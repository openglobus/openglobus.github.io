import{r as qe}from"./iframe-CxB7CSSt.js";const mn=qe.createContext({globe:null,setGlobe:()=>{}}),Oo=({children:l})=>{const[t,i]=qe.useState(null);return qe.createElement(mn.Provider,{value:{globe:t,setGlobe:i}},l)},No=()=>qe.useContext(mn);Oo.__docgenInfo={description:"",methods:[],displayName:"GlobeContextProvider",props:{children:{required:!0,tsType:{name:"ReactReactNode",raw:"React.ReactNode"},description:""}}};const Oi=2*Math.PI,vn=Math.PI/2,bs=Number.MAX_VALUE||17976931348623157e292,mr=Math.log(2),Tt=2147483647,ve=549755748352,Te=-549755748352,G=Math.PI/180,J=180/Math.PI,js=2*J,Ye=.5*G,yn=Math.sqrt(.5),xn=1e-5,tt=1e-10,ws=1e-12,Ts=1e-14;function Ni(l,t,i){return Math.max(t,Math.min(l,i))}function Hi(l){return!(l&l-1)}function Vt(l,t=4096){--l;for(let i=1;i<32;i<<=1)l|=l>>i;return l+1>t?t:l+1}function Li(l=0,t=1){return Math.floor(Math.random()*(t-l))+l}function bn(l,t){return(l%t+t)%t}function Ft(l){const t=bn(l,Oi);return Math.abs(t)<Ts&&Math.abs(l)>Ts?Oi:t}function Zt(l){const t=Math.abs(l);return t-Math.floor(t)}function wn(l,t,i){return i+l*(t-i)}function ts(l){return l*l*l}function is(l){return l*l}function Cs(l){return l-360*Math.floor(l/360)}const id=Object.freeze(Object.defineProperty({__proto__:null,ARCSECONDS_TO_RADIANS:484813681109536e-20,DEG2RAD:function(l){return l*G},DEGREES:J,DEGREES_DOUBLE:js,DEGREES_TO_HOURS:1/15,EPS1:.1,EPS10:tt,EPS11:1e-11,EPS12:ws,EPS13:1e-13,EPS14:Ts,EPS15:1e-15,EPS16:1e-16,EPS17:1e-17,EPS18:1e-18,EPS19:1e-19,EPS2:.01,EPS20:1e-20,EPS3:.001,EPS4:1e-4,EPS5:xn,EPS6:1e-6,EPS7:1e-7,EPS8:1e-8,EPS9:1e-9,HOURS_TO_DEGREES:15,HOURS_TO_RADIANS:.26179938779914946,LOG2:mr,MAX:ve,MAX32:Tt,MAX_FLOAT:bs,MIN:Te,PI_TWO:vn,RAD2DEG:function(l){return l*J},RADIANS:G,RADIANS_HALF:Ye,RADIANS_TO_HOURS:3.819718634205488,SQRT_HALF:yn,TWO_PI:Oi,W:3,X:0,Y:1,Z:2,bezier1v:function(l,t,i,s,r){return ts(1-l)*t+3*is(1-l)*l*i+3*(1-l)*is(l)*s+ts(l)*r},bezier3v:function(l,t,i,s,r){let n=1-l,a=l*l,o=n*n,h=o*n,c=a*l;return t.scaleTo(h).addA(i.scaleTo(3*o*l)).addA(s.scaleTo(3*n*a)).addA(r.scaleTo(c))},clamp:Ni,cube:ts,degToDec:function(l,t,i,s){return s?l+t/60+i/3600:-l-t/60-i/3600},exp2:function(l){return Math.pow(2,l)},frac:Zt,getAngleBetweenAzimuths:function(l,t){return(((l=Ft(l))-(t=Ft(t)))%360+360+180)%360-180},isPowerOfTwo:Hi,lerp:wn,log:function(l,t){return Math.log(l)/Math.log(t)},log2:function(l){return Math.log(l)/mr},mod:bn,negativePItoPI:function(l){return Ft(l+Math.PI)-Math.PI},nextHighestPowerOfTwo:Vt,norm_lon:function(l){return l>180?(l+180)%360-180:l<-180?(l-180)%360+180:l},pow2i:function(l){return 2<<l-1},random:function(l=0,t=1){return Math.random()*(t-l)+l},randomi:Li,rev:Cs,slice:function(l,t,i){return l*(t-i)},solve_iteration:function(l,t,i,s=50){let r=0,n=t;for(let a=0;a<s;a++)if(r=n,n=l(r),Math.abs(n-r)<i)return n;return n},solve_iteration_fixed:function(l,t,i){let s=0,r=t;for(let n=0;n<i;n++)s=r,r=l(s);return r},square:is,step:function(l,t){return t<l?0:1},zeroTwoPI:Ft},Symbol.toStringTag,{value:"Module"})),Ho=.5*Math.PI,Tn=180/Math.PI,Vo=2*Tn,ss=Math.PI/360,Uo=Tn*Ho;class L{constructor(t=0,i=0,s=0){this.lon=0,this.lat=0,this.height=0,this.lon=t,this.lat=i,this.height=s}isZero(){return this.lon===0&&this.lat===0&&this.height===0}static join(t){let i=[];for(let s=0;s<t.length;s++){let r=t[s];i[s]=new L(r[0],r[1],r[2])}return i}static createFromArray(t){return new L(t[0],t[1],t[2])}static toArray(t){return[t.lon,t.lat,t.height]}toArray(){return L.toArray(this)}static forwardMercator(t,i,s){return new L(t*Pi,Math.log(Math.tan((90+i)*ss))*Ht,s)}static forwardMercatorRes(t,i){return i.lon=t.lon*Pi,i.lat=Math.log(Math.tan((90+t.lat)*ss))*Ht,i.height=t.height,i}static inverseMercator(t,i,s=0){return new L(t*Cn,Vo*Math.atan(Math.exp(i*qs))-Uo,s)}set(t=0,i=0,s=0){return this.lon=t,this.lat=i,this.height=s,this}copy(t){return this.lon=t.lon,this.lat=t.lat,this.height=t.height,this}clone(){return new L(this.lon,this.lat,this.height)}forwardMercator(){return L.forwardMercator(this.lon,this.lat,this.height)}forwardMercatorEPS01(){let t=this.lat;return t>89.9?t=89.9:t<-89.9&&(t=-89.9),new L(this.lon*Pi,Math.log(Math.tan((90+t)*ss))*Ht)}inverseMercator(){return L.inverseMercator(this.lon,this.lat,this.height)}equal(t){return t.height?this.lon===t.lon&&this.lat===t.lat&&this.height===t.height:this.lon===t.lon&&this.lat===t.lat}}const Ae=2003750834e-2,Vi=2*Ae,qs=Math.PI/Ae,Ht=Ae/Math.PI,Go=.5*Math.PI,Pi=Ae/180,Cn=180/Ae,An=Math.PI/360,vr=Math.PI/180,jo=180/Math.PI,En=2*Ae,Qt=1/En;function Ui(l){return new L(l.lon*Ae/180,Math.log(Math.tan((90+l.lat)*An))*Ht,l.height)}function Kt(l){return l*Ae/180}function Jt(l){return Math.log(Math.tan((90+l)*An))*Ht}function Ln(l){return jo*(2*Math.atan(Math.exp(l*qs))-Go)}function Gt(l,t,i){let s=Vi/(1<<i),r=new L(l*s-2003750834e-2,Ae-t*s-s);return new j(r,new L(r.lon+s,r.lat+s))}const ce=Ln(Ae),ke=-ce;Object.freeze(Object.defineProperty({__proto__:null,INV_POLE_BY_180:Cn,MAX_LAT:ce,MIN_LAT:ke,ONE_BY_POLE_DOUBLE:Qt,PI_BY_POLE:qs,POLE:Ae,POLE2:Vi,POLE_BY_180:Pi,POLE_BY_PI:Ht,POLE_DOUBLE:En,forward:Ui,forwardArray:function(l){let t=[];for(let i=0;i<l.length;i++)t.push(l[i].forwardMercator());return t},forward_lat:Jt,forward_lon:Kt,getTileExtent:Gt,getTileX:function(l,t){return Math.floor((l+180)/360*Math.pow(2,t))},getTileY:function(l,t){return Math.floor(.5*(1-Math.log(Math.tan(l*vr)+1/Math.cos(l*vr))/Math.PI)*Math.pow(2,t))},inverse_lat:Ln,inverse_lon:function(l){return 180*l/Ae}},Symbol.toStringTag,{value:"Module"}));class j{constructor(t=new L,i=new L){this.southWest=t,this.northEast=i}static createFromArray(t){return new j(new L(t[0],t[1]),new L(t[2],t[3]))}static createByCoordinates(t){let i=ve,s=Te,r=ve,n=Te;for(let a=0;a<t.length;a++){const o=t[a];o.lon<i&&(i=o.lon),o.lon>s&&(s=o.lon),o.lat<r&&(r=o.lat),o.lat>n&&(n=o.lat)}return new j(new L(i,r),new L(s,n))}static createByCoordinatesArr(t){let i=ve,s=Te,r=ve,n=Te;for(let a=0;a<t.length;a++){const o=t[a];o[0]<i&&(i=o[0]),o[0]>s&&(s=o[0]),o[1]<r&&(r=o[1]),o[1]>n&&(n=o[1])}return new j(new L(i,r),new L(s,n))}static fromTile(t,i,s,r=4007501668e-2,n=4007501668e-2){const a=1<<s,o=r/a,h=n/a,c=.5*-r+t*o,d=.5*n-i*h,u=c+o;return new j(new L(c,d-h),new L(u,d))}setByCoordinates(t){let i=ve,s=Te,r=ve,n=Te;for(let a=0;a<t.length;a++){const o=t[a];o.lon<i&&(i=o.lon),o.lon>s&&(s=o.lon),o.lat<r&&(r=o.lat),o.lat>n&&(n=o.lat)}return this.southWest.lon=i,this.southWest.lat=r,this.northEast.lon=s,this.northEast.lat=n,this}isInside(t){const i=this.southWest,s=this.northEast;return t.lon>=i.lon&&t.lon<=s.lon&&t.lat>=i.lat&&t.lat<=s.lat}overlaps(t){const i=this.southWest,s=this.northEast;return i.lon<=t.northEast.lon&&s.lon>=t.southWest.lon&&i.lat<=t.northEast.lat&&s.lat>=t.southWest.lat}getWidth(){return this.northEast.lon-this.southWest.lon}getHeight(){return this.northEast.lat-this.southWest.lat}clone(){return new j(this.southWest.clone(),this.northEast.clone())}getCenter(){const t=this.southWest,i=this.northEast;return new L(t.lon+.5*(i.lon-t.lon),t.lat+.5*(i.lat-t.lat))}getNorthWest(){return new L(this.southWest.lon,this.northEast.lat)}getNorthEast(){return new L(this.northEast.lon,this.northEast.lat)}getSouthWest(){return new L(this.southWest.lon,this.southWest.lat)}getSouthEast(){return new L(this.northEast.lon,this.southWest.lat)}getNorth(){return this.northEast.lat}getEast(){return this.northEast.lon}getWest(){return this.southWest.lon}getSouth(){return this.southWest.lat}equals(t){return this.southWest.lon===t.southWest.lon&&this.southWest.lat===t.southWest.lat&&this.northEast.lon===t.northEast.lon&&this.northEast.lat===t.northEast.lat}forwardMercator(){return new j(this.southWest.forwardMercator(),this.northEast.forwardMercator())}inverseMercator(){return new j(this.southWest.inverseMercator(),this.northEast.inverseMercator())}getCartesianBounds(t){let i=ve,s=Te,r=ve,n=Te,a=ve,o=Te;const h=[new L(this.southWest.lon,this.southWest.lat),new L(this.southWest.lon,this.northEast.lat),new L(this.northEast.lon,this.northEast.lat),new L(this.northEast.lon,this.southWest.lat)];for(let c=0;c<h.length;c++){const d=t.lonLatToCartesian(h[c]),u=d.x,_=d.y,p=d.z;u<i&&(i=u),u>s&&(s=u),_<r&&(r=_),_>n&&(n=_),p<a&&(a=p),p>o&&(o=p)}return[i,r,a,s,n,o]}toString(){return`[${this.southWest.lon.toFixed(5)}, ${this.southWest.lat.toFixed(5)}, ${this.northEast.lon.toFixed(5)}, ${this.northEast.lat.toFixed(5)}]`}}class At{constructor(){this._m=[0,0,0,0,0,0,0,0,0]}set(t){return this._m[0]=t[0],this._m[1]=t[1],this._m[2]=t[2],this._m[3]=t[3],this._m[4]=t[4],this._m[5]=t[5],this._m[6]=t[6],this._m[7]=t[7],this._m[8]=t[8],this}clone(){let t=new At;return t.set(this._m),t}copy(t){return this.set(t._m)}transposeTo(){let t=new At,i=this._m;return t._m[0]=i[0],t._m[1]=i[3],t._m[2]=i[6],t._m[3]=i[1],t._m[4]=i[4],t._m[5]=i[7],t._m[6]=i[2],t._m[7]=i[5],t._m[8]=i[8],t}setIdentity(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=1,this._m[5]=0,this._m[6]=0,this._m[7]=0,this._m[8]=1,this}mulVec(t){let i=t.x,s=t.y,r=t.z,n=this._m;return new v(n[0]*i+n[3]*s+n[6]*r,n[1]*i+n[4]*s+n[7]*r,n[2]*i+n[5]*s+n[8]*r)}getMat4(){let t=new ee,i=t._m,s=this._m;return i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=0,i[4]=s[3],i[5]=s[4],i[6]=s[5],i[7]=0,i[8]=s[6],i[9]=s[7],i[10]=s[8],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,t}}class te{constructor(t=0,i=0,s=0,r=0){this.x=t,this.y=i,this.z=s,this.w=r}static get identity(){return new te(0,0,0,1)}static fromVec(t){return new te(t[0],t[1],t[2],t[3])}toVec3(){return new v(this.x,this.y,this.z)}clone(){return new te(this.x,this.y,this.z,this.w)}equal(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}toArray(){return[this.x,this.y,this.z,this.w]}toArray3(){return[this.x,this.y,this.z]}set(t,i,s,r){return this.x=t,this.y=i,this.z=s,this.w=r,this}addA(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}subA(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}scale(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}affinity(){let t=1/this.w;return this.x*=t,this.y*=t,this.z*=t,this.w=1,this}scaleTo(t){return new te(this.x*t,this.y*t,this.z*t,this.w*t)}getStep(t){return new te(this.x<t?0:1,this.y<t?0:1,this.z<t?0:1,this.w<t?0:1)}getFrac(t){return new te(Zt(t.x),Zt(t.y),Zt(t.z),Zt(t.w))}dot(t){return t.x*this.x+t.y*this.y+t.z*this.z+t.w*this.w}isZero(){return!(this.x||this.y||this.z||this.w)}}class ee{constructor(){this._m=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}static identity(){let t=new ee;return t._m[0]=1,t._m[1]=0,t._m[2]=0,t._m[3]=0,t._m[4]=0,t._m[5]=1,t._m[6]=0,t._m[7]=0,t._m[8]=0,t._m[9]=0,t._m[10]=1,t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t}static getRotationAroundPoint(t,i=v.ZERO,s=v.UP){let r=ee.getRotation(t,s),n=new ee().setIdentity().translate(i),a=new ee().setIdentity().translate(i.negateTo());return n.mul(r).mul(a)}static getRotation(t,i=v.UP){return new ee().setRotation(i,t)}getPosition(){return new v(this._m[12],this._m[13],this._m[14])}getScaling(){let t=this._m[0],i=this._m[1],s=this._m[2],r=this._m[4],n=this._m[5],a=this._m[6],o=this._m[8],h=this._m[9],c=this._m[10];return new v(Math.sqrt(t*t+i*i+s*s),Math.sqrt(r*r+n*n+a*a),Math.sqrt(o*o+h*h+c*c))}getQuat(){let t=this.getScaling();const i=[0,0,0,1];let s=1/t.x,r=1/t.y,n=1/t.z,a=this._m[0]*s,o=this._m[1]*r,h=this._m[2]*n,c=this._m[4]*s,d=this._m[5]*r,u=this._m[6]*n,_=this._m[8]*s,p=this._m[9]*r,f=this._m[10]*n,m=a+d+f,g=0;return m>0?(g=2*Math.sqrt(m+1),i[3]=.25*g,i[0]=(u-p)/g,i[1]=(_-h)/g,i[2]=(o-c)/g):a>d&&a>f?(g=2*Math.sqrt(1+a-d-f),i[3]=(u-p)/g,i[0]=.25*g,i[1]=(o+c)/g,i[2]=(_+h)/g):d>f?(g=2*Math.sqrt(1+d-a-f),i[3]=(_-h)/g,i[0]=(o+c)/g,i[1]=.25*g,i[2]=(u+p)/g):(g=2*Math.sqrt(1+f-a-d),i[3]=(o-c)/g,i[0]=(_+h)/g,i[1]=(u+p)/g,i[2]=.25*g),new F(...i)}set(t){return this._m[0]=t[0],this._m[1]=t[1],this._m[2]=t[2],this._m[3]=t[3],this._m[4]=t[4],this._m[5]=t[5],this._m[6]=t[6],this._m[7]=t[7],this._m[8]=t[8],this._m[9]=t[9],this._m[10]=t[10],this._m[11]=t[11],this._m[12]=t[12],this._m[13]=t[13],this._m[14]=t[14],this._m[15]=t[15],this}clone(){let t=new ee;return t.set(this._m),t}copy(t){return this.set(t._m)}getMat3(){let t=new At,i=this._m,s=t._m;return s[0]=i[0],s[1]=i[1],s[2]=i[2],s[3]=i[4],s[4]=i[5],s[5]=i[6],s[6]=i[8],s[7]=i[9],s[8]=i[10],t}mulVec3(t){let i=t.x,s=t.y,r=t.z;return new v(this._m[0]*i+this._m[4]*s+this._m[8]*r+this._m[12],this._m[1]*i+this._m[5]*s+this._m[9]*r+this._m[13],this._m[2]*i+this._m[6]*s+this._m[10]*r+this._m[14])}mulVec4(t){let i=t.x,s=t.y,r=t.z,n=t.w;return new te(this._m[0]*i+this._m[4]*s+this._m[8]*r+this._m[12]*n,this._m[1]*i+this._m[5]*s+this._m[9]*r+this._m[13]*n,this._m[2]*i+this._m[6]*s+this._m[10]*r+this._m[14]*n,this._m[3]*i+this._m[7]*s+this._m[11]*r+this._m[15]*n)}toInverseMatrix3(){let t=this._m,i=t[0],s=t[1],r=t[2],n=t[4],a=t[5],o=t[6],h=t[8],c=t[9],d=t[10],u=d*a-o*c,_=-d*n+o*h,p=c*n-a*h,f=i*u+s*_+r*p;if(!f)return;f=1/f;let m=new At;return m._m[0]=u*f,m._m[1]=(-d*s+r*c)*f,m._m[2]=(o*s-r*a)*f,m._m[3]=_*f,m._m[4]=(d*i-r*h)*f,m._m[5]=(-o*i+r*n)*f,m._m[6]=p*f,m._m[7]=(-c*i+s*h)*f,m._m[8]=(a*i-s*n)*f,m}inverseTo(t=new ee){let i=this._m[0],s=this._m[1],r=this._m[2],n=this._m[3],a=this._m[4],o=this._m[5],h=this._m[6],c=this._m[7],d=this._m[8],u=this._m[9],_=this._m[10],p=this._m[11],f=this._m[12],m=this._m[13],g=this._m[14],y=this._m[15],x=i*o-s*a,b=i*h-r*a,T=i*c-n*a,w=s*h-r*o,A=s*c-n*o,E=r*c-n*h,C=d*m-u*f,M=d*g-_*f,P=d*y-p*f,B=u*g-_*m,k=u*y-p*m,O=_*y-p*g,R=1/(x*O-b*k+T*B+w*P-A*M+E*C);return t._m[0]=(o*O-h*k+c*B)*R,t._m[1]=(-s*O+r*k-n*B)*R,t._m[2]=(m*E-g*A+y*w)*R,t._m[3]=(-u*E+_*A-p*w)*R,t._m[4]=(-a*O+h*P-c*M)*R,t._m[5]=(i*O-r*P+n*M)*R,t._m[6]=(-f*E+g*T-y*b)*R,t._m[7]=(d*E-_*T+p*b)*R,t._m[8]=(a*k-o*P+c*C)*R,t._m[9]=(-i*k+s*P-n*C)*R,t._m[10]=(f*A-m*T+y*x)*R,t._m[11]=(-d*A+u*T-p*x)*R,t._m[12]=(-a*B+o*M-h*C)*R,t._m[13]=(i*B-s*M+r*C)*R,t._m[14]=(-f*w+m*b-g*x)*R,t._m[15]=(d*w-u*b+_*x)*R,t}transposeTo(){let t=new ee;return t._m[0]=this._m[0],t._m[1]=this._m[4],t._m[2]=this._m[8],t._m[3]=this._m[12],t._m[4]=this._m[1],t._m[5]=this._m[5],t._m[6]=this._m[9],t._m[7]=this._m[13],t._m[8]=this._m[2],t._m[9]=this._m[6],t._m[10]=this._m[10],t._m[11]=this._m[14],t._m[12]=this._m[3],t._m[13]=this._m[7],t._m[14]=this._m[11],t._m[15]=this._m[15],t}setIdentity(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=0,this._m[5]=1,this._m[6]=0,this._m[7]=0,this._m[8]=0,this._m[9]=0,this._m[10]=1,this._m[11]=0,this._m[12]=0,this._m[13]=0,this._m[14]=0,this._m[15]=1,this}mul(t){let i=this._m[0],s=this._m[1],r=this._m[2],n=this._m[3],a=this._m[4],o=this._m[5],h=this._m[6],c=this._m[7],d=this._m[8],u=this._m[9],_=this._m[10],p=this._m[11],f=this._m[12],m=this._m[13],g=this._m[14],y=this._m[15],x=t._m[0],b=t._m[1],T=t._m[2],w=t._m[3],A=t._m[4],E=t._m[5],C=t._m[6],M=t._m[7],P=t._m[8],B=t._m[9],k=t._m[10],O=t._m[11],R=t._m[12],z=t._m[13],D=t._m[14],S=t._m[15],I=new ee;return I._m[0]=x*i+b*a+T*d+w*f,I._m[1]=x*s+b*o+T*u+w*m,I._m[2]=x*r+b*h+T*_+w*g,I._m[3]=x*n+b*c+T*p+w*y,I._m[4]=A*i+E*a+C*d+M*f,I._m[5]=A*s+E*o+C*u+M*m,I._m[6]=A*r+E*h+C*_+M*g,I._m[7]=A*n+E*c+C*p+M*y,I._m[8]=P*i+B*a+k*d+O*f,I._m[9]=P*s+B*o+k*u+O*m,I._m[10]=P*r+B*h+k*_+O*g,I._m[11]=P*n+B*c+k*p+O*y,I._m[12]=R*i+z*a+D*d+S*f,I._m[13]=R*s+z*o+D*u+S*m,I._m[14]=R*r+z*h+D*_+S*g,I._m[15]=R*n+z*c+D*p+S*y,I}translate(t){let i=t.x,s=t.y,r=t.z,n=this._m;return n[12]=n[0]*i+n[4]*s+n[8]*r+n[12],n[13]=n[1]*i+n[5]*s+n[9]*r+n[13],n[14]=n[2]*i+n[6]*s+n[10]*r+n[14],n[15]=n[3]*i+n[7]*s+n[11]*r+n[15],this}translateToPosition(t){let i=this._m;return i[12]=t.x,i[13]=t.y,i[14]=t.z,this}rotate(t,i){let s=Math.cos(i),r=Math.sin(i),n=new ee,a=n._m;return a[0]=s+(1-s)*t.x*t.x,a[1]=(1-s)*t.y*t.x-r*t.z,a[2]=(1-s)*t.z*t.x+r*t.y,a[3]=0,a[4]=(1-s)*t.x*t.y+r*t.z,a[5]=s+(1-s)*t.y*t.y,a[6]=(1-s)*t.z*t.y-r*t.x,a[7]=0,a[8]=(1-s)*t.x*t.z-r*t.y,a[9]=(1-s)*t.y*t.z+r*t.x,a[10]=s+(1-s)*t.z*t.z,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,this.mul(n)}setRotation(t,i){let s=Math.cos(i),r=Math.sin(i),n=this._m;return n[0]=s+(1-s)*t.x*t.x,n[1]=(1-s)*t.y*t.x-r*t.z,n[2]=(1-s)*t.z*t.x+r*t.y,n[3]=0,n[4]=(1-s)*t.x*t.y+r*t.z,n[5]=s+(1-s)*t.y*t.y,n[6]=(1-s)*t.z*t.y-r*t.x,n[7]=0,n[8]=(1-s)*t.x*t.z-r*t.y,n[9]=(1-s)*t.y*t.z+r*t.x,n[10]=s+(1-s)*t.z*t.z,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,this}rotateBetweenVectors(t,i){return F.getRotationBetweenVectors(t,i).getMat4()}scale(t){let i=this._m;return i[0]=i[0]*t.x,i[1]=i[1]*t.x,i[2]=i[2]*t.x,i[3]=i[3]*t.x,i[4]=i[4]*t.y,i[5]=i[5]*t.y,i[6]=i[6]*t.y,i[7]=i[7]*t.y,i[8]=i[8]*t.z,i[9]=i[9]*t.z,i[10]=i[10]*t.z,i[11]=i[11]*t.z,this}setPerspective(t,i,s,r,n,a){let o=i-t,h=r-s,c=n-a,d=2*n,u=this._m;return u[0]=d/o,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=d/h,u[6]=0,u[7]=0,u[8]=(i+t)/o,u[9]=(r+s)/h,u[10]=(a+n)/c,u[11]=-1,u[12]=0,u[13]=0,u[14]=d*a/c,u[15]=0,this}setOrthographic(t,i,s,r,n,a){let o=1/(t-i),h=1/(s-r),c=1/(n-a),d=this._m;return d[0]=-2*o,d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=-2*h,d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[10]=2*c,d[11]=0,d[12]=(t+i)*o,d[13]=(r+s)*h,d[14]=(a+n)*c,d[15]=1,this}eulerToMatrix(t,i,s){let r=Math.cos(t),n=Math.sin(t),a=Math.cos(i),o=Math.sin(i),h=Math.cos(s),c=Math.sin(s),d=r*o,u=n*o,_=this._m;return _[0]=a*h,_[1]=-a*c,_[2]=-o,_[4]=-u*h+r*c,_[5]=u*c+r*h,_[6]=-n*a,_[8]=d*h+n*c,_[9]=-d*c+n*h,_[10]=r*a,_[3]=_[7]=_[11]=_[12]=_[13]=_[14]=0,_[15]=1,this}}class F{constructor(t=0,i=0,s=0,r=0){this.x=t,this.y=i,this.z=s,this.w=r}static get IDENTITY(){return new F(0,0,0,1)}static xRotation(t){return t*=.5,new F(Math.sin(t),0,0,Math.cos(t))}static yRotation(t){return t*=.5,new F(0,Math.sin(t),0,Math.cos(t))}static zRotation(t){return t*=.5,new F(0,0,Math.sin(t),Math.cos(t))}static axisAngleToQuat(t,i=0){let s=t.getNormal(),r=.5*i,n=Math.sin(r);return new F(s.x*n,s.y*n,s.z*n,Math.cos(r))}static getLookRotation(t,i){let s=t.getNormal().negate(),r=i.cross(s).normalize(),n=s.cross(r),a=1+r.x+n.y+s.z;if(a>1e-6){let h=1/(2*Math.sqrt(a));return new F((s.y-n.z)*h,(r.z-s.x)*h,(n.x-r.y)*h,.25/h)}if(r.x>n.y&&r.x>s.z){let h=1/(2*Math.sqrt(1+r.x-n.y-s.z));return new F(.25/h,(n.x+r.y)*h,(r.z+s.x)*h,(s.y-n.z)*h)}if(n.y>s.z){let h=1/(2*Math.sqrt(1+n.y-r.x-s.z));return new F((n.x+r.y)*h,.25/h,(s.y+n.z)*h,(r.z-s.x)*h)}let o=1/(2*Math.sqrt(1+s.z-r.x-n.y));return new F((r.z+s.x)*o,(s.y+n.z)*o,.25/o,(n.x-r.y)*o)}static getLookAtSourceDest(t,i){let s=i.subA(t).normalize(),r=v.FORWARD.dot(s);if(Math.abs(r- -1)<1e-6)return F.axisAngleToQuat(v.UP,Math.PI);if(Math.abs(r-1)<1e-6)return new F(0,0,0,1);let n=Math.acos(r),a=v.FORWARD.cross(s).normalize();return F.axisAngleToQuat(a,n)}static getRotationBetweenVectors(t,i){let s=t.cross(i);return new F(s.x,s.y,s.z,1+t.dot(i)).normalize()}static getRotationBetweenVectorsRes(t,i,s){let r=t.cross(i);return s.set(r.x,r.y,r.z,1+t.dot(i)),s.normalize()}static getRotationBetweenVectorsUp(t,i,s){let r=t.dot(i);if(Math.abs(r+1)<1e-6)return F.axisAngleToQuat(s,Math.PI);if(Math.abs(r-1)<1e-6)return new F(0,0,0,1);let n=Math.acos(r),a=t.cross(i).normalize();return F.axisAngleToQuat(a,n)}isZero(){return this.x===0&&this.y===0&&this.z===0&&this.w===0}isNaN(){return isNaN(this.x)||isNaN(this.y)||isNaN(this.z)||isNaN(this.w)}clear(){return this.x=this.y=this.z=this.w=0,this}set(t,i,s,r){return this.x=t,this.y=i,this.z=s,this.w=r,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}setIdentity(){return this.x=0,this.y=0,this.z=0,this.w=1,this}clone(){return new F(this.x,this.y,this.z,this.w)}add(t){return new F(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}addRes(t,i){return i.set(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}sub(t){return new F(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)}scaleTo(t){return new F(this.x*t,this.y*t,this.z*t,this.w*t)}scale(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}toVec(){return[this.x,this.y,this.z,this.w]}get xyz(){return new v(this.x,this.y,this.z)}setLookRotation(t,i){let s=t.getNormal().negate(),r=i.cross(s).normalize(),n=s.cross(r),a=1+r.x+n.y+s.z;if(a>1e-6){let o=1/(2*Math.sqrt(a));this.x=(s.y-n.z)*o,this.y=(r.z-s.x)*o,this.z=(n.x-r.y)*o,this.w=.25/o}else if(r.x>n.y&&r.x>s.z){let o=1/(2*Math.sqrt(1+r.x-n.y-s.z));this.x=.25/o,this.y=(n.x+r.y)*o,this.z=(r.z+s.x)*o,this.w=(s.y-n.z)*o}else if(n.y>s.z){let o=1/(2*Math.sqrt(1+n.y-r.x-s.z));this.x=(n.x+r.y)*o,this.y=.25/o,this.z=(s.y+n.z)*o,this.w=(r.z-s.x)*o}else{let o=1/(2*Math.sqrt(1+s.z-r.x-n.y));this.x=(r.z+s.x)*o,this.y=(s.y+n.z)*o,this.z=.25/o,this.w=(n.x-r.y)*o}return this}setFromSphericalCoords(t,i,s){let r=Math.sin(s/2),n=Math.cos(s/2),a=Math.sin(t),o=Math.cos(t),h=Math.sin(i),c=Math.cos(i);return this.x=r*o*h,this.y=r*a,this.z=r*a*c,this.w=n,this}getSphericalCoords(){let t=this.w,i=Math.sqrt(1-t*t);Math.abs(i)<5e-4&&(i=1);let s,r=this.x/i,n=this.y/i,a=this.z/i,o=-Math.asin(n);return s=r*r+a*a<5e-4?0:Math.atan2(r,a),s<0&&(s+=360),{lat:o,lon:s,alpha:Math.acos(t)}}setFromAxisAngle(t,i){let s=t.getNormal(),r=.5*i,n=Math.sin(r);return this.set(s.x*n,s.y*n,s.z*n,Math.cos(r)),this}getAxisAngle(){let t,i,s=this.x,r=this.y,n=this.z,a=this.w,o=Math.sqrt(s*s+r*r+n*n);if(o>1e-7){let h=1/o;t=new v(s*h,r*h,n*h),i=a<0?2*Math.atan2(-o,-a):2*Math.atan2(o,a)}else t=new v(0,0,0),i=0;return{axis:t,angle:i}}getPitch(){let t=-2*(this.y*this.z-this.w*this.x);return Math.abs(t)>=1?Math.sign(t)*vn:Math.asin(t)}getYaw(){return-Math.atan2(2*(this.x*this.z+this.w*this.y),1-2*(this.y*this.y+this.x*this.x))}getRoll(){return Math.atan2(2*(this.x*this.y+this.w*this.z),1-2*(this.z*this.z+this.x*this.x))}setPitchYawRoll(t,i,s,r=F.IDENTITY){let n=F.xRotation(-t),a=F.yRotation(i),o=F.zRotation(-s);return this.copy(o.mul(n).mul(a).mul(r).conjugate())}setFromEulerAngles(t,i,s){let r=t*Ye,n=i*Ye,a=s*Ye,o=Math.cos(r),h=Math.cos(n),c=Math.cos(a),d=Math.sin(r),u=Math.sin(n),_=Math.sin(a),p=h*c,f=u*_;return this.w=o*p+d*f,this.x=d*p-o*f,this.y=o*u*c+d*h*_,this.z=o*h*_-d*u*c,this.normalize()}getEulerAngles(){let t=this.x,i=this.y,s=this.z,r=this.w,n=i*i,a=r*i-s*t;return a<-1?a=-1:a>1&&(a=1),{roll:Math.atan2(2*(r*t+i*s),1-2*(t*t+n)),pitch:Math.asin(2*a),yaw:Math.atan2(2*(r*s+t*i),1-2*(n+s*s))}}setFromMatrix4(t){let i,s,r,n,a,o=[],h=t._m,c=[1,2,0];return i=h[0]+h[5]+h[10],i>0?(s=Math.sqrt(i+1),this.w=s/2,s=.5/s,this.x=(h[6]-h[9])*s,this.y=(h[8]-h[2])*s,this.z=(h[1]-h[4])*s):(r=0,h[5]>h[0]&&(r=1),h[10]>h[5*r]&&(r=2),n=c[r],a=c[n],s=Math.sqrt(h[5*r]-(h[5*n]+h[5*a])+1),o[r]=.5*s,s!==0&&(s=.5/s),o[3]=(h[4*n+a]-h[4*a+n])*s,o[n]=(h[4*r+n]+h[4*n+r])*s,o[a]=(h[4*r+a]+h[4*a+r])*s,this.x=o[0],this.y=o[1],this.z=o[2],this.w=o[3]),this}getMat4(t=new ee){let i=this.x+this.x,s=this.y+this.y,r=this.z+this.z,n=this.w*i,a=this.w*s,o=this.w*r,h=this.x*i,c=this.x*s,d=this.x*r,u=this.y*s,_=this.y*r,p=this.z*r;return t.set([1-(u+p),c-o,d+a,0,c+o,1-(h+p),_-n,0,d-a,_+n,1-(h+u),0,0,0,0,1])}getMat3(){let t=new At,i=t._m,s=this.x,r=this.y,n=this.z,a=this.w,o=s+s,h=r+r,c=n+n,d=s*o,u=s*h;s*=c;let _=r*h;return r*=c,n*=c,o*=a,h*=a,a*=c,i[0]=1-(_+n),i[1]=u-a,i[2]=s+h,i[3]=u+a,i[4]=1-(d+n),i[5]=r-o,i[6]=s-h,i[7]=r+o,i[8]=1-(d+_),t}mulVec3(t){let i=t.x,s=t.y,r=t.z,n=this.x,a=this.y,o=this.z,h=this.w,c=h*i+a*r-o*s,d=h*s+o*i-n*r,u=h*r+n*s-a*i;return i=-n*i-a*s-o*r,new v(c*h+i*-n+d*-o-u*-a,d*h+i*-a+u*-n-c*-o,u*h+i*-o+c*-a-d*-n)}mulVec3Res(t,i){let s=t.x,r=t.y,n=t.z,a=this.x,o=this.y,h=this.z,c=this.w,d=c*s+o*n-h*r,u=c*r+h*s-a*n,_=c*n+a*r-o*s;return s=-a*s-o*r-h*n,i.set(d*c+s*-a+u*-h-_*-o,u*c+s*-o+_*-a-d*-h,_*c+s*-h+d*-o-u*-a)}mul(t){let i=this.x,s=this.y,r=this.z,n=this.w,a=t.x,o=t.y,h=t.z,c=t.w;return new F(i*c+n*a+s*h-r*o,s*c+n*o+r*a-i*h,r*c+n*h+i*o-s*a,n*c-i*a-s*o-r*h)}mulRes(t,i){let s=this.x,r=this.y,n=this.z,a=this.w,o=t.x,h=t.y,c=t.z,d=t.w;return i.set(s*d+a*o+r*c-n*h,r*d+a*h+n*o-s*c,n*d+a*c+s*h-r*o,a*d-s*o-r*h-n*c)}mulA(t){let i=this.x,s=this.y,r=this.z,n=this.w,a=t.x,o=t.y,h=t.z,c=t.w;return this.x=i*c+n*a+s*h-r*o,this.y=s*c+n*o+r*a-i*h,this.z=r*c+n*h+i*o-s*a,this.w=n*c-i*a-s*o-r*h,this}conjugate(){return new F(-this.x,-this.y,-this.z,this.w)}inverse(){let t=1/this.magnitude2();return new F(-this.x*t,-this.y*t,-this.z*t,this.w*t)}magnitude(){let t=this.x,i=this.y,s=this.z,r=this.w;return Math.sqrt(t*t+i*i+s*s+r*r)}magnitude2(){let t=this.x,i=this.y,s=this.z,r=this.w;return t*t+i*i+s*s+r*r}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}normalize(){let t=this.x,i=this.y,s=this.z,r=this.w,n=Math.sqrt(t*t+i*i+s*s+r*r);return n===0?(this.x=0,this.y=0,this.z=0,this.w=0,this):(n=1/n,this.x=t*n,this.y=i*n,this.z=s*n,this.w=r*n,this)}isEqual(t){let i=this.dot(t);return Math.abs(i-1)<.001}slerp(t,i){let s,r,n,a,o,h=this.x,c=this.y,d=this.z,u=this.w,_=t.x,p=t.y,f=t.z,m=t.w;return r=h*_+c*p+d*f+u*m,r<0&&(r=-r,_=-_,p=-p,f=-f,m=-m),1-r>1e-6?(s=Math.acos(r),n=Math.sin(s),a=Math.sin((1-i)*s)/n,o=Math.sin(i*s)/n):(a=1-i,o=i),new F(a*h+o*_,a*c+o*p,a*d+o*f,a*u+o*m)}}class v{constructor(t=0,i=0,s=0){this.x=t,this.y=i,this.z=s}static get UP(){return new v(0,1,0)}static get DOWN(){return new v(0,-1,0)}static get RIGHT(){return new v(1,0,0)}static get LEFT(){return new v(-1,0,0)}static get FORWARD(){return new v(0,0,-1)}static get BACKWARD(){return new v(0,0,1)}static get ZERO(){return new v}static get UNIT_X(){return new v(1,0,0)}static get UNIT_Y(){return new v(0,1,0)}static get UNIT_Z(){return new v(0,0,1)}static get NORTH(){return v.UNIT_Z}static doubleToTwoFloats(t,i,s){let r=t.x,n=t.y,a=t.z;if(r>=0){let o=65536*Math.floor(r/65536);i.x=Math.fround(o),s.x=Math.fround(r-o)}else{let o=65536*Math.floor(-r/65536);i.x=Math.fround(-o),s.x=Math.fround(r+o)}if(n>=0){let o=65536*Math.floor(n/65536);i.y=Math.fround(o),s.y=Math.fround(n-o)}else{let o=65536*Math.floor(-n/65536);i.y=Math.fround(-o),s.y=Math.fround(n+o)}if(a>=0){let o=65536*Math.floor(a/65536);i.z=Math.fround(o),s.z=Math.fround(a-o)}else{let o=65536*Math.floor(-a/65536);i.z=Math.fround(-o),s.z=Math.fround(a+o)}}static doubleToTwoFloat32Array(t,i,s){let r=t.x,n=t.y,a=t.z;if(r>=0){let o=65536*Math.floor(r/65536);i[0]=Math.fround(o),s[0]=Math.fround(r-o)}else{let o=65536*Math.floor(-r/65536);i[0]=Math.fround(-o),s[0]=Math.fround(r+o)}if(n>=0){let o=65536*Math.floor(n/65536);i[1]=Math.fround(o),s[1]=Math.fround(n-o)}else{let o=65536*Math.floor(-n/65536);i[1]=Math.fround(-o),s[1]=Math.fround(n+o)}if(a>=0){let o=65536*Math.floor(a/65536);i[2]=Math.fround(o),s[2]=Math.fround(a-o)}else{let o=65536*Math.floor(-a/65536);i[2]=Math.fround(-o),s[2]=Math.fround(a+o)}}static fromVec(t){return new v(t[0],t[1],t[2])}static angle(t,i){let s=t.dot(i),r=t.cross(i).length();return Math.atan2(r,s)}static lerp(t,i,s){return new v(t.x+(i.x-t.x)*s,t.y+(i.y-t.y)*s,t.z+(i.z-t.z)*s)}static add(t,i){let s=new v(t.x,t.y,t.z);return s.addA(i),s}static sub(t,i){let s=new v(t.x,t.y,t.z);return s.subA(i),s}static scale(t,i){return t.scaleTo(i)}static mul(t,i){let s=new v(t.x,t.y,t.z);return s.mulA(i),s}static noncollinear(t,i){return!!(t.y*i.z-t.z*i.y||t.z*i.x-t.x*i.z||t.x*i.y-t.y*i.z)}static proj_b_to_plane(t,i,s){let r=t.sub(i.scaleTo(i.dot(t)/i.dot(i)));return s&&r.isZero()?new v(s.x,s.y,s.z):r}static proj_b_to_a(t,i){return i.scaleTo(i.dot(t)/i.dot(i))}static orthoNormalize(t,i){return(t=t.getNormal()).scale(i.dot(t)),i.subA(t).normalize()}static isOrthogonal(t,i,s=1e-6){const r=t.x*i.x+t.y*i.y+t.z*i.z;return Math.abs(r)<s}isOrthogonal(t,i=1e-6){const s=this.x*t.x+this.y*t.y+this.z*t.z;return Math.abs(s)<i}static div(t,i){let s=new v(t.x,t.y,t.z);return s.divA(i),s}static length2(t){return t.length2()}static dot(t,i){return t.dot(i)}toVec4(){return new te(this.x,this.y,this.z,1)}clone(){return new v(this.x,this.y,this.z)}toString(){return`(${this.x},${this.y},${this.z})`}isZero(){return!(this.x||this.y||this.z)}projToVec(t){return t.scaleTo(t.dot(this)/t.dot(t))}equal(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}length2(){return this.x*this.x+this.y*this.y+this.z*this.z}getQuat(){return new F(this.x,this.y,this.z)}addA(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}add(t){return new v(this.x+t.x,this.y+t.y,this.z+t.z)}addRes(t,i){return i.set(this.x+t.x,this.y+t.y,this.z+t.z)}subA(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}sub(t){return new v(this.x-t.x,this.y-t.y,this.z-t.z)}scale(t){return this.x*=t,this.y*=t,this.z*=t,this}scaleTo(t){return new v(this.x*t,this.y*t,this.z*t)}mulA(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}mul(t){return new v(this.x*t.x,this.y*t.y,this.z*t.z)}mulRes(t,i){return i.set(this.x*t.x,this.y*t.y,this.z*t.z)}divA(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}div(t){return new v(this.x/t.x,this.y/t.y,this.z/t.z)}dot(t){return t.x*this.x+t.y*this.y+t.z*this.z}dotArr(t){return t[0]*this.x+t[1]*this.y+t[2]*this.z}cross(t){return new v(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}clear(){return this.x=this.y=this.z=0,this}getNormal(){let t=new v;t.copy(this);let i=1/t.length();return t.x*=i,t.y*=i,t.z*=i,t}normal(){let t=new v;t.copy(this);let i=1/t.length();return t.x*=i,t.y*=i,t.z*=i,t}normalNegate(){let t=new v;t.copy(this);let i=-1/t.length();return t.x*=i,t.y*=i,t.z*=i,t}normalNegateScale(t){let i=new v;i.copy(this);let s=-t/i.length();return i.x*=s,i.y*=s,i.z*=s,i}normalScale(t){let i=new v;i.copy(this);let s=t/i.length();return i.x*=s,i.y*=s,i.z*=s,i}normalize(){let t=1/this.length();return this.x*=t,this.y*=t,this.z*=t,this}toVec(){return[this.x,this.y,this.z]}toArray(){return[this.x,this.y,this.z]}distance(t){let i=this.x-t.x,s=this.y-t.y,r=this.z-t.z;return Math.sqrt(i*i+s*s+r*r)}distance2(t){let i=this.x-t.x,s=this.y-t.y,r=this.z-t.z;return i*i+s*s+r*r}set(t,i,s){return this.x=t,this.y=i,this.z=s,this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}negateTo(){return new v(-this.x,-this.y,-this.z)}projToRay(t,i){let s=v.proj_b_to_a(v.sub(this,t),i);return s.addA(t),s}angle(t){return v.angle(this,t)}lerp(t,i){return new v(this.x+(t.x-this.x)*i,this.y+(t.y-this.y)*i,this.z+(t.z-this.z)*i)}smerp(t,i){let s=1-i;return new v(this.x*i+t.x*s,this.y*i+t.y*s,this.z*i+t.z*s)}static get LERP_DELTA(){return 1e-6}slerp(t,i){let s,r,n,a,o=new v;if(i<=0)return o.copy(this),o;if(i>=1)return o.copy(t),o;let h=this.dot(t);return 1-h>v.LERP_DELTA?(s=Math.acos(h),r=Math.sin(s),n=Math.sin((1-i)*s)/r,a=Math.sin(i*s)/r):(n=1-i,a=i),v.add(this.scaleTo(n),t.scale(a))}mulVecA(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}getRotationTo(t,i){let s=this.clone(),r=t.clone();s.normalize(),r.normalize();let n=s.dot(r);if(n>=1)return F.IDENTITY.clone();if(n<-.999999){if(i.equal(v.ZERO)){let a=v.UNIT_X.cross(s);return a.isZero()&&(a=v.UNIT_Y.cross(s)),a.normalize(),F.axisAngleToQuat(a,Math.PI)}return F.axisAngleToQuat(i,Math.PI)}{let a=Math.sqrt(2*(1+n)),o=1/a,h=s.cross(r),c=new F(h.x*o,h.y*o,h.z*o,.5*a);return c.normalize(),c}}}class H{constructor(t=0,i=0){this.x=t,this.y=i}static get UP(){return new H(0,1)}static get DOWN(){return new H(0,-1)}static get RIGHT(){return new H(1,0)}static get LEFT(){return new H(-1,0)}static get ZERO(){return new H}static add(t,i){const s=new H(t.x,t.y);return s.addA(i),s}static sub(t,i){var s=new H(t.x,t.y);return s.subA(i),s}static scale(t,i){let s=new H(t.x,t.y);return s.scale(i),s}static mul(t,i){let s=new H(t.x,t.y);return s.mulA(i),s}static div(t,i){let s=new H(t.x,t.y);return s.divA(i),s}static proj_b_to_a(t,i){return i.scaleTo(i.dot(t)/i.dot(i))}static angle(t,i){return Math.acos(t.dot(i)/Math.sqrt(t.length2()*i.length2()))}static orthoNormalize(t,i){return(t=t.normal()).scale(i.dot(t)),i.sub(t).normalize()}static proj_b_to_plane(t,i,s){let r=t.sub(i.scaleTo(i.dot(t)/i.dot(i)));return s&&r.isZero()?new H(s.x,s.y):r}toVector3(){return new v(this.x,this.y,0)}clone(){return new H(this.x,this.y)}equal(t){return this.x===t.x&&this.y===t.y}copy(t){return this.x=t.x,this.y=t.y,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}length2(){return this.x*this.x+this.y*this.y}addA(t){return this.x+=t.x,this.y+=t.y,this}add(t){return new H(this.x+t.x,this.y+t.y)}subA(t){return this.x-=t.x,this.y-=t.y,this}sub(t){return new H(this.x-t.x,this.y-t.y)}scale(t){return this.x*=t,this.y*=t,this}scaleTo(t){return new H(this.x*t,this.y*t)}mulA(t){return this.x*=t.x,this.y*=t.y,this}mul(t){return new H(this.x*t.x,this.y*t.y)}divA(t){return this.x/=t.x,this.y/=t.y,this}dot(t){return t.x*this.x+t.y*this.y}dotArr(t){return t[0]*this.x+t[1]*this.y}cross(t){return this.x*t.y-this.y*t.x}clear(){return this.x=this.y=0,this}normal(){return this.getNormal()}getNormal(){let t=new H;t.copy(this);let i=1/t.length();return t.x*=i,t.y*=i,t}normalize(){let t=1/this.length();return this.x*=t,this.y*=t,this}toVec(){return[this.x,this.y]}distance(t){return H.sub(this,t).length()}set(t,i){return this.x=t,this.y=i,this}negate(){return this.x=-this.x,this.y=-this.y,this}negateTo(){return new H(-this.x,-this.y)}projToRay(t,i){let s=H.proj_b_to_a(H.sub(this,t),i);return s.add(t),s}angle(t){return H.angle(this,t)}lerp(t,i,s){let r=this.clone();return s<=0?r.copy(t):s>=1?r.copy(i):r=H.add(t,H.sub(i,t).scale(s)),r}static get LERP_DELTA(){return 1e-6}slerp(t,i){let s,r,n,a,o=new H;if(i<=0)return o.copy(this),o;if(i>=1)return o.copy(t),o;let h=this.dot(t);return 1-h>H.LERP_DELTA?(s=Math.acos(h),r=Math.sin(s),n=Math.sin((1-i)*s)/r,a=Math.sin(i*s)/r):(n=1-i,a=i),H.add(this.scale(n),t.scale(a))}isZero(){return!(this.x||this.y)}}const Pn={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};class Ys{constructor(t=1,i=1){this._a=t,this._b=i,this._flattening=(t-i)/t,this._f=1/this._flattening,this._a2=t*t,this._b2=i*i;const s=Math.sqrt(this._a2-this._b2);this._e=s/t,this._e2=this._e*this._e,this._e22=this._e2*this._e2,this._k=s/i,this._k2=this._k*this._k,this._radii=new v(t,t,i),this._radii2=new v(this._a2,this._a2,this._b2),this._invRadii=new v(1/t,1/t,1/i),this._invRadii2=new v(1/this._a2,1/this._a2,1/this._b2)}rhumbDistanceTo(t,i){const s=t.lat*G,r=i.lat*G,n=r-s;let a=Math.abs(i.lon-t.lon)*G;Math.abs(a)>Math.PI&&(a=a>0?-(2*Math.PI-a):2*Math.PI+a);const o=Math.log(Math.tan(r/2+Math.PI/4)/Math.tan(s/2+Math.PI/4)),h=Math.abs(o)>1e-11?n/o:Math.cos(s);return Math.sqrt(n*n+h*h*a*a)*this._a}getIntermediatePointOnGreatCircle(t,i,s){if(s==0)return t.clone();if(s==1)return i.clone();const r=this.inverse(t,i),n=r.distance,a=r.initialAzimuth;return isNaN(a)?t:this.getGreatCircleDestination(t,a,n*s)}static getBearing(t,i){let s=t.lat*G,r=t.lon*G,n=i.lat*G,a=i.lon*G,o=Math.sin(a-r)*Math.cos(n),h=Math.cos(s)*Math.sin(n)-Math.sin(s)*Math.cos(n)*Math.cos(a-r);return Math.atan2(o,h)*J}getFlattening(){return this._flattening}getEquatorialSize(){return this._a}get equatorialSize(){return this._a}get equatorialSizeSqr(){return this._a2}getPolarSize(){return this._b}get polarSize(){return this._b}get polarSizeSqr(){return this._b2}lonLatToCartesian(t){return this.geodeticToCartesian(t.lon,t.lat,t.height)}lonLatToCartesianRes(t,i){return this.geodeticToCartesian(t.lon,t.lat,t.height,i)}geodeticToCartesian(t,i,s=0,r=new v){let n=G*i,a=G*t,o=Math.sin(n),h=this._a/Math.sqrt(1-this._e2*o*o),c=(h+s)*Math.cos(n);return r.x=c*Math.cos(a),r.y=c*Math.sin(a),r.z=(h*(1-this._e2)+s)*o,r}projToSurface(t){let i=t.x||0,s=t.y||0,r=t.z||0,n=Math.sqrt(i*i+s*s+r*r);if(n===0)return this.lonLatToCartesian(new L);let a=this._invRadii2.x,o=this._invRadii2.y,h=this._invRadii2.z,c=i*i*a,d=s*s*o,u=r*r*h,_=c+d+u,p=Math.sqrt(1/_),f=t.scaleTo(p);if(_<.1)return Number.isFinite(p)?f:new v;let m=(1-p)*n/f.mulA(this._invRadii2).length(),g=0,y=0,x=0;for(;;){g=1/(1+m*a),y=1/(1+m*o),x=1/(1+m*h);let b=g*g,T=y*y,w=x*x,A=c*b+d*T+u*w-1;if(Math.abs(A)<ws)break;m+=.5*A/(c*(b*g)*a+d*(T*y)*o+u*(w*x)*h)}return new v(i*g,s*y,r*x)}cartesianToLonLat(t){return this.cartesianToLonLatRes(t)}cartesianToLonLatRes(t,i=new L){let s=this.projToSurface(t),r=this.getSurfaceNormal3v(s),n=t.sub(s);return i.lon=Math.atan2(r.y,r.x)*J,i.lat=Math.asin(r.z)*J,i.height=Math.sign(n.dot(t))*n.length(),i}getSurfaceNormal3v(t){let i=this._invRadii2,s=t.x*i.x,r=t.y*i.y,n=t.z*i.z,a=1/Math.sqrt(s*s+r*r+n*n);return new v(s*a,r*a,n*a)}getGreatCircleDistance(t,i){return this.inverse(t,i).distance}getGreatCircleDestination(t,i,s){return this.direct(t,i,s).destination}inverse(t,i){let s=this._a,r=this._b,n=this._flattening;const a=t.lat*G,o=t.lon*G,h=i.lat*G,c=i.lon*G-o,d=(1-n)*Math.tan(a),u=1/Math.sqrt(1+d*d),_=d*u,p=(1-n)*Math.tan(h),f=1/Math.sqrt(1+p*p),m=p*f,g=Math.abs(c)>Math.PI/2||Math.abs(h-a)>Math.PI/2;let y=c,x=null,b=null,T=g?Math.PI:0,w=0,A=g?-1:1,E=null,C=1,M=1,P=null,B=0;do{if(x=Math.sin(y),b=Math.cos(y),E=(f*x)**2+(u*m-_*f*b)**2,Math.abs(E)<1e-24)break;w=Math.sqrt(E),A=_*m+u*f*b,T=Math.atan2(w,A);const S=u*f*x/w;M=1-S*S,C=M!=0?A-2*_*m/M:0;const I=n/16*M*(4+n*(4-3*M));P=y,y=c+(1-I)*n*S*(T+I*w*(C+I*A*(2*C*C-1)))}while(Math.abs(y-P)>ws&&++B<1e3);const k=M*(s*s-r*r)/(r*r),O=k/1024*(256+k*(k*(74-47*k)-128)),R=r*(1+k/16384*(4096+k*(k*(320-175*k)-768)))*(T-O*w*(C+O/4*(A*(2*C*C-1)-O/6*C*(4*w*w-3)*(4*C*C-3)))),z=Math.abs(E)<Number.EPSILON?0:Math.atan2(f*x,u*m-_*f*b),D=Math.abs(E)<Number.EPSILON?Math.PI:Math.atan2(u*x,-_*f+u*m*b);return{distance:R,initialAzimuth:Math.abs(R)<Number.EPSILON?NaN:Ft(z)*J,finalAzimuth:Math.abs(R)<Number.EPSILON?NaN:Ft(D)*J}}direct(t,i,s){let r=t.lon,n=t.lat,a=this._a,o=this._b,h=this._flattening,c=s,d=i*G,u=Math.sin(d),_=Math.cos(d),p=(1-h)*Math.tan(n*G),f=1/Math.sqrt(1+p*p),m=p*f,g=Math.atan2(p,_),y=f*u,x=1-y*y,b=x*(a*a-o*o)/(o*o),T=1+b/16384*(4096+b*(b*(320-175*b)-768)),w=b/1024*(256+b*(b*(74-47*b)-128)),A=c/(o*T),E=2*Math.PI,C=0,M=0,P=0,B=0;for(;Math.abs(A-E)>1e-12;)C=Math.cos(2*g+A),M=Math.sin(A),P=Math.cos(A),B=w*M*(C+w/4*(P*(2*C*C-1)-w/6*C*(4*M*M-3)*(4*C*C-3))),E=A,A=c/(o*T)+B;let k=m*M-f*P*_,O=Math.atan2(m*P+f*M*_,(1-h)*Math.sqrt(y*y+k*k)),R=h/16*x*(4+h*(4-3*x)),z=Math.atan2(M*u,f*P-m*M*_)-(1-R)*h*y*(A+R*M*(C+R*P*(2*C*C-1))),D=Math.atan2(y,-k);return{destination:new L(r+z*J,O*J),finalAzimuth:D*J}}hitRay(t,i){let s,r,n,a,o,h=this._invRadii.mul(t),c=this._invRadii.mul(i),d=h.dot(h),u=h.dot(c);if(d>1){if(u>=0)return;var _=u*u;if(s=d-1,r=c.dot(c),n=r*s,Math.abs(_-n)>1e-15&&_<n)return;if(_>n){a=u*u-n,o=-u+Math.sqrt(a);var p=o/r,f=s/o;return p<f?t.add(i.scaleTo(p)):t.add(i.scaleTo(f))}var m=Math.sqrt(s/r);return t.add(i.scaleTo(m))}return d<1?(s=d-1,r=c.dot(c),n=r*s,a=u*u-n,o=-u+Math.sqrt(a),t.add(i.scaleTo(o/r))):u<0?(r=c.dot(c),t.add(i.scaleTo(-u/r))):void 0}getNorthFrameRotation(t){let i=this.getSurfaceNormal3v(t),s=v.proj_b_to_plane(v.NORTH,i);return F.getLookRotation(s,i)}getBearingDestination(t,i=0,s=0){i*=G;var r=(t.lon+540)%360-180,n=t.lat*G,a=r*G,o=s/this._a,h=Math.asin(Math.sin(n)*Math.cos(o)+Math.cos(n)*Math.sin(o)*Math.cos(i));return new L((a+Math.atan2(Math.sin(i)*Math.sin(o)*Math.cos(n),Math.cos(o)-Math.sin(n)*Math.sin(h)))*J,h*J)}static getIntermediatePointOnGreatCircle(t,i,s){var r=t.lat*G,n=t.lon*G,a=i.lat*G,o=i.lon*G,h=Math.sin(r),c=Math.cos(r),d=Math.sin(n),u=Math.cos(n),_=Math.sin(a),p=Math.cos(a),f=Math.sin(o),m=Math.cos(o),g=a-r,y=o-n,x=Math.sin(g/2)*Math.sin(g/2)+Math.cos(r)*Math.cos(a)*Math.sin(y/2)*Math.sin(y/2),b=2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)),T=Math.sin((1-s)*b)/Math.sin(b),w=Math.sin(s*b)/Math.sin(b),A=T*c*u+w*p*m,E=T*c*d+w*p*f,C=T*h+w*_,M=Math.atan2(C,Math.sqrt(A*A+E*E)),P=Math.atan2(E,A);return new L((P*J+540)%360-180,M*J)}static getRhumbBearing(t,i){var s=(i.lon-t.lon)*G,r=Math.log(Math.tan(i.lat*G/2+Math.PI/4)/Math.tan(t.lat*G/2+Math.PI/4));return Math.abs(s)>Math.PI&&(s=s>0?-1*(2*Math.PI-s):2*Math.PI+s),(Math.atan2(s,r)*J+360)%360}getLonLatVisibilitySimple(t,i,s){const r=this.lonLatToCartesian(i),n=i.height,a=this.polarSize+n,o=Math.max(t.length()-this.polarSize,0),h=r.sub(t);let c;return c=o>0?Math.sqrt((a+o)**2-a**2):a,c>h.length()&&(!s||s.dot(h.normalize())>0)}}const Sn=new Ys(6378137,6356752314245179e-9);function Si(l,t){return l??t}function Fe(l){return l==null}function yr(l){return l===void 0}let qo=0;function Ws(l){let t=l._openglobus_id;return t||(t=l._openglobus_id=++qo),t}function Zi(l){return typeof l=="string"||l instanceof String}function Pt(l){return l.toString(16).padStart(2,"0")}function As(l){let t,i,s;return l instanceof Array?(t=Pt(l[0]),i=Pt(l[1]),s=Pt(l[2])):(t=Pt(l.x),i=Pt(l.y),s=Pt(l.z)),`#${t}${i}${s}`}function at(l,t){let i=Pn[l];if(i&&(l=i),l[0]==="#"){let s=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,r=l.replace(s,(function(a,o,h,c){return o+o+h+h+c+c})),n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(r);return n?new te(parseInt(n[1],16)/255,parseInt(n[2],16)/255,parseInt(n[3],16)/255,Fe(t)?1:t):new te}{Fe(t)&&(t=1);let s=l.split(",");return new te(parseInt(s[0].split("(")[1])/255,parseInt(s[1])/255,parseInt(s[2])/255,Fe(s[3])?t:parseFloat(s[3]))}}function ft(l,t){let i=at(l,t);return new Float32Array([i.x,i.y,i.z,i.w])}function Gi(l){let t=Pn[l];if(t&&(l=t),l[0]==="#"){let i=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,s=l.replace(i,(function(n,a,o,h){return a+a+o+o+h+h})),r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(s);return r?new v(parseInt(r[1],16)/255,parseInt(r[2],16)/255,parseInt(r[3],16)/255):new v}{let i=l.split(",");return new v(parseInt(i[0].split("(")[1])/255,parseInt(i[1])/255,parseInt(i[2])/255)}}function Ie(l,t){return l.replace(/{[^{}]+}/g,(function(i){return t[i.replace(/[{}]+/g,"")]||""}))}function ri(l,t){return l.replace(/\$\{([^}]+)\}/g,((i,s)=>t?.[s.trim()]??""))}function $s(l){let t=document.createElement("div");t.innerHTML=l;let i=[];for(let s=0;s<t.childNodes.length;s++)i.push(t.childNodes[s]),t.removeChild(t.childNodes[s]);return i}function Rn(l,t,i,s){let r=document.getElementById(l);r||(r=document.createElement("div"),r.id=l,r.classList.add("defaultText"),document.body.appendChild(r)),r.innerHTML=t,r.style.left=`${i}px`,r.style.top=`${s}px`}function Mn(l){return typeof l=="number"}function Bn(l,t=""){return l?l.trim():t}function He(l,t){if(l){if(Mn(l))return new v(l,l,l);if(l instanceof v)return l.clone();if(l instanceof Array)return v.fromVec(l);if(l instanceof H)return new v(l.x,l.y,0)}else if(t)return t;return new v}function nt(l,t){if(l){if(Zi(l))return at(l);if(l instanceof Array)return te.fromVec(l);if(l instanceof te)return l.clone()}else if(t)return t;return new te(1,1,1,1)}function Oe(l,t){if(l){if(Zi(l))return Gi(l);if(l instanceof Array)return v.fromVec(l);if(l instanceof v)return l.clone()}else if(t)return t;return new v(1,1,1)}function Xs(l,t){if(l){if(l instanceof Array)return new j(ji(l[0]),ji(l[1]));if(l instanceof j)return l.clone()}else if(t)return t;return new j}function ji(l,t){if(l){if(l instanceof Array)return new L(l[0],l[1],l[2]);if(l instanceof L)return l.clone()}else if(t)return t;return new L}function Zs(l,t){let i=0,s=l.length-1;for(;i<=s;){let r=Math.floor(.5*(i+s));if(Math.abs(l[r]-t)<.001)return r;l[r]<t?i=r+1:s=r-1}return-1}function Et(l,t,i){let s=0,r=l.length-1;for(;s<=r;){let n=r+s>>1,a=i(t,l[n],n);if(a>0)s=n+1;else{if(!(a<0))return n;r=n-1}}return-s-1}function Qs(l,t,i){let s=Et(l,t,i);return s<0&&(s=~s),l.splice(s,0,t),s}function kn(l,t,i,s,r=!1){let n=new L(t.lon-l.lon,t.lat-l.lat),a=new L(s.lon-i.lon,s.lat-i.lat),o=-n.lat,h=+n.lon,c=-(o*l.lon+h*l.lat),d=-a.lat,u=+a.lon,_=-(d*i.lon+u*i.lat),p=d*l.lon+u*l.lat+_,f=d*t.lon+u*t.lat+_,m=o*i.lon+h*i.lat+c,g=o*s.lon+h*s.lat+c;if(r&&(p*f>0||m*g>0))return;let y=p/(p-f);return new L(l.lon+y*n.lon,l.lat+y*n.lat)}const Yo={string:function(l){return Fe(l)?l:l.toString()},date:function(l){return Fe(l)?l:new Date(1e3*l)},datetime:function(l){return Fe(l)?l:new Date(1e3*l)},time:function(l){return Fe(l)?l:parseInt(l)},integer:function(l){return Fe(l)?l:parseInt(l)},float:function(l){return Fe(l)?l:parseFloat(l)},boolean:function(l){if(l===null)return l;if(typeof l=="boolean")return l===!0;if(typeof l=="string"){if(l==="")return!1;if((l=l.replace(/^\s+|\s+$/g,"")).toLowerCase()==="true"||l.toLowerCase()==="yes")return!0;l=(l=l.replace(/,/g,".")).replace(/^\s*\-\s*/g,"-")}return!isNaN(l)&&parseFloat(l)!==0}};function xr(l,t=""){let i=1024,s=atob(l),r=s.length,n=Math.ceil(r/i),a=new Array(n);for(let o=0;o<n;++o){let h=o*i,c=Math.min(h+i,r),d=new Array(c-h);for(let u=h,_=0;u<c;++_,++u)d[_]=s[u].charCodeAt(0);a[o]=new Uint8Array(d)}return new Blob(a,{type:t})}function di(l,t,i=!1){let s,r=0;return function(){const n=arguments;r?(i&&clearTimeout(s),s=setTimeout((()=>{Date.now()-r>=t&&(l.apply(null,n),r=Date.now())}),t-(Date.now()-r))):(l.apply(null,n),r=Date.now())}}function ie(l,t){let i=new l.constructor(l.length+t.length);return i.set(l,0),i.set(t,l.length),i}function ye(l=[],t=[]){if(ArrayBuffer.isView(l))return ie(l,t);for(let i=0;i<t.length;i++)l.push(t[i]);return l}function se(l,t=Float32Array){if(ArrayBuffer.isView(l))return l;{const i=new t(l.length);return i.set(l,0),i}}function zt(l){return ArrayBuffer.isView(l)?Array.from(l):l}function Ce(l,t,i,s){if(ArrayBuffer.isView(l))return t<0&&(i=Math.abs(t),t+=l.length),ae(l,t,i,s);{let r;return r=t<0?l.splice(t):l.splice(t,i),s&&(s.result=r),l}}function ae(l,t,i,s){if(l.length===0)return l;const r=l.length-i,n=new l.constructor(r);return n.set(l.subarray(0,t)),n.set(l.subarray(t+i),t),s&&(s.result=l.subarray(t,t+i)),n}function Ks(l,t,i,s,r){const n=r+1,a=i+n,o=s+n;let h=new Float64Array(n*n*3),c=0;for(let d=i;d<a;d++)for(let u=s;u<o;u++){let _=3*(d*(t+1)+u);h[c++]=l[_],h[c++]=l[_+1],h[c++]=l[_+2]}return h}function In(l,t,i,s,r){const n=r+1,a=i+n,o=s+n;let h=new Float32Array(n*n*3),c=0;for(let d=i;d<a;d++)for(let u=s;u<o;u++){let _=3*(d*(t+1)+u);h[c++]=l[_],h[c++]=l[_+1],h[c++]=l[_+2]}return h}function Es(l,t,i,s,r,n,a,o,h,c,d,u,_){const p=n+o+1,f=a+o+1;r+=1;let m=0,g=0;for(let y=n;y<p;y++)for(let x=a;x<f;x++){let b=y*r+x,T=3*b,w=l[T],A=l[T+1],E=l[T+2];s&&s[b]!==0?_[g]=1:(w<u.xmin&&(u.xmin=w),w>u.xmax&&(u.xmax=w),A<u.ymin&&(u.ymin=A),A>u.ymax&&(u.ymax=A),E<u.zmin&&(u.zmin=E),E>u.zmax&&(u.zmax=E)),g++,h[m]=w,d[m]=i[T],c[m++]=t[T],h[m]=A,d[m]=i[T+1],c[m++]=t[T+1],h[m]=E,d[m]=i[T+2],c[m++]=t[T+2]}}function Js(l){return l.map((t=>Array.isArray(t)?Js(t):t))}async function Ri(l){return new Promise((t=>{const i=new Image;return i.addEventListener("load",(()=>{t(i)})),i.src=l,i.crossOrigin="",i}))}function Ls(l){return l.complete&&l.naturalHeight!==0}function Ot(l){return l>1e3?l-Math.floor(l)!=0?[(l/1e3).toFixed(2),"km"]:[(l/1e3).toFixed(0),"km"]:l>9?[Math.round(l).toString(),"m"]:l<=.01?["0","m"]:[l.toFixed(1),"m"]}function zn(l){let t=new URLSearchParams(location.search).get(l);if(t)return Number(t)}function Ps(l,t=-1){if(t<0)return l.toString();const i=Math.pow(10,t);return(Math.round(l*i)/i).toString()}const sd=Object.freeze(Object.defineProperty({__proto__:null,base64StringToBlog:function(l){let t=l.split(";"),i=t[0].split(":")[1];return xr(t[1].split(",")[1],i)},base64toBlob:xr,binaryInsert:Qs,binarySearch:Et,binarySearchFast:Zs,blerp:function(l,t,i,s,r,n,a=0,o=1,h=0,c=1){return(i*(o-l)*(c-t)+s*(l-a)*(c-t)+r*(o-l)*(t-h)+n*(l-a)*(t-h))/((o-a)*(c-h))},blerp2:function(l,t,i,s,r,n){return i*(1-l)*(1-t)+s*l*(1-t)+r*(1-l)*t+n*l*t},castType:Yo,cloneArray:Js,concatArrays:ye,concatTypedArrays:ie,createColorRGB:Oe,createColorRGBA:nt,createExtent:Xs,createLonLat:ji,createVector3:He,createVector4:function(l,t){if(l){if(l instanceof te)return l.clone();if(l instanceof Array)return te.fromVec(l)}else if(t)return t;return new te},defaultString:Bn,distanceFormat:function(l){return l>1e3?`${(l/1e3).toFixed(2)} km`:l>9?`${Math.round(l)} m`:`${l.toFixed(1)} m`},distanceFormatExt:Ot,extractElevationTiles:function(l,t,i){let s=Math.sqrt(t.length)-1,r=s+1,n=Math.sqrt(l.length/4),a=n/s,o=0,h=0;for(let c=0,d=0,u=l.length/4;c<u;c++){let _=l[4*c],p=Math.floor(c/n),f=c%n,m=Math.floor(f/s),g=Math.floor(p/s),y=i[g][m],x=p%s,b=f%s,T=(x+g)*r+b+m;if(y[T]=_,(p+g)%a==0&&(f+m)%a==0&&(t[d++]=_),(f+1)%s==0&&f!==n-1){o=l[4*(c+1)];let w=.5*(_+o);T=(x+g)*r+b+1,y[T]=w,(p+g)%a==0&&(t[d++]=w);let A=(x+g)*r+(b+1)%s;i[g][m+1][A]=w}if((p+1)%s==0&&p!==n-1){h=l[4*(c+n)];let w=.5*(_+h);T=(x+1)*r+b+m,y[T]=w,(f+m)%a==0&&(t[d++]=w);let A=(x+1)%s*r+b+m;i[g+1][m][A]=w}if((f+1)%s==0&&f!==n-1&&(p+1)%s==0&&p!==n-1){let w=.25*(_+o+h+l[4*(c+n+1)]);T=(x+1)*r+(b+1),y[T]=w,t[d++]=w;let A=(x+1)*r;i[g][m+1][A]=w;let E=s;i[g+1][m][E]=w;let C=0;i[g+1][m+1][C]=w}}},getDefault:Si,getHTML:function(l,t){return Ie(l,t)},getLinesIntersection2v:function(l,t,i,s,r){let n=t.sub(l),a=s.sub(i),o=-n.y,h=+n.x,c=-(o*l.x+h*l.y),d=-a.y,u=+a.x,_=-(d*i.x+u*i.y),p=d*l.x+u*l.y+_,f=d*t.x+u*t.y+_,m=o*i.x+h*i.y+c,g=o*s.x+h*s.y+c;if(r&&(p*f>0||m*g>0))return;let y=p/(p-f);return new H(l.x+y*n.x,l.y+y*n.y)},getLinesIntersectionLonLat:kn,getMatrixSubArray32:In,getMatrixSubArray64:Ks,getMatrixSubArrayBoundsExt:Es,getTileImageResolution:function(l,t,i,s=256,r=Sn){let n=Gt(l,t,i),a=n.getSouthWest().inverseMercator(),o=n.getNorthEast().inverseMercator();return[r.getGreatCircleDistance(a,new L(o.lon,a.lat))/s,r.getGreatCircleDistance(a,new L(a.lon,o.lat))/s]},getUrlParam:zn,htmlColorToFloat32Array:ft,htmlColorToRgb:Gi,htmlColorToRgba:at,isEmpty:Fe,isImageLoaded:Ls,isNumber:Mn,isString:Zi,isUndef:yr,isUndefExt:function(l,t){return yr(l)?t:l},loadImage:Ri,makeArray:zt,makeArrayTyped:se,parseHTML:$s,print2d:Rn,rgbToStringHTML:As,spliceArray:Ce,spliceTypedArray:ae,stamp:Ws,stringTemplate:Ie,stringTemplate2:ri,throttle:di,toFixedMax:Ps,xmlToJson:function l(t){let i={};if(t.nodeType===1){if(t.attributes.length>0){i["@attributes"]={};for(let s=0;s<t.attributes.length;s++){let r=t.attributes.item(s);i["@attributes"][r.nodeName]=r.nodeValue}}}else t.nodeType===3&&(i=t.nodeValue);if(t.hasChildNodes())for(let s=0;s<t.childNodes.length;s++){let r=t.childNodes.item(s),n=r.nodeName;if(i[n]===void 0)i[n]=l(r);else{if(i[n].push===void 0){let a=i[n];i[n]=[],i[n].push(a)}i[n].push(l(r))}}return i}},Symbol.toStringTag,{value:"Module"})),Mi=1e3,Ss=1/60,br=1/24,ui=3600,Rs=1/ui,er=43200,Bi=1440,Wo=1/Bi,Ze=86400,$o=864e5,tr=11574074074074074e-24,st=1/Ze,qi=2451545;function Dn(l,t,i){let s=(t-14)/12|0,r=l+4800+s;return(1461*r/4|0)+(367*(t-2-12*s)/12|0)-(3*((r+100)/100|0)/4|0)+i-32075}function Yi(l){let t=Dn(l.getUTCFullYear(),l.getUTCMonth()+1,l.getUTCDate()),i=l.getUTCHours()-12;i<0&&(i+=24);let s=l.getUTCSeconds()+i*ui+60*l.getUTCMinutes()+.001*l.getUTCMilliseconds();s>=er&&t--;let r=s*st|0;return t+=r,s-=Ze*r,s<0&&(t--,s+=Ze),t+s*st}function Ms(l){let t=On,i=Et(t,l,(function(r,n){return r-n.jd}));i<0&&(i=~i),i>=t.length&&(i=t.length-1);let s=t[i].leapSeconds;return i!==0&&(t[i].jd-l)*Ze>s&&(s=t[i-1].leapSeconds),l+s*st}function rs(l){let t=On,i=Et(t,l,(function(r,n){return r-n.jd}));if(i<0&&(i=~i),i>=t.length)return l-t[i-1].leapSeconds*st;if(i===0)return l-t[0].leapSeconds*st;let s=(t[i].jd-l)*Ze;return s===0?l-t[i].leapSeconds*st:s<=1?void 0:l-t[i-1].leapSeconds*st}function Bs(l){let t=0|l,i=(l-t)*Ze;i>=er&&t++;let s=t+68569|0,r=4*s/146097|0;s=s-((146097*r+3)/4|0)|0;let n=4e3*(s+1)/1461001|0;s=s-(1461*n/4|0)+31|0;let a=80*s/2447|0,o=s-(2447*a/80|0)|0;s=a/11|0;let h=a+2-12*s|0,c=100*(r-49)+n+s|0,d=i*Rs|0,u=i-d*ui,_=u*Ss|0;u-=60*_;let p=0|u,f=(u-p)*Mi|0;return d+=12,d>23&&(d-=24),new Date(Date.UTC(c,h-1,o,d,_,p,f))}function Fn(l,t){return l+t*tr}function wr(l,t){return l+t*st}function ne(l,t){return{jd:l,leapSeconds:t}}const On=[ne(24413175e-1,10),ne(24414995e-1,11),ne(24416835e-1,12),ne(24420485e-1,13),ne(24424135e-1,14),ne(24427785e-1,15),ne(24431445e-1,16),ne(24435095e-1,17),ne(24438745e-1,18),ne(24442395e-1,19),ne(24447865e-1,20),ne(24451515e-1,21),ne(24455165e-1,22),ne(24462475e-1,23),ne(24471615e-1,24),ne(24478925e-1,25),ne(24482575e-1,26),ne(24488045e-1,27),ne(24491695e-1,28),ne(24495345e-1,29),ne(24500835e-1,30),ne(24506305e-1,31),ne(24511795e-1,32),ne(24537365e-1,33),ne(24548325e-1,34),ne(24561095e-1,35),ne(24572045e-1,36)],Xo=Ms(qi);Object.freeze(Object.defineProperty({__proto__:null,DAYS_PER_JULIAN_CENTURY:36525,DAYS_PER_JULIAN_YEAR:365.25,DateToTAI:function(l){return Ms(Yi(l))},DateToUTC:Yi,HOURS_PER_DAY:24,J2000:qi,J2000TAI:Xo,MILLISECONDS_PER_DAY:$o,MILLISECONDS_PER_SECOND:Mi,MINUTES_PER_DAY:Bi,MINUTES_PER_HOUR:60,MODIFIED_JULIAN_DATE_DIFFERENCE:24000005e-1,ONE_BY_HOURS_PER_DAY:br,ONE_BY_MILLISECONDS_PER_DAY:tr,ONE_BY_MINUTES_PER_DAY:Wo,ONE_BY_SECONDS_PER_DAY:st,ONE_BY_SECONDS_PER_HOUR:Rs,ONE_BY_SECONDS_PER_MINUTE:Ss,PICOSECOND:1e-9,SECONDS_PER_12_HOURS:er,SECONDS_PER_DAY:Ze,SECONDS_PER_HOUR:ui,SECONDS_PER_MILLISECOND:.001,SECONDS_PER_MINUTE:60,T:function(l){return(l-qi)/36525},TAItoDate:function(l){let t=rs(l);return t||(t=rs(wr(l,-1)),console.trace(`TAItoDate - can't convert ${l.toString()} to utc.`)),Bs(t)},TAItoUTC:rs,UTCtoDate:Bs,UTCtoTAI:Ms,addDays:function(l,t){return l+t},addHours:function(l,t){return l+t*br},addMilliseconds:Fn,addMinutes:function(l,t){return l+t*Bi},addSeconds:wr,daysToSeconds:function(l){return l*Ze},getDayNumber:Dn,getDays:function(l){return 0|l},getHours:function(l){let t=(l-(0|l))*Ze,i=t*Rs|0,s=t-i*ui,r=s*Ss|0;s-=60*r;let n=0|s;return i+=12+r/60+n/3600+((s-n)*Mi|0)/1e3,i>23&&(i-=24),i},getMilliseconds:function(l){let t=l-(0|l);return t*=Ze,(t-(0|t))*Mi|0},getMinutes:function(l){return(l-(0|l))*Bi|0},getSeconds:function(l){return(l-(0|l))*Ze},secondsToDays:function(l){return l*st}},Symbol.toStringTag,{value:"Module"}));class Nn{constructor(t){this.vertices=[new v,new v,new v,new v,new v,new v,new v,new v],t&&this.setFromBoundsArr(t)}copy(t){for(let i=0,s=this.vertices.length;i<s;i++)this.vertices[i].copy(t.vertices[i])}setFromBoundsArr(t){let i=t[0],s=t[3],r=t[1],n=t[4],a=t[2],o=t[5],h=this.vertices;h[0].set(i,r,a),h[1].set(s,r,a),h[2].set(s,r,o),h[3].set(i,r,o),h[4].set(i,n,a),h[5].set(s,n,a),h[6].set(s,n,o),h[7].set(i,n,o)}setFromExtent(t,i){this.setFromBoundsArr(i.getCartesianBounds(t))}}class Be{constructor(t=0,i){this.radius=t,this.center=i?i.clone():new v}setFromBounds(t){let i=new v(t[0],t[1],t[2]);this.center.set(i.x+.5*(t[3]-i.x),i.y+.5*(t[3]-i.y),i.z+.5*(t[5]-i.z)),this.radius=this.center.distance(i)}setFromExtent(t,i){this.setFromBounds(i.getCartesianBounds(t))}}Object.freeze(Object.defineProperty({__proto__:null,Box:Nn,Sphere:Be},Symbol.toStringTag,{value:"Module"}));function le(l,t){return new ir(l,t)}const Hn=class Vn{constructor(t,i){this.__id=Vn.__counter__++,this._eventNames=[],t&&this.registerNames(t),this._sender=i||this,this._stopPropagation=!1,this._stampCache={}}bindSender(t){this._sender=t||this}registerNames(t){for(let i=0;i<t.length;i++)this[t[i]]={active:!0,handlers:[]},this._eventNames.push(t[i]);return this}_getStamp(t,i,s){return`${t}_${i}_${s}`}_stamp(t,i){let s=Ws(i),r=this._getStamp(t,this.__id,s);return!this._stampCache[r]&&(this._stampCache[r]=s,!0)}on(t,i,s,r=0){if(this._stamp(t,i)&&this[t]){let n=i.bind(s||this._sender);n._openglobus_id=i._openglobus_id,n._openglobus_priority=r,Qs(this[t].handlers,n,((a,o)=>(o._openglobus_priority||0)-(a._openglobus_priority||0)))}}off(t,i){if(i){let s=this._getStamp(t,this.__id,i._openglobus_id);if(i._openglobus_id&&this._stampCache[s]){let r=this[t].handlers,n=r.length,a=-1;for(;n--;)if(r[n]._openglobus_id===i._openglobus_id){a=n;break}a!==-1&&(r.splice(a,1),this._stampCache[s]=void 0,delete this._stampCache[s])}}}dispatch(t,...i){let s=!0;if(t&&t.active&&!this._stopPropagation){let r=t.handlers.slice(0),n=r.length;for(;n--;)r[n](...i)===!1&&(s=!1)}return this._stopPropagation=!1,s}stopPropagation(){this._stopPropagation=!0}clear(){for(let t=0;t<this._eventNames.length;t++){let i=this[this._eventNames[t]];i.handlers.length=0,i.handlers=[]}this._eventNames.length=0,this._eventNames=[]}};Hn.__counter__=0;let ir=Hn;const Zo=["render"],Un=class We{constructor(t={}){this.__id=We.__counter__++,this.events=le(Zo),this.model=t.model||null,this.template=t.template||"",this.parent=t.parent||null,this._classList=t.classList||[],this.el=null,t.initRender&&this.render()}on(t,i,s,r){this.events.on(t,i,s,r)}off(t,i){this.events.off(t,i)}static getHTML(t,i){return Ie(t,i)}static parseHTML(t){return $s(t)}static insertAfter(t,i){Array.isArray(t)||(t=[t]);for(let s=0;s<t.length;s++)i.parentNode&&i.parentNode.insertBefore(t[s],i.nextSibling);return t}static insertBefore(t,i){Array.isArray(t)||(t=[t]);for(let s=0;s<t.length;s++)i.parentNode&&i.parentNode.insertBefore(t[s],i);return t}insertBefore(t){this.el||this.render(),this.el&&(t instanceof HTMLElement&&t.parentNode&&We.insertBefore(this.el,t),t instanceof We&&t.el&&t.el.parentNode&&We.insertBefore(this.el,t.el))}insertAfter(t){this.el||this.render(),this.el&&(t instanceof HTMLElement&&t.parentNode&&We.insertAfter(this.el,t),t instanceof We&&t.el&&t.el.parentNode&&We.insertAfter(this.el,t.el))}isEqual(t){return t.__id===this.__id}appendTo(t,i=!1,s=!1){return t&&(this.el||(this.beforeRender(t),this.render()),this.el&&this.el.parentNode&&this.el.parentNode.removeChild(this.el),i&&(t.innerHTML=""),this.el&&(s&&t.childNodes[0]?We.insertBefore(this.el,t.childNodes[0]):t.appendChild(this.el)),this.afterRender(t)),this}afterRender(t){}beforeRender(t){}stopPropagation(){this.events.stopPropagation()}renderTemplate(t){return We.parseHTML(We.getHTML(this.template,t||{}))[0]}render(t){this.el=this.renderTemplate(t);for(let i=0,s=this._classList.length;i<s;i++)this.el.classList.add(this._classList[i]);return this.events.dispatch(this.events.render,this),this}select(t){return this.el?this.el.querySelector(t):null}selectRemove(t){if(this.el){let i=this.select(t);if(i&&i.parentNode)return i.parentNode.removeChild(i),i}}selectAll(t,i){if(this.el){const s=this.el.querySelectorAll(t);if(i)for(let r=0,n=s.length;r<n;r++)i(s[r],r);return s}}remove(){this.el&&this.el.parentNode&&this.el.parentNode.removeChild(this.el)}};Un.__counter__=0;let xe=Un;const Qo=["click","mousedown","mouseup","touchstart","touchend","touchcancel"];class ot extends xe{constructor(t={}){super({template:Ie(`<div class="og-button" title="{title}">
       <div class="og-button-icon">{icon}</div>
       <div class="og-button-text">{text}</div>
    </div>`,{icon:t.icon||"",text:t.text||"",title:t.title||""}),...t}),this._onMouseDown=i=>{i.preventDefault(),this.events.dispatch(this.events.mousedown,this,i)},this._onMouseUp=i=>{i.preventDefault(),this.events.dispatch(this.events.mouseup,this,i)},this._onTouchStart=i=>{i.preventDefault(),this.events.dispatch(this.events.touchstart,this,i)},this._onTouchEnd=i=>{i.preventDefault(),this.events.dispatch(this.events.touchend,this,i)},this._onTouchCancel=i=>{i.preventDefault(),this.events.dispatch(this.events.touchcancel,this,i)},this._onMouseClick=i=>{this._mouseClickHandler(i)},this.events=this.events.registerNames(Qo),this.el=null,this.name=t.name||"",this.$icon=null,this.$text=null}render(t){return super.render(t),this.$icon=this.select(".og-button-icon"),this.$text=this.select(".og-button-text"),this.el.__og_button__=this,this._initEvents(),this}_initEvents(){this.el&&(this.el.addEventListener("click",this._onMouseClick),this.el.addEventListener("mousedown",this._onMouseDown),this.el.addEventListener("mouseup",this._onMouseUp),this.el.addEventListener("touchstart",this._onTouchStart),this.el.addEventListener("touchend",this._onTouchEnd),this.el.addEventListener("touchcancel",this._onTouchCancel))}_mouseClickHandler(t){t.preventDefault(),this.events.dispatch(this.events.click,this,t)}remove(){this._clearEvents(),super.remove()}_clearEvents(){this.el&&this.el.removeEventListener("click",this._onMouseClick)}}const Gn=class jn{constructor(t={}){this.__id=jn.__counter__++,this._name=t.name||`_control_${this.__id.toString()}`,this.planet=null,this._initialized=!1,this.renderer=null,this.autoActivate=t.autoActivate||!1,this._active=!1,this._deferredActive=!0}get name(){return this._name}oninit(){}onadd(){}onremove(){}onactivate(){}ondeactivate(){}addTo(t){t&&(this.renderer=t,t.controls[this.name]=this,this.onadd&&this.onadd(),t.isInitialized()&&!this._initialized&&(this._initialized=!0,this.oninit&&this.oninit(),this.autoActivate&&this.activate()))}remove(){this.deactivate(),this.onremove&&this.onremove();let t=this.renderer,i=this.name;if(!t)return;let s=t.controls[i];s&&this.isEqual(s)&&delete t.controls[i],this.renderer=null,this._active=!1,this._initialized=!1}activate(){this._active||(this._initialized||(this._initialized=!0,this.oninit&&this.oninit()),this._deferredActive?(this._active=!0,this.onactivate&&this.onactivate()):this._deferredActive=!0)}deactivate(){this._active?(this._active=!1,this.ondeactivate&&this.ondeactivate()):this._initialized||(this._deferredActive=!1)}isActive(){return this._active}isEqual(t){return t.__id===this.__id}};Gn.__counter__=0;let K=Gn;class qn extends K{constructor(t={}){super(t),this._heading=0,this._svg=null}oninit(){let t=new ot({classList:["og-map-button","og-compass-button"],icon:`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   viewBox="0 0 110.6 110.3"
   version="1.1"
   id="svg21"
   sodipodi:docname="aaa.svg"
   inkscape:version="0.92.3 (2405546, 2018-03-11)">
  <metadata
     id="metadata11">
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
      </cc:Work>
    </rdf:RDF>
  </metadata>
  <defs
     id="defs25" />
  <sodipodi:namedview
     pagecolor="#ffffff"
     bordercolor="#666666"
     borderopacity="1"
     objecttolerance="10"
     gridtolerance="10"
     guidetolerance="10"
     inkscape:pageopacity="0"
     inkscape:pageshadow="2"
     inkscape:window-width="1920"
     inkscape:window-height="1001"
     id="namedview23"
     showgrid="false"
     inkscape:zoom="9.4900968"
     inkscape:cx="28.376998"
     inkscape:cy="60.17054"
     inkscape:window-x="-9"
     inkscape:window-y="-9"
     inkscape:window-maximized="1"
     inkscape:current-layer="svg21" />
  <g
     id="Layer_2"
     data-name="Layer 2"
     transform="matrix(1,0,0,-1,0,110.3)">
    <g
       id="_1"
       data-name=" 1">
      <g
         id="_Group_"
         data-name="&lt;Group&gt;">
        <g
           id="_Group_7"
           data-name="&lt;Group&gt;">
          <polygon
             id="_Path_7"
             data-name="&lt;Path&gt;"
             points="55.2,97.6 55.3,97.4 55.3,97.6 55.3,97.2 65.3,55.1 55.3,55.1 55.2,55.1 45.3,55.1 55.2,97.2 "
             style="fill:#ff2b45" />
          <polygon
             id="_Path_8"
             data-name="&lt;Path&gt;"
             points="55.3,12.7 55.3,12.9 55.2,12.7 55.2,13.1 45.3,55.1 55.2,55.1 55.3,55.1 65.3,55.1 55.3,13.1 "
             style="fill:#cecece;" />
        </g>
      </g>
    </g>
  </g>
</svg>`});t.appendTo(this.renderer.div),t.events.on("click",this._onClick,this),t.events.on("touchstart",this._onClick,this),this._svg=t.select("svg"),this.renderer.events.on("draw",this._draw,this)}_onClick(){const t=this.planet;let i=t.getCartesianFromPixelTerrain(this.renderer.handler.getCenter());i?t.flyCartesian(i.normal().scaleTo(i.length()+i.distance(t.camera.eye)),{amplitude:0,completeCallback:()=>{t.camera.look(i)}}):t.flyCartesian(t.camera.eye)}_draw(){this.setHeading(this.planet.camera.getHeading())}setHeading(t){this._heading!==t&&(this._heading=t,this._svg.style.transform=`rotateZ(${-t}deg)`)}}const Ko=`<svg className="svg-icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor; overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <path d="M777.856 280.192l-33.92-33.952-231.872 231.872-231.84-231.872-33.984 33.888 231.872 231.904-231.84 231.84 33.888 33.984 231.904-231.904 231.84 231.872 33.952-33.888-231.872-231.904z"/>
</svg>`,Jo=["resize","focus","visibility","dragstart","dragend"],Yn=class Wn extends xe{constructor(t={}){super({template:Ie(`<div class="og-ddialog" 
        style="display:{display}; resize:{resize}; width: {width}px; {height}; top: {top}px; left: {left}px; min-height: {minHeight}; max-height: {maxHeight}; min-width: {minWidth}; max-width: {maxWidth};">
       <div class="og-ddialog-header">
         <div class="og-ddialog-header__title">{title}</div>      
         <div class="og-ddialog-header__buttons"></div>      
        </div>
       <div class="og-ddialog-container"></div>
    </div>>`,{title:t.title||"",display:Si(t.visible,!0)?"flex":"none",resize:Si(t.resizable,!0)?"both":"none",width:t.width||300,height:t.height?`height: ${t.height||200}px`:"",left:t.left||0,top:t.top||0,minHeight:t.minHeight?`${t.minHeight}px`:"unset",maxHeight:t.maxHeight?`${t.maxHeight}px`:"unset",minWidth:t.minWidth?`${t.minWidth}px`:"unset",maxWidth:t.maxWidth?`${t.maxWidth}px`:"unset"}),...t}),this._onCloseBtnClick=()=>{this.close()},this._onMouseDownAll=()=>{this.bringToFront()},this._onMouseDown=i=>{i.preventDefault(),this._startDragging(),this._startPosX=i.clientX,this._startPosY=i.clientY,document.addEventListener("mousemove",this._onMouseMove),document.addEventListener("mouseup",this._onMouseUp)},this._onMouseMove=i=>{i.preventDefault();let s=this._startPosX-i.clientX,r=this._startPosY-i.clientY;this._startPosX=i.clientX,this._startPosY=i.clientY,this.setPosition(this.el.offsetLeft-s,this.el.offsetTop-r)},this._onMouseUp=()=>{this._clearDragging(),document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousemove",this._onMouseMove)},this.events=this.events.registerNames(Jo),this._width=t.width||300,this._height=t.height||200,this._startPosX=0,this._startPosY=0,this.$header=null,this.$title=null,this.$container=null,this.$buttons=null,this._closeBtn=new ot({icon:Ko,classList:["og-button-size__20"]}),this.useHide=t.useHide||!1,this._visibility=Si(t.visible,!0),this._right=t.right!=null?t.right:null}setContainer(t){this.$container.innerHTML=t}get container(){return this.$container}get width(){return this.el?parseFloat(this.el.style.width):this._width}get height(){return this.el?parseFloat(this.el.style.height):this._height}bringToFront(){this.el.style.zIndex=String(Wn.__zIndex__++)}render(t){return super.render(t),this.bringToFront(),this.$header=this.select(".og-ddialog-header"),this.$title=this.select(".og-ddialog-header__title"),this.$container=this.select(".og-ddialog-container"),this.$buttons=this.select(".og-ddialog-header__buttons"),this._initEvents(),this._initButtons(),this._right!=null&&(this.el.style.visibility="hidden",new IntersectionObserver(((i,s)=>{i.forEach((r=>{r.isIntersecting&&(this.el.style.visibility="visible",this.el.parentNode&&(this.setPosition(this.el.parentNode.clientWidth-this.el.clientWidth-this._right),s.disconnect()))}))})).observe(this.el)),this}show(){this._visibility||(this._visibility=!0,this.el.style.display="flex",this.bringToFront(),this.events.dispatch(this.events.visibility,!0,this))}hide(){this._visibility&&(this._visibility=!1,this.el.style.display="none",this.events.dispatch(this.events.visibility,!1,this))}close(){this.useHide?this.hide():this.remove()}setVisibility(t){t?this.show():this.hide()}getVisibility(){return this._visibility}_initButtons(){this._closeBtn.events.on("click",this._onCloseBtnClick),this._closeBtn.appendTo(this.$buttons)}_initEvents(){this.$header.addEventListener("mousedown",this._onMouseDown),this.el.addEventListener("mousedown",this._onMouseDownAll)}setPosition(t,i){t!=null&&(this.el.style.left=`${t}px`),i!=null&&(this.el.style.top=`${i}px`)}_startDragging(){this.el.classList.contains("dragging")||(this.el.classList.add("dragging"),this.events.dispatch(this.events.dragstart,this))}_clearDragging(){this.el.classList.contains("dragging")&&(this.events.dispatch(this.events.dragend,this),this.el.classList.remove("dragging"))}remove(){this._clearDragging(),this._clearEvents(),super.remove()}_clearEvents(){this._closeBtn.events.off("click",this._onCloseBtnClick),document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousemove",this._onMouseMove),this.$header.removeEventListener("mousedown",this._onMouseDown),this.el.removeEventListener("mousedown",this._onMouseDownAll)}};Yn.__zIndex__=0;let it=Yn;const el=["change"];class de extends ot{constructor(t){super({...t}),this._onMouseClick=i=>{this.preventClick||(this._mouseClickHandler(i),this.setActive(!this.isActive))},this.events=this.events.registerNames(el),this._isActive=t.isActive||!1,this.preventClick=t.preventClick||!1}setActive(t,i=!1){t!==this._isActive&&(this._isActive=t,this._toggle(),i||this.events.dispatch(this.events.change,t,this))}_toggle(){this.el&&this.el.classList.toggle("og-button__active")}get isActive(){return this._isActive}render(t){return super.render(t),this._isActive&&this._toggle(),this}}const ni=[2,3,0,1],Tr=[[-1,-1,0,1],[1,-1,3,-1],[2,3,-1,-1],[-1,0,-1,2]],tl=[[2,3,0,1],[1,0,3,2],[2,3,0,1],[1,0,3,2]],il=[[0,1,0,0],[1,0,0,0],[0,1,0,1],[1,1,1,1]];class $n{constructor(t,i){this.segment=t,this.layer=i,this.isReady=!1,this.isLoading=!1,this.texture=null,this.pickingMask=null,this.textureExists=!1,this.appliedNodeId=0,this.appliedNode=null,this.texOffset=[0,0,1,1],this.loadingAttempts=0,this._updateTexture=null,this._updatePickingMask=null,this.pickingReady=!1}abortLoading(){this.layer.abortMaterialLoading(this)}_createTexture(t){return this.layer._planet&&this.layer.createTexture(t,this.layer._internalFormat,this.isReady?this.texture:null)}applyImage(t){this.segment.initialized&&(this._updateTexture=null,this.texture=this._createTexture(t),this.isReady=!0,this.pickingReady=!0,this.textureExists=!0,this.isLoading=!1,this.appliedNodeId=this.segment.node.nodeId,this.texOffset=[0,0,1,1])}applyTexture(t,i){this.segment.initialized&&(this.texture=t,this._updateTexture=null,this.pickingMask=i||null,this._updatePickingMask=null,this.isReady=!0,this.pickingReady=!0,this.textureExists=!0,this.isLoading=!1,this.appliedNodeId=this.segment.node.nodeId,this.texOffset=[0,0,1,1])}textureNotExists(){this.segment.initialized&&(this.pickingReady=!0,this.isLoading=!1,this.isReady=!0,this.textureExists=!1)}clear(){this.loadingAttempts=0,this.layer.clearMaterial(this)}}const Xn=class Zn{constructor(t,i={}){if(this.isVector=!1,this.__id=Zn.__counter__++,this._iconSrc=i.iconSrc||null,this.events=le(Qn,this),this.name=t||"noname",this.properties=i.properties||{},this.hideInLayerSwitcher=i.hideInLayerSwitcher||!1,this._hasImageryTiles=!0,this._opacity=i.opacity!=null?i.opacity:1,this.minZoom=i.minZoom||0,this.maxZoom=i.maxZoom!=null?i.maxZoom:50,this._planet=null,this.isVector=!1,this._attribution=i.attribution||"",this._zIndex=i.zIndex||0,this._isBaseLayer=i.isBaseLayer||!1,this._defaultTextures=i.defaultTextures||[null,null],this._visibility=i.visibility===void 0||i.visibility,this._fading=i.fading||!1,this._fadingFactor=this._opacity/30,this._fading?this._fadingOpacity=0:this._fadingOpacity=this._opacity,this._height=i.height||0,this._extent=new j,this.createTexture=null,this._textureFilter=i.textureFilter?i.textureFilter.trim().toUpperCase():"MIPMAP",this._isSRGB=i.isSRGB!=null&&i.isSRGB,this._internalFormat=null,this._extentMerc=new j,this.setExtent(Xs(i.extent,new j(new L(-180,-90),new L(180,90)))),this._pickingColor=new v,this._pickingEnabled=i.pickingEnabled===void 0||i.pickingEnabled,this._isPreloadDone=!1,this._preLoadZoomLevels=i.preLoadZoomLevels||[0,1],this._ambient=null,this._diffuse=null,this._specular=null,i.ambient){let s=Oe(i.ambient,new v(.2,.2,.2));this._ambient=new Float32Array([s.x,s.y,s.z])}if(i.diffuse){let s=Oe(i.diffuse,new v(.8,.8,.8));this._diffuse=new Float32Array([s.x,s.y,s.z])}if(i.specular){let s=Oe(i.specular,new v(3e-4,3e-4,3e-4)),r=i.shininess||20;this._specular=new Float32Array([s.x,s.y,s.z,r])}this.nightTextureCoefficient=i.nightTextureCoefficient||1}get iconSrc(){return this._iconSrc}set iconSrc(t){this._iconSrc=t}set diffuse(t){if(t){let i=Oe(t);this._diffuse=new Float32Array(i.toArray())}else this._diffuse=null}set ambient(t){if(t){let i=Oe(t);this._ambient=new Float32Array(i.toArray())}else this._ambient=null}set specular(t){if(t){let i=Oe(t);this._specular=new Float32Array([i.x,i.y,i.y,this._specular?this._specular[3]:0])}else this._specular=null}set shininess(t){this._specular&&(this._specular[3]=t)}static getTMS(t,i,s){return{x:t,y:(1<<s)-i-1,z:s}}static getTileIndex(t,i,s,r){return`${r}::${t}_${i}_${s}`}get instanceName(){return"Layer"}get rendererEvents(){return this.events}set opacity(t){t!==this._opacity&&(this._fading?t>this._opacity?this._fadingFactor=(t-this._opacity)/30:t<this._opacity&&(this._fadingFactor=(this._opacity-t)/30):this._fadingOpacity=t,this._opacity=t)}set pickingEnabled(t){this._pickingEnabled=t}get pickingEnabled(){return this._pickingEnabled}hasImageryTiles(){return this._hasImageryTiles}getID(){return this.__id}get id(){return this.__id}get _id(){return this.__id}isEqual(t){return t.__id===this.__id}_assignPlanet(t){this._planet=t,t._layers.push(this),t.renderer&&t.renderer.isInitialized()&&(this._isSRGB?this._internalFormat=t.renderer.handler.gl.SRGB8_ALPHA8:this._internalFormat=t.renderer.handler.gl.RGBA8,this.createTexture=t.renderer.handler.createTexture[this._textureFilter],this.events.on("visibilitychange",t._onLayerVisibilityChanged,t),this._isBaseLayer&&this._visibility&&t.setBaseLayer(this),t.events.dispatch(t.events.layeradd,this),this.events.dispatch(this.events.add,t),t.updateVisibleLayers(),this._bindPicking(),this._visibility&&this.hasImageryTiles()&&this._preLoad())}get isIdle(){return this._planet&&this._planet.quadTreeStrategy._terrainCompletedActivated||!1}_bindPicking(){this._planet&&this._planet.renderer&&this._planet.renderer.assignPickingColor(this)}addTo(t){this._planet||this._assignPlanet(t)}remove(){let t=this._planet;if(t){for(let i=0;i<t._layers.length;i++)if(this.isEqual(t._layers[i]))return t.renderer&&t.renderer.clearPickingColor(this),t._layers.splice(i,1),t.updateVisibleLayers(),this.clear(),t.events.dispatch(t.events.layerremove,this),this.events.dispatch(this.events.remove,t),this._planet=null,this._internalFormat=null,this.createTexture=null,this}return this}clear(){this._planet&&this._planet._clearLayerMaterial(this)}get planet(){return this._planet}setAttribution(t){this._attribution!==t&&(this._attribution=t,this._planet&&this._planet.updateAttributionsList())}getAttribution(){return this._attribution}setHeight(t){this._height=t,this._planet&&this._planet.updateVisibleLayers()}getHeight(){return this._height}setZIndex(t){this._zIndex=t,this._planet&&this._planet.updateVisibleLayers()}getZIndex(){return this._zIndex}bringToFront(){if(this._planet){let t=this._planet.visibleTileLayers,i=t[t.length-1];i.isEqual(this)||this.setZIndex(i.getZIndex()+1)}}isBaseLayer(){return this._isBaseLayer}setBaseLayer(t){this._isBaseLayer=t,this._planet&&(!t&&this._planet.baseLayer&&this.isEqual(this._planet.baseLayer)&&(this._planet.baseLayer=null),this._planet.updateVisibleLayers())}setVisibility(t){t!==this._visibility&&(this._visibility=t,this._planet&&(this._isBaseLayer&&t&&this._planet.setBaseLayer(this),this._planet.updateVisibleLayers(),!t||this._isPreloadDone||this.isVector||(this._isPreloadDone=!0,this._preLoad())),this.events.dispatch(this.events.visibilitychange,this))}_forceMaterialApply(t){let i=t.materials,s=i[this.__id];s||(s=i[this.__id]=this.createMaterial(t)),s.isReady||(t.quadTreeStrategy._renderCompleted=!1),this.applyMaterial(s,!0)}clearMaterial(t){}loadMaterial(t,i=!1){}applyMaterial(t,i=!1){return[0,0,1,1]}_preLoadRecursive(t,i){if(!(t.segment.tileZoom>i)){this._preLoadZoomLevels.includes(t.segment.tileZoom)&&this._forceMaterialApply(t.segment);for(let s=0,r=t.nodes.length;s<r;s++)t.nodes[s]&&this._preLoadRecursive(t.nodes[s],i)}}_preLoad(){if(this._planet&&this._preLoadZoomLevels.length){let t=this._planet,i=Math.max(...this._preLoadZoomLevels);for(let s=0,r=t.quadTreeStrategy.quadTreeList.length;s<r;s++)this._preLoadRecursive(t.quadTreeStrategy.quadTreeList[s],i)}}getVisibility(){return this._visibility}setExtent(t){let i=t.southWest.clone(),s=t.northEast.clone();i.lat<ke&&(i.lat=ke),s.lat>ce&&(s.lat=ce),this._extent=t.clone(),this._extentMerc=new j(i.forwardMercator(),s.forwardMercator()),this._correctFullExtent()}getExtent(){return this._extent}getExtentMerc(){return this._extentMerc}flyExtent(){var t;(t=this._planet)==null||t.flyExtent(this.getExtent())}viewExtent(){var t;(t=this._planet)==null||t.viewExtent(this.getExtent())}_correctFullExtent(){}get opacity(){return this._opacity}get screenOpacity(){return this._fading?this._fadingOpacity:this._opacity}_refreshFadingOpacity(t,i){let s=this._planet;return this._visibility&&s.getViewExtent().overlaps(this._extent)&&i>=this.minZoom&&t<=this.maxZoom?(this._fadingOpacity+=this._fadingFactor,(this._fadingFactor>0&&this._fadingOpacity>this._opacity||this._fadingFactor<0&&this._fadingOpacity<this._opacity)&&(this._fadingOpacity=this._opacity),!1):(this._fadingOpacity-=this._fadingFactor,this._fadingOpacity<=0&&(this._fadingOpacity=0),!1)}createMaterial(t){return new $n(t,this)}redraw(){var t;(t=this._planet)==null||t.quadTreeStrategy.clearLayerMaterial(this)}abortMaterialLoading(t){}abortLoading(){}};Xn.__counter__=0;let Ve=Xn;const Qn=["visibilitychange","add","remove","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"],sl=["load","loadend"],ks=class Ke extends Ve{constructor(t,i){super(t,i),this.events=this.events.registerNames(sl),this.animated=i.animated||!1,this.minNativeZoom=i.minNativeZoom||0,this.maxNativeZoom=i.maxNativeZoom||100,this._counter=0,this._pendingsQueue=[],this.drawTile=i.drawTile,this._onLoadend_=null}addTo(t){return this._onLoadend_=this._onLoadend.bind(this),this.events.on("loadend",this._onLoadend_,this),super.addTo(t)}remove(){return this.events.off("loadend",this._onLoadend_),this._onLoadend_=null,super.remove()}_onLoadend(){this._planet&&this._planet.quadTreeStrategy._terrainCompletedActivated&&this._planet.events.dispatch(this._planet.events.layerloadend,this)}get instanceName(){return"CanvasTiles"}get isIdle(){return super.isIdle&&this._counter===0}abortLoading(){this._pendingsQueue.forEach((t=>{this.abortMaterialLoading(t)})),this._pendingsQueue=[]}setVisibility(t){t!==this._visibility&&(super.setVisibility(t),t||this.abortLoading())}loadMaterial(t){let i=t.segment;this._isBaseLayer?t.texture=i.getDefaultTexture():t.texture=i.planet.transparentTexture,(this._planet.layerLock.isFree()||t.segment.tileZoom<2)&&(t.isReady=!1,t.isLoading=!0,Ke.__requestsCounter>=Ke.MAX_REQUESTS&&this._counter?this._pendingsQueue.push(t):this._exec(t))}_exec(t){Ke.__requestsCounter++,this._counter++;const i=this.events.load;i.handlers.length&&this.events.dispatch(i,t),requestAnimationFrame((()=>{this.drawTile(t,(s=>{this._counter--,Ke.__requestsCounter--,this._correctCounter(),t.isLoading&&t.applyImage(s),this._dequeueRequest()}))}))}_correctCounter(){this._counter<0&&(this._counter=0),Ke.__requestsCounter<0&&(Ke.__requestsCounter=0)}abortMaterialLoading(t){t.isLoading&&(this._counter--,Ke.__requestsCounter--,this._correctCounter(),this._dequeueRequest()),t.isLoading=!1,t.isReady=!1}_dequeueRequest(){if(this._pendingsQueue.length){if(Ke.__requestsCounter<Ke.MAX_REQUESTS){const t=this._whilePendings();t&&this._exec(t)}}else this._counter===0&&this._planet&&this._planet.quadTreeStrategy._terrainCompletedActivated&&this.events.dispatch(this.events.loadend)}_whilePendings(){for(;this._pendingsQueue.length;){const t=this._pendingsQueue.pop();if(t&&t.segment&&t.segment.node){if(t.segment.initialized&&t.segment.node.getState()===1)return t;t.isLoading=!1}}return null}applyMaterial(t){if(t.isReady)return t.layer.animated&&requestAnimationFrame((()=>{this.drawTile(t,(function(i){t.applyImage(i)}))})),t.texOffset;if(t.segment.tileZoom<this.minNativeZoom)t.textureNotExists();else{let i=t.segment,s=i.node,r=!1,n=t.layer.maxNativeZoom;i.passReady&&!t.isLoading&&i.tileZoom<=n&&this.loadMaterial(t);let a=this._id,o=t;for(;s.parentNode;)if(s=s.parentNode,o=s.segment.materials[a],o&&o.textureExists){r=!0;break}if(i.passReady){if(s.segment.tileZoom===n)i.tileZoom>n&&t.textureNotExists();else if(s.segment.tileZoom<n){let h=i.node;for(;h.segment.tileZoom>n;)h=h.parentNode;let c=h.segment.materials[a];c?!c.isLoading&&!c.isReady&&this.loadMaterial(c):(c=h.segment.materials[t.layer._id]=t.layer.createMaterial(h.segment),this.loadMaterial(c))}}if(r){t.layer.animated&&requestAnimationFrame((()=>{t.segment&&this.drawTile(t,(function(c){t.applyImage(c)}))})),t.appliedNodeId=s.nodeId,t.texture=o.texture;let h=1/(2<<i.tileZoom-s.segment.tileZoom-1);t.texOffset[0]=i.tileX*h-s.segment.tileX,t.texOffset[1]=i.tileY*h-s.segment.tileY,t.texOffset[2]=h,t.texOffset[3]=h}else t.texture=i.planet.transparentTexture,t.texOffset[0]=0,t.texOffset[1]=0,t.texOffset[2]=1,t.texOffset[3]=1}return t.texOffset}clearMaterial(t){t.isReady&&(t.isReady=!1,t.textureExists&&t.texture&&!t.texture.default&&(t.segment.handler.gl.deleteTexture(t.texture),t.texture=null)),this.abortMaterialLoading(t),t.isLoading=!1,t.textureExists=!1,t.layer=null,t.segment=null}};ks.MAX_REQUESTS=20,ks.__requestsCounter=0;let Kn=ks;const rl=["change"];class Jn{constructor(t={}){this._onChange=(i,s)=>{if(i){s.preventClick=!0;for(let r=0;r<this._buttons.length;r++){let n=this._buttons[r];n.isEqual(s)||(n.setActive(!1),n.preventClick=!1)}this.events.dispatch(this.events.change,s)}},this.events=le(rl),this._buttons=t.buttons||[];for(let i=0;i<this._buttons.length;i++)this._bindButton(this._buttons[i])}_bindButton(t){t.events.on("change",this._onChange)}add(t){this._buttons.push(t),this._bindButton(t)}remove(t){for(let i=0;i<this._buttons.length;i++)if(this._buttons[i].isEqual(t))return this._buttons.splice(i),void t.events.off("change",this._onChange)}}class sr{constructor(t=2,i){this._sourceId=0,this._source=new Map,this._pendingQueue=[],this._numWorkers=t,this._workerQueue=[],i&&this.setProgram(i)}check(){this._pendingQueue.length&&this.make(this._pendingQueue.pop())}setProgram(t){if(Zi(t)){let i=new Blob([t],{type:"application/javascript"});for(let s=0;s<this._numWorkers;s++){let r=new Worker(URL.createObjectURL(i));r.onmessage=n=>{this._onMessage(n),this._workerQueue&&this._workerQueue.unshift(n.target),this.check()},this._workerQueue.push(r)}}else for(let i=0;i<this._numWorkers;i++){let s=new t;s.onmessage=r=>{this._onMessage(r),this._workerQueue&&this._workerQueue.unshift(r.target),this.check()},this._workerQueue.push(s)}}make(t){}_onMessage(t){}destroy(){for(let t=0;t<this._workerQueue.length;t++){const i=this._workerQueue[t];i.onmessage=null,i.terminate()}this._pendingQueue=[],this._workerQueue=[]}get pendingQueue(){return this._pendingQueue}}const ea=`(function(){"use strict";function n(i,f,u){let o=u.length,b=f*o;for(let A=0;A<o;A++)i[b+A]=u[A]}self.onmessage=function(i){var f=i.data.labelData,u=f[0],o=f[1],b=f[2],A=f[3],z=f[4],D=f[5],H=f[6],I=f[7],L=f[8],M=f[9],P=f[10],j=f[11],q=f[12],B=f[13],E=f[14],G=f[15],J=f[16],K=f[17],N=f[18],O=f[19],Q=f[20],R=f[21],S=f[22],T=f[23],U=f[24],Z=f[25],_=f[26],$=f[27],V=f[28],X=f[29];let w=new Float32Array(12*o),s=new Float32Array(24*o),y=new Float32Array(24*o),F=new Float32Array(18*o),g=new Float32Array(18*o),c=new Float32Array(6*o),d=new Float32Array(18*o),p=new Float32Array(24*o),x=new Float32Array(6*o),h=new Float32Array(18*o),v=new Float32Array(6*o),C=new Float32Array(6*o),m=new Float32Array(24*o),k=new Float32Array(18*o);for(let t=0;t<o;t++){n(w,t,b!==0?[0,0,0,-1,1,-1,1,-1,1,0,0,0]:[0,0,0,0,0,0,0,0,0,0,0,0]),n(s,t,[0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0]),n(y,t,[1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0]);var l,r=A,e=z,a=D;n(F,t,[r,e,a,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(g,t,[r=H,e=I,a=L,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(c,t,[r=M,r,r,r,r,r]),n(d,t,[r=P,e=j,a=q,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(p,t,[r=B,e=E,a=G,l=J,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l]),n(x,t,[r=K,r,r,r,r,r]),n(h,t,[r=N,e=O,a=Q,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(v,t,[r=R,r,r,r,r,r]),n(C,t,[r=S,r,r,r,r,r]),n(m,t,[r=T,e=U,a=Z,l=_,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l]),n(k,t,[r=$/255,e=V/255,a=X/255,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a])}self.postMessage({id:u,vertexArr:w,texCoordArr:s,gliphParamArr:y,positionHighArr:F,positionLowArr:g,sizeArr:c,offsetArr:d,rgbaArr:p,rotationArr:x,alignedAxisArr:h,fontIndexArr:v,outlineArr:C,outlineColorArr:m,pickingColorArr:k},[w.buffer,s.buffer,y.buffer,F.buffer,g.buffer,c.buffer,d.buffer,p.buffer,x.buffer,h.buffer,v.buffer,C.buffer,m.buffer,k.buffer])}})();
//# sourceMappingURL=LabelWorker.worker-BT1uJgYn.js.map
`,Cr=typeof self<"u"&&self.Blob&&new Blob([ea],{type:"text/javascript;charset=utf-8"});function nl(l){let t;try{if(t=Cr&&(self.URL||self.webkitURL).createObjectURL(Cr),!t)throw"";const i=new Worker(t,{name:l?.name});return i.addEventListener("error",(()=>{(self.URL||self.webkitURL).revokeObjectURL(t)})),i}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(ea),{name:l?.name})}finally{t&&(self.URL||self.webkitURL).revokeObjectURL(t)}}class al extends sr{constructor(t=4){super(t,nl)}_onMessage(t){let i=this._source.get(t.data.id);i.label._lockId===-2?requestAnimationFrame((()=>{this.make({handler:i.handler,label:i.label})})):i.handler.workerCallback(t.data,i.label),this._source.delete(t.data.id)}make(t){let i=t.label;if(t.handler._entityCollection){let s=i.serializeWorkerData(this._sourceId);if(s)if(this._workerQueue.length){let r=this._workerQueue.pop();this._source.set(this._sourceId,t),i._lockId=this._sourceId,this._sourceId++,r.postMessage({labelData:s},[s.buffer])}else this._pendingQueue.push(t)}}}const ta=class ia{constructor(t={}){this.__id=ia.__counter__++,this._position=He(t.position),this._positionHigh=new v,this._positionLow=new v,v.doubleToTwoFloats(this._position,this._positionHigh,this._positionLow),this._rotation=t.rotation||0,this._color=nt(t.color),this._alignedAxis=He(t.alignedAxis),this._offset=He(t.offset),this._visibility=t.visibility==null||t.visibility,this._entity=null,this._handler=null,this._handlerIndex=-1,this._isReady=!1,this._lockId=-1}setPosition(t,i,s){this._position.x=t,this._position.y=i,this._position.z=s,v.doubleToTwoFloats(this._position,this._positionHigh,this._positionLow),this._isReady&&this._handler?this._handler.setPositionArr(this._handlerIndex,this._positionHigh,this._positionLow):this._lockId!==-1&&(this._lockId=-2)}setPosition3v(t){this._position.x=t.x,this._position.y=t.y,this._position.z=t.z,v.doubleToTwoFloats(t,this._positionHigh,this._positionLow),this._isReady&&this._handler?this._handler.setPositionArr(this._handlerIndex,this._positionHigh,this._positionLow):this._lockId!==-1&&(this._lockId=-2)}getPosition(){return this._position}setOffset(t,i,s){this._offset.x=t,this._offset.y=i,s!=null&&(this._offset.z=s),this._isReady&&this._handler?this._handler.setOffsetArr(this._handlerIndex,this._offset):this._lockId!==-1&&(this._lockId=-2)}setOffset3v(t){this.setOffset(t.x,t.y,t.z)}getOffset(){return this._offset}setRotation(t){t!==this._rotation&&(this._rotation=t,this._isReady&&this._handler?this._handler.setRotationArr(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2))}getRotation(){return this._rotation}setOpacity(t){t!==this._color.w&&(t!=null&&(this._color.w=t),this._isReady&&this._handler?this._handler.setRgbaArr(this._handlerIndex,this._color):this._lockId!==-1&&(this._lockId=-2))}setColor(t,i,s,r){r===this._color.w&&t===this._color.x&&i===this._color.y&&this._color.z===s||(this._color.x=t,this._color.y=i,this._color.z=s,r!=null&&(this._color.w=r),this._isReady&&this._handler?this._handler.setRgbaArr(this._handlerIndex,this._color):this._lockId!==-1&&(this._lockId=-2))}setColor4v(t){this.setColor(t.x,t.y,t.z,t.w)}setColorHTML(t){this.setColor4v(at(t))}getColor(){return this._color}setVisibility(t){t!==this._visibility&&(this._visibility=t,this._isReady&&this._handler?this._handler.setVisibility(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2))}getVisibility(){return this._visibility}setAlignedAxis(t,i,s){this._alignedAxis.x=t,this._alignedAxis.y=i,this._alignedAxis.z=s,this._isReady&&this._handler?this._handler.setAlignedAxisArr(this._handlerIndex,this._alignedAxis):this._lockId!==-1&&(this._lockId=-2)}setAlignedAxis3v(t){this.setAlignedAxis(t.x,t.y,t.z)}getAlignedAxis(){return this._alignedAxis}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._isReady&&this._handler?this._handler.setPickingColorArr(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2)}serializeWorkerData(t){return this._handler?new Float32Array([]):null}};ta.__counter__=0;let sa=ta;class ol extends sa{constructor(t={}){super(t),this._handler=null,this._src=t.src||null,this._image=t.image||null,this._scale=1,this._width=t.width||(t.size?t.size[0]:30),this._height=t.height||(t.size?t.size[1]:30)}setSrc(t){this._src=t;let i=this._handler;if(i&&t&&t.length){let s=i._entityCollection.renderNode;if(s&&s.renderer){let r=s.renderer.billboardsTextureAtlas,n=this;r.loadImage(t,(function(a){a.__nodeIndex!=null&&r.get(a.__nodeIndex)?(n._image=a,i.setTexCoordArr(n._handlerIndex,r.get(n._image.__nodeIndex).texCoords)):(r.addImage(a),r.createTexture(),n._image=a,s.updateBillboardsTexCoords())}))}}}getSrc(){return this._src}setImage(t){this.setSrc(t.src)}getImage(){return this._image}setSize(t,i){this._width=t,this._height=i,this._handler&&this._handler.setSizeArr(this._handlerIndex,t*this._scale,i*this._scale)}getSize(){return{width:this._width,height:this._height}}setWidth(t){this.setSize(t,this._height)}getWidth(){return this._width}setHeight(t){this.setSize(this._width,t)}getHeight(){return this._height}}var ei=(l=>(l[l.POINT=1]="POINT",l[l.LINESTRING=2]="LINESTRING",l[l.POLYGON=3]="POLYGON",l[l.MULTIPOLYGON=4]="MULTIPOLYGON",l[l.MULTILINESTRING=5]="MULTILINESTRING",l))(ei||{});const ll={POINT:1,LINESTRING:2,POLYGON:3,MULTIPOLYGON:4,MULTILINESTRING:5},ra=class mt{constructor(t={}){this.__id=mt.__counter__++,this._entity=null,this._handler=null,this._handlerIndex=-1,this._polyVerticesHighMerc=[],this._polyVerticesLowMerc=[],this._polyVerticesLength=-1,this._polyIndexesLength=-1,this._polyVerticesHandlerIndex=-1,this._polyIndexesHandlerIndex=-1,this._lineVerticesHighMerc=[],this._lineVerticesLowMerc=[],this._lineVerticesLength=-1,this._lineOrdersLength=-1,this._lineIndexesLength=-1,this._lineColorsLength=-1,this._lineThicknessLength=-1,this._lineVerticesHandlerIndex=-1,this._lineOrdersHandlerIndex=-1,this._lineIndexesHandlerIndex=-1,this._lineThicknessHandlerIndex=-1,this._lineColorsHandlerIndex=-1,this._type=t.type&&mt.getType(t.type)||1,this._coordinates=t.coordinates||[],this._extent=mt.getExtent({type:t.type||"POINT",coordinates:t.coordinates||[]},this._coordinates),t.style=t.style||{},this._style={fillColor:nt(t.style.fillColor,new te(.19,.62,.85,.4)),lineColor:nt(t.style.lineColor,new te(.19,.62,.85,1)),strokeColor:nt(t.style.strokeColor,new te(1,1,1,.95)),lineWidth:t.style.lineWidth||3,strokeWidth:t.style.strokeWidth||0},this._visibility=t.visibility||!0,this._pickingReady=!1}get id(){return this.__id}get type(){return this._type}static getType(t){return ll[t.toUpperCase()]}static getExtent(t,i){let s=new j(new L(180,90),new L(-180,-90)),r=mt.getType(t.type);if(r===1){let n=t.coordinates[0],a=t.coordinates[1];s.southWest.lon=n,s.southWest.lat=a,s.northEast.lon=n,s.northEast.lat=a,i&&(i[0]=n)&&(i[1]=a)}else if(r===2){let n=t.coordinates;for(let a=0;a<n.length;a++){let o=n[a][0],h=n[a][1];o<s.southWest.lon&&(s.southWest.lon=o),h<s.southWest.lat&&(s.southWest.lat=h),o>s.northEast.lon&&(s.northEast.lon=o),h>s.northEast.lat&&(s.northEast.lat=h),i&&(i[a]=[o,h])}}else if(r===3){let n=t.coordinates;for(let a=0;a<n.length;a++){let o=n[a];i&&(i[a]=[]);for(let h=0;h<o.length;h++){let c=o[h],d=c[0],u=c[1];d<s.southWest.lon&&(s.southWest.lon=d),u<s.southWest.lat&&(s.southWest.lat=u),d>s.northEast.lon&&(s.northEast.lon=d),u>s.northEast.lat&&(s.northEast.lat=u),i&&(i[a][h]=[d,u])}}}else if(r===4){let n=t.coordinates;for(let a=0;a<n.length;a++){let o=n[a];i&&(i[a]=[]);for(let h=0;h<o.length;h++){let c=o[h];i&&(i[a][h]=[]);for(let d=0;d<c.length;d++){let u=c[d],_=u[0],p=u[1];_<s.southWest.lon&&(s.southWest.lon=_),p<s.southWest.lat&&(s.southWest.lat=p),_>s.northEast.lon&&(s.northEast.lon=_),p>s.northEast.lat&&(s.northEast.lat=p),i&&(i[a][h][d]=[_,p])}}}}else if(r===5){let n=t.coordinates;for(let a=0;a<n.length;a++){let o=n[a];i&&(i[a]=[]);for(let h=0;h<o.length;h++){let c=o[h],d=c[0],u=c[1];d<s.southWest.lon&&(s.southWest.lon=d),u<s.southWest.lat&&(s.southWest.lat=u),d>s.northEast.lon&&(s.northEast.lon=d),u>s.northEast.lat&&(s.northEast.lat=u),i&&(i[a][h]=[d,u])}}}else s.southWest.lon=s.southWest.lat=s.northEast.lon=s.northEast.lat=0,i&&(i[0]=0)&&(i[1]=0);return s}setGeometry(t){let i=this._handler;return i&&(this.remove(),this._type=mt.getType(t.type||"Point"),this._extent=mt.getExtent(t,this._coordinates),i.add(this)),this}setFillColor(t,i,s,r=1){let n=this._style.fillColor;return(n.w===0&&r!==0||n.w!==0&&r===0)&&(this._pickingReady=!1),n.x=t,n.y=i,n.z=s,n.w=r,this._handler&&this._handler.setPolyColorArr(this,n),this}overlaps(t){return this._extent.overlaps(t)}setFillColor4v(t){return this.setFillColor(t.x,t.y,t.z,t.w)}setStrokeColor(t,i,s,r=1){let n=this._style.strokeColor;return(n.w===0&&r!==0||n.w!==0&&r===0)&&(this._pickingReady=!1),n.x=t,n.y=i,n.z=s,n.w=r,this._handler&&this._handler.setLineStrokeColorArr(this,n),this}setLineColor(t,i,s,r=1){let n=this._style.lineColor;return(n.w===0&&r!==0||n.w!==0&&r===0)&&(this._pickingReady=!1),n.x=t,n.y=i,n.z=s,n.w=r,this._handler&&this._handler.setLineColorArr(this,n),this}setStrokeColor4v(t){return this.setStrokeColor(t.x,t.y,t.z,t.w)}setLineColor4v(t){return this.setLineColor(t.x,t.y,t.z,t.w)}setStrokeOpacity(t){let i=this._style.strokeColor;return i.w=t,this.setStrokeColor(i.x,i.y,i.z,t)}setLineOpacity(t){let i=this._style.lineColor;return i.w=t,this.setLineColor(i.x,i.y,i.z,t)}setStrokeWidth(t){return this._style.strokeWidth=t,this._pickingReady=!1,this._handler&&this._handler.setLineStrokeArr(this,t),this}bringToFront(){return this._handler&&this._handler.bringToFront(this),this}setLineWidth(t){return this._style.lineWidth=t,this._pickingReady=!1,this._handler&&this._handler.setLineThicknessArr(this,t),this}setFillOpacity(t){let i=this._style.fillColor;return(i.w===0&&t!==0||i.w!==0&&t===0)&&(this._pickingReady=!1),i.w=t,this._handler&&this._handler.setPolyColorArr(this,i),this}setVisibility(t){return this._visibility=t,this._handler&&this._handler.setGeometryVisibility(this),this}getVisibility(){return this._visibility}remove(){this._handler&&this._handler.remove(this)}getExtent(){return this._extent.clone()}getType(){return this._type}};ra.__counter__=0;let hl=ra;class $e{constructor(t,i){this.p0=t||new v,this.p1=i||new v}getMagnitude(){return this.p0.distance(this.p1)}getSphereIntersection(t){let i=this.p0,s=this.p1,r=t.center.x,n=t.center.y,a=t.center.z,o=i.x,h=i.y,c=i.z,d=s.x-o,u=s.y-h,_=s.z-c,p=d*d+u*u+_*_,f=2*(o*d+h*u+c*_-d*r-u*n-_*a),m=f*f-4*p*(o*o-2*o*r+r*r+h*h-2*h*n+n*n+c*c-2*c*a+a*a-t.radius*t.radius);if(m<0)return[];let g=(-f-Math.sqrt(m))/(2*p),y=new v(i.x*(1-g)+g*s.x,i.y*(1-g)+g*s.y,i.z*(1-g)+g*s.z);if(m==0)return[y];let x=(-f+Math.sqrt(m))/(2*p),b=new v(i.x*(1-x)+x*s.x,i.y*(1-x)+x*s.y,i.z*(1-x)+x*s.z);return Math.abs(g-.5)<Math.abs(x-.5)?[y,b]:[b,y]}intersects(t,i,s){let r=this.p0.sub(t.p0),n=t.p1.sub(t.p0);if(Math.abs(n.x)<tt&&Math.abs(n.y)<tt&&Math.abs(n.z)<tt)return!1;let a=this.p1.sub(this.p0);if(Math.abs(a.x)<tt&&Math.abs(a.y)<tt&&Math.abs(a.z)<tt)return!1;let o=r.x*n.x+r.y*n.y+r.z*n.z,h=n.x*a.x+n.y*a.y+n.z*a.z,c=r.x*a.x+r.y*a.y+r.z*a.z,d=n.x*n.x+n.y*n.y+n.z*n.z,u=(a.x*a.x+a.y*a.y+a.z*a.z)*d-h*h;if(Math.abs(u)<tt)return!1;let _=(o*h-c*d)/u;if(i.x=this.p0.x+_*a.x,i.y=this.p0.y+_*a.y,i.z=this.p0.z+_*a.z,s){let p=(o+h*_)/d;s.x=t.p0.x+p*n.x,s.y=t.p0.y+p*n.y,s.z=t.p0.z+p*n.z}return!0}getNearestDistancePoint(t,i){let s=this.p0,r=this.p1,n=this.getMagnitude(),a=((t.x-s.x)*(r.x-s.x)+(t.y-s.y)*(r.y-s.y)+(t.z-s.z)*(r.z-s.z))/(n*n);return i.x=s.x+a*(r.x-s.x),i.y=s.y+a*(r.y-s.y),i.z=s.z+a*(r.z-s.z),!(a<0||a>1)}}class pe{constructor(t,i){this.p=t?t.clone():new v,this.n=i?i.clone():this.p.isZero()?v.UP:this.p.getNormal()}setByPoints(t,i,s){let r=v.sub(i,t),n=v.sub(s,t);return this.n=r.cross(n),this.p.copy(t),this}static fromPoints(t,i,s){return new pe().setByPoints(t,i,s)}set(t,i){this.p.copy(t),this.n.copy(i)}getNormal(){return this.n.clone()}distance(t){let i=this.getProjection(t);return t.distance(i)}getProjection(t,i){return v.proj_b_to_plane(t,this.n,i)}getProjectionPoint(t,i){let s=t.sub(this.p),r=this.n,n=s.dot(r);return i?i.copy(r.scale(n)):i=r.scale(n),t.sub(i)}getIntersection(t,i,s){let r,n=t.n.cross(i.n),a=n.x>=0?n.x:-n.x,o=n.y>=0?n.y:-n.y,h=n.z>=0?n.z:-n.z;if(a+o+h<xn){let _=i.p.sub(t.p);return t.n.dot(_)==0?1:0}r=a>o?a>h?1:3:o>h?2:3;let c,d,u=new v;return c=-t.n.dot(t.p),d=-i.n.dot(i.p),r===1?(u.x=0,u.y=(d*t.n.z-c*i.n.z)/n.x,u.z=(c*i.n.y-d*t.n.y)/n.x):r===2?(u.x=(c*i.n.z-d*t.n.z)/n.y,u.y=0,u.z=(d*t.n.x-c*i.n.x)/n.y):r===3&&(u.x=(d*t.n.y-c*i.n.y)/n.z,u.y=(c*i.n.x-d*t.n.x)/n.z,u.z=0),s.p0.copy(u),s.p1.copy(u.add(n)),2}}let V=class Je{constructor(t=v.ZERO,i=v.ZERO){this.origin=t,this.direction=i}static get OUTSIDE(){return 0}static get INSIDE(){return 1}static get INPLANE(){return 2}static get AWAY(){return 3}set(t,i){return this.origin=t,this.direction=i,this}getPoint(t){return v.add(this.origin,this.direction.scaleTo(t))}hitTriangleRes(t,i,s,r){let n=i.sub(t),a=s.sub(t),o=n.cross(a),h=this.origin.sub(t),c=-o.dot(h),d=o.dot(this.direction);if(Math.abs(d)<tt)return c===0?(r.copy(this.origin),Je.INPLANE):Je.OUTSIDE;let u=c/d;if(r.copy(this.origin.add(this.direction.scaleTo(u))),u<0)return Je.AWAY;let _=n.dot(n),p=n.dot(a),f=a.dot(a),m=r.sub(t),g=m.dot(n),y=m.dot(a),x=p*p-_*f,b=(p*y-f*g)/x;if(b<0||b>1)return Je.OUTSIDE;let T=(p*g-_*y)/x;return T<0||b+T>1?Je.OUTSIDE:Je.INSIDE}hitPlaneRes(t,i){const s=this.direction.dot(t.n);if(Math.abs(s)<tt)return Je.OUTSIDE;const r=t.p.sub(this.origin).dot(t.n)/s;return r<0?Je.AWAY:(i.copy(this.getPoint(r)),Je.INSIDE)}hitSphere(t){const i=v.sub(this.origin,t.center),s=this.direction.dot(this.direction),r=2*i.dot(this.direction),n=r*r-4*s*(i.dot(i)-t.radius*t.radius);if(n<0)return null;const a=Math.sqrt(n);let o=(-r-a)/(2*s);return o<0&&(o=(-r+a)/(2*s)),o<0?null:v.add(this.origin,this.direction.scaleTo(o))}hitBox(t){}};function ns(l){let t=l.split("/"),i=t[t.length-1],s=t[t.length-2];return`${s?s+"/":""}${i}`}class Ar{constructor(){this.objPositions=[],this.objTexcoords=[],this.objNormals=[],this.objVertexData=[this.objPositions,this.objTexcoords,this.objNormals],this.vertexData=[[],[],[]],this._materialLibs=[],this.geometries=[],this.geometry=null,this.materials={},this.material={},this.object="default",this.groups=["default"],this._path="",this.keywords={v:t=>{this.objPositions.push(t.map(parseFloat))},vn:t=>{this.objNormals.push(t.map(parseFloat))},vt:t=>{this.objTexcoords.push([parseFloat(t[0]),1-parseFloat(t[1])])},f:t=>{this.setGeometry();const i=t.length-2;for(let s=0;s<i;++s)this.addVertex(t[0]),this.addVertex(t[s+1]),this.addVertex(t[s+2])},s:()=>{},mtllib:(t,i)=>{this._materialLibs.push(i)},usemtl:(t,i)=>{this.newGeometry(),this.setGeometry(),this.geometry&&(this.geometry.material=i)},g:t=>{this.groups=t,this.newGeometry()},o:(t,i)=>{this.object=i,this.newGeometry()},newmtl:(t,i)=>{const s={};this.material=s,this.materials[i]=s},Ns:(t,i)=>{this.material.shininess=parseFloat(i)},Ni:(t,i)=>{},Ka:(t,i)=>{this.material.ambient=t.map((s=>parseFloat(s)))},Kd:(t,i)=>{this.material.diffuse=t.map((s=>parseFloat(s)))},Ks:(t,i)=>{this.material.specular=t.map((s=>parseFloat(s)))},Ke:(t,i)=>{this.material.color=t.map((s=>parseFloat(s)))},illum:(t,i)=>{this.material.illum=parseFloat(i)},d:(t,i)=>{this.material.opacity=parseFloat(i)},Tr:(t,i)=>{this.material.opacity=parseFloat(i)},Tf:(t,i)=>{},map_Ka:(t,i)=>{},map_Kd:(t,i)=>{this.material.colorTexture=`${this._path}/${ns(i)}`},map_Bump:(t,i)=>{this.material.normalTexture=`${this._path}/${ns(i)}`},map_Ns:(t,i)=>{this.material.metallicRoughnessTexture=`${this._path}/${ns(i)}`}}}newGeometry(){this.geometry&&this.geometry.data.vertices.length&&(this.geometry=null)}setGeometry(){if(!this.geometry){const t=[],i=[],s=[];this.vertexData=[t,i,s],this.geometry={object:this.object,groups:this.groups,material:"",data:{vertices:t,texCoords:i,normals:s}},this.geometries.push(this.geometry)}}addVertex(t){let i=t.split("/");for(let s=0;s<i.length;s++){let r=i[s];if(!r)continue;let n=parseInt(r)-1,a=this.vertexData[s],o=a.length,h=this.objVertexData[s][n],c=h.length;this.vertexData[s].length=o+c;for(let d=0;d<c;d++)a[o+d]=h[d]}}_innerParser(t,i){const s=/(\w*)(?: )*(.*)/,r=t.split(`
`);for(let n=0;n<r.length;++n){const a=r[n].trim();if(a===""||a.startsWith("#"))continue;const o=s.exec(a);if(!o)continue;const[,h,c]=o,d=a.split(/\s+/).slice(1),u=this.keywords[h];u?u(d,c):console.warn(`Unknown keyword '${h}' in '${i}:${n}'`)}}get data(){return{geometries:this.geometries,materials:this.materials}}async load(t){this._path=t.substring(0,t.lastIndexOf("/"));const i=await fetch(t);if(!i.ok)throw new Error(`Unable to load '${t}'`);const s=i.body.getReader(),r=new TextDecoder;let{value:n,done:a}=await s.read(),o="";for(;!a;){const c=(o+r.decode(n,{stream:!0})).split(`
`);o=c.pop();for(const d of c)this._innerParser(d,t);({value:n,done:a}=await s.read())}o&&this._innerParser(o,t),this._cleanupGeometryArrays();let h=this._materialLibs.map((c=>(c=`${this._path}/${c}`,fetch(c).then((d=>d.text())).then((d=>({text:d,filename:c}))))));return await Promise.all(h).then((c=>{c.forEach((d=>this._innerParser(d.text,d.filename)))})),this.data}async _readAndParse(t){const i=t.stream().getReader(),s=new TextDecoder;let{value:r,done:n}=await i.read(),a="";for(;!n;){const o=(a+s.decode(r,{stream:!0})).split(`
`);a=o.pop();for(const h of o)this._innerParser(h,t.name);({value:r,done:n}=await i.read())}a&&this._innerParser(a,t.name)}async readFile(t,i){return this._path="",await this._readAndParse(t),this._cleanupGeometryArrays(),i&&await this._readAndParse(i),this.data}_cleanupGeometryArrays(){for(const t of this.geometries)t.data=Object.fromEntries(Object.entries(t.data).filter((([i,s])=>s.length>0)))}}function St(l){let t=new Float32Array([1,1,1]);if(l instanceof Array)t[0]=l[0],t[1]=l[1],t[2]=l[2];else if(typeof l=="string"){let i=ft(l);t[0]=i[0],t[1]=i[1],t[2]=i[2]}return t}class ${constructor(t={}){var i;if(this._name=t.name||"noname",this._vertices=t.vertices||[],this._numVertices=this._vertices.length/3,this._texCoords=t.texCoords||new Array(2*this._numVertices),this.color=(i=t.color)instanceof Array?new Float32Array(i):typeof i=="string"?ft(i):new Float32Array([.5,.5,.5,1]),this.ambient=St(t.ambient),this.diffuse=St(t.diffuse),this.specular=St(t.specular),this.shininess=t.shininess||100,this.colorTextureSrc=t.colorTextureSrc||null,this.colorTextureImage=t.colorTextureImage||null,this.normalTextureSrc=t.normalTextureSrc||null,this.normalTextureImage=t.normalTextureImage||null,this.metallicRoughnessTextureSrc=t.metallicRoughnessTextureSrc||null,this.metallicRoughnessTextureImage=t.metallicRoughnessTextureImage||null,t.scale){let s,r=t.scale;s=typeof r=="number"?new v(r,r,r):r,$.scale(this._vertices,s)}if(t.center&&$.centering(this._vertices),this.center=$.getCenter(this._vertices),t.indices)this._indices=t.indices,this._normals=t.normals||[];else{this._normals=t.normals||$.getNormals(this._vertices),this._indices=new Array(this._vertices.length/3);for(let s=0,r=this._indices.length;s<r;s++)this._indices[s]=s}}static getCenter(t){let i=ve,s=ve,r=ve,n=Te,a=Te,o=Te;for(let h=0,c=t.length;h<c;h+=3){let d=t[h],u=t[h+1],_=t[h+2];d<i&&(i=d),u<s&&(s=u),_<r&&(r=_),d>n&&(n=d),u>a&&(a=u),_>o&&(o=_)}return new v(i+.5*(n-i),s+.5*(a-s),r+.5*(o-r))}static centering(t){let i=$.getCenter(t);for(let s=0,r=t.length;s<r;s+=3)t[s]-=i.x,t[s+1]-=i.y,t[s+2]-=i.z}setMaterial(t){return t.ambient&&(this.ambient=St(t.ambient)),t.diffuse&&(this.diffuse=St(t.diffuse)),t.specular&&(this.specular=St(t.specular)),t.shininess!==void 0&&(this.shininess=t.shininess),this}centering(){return $.centering(this._vertices),this}applyMat4(t){for(let i=0,s=this._vertices.length;i<s;i+=3){let r=new v(this._vertices[i],this._vertices[i+1],this._vertices[i+2]),n=new v(this._normals[i],this._normals[i+1],this._normals[i+2]);r=t.mulVec3(r),n=t.mulVec3(n),this._vertices[i]=r.x,this._vertices[i+1]=r.y,this._vertices[i+2]=r.z,this._normals[i]=n.x,this._normals[i+1]=n.y,this._normals[i+2]=n.z}return this}scale(t){return $.scale(this._vertices,t),this}translate(t){for(let i=0,s=this._vertices.length;i<s;i+=3)this._vertices[i]+=t.x,this._vertices[i+1]+=t.y,this._vertices[i+2]+=t.z;return this}get name(){return this._name}get vertices(){return this._vertices}get normals(){return this._normals}get indices(){return this._indices}get texCoords(){return this._texCoords}get numVertices(){return this._numVertices}static scale(t,i){for(let s=0;s<t.length;s+=3)t[s]*=i.x,t[s+1]*=i.y,t[s+2]*=i.z}static centroid(t){let i=1e3,s=1e3,r=1e3,n=-1e3,a=-1e3,o=-1e3;for(let h=0;h<t.length;h+=3){let c=t[h],d=t[h+1],u=t[h+2];c<i&&(i=c),d<s&&(s=d),u<r&&(r=u),c>n&&(n=c),d>a&&(a=d),u>o&&(o=u)}return[i+.5*(n-i),s+.5*(a-s),r+.5*(o-r)]}static translate(t,i){for(let s=0;s<t.length;s+=3)t[s]+=i[0],t[s+1]+=i[1],t[s+2]+=i[2]}static getNormals(t){let i=new Array(t.length);for(let s=0;s<t.length;s+=9){let r=s,n=s+3,a=s+6,o=t[r],h=t[r+1],c=t[r+2],d=t[n]-o,u=t[n+1]-h,_=t[n+2]-c,p=t[a]-o,f=t[a+1]-h,m=t[a+2]-c,g=u*m-_*f,y=_*p-d*m,x=d*f-u*p,b=Math.sqrt(g*g+y*y+x*x);g/=b,y/=b,x/=b,i[r]=g,i[r+1]=y,i[r+2]=x,i[n]=g,i[n+1]=y,i[n+2]=x,i[a]=g,i[a+1]=y,i[a+2]=x}return i}static createSphere(t=16,i=16,s=1,r=0,n=0,a=0){let o=[],h=[],c=[];for(let d=0;d<=i;d++){let u=d*Math.PI/i,_=Math.sin(u),p=Math.cos(u);for(let f=0;f<=t;f++){let m=2*f*Math.PI/t,g=Math.sin(m),y=Math.cos(m)*_+r,x=p+n,b=g*_+a;c.push(y),c.push(x),c.push(b),o.push(s*y),o.push(s*x),o.push(s*b)}}for(let d=0;d<i;d++)for(let u=0;u<t;u++){let _=d*(t+1)+u,p=_+t+1;h.push(_),h.push(_+1),h.push(p),h.push(p),h.push(_+1),h.push(p+1)}return new $({vertices:o,normals:c,indices:h})}static createDisc(t=1,i=0,s=8,r=!0,n=0,a=0,o=0,h=0){let c=[],d=[],u=[],_=2*Math.PI,p=r?1:-1,f=n;for(let g=1;g<=s;g++)c.push(a,i*p+o,h),u.push(0,p,0),n++;let m=n;for(let g=0;g<=s;g++){let y=g/s*_+0,x=Math.cos(y),b=Math.sin(y);c.push(t*b+a,i*p+o,t*x+h),u.push(0,p,0),n++}for(let g=0;g<s;g++){let y=f+g,x=m+g;r?d.push(x,x+1,y):d.push(x+1,x,y)}return new $({vertices:c,normals:u,indices:d})}static getFrustumScaleByCameraAngles(t,i,s){return new v(2*t*Math.tan(Ye*i),2*t*Math.tan(Ye*s),t)}static getFrustumScaleByCameraAspectRatio(t,i,s){let r=js*Math.atan(Math.tan(Ye*i)/s);return $.getFrustumScaleByCameraAngles(t,i,r)}static createFrustum(t=1,i=1,s=1,r=0,n=0,a=0){return new $({vertices:[0+r,0+n,0+a,-1*(i*=.5)+r,1*(s*=.5)+n,-1*t+a,1*i+r,1*s+n,-1*t+a,0+r,0+n,0+a,1*i+r,-1*s+n,-1*t+a,-1*i+r,-1*s+n,-1*t+a,0+r,0+n,0+a,1*i+r,1*s+n,-1*t+a,1*i+r,-1*s+n,-1*t+a,0+r,0+n,0+a,-1*i+r,-1*s+n,-1*t+a,-1*i+r,1*s+n,-1*t+a,0+r,0+n,0+a,1*i+r,1*s+n,-1*t+a,-1*i+r,1*s+n,-1*t+a,0+r,0+n,0+a,-1*i+r,-1*s+n,-1*t+a,1*i+r,-1*s+n,-1*t+a,0+r,0+n,0+a,1*i+r,-1*s+n,-1*t+a,1*i+r,1*s+n,-1*t+a,0+r,0+n,0+a,-1*i+r,1*s+n,-1*t+a,-1*i+r,-1*s+n,-1*t+a]})}static createCylinder(t=1,i=1,s=1,r=32,n=1,a=!0,o=!0,h=0,c=0,d=0){let u=[],_=[],p=[],f=2*Math.PI,m=0,g=[],y=new v,x=(i-t)/s;for(let b=0;b<=n;b++){let T=[],w=b/n,A=w*(i-t)+t;for(let E=0;E<=r;E++){let C=E/r*f+0,M=Math.sin(C),P=Math.cos(C);u.push(A*M+h,-w*s+s+c,A*P+d),y.set(M,x,P).normalize(),p.push(y.x,y.y,y.z),T.push(m++)}g.push(T)}for(let b=0;b<r;b++)for(let T=0;T<n;T++){let w=g[T][b],A=g[T+1][b],E=g[T+1][b+1],C=g[T][b+1];_.push(w,A,C),_.push(A,E,C)}if(t!==0&&a){let b=$.createDisc(t,s,r,!0,m,h,c,d);u.push(...b.vertices),p.push(...b.normals),_.push(...b.indices)}if(i!==0&&o){let b=$.createDisc(i,0,r,!1,m+(a?1+2*r:0),h,c,d);u.push(...b.vertices),p.push(...b.normals),_.push(...b.indices)}return new $({vertices:u,normals:p,indices:_})}static createCube(t=1,i=1,s=1,r=0,n=0,a=0){let o=.5*t+r,h=.5*i+n,c=.5*s+a;return new $({vertices:[-o,-h,c,o,-h,-c,o,-h,c,-o,-h,c,-o,-h,-c,o,-h,-c,-o,h,c,o,h,c,o,h,-c,-o,h,c,o,h,-c,-o,h,-c,-o,-h,c,o,-h,c,-o,h,c,-o,h,c,o,-h,c,o,h,c,-o,-h,-c,-o,h,-c,o,-h,-c,-o,h,-c,o,h,-c,o,-h,-c,o,-h,c,o,-h,-c,o,h,c,o,h,c,o,-h,-c,o,h,-c,-o,-h,c,-o,h,c,-o,-h,-c,-o,h,c,-o,h,-c,-o,-h,-c]})}static createPlane(t=1,i=1,s=0,r=0,n=0){let a=.5*t,o=.5*i;return new $({vertices:[-a+s,r,o+n,a+s,r,-o+n,a+s,r,o+n,-a+s,r,o+n,-a+s,r,-o+n,a+s,r,-o+n,-a+s,r,o+n,a+s,r,o+n,a+s,r,-o+n,-a+s,r,o+n,a+s,r,-o+n,-a+s,r,-o+n]})}static createArrow(t=0,i=2.1,s=-15){return new $({vertices:[0,i,0,7,0,6,0,0,s,0,0,t,7,0,6,0,i,0,-7,0,6,0,0,t,0,i,0,-7,0,6,0,i,0,0,0,s,-7,0,6,0,0,s,0,0,t,0,0,t,0,0,s,7,0,6]})}static async readFileObj(t,i,s){const r=await new Ar().readFile(t,i);let n=r.materials;return r.geometries.map((a=>{let o=n[a.material]||{};return new $({name:a.object,vertices:a.data.vertices,normals:a.data.normals,texCoords:a.data.texCoords,ambient:o.ambient,diffuse:o.diffuse,specular:o.specular,shininess:o.shininess,color:o.color,colorTextureSrc:s?`${s}/${o.colorTexture}`:o.colorTexture,normalTextureSrc:s?`${s}/${o.normalTexture}`:o.normalTexture,metallicRoughnessTextureSrc:s?`${s}/${o.metallicRoughnessTexture}`:o.metallicRoughnessTexture})}))}static async loadObj(t){const i=await new Ar().load(t);let s=i.materials;return i.geometries.map((r=>{let n=s[r.material]||{};return new $({name:r.object,vertices:r.data.vertices,normals:r.data.normals,texCoords:r.data.texCoords,ambient:n.ambient,diffuse:n.diffuse,specular:n.specular,shininess:n.shininess,color:n.color,colorTextureSrc:n.colorTexture,normalTextureSrc:n.normalTexture,metallicRoughnessTextureSrc:n.metallicRoughnessTexture})}))}merge(t){const i=this._vertices.length/3;let s=this._vertices.length;this._vertices.length=s+t._vertices.length;for(let r=0;r<t._vertices.length;r++)this._vertices[s+r]=t._vertices[r];s=this._normals.length,this._normals.length=s+t._normals.length;for(let r=0;r<t._normals.length;r++)this._normals[s+r]=t._normals[r];s=this._texCoords.length,this._texCoords.length=s+t._texCoords.length;for(let r=0;r<t._texCoords.length;r++)this._texCoords[s+r]=t._texCoords[r];s=this._indices.length,this._indices.length=s+t._indices.length;for(let r=0;r<t._indices.length;r++)this._indices[s+r]=t._indices[r]+i;return this._numVertices=this._vertices.length/3,this}static merge(t,i){let s=new $,r=i||t.length;for(let n=0;n<r;n++)s.merge(t[n]);return s}}const cl=new v(0,0,-1),na=class aa{constructor(t){var i,s;this._handlerIndex=-1,this._tag=t.tag||"tag_"+aa.__counter__++,this._entity=null,this._position=He(t.position),this._rtcPositionHigh=new v,this._rtcPositionLow=new v,this._scale=He(t.scale,new v(1,1,1)),this._translate=He(t.translate,new v),this._localPosition=new v;const[r=.15,n=.15,a=.15,o=1]=(i=t.object3d)!=null&&i.color?Array.from(t.object3d.color):[];this._color=nt(t.color,new te(r,n,a,o)),this._handler=null,this._handlerIndex=-1,this._tagData=null,this._tagDataIndex=-1;let h=t.object3d;t.object3d&&((s=t.object3d)==null?void 0:s.vertices.length)!==0||(h=new $),t.objSrc&&(this.setObjectSrc(t.objSrc),this._objectSrc=t.objSrc),this._object3d=h,this._visibility=t.visibility==null||t.visibility,this._children=[],this._direction=new v,this._qFrame=new F,this._qRot=F.IDENTITY}get tag(){return this._tag}getPosition(){return this._position}get object3d(){return this._object3d}get vertices(){return this._object3d.vertices}get normals(){return this._object3d.normals}get texCoords(){return this._object3d.texCoords}get indices(){return this._object3d.indices}setOpacity(t){this._color.w=t,this.setColor(this._color.x,this._color.y,this._color.z,t)}getOpacity(){return this._color.w}setColor(t,i,s,r){this._color.x=t,this._color.y=i,this._color.z=s,r!=null&&(this._color.w=r),this._handler&&this._handler.setRgbaArr(this._tagData,this._tagDataIndex,this._color)}setColor4v(t){this._color.x=t.x,this._color.y=t.y,this._color.z=t.z,t.w!=null&&(this._color.w=t.w),this._handler&&this._handler.setRgbaArr(this._tagData,this._tagDataIndex,this._color)}setVisibility(t){this._visibility=t,this._handler&&this._handler.setVisibility(this._tagData,this._tagDataIndex,t)}getVisibility(){return this._visibility}setPosition(t,i,s){this._position.x=t,this._position.y=i,this._position.z=s,this.updateRTCPosition(),this.updateRotation()}updateRTCPosition(){this._handler&&(this._handler.getRTCPosition(this._position,this._rtcPositionHigh,this._rtcPositionLow),this._handler.setRTCPositionArr(this._tagData,this._tagDataIndex,this._rtcPositionHigh,this._rtcPositionLow))}setPosition3v(t){this.setPosition(t.x,t.y,t.z)}setObject(t){this._object3d=t}setObjectSrc(t){this._objectSrc=t,this._handler&&this._handler.setObjectSrc(t,this.tag)}setColorHTML(t){this.setColor4v(at(t))}setScale(t){this._scale.x=this._scale.y=this._scale.z=t,this._handler&&this._handler.setScaleArr(this._tagData,this._tagDataIndex,this._scale)}setScale3v(t){this._scale.copy(t),this._handler&&this._handler.setScaleArr(this._tagData,this._tagDataIndex,t)}getScale(){return this._scale}setTranslate3v(t){this._translate.copy(t),this._handler&&this._handler.setTranslateArr(this._tagData,this._tagDataIndex,t)}getTranslate(){return this._translate.clone()}setLocalPosition3v(t){this._localPosition.copy(t),this._handler&&this._handler.setLocalPositionArr(this._tagData,this._tagDataIndex,t)}getLocalPosition(){return this._localPosition.clone()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._handler&&this._handler.setPickingColorArr(this._tagData,this._tagDataIndex,t)}setRotation(t){this._qRot.copy(t),this._qRot.mulVec3Res(cl,this._direction).normalize(),this.updateRotation()}getRotation(){return this._qRot}updateRotation(){this._handler&&this._handler.setQRotArr(this._tagData,this._tagDataIndex,this._qRot)}getDirection(){return this._direction.clone()}};na.__counter__=0;let dl=na;const ai={RIGHT:0,LEFT:1,CENTER:2},Er={left:ai.LEFT,right:ai.RIGHT,center:ai.CENTER};class ul extends sa{constructor(t={}){super(t),this._handler=null,this._text=t.text||"",this._face=Bn(t.face,"arial"),this._size=t.size||24,this._outline=t.outline!=null?t.outline:0,this._outlineColor=nt(t.outlineColor,new te(0,0,0,1)),this._align=t.align&&Er[t.align.trim().toLowerCase()]||ai.RIGHT,this._fontIndex=0,this._fontAtlas=null,this._isRTL=t.isRTL||!1,this._letterSpacing=t.letterSpacing||0}setText(t){this._text=t.toString(),this._isReady&&this._handler&&this._handler.setText(this._handlerIndex,t,this._fontIndex,this._align,this._letterSpacing,this._isRTL)}setLetterSpacing(t){this._letterSpacing=t,this._isReady&&this._handler&&this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,t,this._isRTL)}getLetterSpacing(){return this._letterSpacing}setRtl(t){this._isRTL=t,this._isReady&&this._handler&&this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,this._letterSpacing,this._isRTL)}getText(){return this._text}setAlign(t){this._align=Er[t.trim().toLowerCase()],this._isReady&&this._handler?this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,this._letterSpacing,this._isRTL):this._lockId!==-1&&(this._lockId=-2)}getAlign(){return this._align}setFace(t){this._face=t.trim(),this.update()}getFace(){return this._face}setSize(t){t!==this._size&&(this._size=t,this._isReady&&this._handler?this._handler.setSizeArr(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2))}getSize(){return this._size}setOutline(t){this._outline=t,this._isReady&&this._handler?this._handler.setOutlineArr(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2)}getOutline(){return this._outline}setOpacity(t){super.setOpacity(t),this.setOutlineOpacity(t)}setOutlineColor(t,i,s,r){r===this._outlineColor.w&&t===this._outlineColor.x&&i===this._outlineColor.y&&s===this._outlineColor.z||(this._outlineColor.x=t,this._outlineColor.y=i,this._outlineColor.z=s,this._outlineColor.w=r,this._isReady&&this._handler?this._handler.setOutlineColorArr(this._handlerIndex,this._outlineColor):this._lockId!==-1&&(this._lockId=-2))}setOutlineColor4v(t){this.setOutlineColor(t.x,t.y,t.z,t.w)}setOutlineColorHTML(t){this.setOutlineColor4v(at(t))}getOutlineColor(){return this._outlineColor}setOutlineOpacity(t){t!==this._outlineColor.w&&(this._outlineColor.w=t,this._isReady&&this._handler?this._handler.setOutlineColorArr(this._handlerIndex,this._outlineColor):this._lockId!==-1&&(this._lockId=-2))}getOutlineOpacity(){return this._outlineColor.w}async update(){if(this._fontAtlas){const t=await this._fontAtlas.getFontIndex(this._face);this._applyFontIndex(t)}}_applyFontIndex(t){this._fontIndex=t,this._isReady&&this._handler?(this._handler.setFontIndexArr(this._handlerIndex,this._fontIndex),this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,this._letterSpacing,this._isRTL)):this._lockId!==-1&&(this._lockId=-2)}assignFontAtlas(t){this._fontAtlas||(this._fontAtlas=t),this.update()}serializeWorkerData(t){return this._handler?new Float32Array([t,this._handler._maxLetters,this.getVisibility()?1:0,this._positionHigh.x,this._positionHigh.y,this._positionHigh.z,this._positionLow.x,this._positionLow.y,this._positionLow.z,this._size,this._offset.x,this._offset.y,this._offset.z,this._color.x,this._color.y,this._color.z,this._color.w,this._rotation,this._alignedAxis.x,this._alignedAxis.y,this._alignedAxis.z,this._fontIndex,this._outline,this._outlineColor.x,this._outlineColor.y,this._outlineColor.z,this._outlineColor.w,this._entity._pickingColor.x,this._entity._pickingColor.y,this._entity._pickingColor.z]):null}}const oa=class la{constructor(t={}){this.__id=la.__counter__++,this.visibility=t.visibility==null||t.visibility,this.pointSize=t.pointSize||3,this.pickingScale=t.pickingScale||0,this._renderNode=null,this._entity=null,this._points=[],this._coordinatesData=[],this._colorData=[],this._pickingColorData=[],this._coordinatesBuffer=null,this._colorBuffer=null,this._pickingColorBuffer=null,this._handler=null,this._handlerIndex=-1,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this._createCoordinatesBuffer,this._buffersUpdateCallbacks[1]=this._createColorBuffer,this._buffersUpdateCallbacks[2]=this._createPickingColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),t.points&&this.setPoints(t.points)}clear(){this._points.length=0,this._points=[],this._coordinatesData.length=0,this._coordinatesData=[],this._colorData.length=0,this._colorData=[],this._pickingColorData.length=0,this._pickingColorData=[],this._deleteBuffers()}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){this._renderNode=t,this._setPickingColors()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPoints(t){this.clear();for(let i=0;i<t.length;i++){let s=t[i],r=new v(s[0],s[1],s[2]),n=new te(s[3],s[4],s[5],s[6]==null?255:s[6]);this._coordinatesData.push(r.x,r.y,r.z),this._colorData.push(n.x/255,n.y/255,n.z/255,n.w/255);let a={_entity:this._entity,_pickingColor:new v,_entityCollection:this._entity?this._entity._entityCollection:null,index:i,position:r,color:n,pointCloud:this,properties:s[7]||{}};this._points.push(a),this._renderNode&&this._renderNode.renderer&&(this._renderNode.renderer.assignPickingColor(a),this._pickingColorData.push(a._pickingColor.x/255,a._pickingColor.y/255,a._pickingColor.z/255,1))}this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}setPointPosition(t,i,s,r){this._changedBuffers[0]=!0}setPointColor(t,i,s,r,n){this._changedBuffers[1]=!0}addPoints(t){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}addPoint(t,i){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}getPoint(t){return this._points[t]}removePoint(t){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}insertPoint(t,i){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}draw(){if(this.visibility&&this._coordinatesData.length){this._update();let t=this._renderNode.renderer,i=t.handler.programs.pointCloud,s=i._program,r=t.handler.gl,n=s.attributes,a=s.uniforms;i.activate(),r.uniformMatrix4fv(a.projectionViewMatrix,!1,t.activeCamera.getProjectionViewMatrix()),r.uniform1f(a.opacity,this._handler._entityCollection._fadingOpacity),r.uniform1f(a.pointSize,this.pointSize),r.bindBuffer(r.ARRAY_BUFFER,this._coordinatesBuffer),r.vertexAttribPointer(n.coordinates,this._coordinatesBuffer.itemSize,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this._colorBuffer),r.vertexAttribPointer(n.colors,this._colorBuffer.itemSize,r.FLOAT,!1,0,0),r.drawArrays(r.POINTS,0,this._coordinatesBuffer.numItems)}}drawPicking(){if(this.visibility&&this._coordinatesData.length){let t=this._renderNode.renderer,i=t.handler.programs.pointCloud,s=i._program,r=t.handler.gl,n=s.attributes,a=s.uniforms;i.activate(),r.uniformMatrix4fv(a.projectionViewMatrix,!1,t.activeCamera.getProjectionViewMatrix()),r.uniform1f(a.opacity,this._handler._entityCollection._fadingOpacity),r.uniform1f(a.pointSize,this.pointSize+this.pickingScale),r.bindBuffer(r.ARRAY_BUFFER,this._coordinatesBuffer),r.vertexAttribPointer(n.coordinates,this._coordinatesBuffer.itemSize,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this._pickingColorBuffer),r.vertexAttribPointer(n.colors,this._pickingColorBuffer.itemSize,r.FLOAT,!1,0,0),r.drawArrays(r.POINTS,0,this._coordinatesBuffer.numItems)}}_update(){if(this._renderNode){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}}_deleteBuffers(){if(this._renderNode){let t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._coordinatesBuffer),t.deleteBuffer(this._colorBuffer),t.deleteBuffer(this._pickingColorBuffer)}this._coordinatesBuffer=null,this._colorBuffer=null,this._pickingColorBuffer=null}_createCoordinatesBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._coordinatesBuffer),this._coordinatesBuffer=t.createArrayBuffer(new Float32Array(this._coordinatesData),3,this._coordinatesData.length/3)}_createColorBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._colorBuffer),this._colorBuffer=t.createArrayBuffer(new Float32Array(this._colorData),4,this._colorData.length/4)}_createPickingColorBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorBuffer=t.createArrayBuffer(new Float32Array(this._pickingColorData),4,this._pickingColorData.length/4)}_setPickingColors(){if(this._renderNode&&this._renderNode.renderer){for(let t=0;t<this._points.length;t++){let i=this._points[t];i._entity=this._entity,i._entityCollection=this._entity._entityCollection,this._renderNode.renderer.assignPickingColor(i),this._pickingColorData.push(i._pickingColor.x/255,i._pickingColor.y/255,i._pickingColor.z/255,1)}this._changedBuffers[2]=!0}}};oa.__counter__=0;let _l=oa;const ha=class ki{constructor(t={}){this.__id=ki.__counter__++,this.__doubleToTwoFloats=v.doubleToTwoFloats,this.altitude=t.altitude||0,this.thickness=t.thickness||1.5,this._opacity=t.opacity!=null?t.opacity:1,this._defaultColor=ft(t.color||"#0000FF",t.opacity),this.visibility=t.visibility==null||t.visibility,this._closedLine=t.isClosed||!1,this._path3v=[],this._pathLengths=[],this._pathLonLat=[],this._pathLonLatMerc=[],this._pathColors=t.pathColors?Js(t.pathColors):[],this._extent=new j,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._texCoordArr=[],this._atlasTexCoords=[],this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._ordersBuffer=null,this._indexesBuffer=null,this._colorsBuffer=null,this._texCoordBuffer=null,this._pickingColor=[0,0,0],this._renderNode=null,this._entity=null,this._handler=null,this._handlerIndex=-1,this._image=t.image||null,this._src=t.src||null,this._texOffset=t.texOffset||0,this._strokeSize=t.strokeSize!=null?t.strokeSize:32,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this._createVerticesBuffer,this._buffersUpdateCallbacks[1]=this._createIndexBuffer,this._buffersUpdateCallbacks[2]=this._createColorsBuffer,this._buffersUpdateCallbacks[3]=this._createTexCoordBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length);let i=He(t.visibleSpherePosition).toArray(),s=t.visibleSphereRadius||0;this._visibleSphere=new Float32Array([...i,s]),t.pathLonLat?this.setPathLonLat(t.pathLonLat):t.path3v&&this.setPath3v(t.path3v),this._refresh()}get texOffset(){return this._texOffset}set texOffset(t){this._texOffset=t}get strokeSize(){return this._strokeSize}set strokeSize(t){this._strokeSize=t}setSrc(t){this._src=t;let i=this._handler;if(i){let s=i._entityCollection.renderNode;if(s&&s.renderer){let r=s.renderer.strokeTextureAtlas;t&&t.length?r.loadImage(t,(n=>{if(n.__nodeIndex!=null&&r.get(n.__nodeIndex)){this._image=n;let a=r.get(n.__nodeIndex);this._setTexCoordArr(a.texCoords)}else r.addImage(n),r.createTexture(),this._image=n,s.updateStrokeTexCoords()})):(this.setTextureDisabled(),s.updateStrokeTexCoords())}}}getSrc(){return this._src}setImage(t){this.setSrc(t.src)}getImage(){return this._image}_setTexCoordArr(t){this._texCoordArr=[],this._atlasTexCoords=t,ki.setPathTexCoords(this._path3v,t,this._texCoordArr),this._changedBuffers[3]=!0}setTextureDisabled(){this._strokeSize=0}__appendLineData3v(t,i,s,r,n,a,o,h,c,d,u,_,p,f){var m=0,g=new v,y=new v;p&&(p.southWest.set(180,90),p.northEast.set(-180,-90)),h.length>0?(m=h[h.length-5]+9,h.push(m,m)):h.push(0,0);for(let B=0,k=t.length;B<k;B++){var x=t[B],b=i[B];if(d[B]=[],_[B]=[],u[B]=[],x.length===0)continue;var T,w=m;if(r)(T=x[x.length-1])instanceof Array&&(T=new v(T[0],T[1],T[2]));else{var A=x[0],E=x[1]||A;A instanceof Array&&(A=new v(A[0],A[1],A[2])),E instanceof Array&&(E=new v(E[0],E[1],E[2])),T=new v(A.x+A.x-E.x,A.y+A.y-E.y,A.z+A.z-E.z)}let O=s;b&&b[0]&&(O=b[0]),this.__doubleToTwoFloats(T,g,y),n.push(g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z),a.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z);let R=O[0],z=O[1],D=O[2],S=O[3]!=null?O[3]:1;B>0&&f.push(R,z,D,S,R,z,D,S,R,z,D,S,R,z,D,S),o.push(1,-1,2,-2);for(let I=0,N=x.length;I<N;I++){var C=x[I];if(C instanceof Array&&(C=new v(C[0],C[1],C[2])),u[B].push(C),c){var M=c.cartesianToLonLat(C);d[B].push(M),_[B].push(M.forwardMercator()),M.lon<p.southWest.lon&&(p.southWest.lon=M.lon),M.lat<p.southWest.lat&&(p.southWest.lat=M.lat),M.lon>p.northEast.lon&&(p.northEast.lon=M.lon),M.lat>p.northEast.lat&&(p.northEast.lat=M.lat)}b&&b[I]&&(O=b[I]),R=O[0],z=O[1],D=O[2],S=O[3]!=null?O[3]:1,this.__doubleToTwoFloats(C,g,y),n.push(g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z),a.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),f.push(R,z,D,S,R,z,D,S,R,z,D,S,R,z,D,S),o.push(1,-1,2,-2),h.push(m++,m++,m++,m++)}var P;if(r)(P=x[0])instanceof Array&&(P=new v(P[0],P[1],P[2])),h.push(w,w+1,w+1,w+1);else{let I=x[x.length-1],N=x[x.length-2]||I;I instanceof Array&&(I=new v(I[0],I[1],I[2])),N instanceof Array&&(N=new v(N[0],N[1],N[2])),P=new v(I.x+I.x-N.x,I.y+I.y-N.y,I.z+I.z-N.z),h.push(m-1,m-1,m-1,m-1)}b&&b[x.length-1]&&(O=b[x.length-1]),R=O[0],z=O[1],D=O[2],S=O[3]!=null?O[3]:1,this.__doubleToTwoFloats(P,g,y),n.push(g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z),a.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),f.push(R,z,D,S,R,z,D,S,R,z,D,S,R,z,D,S),o.push(1,-1,2,-2),B<t.length-1&&t[B+1].length!==0&&(m+=8,h.push(m,m))}}__appendPoint3v(t,i,s,r,n,a,o,h,c,d,u,_,p,f){var m=new v,g=new v,y=d.length-4,x=d[y-1]+1;t.length===0?(t.push([]),s[0]||(s[0]=[])):s[t.length-1]||(s[t.length-1]=[]);var b=t[t.length-1],T=b.length;b.push(i);let w=r[0],A=r[1],E=r[2],C=r[3]!=null?r[3]:1,M=s[t.length-1];if(M[T]?(M[T][0]=w,M[T][1]=A,M[T][2]=E,M[T][3]=C):M.push(r),T===1){var P;if(n)(P=b[T-1])instanceof Array&&(P=new v(P[0],P[1],P[2]));else{let I=b[0],N=b[1]||I;I instanceof Array&&(I=new v(I[0],I[1],I[2])),N instanceof Array&&(N=new v(N[0],N[1],N[2])),P=new v(I.x+I.x-N.x,I.y+I.y-N.y,I.z+I.z-N.z)}this.__doubleToTwoFloats(P,m,g);let S=a.length-36;a[S]=m.x,a[S+1]=m.y,a[S+2]=m.z,a[S+3]=m.x,a[S+4]=m.y,a[S+5]=m.z,a[S+6]=m.x,a[S+7]=m.y,a[S+8]=m.z,a[S+9]=m.x,a[S+10]=m.y,a[S+11]=m.z,o[S]=g.x,o[S+1]=g.y,o[S+2]=g.z,o[S+3]=g.x,o[S+4]=g.y,o[S+5]=g.z,o[S+6]=g.x,o[S+7]=g.y,o[S+8]=g.z,o[S+9]=g.x,o[S+10]=g.y,o[S+11]=g.z}var B=x;if(u){_.length===0&&_.push([]),p.length===0&&p.push([]);var k=_[_.length-1],O=p[p.length-1];let S=u.cartesianToLonLat(i);k.push(S),O.push(S.forwardMercator()),S.lon<f.southWest.lon&&(f.southWest.lon=S.lon),S.lat<f.southWest.lat&&(f.southWest.lat=S.lat),S.lon>f.northEast.lon&&(f.northEast.lon=S.lon),S.lat>f.northEast.lat&&(f.northEast.lat=S.lat)}this.__doubleToTwoFloats(i,m,g);let R=a.length-12;a[R]=m.x,a[R+1]=m.y,a[R+2]=m.z,a[R+3]=m.x,a[R+4]=m.y,a[R+5]=m.z,a[R+6]=m.x,a[R+7]=m.y,a[R+8]=m.z,a[R+9]=m.x,a[R+10]=m.y,a[R+11]=m.z,o[R]=g.x,o[R+1]=g.y,o[R+2]=g.z,o[R+3]=g.x,o[R+4]=g.y,o[R+5]=g.z,o[R+6]=g.x,o[R+7]=g.y,o[R+8]=g.z,o[R+9]=g.x,o[R+10]=g.y,o[R+11]=g.z;let z=h.length-16;var D;if(h[z]=w,h[z+1]=A,h[z+2]=E,h[z+3]=C,h[z+4]=w,h[z+5]=A,h[z+6]=E,h[z+7]=C,h[z+8]=w,h[z+9]=A,h[z+10]=E,h[z+11]=C,h[z+12]=w,h[z+13]=A,h[z+14]=E,h[z+15]=C,d[y]=x++,d[y+1]=x++,d[y+2]=x++,d[y+3]=x++,n)D=b[0],d.push(B,B+1,B+1,B+1);else{let S=b[b.length-1],I=b[b.length-2]||S;D=new v(S.x+S.x-I.x,S.y+S.y-I.y,S.z+S.z-I.z),d.push(x-1,x-1,x-1,x-1)}this.__doubleToTwoFloats(D,m,g),a.push(m.x,m.y,m.z,m.x,m.y,m.z,m.x,m.y,m.z,m.x,m.y,m.z),o.push(g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z),h.push(w,A,E,C,w,A,E,C,w,A,E,C,w,A,E,C),c.push(1,-1,2,-2)}static setPathTexCoords(t,i,s){let r=i[1],n=i[3]-r,a=new H(i[4],i[5]),o=new H(i[2],i[3]),h=new H(i[8],i[9]),c=new H(i[0],i[1]);for(let u=0,_=t.length;u<_;u++){var d=t[u];if(d.length!==0){u>0&&s.push(a.x,a.y,r,n,o.x,o.y,r,n,h.x,h.y,r,n,c.x,c.y,r,n);for(let p=0,f=d.length;p<f;p++)s.push(a.x,a.y,r,n,o.x,o.y,r,n,h.x,h.y,r,n,c.x,c.y,r,n);s.push(a.x,a.y,r,n,o.x,o.y,r,n,h.x,h.y,r,n,c.x,c.y,r,n)}}}static setPathColors(t,i,s,r){for(let o=0,h=t.length;o<h;o++){var n=t[o],a=i[o];if(n.length===0)continue;let c=s;a&&a[0]&&(c=a[0]);let d=c[0],u=c[1],_=c[2],p=c[3]!=null?c[3]:1;o>0&&r.push(d,u,_,p,d,u,_,p,d,u,_,p,d,u,_,p);for(let f=0,m=n.length;f<m;f++)a&&a[f]&&(c=a[f]),d=c[0],u=c[1],_=c[2],p=c[3]!=null?c[3]:1,r.push(d,u,_,p,d,u,_,p,d,u,_,p,d,u,_,p);a&&a[n.length-1]&&(c=a[n.length-1]),d=c[0],u=c[1],_=c[2],p=c[3]!=null?c[3]:1,r.push(d,u,_,p,d,u,_,p,d,u,_,p,d,u,_,p)}}__appendLineDataLonLat(t,i,s,r,n,a,o,h,c,d,u,_,p,f,m){var g=0,y=new v,x=new v;f&&(f.southWest.set(180,90),f.northEast.set(-180,-90)),h.length>0?(g=h[h.length-5]+9,h.push(g)):h.push(0);for(let P=0,B=t.length;P<B;P++){var b=t[P],T=i[P];if(u[P]=[],p[P]=[],_[P]=[],b.length===0)continue;var w,A=g;if(r){let S=b[b.length-1];w=S instanceof Array?d.lonLatToCartesian(new L(S[0],S[1],S[2])):d.lonLatToCartesian(S)}else{let S,I,N=b[0];S=N instanceof Array?d.lonLatToCartesian(new L(N[0],N[1],N[2])):d.lonLatToCartesian(N),N=b[1],N||(N=b[0]),I=N instanceof Array?d.lonLatToCartesian(new L(N[0],N[1],N[2])):d.lonLatToCartesian(N),w=new v(S.x+S.x-I.x,S.y+S.y-I.y,S.z+S.z-I.z)}let k=s;T&&T[0]&&(k=T[0]),this.__doubleToTwoFloats(w,y,x),n.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),a.push(x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z);let O=k[0],R=k[1],z=k[2],D=k[3]!=null?k[3]:1;P>0&&m.push(O,R,z,D,O,R,z,D,O,R,z,D,O,R,z,D),o.push(1,-1,2,-2),c.push(0,0,0,0,1,0,0,0,1,0,0,0,1,1,0,0);for(let S=0,I=b.length;S<I;S++){var E=b[S];E instanceof Array&&(E=new L(E[0],E[1],E[2])),T&&T[S]&&(k=T[S]),O=k[0],R=k[1],z=k[2],D=k[3]!=null?k[3]:1;var C=d.lonLatToCartesian(E);u[P].push(C),_[P].push(E),p[P].push(E.forwardMercator()),this.__doubleToTwoFloats(C,y,x),n.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),a.push(x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z),m.push(O,R,z,D,O,R,z,D,O,R,z,D,O,R,z,D),o.push(1,-1,2,-2),h.push(g++,g++,g++,g++),c.push(0,0,0,0,1,0,0,0,1,0,0,0,1,1,0,0),E.lon<f.southWest.lon&&(f.southWest.lon=E.lon),E.lat<f.southWest.lat&&(f.southWest.lat=E.lat),E.lon>f.northEast.lon&&(f.northEast.lon=E.lon),E.lat>f.northEast.lat&&(f.northEast.lat=E.lat)}var M;if(r){let S=b[0];M=S instanceof Array?d.lonLatToCartesian(new L(S[0],S[1],S[2])):d.lonLatToCartesian(S),h.push(A,A+1,A+1,A+1)}else{let S,I,N=b[b.length-1];S=N instanceof Array?d.lonLatToCartesian(new L(N[0],N[1],N[2])):d.lonLatToCartesian(N),N=b[b.length-2],N||(N=b[0]),I=N instanceof Array?d.lonLatToCartesian(new L(N[0],N[1],N[2])):d.lonLatToCartesian(N),M=new v(S.x+S.x-I.x,S.y+S.y-I.y,S.z+S.z-I.z),h.push(g-1,g-1,g-1,g-1)}T&&T[b.length-1]&&(k=T[b.length-1]),O=k[0],R=k[1],z=k[2],D=k[3]!=null?k[3]:1,this.__doubleToTwoFloats(M,y,x),n.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),a.push(x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z),m.push(O,R,z,D,O,R,z,D,O,R,z,D,O,R,z,D),o.push(1,-1,2,-2),c.push(0,0,0,0,1,0,0,0,1,0,0,0,1,1,0,0),P<t.length-1&&t[P+1].length!==0&&(g+=8,h.push(g,g))}}_setEqualPath3v(t){var i=this._extent;i.southWest.set(180,90),i.northEast.set(-180,-90);var s=new v,r=new v,n=this._verticesHigh,a=this._verticesLow,o=this._pathLonLat,h=this._pathLonLatMerc,c=0,d=this._renderNode.ellipsoid;for(let x=0;x<t.length;x++){var u,_,p=t[x];u=this._closedLine?p[p.length-1]:new v(p[0].x+p[0].x-p[1].x,p[0].y+p[0].y-p[1].y,p[0].z+p[0].z-p[1].z),this.__doubleToTwoFloats(u,s,r),n[c]=s.x,a[c++]=r.x,n[c]=s.y,a[c++]=r.y,n[c]=s.z,a[c++]=r.z,n[c]=s.x,a[c++]=r.x,n[c]=s.y,a[c++]=r.y,n[c]=s.z,a[c++]=r.z,n[c]=s.x,a[c++]=r.x,n[c]=s.y,a[c++]=r.y,n[c]=s.z,a[c++]=r.z,n[c]=s.x,a[c++]=r.x,n[c]=s.y,a[c++]=r.y,n[c]=s.z,a[c++]=r.z;for(let b=0;b<p.length;b++){var f=p[b],m=this._path3v[x][b];if(m.x=f.x,m.y=f.y,m.z=f.z,d){var g=d.cartesianToLonLat(f);this._pathLonLat[x][b]=g,o[x][b]=g,h[x][b]=g.forwardMercator(),g.lon<i.southWest.lon&&(i.southWest.lon=g.lon),g.lat<i.southWest.lat&&(i.southWest.lat=g.lat),g.lon>i.northEast.lon&&(i.northEast.lon=g.lon),g.lat>i.northEast.lat&&(i.northEast.lat=g.lat)}this.__doubleToTwoFloats(f,s,r),n[c]=s.x,a[c++]=r.x,n[c]=s.y,a[c++]=r.y,n[c]=s.z,a[c++]=r.z,n[c]=s.x,a[c++]=r.x,n[c]=s.y,a[c++]=r.y,n[c]=s.z,a[c++]=r.z,n[c]=s.x,a[c++]=r.x,n[c]=s.y,a[c++]=r.y,n[c]=s.z,a[c++]=r.z,n[c]=s.x,a[c++]=r.x,n[c]=s.y,a[c++]=r.y,n[c]=s.z,a[c++]=r.z}if(this._closedLine)_=p[0];else{var y=p.length-1;_=new v(p[y].x+p[y].x-p[y-1].x,p[y].y+p[y].y-p[y-1].y,p[y].z+p[y].z-p[y-1].z)}this.__doubleToTwoFloats(_,s,r),n[c]=s.x,a[c++]=r.x,n[c]=s.y,a[c++]=r.y,n[c]=s.z,a[c++]=r.z,n[c]=s.x,a[c++]=r.x,n[c]=s.y,a[c++]=r.y,n[c]=s.z,a[c++]=r.z,n[c]=s.x,a[c++]=r.x,n[c]=s.y,a[c++]=r.y,n[c]=s.z,a[c++]=r.z,n[c]=s.x,a[c++]=r.x,n[c]=s.y,a[c++]=r.y,n[c]=s.z,a[c++]=r.z}}_setEqualPathLonLat(t){var i=this._extent;i.southWest.set(180,90),i.northEast.set(-180,-90);var s=new v,r=new v,n=this._verticesHigh,a=this._verticesLow,o=this._pathLonLat,h=this._pathLonLatMerc,c=this._path3v,d=0,u=this._renderNode.ellipsoid;for(let y=0;y<t.length;y++){var _,p,f=t[y];if(this._closedLine)_=u.lonLatToCartesian(f[f.length-1]);else{let x=u.lonLatToCartesian(f[0]),b=u.lonLatToCartesian(f[1]);_=new v(x.x+x.x-b.x,x.y+x.y-b.y,x.z+x.z-b.z)}this.__doubleToTwoFloats(_,s,r),n[d]=s.x,a[d++]=r.x,n[d]=s.y,a[d++]=r.y,n[d]=s.z,a[d++]=r.z,n[d]=s.x,a[d++]=r.x,n[d]=s.y,a[d++]=r.y,n[d]=s.z,a[d++]=r.z,n[d]=s.x,a[d++]=r.x,n[d]=s.y,a[d++]=r.y,n[d]=s.z,a[d++]=r.z,n[d]=s.x,a[d++]=r.x,n[d]=s.y,a[d++]=r.y,n[d]=s.z,a[d++]=r.z;for(let x=0;x<f.length;x++){var m=f[x],g=u.lonLatToCartesian(m);c[y][x]=g,h[y][x]=m.forwardMercator(),o[y][x]=m,this.__doubleToTwoFloats(g,s,r),n[d]=s.x,a[d++]=r.x,n[d]=s.y,a[d++]=r.y,n[d]=s.z,a[d++]=r.z,n[d]=s.x,a[d++]=r.x,n[d]=s.y,a[d++]=r.y,n[d]=s.z,a[d++]=r.z,n[d]=s.x,a[d++]=r.x,n[d]=s.y,a[d++]=r.y,n[d]=s.z,a[d++]=r.z,n[d]=s.x,a[d++]=r.x,n[d]=s.y,a[d++]=r.y,n[d]=s.z,a[d++]=r.z,m.lon<i.southWest.lon&&(i.southWest.lon=m.lon),m.lat<i.southWest.lat&&(i.southWest.lat=m.lat),m.lon>i.northEast.lon&&(i.northEast.lon=m.lon),m.lat>i.northEast.lat&&(i.northEast.lat=m.lat)}if(this._closedLine)p=u.lonLatToCartesian(f[0]);else{let x=u.lonLatToCartesian(f[f.length-1]),b=u.lonLatToCartesian(f[f.length-2]);p=new v(x.x+x.x-b.x,x.y+x.y-b.y,x.z+x.z-b.z)}this.__doubleToTwoFloats(p,s,r),n[d]=s.x,a[d++]=r.x,n[d]=s.y,a[d++]=r.y,n[d]=s.z,a[d++]=r.z,n[d]=s.x,a[d++]=r.x,n[d]=s.y,a[d++]=r.y,n[d]=s.z,a[d++]=r.z,n[d]=s.x,a[d++]=r.x,n[d]=s.y,a[d++]=r.y,n[d]=s.z,a[d++]=r.z,n[d]=s.x,a[d++]=r.x,n[d]=s.y,a[d++]=r.y,n[d]=s.z,a[d++]=r.z}}setPointLonLat(t,i,s){if(this._renderNode&&this._renderNode.ellipsoid){let h=this._pathLonLat,c=this._pathLonLatMerc;h[s][i]=t,c[s][i]=t.forwardMercator();var r=this._extent;r.southWest.set(180,90),r.northEast.set(-180,-90);for(let d=0;d<h.length;d++){var n=h[d];for(let u=0;u<n.length;u++){var a=n[u].lon,o=n[u].lat;a>r.northEast.lon&&(r.northEast.lon=a),o>r.northEast.lat&&(r.northEast.lat=o),a<r.southWest.lon&&(r.southWest.lon=a),o<r.southWest.lat&&(r.southWest.lat=o)}}this.setPoint3v(this._renderNode.ellipsoid.lonLatToCartesian(t),i,s,!0)}else{let h=this._pathLonLat[s];h[i].lon=t.lon,h[i].lat=t.lat,h[i].height=t.height}}setPoint3v(t,i=0,s=0,r=!1){if(this._renderNode){var n,a=new v,o=new v,h=this._verticesHigh,c=this._verticesLow,d=this._pathLonLat,u=this._pathLonLatMerc,_=0;n=12*this._pathLengths[s]+24*s;let w=this._path3v[s];w[i].x=t.x,w[i].y=t.y,w[i].z=t.z;let A=this._closedLine||w.length===1;var p;if((i===0||i===1)&&(p=A?w[w.length-1]:new v(w[0].x+w[0].x-w[1].x,w[0].y+w[0].y-w[1].y,w[0].z+w[0].z-w[1].z),_=n,this.__doubleToTwoFloats(p,a,o),h[_]=a.x,h[_+1]=a.y,h[_+2]=a.z,h[_+3]=a.x,h[_+4]=a.y,h[_+5]=a.z,h[_+6]=a.x,h[_+7]=a.y,h[_+8]=a.z,h[_+9]=a.x,h[_+10]=a.y,h[_+11]=a.z,c[_]=o.x,c[_+1]=o.y,c[_+2]=o.z,c[_+3]=o.x,c[_+4]=o.y,c[_+5]=o.z,c[_+6]=o.x,c[_+7]=o.y,c[_+8]=o.z,c[_+9]=o.x,c[_+10]=o.y,c[_+11]=o.z),!r&&this._renderNode.ellipsoid){var f=this._renderNode.ellipsoid.cartesianToLonLat(t);d[s][i]=f,u[s][i]=f.forwardMercator();var m=this._extent;m.southWest.set(180,90),m.northEast.set(-180,-90);for(let E=0;E<d.length;E++){var g=d[E];for(let C=0;C<g.length;C++){var y=g[C].lon,x=g[C].lat;y>m.northEast.lon&&(m.northEast.lon=y),x>m.northEast.lat&&(m.northEast.lat=x),y<m.southWest.lon&&(m.southWest.lon=y),x<m.southWest.lat&&(m.southWest.lat=x)}}}if(_=n+12*i+12,this.__doubleToTwoFloats(t,a,o),h[_]=a.x,h[_+1]=a.y,h[_+2]=a.z,h[_+3]=a.x,h[_+4]=a.y,h[_+5]=a.z,h[_+6]=a.x,h[_+7]=a.y,h[_+8]=a.z,h[_+9]=a.x,h[_+10]=a.y,h[_+11]=a.z,c[_]=o.x,c[_+1]=o.y,c[_+2]=o.z,c[_+3]=o.x,c[_+4]=o.y,c[_+5]=o.z,c[_+6]=o.x,c[_+7]=o.y,c[_+8]=o.z,c[_+9]=o.x,c[_+10]=o.y,c[_+11]=o.z,i===w.length-1||i===w.length-2){var b;if(A)b=w[0];else{var T=w.length-1;b=new v(w[T].x+w[T].x-w[T-1].x,w[T].y+w[T].y-w[T-1].y,w[T].z+w[T].z-w[T-1].z)}_=n+12*w.length+12,this.__doubleToTwoFloats(b,a,o),h[_]=a.x,h[_+1]=a.y,h[_+2]=a.z,h[_+3]=a.x,h[_+4]=a.y,h[_+5]=a.z,h[_+6]=a.x,h[_+7]=a.y,h[_+8]=a.z,h[_+9]=a.x,h[_+10]=a.y,h[_+11]=a.z,c[_]=o.x,c[_+1]=o.y,c[_+2]=o.z,c[_+3]=o.x,c[_+4]=o.y,c[_+5]=o.z,c[_+6]=o.x,c[_+7]=o.y,c[_+8]=o.z,c[_+9]=o.x,c[_+10]=o.y,c[_+11]=o.z}this._changedBuffers[0]=!0}else{let w=this._path3v[s];w[i].x=t.x,w[i].y=t.y,w[i].z=t.z}}_resizePathLengths(t=0){this._pathLengths[0]=0;for(let i=t+1,s=this._path3v.length;i<=s;i++)this._pathLengths[i]=this._pathLengths[i-1]+this._path3v[i-1].length}removeSegment(t){this._path3v.splice(t,1),this.setPath3v([].concat(this._path3v))}removePoint(t,i=0){this._path3v[i].splice(t,1),this._path3v[i].length===0&&this._path3v.splice(i,1),this.setPath3v([].concat(this._path3v))}insertPoint3v(t,i=0,s,r=0){let n=[].concat(this._path3v),a=n[r];if(a){let o=[].concat(this._pathColors);if(a.splice(i,0,t),s){let h=o[r];h||(h=new Array(a.length)),h.splice(i,0,s)}this.setPath3v(n,o)}else this.addPoint3v(t,r)}appendPoint3v(t,i,s){this._path3v.length!==0&&this._renderNode?(this._verticesHigh=zt(this._verticesHigh),this._verticesLow=zt(this._verticesLow),this._colors=zt(this._colors),this._orders=zt(this._orders),this._indexes=zt(this._indexes),this.__appendPoint3v(this._path3v,t,this._pathColors,i||this._defaultColor,this._closedLine,this._verticesHigh,this._verticesLow,this._colors,this._orders,this._indexes,s?null:this._renderNode.ellipsoid,this._pathLonLat,this._pathLonLatMerc,this._extent),this._pathLengths[this._path3v.length]+=1,this._changedBuffers[0]=!0,this._changedBuffers[2]=!0,this._changedBuffers[1]=!0):(this._pathColors.push([i||this._defaultColor]),this.addPoint3v(t))}addPoint3v(t,i=0){i>=this._path3v.length&&this._path3v.push([]),this._path3v[i].push(t),this.setPath3v([].concat(this._path3v))}addPointLonLat(t,i=0){i>=this._pathLonLat.length&&this._pathLonLat.push([]),this._pathLonLat[i].push(t),this.setPathLonLat([].concat(this._pathLonLat))}clear(){this._clearData()}setPointColor(t,i=0,s=0){if(this._renderNode&&i<this._path3v[s].length){let r=this._pathColors[s];if(!r){if(!(this._path3v[s]&&i<this._path3v[s].length))return;this._pathColors[s]=new Array(this._path3v[s].length)}r[i]?(r[i][0]=t[0],r[i][1]=t[1],r[i][2]=t[2],r[i][3]=t[3]||1):r[i]=[t[0],t[1],t[2],t[3]||1];let n=this._colors,a=16*i+16*this._pathLengths[s]+32*s;n[a]=n[a+4]=n[a+8]=n[a+12]=t[0],n[a+1]=n[a+5]=n[a+9]=n[a+13]=t[1],n[a+2]=n[a+6]=n[a+10]=n[a+14]=t[2],n[a+3]=n[a+7]=n[a+11]=n[a+15]=t[3]||1,this._changedBuffers[2]=!0}else this._pathColors[s][i]=t}setOpacity(t){this._opacity=t}getOpacity(){return this._opacity}setAltitude(t){this.altitude=t}setThickness(t){this.thickness=t}getThickness(){return this.thickness}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){t&&(this._renderNode=t,this._pathLonLat.length?this._createDataLonLat([].concat(this._pathLonLat)):this._createData3v([].concat(this._path3v)),this._refresh(),t.renderer&&t.renderer.isInitialized()&&this._update())}_clearData(){this._verticesHigh=null,this._verticesLow=null,this._orders=null,this._indexes=null,this._colors=null,this._texCoordArr=null,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._texCoordArr=[],this._path3v.length=0,this._pathLonLat.length=0,this._pathLonLatMerc.length=0,this._path3v=[],this._pathLonLat=[],this._pathLonLatMerc=[]}_createData3v(t){this._clearData(),this.__appendLineData3v(t,this._pathColors,this._defaultColor,this._closedLine,this._verticesHigh,this._verticesLow,this._orders,this._indexes,this._renderNode.ellipsoid,this._pathLonLat,this._path3v,this._pathLonLatMerc,this._extent,this._colors),this._resizePathLengths(0)}_createDataLonLat(t){this._clearData(),this.__appendLineDataLonLat(t,this._pathColors,this._defaultColor,this._closedLine,this._verticesHigh,this._verticesLow,this._orders,this._indexes,this._texCoordArr,this._renderNode.ellipsoid,this._path3v,this._pathLonLat,this._pathLonLatMerc,this._extent,this._colors),this._resizePathLengths(0)}remove(){this._entity=null,this._pathColors.length=0,this._pathColors=[],this._verticesHigh=null,this._verticesLow=null,this._orders=null,this._indexes=null,this._colors=null,this._texCoordArr=null,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._texCoordArr=[],this._deleteBuffers(),this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._pickingColor[0]=t.x/255,this._pickingColor[1]=t.y/255,this._pickingColor[2]=t.z/255}getExtent(){return this._extent.clone()}getPath3v(){return this._path3v}getPathLonLat(){return this._pathLonLat}getPathColors(){return this._pathColors}setPathColors(t){t&&(this._colors=[],this._pathColors=[].concat(t),ki.setPathColors(this._pathLonLat,t,this._defaultColor,this._colors),this._changedBuffers[2]=!0)}setColorHTML(t){this._defaultColor=ft(t);let i=at(t),s=this._pathColors;for(let n=0,a=s.length;n<a;n++){let o=s[n];for(let h=0,c=o.length;h<c;h++)o[h][0]=i.x,o[h][1]=i.y,o[h][2]=i.z,o[h][3]=i.w}let r=this._colors;for(let n=0,a=r.length;n<a;n+=4)r[n]=i.x,r[n+1]=i.y,r[n+2]=i.z,r[n+3]=i.w;this._changedBuffers[2]=!0}setPathLonLatFast(t,i){this.setPathLonLat(t,i,!0)}setPath3vFast(t,i){this.setPath3v(t,i,!0)}setPathLonLat(t,i,s=!1){i&&(this._pathColors=[].concat(i)),this._renderNode&&this._renderNode.ellipsoid?s?(this._setEqualPathLonLat(t),this._changedBuffers[0]=!0,this._changedBuffers[2]=!0):(this._createDataLonLat(t),this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0):this._pathLonLat=[].concat(t)}getSize(t=0){return this._path3v[t].length}setPath3v(t,i,s=!1){i&&(this._pathColors=[].concat(i)),this._renderNode?s?(this._setEqualPath3v(t),this._changedBuffers[0]=!0,this._changedBuffers[2]=!0):(this._createData3v(t),this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0):this._path3v=[].concat(t)}draw(){if(this.visibility&&this._path3v.length){this._update();let t=this._renderNode.renderer,i=t.handler.programs.polyline_screen,s=i._program,r=t.handler.gl,n=s.attributes,a=s.uniforms,o=this._handler._entityCollection;i.activate(),r.disable(r.CULL_FACE),r.uniform1f(a.depthOffset,o.polygonOffsetUnits),r.uniformMatrix4fv(a.proj,!1,t.activeCamera.getProjectionMatrix()),r.uniformMatrix4fv(a.view,!1,t.activeCamera.getViewMatrix()),r.uniform3fv(a.rtcEyePositionHigh,this._handler._rtcEyePositionHigh),r.uniform3fv(a.rtcEyePositionLow,this._handler._rtcEyePositionLow),r.uniform4fv(a.visibleSphere,this._visibleSphere),r.uniform2fv(a.viewport,[t.handler.canvas.width,t.handler.canvas.height]),r.uniform1f(a.thickness,.5*this.thickness),r.uniform1f(a.opacity,this._opacity*o._fadingOpacity),r.uniform1f(a.texOffset,this._texOffset),r.uniform1f(a.strokeSize,this._strokeSize),r.bindBuffer(r.ARRAY_BUFFER,this._colorsBuffer),r.vertexAttribPointer(n.color,this._colorsBuffer.itemSize,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this._texCoordBuffer),r.vertexAttribPointer(n.texCoord,this._texCoordBuffer.itemSize,r.FLOAT,!1,0,0);let h=this._verticesHighBuffer;r.bindBuffer(r.ARRAY_BUFFER,h),r.vertexAttribPointer(n.prevHigh,h.itemSize,r.FLOAT,!1,12,0),r.vertexAttribPointer(n.currentHigh,h.itemSize,r.FLOAT,!1,12,48),r.vertexAttribPointer(n.nextHigh,h.itemSize,r.FLOAT,!1,12,96),h=this._verticesLowBuffer,r.bindBuffer(r.ARRAY_BUFFER,h),r.vertexAttribPointer(n.prevLow,h.itemSize,r.FLOAT,!1,12,0),r.vertexAttribPointer(n.currentLow,h.itemSize,r.FLOAT,!1,12,48),r.vertexAttribPointer(n.nextLow,h.itemSize,r.FLOAT,!1,12,96),r.bindBuffer(r.ARRAY_BUFFER,this._ordersBuffer),r.vertexAttribPointer(n.order,this._ordersBuffer.itemSize,r.FLOAT,!1,4,0),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this._indexesBuffer),r.drawElements(r.TRIANGLE_STRIP,this._indexesBuffer.numItems,r.UNSIGNED_INT,0),r.enable(r.CULL_FACE)}}drawPicking(){if(this.visibility&&this._path3v.length){let t=this._renderNode.renderer,i=t.handler.programs.polyline_picking,s=i._program,r=t.handler.gl,n=s.attributes,a=s.uniforms,o=this._handler._entityCollection;i.activate(),r.disable(r.CULL_FACE),r.uniform1f(a.depthOffset,o.polygonOffsetUnits),r.uniformMatrix4fv(a.proj,!1,t.activeCamera.getProjectionMatrix()),r.uniformMatrix4fv(a.view,!1,t.activeCamera.getViewMatrix()),r.uniform4fv(a.color,[this._pickingColor[0],this._pickingColor[1],this._pickingColor[2],1]),r.uniform3fv(a.rtcEyePositionHigh,this._handler._rtcEyePositionHigh),r.uniform3fv(a.rtcEyePositionLow,this._handler._rtcEyePositionLow),r.uniform4fv(a.visibleSphere,this._visibleSphere),r.uniform2fv(a.viewport,[t.handler.canvas.width,t.handler.canvas.height]),r.uniform1f(a.thickness,.5*this.thickness*o.pickingScale[0]);let h=this._verticesHighBuffer;r.bindBuffer(r.ARRAY_BUFFER,h),r.vertexAttribPointer(n.prevHigh,h.itemSize,r.FLOAT,!1,12,0),r.vertexAttribPointer(n.currentHigh,h.itemSize,r.FLOAT,!1,12,48),r.vertexAttribPointer(n.nextHigh,h.itemSize,r.FLOAT,!1,12,96),h=this._verticesLowBuffer,r.bindBuffer(r.ARRAY_BUFFER,h),r.vertexAttribPointer(n.prevLow,h.itemSize,r.FLOAT,!1,12,0),r.vertexAttribPointer(n.currentLow,h.itemSize,r.FLOAT,!1,12,48),r.vertexAttribPointer(n.nextLow,h.itemSize,r.FLOAT,!1,12,96),r.bindBuffer(r.ARRAY_BUFFER,this._ordersBuffer),r.vertexAttribPointer(n.order,this._ordersBuffer.itemSize,r.FLOAT,!1,4,0),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this._indexesBuffer),r.drawElements(r.TRIANGLE_STRIP,this._indexesBuffer.numItems,r.UNSIGNED_INT,0),r.enable(r.CULL_FACE)}}_refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}_update(){if(this._renderNode){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}}_deleteBuffers(){if(this._renderNode){let t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._verticesHighBuffer),t.deleteBuffer(this._verticesLowBuffer),t.deleteBuffer(this._ordersBuffer),t.deleteBuffer(this._indexesBuffer),t.deleteBuffer(this._colorsBuffer),t.deleteBuffer(this._texCoordBuffer),this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._ordersBuffer=null,this._indexesBuffer=null,this._colorsBuffer=null,this._texCoordBuffer=null}}_createVerticesBuffer(){let t=this._renderNode.renderer.handler,i=this._verticesHigh.length/3;this._verticesHighBuffer&&this._verticesHighBuffer.numItems===i||(t.gl.deleteBuffer(this._verticesHighBuffer),t.gl.deleteBuffer(this._verticesLowBuffer),this._verticesHighBuffer=t.createStreamArrayBuffer(3,i),this._verticesLowBuffer=t.createStreamArrayBuffer(3,i)),this._verticesHigh=se(this._verticesHigh),this._verticesLow=se(this._verticesLow),t.setStreamArrayBuffer(this._verticesHighBuffer,this._verticesHigh),t.setStreamArrayBuffer(this._verticesLowBuffer,this._verticesLow)}_createIndexBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._ordersBuffer),t.gl.deleteBuffer(this._indexesBuffer),this._orders=se(this._orders),this._ordersBuffer=t.createArrayBuffer(this._orders,1,this._orders.length/2),this._indexes=se(this._indexes,Uint32Array),this._indexesBuffer=t.createElementArrayBuffer(this._indexes,1,this._indexes.length)}_createColorsBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._colorsBuffer),this._colors=se(this._colors),this._colorsBuffer=t.createArrayBuffer(this._colors,4,this._colors.length/4)}_createTexCoordBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordArr=se(this._texCoordArr),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,4,this._texCoordArr.length/4)}setVisibleSphere(t,i){this._handler&&(this._visibleSphere[0]=t.x-this._handler._relativeCenter.x,this._visibleSphere[1]=t.y-this._handler._relativeCenter.y,this._visibleSphere[2]=t.z-this._handler._relativeCenter.z),this._visibleSphere[3]=i}updateRTCPosition(){this._handler&&this._renderNode&&(this._visibleSphere[0]=this._visibleSphere[0]-this._handler._relativeCenter.x,this._visibleSphere[1]=this._visibleSphere[1]-this._handler._relativeCenter.y,this._visibleSphere[2]=this._visibleSphere[2]-this._handler._relativeCenter.z,this._setEqualPath3v(this._path3v)),this._changedBuffers[0]=!0}};ha.__counter__=0;let fl=ha;const ca=class da{constructor(t={}){this.__id=da.__counter__++,this._thickness=t.thickness||2,this._startPosition=He(t.startPosition),this._startPositionHigh=new v,this._startPositionLow=new v,v.doubleToTwoFloats(this._startPosition,this._startPositionHigh,this._startPositionLow),this._endPosition=He(t.endPosition),this._endPositionHigh=new v,this._endPositionLow=new v,v.doubleToTwoFloats(this._endPosition,this._endPositionHigh,this._endPositionLow),this._startColor=nt(t.startColor),this._endColor=nt(t.endColor),this._visibility=t.visibility==null||t.visibility,this._entity=null,this._handler=null,this._handlerIndex=-1,this._image=t.image||null,this._src=t.src||null,this._texOffset=t.texOffset||0,this._strokeSize=t.strokeSize!=null?t.strokeSize:32}setStartPosition(t,i,s){this._startPosition.x=t,this._startPosition.y=i,this._startPosition.z=s,v.doubleToTwoFloats(this._startPosition,this._startPositionHigh,this._startPositionLow),this._handler&&this._handler.setStartPositionArr(this._handlerIndex,this._startPositionHigh,this._startPositionLow)}getLength(){return this._startPosition.distance(this._endPosition)}setSrc(t){this._src=t;let i=this._handler;if(i){let s=i._entityCollection.renderNode;if(s&&s.renderer){let r=s.renderer.strokeTextureAtlas;t&&t.length?r.loadImage(t,(n=>{if(n.__nodeIndex!=null&&r.get(n.__nodeIndex)){this._image=n;let a=r.get(n.__nodeIndex);i.setTexCoordArr(this._handlerIndex,a.texCoords)}else r.addImage(n),r.createTexture(),this._image=n,s.updateStrokeTexCoords()})):(i.setTextureDisabled(this._handlerIndex),s.updateStrokeTexCoords())}}}getSrc(){return this._src}setImage(t){this.setSrc(t.src)}getImage(){return this._image}setStartPosition3v(t){this._startPosition.x=t.x,this._startPosition.y=t.y,this._startPosition.z=t.z,v.doubleToTwoFloats(this._startPosition,this._startPositionHigh,this._startPositionLow),this._handler&&this._handler.setStartPositionArr(this._handlerIndex,this._startPositionHigh,this._startPositionLow)}setEndPosition(t,i,s){this._endPosition.x=t,this._endPosition.y=i,this._endPosition.z=s,v.doubleToTwoFloats(this._endPosition,this._endPositionHigh,this._endPositionLow),this._handler&&this._handler.setEndPositionArr(this._handlerIndex,this._endPositionHigh,this._endPositionLow)}setEndPosition3v(t){this._endPosition.x=t.x,this._endPosition.y=t.y,this._endPosition.z=t.z,v.doubleToTwoFloats(this._endPosition,this._endPositionHigh,this._endPositionLow),this._handler&&this._handler.setEndPositionArr(this._handlerIndex,this._endPositionHigh,this._endPositionLow)}setThickness(t){this._thickness=t,this._handler&&this._handler.setThicknessArr(this._handlerIndex,t)}setColors4v(t,i){t&&(this._startColor.x=t.x,this._startColor.y=t.y,this._startColor.z=t.z,this._startColor.w=t.w),i&&(this._endColor.x=i.x,this._endColor.y=i.y,this._endColor.z=i.z,this._endColor.w=i.w),this._handler&&this._handler.setRgbaArr(this._handlerIndex,this._startColor,this._endColor)}setColorsHTML(t,i){t&&(this._startColor=at(t)),i&&(this._endColor=at(i)),this._handler&&this._handler.setRgbaArr(this._handlerIndex,this._startColor,this._endColor)}get texOffset(){return this._texOffset}set texOffset(t){this._texOffset=t,this._handler&&this._handler.setTexOffsetArr(this._handlerIndex,t)}get strokeSize(){return this._strokeSize}set strokeSize(t){this._strokeSize=t,this._handler&&this._handler.setStrokeSizeArr(this._handlerIndex,t)}getStartPosition(){return this._startPosition}getEndPosition(){return this._endPosition}setVisibility(t){this._visibility=t,this._handler&&this._handler.setVisibility(this._handlerIndex,t)}getVisibility(){return this._visibility}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._handler&&this._handler.setPickingColorArr(this._handlerIndex,t)}};ca.__counter__=0;let gl=ca,_e=new v,fe=new v;const ua=class _a{constructor(t={}){if(this.__id=_a.__counter__++,this.visibility=t.visibility==null||t.visibility,this.color=new Float32Array([1,1,1,.5]),t.color){let i=nt(t.color);this.setColor(i.x,i.y,i.z,i.w)}t.opacity&&this.setOpacity(t.opacity),this._renderNode=null,this._entity=null,this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._indexBuffer=null,this._verticesHigh=[],this._verticesLow=[],this._indexes=[],this._path=[],this._pickingColor=new Float32Array(4),this._gridSize=1,this._handler=null,this._handlerIndex=-1,t.path&&this.setPath(t.path)}setPickingColor3v(t){this._pickingColor[0]=t.x/255,this._pickingColor[1]=t.y/255,this._pickingColor[2]=t.z/255,this._pickingColor[3]=1}clear(){this._path.length=0,this._path=[],this._verticesHigh.length=0,this._verticesHigh=[],this._verticesLow.length=0,this._verticesLow=[],this._indexes.length=0,this._indexes=[],this._deleteBuffers()}setColor4v(t){this.setColor(t.x,t.y,t.z,t.w)}setColorHTML(t){this.setColor4v(at(t))}setColor(t,i,s,r){r=r||this.color[3],this.color[0]=t,this.color[1]=i,this.color[2]=s,this.color[3]=r}setOpacity(t){this.color[3]=t||0}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){this._renderNode=t,this._createBuffers()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}draw(){if(this.visibility&&this._verticesHigh.length){let t=this._renderNode.renderer,i=t.handler.gl,s=t.handler.programs.strip,r=s._program,n=r.attributes,a=r.uniforms;s.activate(),i.disable(i.CULL_FACE),i.uniformMatrix4fv(a.viewMatrix,!1,t.activeCamera.getViewMatrix()),i.uniformMatrix4fv(a.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),i.uniform3fv(a.eyePositionHigh,t.activeCamera.eyeHigh),i.uniform3fv(a.eyePositionLow,t.activeCamera.eyeLow),i.uniform4fv(a.uColor,this.color),i.uniform1f(a.uOpacity,this._entity._entityCollection._fadingOpacity),i.bindBuffer(i.ARRAY_BUFFER,this._verticesHighBuffer),i.vertexAttribPointer(n.aVertexPositionHigh,this._verticesHighBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._verticesLowBuffer),i.vertexAttribPointer(n.aVertexPositionLow,this._verticesLowBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this._indexBuffer),i.drawElements(t.handler.gl.TRIANGLE_STRIP,this._indexBuffer.numItems,i.UNSIGNED_INT,0),i.enable(i.CULL_FACE)}}drawPicking(){if(this.visibility&&this._verticesHigh.length){let t=this._renderNode.renderer,i=t.handler.gl,s=t.handler.programs.strip,r=s._program,n=r.attributes,a=r.uniforms;s.activate(),i.disable(i.CULL_FACE),i.uniformMatrix4fv(a.viewMatrix,!1,t.activeCamera.getViewMatrix()),i.uniformMatrix4fv(a.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),i.uniform3fv(a.eyePositionHigh,t.activeCamera.eyeHigh),i.uniform3fv(a.eyePositionLow,t.activeCamera.eyeLow),i.uniform1f(a.uOpacity,this._entity._entityCollection._fadingOpacity!=0?1:0),i.uniform4fv(a.uColor,this._pickingColor),i.bindBuffer(i.ARRAY_BUFFER,this._verticesHighBuffer),i.vertexAttribPointer(n.aVertexPositionHigh,this._verticesHighBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._verticesLowBuffer),i.vertexAttribPointer(n.aVertexPositionLow,this._verticesLowBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this._indexBuffer),i.drawElements(t.handler.gl.TRIANGLE_STRIP,this._indexBuffer.numItems,i.UNSIGNED_INT,0),i.enable(i.CULL_FACE)}}_deleteBuffers(){if(this._renderNode&&this._renderNode.renderer){let t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._indexBuffer),t.deleteBuffer(this._verticesHighBuffer),t.deleteBuffer(this._verticesLowBuffer)}this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._indexBuffer=null}_createBuffers(){if(this._renderNode&&this._renderNode.renderer&&this._renderNode.renderer.isInitialized()){let t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._indexBuffer),t.deleteBuffer(this._verticesHighBuffer),t.deleteBuffer(this._verticesLowBuffer),this._verticesHighBuffer=this._renderNode.renderer.handler.createArrayBuffer(new Float32Array(this._verticesHigh),3,this._verticesHigh.length/3),this._verticesLowBuffer=this._renderNode.renderer.handler.createArrayBuffer(new Float32Array(this._verticesLow),3,this._verticesLow.length/3),this._indexBuffer=this._renderNode.renderer.handler.createElementArrayBuffer(new Uint32Array(this._indexes),1,this._indexes.length)}}addEdge3v(t,i){let s=this._path.length;if(s===0)this._path.push([t.clone(),i.clone()]);else{let r=this._path[s-1][0],n=this._path[s-1][1];this._path.push([t.clone(),i.clone()]);let a=this._verticesHigh,o=this._verticesLow,h=this._gridSize,c=h+1,d=new v,u=this._verticesHigh.length/3,_=u,p=Math.abs(r.sub(n).normal().dot(t.sub(r).normal()));for(let f=0;f<c;f++){let m=f/h,g=r.lerp(t,m),y=n.lerp(i,m);for(let x=0;x<c;x++){let b=x/h,T=r.lerp(n,b),w=t.lerp(i,b);p!==1?new $e(g,y).intersects(new $e(T,w),d):d=w,_=u+f*c+x,v.doubleToTwoFloats(d,_e,fe);let A=3*_;a[A]=_e.x,a[A+1]=_e.y,a[A+2]=_e.z,o[A]=fe.x,o[A+1]=fe.y,o[A+2]=fe.z,f<h&&this._indexes.push(_,_+c)}f<h&&this._indexes.push(_+c,_+1)}this._createBuffers()}}setEdge3v(t,i,s){if(s!==this._path.length)if(this._path[s]){if(this._path[s][0]=t,this._path[s][1]=i,this._path.length>1){let r=this._gridSize,n=r+1,a=n*n,o=new v,h=this._verticesHigh,c=this._verticesLow;if(s===this._path.length-1){let d=this._path[s-1][0],u=this._path[s-1][1],_=this._verticesHigh.length/3-a,p=_,f=Math.abs(d.sub(u).normal().dot(t.sub(d).normal()));for(let m=0;m<n;m++){let g=m/r,y=d.lerp(t,g),x=u.lerp(i,g);for(let b=0;b<n;b++){let T=b/r,w=d.lerp(u,T),A=t.lerp(i,T);f!==1?new $e(y,x).intersects(new $e(w,A),o):o=A,p=_+m*n+b,v.doubleToTwoFloats(o,_e,fe);let E=3*p;h[E]=_e.x,h[E+1]=_e.y,h[E+2]=_e.z,c[E]=fe.x,c[E+1]=fe.y,c[E+2]=fe.z}}}else if(s===0){let d=0,u=t,_=i;t=this._path[1][0],i=this._path[1][1];for(let p=0;p<n;p++){let f=p/r,m=u.lerp(t,f),g=_.lerp(i,f);for(let y=0;y<n;y++){let x=y/r,b=u.lerp(_,x),T=t.lerp(i,x);new $e(m,g).intersects(new $e(b,T),o),d=p*n+y,v.doubleToTwoFloats(o,_e,fe);let w=3*d;h[w]=_e.x,h[w+1]=_e.y,h[w+2]=_e.z,c[w]=fe.x,c[w+1]=fe.y,c[w+2]=fe.z}}}else if(s>0&&s<this._path.length){let d=this._path[s-1][0],u=this._path[s-1][1],_=this._path[s+1][0],p=this._path[s+1][1],f=s*a,m=(s-1)*a,g=m;for(let y=0;y<n;y++){let x=y/r,b=d.lerp(t,x),T=i.lerp(p,x),w=t.lerp(_,x),A=u.lerp(i,x);for(let E=0;E<n;E++){let C=E/r,M=d.lerp(u,C),P=t.lerp(i,C);new $e(b,A).intersects(new $e(M,P),o);let B=y*n+E;g=m+B,v.doubleToTwoFloats(o,_e,fe);let k=3*g;h[k]=_e.x,h[k+1]=_e.y,h[k+2]=_e.z,c[k]=fe.x,c[k+1]=fe.y,c[k+2]=fe.z;let O=_.lerp(p,C);P=t.lerp(i,C),new $e(w,T).intersects(new $e(P,O),o),g=f+B,v.doubleToTwoFloats(o,_e,fe),k=3*g,h[k]=_e.x,h[k+1]=_e.y,h[k+2]=_e.z,c[k]=fe.x,c[k+1]=fe.y,c[k+2]=fe.z}}}this._createBuffers()}}else console.warn(`strip index ${s} is out of range`);else this.addEdge3v(t,i)}removeEdge(t){this._path.splice(t,1),this.setPath([].concat(this._path))}setGridSize(t){this._gridSize=t,this.setPath([].concat(this._path))}getPath(){return this._path}setPath(t){this._verticesHigh=[],this._verticesLow=[],this._indexes=[],this._path=[];for(let i=0;i<t.length;i++){let s=t[i][0],r=t[i][1];s instanceof Array&&(s=new v(s[0],s[1],s[2])),r instanceof Array&&(r=new v(r[0],r[1],r[2])),this.addEdge3v(s,r)}}insertEdge3v(t,i,s){if(s<this._path.length){let r=[].concat(this._path);r.splice(s,0,[t,i]),this.setPath(r)}else s===this._path.length&&this.addEdge3v(t,i)}};ua.__counter__=0;let pl=ua;const fa=class ga{constructor(t={}){t.properties=t.properties||{},this.__id=ga.__counter__++,this._name=t.name||`entity:${this.__id}`,this.properties=t.properties||{},this.childEntities=[],this.parent=null,this.forceGlobalPosition=t.forceGlobalPosition||!1,this.forceGlobalRotation=t.forceGlobalRotation||!1,this.forceGlobalScale=t.forceGlobalScale||!1,this._cartesian=He(t.cartesian),this._rootCartesian=new v,this._localPosition=He(t.localPosition),this._absoluteLocalPosition=new v,this._lonLat=ji(t.lonlat),this._lonLatMerc=new L,this._altitude=t.altitude||0,this._visibility=t.visibility==null||t.visibility,this._entityCollection=null,this._entityCollectionIndex=-1,this._layer=null,this._layerIndex=-1,this._pickingColor=new v(0,0,0),this._independentPicking=t.independentPicking||!1,this._relativePosition=t.relativePosition||!1,this._pitchRad=t.pitch||0,this._yawRad=t.yaw||0,this._rollRad=t.roll||0,this._scale=He(t.scale,new v(1,1,1)),this._absoluteScale=new v,this._qFrame=F.IDENTITY,this._qRot=F.IDENTITY,this._absoluteQRot=F.IDENTITY,this._useDirectQuaternion=!1,this._featureConstructorArray={billboard:[ol,this.setBillboard],label:[ul,this.setLabel],polyline:[fl,this.setPolyline],pointCloud:[_l,this.setPointCloud],geometry:[hl,this.setGeometry],geoObject:[dl,this.setGeoObject],strip:[pl,this.setStrip],ray:[gl,this.setRay]},this.billboard=this._createOptionFeature("billboard",t.billboard),this.label=this._createOptionFeature("label",t.label),this.polyline=this._createOptionFeature("polyline",t.polyline),this.ray=this._createOptionFeature("ray",t.ray),this.pointCloud=this._createOptionFeature("pointCloud",t.pointCloud),this.geometry=this._createOptionFeature("geometry",t.geometry),this.geoObject=this._createOptionFeature("geoObject",t.geoObject),this.strip=this._createOptionFeature("strip",t.strip)}get name(){return this._name}set name(t){t!==this._name&&(this._name=t)}get isEmpty(){return!(this.strip||this.polyline||this.ray||this.geoObject||this.geometry||this.billboard||this.label||this.pointCloud)}get rootEntity(){let t=this;for(;t;){if(!t.parent)return t;t=t.parent}return this}set relativePosition(t){if(t!==this._relativePosition){let i=this.getAbsoluteCartesian(),s=this.getAbsolutePitch(),r=this.getAbsoluteYaw(),n=this.getAbsoluteRoll();this._relativePosition=t,this.parent&&this._rootCartesian.copy(this.parent._rootCartesian),t?this.parent&&(this.setAbsoluteCartesian3v(i),this.setAbsolutePitch(s),this.setAbsoluteYaw(r),this.setAbsoluteRoll(n)):(this.setCartesian3v(i),this.setPitch(s),this.setYaw(r),this.setRoll(n))}}get relativePosition(){return this._relativePosition}get entityCollection(){return this._entityCollection}get id(){return this.__id}isEqual(t){return this.__id===t.__id}get layerIndex(){return this._layerIndex}get instanceName(){return"Entity"}_createOptionFeature(t,i){if(i){let s=this._featureConstructorArray[t];return s[1].call(this,new s[0](i))}return null}getCollectionIndex(){return this._entityCollectionIndex}addTo(t){return t.add(this),this}remove(){return this._layer&&this._layer.removeEntity(this),this._entityCollection&&this._entityCollection.removeEntity(this),this}setVisibility(t){this._visibility=t,this.billboard&&this.billboard.setVisibility(t),this.geoObject&&this.geoObject.setVisibility(t),this.label&&this.label.setVisibility(t),this.polyline&&this.polyline.setVisibility(t),this.ray&&this.ray.setVisibility(t),this.geometry&&this.geometry.setVisibility(t);for(let i=0;i<this.childEntities.length;i++)this.childEntities[i].setVisibility(t)}getVisibility(){return this._visibility}setCartesian3v(t){this.setCartesian(t.x,t.y,t.z)}getScale(){return this._scale}setScale3v(t){this._scale.copy(t),this._updateAbsolutePosition();for(let i=0;i<this.childEntities.length;i++){let s=this.childEntities[i];s.forceGlobalScale?s.setScale3v(this._scale):s.setScale3v(this.childEntities[i].getScale())}}setScale(t){this.setScale3v(new v(t,t,t))}getAbsoluteRotation(){return this._absoluteQRot.clone()}getRotation(){return this._qRot}setLook3v(t){let i,s=new F,r=this.getAbsoluteCartesian();if(this._entityCollection){let n=this._entityCollection.renderNode.ellipsoid.getSurfaceNormal3v(r);i=s.setLookRotation(t.sub(r),n).conjugate()}else i=s.setLookRotation(t.sub(r),v.UP).conjugate();this.setAbsoluteRotation(i)}setLookLonLat(t){if(this._entityCollection){let i=this._entityCollection.renderNode.ellipsoid.lonLatToCartesian(t);this.setLook3v(i)}}setAbsoluteRotation(t){this._absoluteQRot.copy(t),this._updatePitchYawRoll()}setRotation(t){this._useDirectQuaternion=!1,this._pitchRad=t.getPitch(),this._yawRad=t.getYaw(),this._rollRad=t.getRoll(),this._updateAbsolutePosition()}setDirectQuaternionRotation(t){this._qRot.copy(t),this._useDirectQuaternion=!0,this._pitchRad=this._qRot.getPitch(),this._yawRad=this._qRot.getYaw(),this._rollRad=this._qRot.getRoll(),this._updateAbsolutePosition()}setPitch(t){this._useDirectQuaternion=!1,this._pitchRad=t,this._updateAbsolutePosition()}setYaw(t){this._useDirectQuaternion=!1,this._yawRad=t,this._updateAbsolutePosition()}setRoll(t){this._useDirectQuaternion=!1,this._rollRad=t,this._updateAbsolutePosition()}getPitch(){return this._pitchRad}getYaw(){return this._yawRad}getRoll(){return this._rollRad}setAbsolutePitch(t){this._relativePosition?(this._absoluteQRot.setPitchYawRoll(t,this.getAbsoluteYaw(),this.getAbsoluteRoll(),this._qFrame),this._updatePitchYawRoll()):this.setPitch(t)}setAbsoluteYaw(t){this._relativePosition?(this._absoluteQRot.setPitchYawRoll(this.getAbsolutePitch(),t,this.getAbsoluteRoll(),this._qFrame),this._updatePitchYawRoll()):this.setYaw(t)}setAbsoluteRoll(t){this._relativePosition?(this._absoluteQRot.setPitchYawRoll(this.getAbsolutePitch(),this.getAbsoluteYaw(),t,this._qFrame),this._updatePitchYawRoll()):this.setRoll(t)}getAbsolutePitch(){return this.parent&&this._relativePosition?this._qFrame.conjugate().inverse().mul(this._absoluteQRot).getPitch():this._pitchRad}getAbsoluteYaw(){return this.parent&&this._relativePosition?this._qFrame.conjugate().inverse().mul(this._absoluteQRot).getYaw():this._yawRad}getAbsoluteRoll(){return this.parent&&this._relativePosition?this._qFrame.conjugate().inverse().mul(this._absoluteQRot).getRoll():this._rollRad}_getScaleByDistance(){let t=1;if(this._entityCollection){let i=this._entityCollection.scaleByDistance,s=1;this._entityCollection.renderNode&&this._entityCollection.renderNode.renderer&&(s=this._entityCollection.renderNode.renderer.activeCamera.eye.distance(this._rootCartesian)),t=i[2]*Ni(s,i[0],i[1])/i[0]}return t}setAbsoluteCartesian(t,i,s){this.setAbsoluteCartesian3v(new v(t,i,s))}setAbsoluteCartesian3v(t){let i=t;if(this.parent&&this._relativePosition){let s=this._getScaleByDistance();i=t.sub(this.parent.getAbsoluteCartesian()).scale(1/s).divA(this.parent._absoluteScale),i=this.parent._absoluteQRot.conjugate().mulVec3(i)}this.setCartesian3v(i)}getAbsoluteCartesian(){if(this.parent&&this._relativePosition){let t=this._getScaleByDistance();return this._rootCartesian.add(this._absoluteLocalPosition.scaleTo(t))}return this._cartesian.clone()}setCartesian(t,i,s){this._cartesian.set(t,i,s),this._updateAbsolutePosition();for(let r=0;r<this.childEntities.length;r++){let n=this.childEntities[r];n._relativePosition?n.setCartesian3v(n.getCartesian()):n.forceGlobalPosition&&n.setCartesian(t,i,s)}this._updateLonLat()}_updatePitchYawRoll(){if(this.parent){this._qRot=this.parent._absoluteQRot.conjugate().mul(this._absoluteQRot),this._pitchRad=this._qRot.getPitch(),this._yawRad=this._qRot.getYaw(),this._rollRad=this._qRot.getRoll(),this.geoObject&&this.geoObject.setRotation(this._absoluteQRot);for(let t=0;t<this.childEntities.length;t++)this.childEntities[t]._updateAbsolutePosition()}}_updateAbsolutePosition(){let t=this.parent;if(t&&this._relativePosition){this._scale.mulRes(t._absoluteScale,this._absoluteScale),this._qFrame.copy(t._qFrame),this._rootCartesian.copy(t._rootCartesian),this._useDirectQuaternion||(t&&this.forceGlobalRotation?this._qRot.setPitchYawRoll(t._pitchRad,t._yawRad,t._rollRad):this._qRot.setPitchYawRoll(this._pitchRad,this._yawRad,this._rollRad)),t._absoluteQRot.mulRes(this._qRot,this._absoluteQRot);let i=t._absoluteQRot.mulVec3(this._cartesian.add(this._localPosition)).mulA(t._absoluteScale);t._absoluteLocalPosition.addRes(i,this._absoluteLocalPosition)}else this._qFrame=F.IDENTITY,this._entityCollection&&this._entityCollection.renderNode&&(this._qFrame=this._entityCollection.renderNode.getFrameRotation(this._cartesian)),this._useDirectQuaternion?this._qFrame.isEqual(F.IDENTITY)||(this._qRot=this._qRot.mul(this._qFrame)):t&&this.forceGlobalRotation?this._qRot.setPitchYawRoll(t._pitchRad,t._yawRad,t._rollRad,this._qFrame):this._qRot.setPitchYawRoll(this._pitchRad,this._yawRad,this._rollRad,this._qFrame),this._absoluteScale.copy(this._scale),this._absoluteQRot.copy(this._qRot),this._rootCartesian.copy(this._cartesian),this._absoluteLocalPosition.copy(this._localPosition);this.geoObject&&(this.geoObject.setScale3v(this._absoluteScale),this.geoObject.setRotation(this._absoluteQRot),this.geoObject.setPosition3v(this._rootCartesian),this.geoObject.setLocalPosition3v(this._absoluteLocalPosition)),this.billboard&&this.billboard.setPosition3v(this._rootCartesian),this.label&&this.label.setPosition3v(this._rootCartesian);for(let i=0,s=this.childEntities.length;i<s;i++)this.childEntities[i]._updateAbsolutePosition();this._updateLonLat()}_setCartesian3vSilent(t,i=!1){this._cartesian.copy(t),this._updateAbsolutePosition();for(let s=0;s<this.childEntities.length;s++)this.childEntities[s].setCartesian(this._cartesian.x,this._cartesian.y,this._cartesian.z);i||this._updateLonLat()}_updateLonLat(){let t=this._entityCollection;t&&t.renderNode&&t.renderNode.ellipsoid&&(this._lonLat=t.renderNode.ellipsoid.cartesianToLonLat(this.getAbsoluteCartesian()),Math.abs(this._lonLat.lat)<ce?this._lonLatMerc=this._lonLat.forwardMercator():this._lonLatMerc.lon=this._lonLatMerc.lat=0)}getLonLat(){return this._lonLat.clone()}setLonLat(t){let i=this._lonLat;i.lon=t.lon,i.lat=t.lat,i.height=t.height;let s=this._entityCollection;if(s&&s.renderNode&&s.renderNode.ellipsoid){Math.abs(i.lat)<ce&&(this._lonLatMerc=i.forwardMercator());let r=new v;s.renderNode.ellipsoid.lonLatToCartesianRes(i,r),this.setAbsoluteCartesian3v(r)}}setLonLat2(t,i,s){let r=this._lonLat;r.lon=t,r.lat=i,r.height=s??r.height;let n=this._entityCollection;if(n&&n.renderNode&&n.renderNode.ellipsoid){Math.abs(r.lat)<ce?this._lonLatMerc=r.forwardMercator():this._lonLatMerc.lon=this._lonLatMerc.lat=this._lonLatMerc.height=0;let a=new v;n.renderNode.ellipsoid.lonLatToCartesianRes(r,a),this.setAbsoluteCartesian3v(a)}}setAltitude(t){this._altitude=t}getAltitude(){return this._altitude}getCartesian(){return this._cartesian.clone()}setBillboard(t){return this.billboard&&this.billboard.remove(),this.billboard=t,this.billboard._entity=this,this.billboard.setPosition3v(this._cartesian),this.billboard.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.billboardHandler.add(t),t}setLabel(t){return this.label&&this.label.remove(),this.label=t,this.label._entity=this,this.label.setPosition3v(this._cartesian),this.label.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.labelHandler.add(t),t}setRay(t){return this.ray&&this.ray.remove(),this.ray=t,this.ray._entity=this,this.ray.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.rayHandler.add(t),t}setPolyline(t){return this.polyline&&this.polyline.remove(),this.polyline=t,this.polyline._entity=this,this.polyline.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.polylineHandler.add(t),t}setPointCloud(t){return this.pointCloud&&this.pointCloud.remove(),this.pointCloud=t,this.pointCloud._entity=this,this.pointCloud.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.pointCloudHandler.add(t),t}setGeometry(t){this.geometry&&this.geometry.remove(),this.geometry=t,this.geometry._entity=this,this.geometry.setVisibility(this._visibility);let i=this._layer;return this._layer&&this._layer.removeEntity(this),i&&i.add(this),t}setGeoObject(t){return this.geoObject&&this.geoObject.remove(),this.geoObject=t,this.geoObject._entity=this,this.geoObject.setPosition3v(this._cartesian),this.geoObject.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.geoObjectHandler.add(t),t}setStrip(t){return this.strip&&this.strip.remove(),this.strip=t,this.strip._entity=this,this.strip.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.stripHandler.add(t),t}get layer(){return this._layer}get rendererEvents(){return this._layer?this._layer.events:this._entityCollection?this._entityCollection.events:null}appendChildren(t,i){for(let s=0;s<t.length;s++)i!==void 0&&(t[s].relativePosition=i),this.appendChild(t[s])}appendChild(t){t._entityCollection=this._entityCollection,t._independentPicking||(t._pickingColor=this._pickingColor),t.parent=this,this.childEntities.push(t),this._entityCollection&&this._entityCollection.appendChildEntity(t)}setPickingColor(){let t=this._pickingColor;this.billboard&&this.billboard.setPickingColor3v(t),this.label&&this.label.setPickingColor3v(t),this.polyline&&this.polyline.setPickingColor3v(t),this.ray&&this.ray.setPickingColor3v(t),this.strip&&this.strip.setPickingColor3v(t),this.geoObject&&this.geoObject.setPickingColor3v(t);for(let i=0;i<this.childEntities.length;i++)this.childEntities[i].setPickingColor()}getExtent(){let t,i=this._lonLat;t=this.billboard||this.label?new j(new L(i.lon,i.lat),new L(i.lon,i.lat)):new j(new L(180,90),new L(-180,-90));let s=t.southWest,r=t.northEast;if(this.polyline){let n=this.polyline.getExtent();n.southWest.lon<s.lon&&(s.lon=n.southWest.lon),n.southWest.lat<s.lat&&(s.lat=n.southWest.lat),n.northEast.lon>r.lon&&(r.lon=n.northEast.lon),n.northEast.lat>r.lat&&(r.lat=n.northEast.lat)}if(this.geometry){let n=this.geometry.getExtent();n.southWest.lon<s.lon&&(s.lon=n.southWest.lon),n.southWest.lat<s.lat&&(s.lat=n.southWest.lat),n.northEast.lon>r.lon&&(r.lon=n.northEast.lon),n.northEast.lat>r.lat&&(r.lat=n.northEast.lat)}for(let n=0;n<this.childEntities.length;n++){let a=this.childEntities[n].getExtent();a.southWest.lon<s.lon&&(s.lon=a.southWest.lon),a.southWest.lat<s.lat&&(s.lat=a.southWest.lat),a.northEast.lon>r.lon&&(r.lon=a.northEast.lon),a.northEast.lat>r.lat&&(r.lat=a.northEast.lat)}return t}};fa.__counter__=0;let U=fa;const pa=class ma{constructor(t){this.__id=ma.__counter__++,this._name=t||`nonameNode:${this.__id}`,this.topNode=this,this._dictionary={},this._dictionary[this._name]=this,this.childNodes=[],this.parentNode=null}get name(){return this._name}addNode(t){this.parentNode==null?t.topNode=this:t.topNode=this.topNode,t.parentNode=this,t._dictionary=this.topNode._dictionary,this.childNodes.push(t),this.topNode._dictionary[t.name]=t}destroy(){for(let t=0;t<this.childNodes.length;t++)this.childNodes[t].destroy();this._clear()}getNodeByName(t){return this._dictionary[t]}_clear(){this.parentNode=null,this.topNode=this,this.childNodes.length=0}isEqual(t){return t.__id===this.__id}};pa.__counter__=0;let ml=pa;class lt extends ml{constructor(t){super(t),this.childNodes=[],this.renderer=null,this.drawMode=0,this.show=!0,this._isActive=!0,this.lightEnabled=!1,this._lightPosition=new Float32Array([100,100,100]),this._lightParams=new Float32Array(9),this._lightShininess=100,this.entityCollections=[],this._entityCollectionsByDepthOrder=[],this._pickingId=-1}getFrameRotation(t){return F.IDENTITY}addNode(t){super.addNode(t),this.renderer&&t.assign(this.renderer)}assign(t){this.renderer=t,this._pickingId=t.addPickingCallback(this,this._entityCollectionPickingCallback),this.initialize()}initialize(){if(this.renderer&&this.renderer.isInitialized()){for(let t=0;t<this.entityCollections.length;t++)this.entityCollections[t].bindRenderNode(this);this.init()}}init(){}onremove(){}remove(){let t=this.renderer,i=this.name;if(t){t.renderNodes[i]&&t.renderNodes[i].isEqual(this)&&(t.renderNodes[i]=null,delete t.renderNodes[i]);for(let s=0;s<t._renderNodesArr.length;s++)if(t._renderNodesArr[s].isEqual(this)){t._renderNodesArr.splice(s,1);break}t.removePickingCallback(this._pickingId),this._pickingId=-1,this.onremove&&this.onremove()}}addEntityCollection(t,i){t.renderNode||(t.renderNode=this,i||(this.entityCollections.push(t),this.updateEntityCollectionsDepthOrder()),this.ellipsoid&&t._updateGeodeticCoordinates(this.ellipsoid),t.bindRenderNode(this),t.events.dispatch(t.events.add,this))}removeEntityCollection(t){for(let i=0;i<this.entityCollections.length;i++)if(this.entityCollections[i].isEqual(t))return this.entityCollections.splice(i,1),void this.updateEntityCollectionsDepthOrder()}updateEntityCollectionsDepthOrder(){let t={0:[]};for(const i of this.entityCollections)i.getVisibility()&&(t[i.depthOrder]||(t[i.depthOrder]=[]),t[i.depthOrder].push(i));this._entityCollectionsByDepthOrder.length=0,this._entityCollectionsByDepthOrder=[],this._entityCollectionsByDepthOrder=Object.keys(t).sort(((i,s)=>Number(i)-Number(s))).map((i=>t[Number(i)]))}addLight(t){return t.addTo(this),this}preDrawNode(){this._isActive&&this._preDrawNodes()}drawNode(){this._isActive&&this._drawNodes()}isActive(){return this._isActive}setActive(t){this._isActive=t,this.renderer&&(this._isActive&&this._pickingId===-1?this._pickingId=this.renderer.addPickingCallback(this,this._entityCollectionPickingCallback):this._isActive||this._pickingId===-1||(this.renderer.removePickingCallback(this._pickingId),this._pickingId=-1));for(let i=0;i<this.childNodes.length;i++)this.childNodes[i].setActive(t)}setDrawMode(t){this.drawMode=t;for(let i=0;i<this.childNodes.length;i++)this.childNodes[i].setDrawMode(t)}updateBillboardsTexCoords(){for(let t=0;t<this.entityCollections.length;t++)this.entityCollections[t].billboardHandler.refreshTexCoordsArr()}updateStrokeTexCoords(){for(let t=0;t<this.entityCollections.length;t++){let i=this.entityCollections[t];i.rayHandler.refreshTexCoordsArr(),i.polylineHandler.refreshTexCoordsArr()}}frame(){}preFrame(){}_preDrawNodes(){for(let t=0;t<this.childNodes.length;t++)this.childNodes[t]._isActive&&this.childNodes[t]._preDrawNodes();if(this.show){this.preFrame();for(let t=0;t<this._entityCollectionsByDepthOrder.length;t++)this.drawEntityCollections(this._entityCollectionsByDepthOrder[t],t)}}_drawNodes(){for(let t=0;t<this.childNodes.length;t++)this.childNodes[t]._isActive&&this.childNodes[t]._drawNodes();this.show&&this.frame()}drawEntityCollections(t,i=0){this.renderer.enqueueEntityCollectionsToDraw(t,i)}drawPickingEntityCollections(t){if(t.length){let i=t.length;for(;i--;)t[i]._fadingOpacity&&t[i].billboardHandler.drawPicking();for(i=t.length;i--;)t[i]._fadingOpacity&&t[i].geoObjectHandler.drawPicking();for(i=t.length;i--;)t[i]._fadingOpacity&&t[i].labelHandler.drawPicking();for(i=t.length;i--;)t[i]._fadingOpacity&&t[i].rayHandler.drawPicking();for(i=t.length;i--;)t[i]._visibility&&t[i].polylineHandler.drawPicking();for(i=t.length;i--;)t[i]._visibility&&t[i].stripHandler.drawPicking()}}_entityCollectionPickingCallback(){}}const Qe=new class{constructor(){this._container=document.createElement("div"),this._container.classList.add("ogConsole"),this._container.style.display="none",document.body&&document.body.appendChild(this._container),this._visibility=!1}getVisibility(){return this._visibility}setVisibility(l){this._visibility!=l&&(this._visibility=l,this._visibility?this.show():this.hide())}show(){this._container.parentNode||document.body&&document.body.appendChild(this._container),this._container.style.display="block",this._visibility=!0}hide(){this._container.style.display="none",this._visibility=!1}logErr(l){let t=document.createElement("div");t.classList.add("ogConsole-text"),t.classList.add("ogConsole-error"),t.innerHTML="error: "+l,console.trace(t.innerHTML),this._container.appendChild(t),this.show()}logWrn(l){let t=document.createElement("div");t.classList.add("ogConsole-text"),t.classList.add("ogConsole-warning"),t.innerHTML="warning: "+l,console.trace(t.innerHTML),this._container.appendChild(t),this.show()}log(l){let t=document.createElement("div");t.classList.add("ogConsole-text"),t.innerHTML=l,console.trace(l),this._container.appendChild(t),this.show()}};let oi=["FLOAT","DOUBLE","BOOL","INT","UINT","VEC2","VEC3","VEC4","DVEC2","DVEC3","DVEC4","BVEC2","BVEC3","BVEC4","IVEC2","IVEC3","IVEC4","UVEC2","UVEC3","UVEC4","MAT2","DMAT2","MAT3","DMAT3","MAT4","DMAT4","MAT2X3","MAT2X4","MAT3X2","MAT3X4","MAT4X2","MAT4X3","DMAT2X3","DMAT2X4","DMAT3X2","DMAT3X4","DMAT4X2","DMAT4X3","SAMPLER1D","SAMPLER2D","SAMPLER3D","SAMPLERCUBE","SAMPLER2DSHADOW","SAMPLER2DARRAY","INTXX","FLOATXX"];const he={};for(let l=0;l<oi.length;l++)he[oi[l]]=l;const Is={};for(let l=0;l<oi.length;l++)Is[oi[l].toLowerCase()]=he[oi[l]];const Ee={u:[],a:[]};Ee.u[he.MAT4]=function(l,t){l.gl.uniformMatrix4fv(t._pName,!1,t.value)},Ee.u[he.MAT3]=function(l,t){l.gl.uniformMatrix3fv(t._pName,!1,t.value)},Ee.u[he.FLOAT]=function(l,t){l.gl.uniform1f(t._pName,t.value)},Ee.u[he.INT]=function(l,t){l.gl.uniform1i(t._pName,t.value)},Ee.u[he.VEC2]=function(l,t){l.gl.uniform2fv(t._pName,t.value)},Ee.u[he.VEC3]=function(l,t){l.gl.uniform3fv(t._pName,t.value)},Ee.u[he.VEC4]=function(l,t){l.gl.uniform4fv(t._pName,t.value)},Ee.u[he.SAMPLER2D]=function(l,t){let i=l.gl;i.activeTexture(i.TEXTURE0+l._textureID),i.bindTexture(i.TEXTURE_2D,t.value),i.uniform1i(t._pName,l._textureID),l._textureID++},Ee.u[he.SAMPLERCUBE]=function(l,t){let i=l.gl;i.activeTexture(i.TEXTURE0+l._textureID),i.bindTexture(i.TEXTURE_CUBE_MAP,t.value),i.uniform1i(t._pName,l._textureID),l._textureID++},Ee.u[he.SAMPLER2DARRAY]=function(l,t){let i=t.value,s=l.gl,r=i.length,n=new Int32Array(r);for(let a=0;a<r;a++)s.activeTexture(s.TEXTURE0+l._textureID+a),s.bindTexture(s.TEXTURE_2D,i[a]),n[a]=a;s.uniform1iv(t._pName,n)},Ee.u[he.INTXX]=function(l,t){l.gl.uniform1iv(t._pName,t.value)},Ee.u[he.FLOATXX]=function(l,t){l.gl.uniform1fv(t._pName,t.value)},Ee.a[he.FLOAT]=function(l,t){l.gl.vertexAttrib1f(t._pName,t.value)},Ee.a[he.VEC2]=function(l,t){l.gl.vertexAttrib2fv(t._pName,t.value)},Ee.a[he.VEC3]=function(l,t){l.gl.vertexAttrib3fv(t._pName,t.value)};const vl=["BYTE","SHORT","UNSIGNED_BYTE","UNSIGNED_SHORT","FLOAT","HALF_FLOAT"];class X{constructor(t,i){this.name=t,this._programController=null,this._attributes={};for(let s in i.attributes)typeof i.attributes[s]=="string"||typeof i.attributes[s]=="number"?this._attributes[s]={type:i.attributes[s]}:this._attributes[s]=i.attributes[s];this._uniforms={};for(let s in i.uniforms)typeof i.uniforms[s]=="string"||typeof i.uniforms[s]=="number"?this._uniforms[s]={type:i.uniforms[s]}:this._uniforms[s]=i.uniforms[s];this.vertexShader=i.vertexShader,this.fragmentShader=i.fragmentShader,this.gl=null,this._variables={},this._p=null,this._textureID=0,this._attribArrays=[],this._attribDivisor=[],this.attributes={},this.uniforms={},this.vertexAttribDivisor=null,this.drawElementsInstanced=null}static bindBuffer(t,i){let s=t.gl;s&&(s.bindBuffer(s.ARRAY_BUFFER,i.value),s.vertexAttribPointer(i._pName,i.value.itemSize,i.itemType,i.normalized,0,0))}use(){this.gl&&this.gl.useProgram(this._p)}set(t){this._textureID=0;for(let i in t)this._variables[i].value=t[i],this._variables[i].func(this,this._variables[i])}apply(){this._textureID=0;let t=this._variables;for(let i in t)t[i].func(this,t[i])}drawIndexBuffer(t,i){let s=this.gl;s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,i),s.drawElements(t,i.numItems,s.UNSIGNED_SHORT,0)}drawArrays(t,i){this.gl.drawArrays(t,0,i)}_getShaderCompileStatus(t,i){if(!this.gl)return!1;const s=this.gl instanceof WebGL2RenderingContext;return this.gl.shaderSource(t,(function(r,n){if(!n)return r;const a=r.split(`
`),o=a.findIndex((h=>h.startsWith("#version")));return o!==-1?(a.splice(o+1,0,"#define WEBGL2"),a.join(`
`)):r})(i,s)),this.gl.compileShader(t),!!this.gl.getShaderParameter(t,this.gl.COMPILE_STATUS)||(Qe.logErr(`Shader program "${this.name}":${this.gl.getShaderInfoLog(t)}.`),!1)}_createVertexShader(t){if(!this.gl)return;let i=this.gl.createShader(this.gl.VERTEX_SHADER);return i&&this._getShaderCompileStatus(i,t)?i:void 0}_createFragmentShader(t){if(!this.gl)return;let i=this.gl.createShader(this.gl.FRAGMENT_SHADER);return i&&this._getShaderCompileStatus(i,t)?i:void 0}disableAttribArrays(){let t=this.gl,i=this._attribArrays;for(let s=0,r=i.length;s<r;s++)t.disableVertexAttribArray(i[s]),this.vertexAttribDivisor(i[s],0)}enableAttribArrays(){let t=this.gl,i=this._attribArrays,s=this._attribDivisor;for(let r=0,n=i.length;r<n;r++)t.enableVertexAttribArray(i[r]),this.vertexAttribDivisor(i[r],s[r])}delete(){this.gl&&this.gl.deleteProgram(this._p)}createProgram(t){if(this.gl=t,this._p=this.gl.createProgram(),!this._p)return;let i=this._createFragmentShader(this.fragmentShader),s=this._createVertexShader(this.vertexShader);if(i&&s){if(t.attachShader(this._p,i),t.attachShader(this._p,s),t.linkProgram(this._p),!this.drawElementsInstanced)if(t.drawElementsInstanced)this.drawElementsInstanced=t.drawElementsInstanced.bind(t);else{let r=t.getExtension("ANGLE_instanced_arrays");r&&(this.drawElementsInstanced=r.drawElementsInstancedANGLE.bind(r))}if(!this.vertexAttribDivisor)if(t.vertexAttribDivisor)this.vertexAttribDivisor=t.vertexAttribDivisor.bind(t);else{let r=t.getExtension("ANGLE_instanced_arrays");r&&(this.vertexAttribDivisor=r.vertexAttribDivisorANGLE.bind(r))}if(!t.getProgramParameter(this._p,t.LINK_STATUS))return Qe.logErr(`Shader program "${this.name}": initialization failed. ${t.getProgramInfoLog(this._p)}.`),void t.deleteProgram(this._p);this.use();for(let r in this._attributes){this._variables[r]=this._attributes[r],this._attributes[r].func=X.bindBuffer;let n=this._attributes[r].itemType,a=n?n.trim().toUpperCase():"FLOAT";if(vl.indexOf(a)==-1?(Qe.logErr(`Shader program "${this.name}": attribute '${r}', item type '${this._attributes[r].itemType}' not exists.`),this._attributes[r].itemType=t.FLOAT):this._attributes[r].itemType=t[a],this._attributes[r].normalized=this._attributes[r].normalized||!1,this._attributes[r].divisor=this._attributes[r].divisor||0,this._p[r]=t.getAttribLocation(this._p,r),this._p[r]==null)return Qe.logErr(`Shader program "${this.name}":  attribute '${r}' not exists.`),void t.deleteProgram(this._p);let o=this._attributes[r].type;typeof o=="string"&&(o=Is[o.trim().toLowerCase()]);let h=this._attributes[r].divisor;if(o===he.MAT4){let c=this._p[r];this._attribArrays.push(c,c+1,c+2,c+3),this._attribDivisor.push(h,h,h,h)}else this._attribArrays.push(this._p[r]),this._attribDivisor.push(h);t.enableVertexAttribArray(this._p[r]),this._attributes[r]._pName=this._p[r],this.attributes[r]=this._p[r]}for(let r in this._uniforms){if(typeof this._uniforms[r].type=="string"){let n=this._uniforms[r].type;this._uniforms[r].func=Ee.u[Is[n.trim().toLowerCase()]]}else this._uniforms[r].func=Ee.u[this._uniforms[r].type];if(this._variables[r]=this._uniforms[r],this._p[r]=t.getUniformLocation(this._p,r),this._p[r]==null)return Qe.logErr(`Shader program "${this.name}": uniform '${r}' not exists.`),void t.deleteProgram(this._p);this._uniforms[r]._pName=this._p[r],this.uniforms[r]=this._p[r]}t.detachShader(this._p,i),t.detachShader(this._p,s),t.deleteShader(i),t.deleteShader(s)}}}const va=class ya{constructor(t){this.__id=ya.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._billboards=[],this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._texCoordBuffer=null,this._vertexBuffer=null,this._pickingColorBuffer=null,this._texCoordArr=new Float32Array([]),this._vertexArr=new Float32Array([]),this._positionHighArr=new Float32Array([]),this._positionLowArr=new Float32Array([]),this._sizeArr=new Float32Array([]),this._offsetArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._rotationArr=new Float32Array([]),this._pickingColorArr=new Float32Array([]),this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this.createPickingColorBuffer,this._buffersUpdateCallbacks[1]=this.createPositionBuffer,this._buffersUpdateCallbacks[2]=this.createSizeBuffer,this._buffersUpdateCallbacks[3]=this.createOffsetBuffer,this._buffersUpdateCallbacks[4]=this.createRgbaBuffer,this._buffersUpdateCallbacks[5]=this.createRotationBuffer,this._buffersUpdateCallbacks[6]=this.createTexCoordBuffer,this._buffersUpdateCallbacks[7]=this.createVertexBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}isEqual(t){return t&&t.__id===this.__id}static concArr(t,i){for(let s=0;s<i.length;s++)t.push(i[s])}initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.billboard||this._renderer.handler.addProgram(new X("billboard",{uniforms:{viewport:"vec2",u_texture:"sampler2d",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",uScaleByDistance:"vec3",opacity:"float",depthOffset:"float"},attributes:{a_vertices:"vec2",a_texCoord:"vec2",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_offset:"vec3",a_size:"vec2",a_rotation:"float",a_rgba:"vec4"},vertexShader:`precision highp float;
#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute vec2 a_vertices;attribute vec2 a_texCoord;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute vec2 a_size;attribute float a_rotation;attribute vec4 a_rgba;varying vec2 v_texCoords;varying vec4 v_rgba;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform vec3 uScaleByDistance;uniform float opacity;uniform float planetRadius;uniform vec2 viewport;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_texCoords=a_texCoord;vec3 look=a_positions-cameraPos;float lookDist=length(look);v_rgba=a_rgba;if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(uScaleByDistance[0],uScaleByDistance[1],lookDist))*(1.0-step(uScaleByDistance[2],lookDist));mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 v=screenPos+rotate2d(a_rotation)*(a_vertices*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:"precision highp float;uniform sampler2D u_texture;varying vec2 v_texCoords;varying vec4 v_rgba;void main(){vec4 color=texture2D(u_texture,v_texCoords);if(color.a<0.1)discard;gl_FragColor=color*v_rgba;}"})),this._renderer.handler.programs.billboardPicking||this._renderer.handler.addProgram(new X("billboardPicking",{uniforms:{viewport:"vec2",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",uScaleByDistance:"vec3",opacity:"float",depthOffset:"float"},attributes:{a_vertices:"vec2",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_offset:"vec3",a_size:"vec2",a_rotation:"float",a_rgba:"vec4"},vertexShader:`precision highp float;
#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute vec2 a_vertices;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute vec2 a_size;attribute float a_rotation;attribute vec4 a_rgba;varying vec3 v_rgb;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform vec3 uScaleByDistance;uniform float opacity;uniform float planetRadius;uniform vec2 viewport;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;vec3 look=a_positions-cameraPos;float lookDist=length(look);v_rgb=a_rgba.rgb;if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(uScaleByDistance[0],uScaleByDistance[1],lookDist))*(1.0-step(uScaleByDistance[2],lookDist));mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 v=screenPos+rotate2d(a_rotation)*(a_vertices*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:"precision highp float;varying vec3 v_rgb;void main(){gl_FragColor=vec4(v_rgb,1.0);}"})))}setRenderer(t){this._renderer=t,this.initProgram()}refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}_removeBillboards(){let t=this._billboards.length;for(;t--;){let i=this._billboards[t];i._handlerIndex=-1,i._handler=null,i._isReady=!1,i._lockId=-1}this._billboards.length=0,this._billboards=[]}clear(){this._texCoordArr=null,this._vertexArr=null,this._positionHighArr=null,this._positionLowArr=null,this._sizeArr=null,this._offsetArr=null,this._rgbaArr=null,this._rotationArr=null,this._pickingColorArr=null,this._texCoordArr=new Float32Array([]),this._vertexArr=new Float32Array([]),this._positionHighArr=new Float32Array([]),this._positionLowArr=new Float32Array([]),this._sizeArr=new Float32Array([]),this._offsetArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._rotationArr=new Float32Array([]),this._pickingColorArr=new Float32Array([]),this._removeBillboards(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){if(this._renderer){let t=this._renderer.handler.gl;t.deleteBuffer(this._positionHighBuffer),t.deleteBuffer(this._positionLowBuffer),t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._offsetBuffer),t.deleteBuffer(this._rgbaBuffer),t.deleteBuffer(this._rotationBuffer),t.deleteBuffer(this._vertexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._pickingColorBuffer)}this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._pickingColorBuffer=null}update(){if(this._renderer){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}}add(t){t._handlerIndex==-1&&(t._isReady=!0,t._handler=this,t._handlerIndex=this._billboards.length,this._billboards.push(t))}_displayPASS(){let t=this._renderer,i=t.handler;i.programs.billboard.activate();let s=i.programs.billboard._program,r=s.attributes,n=s.uniforms,a=i.gl,o=this._entityCollection;a.disable(a.CULL_FACE),a.uniform1f(n.depthOffset,o.polygonOffsetUnits),a.uniform1i(n.u_texture,0),a.uniformMatrix4fv(n.viewMatrix,!1,t.activeCamera.getViewMatrix()),a.uniformMatrix4fv(n.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),a.uniform3fv(n.eyePositionHigh,t.activeCamera.eyeHigh),a.uniform3fv(n.eyePositionLow,t.activeCamera.eyeLow),a.uniform3fv(n.uScaleByDistance,o.scaleByDistance),a.uniform1f(n.opacity,o._fadingOpacity),a.bindBuffer(a.ARRAY_BUFFER,this._texCoordBuffer),a.vertexAttribPointer(r.a_texCoord,this._texCoordBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._vertexBuffer),a.vertexAttribPointer(r.a_vertices,this._vertexBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionHighBuffer),a.vertexAttribPointer(r.a_positionsHigh,this._positionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionLowBuffer),a.vertexAttribPointer(r.a_positionsLow,this._positionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._rgbaBuffer),a.vertexAttribPointer(r.a_rgba,this._rgbaBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._sizeBuffer),a.vertexAttribPointer(r.a_size,this._sizeBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._offsetBuffer),a.vertexAttribPointer(r.a_offset,this._offsetBuffer.itemSize,a.FLOAT,!1,0,0),a.uniform1f(n.planetRadius,o.renderNode._planetRadius2||0),a.uniform2fv(n.viewport,[i.canvas.clientWidth,i.canvas.clientHeight]),a.bindBuffer(a.ARRAY_BUFFER,this._rotationBuffer),a.vertexAttribPointer(r.a_rotation,this._rotationBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,this._vertexBuffer.numItems),a.enable(a.CULL_FACE)}_pickingPASS(){let t=this._renderer,i=t.handler;i.programs.billboardPicking.activate();let s=i.programs.billboardPicking._program,r=s.attributes,n=s.uniforms,a=i.gl,o=this._entityCollection;a.disable(a.CULL_FACE),a.uniform1f(n.depthOffset,o.polygonOffsetUnits),a.uniformMatrix4fv(n.viewMatrix,!1,t.activeCamera.getViewMatrix()),a.uniformMatrix4fv(n.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),a.uniform3fv(n.eyePositionHigh,t.activeCamera.eyeHigh),a.uniform3fv(n.eyePositionLow,t.activeCamera.eyeLow),a.uniform3fv(n.uScaleByDistance,o.scaleByDistance),a.uniform1f(n.opacity,o._fadingOpacity),a.bindBuffer(a.ARRAY_BUFFER,this._vertexBuffer),a.vertexAttribPointer(r.a_vertices,this._vertexBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionHighBuffer),a.vertexAttribPointer(r.a_positionsHigh,this._positionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionLowBuffer),a.vertexAttribPointer(r.a_positionsLow,this._positionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._pickingColorBuffer),a.vertexAttribPointer(r.a_rgba,this._pickingColorBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._sizeBuffer),a.vertexAttribPointer(r.a_size,this._sizeBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._offsetBuffer),a.vertexAttribPointer(r.a_offset,this._offsetBuffer.itemSize,a.FLOAT,!1,0,0),a.uniform1f(n.planetRadius,o.renderNode._planetRadius2||0),a.uniform2fv(n.viewport,[i.canvas.clientWidth,i.canvas.clientHeight]),a.bindBuffer(a.ARRAY_BUFFER,this._rotationBuffer),a.vertexAttribPointer(r.a_rotation,this._rotationBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,this._vertexBuffer.numItems),a.enable(a.CULL_FACE)}draw(){this._billboards.length&&(this.update(),this._displayPASS())}drawPicking(){this._billboards.length&&this.pickingEnabled&&this._pickingPASS()}reindexBillboardsArray(t){let i=this._billboards;for(let s=t;s<i.length;s++)i[s]._handlerIndex=s}_removeBillboard(t){let i=t._handlerIndex;this._billboards.splice(i,1);let s=24*i;this._rgbaArr=ae(this._rgbaArr,s,24),s=18*i,this._positionHighArr=ae(this._positionHighArr,s,18),this._positionLowArr=ae(this._positionLowArr,s,18),this._offsetArr=ae(this._offsetArr,s,18),this._pickingColorArr=ae(this._pickingColorArr,s,18),s=12*i,this._vertexArr=ae(this._vertexArr,s,12),this._sizeArr=ae(this._sizeArr,s,12),this._texCoordArr=ae(this._texCoordArr,s,12),s=6*i,this._rotationArr=ae(this._rotationArr,s,6),this.reindexBillboardsArray(i),this.refresh(),t._handlerIndex=-1,t._handler=null,t._isReady=!1,t._lockId=-1}setAlignedAxisArr(t,i){}remove(t){t._handler&&(t._isReady&&this.__id===t._handler.__id?this._removeBillboard(t):t._handler=null)}setPositionArr(t,i,s){let r=18*t,n=this._positionHighArr,a=i.x,o=i.y,h=i.z;n[r]=a,n[r+1]=o,n[r+2]=h,n[r+3]=a,n[r+4]=o,n[r+5]=h,n[r+6]=a,n[r+7]=o,n[r+8]=h,n[r+9]=a,n[r+10]=o,n[r+11]=h,n[r+12]=a,n[r+13]=o,n[r+14]=h,n[r+15]=a,n[r+16]=o,n[r+17]=h,n=this._positionLowArr,a=s.x,o=s.y,h=s.z,n[r]=a,n[r+1]=o,n[r+2]=h,n[r+3]=a,n[r+4]=o,n[r+5]=h,n[r+6]=a,n[r+7]=o,n[r+8]=h,n[r+9]=a,n[r+10]=o,n[r+11]=h,n[r+12]=a,n[r+13]=o,n[r+14]=h,n[r+15]=a,n[r+16]=o,n[r+17]=h,this._changedBuffers[1]=!0}setPickingColorArr(t,i){let s=18*t,r=this._pickingColorArr,n=i.x/255,a=i.y/255,o=i.z/255;r[s]=n,r[s+1]=a,r[s+2]=o,r[s+3]=n,r[s+4]=a,r[s+5]=o,r[s+6]=n,r[s+7]=a,r[s+8]=o,r[s+9]=n,r[s+10]=a,r[s+11]=o,r[s+12]=n,r[s+13]=a,r[s+14]=o,r[s+15]=n,r[s+16]=a,r[s+17]=o,this._changedBuffers[0]=!0}setSizeArr(t,i,s){let r=12*t,n=this._sizeArr,a=i,o=s;n[r]=a,n[r+1]=o,n[r+2]=a,n[r+3]=o,n[r+4]=a,n[r+5]=o,n[r+6]=a,n[r+7]=o,n[r+8]=a,n[r+9]=o,n[r+10]=a,n[r+11]=o,this._changedBuffers[2]=!0}setOffsetArr(t,i){let s=18*t,r=this._offsetArr,n=i.x,a=i.y,o=i.z;r[s]=n,r[s+1]=a,r[s+2]=o,r[s+3]=n,r[s+4]=a,r[s+5]=o,r[s+6]=n,r[s+7]=a,r[s+8]=o,r[s+9]=n,r[s+10]=a,r[s+11]=o,r[s+12]=n,r[s+13]=a,r[s+14]=o,r[s+15]=n,r[s+16]=a,r[s+17]=o,this._changedBuffers[3]=!0}setRgbaArr(t,i){let s=24*t,r=this._rgbaArr,n=i.x,a=i.y,o=i.z,h=i.w;r[s]=n,r[s+1]=a,r[s+2]=o,r[s+3]=h,r[s+4]=n,r[s+5]=a,r[s+6]=o,r[s+7]=h,r[s+8]=n,r[s+9]=a,r[s+10]=o,r[s+11]=h,r[s+12]=n,r[s+13]=a,r[s+14]=o,r[s+15]=h,r[s+16]=n,r[s+17]=a,r[s+18]=o,r[s+19]=h,r[s+20]=n,r[s+21]=a,r[s+22]=o,r[s+23]=h,this._changedBuffers[4]=!0}setRotationArr(t,i){let s=6*t,r=this._rotationArr;r[s]=i,r[s+1]=i,r[s+2]=i,r[s+3]=i,r[s+4]=i,r[s+5]=i,this._changedBuffers[5]=!0}setTexCoordArr(t,i){let s=12*t,r=this._texCoordArr;r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=i[3],r[s+4]=i[4],r[s+5]=i[5],r[s+6]=i[6],r[s+7]=i[7],r[s+8]=i[8],r[s+9]=i[9],r[s+10]=i[10],r[s+11]=i[11],this._changedBuffers[6]=!0}setVisibility(t,i){let s;s=i?[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(t,s)}setVertexArr(t,i){let s=12*t,r=this._vertexArr;r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=i[3],r[s+4]=i[4],r[s+5]=i[5],r[s+6]=i[6],r[s+7]=i[7],r[s+8]=i[8],r[s+9]=i[9],r[s+10]=i[10],r[s+11]=i[11],this._changedBuffers[7]=!0}createPositionBuffer(){let t=this._renderer.handler,i=this._positionHighArr.length/3;this._positionHighBuffer&&this._positionHighBuffer.numItems===i||(t.gl.deleteBuffer(this._positionHighBuffer),t.gl.deleteBuffer(this._positionLowBuffer),this._positionHighBuffer=t.createStreamArrayBuffer(3,i),this._positionLowBuffer=t.createStreamArrayBuffer(3,i)),t.setStreamArrayBuffer(this._positionHighBuffer,this._positionHighArr),t.setStreamArrayBuffer(this._positionLowBuffer,this._positionLowArr)}createSizeBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=t.createArrayBuffer(this._sizeArr,2,this._sizeArr.length/2)}createOffsetBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._offsetBuffer),this._offsetBuffer=t.createArrayBuffer(this._offsetArr,3,this._offsetArr.length/3)}createRgbaBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._rgbaBuffer),this._rgbaBuffer=t.createArrayBuffer(this._rgbaArr,4,this._rgbaArr.length/4)}createRotationBuffer(){let t=this._renderer.handler;this._rotationBuffer&&this._rotationBuffer.numItems===this._rotationArr.length||(t.gl.deleteBuffer(this._rotationBuffer),this._rotationBuffer=t.createStreamArrayBuffer(1,this._rotationArr.length)),t.setStreamArrayBuffer(this._rotationBuffer,this._rotationArr)}createVertexBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._vertexBuffer),this._vertexBuffer=t.createArrayBuffer(this._vertexArr,2,this._vertexArr.length/2)}createTexCoordBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,2,this._texCoordArr.length/2)}createPickingColorBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorBuffer=t.createArrayBuffer(this._pickingColorArr,3,this._pickingColorArr.length/3)}refreshTexCoordsArr(){}};va.__counter__=0;let xa=va;class yl extends xa{constructor(t){super(t),this._billboards=[]}add(t){if(t._handlerIndex==-1){super.add(t),this._addBillboardToArrays(t),this.refresh();let i=t.getSrc()||t.getImage()&&t.getImage().src;i&&t.setSrc(i)}}_addBillboardToArrays(t){t.getVisibility()?this._vertexArr=ie(this._vertexArr,[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]):this._vertexArr=ie(this._vertexArr,[0,0,0,0,0,0,0,0,0,0,0,0]),this._texCoordArr=ie(this._texCoordArr,[0,0,0,0,0,0,0,0,0,0,0,0]);let i,s=t._positionHigh.x,r=t._positionHigh.y,n=t._positionHigh.z;this._positionHighArr=ie(this._positionHighArr,[s,r,n,s,r,n,s,r,n,s,r,n,s,r,n,s,r,n]),s=t._positionLow.x,r=t._positionLow.y,n=t._positionLow.z,this._positionLowArr=ie(this._positionLowArr,[s,r,n,s,r,n,s,r,n,s,r,n,s,r,n,s,r,n]),s=t._width,r=t._height,this._sizeArr=ie(this._sizeArr,[s,r,s,r,s,r,s,r,s,r,s,r]),s=t._offset.x,r=t._offset.y,n=t._offset.z,this._offsetArr=ie(this._offsetArr,[s,r,n,s,r,n,s,r,n,s,r,n,s,r,n,s,r,n]),s=t._color.x,r=t._color.y,n=t._color.z,i=t._color.w,this._rgbaArr=ie(this._rgbaArr,[s,r,n,i,s,r,n,i,s,r,n,i,s,r,n,i,s,r,n,i,s,r,n,i]),s=t._rotation,this._rotationArr=ie(this._rotationArr,[s,s,s,s,s,s]),s=t._entity._pickingColor.x/255,r=t._entity._pickingColor.y/255,n=t._entity._pickingColor.z/255,this._pickingColorArr=ie(this._pickingColorArr,[s,r,n,s,r,n,s,r,n,s,r,n,s,r,n,s,r,n])}get billboards(){return this._billboards}refreshTexCoordsArr(){if(this._entityCollection&&this._renderer){let t=this._renderer.billboardsTextureAtlas;for(let i=0;i<this._billboards.length;i++){let s=this._billboards[i],r=s.getImage();if(r){let n=t.get(r.__nodeIndex);n&&this.setTexCoordArr(s._handlerIndex,n.texCoords)}}}}}class xl{constructor(t){this.isFree=!0,this._geoObjectHandler=t,this.geoObjects=[],this.numInstances=0,this._colorTexture=null,this._colorTextureSrc=null,this._colorTextureImage=null,this._normalTexture=null,this._normalTextureSrc=null,this._normalTextureImage=null,this._metallicRoughnessTexture=null,this._metallicRoughnessTextureSrc=null,this._metallicRoughnessTextureImage=null,this._sizeArr=[],this._translateArr=[],this._vertexArr=[],this._rtcPositionHighArr=[],this._rtcPositionLowArr=[],this._qRotArr=[],this._rgbaArr=[],this._normalsArr=[],this._indicesArr=[],this._pickingColorArr=[],this._visibleArr=[],this._texCoordArr=[],this._localPositionArr=[],this._sizeBuffer=null,this._translateBuffer=null,this._vertexBuffer=null,this._rtcPositionHighBuffer=null,this._rtcPositionLowBuffer=null,this._qRotBuffer=null,this._rgbaBuffer=null,this._normalsBuffer=null,this._indicesBuffer=null,this._pickingColorBuffer=null,this._visibleBuffer=null,this._texCoordBuffer=null,this._localPositionBuffer=null,this._materialParams=new Float32Array(9),this._materialShininess=0,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[Pa]=this.createPickingColorBuffer,this._buffersUpdateCallbacks[Ca]=this.createNormalsBuffer,this._buffersUpdateCallbacks[Ta]=this.createRgbaBuffer,this._buffersUpdateCallbacks[Aa]=this.createIndicesBuffer,this._buffersUpdateCallbacks[ba]=this.createVertexBuffer,this._buffersUpdateCallbacks[La]=this.createSizeBuffer,this._buffersUpdateCallbacks[Sa]=this.createVisibleBuffer,this._buffersUpdateCallbacks[Ra]=this.createTexCoordBuffer,this._buffersUpdateCallbacks[Ea]=this.createQRotBuffer,this._buffersUpdateCallbacks[Ma]=this.createTranslateBuffer,this._buffersUpdateCallbacks[wa]=this.createRTCPositionBuffer,this._buffersUpdateCallbacks[Ba]=this.createLocalPositionBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}setMaterialAmbient(t,i,s){this._materialParams[0]=t,this._materialParams[1]=i,this._materialParams[2]=s}setMaterialDiffuse(t,i,s){this._materialParams[3]=t,this._materialParams[4]=i,this._materialParams[5]=s}setMaterialSpecular(t,i,s){this._materialParams[6]=t,this._materialParams[7]=i,this._materialParams[8]=s}setMaterialShininess(t){this._materialShininess=t}setMaterialParams(t,i,s,r){this.setMaterialAmbient(t[0],t[1],t[2]),this.setMaterialDiffuse(i[0],i[1],i[2]),this.setMaterialSpecular(s[0],s[1],s[2]),this.setMaterialShininess(r)}drawOpaque(t){let i=t.gl,s=t.uniforms,r=t.attributes;i.bindBuffer(i.ARRAY_BUFFER,this._qRotBuffer),i.vertexAttribPointer(r.qRot,this._qRotBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._sizeBuffer),i.vertexAttribPointer(r.aScale,this._sizeBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._translateBuffer),i.vertexAttribPointer(r.aTranslate,this._translateBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._localPositionBuffer),i.vertexAttribPointer(r.aLocalPosition,this._localPositionBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._visibleBuffer),i.vertexAttribPointer(r.aDispose,this._visibleBuffer.itemSize,i.FLOAT,!1,0,0),i.uniform1f(s.uUseTexture,this._colorTexture?1:0),i.bindBuffer(i.ARRAY_BUFFER,this._rgbaBuffer),i.vertexAttribPointer(r.aColor,this._rgbaBuffer.itemSize,i.FLOAT,!1,0,0),i.uniform3fv(s.materialParams,this._materialParams),i.uniform1f(s.materialShininess,this._materialShininess),this._drawElementsInstanced(t)}drawTransparent(t){let i=t.gl,s=t.uniforms,r=t.attributes;i.bindBuffer(i.ARRAY_BUFFER,this._qRotBuffer),i.vertexAttribPointer(r.qRot,this._qRotBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._sizeBuffer),i.vertexAttribPointer(r.aScale,this._sizeBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._translateBuffer),i.vertexAttribPointer(r.aTranslate,this._translateBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._localPositionBuffer),i.vertexAttribPointer(r.aLocalPosition,this._localPositionBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._visibleBuffer),i.vertexAttribPointer(r.aDispose,this._visibleBuffer.itemSize,i.FLOAT,!1,0,0),i.uniform1f(s.uUseTexture,this._colorTexture?1:0),i.uniform3fv(s.materialParams,this._materialParams),i.uniform1f(s.materialShininess,this._materialShininess),i.bindBuffer(i.ARRAY_BUFFER,this._rgbaBuffer),i.vertexAttribPointer(r.aColor,this._rgbaBuffer.itemSize,i.FLOAT,!1,0,0),this._drawElementsInstanced(t)}_drawElementsInstanced(t){let i=t.gl,s=t.uniforms,r=t.attributes,n=this._geoObjectHandler._renderer;i.bindBuffer(i.ARRAY_BUFFER,this._rtcPositionHighBuffer),i.vertexAttribPointer(r.aRTCPositionHigh,this._rtcPositionHighBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._rtcPositionLowBuffer),i.vertexAttribPointer(r.aRTCPositionLow,this._rtcPositionLowBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._normalsBuffer),i.vertexAttribPointer(r.aVertexNormal,this._normalsBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this._vertexBuffer),i.vertexAttribPointer(r.aVertexPosition,this._vertexBuffer.itemSize,i.FLOAT,!1,0,0),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this._colorTexture||n.handler.defaultTexture),i.uniform1i(s.uTexture,0),i.bindBuffer(i.ARRAY_BUFFER,this._texCoordBuffer),i.vertexAttribPointer(r.aTexCoord,this._texCoordBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this._indicesBuffer),t.drawElementsInstanced(i.TRIANGLES,this._indicesBuffer.numItems,i.UNSIGNED_INT,0,this.numInstances)}async loadColorTexture(){if(this._geoObjectHandler._renderer){if(!this._colorTextureSrc)return this._colorTextureImage?(await this._colorTextureImage.decode(),void this._createColorTexture(this._colorTextureImage)):void 0;{const t=await Ri(this._colorTextureSrc);this._createColorTexture(t)}}}async loadNormalTexture(){if(this._geoObjectHandler._renderer){if(!this._normalTextureSrc)return this._normalTextureImage?(await this._normalTextureImage.decode(),void this._createNormalTexture(this._normalTextureImage)):void 0;{const t=await Ri(this._normalTextureSrc);this._createNormalTexture(t)}}}async loadMetallicRoughnessTexture(){if(this._geoObjectHandler._renderer){if(!this._metallicRoughnessTextureSrc)return this._metallicRoughnessTextureImage?(await this._metallicRoughnessTextureImage.decode(),void this._createMetallicRoughnessTexture(this._metallicRoughnessTextureImage)):void 0;{const t=await Ri(this._metallicRoughnessTextureSrc);this._createMetallicRoughnessTexture(t)}}}clear(){this.numInstances=0,this.geoObjects=[],this._sizeArr=[],this._translateArr=[],this._vertexArr=[],this._rtcPositionHighArr=[],this._rtcPositionLowArr=[],this._qRotArr=[],this._rgbaArr=[],this._normalsArr=[],this._indicesArr=[],this._pickingColorArr=[],this._visibleArr=[],this._texCoordArr=[],this._localPositionArr=[],this._deleteBuffers(),this.isFree=!1}_deleteBuffers(){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let t=this._geoObjectHandler._renderer.handler;if(t){t.deleteTexture(this._colorTexture),t.deleteTexture(this._normalTexture),t.deleteTexture(this._metallicRoughnessTexture);let i=t.gl;i&&(i.deleteBuffer(this._sizeBuffer),i.deleteBuffer(this._translateBuffer),i.deleteBuffer(this._vertexBuffer),i.deleteBuffer(this._rtcPositionHighBuffer),i.deleteBuffer(this._rtcPositionLowBuffer),i.deleteBuffer(this._qRotBuffer),i.deleteBuffer(this._rgbaBuffer),i.deleteBuffer(this._normalsBuffer),i.deleteBuffer(this._indicesBuffer),i.deleteBuffer(this._pickingColorBuffer),i.deleteBuffer(this._visibleBuffer),i.deleteBuffer(this._texCoordBuffer),i.deleteBuffer(this._localPositionBuffer))}this._colorTexture=null,this._normalTexture=null,this._metallicRoughnessTexture=null}this._sizeBuffer=null,this._translateBuffer=null,this._vertexBuffer=null,this._rtcPositionHighBuffer=null,this._rtcPositionLowBuffer=null,this._qRotBuffer=null,this._rgbaBuffer=null,this._normalsBuffer=null,this._indicesBuffer=null,this._pickingColorBuffer=null,this._visibleBuffer=null,this._texCoordBuffer=null,this._localPositionBuffer=null}createVertexBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._vertexBuffer),this._vertexArr=se(this._vertexArr),this._vertexBuffer=t.createArrayBuffer(this._vertexArr,3,this._vertexArr.length/3)}createVisibleBuffer(){const t=this._geoObjectHandler._renderer.handler,i=this._visibleArr.length;this._visibleBuffer&&this._visibleBuffer.numItems===i||(t.gl.deleteBuffer(this._visibleBuffer),this._visibleBuffer=t.createStreamArrayBuffer(1,i)),this._visibleArr=se(this._visibleArr),t.setStreamArrayBuffer(this._visibleBuffer,this._visibleArr)}createSizeBuffer(){let t=this._geoObjectHandler._renderer.handler,i=this._sizeArr.length/3;this._sizeBuffer&&this._sizeBuffer.numItems===i||(t.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=t.createStreamArrayBuffer(3,i)),this._sizeArr=se(this._sizeArr),t.setStreamArrayBuffer(this._sizeBuffer,this._sizeArr)}createTranslateBuffer(){let t=this._geoObjectHandler._renderer.handler,i=this._translateArr.length/3;this._translateBuffer&&this._translateBuffer.numItems===i||(t.gl.deleteBuffer(this._translateBuffer),this._translateBuffer=t.createStreamArrayBuffer(3,i)),this._translateArr=se(this._translateArr),t.setStreamArrayBuffer(this._translateBuffer,this._translateArr)}createLocalPositionBuffer(){let t=this._geoObjectHandler._renderer.handler,i=this._localPositionArr.length/3;this._localPositionBuffer&&this._localPositionBuffer.numItems===i||(t.gl.deleteBuffer(this._localPositionBuffer),this._localPositionBuffer=t.createStreamArrayBuffer(3,i)),this._localPositionArr=se(this._localPositionArr),t.setStreamArrayBuffer(this._localPositionBuffer,this._localPositionArr)}createTexCoordBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordArr=se(this._texCoordArr),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,2,this._texCoordArr.length/2)}createRTCPositionBuffer(){let t=this._geoObjectHandler._renderer.handler,i=this._rtcPositionHighArr.length/3;this._rtcPositionHighBuffer&&this._rtcPositionHighBuffer.numItems===i||(t.gl.deleteBuffer(this._rtcPositionHighBuffer),t.gl.deleteBuffer(this._rtcPositionLowBuffer),this._rtcPositionHighBuffer=t.createStreamArrayBuffer(3,i),this._rtcPositionLowBuffer=t.createStreamArrayBuffer(3,i)),this._rtcPositionHighArr=se(this._rtcPositionHighArr),this._rtcPositionLowArr=se(this._rtcPositionLowArr),t.setStreamArrayBuffer(this._rtcPositionHighBuffer,this._rtcPositionHighArr),t.setStreamArrayBuffer(this._rtcPositionLowBuffer,this._rtcPositionLowArr)}createRgbaBuffer(){let t=this._geoObjectHandler._renderer.handler,i=this._rgbaArr.length/4;this._rgbaBuffer&&this._rgbaBuffer.numItems===i||(t.gl.deleteBuffer(this._rgbaBuffer),this._rgbaBuffer=t.createStreamArrayBuffer(4,i)),this._rgbaArr=se(this._rgbaArr),t.setStreamArrayBuffer(this._rgbaBuffer,this._rgbaArr)}createQRotBuffer(){let t=this._geoObjectHandler._renderer.handler,i=this._qRotArr.length/4;this._qRotBuffer&&this._qRotBuffer.numItems===i||(t.gl.deleteBuffer(this._qRotBuffer),this._qRotBuffer=t.createStreamArrayBuffer(4,i)),this._qRotArr=se(this._qRotArr),t.setStreamArrayBuffer(this._qRotBuffer,this._qRotArr)}createNormalsBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._normalsBuffer),this._normalsArr=se(this._normalsArr),this._normalsBuffer=t.createArrayBuffer(this._normalsArr,3,this._normalsArr.length/3)}createIndicesBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._indicesBuffer),this._indicesArr=se(this._indicesArr,Uint32Array),this._indicesBuffer=t.createElementArrayBuffer(this._indicesArr,1,this._indicesArr.length)}createPickingColorBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorArr=se(this._pickingColorArr),this._pickingColorBuffer=t.createArrayBuffer(this._pickingColorArr,3,this._pickingColorArr.length/3)}refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}update(){if(this._geoObjectHandler._renderer){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1);this.isFree=!0}}_createColorTexture(t){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let i=this._geoObjectHandler._renderer.handler;this._colorTexture=i.createTextureDefault(t,null,i.gl.REPEAT)}}_createNormalTexture(t){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let i=this._geoObjectHandler._renderer.handler;this._normalTexture=i.createTextureDefault(t,null,i.gl.REPEAT)}}_createMetallicRoughnessTexture(t){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let i=this._geoObjectHandler._renderer.handler;this._metallicRoughnessTexture=i.createTextureDefault(t,null,i.gl.REPEAT)}}}const ba=0,wa=1,Ta=2,Ca=3,Aa=4,Ea=5,La=6,Pa=7,Sa=8,Ra=9,Ma=10,Ba=11;function we(l,t=0,i=0,s=1,...r){const n=t*i;for(let a=n,o=n+i;a<o;a++)l[a]=r[a%s];return l}const ka=class Ia{constructor(t){this.__id=Ia.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderNode=null,this._renderer=null,this._geoObjects=[],this._instanceDataMap=new Map,this._instanceDataMapValues=[],this._dataTagUpdateQueue=[],this._relativeCenter=new v,this._rtcEyePositionHigh=new Float32Array([0,0,0]),this._rtcEyePositionLow=new Float32Array([0,0,0])}initProgram(){this._renderer&&(this._renderer.handler.programs.geo_object||this._renderer.handler.addProgram(new X("geo_object",{uniforms:{viewMatrix:"mat4",projectionMatrix:"mat4",uScaleByDistance:"vec3",eyePositionHigh:"vec3",eyePositionLow:"vec3",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",sunPosition:"vec3",materialParams:"vec3",materialShininess:"float",uTexture:"sampler2d",uUseTexture:"float",useLighting:"float"},attributes:{aVertexPosition:"vec3",aVertexNormal:"vec3",aTexCoord:"vec2",aLocalPosition:{type:"vec3",divisor:1},aRTCPositionHigh:{type:"vec3",divisor:1},aRTCPositionLow:{type:"vec3",divisor:1},aColor:{type:"vec4",divisor:1},aScale:{type:"vec3",divisor:1},aTranslate:{type:"vec3",divisor:1},aDispose:{type:"float",divisor:1},qRot:{type:"vec4",divisor:1}},vertexShader:"precision highp float;vec3 qRotate(vec4 q,vec3 v){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}attribute vec3 aVertexPosition;attribute vec3 aVertexNormal;attribute vec3 aRTCPositionHigh;attribute vec3 aRTCPositionLow;attribute vec4 aColor;attribute vec3 aScale;attribute vec3 aTranslate;attribute float aDispose;attribute float aUseTexture;attribute vec2 aTexCoord;attribute vec4 qRot;attribute vec3 aLocalPosition;uniform vec3 uScaleByDistance;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;varying vec3 cameraPosition;varying vec3 vNormal;varying vec3 v_vertex;varying vec4 vColor;varying float vDispose;varying vec2 vTexCoords;void main(void){if(aDispose==0.0){return;}vColor=aColor;vTexCoords=aTexCoord;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=aRTCPositionHigh-rtcEyePositionHigh;vec3 lowDiff=aRTCPositionLow-rtcEyePositionLow;cameraPosition=eyePositionHigh+eyePositionLow;highDiff=highDiff*step(1.0,length(highDiff));vec4 positionInViewSpace=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);float lookLength=length(positionInViewSpace.xyz);vNormal=normalize(qRotate(qRot,aVertexNormal));float scd=uScaleByDistance[2]*clamp(lookLength,uScaleByDistance[0],uScaleByDistance[1])/uScaleByDistance[0];vec3 vert=qRotate(qRot,scd*(aVertexPosition*aScale+aTranslate))+scd*aLocalPosition;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff+lowDiff+vert,1.0);v_vertex=positionInViewSpace.xyz+vert;}",fragmentShader:"precision highp float;uniform vec3 sunPosition;uniform vec3 materialParams[3];uniform float materialShininess;uniform sampler2D uTexture;uniform float uUseTexture;uniform float useLighting;varying vec3 cameraPosition;varying vec3 v_vertex;varying vec4 vColor;varying vec3 vNormal;varying vec2 vTexCoords;void main(void){vec3 lightWeighting=vec3(1.0);if(useLighting!=0.0){vec3 normal=normalize(vNormal);vec3 light_dir=normalize(sunPosition);vec3 look_dir=normalize(cameraPosition-v_vertex);float diffuse=max(dot(normal,light_dir),0.0);vec3 refl_dir=reflect(-light_dir,normal);float refl=max(dot(refl_dir,look_dir),0.0);float specular=pow(refl,materialShininess)*step(1e-4,diffuse);lightWeighting=vColor.rgb*materialParams[0]+materialParams[1]*diffuse+materialParams[2]*specular;}else{lightWeighting=vColor.rgb;}if(uUseTexture>0.0){vec4 texColor=texture2D(uTexture,vTexCoords);gl_FragColor=vec4(texColor.rgb*lightWeighting,texColor.a);}else{gl_FragColor=vec4(lightWeighting,vColor.a);}}"})),this._renderer.handler.programs.geo_object_picking||this._renderer.handler.addProgram(new X("geo_object_picking",{uniforms:{viewMatrix:"mat4",projectionMatrix:"mat4",uScaleByDistance:"vec3",pickingScale:"vec3",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3"},attributes:{aVertexPosition:"vec3",aRTCPositionHigh:{type:"vec3",divisor:1},aRTCPositionLow:{type:"vec3",divisor:1},aPickingColor:{type:"vec3",divisor:1},aScale:{type:"vec3",divisor:1},aTranslate:{type:"vec3",divisor:1},aLocalPosition:{type:"vec3",divisor:1},aDispose:{type:"float",divisor:1},qRot:{type:"vec4",divisor:1}},vertexShader:"precision highp float;vec3 qRotate(vec4 q,vec3 v){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}attribute vec3 aVertexPosition;attribute vec3 aRTCPositionHigh;attribute vec3 aRTCPositionLow;attribute vec3 aPickingColor;attribute vec3 aScale;attribute vec3 aTranslate;attribute float aDispose;attribute vec4 qRot;attribute vec3 aLocalPosition;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform vec3 uScaleByDistance;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 pickingScale;varying vec3 vColor;void main(void){if(aDispose==0.0){return;}vColor=aPickingColor;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=aRTCPositionHigh-rtcEyePositionHigh;vec3 lowDiff=aRTCPositionLow-rtcEyePositionLow;highDiff=highDiff*step(1.0,length(highDiff));vec4 positionInViewSpace=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);float lookLength=length(positionInViewSpace.xyz);float scd=uScaleByDistance[2]*clamp(lookLength,uScaleByDistance[0],uScaleByDistance[1])/uScaleByDistance[0];vec3 vert=qRotate(qRot,scd*pickingScale*(aVertexPosition*aScale+aTranslate))+scd*aLocalPosition;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff+lowDiff+vert,1.0);}",fragmentShader:"precision highp float;varying vec3 vColor;void main(){gl_FragColor=vec4(vColor,1.0);}"})),this._renderer.handler.programs.geo_object_depth||this._renderer.handler.addProgram(new X("geo_object_depth",{uniforms:{viewMatrix:"mat4",projectionMatrix:"mat4",uScaleByDistance:"vec3",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",frustumPickingColor:"float"},attributes:{aVertexPosition:"vec3",aRTCPositionHigh:{type:"vec3",divisor:1},aRTCPositionLow:{type:"vec3",divisor:1},aScale:{type:"vec3",divisor:1},aTranslate:{type:"vec3",divisor:1},aDispose:{type:"float",divisor:1},qRot:{type:"vec4",divisor:1},aLocalPosition:{type:"vec3",divisor:1}},vertexShader:`#version 300 es
precision highp float;vec3 qRotate(vec4 q,vec3 v){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}in vec3 aVertexPosition;in vec3 aRTCPositionHigh;in vec3 aRTCPositionLow;in vec3 aScale;in vec3 aTranslate;in float aDispose;in vec4 qRot;in vec3 aLocalPosition;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform vec3 uScaleByDistance;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;void main(void){if(aDispose==0.0){return;}mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=aRTCPositionHigh-rtcEyePositionHigh;vec3 lowDiff=aRTCPositionLow-rtcEyePositionLow;highDiff=highDiff*step(1.0,length(highDiff));vec4 positionInViewSpace=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);float lookLength=length(positionInViewSpace.xyz);float scd=uScaleByDistance[2]*clamp(lookLength,uScaleByDistance[0],uScaleByDistance[1])/uScaleByDistance[0];vec3 vert=qRotate(qRot,scd*(aVertexPosition*aScale+aTranslate))+scd*aLocalPosition;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff+lowDiff+vert,1.0);}`,fragmentShader:`#version 300 es
precision highp float;uniform float frustumPickingColor;layout(location=0)out vec4 frustumColor;layout(location=1)out vec4 depthColor;void main(){frustumColor=vec4(frustumPickingColor,frustumPickingColor,frustumPickingColor,1.0);depthColor=vec4(gl_FragCoord.z,gl_FragCoord.z,gl_FragCoord.z,1.0);}`})))}setRenderNode(t){this._renderNode=t,this._renderer=t.renderer,this.initProgram();for(let i=0;i<this._instanceDataMapValues.length;i++)this._instanceDataMapValues[i].loadColorTexture(),this._instanceDataMapValues[i].loadNormalTexture(),this._instanceDataMapValues[i].loadMetallicRoughnessTexture();for(let i=0;i<this._geoObjects.length;i++)this._geoObjects[i].updateRotation();this.update()}setColorTextureTag(t,i){const s=this._instanceDataMap.get(i);s&&(typeof t=="string"&&(s._colorTextureSrc=t,s._colorTextureImage=null),t instanceof HTMLImageElement&&(s._colorTextureSrc=null,s._colorTextureImage=t),this._instanceDataMap.set(i,s),s.loadColorTexture())}setNormalTextureTag(t,i){const s=this._instanceDataMap.get(i);s&&(typeof t=="string"&&(s._normalTextureSrc=t,s._normalTextureImage=null),t instanceof HTMLImageElement&&(s._normalTextureSrc=null,s._normalTextureImage=t),this._instanceDataMap.set(i,s),s.loadNormalTexture())}setMetallicRoughnessTextureTag(t,i){const s=this._instanceDataMap.get(i);s&&(typeof t=="string"&&(s._metallicRoughnessTextureSrc=t,s._metallicRoughnessTextureImage=null),t instanceof HTMLImageElement&&(s._metallicRoughnessTextureSrc=null,s._metallicRoughnessTextureImage=t),this._instanceDataMap.set(i,s),s.loadMetallicRoughnessTexture())}setObjectSrc(t,i){const s=this._instanceDataMap.get(i);t&&s&&s._objectSrc!==t&&(s._objectSrc=t,$.loadObj(t).then((r=>{this._updateInstanceData(r[0],i)})))}_updateInstanceData(t,i){const s=this._instanceDataMap.get(i);s&&(t.vertices.length!==s._vertexArr.length&&(s._vertexArr=t.vertices,s._changedBuffers[ba]=!0),t.normals.length!==s._normalsArr.length&&(s._normalsArr=t.normals,s._changedBuffers[Ca]=!0),t.indices.length!==s._indicesArr.length&&(s._indicesArr=t.indices,s._changedBuffers[Aa]=!0),t.texCoords.length!==s._texCoordArr.length&&(s._texCoordArr=t.texCoords,s._changedBuffers[Ra]=!0),s._colorTextureSrc=t.colorTextureSrc,s._normalTextureSrc=t.normalTextureSrc,s._metallicRoughnessTexture=t.metallicRoughnessTextureSrc,s._colorTextureImage=t.colorTextureImage,s._normalTextureImage=t.normalTextureImage,s._metallicRoughnessTextureImage=t.metallicRoughnessTextureImage,s.loadColorTexture(),s.loadNormalTexture(),s.loadMetallicRoughnessTexture(),this._updateTag(s),this._instanceDataMapValues=Array.from(this._instanceDataMap.values()))}_addGeoObjectToArray(t){const i=t.tag;let s=this._instanceDataMap.get(i);s||(s=new xl(this),this._instanceDataMap.set(i,s),this._instanceDataMapValues=Array.from(this._instanceDataMap.values()),s._vertexArr=t.vertices,s._normalsArr=t.normals,s._indicesArr=t.indices,s._texCoordArr=t.texCoords,s._colorTextureSrc=t.object3d.colorTextureSrc,s._normalTextureSrc=t.object3d.normalTextureSrc,s._metallicRoughnessTextureSrc=t.object3d.metallicRoughnessTextureSrc,s._colorTextureImage=t.object3d.colorTextureImage,s._normalTextureImage=t.object3d.normalTextureImage,s._metallicRoughnessTextureImage=t.object3d.metallicRoughnessTextureImage,s.setMaterialParams(t.object3d.ambient,t.object3d.diffuse,t.object3d.specular,t.object3d.shininess),s.loadColorTexture(),s.loadNormalTexture(),s.loadMetallicRoughnessTexture()),t._tagDataIndex=s.numInstances++,t._tagData=s,s.geoObjects.push(t);let r=3;s._visibleArr=ye(s._visibleArr,we([],0,1,1,t.getVisibility()?1:0)),this.getRTCPosition(t.getPosition(),t._rtcPositionHigh,t._rtcPositionLow);let n,a=t._rtcPositionHigh.x,o=t._rtcPositionHigh.y,h=t._rtcPositionHigh.z;s._rtcPositionHighArr=ye(s._rtcPositionHighArr,we([],0,r,r,a,o,h)),a=t._rtcPositionLow.x,o=t._rtcPositionLow.y,h=t._rtcPositionLow.z,s._rtcPositionLowArr=ye(s._rtcPositionLowArr,we([],0,r,r,a,o,h)),a=t._entity._pickingColor.x/255,o=t._entity._pickingColor.y/255,h=t._entity._pickingColor.z/255,s._pickingColorArr=ye(s._pickingColorArr,we([],0,r,r,a,o,h)),r=4,a=t._qRot.x,o=t._qRot.y,h=t._qRot.z,n=t._qRot.w,s._qRotArr=ye(s._qRotArr,we([],0,r,r,a,o,h,n)),a=t._color.x,o=t._color.y,h=t._color.z,n=t._color.w,s._rgbaArr=ye(s._rgbaArr,we([],0,r,r,a,o,h,n)),r=3;let c=t.getScale();a=c.x,o=c.y,h=c.z,s._sizeArr=ye(s._sizeArr,we([],0,r,r,a,o,h));let d=t.getTranslate();a=d.x,o=d.y,h=d.z,s._translateArr=ye(s._translateArr,we([],0,r,r,a,o,h));let u=t.getLocalPosition();a=u.x,o=u.y,h=u.z,s._localPositionArr=ye(s._localPositionArr,we([],0,r,r,a,o,h))}_bindCommon(){let t=this._renderer,i=t.handler.programs.geo_object._program.uniforms,s=t.handler.gl,r=this._entityCollection;s.uniform3fv(i.uScaleByDistance,r.scaleByDistance),s.uniform1f(i.useLighting,r._useLighting),s.uniform3fv(i.eyePositionHigh,t.activeCamera.eyeHigh),s.uniform3fv(i.eyePositionLow,t.activeCamera.eyeLow),s.uniform3fv(i.rtcEyePositionHigh,this._rtcEyePositionHigh),s.uniform3fv(i.rtcEyePositionLow,this._rtcEyePositionLow),s.uniformMatrix4fv(i.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),s.uniformMatrix4fv(i.viewMatrix,!1,t.activeCamera.getViewMatrix()),s.uniform3fv(i.sunPosition,this._renderNode._lightPosition)}_displayOpaquePASS(){let t=this._renderer.handler.programs.geo_object,i=t._program;t.activate(),this._bindCommon();for(let s=0;s<this._instanceDataMapValues.length;s++)this._instanceDataMapValues[s].drawOpaque(i)}_displayTransparentPASS(){let t=this._renderer.handler.programs.geo_object,i=t._program;t.activate(),this._bindCommon();for(let s=0;s<this._instanceDataMapValues.length;s++)this._instanceDataMapValues[s].drawTransparent(i)}_depthPASS(){let t=this._renderer,i=t.handler.programs.geo_object_depth,s=i._program,r=s.uniforms,n=s.attributes,a=t.handler.gl,o=this._entityCollection,h=t.activeCamera;i.activate(),a.uniform3fv(r.uScaleByDistance,o.scaleByDistance),a.uniform3fv(r.rtcEyePositionHigh,this._rtcEyePositionHigh),a.uniform3fv(r.rtcEyePositionLow,this._rtcEyePositionLow),a.uniformMatrix4fv(r.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),a.uniformMatrix4fv(r.viewMatrix,!1,t.activeCamera.getViewMatrix()),a.uniform1f(r.frustumPickingColor,h.frustumColorIndex);for(let c=0;c<this._instanceDataMapValues.length;c++){let d=this._instanceDataMapValues[c];a.bindBuffer(a.ARRAY_BUFFER,d._qRotBuffer),a.vertexAttribPointer(n.qRot,d._qRotBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._sizeBuffer),a.vertexAttribPointer(n.aScale,d._sizeBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._translateBuffer),a.vertexAttribPointer(n.aTranslate,d._translateBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._localPositionBuffer),a.vertexAttribPointer(n.aLocalPosition,d._localPositionBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._rtcPositionHighBuffer),a.vertexAttribPointer(n.aRTCPositionHigh,d._rtcPositionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._rtcPositionLowBuffer),a.vertexAttribPointer(n.aRTCPositionLow,d._rtcPositionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._visibleBuffer),a.vertexAttribPointer(n.aDispose,d._visibleBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._vertexBuffer),a.vertexAttribPointer(n.aVertexPosition,d._vertexBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,d._indicesBuffer),s.drawElementsInstanced(a.TRIANGLES,d._indicesBuffer.numItems,a.UNSIGNED_INT,0,d.numInstances)}}drawDepth(){this._geoObjects.length&&this._depthPASS()}drawPicking(){this._geoObjects.length&&this.pickingEnabled&&this._pickingPASS()}_pickingPASS(){let t=this._renderer,i=t.handler.programs.geo_object_picking,s=i._program,r=s.uniforms,n=s.attributes,a=t.handler.gl,o=this._entityCollection;i.activate(),a.uniform3fv(r.uScaleByDistance,o.scaleByDistance),a.uniform3fv(r.pickingScale,o.pickingScale),a.uniform3fv(r.rtcEyePositionHigh,this._rtcEyePositionHigh),a.uniform3fv(r.rtcEyePositionLow,this._rtcEyePositionLow),a.uniformMatrix4fv(r.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),a.uniformMatrix4fv(r.viewMatrix,!1,t.activeCamera.getViewMatrix());for(let h=0;h<this._instanceDataMapValues.length;h++){let c=this._instanceDataMapValues[h];a.bindBuffer(a.ARRAY_BUFFER,c._qRotBuffer),a.vertexAttribPointer(n.qRot,c._qRotBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,c._sizeBuffer),a.vertexAttribPointer(n.aScale,c._sizeBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,c._translateBuffer),a.vertexAttribPointer(n.aTranslate,c._translateBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,c._localPositionBuffer),a.vertexAttribPointer(n.aLocalPosition,c._localPositionBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,c._pickingColorBuffer),a.vertexAttribPointer(n.aPickingColor,c._pickingColorBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,c._rtcPositionHighBuffer),a.vertexAttribPointer(n.aRTCPositionHigh,c._rtcPositionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,c._rtcPositionLowBuffer),a.vertexAttribPointer(n.aRTCPositionLow,c._rtcPositionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,c._visibleBuffer),a.vertexAttribPointer(n.aDispose,c._visibleBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,c._vertexBuffer),a.vertexAttribPointer(n.aVertexPosition,c._vertexBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c._indicesBuffer),s.drawElementsInstanced(a.TRIANGLES,c._indicesBuffer.numItems,a.UNSIGNED_INT,0,c.numInstances)}}setQRotArr(t,i,s){we(t._qRotArr,i,4,4,s.x,s.y,s.z,s.w),t._changedBuffers[Ea]=!0,this._updateTag(t)}setVisibility(t,i,s){we(t._visibleArr,i,1,1,s?1:0),t._changedBuffers[Sa]=!0,this._updateTag(t)}setRTCPositionArr(t,i,s,r){we(t._rtcPositionHighArr,i,3,3,s.x,s.y,s.z),we(t._rtcPositionLowArr,i,3,3,r.x,r.y,r.z),t._changedBuffers[wa]=!0,this._updateTag(t)}setRgbaArr(t,i,s){we(t._rgbaArr,i,4,4,s.x,s.y,s.z,s.w),t._changedBuffers[Ta]=!0,this._updateTag(t)}setPickingColorArr(t,i,s){we(t._pickingColorArr,i,3,3,s.x/255,s.y/255,s.z/255),t._changedBuffers[Pa]=!0,this._updateTag(t)}setScaleArr(t,i,s){we(t._sizeArr,i,3,3,s.x,s.y,s.z),t._changedBuffers[La]=!0,this._updateTag(t)}setTranslateArr(t,i,s){we(t._translateArr,i,3,3,s.x,s.y,s.z),t._changedBuffers[Ma]=!0,this._updateTag(t)}setLocalPositionArr(t,i,s){we(t._localPositionArr,i,3,3,s.x,s.y,s.z),t._changedBuffers[Ba]=!0,this._updateTag(t)}_updateTag(t){t.isFree&&(t.isFree=!1,this._dataTagUpdateQueue.push(t))}update(){for(let t=0,i=this._dataTagUpdateQueue.length;t<i;t++)this._dataTagUpdateQueue[t].update();this._dataTagUpdateQueue=[]}_removeAll(){let t=this._geoObjects.length;for(;t--;){const i=this._geoObjects[t];i._tagDataIndex=-1,i._tagData=null,i._handlerIndex=-1,i._handler=null}this._geoObjects.length=0,this._geoObjects=[];for(let i=0;i<this._instanceDataMapValues.length;i++)this._instanceDataMapValues[i].clear();this._instanceDataMap.clear(),this._instanceDataMapValues=[]}clear(){this._removeAll()}getRTCPosition(t,i,s){let r=t.sub(this._relativeCenter);v.doubleToTwoFloats(r,i,s)}setRelativeCenter(t){this._relativeCenter.copy(t);for(let i=0;i<this._instanceDataMapValues.length;i++){let s=this._instanceDataMapValues[i].geoObjects;for(let r=0;r<s.length;r++)s[r].updateRTCPosition()}}_updateRTCEyePosition(){let t=this._renderer;if(t.activeCamera.isFirstPass){let i=t.activeCamera.eye.sub(this._relativeCenter);v.doubleToTwoFloat32Array(i,this._rtcEyePositionHigh,this._rtcEyePositionLow)}}draw(){this._geoObjects.length&&(this._updateRTCEyePosition(),this.update(),this._displayOpaquePASS())}drawTransparent(){this._geoObjects.length&&this._displayTransparentPASS()}add(t){t._handlerIndex===-1&&(t._handler=this,t._handlerIndex=this._geoObjects.length,this._geoObjects.push(t),this._addGeoObjectToArray(t),t.updateRotation(),t._tagData.refresh(),this._updateTag(t._tagData),t.setObjectSrc(t._objectSrc))}remove(t){t._handler&&this.__id==t._handler.__id&&this._removeGeoObject(t)}_clearDataTagQueue(){this._dataTagUpdateQueue=[]}_removeGeoObject(t){let i=t._tagData,s=t.tag;i.numInstances--;let r=!1;if(i.numInstances===0){i.clear(),this._instanceDataMap.delete(s);for(let a=0;this._instanceDataMapValues.length;a++)if(this._instanceDataMapValues[a].numInstances===0){this._instanceDataMapValues.splice(a,1);break}this._clearDataTagQueue(),r=!0}this._geoObjects.splice(t._handlerIndex,1);for(let a=t._handlerIndex,o=this._geoObjects.length;a<o;a++){let h=this._geoObjects[a];h._handlerIndex=h._handlerIndex-1}let n=t._tagDataIndex;i.geoObjects.splice(n,1);for(let a=t._tagDataIndex,o=i.geoObjects.length;a<o;a++){let h=i.geoObjects[a];h._tagDataIndex=h._tagDataIndex-1}i._rgbaArr=Ce(i._rgbaArr,4*n,4),i._rtcPositionHighArr=Ce(i._rtcPositionHighArr,3*n,3),i._rtcPositionLowArr=Ce(i._rtcPositionLowArr,3*n,3),i._qRotArr=Ce(i._qRotArr,4*n,4),i._pickingColorArr=Ce(i._pickingColorArr,3*n,3),i._sizeArr=Ce(i._sizeArr,3*n,3),i._translateArr=Ce(i._translateArr,3*n,3),i._localPositionArr=Ce(i._localPositionArr,3*n,3),i._visibleArr=Ce(i._visibleArr,n,1),t._handlerIndex=-1,t._handler=null,t._tagDataIndex=-1,t._tagData=null,r||(i.refresh(),this._updateTag(i))}};ka.__counter__=0;let bl=ka;class wl extends xa{constructor(t,i=21){super(t),this._billboards=[],this._gliphParamBuffer=null,this._fontIndexBuffer=null,this._outlineBuffer=null,this._outlineColorBuffer=null,this._gliphParamArr=new Float32Array([]),this._fontIndexArr=new Float32Array([]),this._outlineArr=new Float32Array([]),this._outlineColorArr=new Float32Array([]),this._buffersUpdateCallbacks[8]=this.createFontIndexBuffer,this._buffersUpdateCallbacks[9]=this.createOutlineBuffer,this._buffersUpdateCallbacks[10]=this.createOutlineColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),this._maxLetters=i}initProgram(){this._renderer&&this._renderer.handler&&this._renderer.handler.gl&&(this._renderer.handler.programs.label||(this._renderer.handler.gl.type==="webgl2"?this._renderer.handler.addProgram(new X("label",{uniforms:{viewport:"vec2",fontTextureArr:"sampler2darray",sdfParamsArr:"vec4",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",scaleByDistance:"vec3",opacity:"float",isOutlinePass:"int",depthOffset:"float"},attributes:{a_outline:"float",a_gliphParam:"vec4",a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_size:"float",a_rotation:"float",a_rgba:"vec4",a_offset:"vec3",a_fontIndex:"float"},vertexShader:`#version 300 es
#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}in float a_outline;in vec4 a_gliphParam;in vec2 a_vertices;in vec4 a_texCoord;in vec3 a_positionsHigh;in vec3 a_positionsLow;in vec3 a_offset;in float a_size;in float a_rotation;in vec4 a_rgba;in float a_fontIndex;out vec2 v_uv;out vec4 v_rgba;flat out int v_fontIndex;out vec4 v_outlineColor;flat out float v_outline;uniform vec2 viewport;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float planetRadius;uniform vec3 scaleByDistance;uniform float opacity;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){if(a_texCoord.w==EMPTY){gl_Position=vec4(0.0);v_fontIndex=-1;return;}vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_outline=a_outline;v_fontIndex=int(a_fontIndex);v_uv=a_texCoord.xy;vec3 look=a_positions-cameraPos;float lookDist=length(look);v_rgba=a_rgba;if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(scaleByDistance[0],scaleByDistance[1],lookDist))*(1.0-step(scaleByDistance[2],lookDist));v_rgba.a*=opacity;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 vert=a_vertices;vec4 gp=a_gliphParam;if(a_texCoord.w==RTL){vert.x=step(vert.x*0.5+1.0,1.0);gp.x=-a_gliphParam.x;gp.z=-(a_gliphParam.z+a_texCoord.z);}else{gp.z=a_gliphParam.z+a_texCoord.z;}vec2 v=screenPos+rotate2d(a_rotation)*((vert*gp.xy+gp.zw)*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:`#version 300 es
uniform int isOutlinePass;precision highp float;const int MAX_SIZE=11;uniform sampler2D fontTextureArr[MAX_SIZE];uniform vec4 sdfParamsArr[MAX_SIZE];flat in int v_fontIndex;in vec2 v_uv;in vec4 v_rgba;flat in float v_outline;in vec3 v_pickingColor;layout(location=0)out vec4 outScreen;float median(float r,float g,float b){return max(min(r,g),min(max(r,g),b));}float getDistance(){vec3 msdf;if(v_fontIndex==0){msdf=texture(fontTextureArr[0],v_uv).rgb;}else if(v_fontIndex==1){msdf=texture(fontTextureArr[1],v_uv).rgb;}else if(v_fontIndex==2){msdf=texture(fontTextureArr[2],v_uv).rgb;}else if(v_fontIndex==3){msdf=texture(fontTextureArr[3],v_uv).rgb;}else if(v_fontIndex==4){msdf=texture(fontTextureArr[4],v_uv).rgb;}else if(v_fontIndex==5){msdf=texture(fontTextureArr[5],v_uv).rgb;}else if(v_fontIndex==6){msdf=texture(fontTextureArr[6],v_uv).rgb;}else if(v_fontIndex==7){msdf=texture(fontTextureArr[7],v_uv).rgb;}else if(v_fontIndex==8){msdf=texture(fontTextureArr[8],v_uv).rgb;}else if(v_fontIndex==9){msdf=texture(fontTextureArr[9],v_uv).rgb;}else if(v_fontIndex==10){msdf=texture(fontTextureArr[10],v_uv).rgb;}return median(msdf.r,msdf.g,msdf.b);}void main(){if(v_fontIndex==-1){return;}vec4 sdfParams=sdfParamsArr[v_fontIndex];float sd=getDistance();vec2 dxdy=fwidth(v_uv)*sdfParams.xy;if(isOutlinePass==0){float dist=sd+min(0.001,0.5-1.0/sdfParams.w)-0.5;float opacity=clamp(dist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(opacity<=0.1){discard;}outScreen=vec4(v_rgba.rgb,opacity*v_rgba.a);}else{float dist=sd+min(v_outline,0.5-1.0/sdfParams.w)-0.5;float opacity=clamp(dist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(opacity<=0.1){discard;}outScreen=vec4(v_rgba.rgb,opacity*v_rgba.a);}}`})):this._renderer.handler.addProgram(new X("label",{uniforms:{viewport:"vec2",fontTextureArr:"sampler2darray",sdfParamsArr:"vec4",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",scaleByDistance:"vec3",opacity:"float",isOutlinePass:"int",depthOffset:"float"},attributes:{a_outline:"float",a_gliphParam:"vec4",a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_size:"float",a_rotation:"float",a_rgba:"vec4",a_offset:"vec3",a_fontIndex:"float"},vertexShader:`#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute float a_outline;attribute vec4 a_gliphParam;attribute vec2 a_vertices;attribute vec4 a_texCoord;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute float a_size;attribute float a_rotation;attribute vec4 a_rgba;attribute float a_fontIndex;varying float v_outline;varying vec2 v_uv;varying vec4 v_rgba;varying float v_fontIndex;uniform vec2 viewport;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float planetRadius;uniform vec3 scaleByDistance;uniform float opacity;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){if(a_texCoord.w==EMPTY){gl_Position=vec4(0.0);v_fontIndex=-1.0;return;}vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_outline=a_outline;v_uv=vec2(a_texCoord.xy);v_rgba=a_rgba;v_fontIndex=a_fontIndex;vec3 look=a_positions-cameraPos;float lookDist=length(look);if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(scaleByDistance[0],scaleByDistance[1],lookDist))*(1.0-step(scaleByDistance[2],lookDist));v_rgba.a*=opacity;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 vert=a_vertices;vec4 gp=a_gliphParam;if(a_texCoord.w==RTL){vert.x=step(vert.x*0.5+1.0,1.0);gp.x=-a_gliphParam.x;gp.z=-(a_gliphParam.z+a_texCoord.z);}else{gp.z=a_gliphParam.z+a_texCoord.z;}vec2 v=screenPos+rotate2d(a_rotation)*((vert*gp.xy+gp.zw)*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:`#extension GL_OES_standard_derivatives: enable
precision highp float;precision highp int;const int MAX_SIZE=11;uniform sampler2D fontTextureArr[MAX_SIZE];uniform vec4 sdfParamsArr[MAX_SIZE];uniform int isOutlinePass;varying float v_outline;varying vec2 v_uv;varying vec4 v_rgba;varying float v_fontIndex;float fontIndex;float median(float r,float g,float b){return max(min(r,g),min(max(r,g),b));}float getDistance(){vec3 msdf;if(fontIndex>=0.0&&fontIndex<1.0){msdf=texture2D(fontTextureArr[0],v_uv).rgb;}else if(fontIndex>=1.0&&fontIndex<2.0){msdf=texture2D(fontTextureArr[1],v_uv).rgb;}else if(fontIndex>=2.0&&fontIndex<3.0){msdf=texture2D(fontTextureArr[2],v_uv).rgb;}else if(fontIndex>=3.0&&fontIndex<4.0){msdf=texture2D(fontTextureArr[3],v_uv).rgb;}else if(fontIndex>=4.0&&fontIndex<5.0){msdf=texture2D(fontTextureArr[4],v_uv).rgb;}else if(fontIndex>=5.0&&fontIndex<6.0){msdf=texture2D(fontTextureArr[5],v_uv).rgb;}else if(fontIndex>=6.0&&fontIndex<7.0){msdf=texture2D(fontTextureArr[6],v_uv).rgb;}else if(fontIndex>=7.0&&fontIndex<8.0){msdf=texture2D(fontTextureArr[7],v_uv).rgb;}else if(fontIndex>=8.0&&fontIndex<9.0){msdf=texture2D(fontTextureArr[8],v_uv).rgb;}else if(fontIndex>=9.0&&fontIndex<10.0){msdf=texture2D(fontTextureArr[9],v_uv).rgb;}else if(fontIndex>=10.0&&fontIndex<11.0){msdf=texture2D(fontTextureArr[10],v_uv).rgb;}return median(msdf.r,msdf.g,msdf.b);}vec4 getSDFParams(){if(fontIndex>=0.0&&fontIndex<1.0){return sdfParamsArr[0];}else if(fontIndex>=1.0&&fontIndex<2.0){return sdfParamsArr[1];}else if(fontIndex>=2.0&&fontIndex<3.0){return sdfParamsArr[2];}else if(fontIndex>=3.0&&fontIndex<4.0){return sdfParamsArr[3];}else if(fontIndex>=4.0&&fontIndex<5.0){return sdfParamsArr[4];}else if(fontIndex>=5.0&&fontIndex<6.0){return sdfParamsArr[5];}else if(fontIndex>=6.0&&fontIndex<7.0){return sdfParamsArr[6];}else if(fontIndex>=7.0&&fontIndex<8.0){return sdfParamsArr[7];}else if(fontIndex>=8.0&&fontIndex<9.0){return sdfParamsArr[8];}else if(fontIndex>=9.0&&fontIndex<10.0){return sdfParamsArr[9];}else if(fontIndex>=10.0&&fontIndex<11.0){return sdfParamsArr[10];}}void main(){fontIndex=v_fontIndex+0.1;if(v_fontIndex<0.0){return;}vec4 sdfParams=getSDFParams();float sd=getDistance();vec2 dxdy=fwidth(v_uv)*sdfParams.xy;float dist=sd+min(0.001,0.5-1.0/sdfParams.w)-0.5;float opacity=clamp(dist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(isOutlinePass==0){}else{float strokeDist=sd+min(v_outline,0.5-1.0/sdfParams.w)-0.5;float strokeAlpha=v_rgba.a*clamp(strokeDist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(strokeAlpha<0.1){discard;}}}`}))),this._renderer.handler.programs.labelPicking||this._renderer.handler.addProgram(new X("labelPicking",{uniforms:{viewport:"vec2",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",scaleByDistance:"vec3",opacity:"float",depthOffset:"float"},attributes:{a_gliphParam:"vec4",a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_offset:"vec3",a_size:"float",a_rotation:"float",a_rgba:"vec4"},vertexShader:`#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute vec4 a_gliphParam;attribute vec2 a_vertices;attribute vec4 a_texCoord;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute float a_size;attribute float a_rotation;attribute vec4 a_rgba;varying vec4 v_rgba;uniform vec2 viewport;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float planetRadius;uniform vec3 scaleByDistance;uniform float opacity;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_rgba=a_rgba;if(a_texCoord.w==EMPTY){v_rgba.a=0.0;gl_Position=vec4(0.0);return;}vec3 look=a_positions-cameraPos;float lookDist=length(look);if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(scaleByDistance[0],scaleByDistance[1],lookDist))*(1.0-step(scaleByDistance[2],lookDist));v_rgba.a*=opacity;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 vert=a_vertices;vec4 gp=a_gliphParam;if(a_texCoord.w==RTL){vert.x=step(vert.x*0.5+1.0,1.0);gp.x=-a_gliphParam.x;gp.z=-(a_gliphParam.z+a_texCoord.z);}else{gp.z=a_gliphParam.z+a_texCoord.z;}vec2 v=screenPos+rotate2d(a_rotation)*((vert*gp.xy+gp.zw)*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:"precision highp float;varying vec4 v_rgba;varying vec3 v_pickingColor;void main(){vec4 color=v_rgba;if(color.a<0.05){return;}gl_FragColor=vec4(v_rgba.rgb,v_rgba.a);}"})))}get labels(){return this._billboards}add(t){t._handler||(t._handler=this,this.assignFontAtlas(t),this.refresh())}updateFonts(){let t=[...this._billboards];this._billboards=[];for(let i=0;i<t.length;i++)this.assignFontAtlas(t[i])}_addLabelToArrays(t){this._renderer&&this._renderer.labelWorker.make({handler:this,label:t})}assignFontAtlas(t){this._entityCollection&&this._renderer?(t.assignFontAtlas(this._renderer.fontAtlas),this._addLabelToArrays(t)):this._billboards.push(t)}workerCallback(t,i){i._lockId!==-1&&i._handler&&this.isEqual(i._handler)&&(i._isReady=!0,i._lockId=-1,i._handlerIndex=this._billboards.length,this._billboards.push(i),this._vertexArr=ie(this._vertexArr,t.vertexArr),this._texCoordArr=ie(this._texCoordArr,t.texCoordArr),this._gliphParamArr=ie(this._gliphParamArr,t.gliphParamArr),this._positionHighArr=ie(this._positionHighArr,t.positionHighArr),this._positionLowArr=ie(this._positionLowArr,t.positionLowArr),this._sizeArr=ie(this._sizeArr,t.sizeArr),this._offsetArr=ie(this._offsetArr,t.offsetArr),this._rgbaArr=ie(this._rgbaArr,t.rgbaArr),this._rotationArr=ie(this._rotationArr,t.rotationArr),this._fontIndexArr=ie(this._fontIndexArr,t.fontIndexArr),this._outlineArr=ie(this._outlineArr,t.outlineArr),this._outlineColorArr=ie(this._outlineColorArr,t.outlineColorArr),this._pickingColorArr=ie(this._pickingColorArr,t.pickingColorArr),i.update(),this.refresh())}clear(){this._texCoordArr=null,this._gliphParamArr=null,this._vertexArr=null,this._positionHighArr=null,this._positionLowArr=null,this._sizeArr=null,this._offsetArr=null,this._rgbaArr=null,this._rotationArr=null,this._fontIndexArr=null,this._outlineArr=null,this._outlineColorArr=null,this._texCoordArr=new Float32Array([]),this._gliphParamArr=new Float32Array([]),this._vertexArr=new Float32Array([]),this._positionHighArr=new Float32Array([]),this._positionLowArr=new Float32Array([]),this._sizeArr=new Float32Array([]),this._offsetArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._rotationArr=new Float32Array([]),this._fontIndexArr=new Float32Array([]),this._outlineArr=new Float32Array([]),this._outlineColorArr=new Float32Array([]),this._removeBillboards(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){if(this._renderer){let t=this._renderer.handler.gl;t.deleteBuffer(this._gliphParamBuffer),t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._fontIndexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._outlineBuffer),t.deleteBuffer(this._outlineColorBuffer),t.deleteBuffer(this._positionHighBuffer),t.deleteBuffer(this._positionLowBuffer),t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._offsetBuffer),t.deleteBuffer(this._rgbaBuffer),t.deleteBuffer(this._rotationBuffer),t.deleteBuffer(this._vertexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._pickingColorBuffer),this._gliphParamBuffer=null,this._sizeBuffer=null,this._fontIndexBuffer=null,this._texCoordBuffer=null,this._outlineBuffer=null,this._outlineColorBuffer=null,this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._pickingColorBuffer=null}}_displayPASS(){let t=this._renderer,i=t.handler;i.programs.label.activate();let s=i.programs.label._program,r=s.attributes,n=s.uniforms,a=i.gl,o=this._entityCollection;a.disable(a.CULL_FACE),a.uniform1iv(n.fontTextureArr,t.fontAtlas.samplerArr),a.uniform4fv(n.sdfParamsArr,t.fontAtlas.sdfParamsArr),a.uniformMatrix4fv(n.viewMatrix,!1,t.activeCamera.getViewMatrix()),a.uniformMatrix4fv(n.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),a.uniform3fv(n.eyePositionHigh,t.activeCamera.eyeHigh),a.uniform3fv(n.eyePositionLow,t.activeCamera.eyeLow),a.uniform3fv(n.scaleByDistance,o.scaleByDistance),a.uniform1f(n.opacity,o._fadingOpacity),a.uniform1f(n.planetRadius,o.renderNode._planetRadius2||0),a.uniform2fv(n.viewport,[i.canvas.clientWidth,i.canvas.clientHeight]),a.bindBuffer(a.ARRAY_BUFFER,this._texCoordBuffer),a.vertexAttribPointer(r.a_texCoord,this._texCoordBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._gliphParamBuffer),a.vertexAttribPointer(r.a_gliphParam,this._gliphParamBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._vertexBuffer),a.vertexAttribPointer(r.a_vertices,this._vertexBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionHighBuffer),a.vertexAttribPointer(r.a_positionsHigh,this._positionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionLowBuffer),a.vertexAttribPointer(r.a_positionsLow,this._positionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._sizeBuffer),a.vertexAttribPointer(r.a_size,this._sizeBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._rotationBuffer),a.vertexAttribPointer(r.a_rotation,this._rotationBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._offsetBuffer),a.vertexAttribPointer(r.a_offset,this._offsetBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._fontIndexBuffer),a.vertexAttribPointer(r.a_fontIndex,this._fontIndexBuffer.itemSize,a.FLOAT,!1,0,0),a.uniform1i(n.isOutlinePass,1),a.uniform1f(n.depthOffset,o.polygonOffsetUnits),a.bindBuffer(a.ARRAY_BUFFER,this._outlineColorBuffer),a.vertexAttribPointer(r.a_rgba,this._outlineColorBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._outlineBuffer),a.vertexAttribPointer(r.a_outline,this._outlineBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,this._vertexBuffer.numItems),a.depthFunc(a.EQUAL),a.uniform1i(n.isOutlinePass,0),a.uniform1f(n.depthOffset,o.polygonOffsetUnits),a.bindBuffer(a.ARRAY_BUFFER,this._rgbaBuffer),a.vertexAttribPointer(r.a_rgba,this._rgbaBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,this._vertexBuffer.numItems),a.depthFunc(a.LESS),a.enable(a.CULL_FACE)}_pickingPASS(){let t=this._renderer,i=t.handler;i.programs.labelPicking.activate();let s=i.programs.labelPicking._program,r=s.attributes,n=s.uniforms,a=i.gl,o=this._entityCollection,h=o.renderNode;a.disable(a.CULL_FACE),a.uniformMatrix4fv(n.viewMatrix,!1,t.activeCamera.getViewMatrix()),a.uniformMatrix4fv(n.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),a.uniform3fv(n.eyePositionHigh,t.activeCamera.eyeHigh),a.uniform3fv(n.eyePositionLow,t.activeCamera.eyeLow),a.uniform3fv(n.scaleByDistance,o.scaleByDistance),a.uniform1f(n.opacity,o._fadingOpacity),a.uniform1f(n.planetRadius,h._planetRadius2||0),a.uniform2fv(n.viewport,[i.canvas.clientWidth,i.canvas.clientHeight]),a.bindBuffer(a.ARRAY_BUFFER,this._texCoordBuffer),a.vertexAttribPointer(r.a_texCoord,this._texCoordBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._gliphParamBuffer),a.vertexAttribPointer(r.a_gliphParam,this._gliphParamBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._vertexBuffer),a.vertexAttribPointer(r.a_vertices,this._vertexBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionHighBuffer),a.vertexAttribPointer(r.a_positionsHigh,this._positionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionLowBuffer),a.vertexAttribPointer(r.a_positionsLow,this._positionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._sizeBuffer),a.vertexAttribPointer(r.a_size,this._sizeBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._rotationBuffer),a.vertexAttribPointer(r.a_rotation,this._rotationBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._offsetBuffer),a.vertexAttribPointer(r.a_offset,this._offsetBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._pickingColorBuffer),a.vertexAttribPointer(r.a_rgba,this._pickingColorBuffer.itemSize,a.FLOAT,!1,0,0),a.uniform1f(n.depthOffset,o.polygonOffsetUnits),a.drawArrays(a.TRIANGLES,0,this._vertexBuffer.numItems),a.enable(a.CULL_FACE)}_removeBillboard(t){let i=t._handlerIndex;this._billboards.splice(i,1);let s=24*this._maxLetters,r=i*s;this._rgbaArr=ae(this._rgbaArr,r,s),this._outlineColorArr=ae(this._outlineColorArr,r,s),this._texCoordArr=ae(this._texCoordArr,r,s),this._gliphParamArr=ae(this._gliphParamArr,r,s),s=18*this._maxLetters,r=i*s,this._positionHighArr=ae(this._positionHighArr,r,s),this._positionLowArr=ae(this._positionLowArr,r,s),this._offsetArr=ae(this._offsetArr,r,s),this._pickingColorArr=ae(this._pickingColorArr,r,s),s=12*this._maxLetters,r=i*s,this._vertexArr=ae(this._vertexArr,r,s),s=6*this._maxLetters,r=i*s,this._sizeArr=ae(this._sizeArr,r,s),this._rotationArr=ae(this._rotationArr,r,s),this._fontIndexArr=ae(this._fontIndexArr,r,s),this._outlineArr=ae(this._outlineArr,r,s),this.reindexBillboardsArray(i),this.refresh(),t._handlerIndex=-1,t._handler=null,t._isReady=!1}setText(t,i,s,r,n=0,a=!1){i=i.normalize("NFKC");let o=this._renderer.fontAtlas.atlasesArr[s];if(!o)return;let h=24*t*this._maxLetters,c=this._texCoordArr,d=this._gliphParamArr,u=0,_=Math.min(this._maxLetters,i.length),p=0;a&&(p=1);let f=0,m=o.kernings;for(u=0;u<_;u++){let g=h+24*u,y=i[u],x=o.get(y.charCodeAt(0))||o.get(32);if(!x)continue;let b=x.texCoords,T=x.metrics;c[g]=b[0],c[g+1]=b[1],c[g+2]=f,c[g+3]=p,c[g+4]=b[2],c[g+5]=b[3],c[g+6]=f,c[g+7]=p,c[g+8]=b[4],c[g+9]=b[5],c[g+10]=f,c[g+11]=p,c[g+12]=b[6],c[g+13]=b[7],c[g+14]=f,c[g+15]=p,c[g+16]=b[8],c[g+17]=b[9],c[g+18]=f,c[g+19]=p,c[g+20]=b[10],c[g+21]=b[11],c[g+22]=f,c[g+23]=p,d[g]=T.nWidth,d[g+1]=T.nHeight,d[g+2]=T.nXOffset,d[g+3]=T.nYOffset,d[g+4]=T.nWidth,d[g+5]=T.nHeight,d[g+6]=T.nXOffset,d[g+7]=T.nYOffset,d[g+8]=T.nWidth,d[g+9]=T.nHeight,d[g+10]=T.nXOffset,d[g+11]=T.nYOffset,d[g+12]=T.nWidth,d[g+13]=T.nHeight,d[g+14]=T.nXOffset,d[g+15]=T.nYOffset,d[g+16]=T.nWidth,d[g+17]=T.nHeight,d[g+18]=T.nXOffset,d[g+19]=T.nYOffset,d[g+20]=T.nWidth,d[g+21]=T.nHeight,d[g+22]=T.nXOffset,d[g+23]=T.nYOffset;let w=m[y.charCodeAt(0)];if(w&&i[u+1]){let A=w[i[u+1].charCodeAt(0)];f+=A?T.nAdvance+A+n:T.nAdvance+n}else f+=T.nAdvance+n}if(r===ai.CENTER)for(f*=-.5,u=0;u<_;u++){let g=h+24*u;c[g+2]+=f,c[g+6]+=f,c[g+10]+=f,c[g+14]+=f,c[g+18]+=f,c[g+22]+=f}for(;u<this._maxLetters;u++){let g=h+24*u;c[g+3]=-1,c[g+7]=-1,c[g+11]=-1,c[g+15]=-1,c[g+19]=-1,c[g+23]=-1}this._changedBuffers[6]=!0}setPositionArr(t,i,s){let r=18*t*this._maxLetters,n=this._positionHighArr,a=i.x,o=i.y,h=i.z,c=this._positionLowArr,d=s.x,u=s.y,_=s.z;for(let p=0;p<this._maxLetters;p++){let f=r+18*p;n[f]=a,n[f+1]=o,n[f+2]=h,n[f+3]=a,n[f+4]=o,n[f+5]=h,n[f+6]=a,n[f+7]=o,n[f+8]=h,n[f+9]=a,n[f+10]=o,n[f+11]=h,n[f+12]=a,n[f+13]=o,n[f+14]=h,n[f+15]=a,n[f+16]=o,n[f+17]=h,c[f]=d,c[f+1]=u,c[f+2]=_,c[f+3]=d,c[f+4]=u,c[f+5]=_,c[f+6]=d,c[f+7]=u,c[f+8]=_,c[f+9]=d,c[f+10]=u,c[f+11]=_,c[f+12]=d,c[f+13]=u,c[f+14]=_,c[f+15]=d,c[f+16]=u,c[f+17]=_}this._changedBuffers[1]=!0}setPickingColorArr(t,i){let s=18*t*this._maxLetters,r=this._pickingColorArr,n=i.x/255,a=i.y/255,o=i.z/255;for(let h=0;h<this._maxLetters;h++){let c=s+18*h;r[c]=n,r[c+1]=a,r[c+2]=o,r[c+3]=n,r[c+4]=a,r[c+5]=o,r[c+6]=n,r[c+7]=a,r[c+8]=o,r[c+9]=n,r[c+10]=a,r[c+11]=o,r[c+12]=n,r[c+13]=a,r[c+14]=o,r[c+15]=n,r[c+16]=a,r[c+17]=o}this._changedBuffers[0]=!0}setSizeArr(t,i){let s=6*t*this._maxLetters,r=this._sizeArr;for(let n=0;n<this._maxLetters;n++){let a=s+6*n;r[a]=i,r[a+1]=i,r[a+2]=i,r[a+3]=i,r[a+4]=i,r[a+5]=i}this._changedBuffers[2]=!0}setOffsetArr(t,i){let s=18*t*this._maxLetters,r=this._offsetArr,n=i.x,a=i.y,o=i.z;for(let h=0;h<this._maxLetters;h++){let c=s+18*h;r[c]=n,r[c+1]=a,r[c+2]=o,r[c+3]=n,r[c+4]=a,r[c+5]=o,r[c+6]=n,r[c+7]=a,r[c+8]=o,r[c+9]=n,r[c+10]=a,r[c+11]=o,r[c+12]=n,r[c+13]=a,r[c+14]=o,r[c+15]=n,r[c+16]=a,r[c+17]=o}this._changedBuffers[3]=!0}setRgbaArr(t,i){let s=24*t*this._maxLetters,r=this._rgbaArr,n=i.x,a=i.y,o=i.z,h=i.w;for(let c=0;c<this._maxLetters;c++){let d=s+24*c;r[d]=n,r[d+1]=a,r[d+2]=o,r[d+3]=h,r[d+4]=n,r[d+5]=a,r[d+6]=o,r[d+7]=h,r[d+8]=n,r[d+9]=a,r[d+10]=o,r[d+11]=h,r[d+12]=n,r[d+13]=a,r[d+14]=o,r[d+15]=h,r[d+16]=n,r[d+17]=a,r[d+18]=o,r[d+19]=h,r[d+20]=n,r[d+21]=a,r[d+22]=o,r[d+23]=h}this._changedBuffers[4]=!0}setOutlineColorArr(t,i){let s=24*t*this._maxLetters,r=this._outlineColorArr,n=i.x,a=i.y,o=i.z,h=i.w;for(let c=0;c<this._maxLetters;c++){let d=s+24*c;r[d]=n,r[d+1]=a,r[d+2]=o,r[d+3]=h,r[d+4]=n,r[d+5]=a,r[d+6]=o,r[d+7]=h,r[d+8]=n,r[d+9]=a,r[d+10]=o,r[d+11]=h,r[d+12]=n,r[d+13]=a,r[d+14]=o,r[d+15]=h,r[d+16]=n,r[d+17]=a,r[d+18]=o,r[d+19]=h,r[d+20]=n,r[d+21]=a,r[d+22]=o,r[d+23]=h}this._changedBuffers[10]=!0}setOutlineArr(t,i){let s=6*t*this._maxLetters,r=this._outlineArr;for(let n=0;n<this._maxLetters;n++){let a=s+6*n;r[a]=i,r[a+1]=i,r[a+2]=i,r[a+3]=i,r[a+4]=i,r[a+5]=i}this._changedBuffers[9]=!0}setRotationArr(t,i){let s=6*t*this._maxLetters,r=this._rotationArr;for(let n=0;n<this._maxLetters;n++){let a=s+6*n;r[a]=i,r[a+1]=i,r[a+2]=i,r[a+3]=i,r[a+4]=i,r[a+5]=i}this._changedBuffers[5]=!0}setVisibility(t,i){let s;s=i?[0,0,0,-1,1,-1,1,-1,1,0,0,0]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(t,s)}setVertexArr(t,i){let s=12*t*this._maxLetters,r=this._vertexArr;for(let n=0;n<this._maxLetters;n++){let a=s+12*n;r[a]=i[0],r[a+1]=i[1],r[a+2]=i[2],r[a+3]=i[3],r[a+4]=i[4],r[a+5]=i[5],r[a+6]=i[6],r[a+7]=i[7],r[a+8]=i[8],r[a+9]=i[9],r[a+10]=i[10],r[a+11]=i[11]}this._changedBuffers[7]=!0}setFontIndexArr(t,i){let s=6*t*this._maxLetters,r=this._fontIndexArr;for(let n=0;n<this._maxLetters;n++){let a=s+6*n;r[a]=i,r[a+1]=i,r[a+2]=i,r[a+3]=i,r[a+4]=i,r[a+5]=i}this._changedBuffers[8]=!0}createSizeBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=t.createArrayBuffer(this._sizeArr,1,this._sizeArr.length)}createFontIndexBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._fontIndexBuffer),this._fontIndexBuffer=t.createArrayBuffer(this._fontIndexArr,1,this._fontIndexArr.length)}createTexCoordBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,4,this._texCoordArr.length/4),t.gl.deleteBuffer(this._gliphParamBuffer),this._gliphParamBuffer=t.createArrayBuffer(this._gliphParamArr,4,this._gliphParamArr.length/4)}createOutlineBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._outlineBuffer),this._outlineBuffer=t.createArrayBuffer(this._outlineArr,1,this._outlineArr.length)}createOutlineColorBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._outlineColorBuffer),this._outlineColorBuffer=t.createArrayBuffer(this._outlineColorArr,4,this._outlineColorArr.length/4)}setMaxLetters(t){this._maxLetters=t}}const za=class Da{constructor(t){this.pickingEnabled=!0,this.__id=Da.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._pointClouds=[]}_initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.pointCloud||this._renderer.handler.addProgram(new X("pointCloud",{uniforms:{projectionViewMatrix:"mat4",opacity:"float",pointSize:"float"},attributes:{coordinates:"vec3",colors:"vec3"},vertexShader:`attribute vec3 coordinates;
            attribute vec4 colors;
            uniform mat4 projectionViewMatrix;
            uniform float opacity;
            uniform float pointSize;
            varying vec4 color;
            void main() {
                color = colors;
                color.a *= opacity;
                gl_Position = projectionViewMatrix * vec4(coordinates, 1.0);
                gl_PointSize = pointSize;
            }`,fragmentShader:`precision highp float;
            varying vec4 color;
            void main(void) {
                gl_FragColor = color;
            }`})))}setRenderNode(t){this._renderer=t.renderer,this._initProgram();for(let i=0;i<this._pointClouds.length;i++)this._pointClouds[i].setRenderNode(t)}add(t){t._handlerIndex===-1&&(t._handler=this,t._handlerIndex=this._pointClouds.length,this._pointClouds.push(t),this._entityCollection&&this._entityCollection.renderNode&&t.setRenderNode(this._entityCollection.renderNode))}remove(t){let i=t._handlerIndex;i!==-1&&(t._deleteBuffers(),t._handlerIndex=-1,t._handler=null,this._pointClouds.splice(i,1),this._reindexPointCloudArray(i))}_reindexPointCloudArray(t){let i=this._pointClouds;for(let s=t;s<i.length;s++)i[s]._handlerIndex=s}draw(){let t=this._pointClouds.length;for(;t--;)this._pointClouds[t].draw()}drawPicking(){if(this.pickingEnabled){let t=this._pointClouds.length;for(;t--;)this._pointClouds[t].drawPicking()}}clear(){let t=this._pointClouds.length;for(;t--;)this._pointClouds[t]._deleteBuffers(),this._pointClouds[t]._handler=null,this._pointClouds[t]._handlerIndex=-1;this._pointClouds.length=0,this._pointClouds=[]}};za.__counter__=0;let Tl=za;const Fa=class Oa{constructor(t){this.__id=Oa.__counter__++,this._entityCollection=t,this._renderer=null,this._polylines=[],this.pickingEnabled=!0,this._relativeCenter=new v,this._rtcEyePositionHigh=new Float32Array([0,0,0]),this._rtcEyePositionLow=new Float32Array([0,0,0])}_initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.polyline_screen||this._renderer.handler.addProgram(new X("polyline_screen",{uniforms:{viewport:"vec2",proj:"mat4",view:"mat4",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",thickness:"float",opacity:"float",depthOffset:"float",visibleSphere:"vec4",texAtlas:"sampler2d",strokeSize:"float",texOffset:"float"},attributes:{prevHigh:"vec3",currentHigh:"vec3",nextHigh:"vec3",prevLow:"vec3",currentLow:"vec3",nextLow:"vec3",order:"float",color:"vec4",texCoord:"vec4"},vertexShader:`#version 300 es
precision highp float;in vec3 prevHigh;in vec3 currentHigh;in vec3 nextHigh;in vec3 prevLow;in vec3 currentLow;in vec3 nextLow;in vec4 texCoord;in float order;in vec4 color;uniform float thickness;uniform mat4 proj;uniform mat4 view;uniform vec2 viewport;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform float opacity;uniform float depthOffset;uniform float strokeSize;uniform float texOffset;out vec4 v_rgba;out vec3 vPos;out vec3 uCamPos;out vec4 vTexCoord;flat out float repeat;flat out float v_texOffset;const float NEAR=-1.0;vec2 getIntersection(vec2 start1,vec2 end1,vec2 start2,vec2 end2){vec2 dir=end2-start2;vec2 perp=vec2(-dir.y,dir.x);float d2=dot(perp,start2);float seg=dot(perp,start1)-d2;float prl=seg-dot(perp,end1)+d2;if(prl>-1.0&&prl<1.0){return start1;}float u=seg/prl;return start1+u*(end1-start1);}vec2 project(vec4 p){return(0.5*p.xyz/p.w+0.5).xy*viewport;}void main(){uCamPos=rtcEyePositionHigh+rtcEyePositionLow;vPos=currentHigh+currentLow;v_rgba=vec4(color.rgb,color.a*opacity);mat4 viewMatrixRTE=view;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff,lowDiff;highDiff=currentHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=currentLow-rtcEyePositionLow;vec4 vCurrent=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=prevHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=prevLow-rtcEyePositionLow;vec4 vPrev=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=nextHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=nextLow-rtcEyePositionLow;vec4 vNext=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);if(vCurrent.z>NEAR){if(vPrev.z<NEAR&&abs(order)==1.0){vCurrent=vPrev+(vCurrent-vPrev)*(NEAR-vPrev.z)/(vCurrent.z-vPrev.z);}else if(vNext.z<NEAR&&abs(order)==2.0){vCurrent=vNext+(vCurrent-vNext)*(NEAR-vNext.z)/(vCurrent.z-vNext.z);}}vec4 dCurrent=proj*vCurrent;vec2 _next=project(proj*vNext);vec2 _prev=project(proj*vPrev);vec2 _current=project(dCurrent);if(_prev==_current){if(_next==_current){_next=_current+vec2(1.0,0.0);_prev=_current-_next;}else{_prev=_current+normalize(_current-_next);}}if(_next==_current){_next=_current+normalize(_current-_prev);}vec2 sNext=_next,sCurrent=_current,sPrev=_prev;vec2 dirNext=normalize(sNext-sCurrent);vec2 dirPrev=normalize(sPrev-sCurrent);float dotNP=dot(dirNext,dirPrev);vec2 normalNext=normalize(vec2(-dirNext.y,dirNext.x));vec2 normalPrev=normalize(vec2(dirPrev.y,-dirPrev.x));float d=thickness*sign(order);vTexCoord=texCoord;vec2 m;if(dotNP>=0.99991){m=sCurrent-normalPrev*d;}else{m=getIntersection(sCurrent+normalPrev*d,sPrev+normalPrev*d,sCurrent+normalNext*d,sNext+normalNext*d);if(dotNP>0.5&&dot(dirNext+dirPrev,m-sCurrent)<0.0){float occw=order*sign(dirNext.x*dirPrev.y-dirNext.y*dirPrev.x);if(occw==-1.0){m=sCurrent+normalPrev*d;}else if(occw==1.0){m=sCurrent+normalNext*d;}else if(occw==-2.0){m=sCurrent+normalNext*d;}else if(occw==2.0){m=sCurrent+normalPrev*d;}}else if(distance(sCurrent,m)>min(distance(sCurrent,sNext),distance(sCurrent,sPrev))){m=sCurrent+normalNext*d;}}repeat=min(distance(sCurrent,sPrev),viewport.y)/strokeSize;v_texOffset=texOffset;gl_Position=vec4((2.0*m/viewport-1.0)*dCurrent.w,dCurrent.z+depthOffset,dCurrent.w);}`,fragmentShader:`#version 300 es
precision highp float;uniform sampler2D texAtlas;uniform vec4 visibleSphere;in vec3 uCamPos;in vec4 v_rgba;in vec3 vPos;in vec4 vTexCoord;flat in float repeat;flat in float v_texOffset;out vec4 fragColor;void main(){if(visibleSphere.w!=0.0){vec3 cam_dir=normalize(vPos-uCamPos);vec3 sph_dir=normalize(vPos-visibleSphere.xyz);if(dot(cam_dir,sph_dir)>0.11){discard;}}float height=vTexCoord.w;if(height==0.0){fragColor=vec4(v_rgba.rgb,v_rgba.a);}else{vec2 uv=vTexCoord.xy;float min=vTexCoord.z;float EPS=0.5/1024.0;float localY=fract((uv.y+v_texOffset-min)/height*repeat);uv.y=clamp(min+localY*height,min+EPS,min+height-EPS);vec4 color=texture(texAtlas,uv);color.a*=v_rgba.a;fragColor=color;}}`})),this._renderer.handler.programs.polyline_picking||this._renderer.handler.addProgram(new X("polyline_picking",{uniforms:{viewport:"vec2",proj:"mat4",view:"mat4",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",color:"vec4",thickness:"float",depthOffset:"float",visibleSphere:"vec4"},attributes:{prevHigh:"vec3",currentHigh:"vec3",nextHigh:"vec3",prevLow:"vec3",currentLow:"vec3",nextLow:"vec3",order:"float"},vertexShader:"precision highp float;attribute vec3 prevHigh;attribute vec3 currentHigh;attribute vec3 nextHigh;attribute vec3 prevLow;attribute vec3 currentLow;attribute vec3 nextLow;attribute float order;uniform float thickness;uniform vec4 color;uniform mat4 proj;uniform mat4 view;uniform vec2 viewport;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform float depthOffset;varying vec4 vColor;varying vec3 vPos;varying vec3 uCamPos;const float NEAR=-1.0;vec2 getIntersection(vec2 start1,vec2 end1,vec2 start2,vec2 end2){vec2 dir=end2-start2;vec2 perp=vec2(-dir.y,dir.x);float d2=dot(perp,start2);float seg=dot(perp,start1)-d2;float prl=seg-dot(perp,end1)+d2;if(prl>-1.0&&prl<1.0){return start1;}float u=seg/prl;return start1+u*(end1-start1);}vec2 project(vec4 p){return(0.5*p.xyz/p.w+0.5).xy*viewport;}void main(){uCamPos=rtcEyePositionHigh+rtcEyePositionLow;vPos=currentHigh+currentLow;vColor=color;vec3 highDiff,lowDiff;mat4 viewMatrixRTE=view;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);highDiff=currentHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=currentLow-rtcEyePositionLow;vec4 vCurrent=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=prevHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=prevLow-rtcEyePositionLow;vec4 vPrev=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=nextHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=nextLow-rtcEyePositionLow;vec4 vNext=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);if(vCurrent.z>NEAR){if(vPrev.z<NEAR&&abs(order)==1.0){vCurrent=vPrev+(vCurrent-vPrev)*(NEAR-vPrev.z)/(vCurrent.z-vPrev.z);}else if(vNext.z<NEAR&&abs(order)==2.0){vCurrent=vNext+(vCurrent-vNext)*(NEAR-vNext.z)/(vCurrent.z-vNext.z);}}vec4 dCurrent=proj*vCurrent;vec2 _next=project(proj*vNext);vec2 _prev=project(proj*vPrev);vec2 _current=project(dCurrent);if(_prev==_current){if(_next==_current){_next=_current+vec2(1.0,0.0);_prev=_current-_next;}else{_prev=_current+normalize(_current-_next);}}if(_next==_current){_next=_current+normalize(_current-_prev);}vec2 sNext=_next,sCurrent=_current,sPrev=_prev;vec2 dirNext=normalize(sNext-sCurrent);vec2 dirPrev=normalize(sPrev-sCurrent);float dotNP=dot(dirNext,dirPrev);vec2 normalNext=normalize(vec2(-dirNext.y,dirNext.x));vec2 normalPrev=normalize(vec2(dirPrev.y,-dirPrev.x));float d=thickness*sign(order);vec2 m;if(dotNP>=0.99991){m=sCurrent-normalPrev*d;}else{m=getIntersection(sCurrent+normalPrev*d,sPrev+normalPrev*d,sCurrent+normalNext*d,sNext+normalNext*d);if(dotNP>0.5&&dot(dirNext+dirPrev,m-sCurrent)<0.0){float occw=order*sign(dirNext.x*dirPrev.y-dirNext.y*dirPrev.x);if(occw==-1.0){m=sCurrent+normalPrev*d;}else if(occw==1.0){m=sCurrent+normalNext*d;}else if(occw==-2.0){m=sCurrent+normalNext*d;}else if(occw==2.0){m=sCurrent+normalPrev*d;}}else if(distance(sCurrent,m)>min(distance(sCurrent,sNext),distance(sCurrent,sPrev))){m=sCurrent+normalNext*d;}}gl_Position=vec4((2.0*m/viewport-1.0)*dCurrent.w,dCurrent.z+depthOffset,dCurrent.w);}",fragmentShader:"precision highp float;uniform vec4 visibleSphere;varying vec3 uCamPos;varying vec4 vColor;varying vec3 vPos;void main(){if(visibleSphere.w!=0.0){vec3 cam_dir=normalize(vPos-uCamPos);vec3 sph_dir=normalize(vPos-visibleSphere.xyz);if(dot(cam_dir,sph_dir)>0.11){discard;}}gl_FragColor=vec4(vColor.rgb,vColor.a);}"})))}setRenderNode(t){this._renderer=t.renderer,this._initProgram();for(let i=0;i<this._polylines.length;i++)this._polylines[i].setRenderNode(t)}add(t){t._handlerIndex===-1&&(t._handler=this,t._handlerIndex=this._polylines.length,t.__doubleToTwoFloats=this.getRTCPosition.bind(this),this._polylines.push(t),this._entityCollection&&this._entityCollection.renderNode&&(t.setRenderNode(this._entityCollection.renderNode),t.updateRTCPosition()))}remove(t){let i=t._handlerIndex;i!==-1&&(t._deleteBuffers(),t._handlerIndex=-1,t._handler=null,this._polylines.splice(i,1),this.reindexPolylineArray(i))}reindexPolylineArray(t){let i=this._polylines;for(let s=t;s<i.length;s++)i[s]._handlerIndex=s}draw(){this._updateRTCEyePosition();let t=this._polylines.length;for(;t--;)this._polylines[t].draw()}drawPicking(){if(this.pickingEnabled){let t=this._polylines.length;for(;t--;)this._polylines[t].drawPicking()}}clear(){let t=this._polylines.length;for(;t--;)this._polylines[t]._deleteBuffers(),this._polylines[t]._handler=null,this._polylines[t]._handlerIndex=-1;this._polylines.length=0,this._polylines=[]}getRTCPosition(t,i,s){let r=t.sub(this._relativeCenter);v.doubleToTwoFloats(r,i,s)}setRelativeCenter(t){this._relativeCenter.copy(t);for(let i=0;i<this._polylines.length;i++)this._polylines[i].updateRTCPosition()}_updateRTCEyePosition(){let t=this._renderer;if(t.activeCamera.isFirstPass){let i=t.activeCamera.eye.sub(this._relativeCenter);v.doubleToTwoFloat32Array(i,this._rtcEyePositionHigh,this._rtcEyePositionLow)}}reloadTextures(){for(let t=0;t<this._polylines.length;t++){let i=this._polylines[t];i.setSrc(i.getSrc())}}get polylines(){return[...this._polylines]}refreshTexCoordsArr(){if(this._entityCollection&&this._renderer){let t=this._renderer.strokeTextureAtlas;for(let i=0;i<this._polylines.length;i++){let s=this._polylines[i],r=s.getImage();if(r){let n=t.get(r.__nodeIndex);n&&s._setTexCoordArr(n.texCoords)}}}}};Fa.__counter__=0;let Cl=Fa;const Na=class Ha{constructor(t){this.__id=Ha.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._rays=[],this._vertexBuffer=null,this._startPositionHighBuffer=null,this._startPositionLowBuffer=null,this._endPositionHighBuffer=null,this._endPositionLowBuffer=null,this._thicknessBuffer=null,this._rgbaBuffer=null,this._pickingColorBuffer=null,this._texCoordBuffer=null,this._texOffsetBuffer=null,this._strokeSizeBuffer=null,this._vertexArr=[],this._startPositionHighArr=[],this._startPositionLowArr=[],this._endPositionHighArr=[],this._endPositionLowArr=[],this._thicknessArr=[],this._rgbaArr=[],this._pickingColorArr=[],this._texCoordArr=new Float32Array([]),this._texOffsetArr=new Float32Array([]),this._strokeSizeArr=new Float32Array([]),this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[5]=this.createVertexBuffer,this._buffersUpdateCallbacks[1]=this.createStartPositionBuffer,this._buffersUpdateCallbacks[2]=this.createEndPositionBuffer,this._buffersUpdateCallbacks[4]=this.createThicknessBuffer,this._buffersUpdateCallbacks[3]=this.createRgbaBuffer,this._buffersUpdateCallbacks[0]=this.createPickingColorBuffer,this._buffersUpdateCallbacks[6]=this.createTexCoordBuffer,this._buffersUpdateCallbacks[7]=this.createTexOffsetBuffer,this._buffersUpdateCallbacks[8]=this.createStrokeSizeBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}static concArr(t,i){for(let s=0;s<i.length;s++)t.push(i[s])}reloadTextures(){for(let t=0;t<this._rays.length;t++){let i=this._rays[t];i.setSrc(i.getSrc())}}get rays(){return[...this._rays]}initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.rayScreen||this._renderer.handler.addProgram(new X("rayScreen",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",resolution:"float",uOpacity:"float",texAtlas:"sampler2d",viewport:"vec2"},attributes:{a_vertices:"vec2",a_texCoord:"vec4",a_startPosHigh:"vec3",a_startPosLow:"vec3",a_endPosHigh:"vec3",a_endPosLow:"vec3",a_thickness:"float",a_rgba:"vec4",a_texOffset:"float",a_strokeSize:"float"},vertexShader:`#version 300 es
precision highp float;in vec4 a_rgba;in vec3 a_startPosHigh;in vec3 a_startPosLow;in vec3 a_endPosHigh;in vec3 a_endPosLow;in vec2 a_vertices;in float a_thickness;in vec4 a_texCoord;in float a_texOffset;in float a_strokeSize;out vec4 v_rgba;out vec4 v_texCoord;out float v_texOffset;flat out float repeat;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float resolution;uniform float uOpacity;uniform vec2 viewport;vec2 project(vec4 p){return(0.5*p.xyz/p.w+0.5).xy*viewport;}void main(){v_texOffset=a_texOffset;v_rgba=vec4(a_rgba.rgb,a_rgba.a*uOpacity);v_texCoord=a_texCoord;vec3 v=(a_endPosHigh-a_startPosHigh)+(a_endPosLow-a_startPosLow);vec3 look=(a_startPosHigh-eyePositionHigh)+(a_startPosLow-eyePositionLow)+v*a_vertices.y;vec3 up=normalize(v);vec3 right=normalize(cross(look,up));float dist=abs(dot(look,vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2])));float focalSize=2.0*dist*resolution;vec3 vert=right*a_thickness*focalSize*a_vertices.x;vec3 highDiff;if(a_vertices.y==0.0){highDiff=a_startPosHigh-eyePositionHigh;vert+=a_startPosLow-eyePositionLow;}else{highDiff=a_endPosHigh-eyePositionHigh;vert+=a_endPosLow-eyePositionLow;}mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+vert,1.0);highDiff=a_startPosHigh-eyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));vec3 lowDiff=a_startPosLow-eyePositionLow;vec4 vStart=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=a_endPosHigh-eyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=a_endPosLow-eyePositionLow;vec4 vEnd=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec2 nStart=project(projectionMatrix*vStart);vec2 nEnd=project(projectionMatrix*vEnd);repeat=min(distance(nStart,nEnd),viewport.y)/a_strokeSize;}`,fragmentShader:`#version 300 es
precision highp float;uniform sampler2D texAtlas;in vec4 v_rgba;in vec4 v_texCoord;in float v_texOffset;flat in float repeat;out vec4 fragColor;void main(){float height=v_texCoord.w;if(height==0.0){fragColor=v_rgba;}else{vec2 uv=v_texCoord.xy;float min=v_texCoord.z;float EPS=0.5/1024.0;float localY=fract((uv.y+v_texOffset-min)/height*repeat);uv.y=clamp(min+localY*height,min+EPS,min+height-EPS);vec4 color=texture(texAtlas,uv);fragColor=v_rgba*color;}}`})))}setRenderer(t){this._renderer=t,this.initProgram()}refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}_removeRays(){let t=this._rays.length;for(;t--;){let i=this._rays[t];i._handlerIndex=-1,i._handler=null}this._rays.length=0,this._rays=[]}clear(){this._vertexArr=null,this._startPositionHighArr=null,this._startPositionLowArr=null,this._endPositionHighArr=null,this._endPositionLowArr=null,this._thicknessArr=null,this._rgbaArr=null,this._texCoordArr=null,this._texOffsetArr=null,this._strokeSizeArr=null,this._vertexArr=new Float32Array([]),this._texCoordArr=new Float32Array([]),this._startPositionHighArr=new Float32Array([]),this._startPositionLowArr=new Float32Array([]),this._endPositionHighArr=new Float32Array([]),this._endPositionLowArr=new Float32Array([]),this._thicknessArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._texOffsetArr=new Float32Array([]),this._strokeSizeArr=new Float32Array([]),this._removeRays(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){if(this._renderer){let t=this._renderer.handler.gl;t&&(t.deleteBuffer(this._startPositionHighBuffer),t.deleteBuffer(this._startPositionLowBuffer),t.deleteBuffer(this._endPositionHighBuffer),t.deleteBuffer(this._endPositionLowBuffer),t.deleteBuffer(this._thicknessBuffer),t.deleteBuffer(this._rgbaBuffer),t.deleteBuffer(this._vertexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._texOffsetBuffer),t.deleteBuffer(this._strokeSizeBuffer)),this._startPositionHighBuffer=null,this._startPositionLowBuffer=null,this._endPositionHighBuffer=null,this._endPositionLowBuffer=null,this._thicknessBuffer=null,this._rgbaBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._texOffsetBuffer=null,this._strokeSizeBuffer=null}}update(){if(this._renderer){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}}add(t){t._handlerIndex==-1&&(t._handler=this,t._handlerIndex=this._rays.length,this._rays.push(t),this._addRayToArrays(t),this.refresh())}_addRayToArrays(t){t.getVisibility()?this._vertexArr=ye(this._vertexArr,[-.5,1,-.5,0,.5,0,.5,0,.5,1,-.5,1]):this._vertexArr=ye(this._vertexArr,[0,0,0,0,0,0,0,0,0,0,0,0]);let i=t.texOffset;this._texOffsetArr=ie(this._texOffsetArr,[i,i,i,i,i,i]),i=t.strokeSize,this._strokeSizeArr=ie(this._strokeSizeArr,[i,i,i,i,i,i]),this._texCoordArr=ie(this._texCoordArr,[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),i=t._startPositionHigh.x;let s=t._startPositionHigh.y,r=t._startPositionHigh.z;this._startPositionHighArr=ye(this._startPositionHighArr,[i,s,r,i,s,r,i,s,r,i,s,r,i,s,r,i,s,r]),i=t._startPositionLow.x,s=t._startPositionLow.y,r=t._startPositionLow.z,this._startPositionLowArr=ye(this._startPositionLowArr,[i,s,r,i,s,r,i,s,r,i,s,r,i,s,r,i,s,r]),i=t._endPositionHigh.x,s=t._endPositionHigh.y,r=t._endPositionHigh.z,this._endPositionHighArr=ye(this._endPositionHighArr,[i,s,r,i,s,r,i,s,r,i,s,r,i,s,r,i,s,r]),i=t._endPositionLow.x,s=t._endPositionLow.y,r=t._endPositionLow.z,this._endPositionLowArr=ye(this._endPositionLowArr,[i,s,r,i,s,r,i,s,r,i,s,r,i,s,r,i,s,r]),i=t._thickness,this._thicknessArr=ye(this._thicknessArr,[i,i,i,i,i,i]);let n=t._startColor.x,a=t._startColor.y,o=t._startColor.z,h=t._startColor.w,c=t._endColor.x,d=t._endColor.y,u=t._endColor.z,_=t._endColor.w;this._rgbaArr=ye(this._rgbaArr,[c,d,u,_,n,a,o,h,n,a,o,h,n,a,o,h,c,d,u,_,c,d,u,_]),i=t._entity._pickingColor.x/255,s=t._entity._pickingColor.y/255,r=t._entity._pickingColor.z/255,this._pickingColorArr=ye(this._pickingColorArr,[i,s,r,i,s,r,i,s,r,i,s,r,i,s,r,i,s,r])}_displayPASS(){let t=this._renderer,i=t.handler;i.programs.rayScreen.activate();let s=i.programs.rayScreen._program,r=s.attributes,n=s.uniforms,a=i.gl,o=this._entityCollection;a.disable(a.CULL_FACE),a.uniform1f(n.uOpacity,o._fadingOpacity),a.uniform1i(n.u_texAtlas,0),a.uniformMatrix4fv(n.viewMatrix,!1,t.activeCamera.getViewMatrix()),a.uniformMatrix4fv(n.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),a.uniform3fv(n.eyePositionHigh,t.activeCamera.eyeHigh),a.uniform3fv(n.eyePositionLow,t.activeCamera.eyeLow),a.uniform1f(n.resolution,t.activeCamera._tanViewAngle_hradOneByHeight),a.uniform2fv(n.viewport,[t.handler.canvas.width,t.handler.canvas.height]),a.bindBuffer(a.ARRAY_BUFFER,this._startPositionHighBuffer),a.vertexAttribPointer(r.a_startPosHigh,this._startPositionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._startPositionLowBuffer),a.vertexAttribPointer(r.a_startPosLow,this._startPositionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._endPositionHighBuffer),a.vertexAttribPointer(r.a_endPosHigh,this._endPositionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._endPositionLowBuffer),a.vertexAttribPointer(r.a_endPosLow,this._endPositionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._rgbaBuffer),a.vertexAttribPointer(r.a_rgba,this._rgbaBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._thicknessBuffer),a.vertexAttribPointer(r.a_thickness,this._thicknessBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._vertexBuffer),a.vertexAttribPointer(r.a_vertices,this._vertexBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._texCoordBuffer),a.vertexAttribPointer(r.a_texCoord,this._texCoordBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._texOffsetBuffer),a.vertexAttribPointer(r.a_texOffset,this._texOffsetBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._strokeSizeBuffer),a.vertexAttribPointer(r.a_strokeSize,this._strokeSizeBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,this._vertexBuffer.numItems),a.enable(a.CULL_FACE)}_pickingPASS(){}draw(){this._rays.length&&(this.update(),this._displayPASS())}drawPicking(){this._rays.length&&this.pickingEnabled&&this._pickingPASS()}reindexRaysArray(t){let i=this._rays;for(let s=t;s<i.length;s++)i[s]._handlerIndex=s}_removeRay(t){let i=t._handlerIndex;this._rays.splice(i,1);let s=24*i;this._rgbaArr=Ce(this._rgbaArr,s,24),this._texCoordArr=ae(this._texCoordArr,s,24),s=18*i,this._startPositionHighArr=Ce(this._startPositionHighArr,s,18),this._startPositionLowArr=Ce(this._startPositionLowArr,s,18),this._endPositionHighArr=Ce(this._endPositionHighArr,s,18),this._endPositionLowArr=Ce(this._endPositionLowArr,s,18),this._pickingColorArr=Ce(this._pickingColorArr,s,18),s=12*i,this._vertexArr=Ce(this._vertexArr,s,12),s=6*i,this._thicknessArr=Ce(this._thicknessArr,s,6),this._texOffsetArr=ae(this._texOffsetArr,s,6),this._strokeSizeArr=ae(this._strokeSizeArr,s,6),this.reindexRaysArray(i),this.refresh(),t._handlerIndex=-1,t._handler=null}remove(t){t._handler&&this.__id===t._handler.__id&&this._removeRay(t)}setStartPositionArr(t,i,s){let r=18*t,n=this._startPositionHighArr,a=i.x,o=i.y,h=i.z;n[r]=a,n[r+1]=o,n[r+2]=h,n[r+3]=a,n[r+4]=o,n[r+5]=h,n[r+6]=a,n[r+7]=o,n[r+8]=h,n[r+9]=a,n[r+10]=o,n[r+11]=h,n[r+12]=a,n[r+13]=o,n[r+14]=h,n[r+15]=a,n[r+16]=o,n[r+17]=h,n=this._startPositionLowArr,a=s.x,o=s.y,h=s.z,n[r]=a,n[r+1]=o,n[r+2]=h,n[r+3]=a,n[r+4]=o,n[r+5]=h,n[r+6]=a,n[r+7]=o,n[r+8]=h,n[r+9]=a,n[r+10]=o,n[r+11]=h,n[r+12]=a,n[r+13]=o,n[r+14]=h,n[r+15]=a,n[r+16]=o,n[r+17]=h,this._changedBuffers[1]=!0}setEndPositionArr(t,i,s){let r=18*t,n=this._endPositionHighArr,a=i.x,o=i.y,h=i.z;n[r]=a,n[r+1]=o,n[r+2]=h,n[r+3]=a,n[r+4]=o,n[r+5]=h,n[r+6]=a,n[r+7]=o,n[r+8]=h,n[r+9]=a,n[r+10]=o,n[r+11]=h,n[r+12]=a,n[r+13]=o,n[r+14]=h,n[r+15]=a,n[r+16]=o,n[r+17]=h,n=this._endPositionLowArr,a=s.x,o=s.y,h=s.z,n[r]=a,n[r+1]=o,n[r+2]=h,n[r+3]=a,n[r+4]=o,n[r+5]=h,n[r+6]=a,n[r+7]=o,n[r+8]=h,n[r+9]=a,n[r+10]=o,n[r+11]=h,n[r+12]=a,n[r+13]=o,n[r+14]=h,n[r+15]=a,n[r+16]=o,n[r+17]=h,this._changedBuffers[2]=!0}setPickingColorArr(t,i){let s=18*t,r=this._pickingColorArr,n=i.x/255,a=i.y/255,o=i.z/255;r[s]=n,r[s+1]=a,r[s+2]=o,r[s+3]=n,r[s+4]=a,r[s+5]=o,r[s+6]=n,r[s+7]=a,r[s+8]=o,r[s+9]=n,r[s+10]=a,r[s+11]=o,r[s+12]=n,r[s+13]=a,r[s+14]=o,r[s+15]=n,r[s+16]=a,r[s+17]=o,this._changedBuffers[0]=!0}setRgbaArr(t,i,s){let r=24*t,n=this._rgbaArr,a=i.x,o=i.y,h=i.z,c=i.w,d=s.x,u=s.y,_=s.z,p=s.w;n[r]=d,n[r+1]=u,n[r+2]=_,n[r+3]=p,n[r+4]=a,n[r+5]=o,n[r+6]=h,n[r+7]=c,n[r+8]=a,n[r+9]=o,n[r+10]=h,n[r+11]=c,n[r+12]=a,n[r+13]=o,n[r+14]=h,n[r+15]=c,n[r+16]=d,n[r+17]=u,n[r+18]=_,n[r+19]=p,n[r+20]=d,n[r+21]=u,n[r+22]=_,n[r+23]=p,this._changedBuffers[3]=!0}setThicknessArr(t,i){let s=6*t,r=this._thicknessArr;r[s]=i,r[s+1]=i,r[s+2]=i,r[s+3]=i,r[s+4]=i,r[s+5]=i,this._changedBuffers[4]=!0}setVisibility(t,i){let s;s=i?[-.5,1,-.5,0,.5,0,.5,0,.5,1,-.5,1]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(t,s)}setVertexArr(t,i){let s=12*t,r=this._vertexArr;r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=i[3],r[s+4]=i[4],r[s+5]=i[5],r[s+6]=i[6],r[s+7]=i[7],r[s+8]=i[8],r[s+9]=i[9],r[s+10]=i[10],r[s+11]=i[11],this._changedBuffers[5]=!0}createStartPositionBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._startPositionHighBuffer),this._startPositionHighArr=se(this._startPositionHighArr),this._startPositionHighBuffer=t.createArrayBuffer(this._startPositionHighArr,3,this._startPositionHighArr.length/3,t.gl.DYNAMIC_DRAW),t.gl.deleteBuffer(this._startPositionLowBuffer),this._startPositionLowArr=se(this._startPositionLowArr),this._startPositionLowBuffer=t.createArrayBuffer(this._startPositionLowArr,3,this._startPositionLowArr.length/3,t.gl.DYNAMIC_DRAW)}createEndPositionBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._endPositionHighBuffer),this._endPositionHighArr=se(this._endPositionHighArr),this._endPositionHighBuffer=t.createArrayBuffer(this._endPositionHighArr,3,this._endPositionHighArr.length/3,t.gl.DYNAMIC_DRAW),t.gl.deleteBuffer(this._endPositionLowBuffer),this._endPositionLowArr=se(this._endPositionLowArr),this._endPositionLowBuffer=t.createArrayBuffer(this._endPositionLowArr,3,this._endPositionLowArr.length/3,t.gl.DYNAMIC_DRAW)}createRgbaBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._rgbaBuffer),this._rgbaArr=se(this._rgbaArr),this._rgbaBuffer=t.createArrayBuffer(this._rgbaArr,4,this._rgbaArr.length/4)}createThicknessBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._thicknessBuffer),this._thicknessArr=se(this._thicknessArr),this._thicknessBuffer=t.createArrayBuffer(this._thicknessArr,1,this._thicknessArr.length,t.gl.DYNAMIC_DRAW)}createVertexBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._vertexBuffer),this._vertexArr=se(this._vertexArr),this._vertexBuffer=t.createArrayBuffer(this._vertexArr,2,this._vertexArr.length/2,t.gl.DYNAMIC_DRAW)}createTexCoordBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,4,this._texCoordArr.length/4)}createTexOffsetBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._texOffsetBuffer),this._texOffsetBuffer=t.createArrayBuffer(this._texOffsetArr,1,this._texOffsetArr.length)}createStrokeSizeBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._strokeSizeBuffer),this._strokeSizeBuffer=t.createArrayBuffer(this._strokeSizeArr,1,this._strokeSizeArr.length)}createPickingColorBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorArr=se(this._pickingColorArr),this._pickingColorBuffer=t.createArrayBuffer(this._pickingColorArr,3,this._pickingColorArr.length/3)}setTexCoordArr(t,i){let s=i[1],r=i[3]-s,n=24*t,a=this._texCoordArr;a[n]=i[0],a[n+1]=i[1],a[n+2]=s,a[n+3]=r,a[n+4]=i[2],a[n+5]=i[3],a[n+6]=s,a[n+7]=r,a[n+8]=i[4],a[n+9]=i[5],a[n+10]=s,a[n+11]=r,a[n+12]=i[6],a[n+13]=i[7],a[n+14]=s,a[n+15]=r,a[n+16]=i[8],a[n+17]=i[9],a[n+18]=s,a[n+19]=r,a[n+20]=i[10],a[n+21]=i[11],a[n+22]=s,a[n+23]=r,this._changedBuffers[6]=!0}setTextureDisabled(t){let i=24*t,s=this._texCoordArr;s[i+3]=0,s[i+7]=0,s[i+11]=0,s[i+15]=0,s[i+19]=0,s[i+23]=0,this._changedBuffers[6]=!0}setTexOffsetArr(t,i){let s=6*t,r=this._texOffsetArr;r[s]=i,r[s+1]=i,r[s+2]=i,r[s+3]=i,r[s+4]=i,r[s+5]=i,this._changedBuffers[7]=!0}setStrokeSizeArr(t,i){let s=6*t,r=this._strokeSizeArr;r[s]=i,r[s+1]=i,r[s+2]=i,r[s+3]=i,r[s+4]=i,r[s+5]=i,this._changedBuffers[8]=!0}refreshTexCoordsArr(){if(this._entityCollection&&this._renderer){let t=this._renderer.strokeTextureAtlas;for(let i=0;i<this._rays.length;i++){let s=this._rays[i],r=s.getImage();if(r){let n=t.get(r.__nodeIndex);n&&this.setTexCoordArr(s._handlerIndex,n.texCoords)}}}}};Na.__counter__=0;let Al=Na;const Va=class Ua{constructor(t){this.__id=Ua.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._strips=[]}_initProgram(){this._renderer&&this._renderer.handler&&!this._renderer.handler.programs.strip&&this._renderer.handler.addProgram(new X("strip",{uniforms:{projectionMatrix:{type:"mat4"},viewMatrix:{type:"mat4"},eyePositionHigh:"vec3",eyePositionLow:"vec3",uColor:{type:"vec4"},uOpacity:{type:"float"}},attributes:{aVertexPositionHigh:{type:"vec3"},aVertexPositionLow:{type:"vec3"}},vertexShader:`attribute vec3 aVertexPositionHigh;
                        attribute vec3 aVertexPositionLow;
                        uniform mat4 projectionMatrix;
                        uniform mat4 viewMatrix;
                        uniform vec3 eyePositionHigh;
                        uniform vec3 eyePositionLow;
                        void main(void) {

                            vec3 highDiff = aVertexPositionHigh - eyePositionHigh;
                            vec3 lowDiff = aVertexPositionLow - eyePositionLow;

                            mat4 viewMatrixRTE = viewMatrix;
                            viewMatrixRTE[3] = vec4(0.0, 0.0, 0.0, 1.0);

                            gl_Position = projectionMatrix * viewMatrixRTE * vec4(highDiff * step(1.0, length(highDiff)) + lowDiff, 1.0);
                        }`,fragmentShader:`precision highp float;
                        uniform vec4 uColor;
                        uniform float uOpacity;
                        void main(void) {
                            gl_FragColor = vec4(uColor.rgb, uColor.a * uOpacity);
                        }`}))}setRenderNode(t){this._renderer=t.renderer,this._initProgram();for(let i=0;i<this._strips.length;i++)this._strips[i].setRenderNode(t)}add(t){t._handlerIndex===-1&&(t._handler=this,t._handlerIndex=this._strips.length,this._strips.push(t),this._entityCollection&&this._entityCollection.renderNode&&t.setRenderNode(this._entityCollection.renderNode))}remove(t){let i=t._handlerIndex;i!==-1&&(t._deleteBuffers(),t._handlerIndex=-1,t._handler=null,this._strips.splice(i,1),this.reindexStripArray(i))}reindexStripArray(t){let i=this._strips;for(let s=t;s<i.length;s++)i[s]._handlerIndex=s}draw(){let t=this._strips.length;for(;t--;)this._strips[t].draw()}drawPicking(){if(this.pickingEnabled){let t=this._strips.length;for(;t--;)this._strips[t].drawPicking()}}clear(){let t=this._strips.length;for(;t--;)this._strips[t]._deleteBuffers(),this._strips[t]._handler=null,this._strips[t]._handlerIndex=-1;this._strips.length=0,this._strips=[]}};Va.__counter__=0;let El=Va;const Ga=class ja{constructor(t={}){this._onChangeRelativeCenter=s=>{this.geoObjectHandler.setRelativeCenter(s),this.polylineHandler.setRelativeCenter(s)},this.__id=ja.__counter__++,this.renderNode=null,this._visibility=t.visibility==null||t.visibility,this.polygonOffsetUnits=t.polygonOffsetUnits!=null?t.polygonOffsetUnits:0,this.billboardHandler=new yl(this),this.labelHandler=new wl(this,t.labelMaxLetters),this.polylineHandler=new Cl(this),this.rayHandler=new Al(this),this.pointCloudHandler=new Tl(this),this.stripHandler=new El(this),this.geoObjectHandler=new bl(this),t.pickingEnabled!=null&&this.setPickingEnabled(t.pickingEnabled),this._entities=[],this.scaleByDistance=t.scaleByDistance||[1,1,1];let i=new Float32Array([1,1,1]);t.pickingScale!==void 0&&(t.pickingScale instanceof Array?(i[0]=t.pickingScale[0]||i[0],i[1]=t.pickingScale[1]||i[1],i[2]=t.pickingScale[2]||i[2]):typeof t.pickingScale=="number"&&(i[0]=t.pickingScale,i[1]=t.pickingScale,i[2]=t.pickingScale)),this._depthOrder=t.depthOrder||0,this.pickingScale=i,this._opacity=t.opacity==null?1:t.opacity,this._fadingOpacity=this._opacity,this.events=this.rendererEvents=le(Ll,this),this._useLighting=t.useLighting!=null?t.useLighting?1:0:1,t.entities&&this.addEntities(t.entities)}get depthOrder(){return this._depthOrder}set depthOrder(t){this._depthOrder=t,this.renderNode&&this.renderNode.updateEntityCollectionsDepthOrder()}isEmpty(){return this._entities.length==0}get id(){return this.__id}get useLighting(){return!!this._useLighting}set useLighting(t){this._useLighting=Number(t)}isEqual(t){return t!==null&&this.__id===t.__id}setVisibility(t){var i;this._visibility=t,this._fadingOpacity=this._opacity*(t?1:0),(i=this.renderNode)==null||i.updateEntityCollectionsDepthOrder(),this.events.dispatch(this.events.visibilitychange,this)}getVisibility(){return this._visibility}setOpacity(t){this._opacity=t}setPickingEnabled(t){this.billboardHandler.pickingEnabled=t,this.labelHandler.pickingEnabled=t,this.polylineHandler.pickingEnabled=t,this.rayHandler.pickingEnabled=t,this.pointCloudHandler.pickingEnabled=t,this.stripHandler.pickingEnabled=t,this.geoObjectHandler.pickingEnabled=t}getOpacity(){return this._opacity}setScaleByDistance(t,i,s){this.scaleByDistance[0]=t,this.scaleByDistance[1]=i,this.scaleByDistance[2]=s||Tt}appendChildEntity(t){this._addRecursively(t)}_addRecursively(t){let i=this.renderNode;i&&i.ellipsoid&&t._cartesian.isZero()&&!t.relativePosition&&t.setCartesian3v(i.ellipsoid.lonLatToCartesian(t._lonLat)),this._setPickingColor(t),t._updateAbsolutePosition(),t.setScale3v(t.getScale()),t.billboard&&this.billboardHandler.add(t.billboard),t.label&&this.labelHandler.add(t.label),t.polyline&&this.polylineHandler.add(t.polyline),t.ray&&this.rayHandler.add(t.ray),t.pointCloud&&this.pointCloudHandler.add(t.pointCloud),t.strip&&this.stripHandler.add(t.strip),t.geoObject&&this.geoObjectHandler.add(t.geoObject),this.events.dispatch(this.events.entityadd,t);for(let s=0;s<t.childEntities.length;s++)t.childEntities[s]._entityCollection=this,this._addRecursively(t.childEntities[s])}add(t){return t._entityCollection||(t._entityCollection=this,t._entityCollectionIndex=this._entities.length,this._entities.push(t),this._addRecursively(t)),this}addEntities(t){for(let i=0,s=t.length;i<s;i++)this.add(t[i]);return this}belongs(t){return this.isEqual(t._entityCollection)}_removeRecursively(t){t._entityCollection=null,t._entityCollectionIndex=-1,t.billboard&&this.billboardHandler.remove(t.billboard),t.label&&this.labelHandler.remove(t.label),t.polyline&&this.polylineHandler.remove(t.polyline),t.ray&&this.rayHandler.remove(t.ray),t.pointCloud&&this.pointCloudHandler.remove(t.pointCloud),t.strip&&this.stripHandler.remove(t.strip),t.geoObject&&this.geoObjectHandler.remove(t.geoObject);for(let i=0;i<t.childEntities.length;i++)this._removeRecursively(t.childEntities[i])}_removeEntity(t){if(t.parent){let i=t.parent.childEntities;for(let s=0,r=i.length;s<r;s++)if(i[s].isEqual(t)){i.splice(s,1);break}t.parent=null}else this._entities.splice(t._entityCollectionIndex,1),this.reindexEntitiesArray(t._entityCollectionIndex);this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(t),t._pickingColor.clear()),this._removeRecursively(t)}removeEntity(t){this.belongs(t)&&(this._removeEntity(t),this.events.dispatch(this.events.entityremove,t))}_removeEntitySilent(t){this.belongs(t)&&this._removeEntity(t)}createPickingColors(t=this._entities){if(this.renderNode&&this.renderNode.renderer)for(let i=0;i<t.length;i++){let s=t[i];this._setPickingColor(s),this.createPickingColors(s.childEntities)}}_setPickingColor(t){this.renderNode&&this.renderNode.renderer&&(t._independentPicking||!t.parent?this.renderNode.renderer.assignPickingColor(t):t._pickingColor=t.parent._pickingColor,this.renderNode.renderer.assignPickingColor(t),t.setPickingColor())}reindexEntitiesArray(t){let i=this._entities;for(let s=t;s<i.length;s++)i[s]._entityCollectionIndex=s}addTo(t,i=!1){return this.renderNode||t.addEntityCollection(this,i),this}bindRenderNode(t){t.renderer&&t.renderer.isInitialized()&&(this.billboardHandler.setRenderer(t.renderer),this.labelHandler.setRenderer(t.renderer),this.rayHandler.setRenderer(t.renderer),this.geoObjectHandler.setRenderNode(t),this.polylineHandler.setRenderNode(t),this.pointCloudHandler.setRenderNode(t),this.stripHandler.setRenderNode(t),t.renderer.events.on("changerelativecenter",this._onChangeRelativeCenter),this.updateBillboardsTextureAtlas(),this.updateLabelsFontAtlas(),this.updateStrokeTextureAtlas(),this.createPickingColors())}_updateGeodeticCoordinates(t){let i=this._entities,s=i.length;for(;s--;){let r=i[s];r._lonLat&&r.setCartesian3v(t.lonLatToCartesian(r._lonLat))}}updateBillboardsTextureAtlas(){let t=this.billboardHandler.billboards;for(let i=0;i<t.length;i++)t[i].setSrc(t[i].getSrc())}updateLabelsFontAtlas(){this.renderNode&&this.labelHandler.updateFonts()}updateStrokeTextureAtlas(){this.rayHandler.reloadTextures(),this.polylineHandler.reloadTextures()}remove(){var t;this.renderNode&&(this.renderNode.removeEntityCollection(this),(t=this.renderNode.renderer)==null||t.events.off("changerelativecenter",this._onChangeRelativeCenter),this.renderNode=null,this.events.dispatch(this.events.remove,this))}getEntities(){return[].concat(this._entities)}each(t){let i=this._entities.length;for(;i--;){let s=this._entities[i];s&&t(s)}}clear(){this.billboardHandler.clear(),this.labelHandler.clear(),this.polylineHandler.clear(),this.rayHandler.clear(),this.pointCloudHandler.clear(),this.stripHandler.clear(),this.geoObjectHandler.clear();let t=this._entities.length;for(;t--;){let i=this._entities[t];this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(i),i._pickingColor.clear()),this._clearEntity(i)}this._entities.length=0,this._entities=[]}_clearEntity(t){t._entityCollection=null,t._entityCollectionIndex=-1;for(let i=0;i<t.childEntities.length;i++)this._clearEntity(t.childEntities[i])}};Ga.__counter__=0;let ht=Ga;const Ll=["draw","drawend","add","remove","entityadd","entityremove","visibilitychange","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];function rt(l,t){if(l>=0){let i=65536*Math.floor(l/65536);t[0]=Math.fround(i),t[1]=Math.fround(l-i)}else{let i=65536*Math.floor(-l/65536);t[0]=Math.fround(-i),t[1]=Math.fround(l+i)}return t}function Lr(l,t){if(l>=0){let i=65536*Math.floor(l/65536);t.x=Math.fround(i),t.y=Math.fround(l-i)}else{let i=65536*Math.floor(-l/65536);t.x=Math.fround(-i),t.y=Math.fround(l+i)}return t}function Pr(l,t,i){i=i||2;var s,r,n,a,o,h,c,d=t&&t.length,u=d?t[0]*i:l.length,_=Sr(l,0,u,i,!0),p=[];if(!_)return p;if(d&&(_=(function(f,m,g,y){var x,b,T,w=[];for(x=0,b=m.length;x<b;x++)(T=Sr(f,m[x]*y,x<b-1?m[x+1]*y:f.length,y,!1))===T.next&&(T.steiner=!0),w.push(Il(T));for(w.sort(Bl),x=0;x<w.length;x++)kl(w[x],g),g=_i(g,g.next);return g})(l,t,_,i)),l.length>80*i){s=n=l[0],r=a=l[1];for(let f=i;f<u;f+=i)(o=l[f])<s&&(s=o),(h=l[f+1])<r&&(r=h),o>n&&(n=o),h>a&&(a=h);c=Math.max(n-s,a-r)}return fi(_,p,i,s,r,c),p}function Sr(l,t,i,s,r){var n,a;if(r===(function(o,h,c,d){var u=0;for(let _=h,p=c-d;_<c;_+=d)u+=(o[p]-o[_])*(o[_+1]+o[p+1]),p=_;return u})(l,t,i,s)>0)for(n=t;n<i;n+=s)a=Rr(n,l[n],l[n+1],a);else for(n=i-s;n>=t;n-=s)a=Rr(n,l[n],l[n+1],a);return a&&xt(a,a.next)&&(pi(a),a=a.next),a}function _i(l,t){if(!l)return l;t||(t=l);var i,s=l;do if(i=!1,s.steiner||!xt(s,s.next)&&Me(s.prev,s,s.next)!==0)s=s.next;else{if(pi(s),(s=t=s.prev)===s.next)return null;i=!0}while(i||s!==t);return t}function fi(l,t,i,s,r,n,a){if(l){!a&&n&&(function(d,u,_,p){var f=d;do f.z===null&&(f.z=zs(f.x,f.y,u,_,p)),f.prevZ=f.prev,f.nextZ=f.next,f=f.next;while(f!==d);f.prevZ.nextZ=null,f.prevZ=null,(function(m){var g,y,x,b,T,w,A,E,C=1;do{for(y=m,m=null,T=null,w=0;y;){for(w++,x=y,A=0,g=0;g<C&&(A++,x=x.nextZ);g++);for(E=C;A>0||E>0&&x;)A!==0&&(E===0||!x||y.z<=x.z)?(b=y,y=y.nextZ,A--):(b=x,x=x.nextZ,E--),T?T.nextZ=b:m=b,b.prevZ=T,T=b;y=x}T.nextZ=null,C*=2}while(w>1)})(f)})(l,s,r,n);for(var o,h,c=l;l.prev!==l.next;)if(o=l.prev,h=l.next,n?Sl(l,s,r,n):Pl(l))t.push(o.i/i),t.push(l.i/i),t.push(h.i/i),pi(l),l=h.next,c=h.next;else if((l=h)===c){a?a===1?fi(l=Rl(l,t,i),t,i,s,r,n,2):a===2&&Ml(l,t,i,s,r,n):fi(_i(l),t,i,s,r,n,1);break}}}function Pl(l){var t=l.prev,i=l,s=l.next;if(Me(t,i,s)>=0)return!1;for(var r=l.next.next;r!==l.prev;){if(Wi(t.x,t.y,i.x,i.y,s.x,s.y,r.x,r.y)&&Me(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function Sl(l,t,i,s){var r=l.prev,n=l,a=l.next;if(Me(r,n,a)>=0)return!1;for(var o=r.x<n.x?r.x<a.x?r.x:a.x:n.x<a.x?n.x:a.x,h=r.y<n.y?r.y<a.y?r.y:a.y:n.y<a.y?n.y:a.y,c=r.x>n.x?r.x>a.x?r.x:a.x:n.x>a.x?n.x:a.x,d=r.y>n.y?r.y>a.y?r.y:a.y:n.y>a.y?n.y:a.y,u=zs(o,h,t,i,s),_=zs(c,d,t,i,s),p=l.nextZ;p&&p.z<=_;){if(p!==l.prev&&p!==l.next&&Wi(r.x,r.y,n.x,n.y,a.x,a.y,p.x,p.y)&&Me(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(p=l.prevZ;p&&p.z>=u;){if(p!==l.prev&&p!==l.next&&Wi(r.x,r.y,n.x,n.y,a.x,a.y,p.x,p.y)&&Me(p.prev,p,p.next)>=0)return!1;p=p.prevZ}return!0}function Rl(l,t,i){var s=l;do{var r=s.prev,n=s.next.next;!xt(r,n)&&qa(r,s,s.next,n)&&gi(r,n)&&gi(n,r)&&(t.push(r.i/i),t.push(s.i/i),t.push(n.i/i),pi(s),pi(s.next),s=l=n),s=s.next}while(s!==l);return s}function Ml(l,t,i,s,r,n){var a=l;do{for(var o=a.next.next;o!==a.prev;){if(a.i!==o.i&&zl(a,o)){var h=Ya(a,o);return a=_i(a,a.next),h=_i(h,h.next),fi(a,t,i,s,r,n),void fi(h,t,i,s,r,n)}o=o.next}a=a.next}while(a!==l)}function Bl(l,t){return l.x-t.x}function kl(l,t){if(t=(function(s,r){var n,a=r,o=s.x,h=s.y,c=-1/0;do{if(h<=a.y&&h>=a.next.y&&a.next.y!==a.y){var d=a.x+(h-a.y)*(a.next.x-a.x)/(a.next.y-a.y);if(d<=o&&d>c){if(c=d,d===o){if(h===a.y)return a;if(h===a.next.y)return a.next}n=a.x<a.next.x?a:a.next}}a=a.next}while(a!==r);if(!n)return null;if(o===c)return n.prev;var u,_=n,p=n.x,f=n.y,m=1/0;for(a=n.next;a!==_;)o>=a.x&&a.x>=p&&o!==a.x&&Wi(h<f?o:c,h,p,f,h<f?c:o,h,a.x,a.y)&&((u=Math.abs(h-a.y)/(o-a.x))<m||u===m&&a.x>n.x)&&gi(a,s)&&(n=a,m=u),a=a.next;return n})(l,t)){var i=Ya(t,l);_i(i,i.next)}}function zs(l,t,i,s,r){return(l=1431655765&((l=858993459&((l=252645135&((l=16711935&((l=32767*(l-i)/r)|l<<8))|l<<4))|l<<2))|l<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-s)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Il(l){var t=l,i=l;do t.x<i.x&&(i=t),t=t.next;while(t!==l);return i}function Wi(l,t,i,s,r,n,a,o){return(r-a)*(t-o)-(l-a)*(n-o)>=0&&(l-a)*(s-o)-(i-a)*(t-o)>=0&&(i-a)*(n-o)-(r-a)*(s-o)>=0}function zl(l,t){return l.next.i!==t.i&&l.prev.i!==t.i&&!(function(i,s){var r=i;do{if(r.i!==i.i&&r.next.i!==i.i&&r.i!==s.i&&r.next.i!==s.i&&qa(r,r.next,i,s))return!0;r=r.next}while(r!==i);return!1})(l,t)&&gi(l,t)&&gi(t,l)&&(function(i,s){var r=i,n=!1,a=(i.x+s.x)/2,o=(i.y+s.y)/2;do r.y>o!=r.next.y>o&&r.next.y!==r.y&&a<(r.next.x-r.x)*(o-r.y)/(r.next.y-r.y)+r.x&&(n=!n),r=r.next;while(r!==i);return n})(l,t)}function Me(l,t,i){return(t.y-l.y)*(i.x-t.x)-(t.x-l.x)*(i.y-t.y)}function xt(l,t){return l.x===t.x&&l.y===t.y}function qa(l,t,i,s){return!!(xt(l,t)&&xt(i,s)||xt(l,s)&&xt(i,t))||Me(l,t,i)>0!=Me(l,t,s)>0&&Me(i,s,l)>0!=Me(i,s,t)>0}function gi(l,t){return Me(l.prev,l,l.next)<0?Me(l,t,l.next)>=0&&Me(l,l.prev,t)>=0:Me(l,t,l.prev)<0||Me(l,l.next,t)<0}function Ya(l,t){var i=new Ds(l.i,l.x,l.y),s=new Ds(t.i,t.x,t.y),r=l.next,n=t.prev;return l.next=t,t.prev=l,i.next=r,r.prev=i,s.next=i,i.prev=s,n.next=s,s.prev=n,s}function Rr(l,t,i,s){var r=new Ds(l,t,i);return s?(r.next=s.next,r.prev=s,s.next.prev=r,s.next=r):(r.prev=r,r.next=r),r}function pi(l){l.next.prev=l.prev,l.prev.next=l.next,l.prevZ&&(l.prevZ.nextZ=l.nextZ),l.nextZ&&(l.nextZ.prevZ=l.prevZ)}function Ds(l,t,i){this.i=l,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Mr(l){var t=l[0][0].length,i={vertices:[],holes:[],dimensions:t},s=0;for(let r=0;r<l.length;r++){for(let n=0;n<l[r].length;n++)for(let a=0;a<t;a++)i.vertices.push(l[r][n][a]);r>0&&(s+=l[r-1].length,i.holes.push(s))}return i}function as(l,t,i){let s=l[0],r=l[1];if(s>=0){let n=65536*Math.floor(s/65536);t.x=Math.fround(n),i.x=Math.fround(s-n)}else{let n=65536*Math.floor(-s/65536);t.x=Math.fround(-n),i.x=Math.fround(s+n)}if(r>=0){let n=65536*Math.floor(r/65536);t.y=Math.fround(n),i.y=Math.fround(r-n)}else{let n=65536*Math.floor(-r/65536);t.y=Math.fround(-n),i.y=Math.fround(r+n)}}let q=new H,Y=new H,Rt=new H;const Wa=class Dt{constructor(t){this.__id=Dt.__counter__++,this._layer=t,this._handler=null,this._geometries=[],this._updatedGeometryArr=[],this._updatedGeometry={},this._removeGeometryExtentArr=[],this._removeGeometryExtents={},this._polyVerticesHighMerc=[],this._polyVerticesLowMerc=[],this._polyColors=[],this._polyPickingColors=[],this._polyIndexes=[],this._lineVerticesHighMerc=[],this._lineVerticesLowMerc=[],this._lineOrders=[],this._lineIndexes=[],this._lineColors=[],this._linePickingColors=[],this._lineThickness=[],this._lineStrokes=[],this._lineStrokeColors=[],this._polyVerticesHighBufferMerc=null,this._polyVerticesLowBufferMerc=null,this._polyColorsBuffer=null,this._polyPickingColorsBuffer=null,this._polyIndexesBuffer=null,this._lineVerticesHighBufferMerc=null,this._lineVerticesLowBufferMerc=null,this._lineColorsBuffer=null,this._linePickingColorsBuffer=null,this._lineThicknessBuffer=null,this._lineStrokesBuffer=null,this._lineStrokeColorsBuffer=null,this._lineOrdersBuffer=null,this._lineIndexesBuffer=null,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this.createPolyVerticesBuffer,this._buffersUpdateCallbacks[1]=this.createPolyIndexesBuffer,this._buffersUpdateCallbacks[2]=this.createPolyColorsBuffer,this._buffersUpdateCallbacks[3]=this.createLineVerticesBuffer,this._buffersUpdateCallbacks[4]=this.createLineIndexesBuffer,this._buffersUpdateCallbacks[5]=this.createLineOrdersBuffer,this._buffersUpdateCallbacks[6]=this.createLineColorsBuffer,this._buffersUpdateCallbacks[7]=this.createLineThicknessBuffer,this._buffersUpdateCallbacks[8]=this.createLineStrokesBuffer,this._buffersUpdateCallbacks[9]=this.createLineStrokeColorsBuffer,this._buffersUpdateCallbacks[10]=this.createPolyPickingColorsBuffer,this._buffersUpdateCallbacks[11]=this.createLinePickingColorsBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}static appendLineData(t,i,s,r,n,a,o,h,c,d,u,_,p,f,m,g,y,x){var b=0;u.length>0?(b=u[u.length-5]+9,u.push(b,b)):u.push(0,0);var T=n,w=[s.x,s.y,s.z,s.w],A=o,E=[a.x,a.y,a.z,a.w],C=[r.x,r.y,r.z,1];for(let P=0;P<t.length;P++){var M=t[P];if(M.length===0)continue;let B,k,O=b;if(i)B=M[M.length-1];else{let R=M[0],z=M[1];z||(z=R),B=[R[0]+R[0]-z[0],R[1]+R[1]-z[1]]}as(B,q,Y),h.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),c.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),y.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),x.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),d.push(1,-1,2,-2),f.push(T,T,T,T),g.push(A,A,A,A),_.push(w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3]),m.push(E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3]),p.push(C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3]);for(let R=0;R<M.length;R++)as(M[R],q,Y),h.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),c.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),y.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),x.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),d.push(1,-1,2,-2),f.push(T,T,T,T),g.push(A,A,A,A),_.push(w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3]),m.push(E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3]),p.push(C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3]),u.push(b++,b++,b++,b++);if(i)k=M[0],u.push(O,O+1,O+1,O+1);else{let R=M[M.length-1],z=M[M.length-2];z||(z=R),k=[R[0]+R[0]-z[0],R[1]+R[1]-z[1]],u.push(b-1,b-1,b-1,b-1)}as(k,q,Y),h.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),c.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),y.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),x.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),d.push(1,-1,2,-2),f.push(T,T,T,T),g.push(A,A,A,A),_.push(w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3]),m.push(E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3]),p.push(C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3]),P<t.length-1&&(b+=8,u.push(b,b))}}assignHandler(t){this._handler=t,this.refresh(),t.isInitialized()&&this.update()}add(t){if(t._handlerIndex===-1){t._handler=this,t._handlerIndex=this._geometries.length,this._geometries.push(t);let i=t._entity._pickingColor.scaleTo(1/255);if(t._polyVerticesHighMerc=[],t._polyVerticesLowMerc=[],t._lineVerticesHighMerc=[],t._lineVerticesLowMerc=[],t._coordinates[0].length){if(t.type===ei.POLYGON){let s=t._coordinates,r=[];for(let d=0;d<s.length;d++){r[d]=[];for(let u=0;u<s[d].length;u++)r[d][u]=[Kt(s[d][u][0]),Jt(s[d][u][1])]}let n=Mr(r),a=Pr(n.vertices,n.holes,2);t._polyVerticesHandlerIndex=this._polyVerticesHighMerc.length,t._polyIndexesHandlerIndex=this._polyIndexes.length;for(let d=0;d<a.length;d++)this._polyIndexes.push(a[d]+.5*t._polyVerticesHandlerIndex);let o=t._style.fillColor,h=[],c=[];for(let d=0;d<.5*n.vertices.length;d++)this._polyColors.push(o.x,o.y,o.z,o.w),this._polyPickingColors.push(i.x,i.y,i.z,1);for(let d=0;d<n.vertices.length;d++)Lr(n.vertices[d],Rt),h[d]=Rt.x,c[d]=Rt.y;t._polyVerticesHighMerc=h,t._polyVerticesLowMerc=c,this._polyVerticesHighMerc.push.apply(this._polyVerticesHighMerc,h),this._polyVerticesLowMerc.push.apply(this._polyVerticesLowMerc,c),t._polyVerticesLength=n.vertices.length,t._polyIndexesLength=a.length,t._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,t._lineOrdersHandlerIndex=this._lineOrders.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._lineColorsHandlerIndex=this._lineColors.length,t._lineThicknessHandlerIndex=this._lineThickness.length,Dt.appendLineData(r,!0,t._style.lineColor,i,t._style.lineWidth,t._style.strokeColor,t._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,t._lineVerticesHighMerc,t._lineVerticesLowMerc),t._lineVerticesLength=this._lineVerticesHighMerc.length-t._lineVerticesHandlerIndex,t._lineOrdersLength=this._lineOrders.length-t._lineOrdersHandlerIndex,t._lineIndexesLength=this._lineIndexes.length-t._lineIndexesHandlerIndex,t._lineColorsLength=this._lineColors.length-t._lineColorsHandlerIndex,t._lineThicknessLength=this._lineThickness.length-t._lineThicknessHandlerIndex}else if(t.type===ei.MULTIPOLYGON){let s=t._coordinates,r=[],n=[];t._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,t._lineOrdersHandlerIndex=this._lineOrders.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._lineColorsHandlerIndex=this._lineColors.length,t._lineThicknessHandlerIndex=this._lineThickness.length;for(let c=0;c<s.length;c++){let d=s[c],u=[];for(let f=0;f<d.length;f++){u[f]=[];for(let m=0;m<s[c][f].length;m++)u[f][m]=[Kt(d[f][m][0]),Jt(d[f][m][1])]}let _=Mr(u),p=Pr(_.vertices,_.holes,2);for(let f=0;f<p.length;f++)n.push(p[f]+.5*r.length);r.push.apply(r,_.vertices),Dt.appendLineData(u,!0,t._style.lineColor,i,t._style.lineWidth,t._style.strokeColor,t._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,t._lineVerticesHighMerc,t._lineVerticesLowMerc)}t._polyVerticesHandlerIndex=this._polyVerticesHighMerc.length,t._polyIndexesHandlerIndex=this._polyIndexes.length;for(let c=0;c<n.length;c++)this._polyIndexes.push(n[c]+.5*t._polyVerticesHandlerIndex);let a=t._style.fillColor,o=[],h=[];for(let c=0;c<.5*r.length;c++)this._polyColors.push(a.x,a.y,a.z,a.w),this._polyPickingColors.push(i.x,i.y,i.z,1);for(let c=0;c<r.length;c++)Lr(r[c],Rt),o[c]=Rt.x,h[c]=Rt.y;t._polyVerticesHighMerc=o,t._polyVerticesLowMerc=h,this._polyVerticesHighMerc.push.apply(this._polyVerticesHighMerc,o),this._polyVerticesLowMerc.push.apply(this._polyVerticesLowMerc,h),t._polyVerticesLength=r.length,t._polyIndexesLength=n.length,t._lineVerticesLength=this._lineVerticesHighMerc.length-t._lineVerticesHandlerIndex,t._lineOrdersLength=this._lineOrders.length-t._lineOrdersHandlerIndex,t._lineIndexesLength=this._lineIndexes.length-t._lineIndexesHandlerIndex,t._lineColorsLength=this._lineColors.length-t._lineColorsHandlerIndex,t._lineThicknessLength=this._lineThickness.length-t._lineThicknessHandlerIndex}else if(t.type===ei.LINESTRING){let s=t._coordinates,r=new Array(s.length);for(let n=0;n<s.length;n++)r[n]=[Kt(s[n][0]),Jt(s[n][1])];t._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,t._lineOrdersHandlerIndex=this._lineOrders.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._lineColorsHandlerIndex=this._lineColors.length,t._lineThicknessHandlerIndex=this._lineThickness.length,Dt.appendLineData([r],!1,t._style.lineColor,i,t._style.lineWidth,t._style.strokeColor,t._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,t._lineVerticesHighMerc,t._lineVerticesLowMerc),t._lineVerticesLength=this._lineVerticesHighMerc.length-t._lineVerticesHandlerIndex,t._lineOrdersLength=this._lineOrders.length-t._lineOrdersHandlerIndex,t._lineIndexesLength=this._lineIndexes.length-t._lineIndexesHandlerIndex,t._lineColorsLength=this._lineColors.length-t._lineColorsHandlerIndex,t._lineThicknessLength=this._lineThickness.length-t._lineThicknessHandlerIndex}else if(t.type===ei.MULTILINESTRING){let s=t._coordinates,r=[];for(let n=0;n<s.length;n++){r[n]=[];for(let a=0;a<s[n].length;a++)r[n][a]=[Kt(s[n][a][0]),Jt(s[n][a][1])]}t._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,t._lineOrdersHandlerIndex=this._lineOrders.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._lineColorsHandlerIndex=this._lineColors.length,t._lineThicknessHandlerIndex=this._lineThickness.length,Dt.appendLineData(r,!1,t._style.lineColor,i,t._style.lineWidth,t._style.strokeColor,t._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,t._lineVerticesHighMerc,t._lineVerticesLowMerc),t._lineVerticesLength=this._lineVerticesHighMerc.length-t._lineVerticesHandlerIndex,t._lineOrdersLength=this._lineOrders.length-t._lineOrdersHandlerIndex,t._lineIndexesLength=this._lineIndexes.length-t._lineIndexesHandlerIndex,t._lineColorsLength=this._lineColors.length-t._lineColorsHandlerIndex,t._lineThicknessLength=this._lineThickness.length-t._lineThicknessHandlerIndex}}this.setGeometryVisibility(t),!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0,this.refresh()}}remove(t){const i=t._handlerIndex;if(i!==-1){this._geometries.splice(i,1),this._polyVerticesHighMerc.splice(t._polyVerticesHandlerIndex,t._polyVerticesLength),this._polyVerticesLowMerc.splice(t._polyVerticesHandlerIndex,t._polyVerticesLength),this._polyColors.splice(2*t._polyVerticesHandlerIndex,2*t._polyVerticesLength),this._polyPickingColors.splice(2*t._polyVerticesHandlerIndex,2*t._polyVerticesLength),this._polyIndexes.splice(t._polyIndexesHandlerIndex,t._polyIndexesLength);let s=.5*t._polyVerticesLength;for(let n=t._polyIndexesHandlerIndex;n<this._polyIndexes.length;n++)this._polyIndexes[n]-=s;this._lineVerticesHighMerc.splice(t._lineVerticesHandlerIndex,t._lineVerticesLength),this._lineVerticesLowMerc.splice(t._lineVerticesHandlerIndex,t._lineVerticesLength),this._lineOrders.splice(t._lineOrdersHandlerIndex,t._lineOrdersLength),this._lineColors.splice(t._lineColorsHandlerIndex,t._lineColorsLength),this._linePickingColors.splice(t._lineColorsHandlerIndex,t._lineColorsLength),this._lineStrokeColors.splice(t._lineColorsHandlerIndex,t._lineColorsLength),this._lineThickness.splice(t._lineThicknessHandlerIndex,t._lineThicknessLength),this._lineStrokes.splice(t._lineThicknessHandlerIndex,t._lineThicknessLength),this._lineIndexes.splice(t._lineIndexesHandlerIndex,t._lineIndexesLength),s=.5*t._lineVerticesLength;for(let n=t._lineIndexesHandlerIndex;n<this._lineIndexes.length;n++)this._lineIndexes[n]-=s;let r=this._geometries;for(let n=i;n<r.length;n++){let a=r[n];a._handlerIndex=n,a._polyVerticesHandlerIndex-=t._polyVerticesLength,a._polyIndexesHandlerIndex-=t._polyIndexesLength,a._lineVerticesHandlerIndex-=t._lineVerticesLength,a._lineOrdersHandlerIndex-=t._lineOrdersLength,a._lineColorsHandlerIndex-=t._lineColorsLength,a._lineThicknessHandlerIndex-=t._lineThicknessLength,a._lineIndexesHandlerIndex-=t._lineIndexesLength}t._pickingReady=!1,t._handler=null,t._handlerIndex=-1,t._polyVerticesHighMerc=[],t._polyVerticesLowMerc=[],t._polyVerticesLength=-1,t._polyIndexesLength=-1,t._polyVerticesHandlerIndex=-1,t._polyIndexesHandlerIndex=-1,t._lineVerticesHighMerc=[],t._lineVerticesLowMerc=[],t._lineVerticesLength=-1,t._lineOrdersLength=-1,t._lineIndexesLength=-1,t._lineColorsLength=-1,t._lineThicknessLength=-1,t._lineVerticesHandlerIndex=-1,t._lineOrdersHandlerIndex=-1,t._lineIndexesHandlerIndex=-1,t._lineThicknessHandlerIndex=-1,t._lineColorsHandlerIndex=-1,!this._removeGeometryExtents[t.__id]&&this._removeGeometryExtentArr.push(t.getExtent()),this._removeGeometryExtents[t.__id]=!0,this.refresh()}}_refreshRecursevely(t,i){if(i.ready){let s=this._layer._id;for(let r=0;r<i.nodes.length;r++){let n=i.nodes[r];if(t.overlaps(n.segment.getExtentLonLat())){this._refreshRecursevely(t,n);let a=n.segment.materials[s];a&&a.isReady&&(a.segment.node.getState()!==1?a.layer.clearMaterial(a):(a.pickingReady=a.pickingReady&&t._pickingReady,a.isReady=!1,a._updateTexture=a.texture,a._updatePickingMask=a.pickingMask),t._pickingReady=!0)}}}}_refreshRecursevelyExt(t,i){if(i.ready){let s=this._layer.__id;for(let r=0;r<i.nodes.length;r++){let n=i.nodes[r];if(t.overlaps(n.segment.getExtentLonLat())){this._refreshRecursevelyExt(t,n);let a=n.segment.materials[s];a&&a.isReady&&a.layer.clearMaterial(a)}}}}_refreshPlanetNode(t){let i,s=this._removeGeometryExtentArr;for(i=0;i<s.length;i++)this._refreshRecursevelyExt(s[i],t);let r=this._updatedGeometryArr;for(i=0;i<r.length;i++)this._refreshRecursevely(r[i],t)}_updatePlanet(){let t=this._layer._planet;if(t){let i=t.quadTreeStrategy.quadTreeList;for(let s=0;s<i.length;s++)this._refreshPlanetNode(i[s])}this._updatedGeometryArr.length=0,this._updatedGeometryArr=[],this._updatedGeometry={},this._removeGeometryExtentArr.length=0,this._removeGeometryExtentArr=[],this._removeGeometryExtents={}}refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}update(){if(this._handler){let t=!1,i=this._changedBuffers.length;for(;i--;)this._changedBuffers[i]&&(t=!0,this._buffersUpdateCallbacks[i].call(this),this._changedBuffers[i]=!1);t&&this._updatePlanet()}}setGeometryVisibility(t){let i=t.getVisibility()?1:0,s=this._polyVerticesHighMerc,r=this._polyVerticesLowMerc,n=t._polyVerticesLength,a=t._polyVerticesHandlerIndex;for(let o=0;o<n;o++)s[a+o]=t._polyVerticesHighMerc[o]*i,r[a+o]=t._polyVerticesLowMerc[o]*i;s=this._lineVerticesHighMerc,r=this._lineVerticesLowMerc,n=t._lineVerticesLength,a=t._lineVerticesHandlerIndex;for(let o=0;o<n;o++)s[a+o]=t._lineVerticesHighMerc[o]*i,r[a+o]=t._lineVerticesLowMerc[o]*i;this._changedBuffers[0]=!0,this._changedBuffers[3]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}setPolyColorArr(t,i){let s=2*t._polyVerticesHandlerIndex,r=s+2*t._polyVerticesLength,n=this._polyColors;for(let a=s;a<r;a+=4)n[a]=i.x,n[a+1]=i.y,n[a+2]=i.z,n[a+3]=i.w;this._changedBuffers[2]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}setLineStrokeColorArr(t,i){let s=t._lineColorsHandlerIndex,r=s+t._lineColorsLength,n=this._lineStrokeColors;for(let a=s;a<r;a+=4)n[a]=i.x,n[a+1]=i.y,n[a+2]=i.z,n[a+3]=i.w;this._changedBuffers[9]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}setLineColorArr(t,i){let s=t._lineColorsHandlerIndex,r=s+t._lineColorsLength,n=this._lineColors;for(let a=s;a<r;a+=4)n[a]=i.x,n[a+1]=i.y,n[a+2]=i.z,n[a+3]=i.w;this._changedBuffers[6]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}setLineStrokeArr(t,i){}setLineThicknessArr(t,i){let s=t._lineThicknessHandlerIndex,r=s+t._lineThicknessLength,n=this._lineThickness;for(let a=s;a<r;a++)n[a]=i;this._changedBuffers[7]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}bringToFront(t){let i=this._polyIndexes.splice(t._polyIndexesHandlerIndex,t._polyIndexesLength),s=this._lineIndexes.splice(t._lineIndexesHandlerIndex,t._lineIndexesLength);this._geometries.splice(t._handlerIndex,1);let r=this._geometries;for(let n=t._handlerIndex;n<r.length;n++){let a=r[n];a._handlerIndex=n,a._polyIndexesHandlerIndex-=t._polyIndexesLength,a._lineIndexesHandlerIndex-=t._lineIndexesLength}t._polyIndexesHandlerIndex=this._polyIndexes.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._handlerIndex=this._geometries.length,this._geometries.push(t),this._polyIndexes.push.apply(this._polyIndexes,i),this._lineIndexes.push.apply(this._lineIndexes,s),this._changedBuffers[1]=!0,this._changedBuffers[4]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}createPolyVerticesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._polyVerticesHighBufferMerc),this._polyVerticesHighBufferMerc=t.createArrayBuffer(new Float32Array(this._polyVerticesHighMerc),2,this._polyVerticesHighMerc.length/2),t.gl.deleteBuffer(this._polyVerticesLowBufferMerc),this._polyVerticesLowBufferMerc=t.createArrayBuffer(new Float32Array(this._polyVerticesLowMerc),2,this._polyVerticesLowMerc.length/2)}createPolyIndexesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._polyIndexesBuffer),this._polyIndexesBuffer=t.createElementArrayBuffer(new Uint32Array(this._polyIndexes),1,this._polyIndexes.length)}createPolyColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._polyColorsBuffer),this._polyColorsBuffer=t.createArrayBuffer(new Float32Array(this._polyColors),4,this._polyColors.length/4)}createPolyPickingColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._polyPickingColorsBuffer),this._polyPickingColorsBuffer=t.createArrayBuffer(new Float32Array(this._polyPickingColors),4,this._polyPickingColors.length/4)}createLineVerticesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineVerticesHighBufferMerc),this._lineVerticesHighBufferMerc=t.createArrayBuffer(new Float32Array(this._lineVerticesHighMerc),2,this._lineVerticesHighMerc.length/2),t.gl.deleteBuffer(this._lineVerticesLowBufferMerc),this._lineVerticesLowBufferMerc=t.createArrayBuffer(new Float32Array(this._lineVerticesLowMerc),2,this._lineVerticesLowMerc.length/2)}createLineIndexesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineIndexesBuffer),this._lineIndexesBuffer=t.createElementArrayBuffer(new Uint32Array(this._lineIndexes),1,this._lineIndexes.length)}createLineOrdersBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineOrdersBuffer),this._lineOrdersBuffer=t.createArrayBuffer(new Float32Array(this._lineOrders),1,this._lineOrders.length/2)}createLineColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineColorsBuffer),this._lineColorsBuffer=t.createArrayBuffer(new Float32Array(this._lineColors),4,this._lineColors.length/4)}createLinePickingColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._linePickingColorsBuffer),this._linePickingColorsBuffer=t.createArrayBuffer(new Float32Array(this._linePickingColors),4,this._linePickingColors.length/4)}createLineThicknessBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineThicknessBuffer),this._lineThicknessBuffer=t.createArrayBuffer(new Float32Array(this._lineThickness),1,this._lineThickness.length)}createLineStrokesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineStrokesBuffer),this._lineStrokesBuffer=t.createArrayBuffer(new Float32Array(this._lineStrokes),1,this._lineStrokes.length)}createLineStrokeColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineStrokeColorsBuffer),this._lineStrokeColorsBuffer=t.createArrayBuffer(new Float32Array(this._lineStrokeColors),4,this._lineStrokeColors.length/4)}clear(){this._geometries=[],this._polyVerticesHighMerc=[],this._polyVerticesLowMerc=[],this._polyIndexes=[],this._polyColors=[],this._polyPickingColors=[],this._lineVerticesHighMerc=[],this._lineVerticesLowMerc=[],this._lineOrders=[],this._lineIndexes=[],this._lineColors=[],this._linePickingColors=[],this._lineThickness=[],this._lineStrokeColors=[],this._lineStrokes=[],this._deleteBuffers(),this._polyVerticesHighBufferMerc=null,this._polyVerticesLowBufferMerc=null,this._polyIndexesBuffer=null,this._polyColorsBuffer=null,this._polyPickingColorsBuffer=null,this._lineVerticesHighBufferMerc=null,this._lineVerticesLowBufferMerc=null,this._lineIndexesBuffer=null,this._lineOrdersBuffer=null,this._lineColorsBuffer=null,this._linePickingColorsBuffer=null,this._lineThicknessBuffer=null,this._lineStrokeColorsBuffer=null,this._lineStrokesBuffer=null,this._updatedGeometryArr=[],this._updatedGeometry={},this._removeGeometryExtentArr=[],this._removeGeometryExtents={},this.refresh()}_deleteBuffers(){if(this._layer._planet&&this._layer._planet.renderer){let t=this._layer._planet.renderer.handler.gl;t&&(t.deleteBuffer(this._polyVerticesHighBufferMerc),t.deleteBuffer(this._polyVerticesLowBufferMerc),t.deleteBuffer(this._polyIndexesBuffer),t.deleteBuffer(this._polyColorsBuffer),t.deleteBuffer(this._polyPickingColorsBuffer),t.deleteBuffer(this._lineVerticesHighBufferMerc),t.deleteBuffer(this._lineVerticesLowBufferMerc),t.deleteBuffer(this._lineIndexesBuffer),t.deleteBuffer(this._lineOrdersBuffer),t.deleteBuffer(this._lineColorsBuffer),t.deleteBuffer(this._linePickingColorsBuffer),t.deleteBuffer(this._lineThicknessBuffer),t.deleteBuffer(this._lineStrokeColorsBuffer),t.deleteBuffer(this._lineStrokesBuffer))}}};Wa.__counter__=0;let Dl=Wa;class ue extends Ve{constructor(t,i={}){super(t,i),this.events=this.events.registerNames(Fl),this.isVector=!0,this._hasImageryTiles=!1,this.scaleByDistance=i.scaleByDistance||[Tt,Tt,Tt],this._useLighting=i.useLighting===void 0||i.useLighting;let s=new Float32Array([1,1,1]);i.pickingScale!==void 0&&(i.pickingScale instanceof Array?(s[0]=i.pickingScale[0]||s[0],s[1]=i.pickingScale[1]||s[1],s[2]=i.pickingScale[2]||s[2]):typeof i.pickingScale=="number"&&(s[0]=i.pickingScale,s[1]=i.pickingScale,s[2]=i.pickingScale)),this.pickingScale=s,this.async=i.async===void 0||i.async,this.clampToGround=i.clampToGround||!1,this.relativeToGround=i.relativeToGround||!1,this._entities=(function(r){let n=[];for(let a=0;a<r.length;a++){let o=r[a];o.instanceName==="Entity"?n.push(o):n.push(new U(o))}return n})(i.entities||[]),this._labelMaxLetters=i.labelMaxLetters||24,this._stripEntityCollection=new ht({pickingEnabled:this.pickingEnabled}),this._bindEventsDefault(this._stripEntityCollection),this._polylineEntityCollection=new ht({pickingEnabled:this.pickingEnabled}),this._bindEventsDefault(this._polylineEntityCollection),this._geoObjectEntityCollection=new ht({pickingEnabled:this.pickingEnabled,useLighting:this._useLighting}),this._bindEventsDefault(this._geoObjectEntityCollection),this._geometryHandler=new Dl(this),this._nodeCapacity=i.nodeCapacity||60,this._entityCollectionsTreeStrategy=null,this.setEntities(this._entities),this.polygonOffsetUnits=i.polygonOffsetUnits!=null?i.polygonOffsetUnits:0,this.pickingEnabled=this._pickingEnabled,this._depthOrder=i.depthOrder||0}get depthOrder(){return this._depthOrder}set depthOrder(t){t!==this._depthOrder&&(this._depthOrder=t,this._planet&&this._planet.updateVisibleLayers())}get useLighting(){return this._useLighting}set useLighting(t){t!==this._useLighting&&(this._geoObjectEntityCollection.useLighting=t,this._useLighting=t)}get labelMaxLetters(){return this._labelMaxLetters}get instanceName(){return"Vector"}_bindPicking(){this._pickingColor.clear()}addTo(t){this._planet||(this._assignPlanet(t),this._geometryHandler.assignHandler(t.renderer.handler),this._polylineEntityCollection.addTo(t,!0),this._stripEntityCollection.addTo(t,!0),this._geoObjectEntityCollection.addTo(t,!0),this._polylineEntityCollection._layer=this,this._stripEntityCollection._layer=this,this._geoObjectEntityCollection._layer=this,this.setEntities(this._entities))}remove(){return super.remove(),this._polylineEntityCollection.remove(),this._stripEntityCollection.remove(),this._geoObjectEntityCollection.remove(),this._polylineEntityCollection._layer=void 0,this._stripEntityCollection._layer=void 0,this._geoObjectEntityCollection._layer=void 0,this}getEntities(){return[].concat(this._entities)}add(t){return t._layer||t._entityCollection||(t._layer=this,t._layerIndex=this._entities.length,this._entities.push(t),this._proceedEntity(t)),this}insert(t,i){if(!t._layer&&!t._entityCollection){t._layer=this,t._layerIndex=i,this._entities.splice(i,0,t);for(let s=i+1,r=this._entities.length;s<r;s++)this._entities[s]._layerIndex=s;this._proceedEntity(t)}return this}_proceedEntity(t){var i;let s=this._hasImageryTiles;t.strip&&this._stripEntityCollection.add(t),(t.polyline||t.ray)&&this._polylineEntityCollection.add(t),(t.geoObject||t.isEmpty)&&this._geoObjectEntityCollection.add(t),t.geometry&&(this._hasImageryTiles=!0,this._planet&&(this._planet.renderer.assignPickingColor(t),this._geometryHandler.add(t.geometry))),this._planet&&((t.billboard||t.label||t.geoObject||t.isEmpty)&&(t._cartesian.isZero()&&!t._lonLat.isZero()?t._setCartesian3vSilent(this._planet.ellipsoid.lonLatToCartesian(t._lonLat)):(t._lonLat=this._planet.ellipsoid.cartesianToLonLat(t._cartesian),Math.abs(t._lonLat.lat)<ce?t._lonLatMerc=t._lonLat.forwardMercator():t._lonLatMerc.lon=t._lonLatMerc.lat=t._lonLatMerc.height=0)),(t.billboard||t.label)&&((i=this._entityCollectionsTreeStrategy)==null||i.insertEntity(t))),this._planet&&this._hasImageryTiles!==s&&this._planet.updateVisibleLayers(),this.events.dispatch(this.events.entityadd,t)}addEntities(t){let i=t.length;for(;i--;)this.add(t[i]);return this}removeEntity(t){if(t._layer&&this.isEqual(t._layer)){if(t.parent||(this._entities.splice(t._layerIndex,1),this._reindexEntitiesArray(t._layerIndex)),t._layer=null,t._layerIndex=-1,t._entityCollection){t._entityCollection._removeEntitySilent(t);let i=t._nodePtr;for(;i;)i.count--,i=i.parentNode;t._nodePtr&&t._nodePtr.count===0&&t._nodePtr.deferredEntities.length===0&&(t._nodePtr.entityCollection=null)}else if(t._nodePtr&&t._nodePtr.deferredEntities.length){let i=t._nodePtr.deferredEntities,s=i.length;for(;s--;)if(i[s].id===t.id){i.splice(s,1);let r=t._nodePtr;for(;r;)r.count--,r=r.parentNode;break}}this._planet&&t.geometry&&(this._geometryHandler.remove(t.geometry),this._planet.renderer.clearPickingColor(t)),t._nodePtr=void 0,this.events.dispatch(this.events.entityremove,t)}return this}set pickingEnabled(t){var i;this._pickingEnabled=t,this._stripEntityCollection.setPickingEnabled(t),this._polylineEntityCollection.setPickingEnabled(t),this._geoObjectEntityCollection.setPickingEnabled(t),(i=this._entityCollectionsTreeStrategy)==null||i.setPickingEnabled(t)}_reindexEntitiesArray(t){const i=this._entities;for(let s=t;s<i.length;s++)i[s]._layerIndex=s}removeEntities(t){let i=t.length;for(;i--;)this.removeEntity(t[i]);return this}clear(){var t;super.clear();let i=new Array(this._entities.length);for(let r=0;r<i.length;r++)i[r]=this._entities[r];let s=this._entities.length;for(;s--;)this._entities[s].remove();this._entities.length=0,this._entities=[];for(let r=0;r<i.length;r++)this._entities[r]=i[r];(t=this._entityCollectionsTreeStrategy)==null||t.dispose(),this._entityCollectionsTreeStrategy=null,this._geometryHandler.clear()}each(t){let i=this._entities,s=i.length;for(;s--;)t(i[s],s)}setEntities(t){let i=new Array(t.length);for(let r=0,n=t.length;r<n;r++)i[r]=t[r];this.clear(),this._entities=new Array(i.length);let s=[];for(let r=0;r<i.length;r++){let n=i[r];n._layer=this,n._layerIndex=r;let a=!(n.strip||n.polyline||n.ray||n.geoObject||n.billboard||n.label);n.strip?this._stripEntityCollection.add(n):n.polyline||n.ray?this._polylineEntityCollection.add(n):n.geoObject||a?this._geoObjectEntityCollection.add(n):(n.billboard||n.label)&&s.push(n),n.geometry&&(this._hasImageryTiles=!0,this._planet&&(this._planet.renderer.assignPickingColor(n),this._geometryHandler.add(n.geometry))),this._entities[r]=n}return this._createEntityCollectionsTree(s),this}_createEntityCollectionsTree(t){this._planet&&(this._entityCollectionsTreeStrategy=this._planet.quadTreeStrategy.createEntityCollectionsTreeStrategy(this,this._nodeCapacity),this._entityCollectionsTreeStrategy.insertEntities(t))}_bindEventsDefault(t){let i=this.events;t.events.on("mousemove",(s=>{i.dispatch(i.mousemove,s)})),t.events.on("mouseenter",(s=>{i.dispatch(i.mouseenter,s)})),t.events.on("mouseleave",(s=>{i.dispatch(i.mouseleave,s)})),t.events.on("lclick",(s=>{i.dispatch(i.lclick,s)})),t.events.on("rclick",(s=>{i.dispatch(i.rclick,s)})),t.events.on("mclick",(s=>{i.dispatch(i.mclick,s)})),t.events.on("ldblclick",(s=>{i.dispatch(i.ldblclick,s)})),t.events.on("rdblclick",(s=>{i.dispatch(i.rdblclick,s)})),t.events.on("mdblclick",(s=>{i.dispatch(i.mdblclick,s)})),t.events.on("lup",(s=>{i.dispatch(i.lup,s)})),t.events.on("rup",(s=>{i.dispatch(i.rup,s)})),t.events.on("mup",(s=>{i.dispatch(i.mup,s)})),t.events.on("ldown",(s=>{i.dispatch(i.ldown,s)})),t.events.on("rdown",(s=>{i.dispatch(i.rdown,s)})),t.events.on("mdown",(s=>{i.dispatch(i.mdown,s)})),t.events.on("lhold",(s=>{i.dispatch(i.lhold,s)})),t.events.on("rhold",(s=>{i.dispatch(i.rhold,s)})),t.events.on("mhold",(s=>{i.dispatch(i.mhold,s)})),t.events.on("mousewheel",(s=>{i.dispatch(i.mousewheel,s)})),t.events.on("touchmove",(s=>{i.dispatch(i.touchmove,s)})),t.events.on("touchstart",(s=>{i.dispatch(i.touchstart,s)})),t.events.on("touchend",(s=>{i.dispatch(i.touchend,s)})),t.events.on("doubletouch",(s=>{i.dispatch(i.doubletouch,s)})),t.events.on("touchleave",(s=>{i.dispatch(i.touchleave,s)})),t.events.on("touchenter",(s=>{i.dispatch(i.touchenter,s)}))}_collectStripCollectionPASS(t){let i=this._stripEntityCollection;i._fadingOpacity=this._fadingOpacity,i.scaleByDistance=this.scaleByDistance,i.pickingScale=this.pickingScale,i.polygonOffsetUnits=this.polygonOffsetUnits,t.push(i)}_collectPolylineCollectionPASS(t){let i=this._polylineEntityCollection;if(i._fadingOpacity=this._fadingOpacity,i.scaleByDistance=this.scaleByDistance,i.pickingScale=this.pickingScale,i.polygonOffsetUnits=this.polygonOffsetUnits,t.push(i),this.clampToGround||this.relativeToGround){let s=Number(this.relativeToGround);const r=this._planet.quadTreeStrategy._renderedNodes,n=this._planet.getViewExtent();let a=i._entities,o=a.length,h=new v;for(;o--;){let c=a[o]._altitude||0,d=a[o].polyline;if(d&&n.overlaps(d._extent)){let u=d._pathLonLatMerc,_=u.length;for(;_--;){let p=u[_].length;for(;p--;){let f=u[_][p],m=r.length;for(;m--;){let g=r[m].segment;if(g._extent.isInside(f)){let y=d._path3v[_][p];g.getTerrainPoint(y,f,h);let x=s&&d.altitude||c;if(x){let b=this._planet.ellipsoid.getSurfaceNormal3v(h);d.setPoint3v(h.addA(b.scale(x)),p,_,!0)}else d.setPoint3v(h,p,_,!0);break}}}}}}}}_collectGeoObjectCollectionPASS(t){let i=this._geoObjectEntityCollection;i._fadingOpacity=this._fadingOpacity,i.scaleByDistance=this.scaleByDistance,i.pickingScale=this.pickingScale,i.polygonOffsetUnits=this.polygonOffsetUnits,t.push(i)}collectVisibleCollections(t){let i=this._planet;(this._fading&&this._fadingOpacity>0||this.minZoom<=i.quadTreeStrategy.maxCurrZoom&&this.maxZoom>=i.quadTreeStrategy.maxCurrZoom)&&(this._collectStripCollectionPASS(t),this._collectPolylineCollectionPASS(t),this._collectGeoObjectCollectionPASS(t),this._entityCollectionsTreeStrategy&&this._entityCollectionsTreeStrategy.collectVisibleEntityCollections(t))}loadMaterial(t){const i=t.segment;this._isBaseLayer?t.texture=i._isNorth?i.planet.solidTextureOne:i.planet.solidTextureTwo:t.texture=i.planet.transparentTexture,this._planet.layerLock.isFree()&&(t.isReady=!1,t.isLoading=!0,this._planet._vectorTileCreator.add(t))}abortMaterialLoading(t){t.isLoading=!1,t.isReady=!1}applyMaterial(t){if(t.isReady)return[0,0,1,1];{!t.isLoading&&this.loadMaterial(t);const i=t.segment;let s=i.node,r=!1,n=this.__id,a=t;for(;s.parentNode;){if(a&&a.isReady){r=!0;break}s=s.parentNode,a=s.segment.materials[n]}if(r){t.appliedNodeId=s.nodeId,t.texture=a.texture,t.pickingMask=a.pickingMask;const o=1/(2<<i.tileZoom-s.segment.tileZoom-1);return[i.tileX*o-s.segment.tileX,i.tileY*o-s.segment.tileY,o,o]}return t.textureExists&&t._updateTexture?(t.texture=t._updateTexture,t.pickingMask=t._updatePickingMask):(t.texture=i.planet.transparentTexture,t.pickingMask=i.planet.transparentTexture),t.pickingReady=!0,[0,0,1,1]}}clearMaterial(t){if(t.isReady){const i=t.segment.handler.gl;t.isReady=!1,t.pickingReady=!1;let s=t.texture;t.texture=null,s&&!s.default&&i.deleteTexture(s),s=t.pickingMask,t.pickingMask=null,s&&!s.default&&i.deleteTexture(s),s=t._updateTexture,t._updateTexture=null,s&&!s.default&&i.deleteTexture(s),s=t._updatePickingMask,t._updatePickingMask=null,s&&!s.default&&i.deleteTexture(s)}this.abortMaterialLoading(t),t.isLoading=!1,t.textureExists=!1}update(){this._geometryHandler.update(),this.events.dispatch(this.events.draw,this)}}const Fl=["draw","entityadd","entityremove"],Ol=["change","startpoint"],Br=$.createCylinder(1,1,2,20,1,!0,!1,0,-.5,0),Re=200,li=.3;class $a extends lt{constructor(t){super(t.name),this._cornerDblClick=!1,this._onChange=i=>{if(i.geometryType==="POLYGON"){let s=this.getCoordinates(),r=new U({geometry:{type:i.geometryType,coordinates:[s],style:this._fillStyle}});this._geometryLayer.clear(),this._geometryLayer.add(r)}},this._onCornerMouseEnter=i=>{i.renderer.handler.canvas.style.cursor="pointer",this.hideGhostPointer()},this._onCornerMouseLeave=i=>{i.renderer.handler.canvas.style.cursor="default",this.showGhostPointer()},this._onCenterMouseEnter=i=>{i.renderer.handler.canvas.style.cursor="pointer",this.hideGhostPointer()},this._onCenterMouseLeave=i=>{i.renderer.handler.canvas.style.cursor="default",this._pickedCenter||this._pickedCorner||this.showGhostPointer()},this._onLup=i=>{this._planet.renderer.controls.mouseNavigation.activate(),(this._pickedCorner||this._pickedCenter)&&(this.events.dispatch(this.events.change,this),this.setGhostPointerPosition(this._planet.getCartesianFromPixelTerrain(i)),this.showGhostPointer(),this._pickedCorner=null,this._pickedCenter=null)},this._onCornerLdown=i=>{this._pickedCorner=this._getLdown(i)},this._onCenterLdown=i=>{this._pickedCenter=this._getLdown(i)},this._onMouseMove=i=>{this._pickedCenter?this._moveCenterPoint():this._pickedCorner?this._moveCornerPoint(i.pos):this.setGhostPointerPosition(this._planet.getCartesianFromPixelTerrain(i.pos))},this._onCornerLdblclick=i=>{this._cornerDblClick=!0;let s=this.getCoordinates();s.splice(i.pickingObject.layerIndex,1),this.setCoordinates(s)},this._onMouseDblClick=i=>{if(this._cornerDblClick)return void(this._cornerDblClick=!1);if(!this._showGhostPointer)return;let s=this._planet.getCartesianFromPixelTerrain(i);s&&(this._addNew(s),!this._isStartPoint&&this._cornerLayer.getEntities().length>2&&(this._isStartPoint=!0,this.events.dispatch(this.events.startpoint,this)),this.events.dispatch(this.events.change,this))},this.events=le(Ol),this._planet=null,this._initCoordinates=t.coordinates||[],this._pickedCorner=null,this._pickedCenter=null,this._startPos=null,this._startClick=new H,this._geometryLayer=new ue,this._cornerStyle={scale:.5,tag:"corners",color:"rgb(350, 350, 0)",object3d:Br,...t.cornerStyle||{}},this._centerStyle={scale:.4,tag:"centers",color:"rgb(0, 350, 50)",object3d:Br,...t.centerStyle||{}},this._outlineStyle={thickness:3.5,color:"rgb(0, 350, 50)",...t.outlineStyle||{}},this._fillStyle={fillColor:"rgba(0,146,247,0.2)",...t.fillStyle||{}},this._cornerLayer=new ue("corners",{pickingScale:3,pickingEnabled:!0,polygonOffsetUnits:-5,relativeToGround:!0,scaleByDistance:[100,4e6,1]}),this._centerLayer=new ue("centers",{pickingScale:3,pickingEnabled:!0,polygonOffsetUnits:-5,relativeToGround:!0,scaleByDistance:[100,4e6,1]}),this._outlineLayer=new ue("outline",{entities:[new U({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}})],pickingEnabled:!1,polygonOffsetUnits:-5,relativeToGround:!0}),this._outlineLayer.getEntities()[0].polyline.altitude=li,this._ghostCorner=new U({geoObject:this._cornerStyle}),this._ghostOutlineLayer=new ue("ghost-pointer",{pickingEnabled:!1,polygonOffsetUnits:-5,relativeToGround:!0,scaleByDistance:[100,4e6,1],opacity:.5}),this._showGhostPointer=!1,this._isStartPoint=!1,this._insertCornerIndex=-1}get geometryType(){return"POLYGON"}getCoordinates(){let t=this._cornerLayer.getEntities();return t.length>0?t.map((i=>{let s=i.getLonLat();return[s.lon,s.lat,s.height]})):this._initCoordinates}bindPlanet(t){this._planet=t}init(){this._initEvents(),this._initGhostLayerPointer(),this._initCoordinates.length&&this.setCoordinates(this._initCoordinates),this._planet.addLayer(this._outlineLayer),this._planet.addLayer(this._cornerLayer),this._planet.addLayer(this._centerLayer),this.showGhostPointer(),this.startNewPoint(),this._geometryLayer.addTo(this._planet),this.events.on("change",this._onChange,this)}onremove(){this._clearEvents(),this.hideGhostPointer(),this.stopNewPoint(),this.clear(),this._geometryLayer.remove()}clear(){this._geometryLayer.clear();let t=this._cornerLayer.getEntities(),i=t.length;for(;i--;)t[i].remove();let s=this._centerLayer.getEntities();for(i=s.length;i--;)s[i].remove();let r=this._outlineLayer.getEntities();for(i=r.length;i--;)r[i].polyline.clear(),i>0&&r[i].remove();this._clearGhostPointer()}setCoordinates(t){this.clear();for(let i=0;i<t.length;i++){let s=t[i],r=this._planet.ellipsoid.lonLatToCartesian(new L(s[0],s[1],s[2]));this._appendCart(r)}this.events.dispatch(this.events.change,this)}stopNewPoint(){this.renderer&&this.renderer.events.off("ldblclick",this._onMouseDblClick)}startNewPoint(){this.renderer.events.on("ldblclick",this._onMouseDblClick,this)}showGhostPointer(){this._showGhostPointer=!0,this._planet.addLayer(this._ghostOutlineLayer),this._insertCornerIndex=this._cornerLayer.getEntities().length}hideGhostPointer(){this._showGhostPointer=!1,this._ghostOutlineLayer.remove(),this._insertCornerIndex=-1}setGhostPointerPosition(t){t&&(this._ghostCorner.setCartesian3v(t),this._updateGhostOutlinePointer(t))}_getLdown(t){this._planet.renderer.controls.mouseNavigation.deactivate(),this._startClick.set(t.x,t.y);let i=t.pickingObject.getCartesian();return this._startPos=this._planet.getPixelFromCartesian(i),t.pickingObject}_initEvents(){this._cornerLayer.events.on("ldblclick",this._onCornerLdblclick,this),this._cornerLayer.events.on("ldown",this._onCornerLdown,this),this._centerLayer.events.on("ldown",this._onCenterLdown,this),this.renderer.events.on("lup",this._onLup,this),this.renderer.events.on("mousemove",this._onMouseMove,this),this._cornerLayer.events.on("mouseenter",this._onCornerMouseEnter,this),this._cornerLayer.events.on("mouseleave",this._onCornerMouseLeave,this),this._centerLayer.events.on("mouseenter",this._onCenterMouseEnter,this),this._centerLayer.events.on("mouseleave",this._onCenterMouseLeave,this)}_clearEvents(){this._cornerLayer.events.off("ldblclick",this._onCornerLdblclick),this._cornerLayer.events.off("ldown",this._onCornerLdown),this._centerLayer.events.off("ldown",this._onCenterLdown),this.renderer.events.off("lup",this._onLup),this.renderer.events.off("mousemove",this._onMouseMove),this._cornerLayer.events.off("mouseenter",this._onCornerMouseEnter),this._cornerLayer.events.off("mouseleave",this._onCornerMouseLeave),this._centerLayer.events.off("mouseenter",this._onCenterMouseEnter),this._centerLayer.events.off("mouseleave",this._onCenterMouseLeave)}_drawCorners(){let t=this._cornerLayer.getEntities();for(let i=0;i<t.length;i++){let s=t[i];this._checkTerrainCollision(s)}}_drawCenters(){let t=this._centerLayer.getEntities();for(let i=0;i<t.length;i++){let s=t[i];this._checkTerrainCollision(s)}}_drawGhostCorner(){this._showGhostPointer&&this._checkTerrainCollision(this._ghostCorner)}frame(){this._drawCorners(),this._drawCenters(),this._drawGhostCorner()}_checkTerrainCollision(t){let i=new v,s=this._planet.quadTreeStrategy._renderedNodes;for(let r=0;r<s.length;r++){let n=s[r].segment;if(n&&n._extentLonLat.isInside(t.getLonLat())){n.getEntityTerrainPoint(t,i),t.setCartesian3v(i);break}}}_moveCenterPoint(){let t=this.getCoordinates(),i=this._pickedCenter.layerIndex+1,s=this._pickedCenter.getLonLat(),r=[s.lon,s.lat,s.height];t.splice(i,0,r),this.setCoordinates(t),this._pickedCenter=null,this._pickedCorner=this._cornerLayer.getEntities()[i]}_addNew(t){if(this._insertCornerIndex===-1||this._cornerLayer.getEntities().length<2)this._appendCart(t);else{let i=this.getCoordinates(),s=this._insertCornerIndex,r=this._planet.ellipsoid.cartesianToLonLat(t),n=[r.lon,r.lat,r.height];i.splice(s,0,n),this.clear(),this.setCoordinates(i)}}_appendCart(t){let i=this._cornerLayer.getEntities(),s=i[i.length-1],r=new U({geoObject:this._cornerStyle});if(r.setCartesian3v(t),r.addTo(this._cornerLayer),this._checkTerrainCollision(r),s){let n=i[0].getCartesian(),a=s.getCartesian(),o=r.getCartesian().sub(a),h=r.getCartesian().sub(n),c=o.length(),d=h.length();o.normalize(),h.normalize();let u=[],_=[];for(let b=0;b<=Re;b++){let T=o.scaleTo(b*c/Re).addA(a);u.push(T);let w=h.scaleTo(b*d/Re).addA(n);_.push(w)}this._outlineLayer.getEntities()[0].polyline.setPath3v([_]);let p=new U({polyline:{path3v:[u],isClosed:!1,...this._outlineStyle}});p.polyline.altitude=li,this._outlineLayer.add(p);let f=this._centerLayer.getEntities(),m=f[f.length-1],g=o.scaleTo(.5*c).addA(a),y=h.scaleTo(.5*d).addA(n),x=new U({geoObject:this._centerStyle});x.setCartesian3v(g),x.addTo(this._centerLayer),this._checkTerrainCollision(x),m.remove(),m.addTo(this._centerLayer),m.setCartesian3v(y)}else new U({geoObject:this._centerStyle}).addTo(this._centerLayer)}_clearGhostPointer(){const t=this._ghostOutlineLayer;t.getEntities()[0].polyline.clear(),t.getEntities()[1].polyline.clear()}_moveCornerPoint(t){let i=new H(t.x,t.y).sub(this._startClick),s=this._startPos.add(i),r=this._planet.getCartesianFromPixelTerrain(s);if(r){this._pickedCorner.setCartesian3v(r);let n=this._cornerLayer.getEntities();if(n.length){let a=this._pickedCorner.layerIndex,o=n.length,h=n[a===0?o-1:a-1].getCartesian(),c=n[(a+1)%o].getCartesian(),d=this._pickedCorner.getCartesian().sub(h),u=this._pickedCorner.getCartesian().sub(c),_=d.length(),p=u.length();d.normalize(),u.normalize();let f=[],m=[];for(let C=0;C<=Re;C++){let M=d.scaleTo(C*_/Re).addA(h);f.push(M);let P=u.scaleTo(C*p/Re).addA(c);m.push(P)}let g=this._outlineLayer.getEntities(),y=g[a].polyline,x=g[(a+1)%o].polyline;y?.setPath3v([f]),x?.setPath3v([m]);let b=this._centerLayer.getEntities(),T=b[a===0?o-1:a-1],w=b[a],A=d.scaleTo(.5*_).addA(h),E=u.scaleTo(.5*p).addA(c);T.setCartesian3v(A),this._checkTerrainCollision(T),w.setCartesian3v(E),this._checkTerrainCollision(w)}}}_updateGhostOutlinePointer(t){let i=this._cornerLayer.getEntities(),s=i.length;if(s>0){let r=0,n=ve;for(let P=0;P<s;P++){let B=i[P].getCartesian().distance(t);B<n&&(n=B,r=P)}let a=i[r].getCartesian(),o=i[(r+1)%s].getCartesian(),h=i[r===0?s-1:r-1].getCartesian().sub(a).normalize(),c=o.sub(a).normalize(),d=t.sub(a).normalize(),u=h.add(c).normalize(),_=d.cross(u),p=h.cross(c);_.dot(p)>0&&(r--,r<0&&(r=s-1));let f=new v;for(let P=0;P<s;P++)if(new $e(i[P].getCartesian(),i[(P+1)%s].getCartesian()).getNearestDistancePoint(t,f)){let B=f.distance(t);B<n&&(n=B,r=P)}this._insertCornerIndex=(r+1)%s;let m=i[r%s].getCartesian(),g=i[(r+1)%s].getCartesian(),y=this._ghostCorner.getCartesian().sub(m),x=this._ghostCorner.getCartesian().sub(g),b=y.length(),T=x.length();y.normalize(),x.normalize();let w=[],A=[];for(let P=0;P<=Re;P++){let B=y.scaleTo(P*b/Re).addA(m);w.push(B);let k=x.scaleTo(P*T/Re).addA(g);A.push(k)}let E=this._ghostOutlineLayer.getEntities(),C=E[0].polyline,M=E[1].polyline;C?.setPath3v([w]),M?.setPath3v([A])}}_initGhostLayerPointer(){this._ghostOutlineLayer.setEntities([new U({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}}),new U({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}}),this._ghostCorner]);const t=this._ghostOutlineLayer;t.getEntities()[0].polyline.altitude=t.getEntities()[1].polyline.altitude=li}}class kr extends $a{constructor(t){super(t)}get geometryType(){return"LineString"}_addNew(t){this._appendCart(t)}_appendCart(t){let i=this._cornerLayer.getEntities(),s=i[i.length-1],r=new U({geoObject:this._cornerStyle});if(r.setCartesian3v(t),r.addTo(this._cornerLayer),this._checkTerrainCollision(r),s){let n=s.getCartesian(),a=r.getCartesian().sub(n),o=a.length();a.normalize();let h=[];for(let _=0;_<=Re;_++){let p=a.scaleTo(_*o/Re).addA(n);h.push(p)}let c=new U({polyline:{path3v:[h],isClosed:!1,...this._outlineStyle}});c.polyline.altitude=li,this._outlineLayer.add(c);let d=a.scaleTo(.5*o).addA(n),u=new U({geoObject:this._centerStyle});u.setCartesian3v(d),u.addTo(this._centerLayer),this._checkTerrainCollision(u)}}_clearGhostPointer(){this._ghostOutlineLayer.getEntities()[0].polyline.clear()}_moveCorner(t,i,s){let r=this._cornerLayer.getEntities();if(r.length==0)return;r.length==1&&(t=i=s=0);let n=r[t].getCartesian(),a=this._pickedCorner.getCartesian().sub(n),o=a.length();a.normalize();let h=[];for(let u=0;u<=Re;u++){let _=a.scaleTo(u*o/Re).addA(n);h.push(_)}let c=this._outlineLayer.getEntities()[i].polyline;c?.setPath3v([h]);let d=this._centerLayer.getEntities()[s];if(d){let u=a.scaleTo(.5*o).addA(n);d.setCartesian3v(u),this._checkTerrainCollision(d)}}_moveCornerPoint(t){let i=new H(t.x,t.y).sub(this._startClick),s=this._startPos.add(i),r=this._planet.getCartesianFromPixelTerrain(s);if(r){this._pickedCorner.setCartesian3v(r);let n=this._cornerLayer.getEntities();if(n.length){let a=this._pickedCorner.layerIndex;a===0?this._moveCorner(a+1,a+1,a):(a===n.length-1||this._moveCorner(a+1,a+1,a),this._moveCorner(a-1,a,a-1))}}}_updateGhostOutlinePointer(t){let i=this._cornerLayer.getEntities(),s=i.length;if(s>0){let r=s-1;this._insertCornerIndex=r;let n=i[r].getCartesian(),a=this._ghostCorner.getCartesian().sub(n),o=a.length();a.normalize();let h=[];for(let c=0;c<=Re;c++){let d=a.scaleTo(c*o/Re).addA(n);h.push(d)}this._ghostOutlineLayer.getEntities()[0].polyline.setPath3v([h])}}_initGhostLayerPointer(){this._ghostOutlineLayer.setEntities([new U({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}}),this._ghostCorner]),this._ghostOutlineLayer.getEntities()[0].polyline.altitude=li}}class Ir extends K{constructor(t={}){super(t),this._drawingScene=new kr({name:`drawingScene:${this.__id}`,cornerStyle:t.cornerStyle||{},centerStyle:t.centerStyle||{},outlineStyle:t.outlineStyle||{},fillStyle:t.fillStyle||{}})}activatePolygonDrawing(){this.deactivate(),this._drawingScene=new $a({name:`polygonDrawingScene:${this.__id}`,cornerStyle:this._drawingScene._cornerStyle,centerStyle:this._drawingScene._centerStyle,outlineStyle:this._drawingScene._outlineStyle,fillStyle:this._drawingScene._fillStyle}),this.activate()}activateLineStringDrawing(){this.deactivate(),this._drawingScene=new kr({name:`linestringDrawingScene:${this.__id}`,cornerStyle:this._drawingScene._cornerStyle,centerStyle:this._drawingScene._centerStyle,outlineStyle:this._drawingScene._outlineStyle,fillStyle:this._drawingScene._fillStyle}),this.activate()}oninit(){}onactivate(){this.planet&&this._drawingScene.bindPlanet(this.planet),this.renderer&&this.renderer.addNode(this._drawingScene)}ondeactivate(){this.renderer&&this.renderer.removeNode(this._drawingScene)}}const ti={ell:0,msl:1,gnd:2},rr=.3048,Nl=1/rr,Hl=1/3.6,Xa=.001*rr,Vl=1/Xa,Ul=["m","km","ft","s","h","m/s","km/h","ft/s"],Za=[0,2,0,0,0,0,0,0];let ge=[];function Qa(l,t,i){return ge[l][t](i)}function Fs(l,t,i,s,r){return l?Qa(t,i,s).toFixed(r||Za[i]):"--"}function Ka(l){return Ul[l]}ge[0]=[],ge[0][0]=l=>l,ge[0][1]=l=>.001*l,ge[0][2]=l=>l*Nl,ge[2]=[],ge[2][0]=l=>l*rr,ge[2][1]=l=>l*Xa,ge[2][2]=l=>l,ge[1]=[],ge[1][0]=l=>1e3*l,ge[1][1]=l=>l,ge[1][2]=l=>l*Vl,ge[5]=[],ge[5][5]=l=>l,ge[5][6]=l=>3.6*l,ge[5][7]=l=>3.28084*l,ge[6]=[],ge[6][5]=l=>l*Hl,ge[6][6]=l=>l;const zr=Object.freeze(Object.defineProperty({__proto__:null,ELL:0,GND:2,MSL:1,_tenth:Za,convert:Qa,convertExt:Fs,ft:2,fts:7,h:4,heightMode:ti,km:1,kmh:6,m:0,ms:5,s:3,toString:Ka},Symbol.toStringTag,{value:"Module"})),Gl=[`<div class="og-lat-side"></div><div class="og-lat-val"></div>
    <div class="og-lon-side"></div><div class="og-lon-val"></div>
    <div class="og-height"></div>
    <div class="og-units-height"></div>`,`<div class="og-lat-side"></div><div class="og-lat-val"></div>
    <div class="og-lon-side"></div><div class="og-lon-val"></div>
    <div class="og-height"></div>
    <div class="og-units-height"></div>`];class Ja extends K{constructor(t={}){super(t),this._type=t.type||0,this._TYPE_FUNC=[this._SHOW_DECIMAL,this._SHOW_DEGREE],this._showFn=null,this._el=null,this._latSideEl=null,this._lonSideEl=null,this._latValEl=null,this._lonValEl=null,this._heightEl=null,this._altUnitVal=t.altitudeUnit||"m",this._heightModeVal=t.heightMode||"ell",this._altUnit=zr[this._altUnitVal],this._heightMode=ti[this._heightModeVal],this._lonLat=null,this._centerMode=!1}_SHOW_DECIMAL(t){if(t){let i=t.lat,s=t.lon;this._latSideEl.innerHTML=i>=0?"N":"S",this._lonSideEl.innerHTML=s>=0?"E":"W",this._latValEl.innerHTML=Math.abs(i).toFixed(7)+"",this._lonValEl.innerHTML=Math.abs(s).toFixed(7)+""}}_SHOW_DEGREE(t){if(t){let i=t.lat,s=t.lon;this._latSideEl.innerHTML=i>=0?"N":"S",this._lonSideEl.innerHTML=s>=0?"E":"W";let r=0,n=i<0?Math.ceil(i):Math.floor(i),a=Math.floor(r=60*Math.abs(i-n)),o=Math.floor(6e3*(r-a))/100;this._latValEl.innerHTML=Math.abs(n)+""+a+"'"+o.toFixed(0)+'"',n=s<0?Math.ceil(s):Math.floor(s),a=Math.floor(r=60*Math.abs(s-n)),o=Math.floor(6e3*(r-a))/100,this._lonValEl.innerHTML=Math.abs(n)+""+a+"'"+o.toFixed(0)+'"'}}_createCenterEl(){let t=document.createElement("div");return t.className="og-center-icon",t.innerHTML='<svg width="12" height="12"><g><path stroke-width="1" stroke-opacity="1" d="M6 0L6 12M0 6L12 6" stroke="#337ab7"></path></g></svg>',t}_updateUnits(){this._heightMode=ti[this._heightModeVal],this._altUnit=zr[this._altUnitVal],this._el.querySelector(".og-units-height").innerHTML=Ka(this._altUnit),this._showHeight()}_refreshCoordinates(){this._type>=this._TYPE_FUNC.length&&(this._type=0);let t=this._el;t.innerHTML=Gl[this._type],this._latSideEl=t.querySelector(".og-lat-side"),this._lonSideEl=t.querySelector(".og-lon-side"),this._latValEl=t.querySelector(".og-lat-val"),this._lonValEl=t.querySelector(".og-lon-val"),this._heightEl=t.querySelector(".og-height"),this._showFn=this._TYPE_FUNC[this._type],this._showFn(this._lonLat)}oninit(){this._el=document.createElement("div"),this._el.classList.add("og-coordinates"),this.renderer.div.appendChild(this._el),this._el.addEventListener("click",(()=>{this._type++,this._refreshCoordinates(),this._updateUnits(),this._showHeight()})),this._centerMode?(this.renderer.div.appendChild(this._createCenterEl()),this.planet.camera.events.on("moveend",this._grabCoordinates,this),this.planet.camera.events.on("moveend",di((()=>this._showHeight()),400,!0),this)):(this.renderer.events.on("mousemove",this._grabCoordinates,this),this.renderer.events.on("mousestop",di((()=>this._showHeight()),400,!0),this)),this._refreshCoordinates(),this._updateUnits()}_grabCoordinates(t){let i,s=t.pos,r=this.renderer;i=this._centerMode?r.handler.getCenter():s,this._lonLat=this.planet.getLonLatFromPixelTerrain(i)||null,this._showFn(this._lonLat)}async _showHeight(){if(this._lonLat&&this.planet){let t=0;this._heightEl.style.opacity="0.7",this._heightMode===ti.ell?(t=await this.planet.getHeightAboveELL(this._lonLat),t=Number(Fs(!0,0,this._altUnit,t))):this._heightMode===ti.msl&&(t=await this.planet.getHeightDefault(this._lonLat),t=Number(Fs(!0,0,this._altUnit,t))),this._heightEl.style.opacity="1.0",this._heightEl.innerHTML=t.toString()}}}const jl=["loadend"];class mi extends Ve{constructor(t,i={}){super(t,i),this.events=this.events.registerNames(jl),this._projType=0,this._frameWidth=256,this._frameHeight=256,this._sourceReady=!1,this._sourceTexture=null,this._materialTexture=null,this._gridBufferLow=null,this._gridBufferHigh=null,this._extentWgs84ParamsHigh=new Float32Array(4),this._extentWgs84ParamsLow=new Float32Array(4),this._extentMercParamsHigh=new Float32Array(4),this._extentMercParamsLow=new Float32Array(4),this._refreshFrame=!0,this._frameCreated=!1,this._sourceCreated=!1,this._animate=!1,this._ready=!1,this._creationProceeding=!1,this._isRendering=!1,this._extentWgs84=new j,this._cornersWgs84=[],this._cornersMerc=[],this._isFullExtent=i.fullExtent?1:0,this.rendering=this._renderingProjType0.bind(this),this._onLoadend_=null,i.corners&&this.setCorners(i.corners)}get isIdle(){return super.isIdle&&this._ready}addTo(t){return this._onLoadend_=this._onLoadend.bind(this),this.events.on("loadend",this._onLoadend_,this),super.addTo(t)}_onLoadend(){this._planet&&this._planet.events.dispatch(this._planet.events.layerloadend,this)}remove(){return this.events.off("loadend",this._onLoadend_),this._onLoadend_=null,super.remove()}get instanceName(){return"BaseGeoImage"}getCornersLonLat(){let t=this._cornersWgs84;return[new L(t[0].lon,t[0].lat),new L(t[1].lon,t[1].lat),new L(t[2].lon,t[2].lat),new L(t[3].lon,t[3].lat)]}getCorners(){let t=this._cornersWgs84;return[[t[0].lon,t[0].lat],[t[1].lon,t[1].lat],[t[2].lon,t[2].lat],[t[3].lon,t[3].lat]]}setCorners(t){this.setCornersLonLat(L.join(t))}setCornersLonLat(t){this._refreshFrame=!0,this._cornersWgs84=[t[0].clone(),t[1].clone(),t[2].clone(),t[3].clone()];for(let s=0;s<this._cornersWgs84.length;s++)this._cornersWgs84[s].lat>=89.9&&(this._cornersWgs84[s].lat=89.9),this._cornersWgs84[s].lat<=-89.9&&(this._cornersWgs84[s].lat=-89.9);this._extent.setByCoordinates(this._cornersWgs84);let i=this._extent;i.southWest.lat>ce||i.northEast.lat<ke?(this._projType=0,this.rendering=this._renderingProjType0):(this._projType=1,this.rendering=this._renderingProjType1),this._ready&&!this._creationProceeding&&this._planet._geoImageCreator.add(this)}_createFrame(){this._extentWgs84=this._extent.clone(),this._cornersMerc=[this._cornersWgs84[0].forwardMercatorEPS01(),this._cornersWgs84[1].forwardMercatorEPS01(),this._cornersWgs84[2].forwardMercatorEPS01(),this._cornersWgs84[3].forwardMercatorEPS01()],this._extentMerc=new j(this._extentWgs84.southWest.forwardMercatorEPS01(),this._extentWgs84.northEast.forwardMercatorEPS01());let t=new Float32Array(2);if(this._projType===0?(rt(this._extentWgs84.southWest.lon,t),this._extentWgs84ParamsHigh[0]=t[0],this._extentWgs84ParamsLow[0]=t[1],rt(this._extentWgs84.southWest.lat,t),this._extentWgs84ParamsHigh[1]=t[0],this._extentWgs84ParamsLow[1]=t[1],this._extentWgs84ParamsHigh[2]=2/this._extentWgs84.getWidth(),this._extentWgs84ParamsHigh[3]=2/this._extentWgs84.getHeight()):(rt(this._extentMerc.southWest.lon,t),this._extentMercParamsHigh[0]=t[0],this._extentMercParamsLow[0]=t[1],rt(this._extentMerc.southWest.lat,t),this._extentMercParamsHigh[1]=t[0],this._extentMercParamsLow[1]=t[1],this._extentMercParamsHigh[2]=2/this._extentMerc.getWidth(),this._extentMercParamsHigh[3]=2/this._extentMerc.getHeight()),this._planet){let i=this._planet.renderer.handler;i.gl.deleteTexture(this._materialTexture),this._materialTexture=i.createEmptyTexture_l(this._frameWidth,this._frameHeight);let s=this._planet._geoImageCreator.createGridBuffer(this._cornersWgs84,this._projType===1);this._gridBufferHigh=s[0],this._gridBufferLow=s[1],this._refreshFrame=!1}}abortMaterialLoading(t){this._creationProceeding=!1,t.isLoading=!1,t.isReady=!1}clear(){let t=this._planet;if(t){let i=t.renderer.handler.gl;this._creationProceeding&&t._geoImageCreator.remove(this),t._clearLayerMaterial(this),i&&(i.deleteBuffer(this._gridBufferHigh),i.deleteBuffer(this._gridBufferLow),i.deleteTexture(this._sourceTexture),this._materialTexture&&!this._materialTexture.default&&i.deleteTexture(this._materialTexture))}this._sourceTexture=null,this._materialTexture=null,this._gridBufferHigh=null,this._gridBufferLow=null,this._refreshFrame=!0,this._sourceCreated=!1,this._ready=!1,this._creationProceeding=!1}setVisibility(t){t!==this._visibility&&(super.setVisibility(t),this._planet&&this._sourceReady&&(t?this._planet._geoImageCreator.add(this):this._planet._geoImageCreator.remove(this)))}clearMaterial(t){t.texture=null,t.isLoading=!1,t.isReady=!1}applyMaterial(t){let i,s,r=t.segment;this._ready?t.applyTexture(this._materialTexture):(t.texture=this._planet.transparentTexture,!this._creationProceeding&&this.loadMaterial(t)),this._projType===0?(i=this._extentWgs84,s=r._extent):(i=this._extentMerc,s=r.getExtentMerc());let n=i.northEast.lon-i.southWest.lon,a=i.northEast.lat-i.southWest.lat;return[(s.southWest.lon-i.southWest.lon)/n,(i.northEast.lat-s.northEast.lat)/a,(s.northEast.lon-s.southWest.lon)/n,(s.northEast.lat-s.southWest.lat)/a]}get getFrameWidth(){return this._frameWidth}get getFrameHeight(){return this._frameHeight}_createSourceTexture(){}_renderingProjType1(){let t=this._planet,i=t.renderer.handler,s=i.gl,r=t._geoImageCreator;this._refreshFrame&&this._createFrame(),this._createSourceTexture();let n=r._framebuffer;n.setSize(this._frameWidth,this._frameHeight),n.activate(),i.programs.geoImageTransform.activate();let a=i.programs.geoImageTransform._program,o=a.attributes,h=a.uniforms;s.disable(s.CULL_FACE),n.bindOutputTexture(this._materialTexture),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT),s.uniform1i(h.isFullExtent,this._isFullExtent),s.bindBuffer(s.ARRAY_BUFFER,r._texCoordsBuffer),s.vertexAttribPointer(o.texCoords,2,s.UNSIGNED_SHORT,!0,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._gridBufferHigh),s.vertexAttribPointer(o.cornersHigh,this._gridBufferHigh.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._gridBufferLow),s.vertexAttribPointer(o.cornersLow,this._gridBufferLow.itemSize,s.FLOAT,!1,0,0),s.uniform4fv(h.extentParamsHigh,this._extentMercParamsHigh),s.uniform4fv(h.extentParamsLow,this._extentMercParamsLow),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._sourceTexture),s.uniform1i(h.sourceTexture,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,r._indexBuffer),s.drawElements(s.TRIANGLE_STRIP,r._indexBuffer.numItems,s.UNSIGNED_INT,0),n.deactivate(),s.enable(s.CULL_FACE),this._ready=!0,this._creationProceeding=!1}_renderingProjType0(){let t=this._planet,i=t.renderer.handler,s=i.gl,r=t._geoImageCreator;this._refreshFrame&&this._createFrame(),this._createSourceTexture();let n=r._framebuffer;n.setSize(this._frameWidth,this._frameHeight),n.activate(),i.programs.geoImageTransform.activate();let a=i.programs.geoImageTransform._program,o=a.attributes,h=a.uniforms;s.disable(s.CULL_FACE),n.bindOutputTexture(this._materialTexture),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT),s.bindBuffer(s.ARRAY_BUFFER,r._texCoordsBuffer),s.vertexAttribPointer(o.texCoords,2,s.UNSIGNED_SHORT,!0,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._gridBufferHigh),s.vertexAttribPointer(o.cornersHigh,this._gridBufferHigh.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._gridBufferLow),s.vertexAttribPointer(o.cornersLow,this._gridBufferLow.itemSize,s.FLOAT,!1,0,0),s.uniform4fv(h.extentParamsHigh,this._extentWgs84ParamsHigh),s.uniform4fv(h.extentParamsLow,this._extentWgs84ParamsLow),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._sourceTexture),s.uniform1i(h.sourceTexture,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,r._indexBuffer),s.drawElements(s.TRIANGLE_STRIP,r._indexBuffer.numItems,s.UNSIGNED_INT,0),n.deactivate(),s.enable(s.CULL_FACE),this._ready=!0,this._creationProceeding=!1}}const W={MB_LEFT:0,MB_RIGHT:2,MB_MIDDLE:1,KEY_CTRL:17,KEY_ALT:18,KEY_SHIFT:16,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINTSCREEN:44,KEY_A:65,KEY_D:68,KEY_E:69,KEY_Q:81,KEY_S:83,KEY_W:87,KEY_X:88,KEY_APOSTROPHE:192},ql=["change","idle","play","pause","stop"];class Yl extends xe{constructor(t){super({template:Ie('<button title={title} class="og-layerSwitcher__layerButton">{icon}<div class="og-layerSwitcher__name">{name}</div></button>',{title:t.model.name,name:t.model.name,icon:t.model.iconSrc?`<img src="${t.model.iconSrc}" />`:""}),...t}),this._onVisibilityChange=i=>{this.el&&(this.model.getVisibility()?this.el.classList.add("og-layerSwitcher__visible"):this.el.classList.remove("og-layerSwitcher__visible"))},this._onClick=()=>{this.model.isBaseLayer()?this.model.setVisibility(!0):this.model.setVisibility(!this.model.getVisibility())},this._onDblClick=()=>{this.model.flyExtent()}}render(t){return super.render(t),this.model.events.on("visibilitychange",this._onVisibilityChange),this._onVisibilityChange(this.model),this.el.addEventListener("click",this._onClick),this.el.addEventListener("dblclick",this._onDblClick),this}remove(){super.remove(),this.model.events.off("visibilitychange",this._onVisibilityChange)}}const Wl=["change"];class Z extends xe{constructor(t={}){super({template:Ie(`<div class="og-slider">
      <div class="og-slider-label">{label}</div>
      <div class="og-slider-panel">
        <div class="og-slider-progress"></div>      
        <div class="og-slider-pointer"></div>
      </div>
      <input type="number"/>
    </div>`,{label:t.label||""})}),this._onResize=()=>{this._setOffset((this._value-this._min)*this.$panel.clientWidth/(this._max-this._min))},this._onMouseWheel=i=>{(i=i||window.event).preventDefault(),i.stopPropagation(),this.value=this._value+Math.sign(i.wheelDelta)*(this._max-this._min)/100},this._onMouseWheelFF=i=>{this._onMouseWheel(i)},this._onInput=i=>{(i=i||window.event).preventDefault(),i.stopPropagation(),this.value=parseFloat(i.target.value)},this._onMouseDown=i=>{(i=i||window.event).preventDefault(),this._startPosX=i.clientX,this.value=this._min+(this._max-this._min)*(i.offsetX/this.$panel.clientWidth),document.addEventListener("mousemove",this._onMouseMove),document.addEventListener("mouseup",this._onMouseUp)},this._onMouseMove=i=>{(i=i||window.event).preventDefault(),i.stopPropagation();let s=this.$panel.getBoundingClientRect(),r=Ni(i.clientX,s.left,s.right),n=this._startPosX-r;this._startPosX=r,this.value=this._value-n*(this._max-this._min)/this.$panel.clientWidth},this._onMouseUp=()=>{document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousemove",this._onMouseMove)},this.events=this.events.registerNames(Wl),this._value=t.value||0,this._min=t.min||0,this._max=t.max||1,this._resizeObserver=new ResizeObserver(this._onResize),this._startPosX=0,this.$label=null,this.$pointer=null,this.$progress=null,this.$input=null,this.$panel=null}render(t){return super.render(t),this.$label=this.select(".og-slider-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$pointer=this.select(".og-slider-pointer"),this.$progress=this.select(".og-slider-progress"),this.$panel=this.select(".og-slider-panel"),this.$input=this.select("input"),this._resizeObserver.observe(this.el),this._initEvents(),this}set value(t){t!==this._value&&(this._value=Ni(t,this._min,this._max),this.$input.value=this._value.toString(),this._setOffset((this._value-this._min)*this.$panel.clientWidth/(this._max-this._min)),this.events.dispatch(this.events.change,this._value,this))}get value(){return this._value}_initEvents(){this.$panel.addEventListener("mousedown",this._onMouseDown),this.$panel.addEventListener("mousewheel",this._onMouseWheel),this.$panel.addEventListener("wheel",this._onMouseWheelFF),this.$input.addEventListener("input",this._onInput)}_clearEvents(){this.$panel.removeEventListener("mousedown",this._onMouseDown),this.$panel.removeEventListener("mousewheel",this._onMouseWheel),this.$panel.removeEventListener("wheel",this._onMouseWheelFF),this.$input.removeEventListener("input",this._onInput)}_setOffset(t){t>=0&&t<=this.$panel.clientWidth&&(this.$pointer.style.left=this.$progress.style.width=100*t/this.$panel.clientWidth+"%")}remove(){this._clearEvents(),super.remove()}set max(t){this._max=t,this.events.stopPropagation(),this.value=this._value+Math.sign(e.wheelDelta)*(this._max-this._min)/100}get max(){return this._max}}const $l=["input"];let Xl=0;class Dr extends xe{constructor(t={}){super({template:Ie(`<div class="og-color">
      <label for="{id}" class="og-color-label">{label}</label>
      <input type="color" name="{id}" value="{value}"/>
    </div>`,{id:"color-"+Xl++,label:t.label||"",value:t.value||"#000000"})}),this._onInput=i=>{this.value=i.target.value},this.events=this.events.registerNames($l),this._value=t.value||"blue",this.$label=null,this.$input=null}render(t){return super.render(t),this.$label=this.select(".og-color-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$input=this.select("input"),this._initEvents(),this}set value(t){t!==this._value&&(this._value=t,this.$input.value=this._value,this.events.dispatch(this.events.input,this._value,this))}get value(){return this._value}_initEvents(){this.$input.addEventListener("input",this._onInput)}_clearEvents(){this.$input.removeEventListener("input",this._onInput)}remove(){this._clearEvents(),super.remove()}}class Os{constructor(){this._lock=0}lock(t){this._lock|=1<<t.id}free(t){this._lock&=~(1<<t.id)}isFree(){return this._lock===0}isLocked(){return this._lock!==0}}const eo=class to{constructor(){this.__id=to.__counter__++}get id(){return this.__id}};eo.__counter__=0;let bi=eo;class nr extends K{constructor(t={}){super(t),this._deactivate=!1,this._shiftBusy=!1,this._name="mouseNavigation",this.grabbedPoint=new v,this._eye0=new v,this.pointOnEarth=new v,this.earthUp=new v,this.inertia=.007,this.grabbedSpheroid=new Be,this.qRot=new F,this.scaleRot=0,this.distDiff=.3,this.stepsCount=8,this.stepsForward=null,this.stepIndex=0,this._lmbDoubleClickActive=!0,this.minSlope=t.minSlope||.1,this._wheelDirection=1,this._keyLock=new bi}static getMovePointsFromPixelTerrain(t,i,s,r,n,a,o){const h=[];let c=t.eye.clone(),d=t.getBackward(),u=t.getRight(),_=t.getUp(),p=i.getCartesianFromPixelTerrain(n);if(p||(p=i.getCartesianFromPixelTerrain(i.renderer.handler.getCenter())),p){o||(o=v.sub(p,t.eye).normalize());let f=r*t.eye.distance(p)/s;f*=a?-1.25:2;const m=d.scaleTo(f);if(o.dot(t.eye.normal().negate())>=.1){const g=new Be;g.radius=p.length();let y=[],x=[],b=!1;for(let T=0;T<s;T++){c.addA(m);const w=new V(c,o).hitSphere(g);if(x[T]=c.clone(),!w){b=!0;break}y[T]=new ee().rotateBetweenVectors(p.normal(),w.normal())}if(b){c=t.eye.clone();for(let T=0;T<s;T++)h[T]={eye:c.addA(m).clone(),v:_,u,n:d}}else for(let T=0;T<s;T++){let w=y[T];h[T]={eye:w.mulVec3(x[T]),v:w.mulVec3(_),u:w.mulVec3(u),n:w.mulVec3(d)}}}else for(let g=0;g<s;g++)h[g]={eye:c.addA(o.scaleTo(-f)).clone(),v:_,u,n:d};return h}}onactivate(){this.renderer&&(this.renderer.events.on("mousewheel",this.onMouseWheel,this),this.renderer.events.on("lhold",this.onMouseLeftButtonDown,this),this.renderer.events.on("rhold",this.onMouseRightButtonDown,this),this.renderer.events.on("ldown",this.onMouseLeftButtonClick,this),this.renderer.events.on("lup",this.onMouseLeftButtonUp,this),this.renderer.events.on("rdown",this.onMouseRightButtonClick,this),this.renderer.events.on("draw",this.onDraw,this,-1e3),this.renderer.events.on("mousemove",this.onMouseMove,this),this.renderer.events.on("mouseleave",this.onMouseLeave,this),this.renderer.events.on("mouseenter",this.onMouseEnter,this),this._lmbDoubleClickActive&&this.renderer.events.on("ldblclick",this.onMouseLeftButtonDoubleClick,this))}ondeactivate(){this.renderer&&(this.renderer.events.off("mousewheel",this.onMouseWheel),this.renderer.events.off("lhold",this.onMouseLeftButtonDown),this.renderer.events.off("rhold",this.onMouseRightButtonDown),this.renderer.events.off("ldown",this.onMouseLeftButtonClick),this.renderer.events.off("lup",this.onMouseLeftButtonUp),this.renderer.events.off("rdown",this.onMouseRightButtonClick),this.renderer.events.off("draw",this.onDraw),this.renderer.events.off("ldblclick",this.onMouseLeftButtonDoubleClick),this.renderer.events.off("mouseleave",this.onMouseLeave),this.renderer.events.off("mouseenter",this.onMouseEnter))}activateDoubleClickZoom(){this._lmbDoubleClickActive||(this._lmbDoubleClickActive=!0,this.renderer&&this.renderer.events.on("ldblclick",this.onMouseLeftButtonDoubleClick,this))}deactivateDoubleClickZoom(){this._lmbDoubleClickActive&&(this._lmbDoubleClickActive=!1,this.renderer&&this.renderer.events.off("ldblclick",this.onMouseLeftButtonDoubleClick))}onMouseEnter(t){const i=this.renderer.events;i.isKeyPressed(W.KEY_ALT)&&i.releaseKeys(),i.updateButtonsStates(t.sys.buttons),i.mouseState.leftButtonDown?this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"):this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")}onMouseLeave(){this.renderer.events.mouseState.leftButtonDown&&(this.scaleRot=0),this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")}onMouseWheel(t){this.stepIndex||(this.planet.stopFlying(),this.stopRotation(),this._deactivate=!0,this.lockPlanet(!0),this.stepsForward=nr.getMovePointsFromPixelTerrain(this.planet.camera,this.planet,this.stepsCount,this.distDiff,t.pos,t.wheelDelta>0,t.direction)||null,this._wheelDirection=t.wheelDelta,this.stepsForward&&(this.stepIndex=this.stepsCount))}oninit(){this.activate(),this.renderer&&(this.renderer.events.on("keyfree",W.KEY_ALT,this.onShiftFree,this),this.renderer.events.on("keyfree",W.KEY_PRINTSCREEN,this.onShiftFree,this))}onMouseLeftButtonDoubleClick(t){this.planet.stopFlying(),this.stopRotation();const i=this.planet.getCartesianFromPixelTerrain(t.pos);if(i){const s=this.planet.camera;let r=s.maxAltitude+this.planet.ellipsoid.polarSize,n=s.minAltitude+this.planet.ellipsoid.polarSize;const a=s.eye.length(),o=this.planet.ellipsoid.cartesianToLonLat(i);if(a>r||a<n)return void this.planet.flyLonLat(new L(o.lon,o.lat));this.renderer.events.isKeyPressed(W.KEY_ALT)?this.planet.flyLonLat(new L(o.lon,o.lat,2*s.eye.distance(i))):this.planet.flyLonLat(new L(o.lon,o.lat,.57*s.eye.distance(i)))}}onMouseLeftButtonClick(){this._active&&(this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"),this.grabbedPoint=this.planet.getCartesianFromMouseTerrain(),this.grabbedPoint&&(this._eye0.copy(this.planet.camera.eye),this.grabbedSpheroid.radius=this.grabbedPoint.length(),this.stopRotation()))}stopRotation(){this.qRot.clear(),this.freePlanet()}onMouseLeftButtonUp(t){this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner"),t.x===t.prev_x&&t.y===t.prev_y&&(this.scaleRot=0)}onMouseLeftButtonDown(t){if(this._active){if(!this.grabbedPoint)return;if(this.planet.stopFlying(),t.moving){let i=this.planet.camera;if(i.slope>.2){const s=new V(i.eye,t.direction).hitSphere(this.grabbedSpheroid);if(s){this.scaleRot=1,this.qRot=F.getRotationBetweenVectors(s.normal(),this.grabbedPoint.normal());let r=this.qRot;i.eye=r.mulVec3(i.eye),i.rotate(r)}}else{let s=this.grabbedPoint,r=v.add(s,i.getRight()),n=v.add(s,s.normal()),a=new v;new V(i.eye,t.direction).hitPlaneRes(pe.fromPoints(s,r,n),a)===V.INSIDE&&(i.eye=this._eye0.addA(a.subA(s).negate()))}}}}onMouseRightButtonClick(t){this.stopRotation(),this.planet.stopFlying(),this.pointOnEarth=this.planet.getCartesianFromPixelTerrain(t.pos),this.pointOnEarth&&(this.earthUp=this.pointOnEarth.normal())}onMouseRightButtonDown(t){const i=this.planet.camera;if(this.pointOnEarth&&t.moving){this.renderer.controlsBag.scaleRot=1;let s=.5/i.eye.distance(this.pointOnEarth)*i._lonLat.height*G;s>.007?s=.007:s<.003&&(s=.003),i.rotateHorizontal(s*(t.x-t.prev_x),!1,this.pointOnEarth,this.earthUp),i.rotateVertical(s*(t.y-t.prev_y),this.pointOnEarth,this.minSlope)}}onShiftFree(){this._shiftBusy=!1}onMouseMove(t){this._active&&this.renderer.events.isKeyPressed(W.KEY_ALT)&&(this._shiftBusy||(this._shiftBusy=!0,this.onMouseRightButtonClick(t)),this.onMouseRightButtonDown(t))}onDraw(){if(this._active){const t=this.renderer,i=this.planet.camera;let s=i.eye.clone();if(this.stepIndex){t.controlsBag.scaleRot=1;const r=this.stepsForward[this.stepsCount-this.stepIndex--];i.eye=r.eye,i._u=r.v,i._r=r.u,i._b=r.n,i._f.set(-i._b.x,-i._b.y,-i._b.z)}else this._deactivate&&(this._deactivate=!1,this.freePlanet());if(t.events.mouseState.leftButtonDown||!this.scaleRot)return;if(this.scaleRot-=this.inertia,this.scaleRot<=0)this.scaleRot=0;else{t.controlsBag.scaleRot=this.scaleRot;let r=this.qRot.slerp(F.IDENTITY,1-this.scaleRot*this.scaleRot*this.scaleRot).normalize();r.x||r.y||r.z||(this.scaleRot=0),i.eye=r.mulVec3(i.eye),i.rotate(r)}i.eye.distance(s)/i.getAltitude()>.01?this.lockPlanet():this.freePlanet()}}lockPlanet(t){this.planet.layerLock.lock(this._keyLock),!t&&this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock)}freePlanet(){this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock)}}const Zl=["drag","zoom","rotate"],Ti=.96;class Ii extends K{constructor(t={}){super({name:"navigation",autoActivate:!0,...t}),this._freeMode=!1,this._shiftBusy=!1,this._hold=!1,this._onShiftFree=()=>{this._shiftBusy=!1},this._onCameraFly=()=>{this.stop()},this._onMouseMove=i=>{this._active&&this.renderer.events.isKeyPressed(W.KEY_ALT)&&(this._shiftBusy||(this._shiftBusy=!0,this._onRHold(i)),this._onRDown(i))},this._onMouseEnter=i=>{const s=this.renderer.events;s.isKeyPressed(W.KEY_ALT)&&s.releaseKeys(),s.updateButtonsStates(i.sys.buttons),s.mouseState.leftButtonDown?this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"):this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")},this._onMouseLeave=()=>{this.renderer.events.mouseState.leftButtonDown&&this.vel.scale(0),this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")},this._onRHold=i=>{if((!this.disableRotation||!this.disableTilt)&&this._targetRotationPoint){this._velInertia=.6,this.disableRotation||(this.force_h=.5*(i.x-i.prev_x)),this.disableTilt||(this.force_v=.5*(i.y-i.prev_y));let s=this.planet.camera.getHeading();this._freeMode=!1,!isNaN(s)&&s>45&&s<340&&(this._freeMode=!0)}},this._onRDown=i=>{if((!this.disableRotation||!this.disableTilt)&&this.planet){this.planet.stopFlying();const s=this._getTargetPoint(i.pos);this._targetRotationPoint=s||null,s&&(this._targetZoomPoint=null,this._targetDragPoint=null,this.vel.set(0,0,0),this._tUp=s.getNormal(),this._tRad=this.planet.camera.eye.distance(s))}},this._onMouseWheel=i=>{if(this.planet){this._targetRotationPoint=null,this._targetDragPoint=null;let s=i.x,r=i.y,n=this.planet.camera;if(n.isOrthographic){s=.5*this.renderer.handler.getWidth(),r=.5*this.renderer.handler.getHeight();let c=this._getTargetPoint(new H(s,r));if(!c)return;this._targetZoomPoint=c,this._grabbedSphere.radius=this._targetZoomPoint.length();let d=n.eye.distance(c),u=new v,_=n.unproject(s,r,d,u);const p=u.sub(_.scaleTo(d));if(c=new V(p,_).hitSphere(this._grabbedSphere),!c)return;this._targetZoomPoint=c}else{let c=this._getTargetPoint(new H(s,r));if(!c)return;this._targetZoomPoint=c,this._grabbedSphere.radius=this._targetZoomPoint.length()}if(this._curPitch=n.getPitch(),this._curYaw=n.getYaw(),this._curRoll=n.getRoll(),Math.sign(i.wheelDelta)!==this._wheelDirection)return this.vel.scale(.3),this._currScreenPos.set(s,r),void(this._wheelDirection=Math.sign(i.wheelDelta));this._currScreenPos.set(s,r),this._wheelDirection=Math.sign(i.wheelDelta);let a=20;this._velInertia=.83,this._isTouchPad=i.isTouchPad,i.isTouchPad&&(this._velInertia=.63,a=17);let o=this._targetZoomPoint.sub(n.eye);o.length()>6e3&&this._wheelDirection>0&&n.eye.getNormal().negate().dot(o.normalize())<.3&&(a=4.3);let h=this.planet.camera.eye.distance(this._targetZoomPoint)*a;this.force=i.direction.scale(this._wheelDirection).normalize().scale(this._wheelDirection<0?1.3*h:h).scale(this.zoomSpeed),this.vel.set(0,0,0),this.force_roll=this._curRoll}},this._onLDown=i=>{this.stop(),this._targetRotationPoint=null,this._targetZoomPoint=null,this.planet&&(this.planet.stopFlying(),this._grabbedPoint=this._getTargetPoint(i.pos),this._grabbedPoint&&(this._targetDragPoint=this._grabbedPoint,this.planet.camera.isOrthographic?this._grabbedDist=this.renderer.getDistanceFromPixel(i.pos):this._grabbedDist=this.renderer.activeCamera.eye.distance(this._grabbedPoint),this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"),this._grabbedSphere.radius=this._grabbedPoint.length(),this._eye0=this.planet.camera.eye.clone(),this._grabbedCameraHeight=this._eye0.length(),this._curPitch=this.planet.camera.getPitch(),this._curYaw=this.planet.camera.getYaw(),this._curRoll=this.planet.camera.getRoll(),this._currScreenPos.copy(i.pos)))},this._onLHold=i=>{if(this._grabbedPoint&&this.planet){let s=this.planet.camera;if(s.isOrthographic){const r=this._grabbedDist,n=new v,a=s.unproject(i.x,i.y,r,n),o=n.sub(a.scaleTo(r)),h=new V(o,a).hitSphere(this._grabbedSphere);if(!h)return;this._targetDragPoint=h;let c=F.getRotationBetweenVectors(this._targetDragPoint.getNormal(),this._grabbedPoint.getNormal()).mulVec3(s.eye);this.force=c.sub(s.eye).scale(this.dragInertia)}else if(s.slope>this.minSlope){this._grabbedDist=s.eye.distance(this._grabbedPoint);let r,n=s.unproject(i.x,i.y,this._grabbedDist),a=new V(s.eye,n).hitSphere(this._grabbedSphere);if(!a)return;if(this._targetDragPoint=a,this.freeMode)r=F.getRotationBetweenVectors(this._targetDragPoint.getNormal(),this._grabbedPoint.getNormal());else{let h=v.NORTH,c=Math.acos(a.dot(h)/this._grabbedSphere.radius)-Math.acos(this._grabbedPoint.dot(h)/this._grabbedSphere.radius),d=s.eyeNorm.dot(v.NORTH);(c>0&&d>=this.poleThreshold||c<0&&d<=-this.poleThreshold)&&(c=0);let u=F.axisAngleToQuat(h.cross(s.eyeNorm).normalize(),-c),_=v.proj_b_to_plane(a,h),p=v.proj_b_to_plane(this._grabbedPoint,h);r=F.getRotationBetweenVectors(_.getNormal(),p.getNormal()).mul(u)}let o=r.mulVec3(s.eye);this.force=o.sub(s.eye).scale(this.dragInertia)}else{let r=this._grabbedPoint,n=v.add(r,s.getRight()),a=v.add(r,r.getNormal()),o=new v;new V(s.eye,i.direction).hitPlaneRes(pe.fromPoints(r,n,a),o);let h=s.eye.add(o.subA(r).negate());this.force=h.sub(s.eye).scale(this.dragInertia),this._targetDragPoint=o}this.vel.set(0,0,0),this._currScreenPos.equal(i.pos)||this._currScreenPos.copy(i.pos),this._hold=!0}},this._onLUp=i=>{this._hold=!1,this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")},this.events=le(Zl,this),this.force=new v,this.force_h=0,this.force_v=0,this.vel=new v,this.vel_h=0,this.vel_v=0,this.vel_roll=0,this.force_roll=0,this.mass=t.mass!=null?t.mass:1,this.inertia=t.inertia!=null?t.inertia:1,this._velInertia=Ti,this.minSlope=t.minSlope!=null?t.minSlope:.35,this.dragInertia=t.dragInertia!=null?t.dragInertia:170,this.zoomSpeed=t.zoomSpeed!=null?t.zoomSpeed:1,this.poleThreshold=t.poleThreshold!=null?t.poleThreshold:.999,this.disableRotation=t.disableRotation!=null&&t.disableRotation,this.disableTilt=t.disableTilt!=null&&t.disableTilt,this._lookPos=void 0,this._grabbedPoint=null,this._grabbedDist=0,this._targetZoomPoint=null,this._targetDragPoint=null,this._targetRotationPoint=null,this._tUp=new v,this._tRad=0,this._rotHDir=0,this._rotVDir=0,this._wheelDirection=1,this._currScreenPos=new H,this._grabbedSphere=new Be,this._rot=new F,this._curPitch=0,this._curYaw=0,this._curRoll=0,this._eye0=new v,this._newEye=new v,this._grabbedCameraHeight=0,this._isTouchPad=!1,this._freeMode=!1,this.mode=this._modeToNumber(t.mode||"adaptive")}oninit(){this.renderer&&(this.renderer.events.on("keyfree",W.KEY_ALT,this._onShiftFree),this.renderer.events.on("keyfree",W.KEY_PRINTSCREEN,this._onShiftFree))}onadd(){var t;(t=this.planet)!=null&&t.camera&&this.planet.camera.events.on("flystart",this._onCameraFly)}onremove(){var t;(t=this.planet)!=null&&t.camera&&this.planet.camera.events.off("flystart",this._onCameraFly)}onactivate(){super.onactivate();let t=this.renderer;t.events.on("mousewheel",this._onMouseWheel),t.events.on("rhold",this._onRHold),t.events.on("rdown",this._onRDown),t.events.on("lhold",this._onLHold),t.events.on("ldown",this._onLDown),t.events.on("lup",this._onLUp),t.events.on("draw",this.onDraw,this,-1e3),t.events.on("mousemove",this._onMouseMove),t.events.on("mouseleave",this._onMouseLeave),t.events.on("mouseenter",this._onMouseEnter)}ondeactivate(){super.ondeactivate();let t=this.renderer;t.events.off("mousewheel",this._onMouseWheel),t.events.off("rhold",this._onRHold),t.events.off("rdown",this._onRDown),t.events.off("lhold",this._onLHold),t.events.off("ldown",this._onLDown),t.events.off("lup",this._onLUp),t.events.off("draw",this.onDraw),t.events.off("mousemove",this._onMouseMove),t.events.off("mouseleave",this._onMouseLeave),t.events.off("mouseenter",this._onMouseEnter)}onDraw(){this._updateVel(),this._handleZoom(),this._handleDrag(),this._handleRotation()}_handleRotation(){if((!this.disableRotation||!this.disableTilt)&&this.planet&&this._targetRotationPoint){let t=this.planet.camera;if((this.disableRotation||this.vel_h===0)&&(this.disableTilt||this.vel_v===0))return;if(!this.disableRotation){let i=this.vel_h*this.dt;t.rotateHorizontal(i,!1,this._targetRotationPoint,this._tUp)}if(!this.disableTilt){let i=this.vel_v*this.dt;t.rotateVertical(i,this._targetRotationPoint,.1)}this.events.dispatch(this.events.rotate,this),this._curPitch=t.getPitch(),this._curYaw=t.getYaw(),this._curRoll=t.getRoll(),this._velInertia=Ti}}_getTargetPoint(t){return this.planet?this.planet.camera.isOrthographic?this.renderer.getCartesianFromPixel(t)||null:this.planet.camera.getAltitude()>8e4?this.planet.getCartesianFromPixelEllipsoid(t)||null:this.planet.getCartesianFromPixelTerrain(t)||null:null}get freeMode(){return this.mode!==1&&(this.mode===0||this._freeMode)}setMode(t){this.mode=this._modeToNumber(t)}_modeToNumber(t){switch(t){case"lockNorth":return 1;case"free":return 0;default:return 2}}_handleDrag(){if(this.planet&&this._targetDragPoint&&this._grabbedPoint&&this.vel.length()>.1){this._velInertia=Ti;let t=this.planet.camera;if(t.slope>this.minSlope){let i=this.vel.scaleTo(this.dt),s=v.proj_b_to_plane(i,t.eyeNorm),r=t.eye.add(s).normalize().scale(this._grabbedCameraHeight);if(this.freeMode){let n=F.getRotationBetweenVectors(t.eye.getNormal(),r.getNormal());t.rotate(n),t.eye.copy(r)}else{let n=r.getNormal().dot(v.NORTH),a=t.eyeNorm.dot(v.NORTH);(n>a&&n>=this.poleThreshold||n<a&&n<=-this.poleThreshold)&&this.vel.scale(.8),t.eye.copy(r),this._corrRoll(),t.setPitchYawRoll(this._curPitch,this._curYaw,this._curRoll)}}else{let i=this.vel.scaleTo(this.dt),s=t.eye.add(i);t.eye.copy(s),t.checkTerrainCollision(),this._corrRoll(),t.setPitchYawRoll(this._curPitch,this._curYaw,this._curRoll)}this.events.dispatch(this.events.drag,this)}}_corrRoll(){this.planet.camera.slope<.5&&(this._curRoll-=this.vel_roll*this.dt,this._curRoll<.01*Math.PI/180&&(this._curRoll=.01*Math.PI/180))}_handleZoom(){if(this._targetZoomPoint&&this.vel.length()>.1){let t=this.planet.camera,i=this._targetZoomPoint,s=t.eye.clone(),r=i.sub(t.eye).normalize(),n=this.vel.getNormal(),a=Math.sign(n.dot(t.getForward())),o=this.vel.scaleTo(this.dt);this._grabbedSphere.radius>s.length()&&(a*=-1);let h=t.getForward().scaleTo(a*o.length());s.addA(h),this.events.dispatch(this.events.zoom,this);let c=t.maxAltitude+this.planet.ellipsoid.getEquatorialSize();if(s.length()>c)return void s.copy(s.getNormal().scale(c));let d=new V(s,r).hitSphere(this._grabbedSphere);if(!d)return void this.vel.set(0,0,0);let u=F.getRotationBetweenVectors(d.getNormal(),i.getNormal());if(t.eye=u.mulVec3(s),t.rotate(u),!this.freeMode){this._corrRoll(),t.setPitchYawRoll(this._curPitch,this._curYaw,this._curRoll),t.update();let _=t.unproject2v(this._currScreenPos,t.eye.distance(this._targetZoomPoint)),p=i.sub(t.eye).normalize(),f=new v,m=new v,g=pe.fromPoints(i,i.add(t.getUp()),i.add(t.getRight()));new V(t.eye,_).hitPlaneRes(g,f),new V(t.eye,p).hitPlaneRes(g,m);let y=m.sub(f);t.eye=t.eye.add(y),this._corrRoll(),t.setPitchYawRoll(this._curPitch,this._curYaw,this._curRoll)}if(t.checkTerrainCollision(),t.isOrthographic){let _=t.getAltitude();_&&(t.focusDistance=Math.abs(_))}}}_updateVel(){let t=this.force.scale(1/this.mass);this.vel.addA(t),this.vel.scale(this.velocityInertia),this.vel.length()<.001&&this.vel.set(0,0,0),this.force.set(0,0,0),this._updateVel_h(),this._updateVel_v(),this._updateVel_roll()}_updateVel_h(){let t=this.force_h/this.mass;this.vel_h+=t,this.vel_h*=this.velocityInertia,Math.abs(this.vel_h)<.001&&(this.vel_h=0),this.force_h=0}_updateVel_v(){let t=this.force_v/this.mass;this.vel_v+=t,this.vel_v*=this.velocityInertia,Math.abs(this.vel_v)<.001&&(this.vel_v=0),this.force_v=0}_updateVel_roll(){let t=this.force_roll/this.mass;this.vel_roll+=t,this.vel_roll*=this.velocityInertia,this.force_roll=0}get dt(){return .001*this.renderer.handler.deltaTime}get velocityInertia(){return this._velInertia*this.inertia}stop(){this.vel.set(0,0,0),this.vel_h=0,this.vel_v=0,this._velInertia=Ti,this._targetZoomPoint=null,this._grabbedPoint=null,this._targetRotationPoint=null,this._targetDragPoint=null}}const Fr=l=>l>1e3?`${(l/1e3).toFixed(1)} km`:l>9?`${Math.round(l)} m`:`${l.toFixed(1)} m`;let Ql=$.createCylinder(1.1,0,2.7,20,1,!0,!1,0,0,0);const Kl={text:"",size:11,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"center",offset:[0,20,0]},Or={scale:1,instanced:!0,tag:"ruler",color:"rgb(0,305,0)",object3d:Ql};class io extends lt{constructor(t={}){super(t.name),this._onCornerLdown=i=>{var s,r;if(!this._startLonLat){(r=(s=this.renderer)==null?void 0:s.controls.navigation)==null||r.deactivate(),this._startClick.set(i.x,i.y);let n=i.pickingObject.getCartesian();this._startPos=this._planet.getPixelFromCartesian(n),this._pickedCorner=i.pickingObject,i.pickingObject.properties.name=="start"?this._anchorLonLat=this._cornerEntity[1].getLonLat().clone():this._anchorLonLat=this._cornerEntity[0].getLonLat().clone()}},this._onLUp=()=>{var i;this._pickedCorner&&((i=this.renderer.controls.navigation)==null||i.activate(),this._pickedCorner=null,this._anchorLonLat=null)},this._onCornerLup=()=>{this._onLUp()},this._onCornerEnter=i=>{i.renderer.handler.canvas.style.cursor="pointer"},this._onCornerLeave=i=>{i.renderer.handler.canvas.style.cursor="default"},this._onLdblclick=()=>{this._preventClick=!0},this._onLclick=i=>{let s=this._planet.getLonLatFromPixelTerrain(i.pos);s&&(this._timeout=setTimeout((()=>{this._preventClick||(this._startLonLat?this._startLonLat=null:(this.setVisibility(!0),this._stopDrawing=!1,this._startLonLat=s)),this._preventClick=!1,this._stopDrawing=!1,clearTimeout(this._timeout)}),200),this._startLonLat&&(this._stopDrawing=!0))},this._onMouseMove=i=>{if(this._startLonLat&&!this._stopDrawing){this._propsLabel.label.setVisibility(!0);let s=this._planet.getLonLatFromPixelTerrain(i.pos);if(!s)return;this._drawLine(this._startLonLat,s)}else if(this._pickedCorner){let s=this._planet.getLonLatFromPixelTerrain(i.pos);s&&(this._pickedCorner.properties.name==="start"?this._drawLine(s,this._anchorLonLat):this._drawLine(this._anchorLonLat,s))}},this.events=le(Jl),this._ignoreTerrain=t.ignoreTerrain==null||t.ignoreTerrain,this._planet=t.planet||null,this._startLonLat=null,this._preventClick=!1,this._stopDrawing=!1,this._pickedCorner=null,this._startPos=null,this._startClick=new H,this._anchorLonLat=null,this._heading=0,this._trackLayer=new ue("track",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-1,relativeToGround:!0,hideInLayerSwitcher:!0}),this._labelLayer=new ue("ruler-label",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-100,relativeToGround:!0,hideInLayerSwitcher:!0}),this._cornersLayer=new ue("corners",{entities:[],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[100,4e6,1],pickingScale:2}),this._propsLabel=new U({name:"propsLabel",label:Kl}),this._trackEntity=new U({polyline:{path3v:[],thickness:4.8,color:"rgb(255,131,0)",isClosed:!1}}),this._trackEntity.polyline.altitude=.01,this._cornerEntity=[new U({geoObject:Or,properties:{name:"start"}}),new U({geoObject:Or,properties:{name:"end"}})]}set ignoreTerrain(t){this._ignoreTerrain=t}bindPlanet(t){this._planet=t}_createCorners(){this._cornersLayer.addEntities(this._cornerEntity)}init(){this._createCorners(),this._trackLayer.addEntities([this._trackEntity]),this._labelLayer.addEntities([this._propsLabel]),this._planet.addLayer(this._labelLayer),this._planet.addLayer(this._trackLayer),this._planet.addLayer(this._cornersLayer),this._activate()}onremove(){this._deactivate()}_activate(){this._propsLabel.label.setVisibility(!1),this.setVisibility(!1),this.renderer.events.on("lclick",this._onLclick,this),this.renderer.events.on("mousemove",this._onMouseMove,this),this.renderer.events.on("ldblclick",this._onLdblclick,this),this.renderer.events.on("lup",this._onLUp,this),this._cornersLayer.events.on("mouseenter",this._onCornerEnter,this),this._cornersLayer.events.on("mouseleave",this._onCornerLeave,this),this._cornersLayer.events.on("ldown",this._onCornerLdown,this),this._cornersLayer.events.on("lup",this._onCornerLup,this)}_deactivate(){this._startLonLat=null,this._preventClick=!1,this._stopDrawing=!1,this._pickedCorner=null,this.renderer.events.off("lclick",this._onLclick),this.renderer.events.off("mousemove",this._onMouseMove),this.renderer.events.off("lup",this._onLUp),this._cornersLayer.events.off("mouseenter",this._onCornerEnter),this._cornersLayer.events.off("mouseleave",this._onCornerLeave),this._cornersLayer.events.off("ldown",this._onCornerLdown),this._cornersLayer.events.off("lup",this._onCornerLup),this.clear()}setVisibility(t){this._cornersLayer.setVisibility(t),this._trackLayer.setVisibility(t),this._labelLayer.setVisibility(t)}_drawLine(t,i,s){s||(s=this._planet.ellipsoid.lonLatToCartesian(t));let r=this._planet.ellipsoid.lonLatToCartesian(i),n=this._planet.ellipsoid.inverse(t,i),a=n.distance;this._heading=n.initialAzimuth;let o=[],h=r.sub(s),c=h.length();h.normalize();for(let d=0;d<120;d++){let u=h.scaleTo(d*c/120).addA(s);o.push(u)}o.push(r),this._trackEntity.polyline.setPath3v([o]),this._ignoreTerrain&&(this._propsLabel.setCartesian3v(o[Math.floor(o.length/2)]),this._propsLabel.label.setText(`${Fr(a)}, ${Math.round(this._heading)} deg`))}clear(){this._trackEntity.remove(),this._cornerEntity[0].remove(),this._cornerEntity[1].remove(),this._propsLabel.remove(),this._planet.removeLayer(this._trackLayer),this._planet.removeLayer(this._cornersLayer)}isCornersPositionChanged(){let t=this._trackEntity.polyline.getPath3v()[0];if(t){const i=t[0].clone(),s=t[t.length-1].clone();return this._cornerEntity[0].getCartesian().equal(i)&&this._cornerEntity[1].getCartesian().equal(s)}return!1}frame(){let t=this._trackEntity.polyline.getPath3v()[0];if(t){const i=t[0].clone(),s=t[t.length-1].clone();if(!this.isCornersPositionChanged()&&(this._cornerEntity[0].setCartesian3v(i),this._cornerEntity[1].setCartesian3v(s),!this._ignoreTerrain)){let r=0;for(let n=0,a=t.length-1;n<a;n++)r+=t[n+1].distance(t[n]);this._propsLabel.setCartesian3v(t[Math.floor(t.length/2)]),this._propsLabel.label.setText(`${Fr(r)}, ${Math.round(this._heading)} deg`)}}}get ellipsoid(){return this._planet?this._planet.ellipsoid:null}}const Jl=["add","remove","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];class so extends K{constructor(t={}){super(t),this._rulerScene=new io({name:`rulerScene:${this.__id}`,ignoreTerrain:t.ignoreTerrain})}set ignoreTerrain(t){this._rulerScene.ignoreTerrain=t}oninit(){this._rulerScene.bindPlanet(this.planet)}onactivate(){this.renderer&&this.renderer.addNode(this._rulerScene)}ondeactivate(){this.renderer&&this.renderer.removeNode(this._rulerScene)}}let eh=$.createCylinder(1.1,0,2,6,1,!0,!0,0,0,0);const Nr={startColor:"rgb(255,131,0)",endColor:"rgb(255,131,0)",thickness:5},os={text:"",size:11,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"center",offset:[0,18,0]},Hr={scale:1,instanced:!0,tag:"height-ruler",color:"rgb(255,131,0)",object3d:eh};class th extends io{constructor(t={}){super(t),this._geoRulerLayer=new ue("rayHeightRuler",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-2,relativeToGround:!1,hideInLayerSwitcher:!0}),this._rayV=new U({name:"verticalRay",ray:Nr}),this._rayH=new U({name:"heightRay",ray:Nr}),this._heightLabels=[new U({name:"startCornerLabel",label:{...os}}),new U({name:"endCornerLabel",label:{...os}}),new U({name:"deltaLabel",label:{...os}})]}setVisibility(t){super.setVisibility(t),this._geoRulerLayer.setVisibility(t)}get deltaLabel(){return this._heightLabels[2]}get startLabel(){return this._heightLabels[0]}get endLabel(){return this._heightLabels[1]}get corners(){return this._cornerEntity}get startCorner(){return this.corners[0]}get endCorner(){return this.corners[1]}get startCornerLonLat(){return this.startCorner.getLonLat()}get startCornerHeight(){return this.startCornerLonLat.height}get endCornerLonLat(){return this.endCorner.getLonLat()}get endCornerHeight(){return this.endCornerLonLat.height}get maxHeightCornerLonLat(){return this.startCornerHeight<=this.endCornerHeight?this.endCornerLonLat:this.startCornerLonLat}get minHeightCornerLonLat(){return this.startCornerHeight>this.endCornerHeight?this.endCornerLonLat:this.startCornerLonLat}get deltaHeight(){return Math.abs(this.startCornerHeight-this.endCornerHeight)}_drawLine(t,i,s){super._drawLine(t,i,s),this._updateHeightRaysAndLabels()}async _updateHeightRaysAndLabels(){const t=this.minHeightCornerLonLat.clone();t.height=this.maxHeightCornerLonLat.height,this._rayH.ray.setStartPosition3v(this._planet.ellipsoid.lonLatToCartesian(this.maxHeightCornerLonLat)),this._rayH.ray.setEndPosition3v(this._planet.ellipsoid.lonLatToCartesian(t)),this._rayV.ray.setStartPosition3v(this._planet.ellipsoid.lonLatToCartesian(this.minHeightCornerLonLat)),this._rayV.ray.setEndPosition3v(this._planet.ellipsoid.lonLatToCartesian(t)),t.height=this.minHeightCornerLonLat.height+this.deltaHeight/2,this.deltaLabel.setLonLat(t),this.startLabel.setLonLat(this.startCornerLonLat),this.endLabel.setLonLat(this.endCornerLonLat);const i=await this._planet.getHeightDefault(this.startCornerLonLat),s=await this._planet.getHeightDefault(this.endCornerLonLat);this.deltaLabel.label.setText(` ${Math.abs(i-s).toFixed(1)} m`),this.startLabel.label.setText(`P1 ${i.toFixed(1)} m`),this.endLabel.label.setText(`P2 ${s.toFixed(1)} m`)}clear(){this._rayH.remove(),this._rayV.remove(),this.startCorner.remove(),this.endCorner.remove(),this.startLabel.remove(),this.endLabel.remove(),this.deltaLabel.remove(),super.clear(),this._planet.removeLayer(this._geoRulerLayer)}_createCorners(){this._cornerEntity=[new U({geoObject:Hr,properties:{name:"start"}}),new U({geoObject:Hr,properties:{name:"end"}})],this._cornersLayer.setEntities(this._cornerEntity)}init(){super.init(),this._createCorners(),this._labelLayer.addEntities(this._heightLabels),this._geoRulerLayer.addEntities([this._rayH,this._rayV]),this._planet.addLayer(this._geoRulerLayer)}frame(){super.frame(),this._updateHeightRaysAndLabels()}}class Vr extends so{constructor(t={}){super(t),this._rulerScene=new th({name:`heightRulerScene:${this.__id}`,ignoreTerrain:!1})}}const ls=[.001,.005,.01,.05,.1,.2,.5,1,2,3,5,10,20,30,50,100,200,300,500,1e3,2e3,3e3,5e3,1e4,2e4,3e4,5e4,1e5,2e5,3e5,5e5,1e6,2e6,3e6,5e6,1e7];class ro extends K{constructor(t={}){t.name&&t.name!==""||(t.name="scaleControl"),super(t),this._template=`<div class="og-scale-container">
      <div class="og-scale-label"></div>
      <div class="og-scale-ruler"></div>
    </div>`,this._minWidth=100,this._maxWidth=150,this._isCenter=t.isCenter==null||t.isCenter,this._mPx=0,this.currWidth=0,this._metersInMinSize=0,this.el=null,this._scaleLabelEl=null}_renderTemplate(){return $s(this._template)[0]}oninit(){this.el=this._renderTemplate(),this._scaleLabelEl=this.el.querySelector(".og-scale-label"),this.renderer.div.appendChild(this.el),this._isCenter?(this.planet.camera.events.on("moveend",(()=>{this._drawScreen(this.planet.renderer.handler.getCenter())})),!this.planet.terrain.isEmpty&&this.planet.terrain.events.on("loadend",(()=>{this._drawScreen(this.planet.renderer.handler.getCenter())}))):(this.renderer.events.on("mousemove",(t=>{t.leftButtonHold||t.rightButtonHold||this._drawScreen(t.pos)})),this.planet.camera.events.on("moveend",(()=>{let t=this.renderer.events.mouseState;t.leftButtonHold||t.rightButtonHold||this._drawScreen(t.pos)})))}_drawScreen(t){let i=this.planet.camera,s=t,r=this.planet.getDistanceFromPixel(s)||0;r===0&&(s=i.project3v(v.ZERO),r=this.planet.getDistanceFromPixel(s)||0);let n=i.getForward().scaleTo(r).addA(i.eye),a=r*Math.tan(i.viewAngle*G),o=n.add(i.getRight().scaleTo(a)),h=i.project3v(o);this._mPx=a/h.distance(s);let c=this._mPx*this._minWidth,d=Et(ls,c,((p,f)=>p-f));d<0&&(d=~d);let u=ls[d],_=(u-c)/(ls[d+1]-u);this.currWidth=this._minWidth+_*(this._maxWidth-this._minWidth),this._scaleLabelEl.innerText=u>=1e3?u/1e3+" km":u>=1?`${u} m`:u>=.01?100*u+" cm":1e3*u+" mm",this._metersInMinSize=c,this.el.style.width=this.currWidth+"px"}}class no extends K{constructor(t={}){super({name:"SimpleSkyBackground",...t}),this._colorOne=new Float32Array([128/255,223/255,1]),this._colorTwo=new Float32Array([10/255,15/255,56/255])}get colorOne(){let t=this._colorOne;return As([Math.round(255*t[0]),Math.round(255*t[1]),Math.round(255*t[2])])}get colorTwo(){let t=this._colorTwo;return As([Math.round(255*t[0]),Math.round(255*t[1]),Math.round(255*t[2])])}set colorOne(t){let i=Gi(t);this._colorOne[0]=i.x,this._colorOne[1]=i.y,this._colorOne[2]=i.z}set colorTwo(t){let i=Gi(t);this._colorTwo[0]=i.x,this._colorTwo[1]=i.y,this._colorTwo[2]=i.z}oninit(){this.renderer.handler.addProgram(new X("simpleSkyBackground",{uniforms:{iResolution:"vec2",fov:"float",camPos:"vec3",earthRadius:"float",viewMatrix:"mat4",colorOne:"vec3",colorTwo:"vec3"},attributes:{corners:"vec3"},vertexShader:`attribute vec2 corners;
                        
            varying vec2 tc;
            
            void main(void) {
                gl_Position = vec4(corners, 0.0, 1.0);
                tc = corners * 0.5 + 0.5;
            }`,fragmentShader:`precision highp float;
            
            #define MAX 10e10
            #define PI 3.14159265359
            #define rad(x) x * PI / 180.
            #define ZERO vec3(0.0)          
           
            #define RED vec4(1.0, 0.0, 0.0, 1.0)
            #define GREEN vec4(0.0, 1.0, 0.0, 1.0)         
            
            uniform vec3 camPos;            
            uniform vec2 iResolution;
            uniform float fov;
            uniform float earthRadius;
            uniform mat4 viewMatrix;
            
            uniform vec3 colorOne;
            uniform vec3 colorTwo;
                         
            varying vec2 tc;
                        
            // compute the view ray in the camera coordinate
            vec3 computeView(vec2 uv){
                float w_h_ratio = iResolution.x / iResolution.y;   
                float h = tan(rad(fov/2.));
                return normalize(vec3(-w_h_ratio * h, -h, -1.) + vec3(uv.x * 2. * h * w_h_ratio, uv.y*2.*h, 0.));
            }

            // sphere of size ra centered at point ce
            vec2 sphIntersect( in vec3 ro, in vec3 rd, in vec3 ce, float ra )
            {
                vec3 oc = ro - ce;
                float b = dot( oc, rd );
                float c = dot( oc, oc ) - ra * ra;
                float h = b * b - c;
                if( h < 0.0 ) return vec2(MAX); // no intersection
                h = sqrt( h );
                return vec2( -b-h, -b+h );
            }
            
            mat3 transpose(mat3 matrix) {
                vec3 row0 = matrix[0];
                vec3 row1 = matrix[1];
                vec3 row2 = matrix[2];
                mat3 result = mat3(
                    vec3(row0.x, row1.x, row2.x),
                    vec3(row0.y, row1.y, row2.y),
                    vec3(row0.z, row1.z, row2.z)
                );
                return result;
            }
            
            float det(mat2 matrix) {
                return matrix[0].x * matrix[1].y - matrix[0].y * matrix[1].x;
            }
            
            mat3 inverse(mat3 matrix) {
                vec3 row0 = matrix[0];
                vec3 row1 = matrix[1];
                vec3 row2 = matrix[2];
            
                vec3 minors0 = vec3(
                    det(mat2(row1.y, row1.z, row2.y, row2.z)),
                    det(mat2(row1.z, row1.x, row2.z, row2.x)),
                    det(mat2(row1.x, row1.y, row2.x, row2.y))
                );
                vec3 minors1 = vec3(
                    det(mat2(row2.y, row2.z, row0.y, row0.z)),
                    det(mat2(row2.z, row2.x, row0.z, row0.x)),
                    det(mat2(row2.x, row2.y, row0.x, row0.y))
                );
                vec3 minors2 = vec3(
                    det(mat2(row0.y, row0.z, row1.y, row1.z)),
                    det(mat2(row0.z, row0.x, row1.z, row1.x)),
                    det(mat2(row0.x, row0.y, row1.x, row1.y))
                );
            
                mat3 adj = transpose(mat3(minors0, minors1, minors2));
            
                return (1.0 / dot(row0, minors0)) * adj;
            }
            
            void main(void) {
            
                vec3 dir = computeView(tc);
                dir = inverse(mat3(viewMatrix)) * dir;
                
                vec2 ER = sphIntersect(camPos, dir, vec3(0.0), earthRadius);
                
                float bigRadius = earthRadius * 2.5;
                vec3 bigCenter = normalize(camPos) * bigRadius * 1.3;                
                               
                vec2 BIG = sphIntersect(camPos, dir, bigCenter, bigRadius);
                
                float Ix = distance(camPos + dir * BIG.y, ZERO);               
                
                float maxI = sqrt(bigRadius * bigRadius + bigRadius * bigRadius);
                                   
                gl_FragColor = vec4(mix(colorOne, colorTwo, Ix / maxI), 1.0);
            }`})),this.activate()}onactivate(){super.onactivate(),this.planet.events.on("draw",this._drawBackground,this)}ondeactivate(){super.ondeactivate(),this.planet.events.off("draw",this._drawBackground)}_drawBackground(){let t=this.renderer.handler,i=t.programs.simpleSkyBackground,s=i._program,r=s.uniforms,n=t.gl,a=this.planet.camera;n.disable(n.DEPTH_TEST),i.activate(),n.bindBuffer(n.ARRAY_BUFFER,this.renderer.screenFramePositionBuffer),n.vertexAttribPointer(s.attributes.corners,2,n.FLOAT,!1,0,0),n.uniform3fv(r.camPos,[a.eye.x,a.eye.y,a.eye.z]),n.uniform2fv(r.iResolution,[t.getWidth(),t.getHeight()]),n.uniform1f(r.fov,a.getViewAngle()),n.uniform1f(r.earthRadius,this.planet.ellipsoid.getPolarSize()+1),n.uniform3fv(r.colorOne,this._colorOne),n.uniform3fv(r.colorTwo,this._colorTwo),n.uniformMatrix4fv(r.viewMatrix,!1,a.getViewMatrix()),n.drawArrays(n.TRIANGLE_STRIP,0,4),n.enable(n.DEPTH_TEST)}}const hs=14959787e4;function cs(l){var t=l-qi,i=282.9404+470935e-10*t,s=.016709-1151e-12*t,r=Cs(356.047+.9856002585*t),n=23.4392911-3563e-10*t,a=r+J*s*Math.sin(r*G)*(1+s*Math.cos(r*G)),o=Math.cos(a*G)-s,h=Math.sin(a*G)*Math.sqrt(1-s*s),c=Math.sqrt(o*o+h*h),d=Cs(Math.atan2(h,o)*J+i),u=o=c*Math.cos(d*G),_=(h=c*Math.sin(d*G))*Math.cos(n*G),p=h*Math.sin(n*G),f=Oi*(24*t/23.9344694-259.853/360);return F.zRotation(-f).mulVec3(new v(-u*hs,-_*hs,p*hs))}class ih{constructor(t){this._renderNode=null,this._position=t.position||new v,this._ambient=t.ambient||new v,this._diffuse=t.diffuse||new v(.8,.8,.8),this._specular=t.specular||new v(.18,.18,.18),this._shininess=t.shininess!=null?t.shininess:3.3,this._active=!0,this._tempAmbient=this._ambient.clone(),this._tempDiffuse=this._diffuse.clone(),this._tempSpecular=this._specular.clone(),this._tempShininess=this._shininess}isActive(){return this._active}setPosition3v(t){this.setPosition(t.x,t.y,t.z)}setPosition(t,i,s){this._position.x=t,this._position.y=i,this._position.z=s,this._renderNode&&(this._renderNode._lightPosition[0]=t,this._renderNode._lightPosition[1]=i,this._renderNode._lightPosition[2]=s)}getPosition(){return this._position.clone()}setAmbient3v(t){this.setAmbient(t.x,t.y,t.z)}setDiffuse3v(t){this.setDiffuse(t.x,t.y,t.z)}setSpecular3v(t){this.setSpecular(t.x,t.y,t.z)}setAmbient(t,i,s){this._ambient.set(t,i,s);const r=this._renderNode;r&&(r._lightParams[0]=t,r._lightParams[1]=i,r._lightParams[2]=s)}setDiffuse(t,i,s){this._diffuse.set(t,i,s);const r=this._renderNode;r&&(r._lightParams[3]=t,r._lightParams[4]=i,r._lightParams[5]=s)}setSpecular(t,i,s){this._specular.set(t,i,s);const r=this._renderNode;r&&(r._lightParams[6]=t,r._lightParams[7]=i,r._lightParams[8]=s)}setShininess(t){this._shininess=t;const i=this._renderNode;i&&(i._lightShininess=t)}addTo(t){this._renderNode=t,this.setShininess(this._shininess),this.setAmbient3v(this._ambient),this.setDiffuse3v(this._diffuse),this.setSpecular3v(this._specular)}}class Ns extends K{constructor(t={}){super({autoActivate:!0,...t}),this._name="sun",this.activationHeight=t.activationHeight||12079e3,this.offsetVertical=t.offsetVertical||-5e6,this.offsetHorizontal=t.offsetHorizontal||5e6,this.sunlight=new ih({ambient:new v(.15,.15,.25),diffuse:new v(.9,.9,.8),specular:new v(.1,.1,.06),shininess:110}),this._currDate=0,this._prevDate=0,this._clockPtr=null,this._lightOn=!1,this._f=0,this._k=0,this._stopped=t.stopped||!1}oninit(){this.planet.lightEnabled=!0,this.sunlight.addTo(this.planet),this.renderer.events.on("draw",this._draw,this),this._clockPtr||(this._clockPtr=this.renderer.handler.defaultClock)}stop(){this._stopped=!0,this.deactivate()}start(){this._stopped=!1,this.activate()}onactivate(){super.onactivate(),this._stopped=!1}bindClock(t){this._clockPtr=t}_draw(){if(this._clockPtr)if(this._currDate=this._clockPtr.currentDate,this._stopped)this.sunlight.setPosition3v(cs(this._currDate));else{let t=this.planet.camera;if(t.getHeight()<this.activationHeight||!this._active){this._lightOn=!0,this._f=1;let i=t.eye.normal(),s=t.getForward();s.scale(Math.sign(t.getUp().dot(i))),t.slope>.99&&(s=t.getUp());let r=v.proj_b_to_plane(s,i,s).normalize().scale(this.offsetVertical),n=v.proj_b_to_plane(t.getRight(),i,t.getRight()).normalize().scale(this.offsetHorizontal),a=r.add(n),o=t.eye.add(a);if(this._k>0){this._k-=.001;let h=F.getRotationBetweenVectors(this.sunlight._position.normal(),o.normal()).slerp(F.IDENTITY,this._k).normalize();this.sunlight.setPosition3v(h.mulVec3(this.sunlight._position))}else this.sunlight.setPosition3v(o)}else if(this._k=1,this._f>0){this._f-=.001;let i=F.getRotationBetweenVectors(this.sunlight._position.normal(),cs(this._currDate).normal()).slerp(F.IDENTITY,this._f).normalize();this.sunlight.setPosition3v(i.mulVec3(this.sunlight._position))}else(Math.abs(this._currDate-this._prevDate)>34e-5&&this._active||this._lightOn)&&(this._lightOn=!1,this._prevDate=this._currDate,this.sunlight.setPosition3v(cs(this._currDate)),this._f=0)}}}const sh=["inertiamove","drag","doubletapzoom"];class Ur{constructor(){this.x=0,this.y=0,this.prev_x=0,this.prev_y=0,this.grabbedPoint=null,this.grabbedSpheroid=new Be,this._vec=new H,this._vecPrev=new H}get dY(){return this.y-this.prev_y}get dX(){return this.x-this.prev_x}get vec(){return this._vec.set(this.x,this.y)}get vecPrev(){return this._vecPrev.set(this.prev_x,this.prev_y)}}class ao extends K{constructor(t={}){super(t),this._onCameraFly=()=>{this.stopRotation()},this._name="touchNavigation",this.events=le(sh,this),this.grabbedPoint=new v,this.inertia=t.inertia!=null?t.inertia:.007,this.minSlope=t.minSlope!=null?t.minSlope:.1,this.jerkLimit=t.jerkLimit!=null?t.jerkLimit:.3,this.grabbedSpheroid=new Be,this.planet=null,this.qRot=new F,this.scaleRot=0,this.rot=1,this._eye0=new v,this.pointOnEarth=null,this.earthUp=null,this.touches=[new Ur,new Ur],this._keyLock=new bi,this._touching=!1}oninit(){this.renderer&&(this.renderer.events.on("touchstart",this.onTouchStart,this),this.renderer.events.on("touchend",this.onTouchEnd,this),this.renderer.events.on("doubletouch",this.onDoubleTouch,this),this.renderer.events.on("touchcancel",this.onTouchCancel,this),this.renderer.events.on("touchmove",this.onTouchMove,this),this.renderer.events.on("draw",this.onDraw,this))}onadd(){var t;(t=this.planet)!=null&&t.camera&&this.planet.camera.events.on("flystart",this._onCameraFly)}onremove(){var t;(t=this.planet)!=null&&t.camera&&this.planet.camera.events.off("flystart",this._onCameraFly)}onTouchStart(t){const i=this.renderer.handler;if(this._touching=!0,t.sys.pointers.length===2){const s=this.touches[0],r=this.touches[1];s.x=(t.sys.pointers[0].clientX-t.sys.offsetLeft)*i.pixelRatio,s.y=(t.sys.pointers[0].clientY-t.sys.offsetTop)*i.pixelRatio,s.prev_x=s.x,s.prev_y=s.y,s.grabbedPoint=this.planet.getCartesianFromPixelTerrain(new H(s.x,s.y))||null,r.x=(t.sys.pointers[1].clientX-t.sys.offsetLeft)*i.pixelRatio,r.y=(t.sys.pointers[1].clientY-t.sys.offsetTop)*i.pixelRatio,r.prev_x=r.x,r.prev_y=r.y,r.grabbedPoint=this.planet.getCartesianFromPixelTerrain(new H(r.x,r.y))||null,this.pointOnEarth=this.planet.getCartesianFromPixelTerrain(this.renderer.handler.getCenter())||null,this.pointOnEarth&&(this.earthUp=this.pointOnEarth.normal()),s.grabbedPoint&&r.grabbedPoint&&(s.grabbedSpheroid.radius=s.grabbedPoint.length(),r.grabbedSpheroid.radius=r.grabbedPoint.length(),this.stopRotation())}else t.sys.pointers.length===1&&this._startTouchOne(t)}_startTouchOne(t){const i=this.touches[0],s=this.renderer.handler;i.x=(t.sys.pointers[0].clientX-t.sys.offsetLeft)*s.pixelRatio,i.y=(t.sys.pointers[0].clientY-t.sys.offsetTop)*s.pixelRatio,i.prev_x=i.x,i.prev_y=i.y,i.grabbedPoint=this.planet.getCartesianFromPixelTerrain(t)||null,this._eye0.copy(this.planet.camera.eye),i.grabbedPoint&&(i.grabbedSpheroid.radius=i.grabbedPoint.length(),this.stopRotation())}stopRotation(){this.qRot.clear(),this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock)}onDoubleTouch(t){this.planet.stopFlying(),this.stopRotation();const i=this.planet.getCartesianFromPixelTerrain(t);if(i){const s=this.planet.ellipsoid.cartesianToLonLat(i);this.planet.flyLonLat(new L(s.lon,s.lat,.57*this.planet.camera.eye.distance(i))),this.events.dispatch(this.events.doubletapzoom,this)}}onTouchEnd(t){t.sys.pointers.length===0&&(this._touching=!1),t.sys.pointers.length===1&&this._startTouchOne(t),Math.abs(this.touches[0].x-this.touches[0].prev_x)<3&&Math.abs(this.touches[0].y-this.touches[0].prev_y)<3&&(this.scaleRot=0)}onTouchCancel(t){}onTouchMove(t){let i=this.planet.camera;const s=this.renderer.handler;if(t.sys.pointers.length===2){this.renderer.controlsBag.scaleRot=1;let n=this.touches[0],a=this.touches[1];if(!n.grabbedPoint||!a.grabbedPoint)return;this.planet.stopFlying(),n.prev_x=n.x,n.prev_y=n.y,n.x=(t.sys.pointers[0].clientX-t.sys.offsetLeft)*s.pixelRatio,n.y=(t.sys.pointers[0].clientY-t.sys.offsetTop)*s.pixelRatio,a.prev_x=a.x,a.prev_y=a.y,a.x=(t.sys.pointers[1].clientX-t.sys.offsetLeft)*s.pixelRatio,a.y=(t.sys.pointers[1].clientY-t.sys.offsetTop)*s.pixelRatio;const o=n.vec.add(a.vec).scale(.5),h=this.planet.getCartesianFromPixelEllipsoid(o);if(h){this.pointOnEarth=h;const c=Math.atan2(n.prev_y-a.prev_y,n.prev_x-a.prev_x),d=Math.atan2(n.y-a.y,n.x-a.x)-c,u=i.eye.distance(this.pointOnEarth),_=n.vec.sub(a.vec),p=n.vecPrev.sub(a.vecPrev);let f=_.length()/p.length();const m=1+this.jerkLimit,g=1-this.jerkLimit;f=f>m?m:f<g?g:f;let y=u*-(1-f);i.eye.addA(i.getForward().scale(y)),i.rotateAround(-d,!1,this.pointOnEarth,this.earthUp);const x=n.vec.add(a.vec).scale(.5),b=n.vecPrev.add(a.vecPrev).scale(.5),T=x.sub(b).scale(-1);var r=.5/u*i._lonLat.height*G;r>.003&&(r=.003),i.rotateHorizontal(r*-T.x,!1,this.pointOnEarth,this.earthUp),i.rotateVertical(r*-T.y,this.pointOnEarth,this.minSlope),i.checkTerrainCollision(),i.update(),this.events.dispatch(this.events.drag,this)}this.scaleRot=0}else if(t.sys.pointers.length===1){let n=this.touches[0];if(n.prev_x=n.x,n.prev_y=n.y,n.x=(t.sys.pointers[0].clientX-t.sys.offsetLeft)*s.pixelRatio,n.y=(t.sys.pointers[0].clientY-t.sys.offsetTop)*s.pixelRatio,!n.grabbedPoint)return;this.planet.stopFlying();let a=t.direction,o=new V(i.eye,a).hitSphere(n.grabbedSpheroid);if(o)if(i.slope>.2){this.qRot=F.getRotationBetweenVectors(o.normal(),n.grabbedPoint.normal());let h=this.qRot;i.eye=h.mulVec3(i.eye),i.rotate(h),i.checkTerrainCollision(),i.update(),this.events.dispatch(this.events.drag,this),this.scaleRot=1}else{let h=n.grabbedPoint,c=v.add(h,i.getUp()),d=v.add(h,h.getNormal()),u=i.unproject(n.x,n.y),_=new v;new V(i.eye,u).hitPlaneRes(pe.fromPoints(h,c,d),_)===V.INSIDE&&(i.eye=this._eye0.addA(_.subA(h).negate()),i.checkTerrainCollision(),i.update(),this.events.dispatch(this.events.drag,this),this.scaleRot=0)}}}onDraw(){const t=this.renderer;if(t.controlsBag.scaleRot=this.scaleRot,this._touching)return;let i=this.planet.camera,s=i.eye.clone();if(!t.events.mouseState.leftButtonDown&&this.scaleRot){if(this.scaleRot-=this.inertia,this.scaleRot<=0)this.scaleRot=0;else{t.controlsBag.scaleRot=this.scaleRot;let r=this.qRot.slerp(F.IDENTITY,1-this.scaleRot*this.scaleRot*this.scaleRot).normalize();r.x||r.y||r.z||(this.scaleRot=0),i.eye=r.mulVec3(i.eye),i.rotate(r),i.checkTerrainCollision(),i.update(),this.events.dispatch(this.events.inertiamove,this)}this.setLock(i.eye.distance(s)/i.getAltitude()>.01)}}setLock(t){t?(this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock)):(this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock))}}class oo extends K{constructor(t={}){super(t),this._keyLock=new bi,this._move=0,this._targetPoint=null}oninit(){let t=new ot({classList:["og-map-button","og-zoomin-button"],icon:'<?xml version="1.0"?><svg width=24 height=24 xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">    <path d="M 11 5 L 11 11 L 5 11 L 5 13 L 11 13 L 11 19 L 13 19 L 13 13 L 19 13 L 19 11 L 13 11 L 13 5 L 11 5 z"/></svg>'});t.appendTo(this.renderer.div);let i=new ot({classList:["og-map-button","og-zoomout-button"],icon:'<?xml version="1.0"?><svg width=24 height=24 xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">    <path d="M 5 11 L 5 13 L 19 13 L 19 11 L 5 11 z"/></svg>'});i.appendTo(this.renderer.div),t.events.on("mousedown",(()=>this.zoomIn())),t.events.on("mouseup",(()=>this.stopZoom())),i.events.on("mousedown",(()=>this.zoomOut())),i.events.on("mouseup",(()=>this.stopZoom())),t.events.on("touchstart",(()=>this.zoomIn())),t.events.on("touchend",(()=>this.stopZoom())),t.events.on("touchcancel",(()=>this.stopZoom())),i.events.on("touchstart",(()=>this.zoomOut())),i.events.on("touchend",(()=>this.stopZoom())),i.events.on("touchcancel",(()=>this.stopZoom())),this.renderer.events.on("draw",this._draw,this)}zoomIn(){this.renderer.controls.navigation.stop(),this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock),this._targetPoint=this.renderer.getCenter(),this._move=1}zoomOut(){this.renderer.controls.navigation.stop(),this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock),this._targetPoint=this.renderer.getCenter(),this._move=-1}stopZoom(){this._move=0,this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock)}_draw(t){const i=this.planet.camera;if(this._move!==0){const s=this.planet.getCartesianFromPixelTerrain(t.getCenter());if(s){let r=.035*i.eye.distance(s);i.eye.addA(i.getForward().scale(this._move*r)),i.checkTerrainCollision(),i.update()}}}}class rh extends lt{constructor(t={}){var i,s;super(t.name),this._ignoreTerrain=!1,this.events=new ir(nh),this._ignoreTerrain=t.ignoreTerrain==null||t.ignoreTerrain,this._onSelect=t.onSelect||null,this._autoSelectionHide=t.autoSelectionHide||!1,this._planet=t.planet||null,this._startLonLat=null,this._heading=0,this._propsLabel=new U({name:"propsLabel",label:{text:"",size:11,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"center",offset:[0,18]}}),(s=(i=this._propsLabel)==null?void 0:i.label)==null||s.setVisibility(!1),this._trackEntity=new U({polyline:{path3v:[],thickness:3.8,color:"rgb(455,455,455)",isClosed:!1}}),this._trackEntity.polyline.altitude=.01;let r=$.createCylinder(1.1,0,2.7,20,1,!0,!1,0,0,0);this._cornerEntity=[new U({geoObject:{scale:1,instanced:!0,tag:"selection",color:"rgb(0,305,0)",object3d:r},properties:{name:"start"}}),new U({geoObject:{scale:1,instanced:!0,tag:"selection",color:"rgb(455,0,0)",object3d:r},properties:{name:"end"}})],this._trackLayer=new ue("track",{entities:[this._trackEntity,this._propsLabel],pickingEnabled:!1,polygonOffsetUnits:-1,relativeToGround:!0,hideInLayerSwitcher:!1}),this._cornersLayer=new ue("corners",{entities:[this._cornerEntity[0],this._cornerEntity[1]],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[1,4e6,.01],pickingScale:2})}set ignoreTerrain(t){this._ignoreTerrain=t}bindPlanet(t){this._planet=t}init(){this._activate()}onremove(){this._deactivate()}_activate(){var t,i,s,r,n;(i=(t=this._propsLabel)==null?void 0:t.label)==null||i.setVisibility(!1),this._onMouseMove_=this._onMouseMove.bind(this),(s=this.renderer)==null||s.events.on("mousemove",this._onMouseMove_,this),this._onMouseLdown_=this._onMouseLdown.bind(this),(r=this.renderer)==null||r.events.on("ldown",this._onMouseLdown_,this),this._onMouseLup_=this._onMouseLup.bind(this),(n=this.renderer)==null||n.events.on("lup",this._onMouseLup_,this),this._planet.addLayer(this._trackLayer),this._planet.addLayer(this._cornersLayer)}_deactivate(){var t,i,s;this._startLonLat=null,this._trackLayer.remove(),this._cornersLayer.remove(),(t=this.renderer)==null||t.events.off("mousemove",this._onMouseMove_),(i=this.renderer)==null||i.events.off("ldown",this._onMouseLdown_),(s=this.renderer)==null||s.events.off("lup",this._onMouseLup_),this.clear(),this._onMouseMove_=null,this._onMouseLdown_=null,this._onMouseLup_=null}_onMouseLdown(t){var i,s,r,n,a,o;if(t.renderer.handler.canvas.classList.remove("ogGrabbingPoiner"),t.renderer.handler.canvas.style.cursor="pointer",!this._startLonLat){(i=this._propsLabel.label)==null||i.setVisibility(!1),(s=this._trackEntity.polyline)==null||s.setPath3v([]),(r=this._cornerEntity[0].geoObject)==null||r.setVisibility(!0),(n=this._cornerEntity[1].geoObject)==null||n.setVisibility(!0),(o=(a=this.renderer)==null?void 0:a.controls.navigation)==null||o.deactivate(),this._startLonLat=this._planet.getLonLatFromPixelTerrain(t);let h=this._planet.ellipsoid.lonLatToCartesian(this._startLonLat);this._cornerEntity[0].setCartesian3v(h),this._cornerEntity[1].setCartesian3v(h)}}_onMouseLup(t){var i,s,r;if(this._startLonLat){if(this._pickedCorner=null,this._anchorLonLat=null,(i=this._propsLabel.label)==null||i.setVisibility(!0),this._onSelect&&typeof this._onSelect=="function"){let n=this._cornerEntity[0].getLonLat(),a=this._cornerEntity[1].getLonLat(),o=[Math.min(n.lon,a.lon),Math.min(n.lat,a.lat),Math.max(n.lon,a.lon),Math.max(n.lat,a.lat)];this._onSelect(o)}this._autoSelectionHide&&this.clear(),this._startLonLat=null}t.renderer.handler.canvas.style.cursor="default",(r=(s=this.renderer)==null?void 0:s.controls.navigation)==null||r.activate()}_drawLine(t,i,s){var r;s||(s=this._planet.ellipsoid.lonLatToCartesian(t));let n=this._planet.ellipsoid.lonLatToCartesian(i),a=this._planet.ellipsoid.direct(t,i);this._heading=a.initialAzimuth;let o=[];this._cornerEntity[0].setCartesian3v(s),this._cornerEntity[1].setCartesian3v(n);let h=[s,this._planet.ellipsoid.lonLatToCartesian(new L(i.lon,t.lat,t.height)),n,this._planet.ellipsoid.lonLatToCartesian(new L(t.lon,i.lat,t.height)),s];o.push(s);let c=(d,u)=>{let _=u.sub(d),p=_.length();_.normalize();for(let f=0;f<120;f++){let m=_.scaleTo(f*p/120).addA(d);o.push(m)}};for(let d=0;d<h.length-1;d++)c(h[d],h[d+1]);(r=this._trackEntity.polyline)==null||r.setPath3v([o]),this._ignoreTerrain}_onMouseMove(t){var i;if(this._startLonLat){(i=this._propsLabel.label)==null||i.setVisibility(!0);let s=this._planet.getLonLatFromPixelTerrain(t);if(!s)return;this._drawLine(this._startLonLat,s)}}clear(){var t,i,s;(t=this._trackEntity.polyline)==null||t.clear(),(i=this._cornerEntity[0].geoObject)==null||i.setVisibility(!1),(s=this._cornerEntity[1].geoObject)==null||s.setVisibility(!1)}frame(){var t,i;let s=(t=this._trackEntity.polyline)==null?void 0:t.getPath3v()[0];if(s&&!this._ignoreTerrain){let n=0;for(let a=0,o=s.length-1;a<o;a++)n+=s[a+1].distance(s[a]);this._propsLabel.setCartesian3v(s[Math.floor(s.length/2)]),(i=this._propsLabel.label)==null||i.setText(`${r=n,r>1e3?`${(r/1e3).toFixed(1)} km`:r>9?`${Math.round(r)} m`:`${r.toFixed(1)} m`}, ${Math.round(this._heading)} deg`)}var r}get ellipsoid(){return this._planet?this._planet.ellipsoid:null}}const nh=["add","remove","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];function Xe(l,t){return new Date(+l+1e3*t)}function ah(l,t=!0,i=!1){let s=lh[l.getMonth()],r=l.getUTCDate(),n=l.getUTCFullYear();if(t){let a=l.getUTCHours().toString().padStart(2,"0"),o=l.getUTCMinutes().toString().padStart(2,"0"),h=l.getUTCSeconds().toString().padStart(2,"0");return i?`${s} ${r} ${n} ${a}:${o}:${h}.${l.getUTCMilliseconds().toString().padStart(3,"0")}`:`${s} ${r} ${n} ${a}:${o}:${h}`}return`${s} ${r} ${n}`}function Gr(l,t=0,i=10,s=2,r="white"){l.lineWidth=s,l.strokeStyle=r,l.beginPath(),l.moveTo(t,0),l.lineTo(t,i),l.stroke()}function oh(l,t,i,s,r="12px Arial",n="black",a="left",o="bottom",h=0){l.save(),l.translate(i,s),l.rotate(h*G),l.fillStyle=n,l.textBaseline=o,l.font=r,l.textAlign=a,l.fillText(t,0,0),l.restore()}const ds=[[.001,10],[.002,10],[.005,10],[.01,10],[.02,10],[.05,10],[.1,10],[.25,10],[.5,5],[1,10],[2,10],[5,5],[10,10],[15,15],[30,6],[60,12],[120,12],[300,5],[600,10],[900,15],[1800,6],[3600,12],[7200,10],[14400,4],[21600,6],[43200,12],[86400,24],[172800,2],[345600,4],[604800,7],[1296e3,15],[2592e3,5],[5184e3,6],[7776e3,9],[15552e3,18],[31536e3,12],[63072e3,2],[126144e3,4],[15768e4,5],[31536e4,10],[63072e4,2],[126144e4,4],[15768e5,5],[31536e5,10],[63072e5,2],[126144e5,4],[15768e6,5],[31536e6,10]],lh=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],hh=["change","current"];class ch{constructor(t={}){this.events=le(hh),this._current=t.current||new Date,this._rangeStart=t.rangeStart||new Date,this._rangeEnd=t.rangeEnd||Xe(this._rangeStart,3600),this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this._minDate=t.minDate||null,this._maxDate=t.maxDate||null,this.multiplier=t.multiplier!=null?t.multiplier:1,this._requestAnimationFrameId=0,this._prevNow=0,this.dt=0}play(){this._requestAnimationFrameId||(this._prevNow=window.performance.now(),this._animationFrameCallback())}stop(){this._requestAnimationFrameId&&(window.cancelAnimationFrame(this._requestAnimationFrameId),this._requestAnimationFrameId=0)}stopped(){return this._requestAnimationFrameId==0}_animationFrameCallback(){this._requestAnimationFrameId=window.requestAnimationFrame((()=>{this._frame(),this._animationFrameCallback()}))}_frame(){let t=window.performance.now();this.dt=t-this._prevNow,this._prevNow=t,this.current=new Date(this.currentTime+this.dt*this.multiplier)}get range(){return this._range}set(t,i){t===this._rangeStart&&i===this._rangeEnd||(this._rangeStart=t,this._rangeEnd=i,this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this.events.dispatch(this.events.change,t,i))}get current(){return this._current}get rangeStart(){return this._rangeStart}get rangeEnd(){return this._rangeEnd}get rangeStartTime(){return this._rangeStart.getTime()}get rangeEndTime(){return this._rangeEnd.getTime()}get currentTime(){return this._current.getTime()}set current(t){t!==this._current&&(this._maxDate&&t>this._maxDate?this._current=this._maxDate:this._minDate&&t<this._minDate?this._current=this._minDate:this._current=t,this.events.dispatch(this.events.current,this._current))}set rangeStart(t){t!==this._rangeStart&&(this._rangeStart=t,this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this.events.dispatch(this.events.change,t))}set rangeEnd(t){t!==this._rangeEnd&&(this._rangeEnd=t,this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this.events.dispatch(this.events.change,t))}}const Mt=.001,dh=["startdrag","stopdrag","startdragcurrent","stopdragcurrent","setcurrent","reset","play","playback","pause","visibility"],jr="#bfbfbf";class uh extends xe{constructor(t={}){super({template:`<div class="og-timeline">

  <div class="og-timeline-top">
  </div>

  <div class="og-timeline-frame">
    <div class="og-timeline-current">
      <div class="og-timeline-current-spin">
        <div class="og-timeline-current-arrow"></div>
      </div>
    </div>
    <div class="og-timeline-scale"></div>
  </div>

  <div class="og-timeline-bottom">
    <div class="og-timeline-controls">
    </div>
  </div>

</div>`,model:new ch({rangeStart:t.rangeStart,rangeEnd:t.rangeEnd,current:t.currentDate,minDate:t.minDate,maxDate:t.maxDate})}),this._onMouseWheel=i=>{if(this._isMouseOver){let s=this._canvasEl.getBoundingClientRect(),r=i.clientX-s.left,n=-(r-.5*this.clientWidth),a=this.model.rangeStartTime+this._millisecondsInPixel*r;this._zoom(a,n,Math.sign(i.wheelDelta))}else if(this._isCurrentMouseOver){let s=-((this.model.currentTime-this.model.rangeStartTime)/this._millisecondsInPixel-.5*this.clientWidth);this._zoom(this.model.currentTime,s,Math.sign(i.wheelDelta))}},this._onMouseWheelFF=i=>{this._onMouseWheel(i)},this._onMouseDown=i=>{this._isMouseOver?(this._isDragging=!0,document.body.classList.add("og-timeline-unselectable"),this._clickPosX=i.clientX,this._clickTime=Date.now(),this._clickRangeStart=this.model.rangeStart,this._clickRangeEnd=this.model.rangeEnd,this.events.dispatch(this.events.startdrag,i)):this._isCurrentMouseOver&&(this._isCurrentDragging=!0,document.body.classList.add("og-timeline-unselectable"),this._clickPosX=i.clientX,this._clickCurrentDate=this.model.current,this.events.dispatch(this.events.startdragcurrent,i))},this._onMouseUp=i=>{if(this._isDragging)if(this._isDragging=!1,document.body.classList.remove("og-timeline-unselectable"),this._clickPosX===i.clientX&&Date.now()-this._clickTime<this._clickDelay){let s=this._canvasEl.getBoundingClientRect(),r=new Date(this.model.rangeStartTime+(i.clientX-s.left)*this._millisecondsInPixel);this.model.current=r,this.events.dispatch(this.events.stopdrag,r),this.events.dispatch(this.events.setcurrent,r)}else this.events.dispatch(this.events.stopdrag,this.model.current);else this._isCurrentDragging&&(this._isCurrentDragging=!1,document.body.classList.remove("og-timeline-unselectable"),this.events.dispatch(this.events.stopdragcurrent,this.model.current))},this._onMouseEnter=()=>{this._isMouseOver=!0},this._onMouseOut=()=>{this._isMouseOver=!1},this._onCurrentMouseEnter=()=>{this._isCurrentMouseOver=!0},this._onCurrentMouseOut=()=>{this._isCurrentMouseOver=!1},this._onMouseMove=i=>{if(this._isDragging){let s=(this._clickPosX-i.clientX)*this._millisecondsInPixel*Mt;this.model.set(Xe(this._clickRangeStart,s),Xe(this._clickRangeEnd,s))}else if(this._isCurrentDragging){let s=(this._clickPosX-i.clientX)*this._millisecondsInPixel*Mt,r=Xe(this._clickCurrentDate,-s);r>=this.model.rangeStart&&r<=this.model.rangeEnd&&(this.model.current=Xe(this._clickCurrentDate,-s))}},this.events=this.events.registerNames(dh),this.fillStyle=t.fillStyle||"rgba(64, 59, 59, 1.0)",this.$controls=null,this._frameEl=null,this._currentEl=null,this._canvasEl=document.createElement("canvas"),this._ctx=this._canvasEl.getContext("2d"),this._isMouseOver=!1,this._isDragging=!1,this._isCurrentDragging=!1,this._isCurrentMouseOver=!1,this._minWidth=330,this._canvasScale=2,this._millisecondsInPixel=0,this._clickPosX=0,this._clickRangeStart=new Date,this._clickRangeEnd=new Date,this._clickCurrentDate=new Date,this._clickTime=0,this._clickDelay=450,this._onResizeObserver_=this._onResizeObserver.bind(this),this._resizeObserver=new ResizeObserver(this._onResizeObserver_),this._pauseBtn=new de({classList:["og-timeline-control_button"],icon:`<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC '-//W3C//DTD SVG 1.1//EN'  'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'><svg enable-background="new 0 0 512 512" height="512px" version="1.1" viewBox="0 0 512 512" width="512px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Layer_6"><rect fill="#252525" height="320" width="60" x="153" y="96"/><rect fill="#252525" height="320" width="60" x="299" y="96"/></g></svg>`,name:"pause"}),this._playBtn=new de({classList:["og-timeline-control_button"],icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" style="fill: black;"/></svg>',name:"play"}),this._buttons=new Jn({buttons:[this._pauseBtn,this._playBtn]}),this._visibility=!1}_onResizeObserver(){this.resize()}get canvasScale(){return this._canvasScale}set canvasScale(t){t!==this._canvasScale&&(this._canvasScale=t,this.resize())}resize(){this._resize(),this.draw()}afterRender(t){this.resize()}render(){return super.render(),this.$controls=this.select(".og-timeline-controls"),this._frameEl=this.select(".og-timeline-frame"),this._currentEl=this.select(".og-timeline-current"),this.select(".og-timeline-frame .og-timeline-scale").appendChild(this._canvasEl),this._resizeObserver.observe(this.el),this.model.events.on("change",(()=>{this.draw()})),this.model.events.on("current",(t=>{this._drawCurrent(),this.events.dispatch(this.events.setcurrent,t)})),this._canvasEl.addEventListener("mouseenter",this._onMouseEnter),this._canvasEl.addEventListener("mouseout",this._onMouseOut),this._currentEl.addEventListener("mouseenter",this._onCurrentMouseEnter),this._currentEl.addEventListener("mouseout",this._onCurrentMouseOut),document.body.addEventListener("mousemove",this._onMouseMove),document.body.addEventListener("mousedown",this._onMouseDown),document.body.addEventListener("mouseup",this._onMouseUp),document.body.addEventListener("wheel",this._onMouseWheelFF),this._playBtn.appendTo(this.$controls),this._pauseBtn.appendTo(this.$controls),this.model.stopped()?(this._pauseBtn.setActive(!0,!0),this._pauseBtn.preventClick=!0):(this._playBtn.setActive(!0,!0),this._playBtn.preventClick=!0),this._buttons.events.on("change",(t=>{switch(t.name){case"play":this.play();break;case"pause":this.pause()}})),this.setVisibility(!0),this}setVisibility(t){t!==this._visibility&&(this._visibility=t,this.el&&(this.el.style.display=t?"block":"none"),this.events.dispatch(this.events.visibility,t))}reset(){this.model.stop(),this.events.dispatch(this.events.reset,this.model)}play(){this.model.multiplier=Math.abs(this.model.multiplier),this.model.play(),this.events.dispatch(this.events.play,this.model)}pause(){this.model.stop(),this.events.dispatch(this.events.pause,this.model)}playBack(){this.model.multiplier=-1*Math.abs(this.model.multiplier),this.model.play(),this.events.dispatch(this.events.playback,this.model)}_zoom(t,i,s){let r=(t-(this.model.rangeStartTime+.5*this.model.range))*Mt,n=Xe(this.model.rangeStart,r),a=Xe(this.model.rangeEnd,r),o=(a.getTime()-n.getTime())/20*Mt,h=Xe(n,o*s),c=Xe(a,-o*s),d=(c.getTime()-h.getTime())/this.clientWidth;if(d<31536e6&&d>.1){let u=d*i*Mt;this.model.set(Xe(h,u),Xe(c,u))}}get clientWidth(){return this._canvasEl?this._canvasEl.width/this._canvasScale:0}get clientHeight(){return this._canvasEl?this._canvasEl.height/this._canvasScale:0}_resize(){this._frameEl&&(this._canvasEl.width=this._frameEl.clientWidth*this._canvasScale,this._canvasEl.height=this._frameEl.clientHeight*this._canvasScale,this._canvasEl.style.width=`${this._frameEl.clientWidth}px`,this._canvasEl.style.height=`${this._frameEl.clientHeight}px`)}getOffsetByTime(t){return(t-this.model.rangeStartTime)/this._millisecondsInPixel}remove(){super.remove(),this.model.stop()}_clearCanvas(){this._ctx.fillStyle=this.fillStyle,this._ctx.fillRect(0,0,this.clientWidth*this._canvasScale,this.clientHeight*this._canvasScale)}_drawCurrent(){let t=(this.model.currentTime-this.model.rangeStartTime)/this._millisecondsInPixel;this.model.current<this.model.rangeStart||this.model.current>this.model.rangeEnd?this._currentEl.style.display="none":(this._currentEl.style.display="block",this._currentEl.style.transform=`translateX(${t}px)`)}draw(){this._millisecondsInPixel=this.model.range/this.clientWidth;let t=(function(s){for(let r=0,n=ds.length;r<n;r++)if(ds[r][0]>s)return ds[r-1]})(this._minWidth*this._millisecondsInPixel*Mt);if(t){this._clearCanvas();let s=1e3*t[0],r=s/this._millisecondsInPixel,n=t[1],a=(i=this.model.rangeStartTime)-i%s,o=t[0]<1,h=t[0]<86400;for(let c=a,d=this.model.rangeEndTime+s;c<d;c+=s){let u=this.getOffsetByTime(c);u>=0&&u<=this.clientWidth*this._canvasScale&&Gr(this._ctx,u*this._canvasScale,10*this._canvasScale,2*this._canvasScale,jr);for(let _=1;_<n;_++){let p=u+_*(r/n);p>=0&&p<=this.clientWidth*this._canvasScale&&Gr(this._ctx,p*this._canvasScale,5*this._canvasScale,1*this._canvasScale,jr)}oh(this._ctx,ah(new Date(c),h,o),u*this._canvasScale,26*this._canvasScale,"24px monospace","#bfbfbf","center")}this._drawCurrent()}var i}}function qr(l,t){const i=new Date(l);return i.setHours(i.getHours()+t),i}class hi{constructor(){this.resolve=()=>{},this.reject=()=>{},this.promise=new Promise(((t,i)=>{this.resolve=t,this.reject=i})),Object.freeze(this)}}const _h=["startcollecting","profilecollected","clear"];class fh{constructor(t={}){this.events=le(_h),this.planet=t.planet||null,this._warningHeightLevel=5,this._pointsReady=!1,this._isWarning=!1,this._minX=0,this._planeDistance=this._maxX=1e3,this._minY=0,this._maxY=200,this._drawData=[[],[]],this._promiseArr=[],this._promiseCounter=0,this._pMaxY=0,this._pMinY=0,this._pDist=0,this._pTrackCoords=[],this._pGroundCoords=[],this._pIndex=0}bindPlanet(t){this.planet=t}setWarningHeightLevel(t=0){this._warningHeightLevel=t}setRange(t,i,s,r){this._minX=t,this._maxX=i,s&&(this._minY=s),r&&(this._maxY=r)}_getHeightAsync(t,i,s){let r=new hi;if(this.planet){let n=this.planet.terrain.geoid.getHeightLonLat(t);this.planet.terrain.getHeightAsync(t,(a=>{this.planet&&s===this._promiseCounter?(a+=n,this._pGroundCoords[i][1]=a,this._pGroundCoords[i][2]=0,this._pGroundCoords[i][3]=t.height,a>this._pMaxY&&(this._pMaxY=a),a<this._pMinY&&(this._pMinY=a),this._updatePointType(i),r.resolve(a)):r.reject()}))}else r.reject();return r.promise}_collectCoordsBetweenTwoTrackPoints(t,i,s,r,n,a){if(this.planet)for(let o=1;o<=i;o++){this._pDist+=1,this._pIndex++;let h=o*s,c=r.add(n.scaleTo(h)),d=this.planet.ellipsoid.cartesianToLonLat(c);this._pGroundCoords[this._pIndex]=[this._pDist,0,0,0,t],((u,_)=>{this._promiseArr.push(this._getHeightAsync(u,_,a))})(d,this._pIndex)}}_collectAllPoints(t,i){if(!this.planet||i!==this._promiseCounter)return;let s=new v,r=new v;for(let n=1,a=t.length;n<a;n++){let o=t[n-1],h=t[n];this.planet.ellipsoid.lonLatToCartesianRes(o,s),this.planet.ellipsoid.lonLatToCartesianRes(h,r);let c=r.sub(s),d=c.length(),u=this.planet.ellipsoid.getSurfaceNormal3v(s),_=v.proj_b_to_plane(c,u),p=_.length(),f=Math.floor(p/1),m=1*d/p;this._getGroundElevation(o,n-1,i),_.normalize(),c.normalize(),this._collectCoordsBetweenTwoTrackPoints(n-1,f,m,s,c,i),this._pDist+=p-1*f,this._pIndex++;let g=h.height;g>this._pMaxY&&(this._pMaxY=g),g<this._pMinY&&(this._pMinY=g),this._pTrackCoords[n]=[this._pDist,g,this._pIndex]}}_getGroundElevation(t,i,s){this._pGroundCoords[this._pIndex]=[this._pDist,0,0,0,i],this._promiseArr.push(this._getHeightAsync(t,this._pIndex,s))}_calcPointsAsync(t,i){return new Promise(((s,r)=>{this._pTrackCoords=[[0,t[0].height,0]],this._pMaxY=t[0].height,this._pMinY=this._pMaxY,this._pDist=0,this._pGroundCoords=[],this._pIndex=0,this._promiseArr=[],this._collectAllPoints(t,i),this._getGroundElevation(t[t.length-1],t.length-1,i),Promise.all(this._promiseArr).then((()=>{s({dist:this._pDist,minY:this._pMinY,maxY:this._pMaxY,trackCoords:this._pTrackCoords,groundCoords:this._pGroundCoords})}))}))}get minX(){return this._minX}get planeDistance(){return this._planeDistance}get maxX(){return this._maxX}get minY(){return this._minY}get maxY(){return this._maxY}get pointsReady(){return this._pointsReady}get isWarningOrCollision(){return this._isWarning}get drawData(){return this._drawData}collectProfile(t){let i=new hi;return this.planet||i.reject(),this._pointsReady=!1,this._isWarning=!1,t&&t.length?(this.events.dispatch(this.events.startcollecting,this),this._promiseCounter++,(s=>{this._calcPointsAsync(t,s).then((r=>{s===this._promiseCounter&&(this._planeDistance=r.dist,this.setRange(0,r.dist,r.minY-.1*Math.abs(r.minY),r.maxY+.2*Math.abs(r.maxY)),this._pointsReady=!0,this._drawData=[r.trackCoords,r.groundCoords],this.events.dispatch(this.events.profilecollected,this._drawData,this),i.resolve(this._drawData))}))})(this._promiseCounter),i.promise):(i.reject(),i.promise)}_updatePointType(t){this._pGroundCoords[t][3]>=this._pGroundCoords[t][1]&&this._pGroundCoords[t][3]<this._pGroundCoords[t][1]+this._warningHeightLevel-.1&&(this._pGroundCoords[t][2]=1),this._pGroundCoords[t][3]<=this._pGroundCoords[t][1]+1&&(this._pGroundCoords[t][2]=2),this._pGroundCoords[t][2]!==1&&this._pGroundCoords[t][2]!==2||(this._isWarning=!0)}_setPointsType(){this._isWarning=!1,this._pTrackCoords=this._drawData[0],this._pGroundCoords=this._drawData[1];for(let t=0;t<this._pGroundCoords.length;t++)this._updatePointType(t);this._drawData[1]=this._pGroundCoords,this.events.dispatch(this.events.profilecollected,this._drawData,this)}clear(){this._promiseCounter=0,this._pointsReady=!1,this._isWarning=!1,this._drawData=[[],[]],this._pMaxY=0,this._pMinY=0,this._pDist=0,this._pTrackCoords=[],this._pGroundCoords=[],this._pIndex=0,this.events.dispatch(this.events.clear,this._drawData,this)}}const lo="rgb(198, 198, 198)",Yr=[lo,"rgb(255, 255, 0)","rgb(255, 0, 0)"],gh=["startdrag","stopdrag","pointer","mouseenter","mouseleave","dblclick","tracklength","groundlength","warninglength","collisionlength"];class ph extends xe{constructor(t={}){super({template:`<div class="og-elevationprofile">
      <div class="og-elevationprofile-loading" style="display: none;">
        <div class="loadingio-spinner-bars-r354qqyl5v">
          <div class="ldio-p0v5a1f6oz">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
          </div>
        </div> 
      </div>     
    </div>`,model:new fh}),this._onMouseDblClick=i=>{let s,r=this.$canvas.getBoundingClientRect(),n=i.clientX-r.left,a=this._leftDistance+(this._rightDistance-this._leftDistance)*n/this.clientWidth,o=this.model.drawData[1],h=this.model.drawData[0];a<0?(s=1,a=0,n=(0-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):a>this.model.planeDistance?(s=o.length-1,a=this.model.planeDistance,n=(a-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):s=-1-Et(o,a,((y,x)=>y-x[0]));let c=o[s-1],d=o[s],u=(a-c[0])/(d[0]-c[0]),_=c[1]+u*(d[1]-c[1]),p=c[4],f=h[p],m=h[p+1];u=(a-f[0])/(m[0]-f[0]);let g=f[1]+u*(m[1]-f[1]);this.events.dispatch(this.events.dblclick,a,f,m,c,d,p,s-1,g-_)},this._onMouseEnter=i=>{this._isMouseOver=!0,this.events.dispatch(this.events.mouseenter,i)},this._onMouseOut=i=>{this._isMouseOver=!1,this.events.dispatch(this.events.mouseleave,i)},this._onMouseDown=i=>{this._isMouseOver&&(this._isDragging=!0,document.body.classList.add("og-timeline-unselectable"),this._clickPosX=i.clientX,this._customFrame||(this._leftDistance=this.model.minX,this._rightDistance=this.model.maxX),this._clickLeftDistance=this._leftDistance,this._clickRightDistance=this._rightDistance,this.events.dispatch(this.events.startdrag,i))},this._onMouseUp=i=>{this._isDragging&&(this._isDragging=!1,document.body.classList.remove("og-timeline-unselectable"),this.events.dispatch(this.events.stopdrag,i))},this._onCanvasMouseMove=i=>{if(this.model.pointsReady)if(this._isDragging)this.clearPointerCanvas();else{this._customFrame||(this._leftDistance=this.model.minX,this._rightDistance=this.model.maxX);let s=this.$pointerCanvas.getBoundingClientRect(),r=i.clientX-s.left;this.redrawPointerCanvas(r)}},this._onMouseMove=i=>{if(this._isDragging&&this.model.pointsReady){let s=(this._clickPosX-i.clientX)*this._canvasScale/this._pixelsInMeter_x;this.setFrame(this._clickLeftDistance+s,this._clickRightDistance+s)}},this._onMouseWheelFF=i=>{this._onMouseWheel(i)},this._onMouseWheel=i=>{if(this._isMouseOver&&this.model.pointsReady){this._customFrame||(this._leftDistance=this.model.minX,this._rightDistance=this.model.maxX),this._customFrame=!0;let s=Math.sign(i.wheelDelta)*(this._rightDistance-this._leftDistance)/20,r=this.$canvas.getBoundingClientRect(),n=i.clientX-r.left,a=n-.5*this.$canvas.clientWidth,o=a*this._canvasScale/this._pixelsInMeter_x,h=o+this._leftDistance+s,c=o+this._rightDistance-s;o=-a*(c-h)/this.clientWidth,this.setFrame(h+o,c+o),this.redrawPointerCanvas(n)}},this.events=this.events.registerNames(gh),this.fillStyle=t.fillStyle||"rgb(63, 63, 63)",this._customFrame=!1,this._leftDistance=0,this._rightDistance=0,this._pixelsInMeter_x=0,this._pixelsInMeter_y=0,this._canvasScale=2,this.$canvas=document.createElement("canvas"),this.$canvas.style.position="absolute",this._ctx=this.$canvas.getContext("2d"),this.$pointerCanvas=document.createElement("canvas"),this.$pointerCanvas.style.pointerEvents="none",this.$pointerCanvas.style.position="absolute",this._pointerCtx=this.$pointerCanvas.getContext("2d"),this.$loading=null,this._isMouseOver=!1,this._isDragging=!1,this._clickPosX=0,this._clickLeftDistance=0,this._clickRightDistance=0,this._timeStartHandler=0,this._onResizeObserver_=this._onResizeObserver.bind(this),this._resizeObserver=new ResizeObserver(this._onResizeObserver_)}_onResizeObserver(){this.resize()}get canvasScale(){return this._canvasScale}set canvasScale(t){t!==this._canvasScale&&(this._canvasScale=t,this.resize())}resize(){this._resize(),this.draw()}render(){return super.render(),this._resizeObserver.observe(this.el),this.el.appendChild(this.$canvas),this.el.appendChild(this.$pointerCanvas),this.model.events.on("profilecollected",(t=>{this._hideLoading(),this.clearPointerCanvas(),this.draw()})),this.model.events.on("startcollecting",(()=>{clearTimeout(this._timeStartHandler),this._timeStartHandler=setTimeout((()=>{this._showLoading()}),450)})),this.model.events.on("clear",(()=>{this._customFrame=!1,this._leftDistance=0,this.clearCanvas(),this.clearPointerCanvas()})),this.$loading=this.select(".og-elevationprofile-loading"),this.$canvas.addEventListener("mouseenter",this._onMouseEnter),this.$canvas.addEventListener("mouseout",this._onMouseOut),this.$canvas.addEventListener("dblclick",this._onMouseDblClick),this.$canvas.addEventListener("mousemove",this._onCanvasMouseMove),document.body.addEventListener("mousemove",this._onMouseMove),document.body.addEventListener("mousedown",this._onMouseDown),document.body.addEventListener("mouseup",this._onMouseUp),document.body.addEventListener("wheel",this._onMouseWheelFF),this}_hideLoading(){clearTimeout(this._timeStartHandler),this.$loading.style.display="none"}_showLoading(){this.$loading.style.display="flex"}redrawPointerCanvas(t){this.clearPointerCanvas();let i,s=this._leftDistance+(this._rightDistance-this._leftDistance)*t/this.clientWidth,r=this.model.drawData[1],n=this.model.drawData[0];s<0?(i=1,s=0,t=(0-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):s>this.model.planeDistance?(i=r.length-1,s=this.model.planeDistance,t=(s-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):i=-1-Et(r,s,((x,b)=>x-b[0]));let a=r[i-1],o=r[i],h=(s-a[0])/(o[0]-a[0]),c=a[1]+h*(o[1]-a[1]),d=a[4],u=n[d],_=n[d+1];h=(s-u[0])/(_[0]-u[0]);let p=u[1]+h*(_[1]-u[1]),f=(this.model.maxY-p)*this._pixelsInMeter_y,m=(this.model.maxY-c)*this._pixelsInMeter_y;this.events.dispatch(this.events.pointer,s,u,_,a,o,d,i-1,p-c);let g=this._pointerCtx;g.lineWidth=3,g.strokeStyle="rgba(64,64,64,0.6)",g.beginPath(),g.moveTo(t*this._canvasScale,0),g.lineTo(t*this._canvasScale,this.clientHeight*this._canvasScale),g.stroke(),g.beginPath(),g.arc(t*this._canvasScale,m,4,0,2*Math.PI,!1),g.fillStyle="#FFB277",g.fill(),g.lineWidth=4,g.strokeStyle="#FFB277",g.stroke(),g.beginPath(),g.arc(t*this._canvasScale,f,4,0,2*Math.PI,!1),g.fillStyle="#FFB277",g.fill(),g.lineWidth=4,g.strokeStyle="#FFB277",g.stroke(),g.lineWidth=3,g.strokeStyle="#FFB277",g.beginPath(),g.moveTo(t*this._canvasScale,m),g.lineTo(t*this._canvasScale,f),g.stroke(),g.fillStyle="white",g.font=28/devicePixelRatio+"px Arial",g.textBaseline="middle",g.textAlign="left",g.fillText(`${Math.round(p-c).toString()} m`,(t+5)*this._canvasScale,m+.5*(f-m)),g.fillStyle="white",g.font=28/devicePixelRatio+"px Arial",g.textAlign="right";let y=Ot(s);g.fillText(`${y[0]} ${y[1]}`,(t-5)*this._canvasScale,(this.clientHeight-7)*this._canvasScale)}get clientWidth(){return this.$canvas?this.$canvas.width/this._canvasScale:0}get clientHeight(){return this.$canvas?this.$canvas.height/this._canvasScale:0}_resize(){this.el&&(this.$canvas.width=this.el.clientWidth*this._canvasScale,this.$canvas.height=this.el.clientHeight*this._canvasScale,this.$canvas.style.width=`${this.el.clientWidth}px`,this.$canvas.style.height=`${this.el.clientHeight}px`,this.$pointerCanvas.width=this.el.clientWidth*this._canvasScale,this.$pointerCanvas.height=this.el.clientHeight*this._canvasScale,this.$pointerCanvas.style.width=`${this.el.clientWidth}px`,this.$pointerCanvas.style.height=`${this.el.clientHeight}px`,this._customFrame&&(this._pixelsInMeter_x=this._canvasScale*this.clientWidth/(this._rightDistance-this._leftDistance)))}clearPointerCanvas(){this._pointerCtx.fillStyle="rgba(0,0,0,0)",this._pointerCtx.clearRect(0,0,this.clientWidth*this._canvasScale,this.clientHeight*this._canvasScale)}clearCanvas(){const t=this._ctx.createLinearGradient(0,0,0,this.clientHeight*this._canvasScale);t.addColorStop(0,"black"),t.addColorStop(1,this.fillStyle),this._ctx.fillStyle=t,this._ctx.fillRect(0,0,this.clientWidth*this._canvasScale,this.clientHeight*this._canvasScale)}setFrame(t,i){this._leftDistance=t,this._rightDistance=i,this._customFrame=!0,this._pixelsInMeter_x=this._canvasScale*this.clientWidth/(this._rightDistance-this._leftDistance),this.model.setRange(t,i),this.draw()}_updateUnits(){this._customFrame||(this._pixelsInMeter_x=this._canvasScale*this.clientWidth/(this.model.maxX-this.model.minX)),this._pixelsInMeter_y=this._canvasScale*this.clientHeight/(this.model.maxY-this.model.minY)}clear(){this.model.clear(),this.clearCanvas()}draw(){let t=this.model.drawData[0];if(t.length>1){this._updateUnits(),this.clearCanvas();let i=this.model.drawData[1];this._drawTrack(t,i),this._drawTerrain(i),this._drawWarningAndCollision(i),this._drawLabels(t,i)}else this.clearCanvas()}_drawLabels(t,i){let s=this._ctx;if(s){let r=t[0];const n=this.model.maxY;let a=(-this._leftDistance+r[0])*this._pixelsInMeter_x,o=(n-r[1])*this._pixelsInMeter_y;i[r[2]][1],this._pixelsInMeter_y,s.beginPath(),s.fillStyle="#F7F718",s.fillRect(a-4,o-4,8,8),s.stroke(),s.fillStyle="white",s.font=26/devicePixelRatio+"px Arial",s.textBaseline="bottom",s.textAlign="left",s.fillText(`${Math.round(r[1]-i[r[2]][1]).toString()} m`,a+1,o-10),s.stroke();for(let h=1,c=t.length;h<c;h++){let d=t[h];a=(-this._leftDistance+d[0])*this._pixelsInMeter_x,o=(n-d[1])*this._pixelsInMeter_y,i[d[2]][1],this._pixelsInMeter_y,s.beginPath(),s.fillStyle="#F7F718",s.fillRect(a-4,o-4,8,8),s.stroke(),s.fillStyle="white",s.fillText(`${Math.round(d[1]-i[d[2]][1]).toString()} m`,a+1,o-10),s.stroke()}}}_drawTrack(t,i){let s=t[0],r=this._ctx;if(r){const n=this.model.maxY;r.lineWidth=5,r.strokeStyle="rgb(0, 255, 50)",r.beginPath(),r.moveTo((-this._leftDistance+s[0])*this._pixelsInMeter_x,(n-s[1])*this._pixelsInMeter_y);let a=0;for(let d=1,u=t.length;d<u;d++){let _=t[d];r.lineTo((-this._leftDistance+_[0])*this._pixelsInMeter_x,(n-_[1])*this._pixelsInMeter_y);let p=t[d-1],f=_[0]-p[0],m=_[1]-p[1],g=f*f,y=m*m;a+=Math.sqrt(g+y)}r.stroke(),r.lineWidth=2,r.strokeStyle="rgba(255,255,255,0.7)",r.beginPath();let o=(-this._leftDistance+s[0])*this._pixelsInMeter_x,h=(n-s[1])*this._pixelsInMeter_y,c=(n-i[s[2]][1])*this._pixelsInMeter_y;r.moveTo(o,h),r.lineTo(o,c);for(let d=1,u=t.length;d<u;d++){let _=t[d];o=(-this._leftDistance+_[0])*this._pixelsInMeter_x,h=(n-_[1])*this._pixelsInMeter_y,c=(n-i[_[2]][1])*this._pixelsInMeter_y,r.strokeStyle="rgba(255,255,255,0.7)",r.moveTo(o,h),r.lineTo(o,c)}r.stroke(),this.events.dispatch(this.events.tracklength,a)}}_drawTerrain(t){let i=t[0],s=this._ctx;if(s){const r=this.model.maxY;s.lineWidth=5,s.strokeStyle=lo,s.beginPath(),s.moveTo((-this._leftDistance+i[0])*this._pixelsInMeter_x,this.$canvas.height),s.lineTo((-this._leftDistance+i[0])*this._pixelsInMeter_x,(r-i[1])*this._pixelsInMeter_y);let n=0;for(let a=1,o=t.length;a<o;a++){let h=t[a];s.lineTo((-this._leftDistance+h[0])*this._pixelsInMeter_x,(r-h[1])*this._pixelsInMeter_y);let c=t[a-1],d=h[0]-c[0],u=h[1]-c[1],_=d*d,p=u*u;n+=Math.sqrt(_+p)}s.lineTo((-this._leftDistance+t[t.length-1][0])*this._pixelsInMeter_x,this.$canvas.height),s.closePath(),s.stroke(),s.save(),s.fillStyle="rgb(64, 68, 82)",s.globalAlpha=.5,s.fill(),s.restore(),s.globalAlpha=1,this.events.dispatch(this.events.groundlength,n)}}_drawWarningAndCollision(t){let i=this._ctx;if(i&&t.length>1){let s=this.model.maxY;i.lineWidth=5,i.beginPath();let r=0,n=0;for(let a=0,o=t.length-1;a<o;a++){let h=t[a],c=t[a+1];if(h[2]!==0&&c[2]!==0){let d=c[0]-h[0],u=c[1]-h[1],_=d*d,p=u*u;h[2]===2?(i.stroke(),i.beginPath(),i.strokeStyle=Yr[2],n+=Math.sqrt(_+p)):h[2]===1&&(i.stroke(),i.beginPath(),i.strokeStyle=Yr[1],r+=Math.sqrt(_+p)),i.moveTo((-this._leftDistance+h[0])*this._pixelsInMeter_x,(s-h[1])*this._pixelsInMeter_y),i.lineTo((-this._leftDistance+c[0])*this._pixelsInMeter_x,(s-c[1])*this._pixelsInMeter_y)}}i.stroke(),this.events.dispatch(this.events.warninglength,r),this.events.dispatch(this.events.collisionlength,n)}}}let mh=$.createCylinder(.33,0,1,20,1,!0,!1,0,0,0),vh=$.createCylinder(.33,.33,1.1,20,1,!0,!0,0,-.55,0);const yh={startPosition:new v,endPosition:new v,startColor:"rgba(255,131,0,0.2)",endColor:"rgba(255,131,0,1.0)",thickness:2.7},xh={src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjEuNBNAaMQAAAiLSURBVHhe7Z0r0BxFEMcjIhAIRERERAQCgUAgEBEIBAIRiUAgIiIQiAgEIlUREQgEIgIREYFAIBCIiAgEIiIiAoGIoHimqPAKz5CP/t23/8vcbe89d/dmZ/pf9avLdZK72e6+ee3M7Imjo6Opc8o4b7xn3DIeGEOJz+Y7+C6+k+/2yjQZXOMEOGdcNe4anv4wvjV+m73bT3wGn8VneqIMlIUyeWXNGteYKTj4feNrI9W/xi/HfxxVfCffnYqyUcbJJINrzIjTxjvGV0aqn43fj/+YhSgLZUpFmd81uAbv2rLANWbAC8ZHxp+GxC8ufZ+rKGNaI1FLcC1ck3etB8U1HhCqzk8N6T/jENV7X6LsXIN008iqeXCNB+B54zND+tt4ePzHIsS1cE0SicA1e74YFdc4IgyjrhvqTP3TvJas9Bq59oP2EVzjCJw03jI0TCMBcurUDS1qBCU9PnjbwCeerwbFNQ4MVd9tQ5pyG7+v0mvHJ6N3FF3jgFwy1JPvmlipUfIFvmHY6/luEFzjANDO0fGRfm1eQ0+UzlriqzOG58tecY0985LxnYH+al5D3ZKP8Bm+83zaG66xRy4a6uzU3NZvK/nqkUEH0fNtL7jGHqBH+4EhTWEGL2ddMwYZJbjGPaGgHxuIDA7tJ/mQGdLek8A17sHTxucGiva+P6kGxbf42PP9TrjGHUmDH1V+/xokCVzjDkTwx1HvSeAat4R2SWP8CP7wko9ZmrZ3n8A1bok6fBH88SRf4/u9ksA1bgFr4ZDG+qHxpLuKLFD1YrMRrnFDLhjocfMaGl8aIjLh5sVoLa5xA140+lhxG+pHNAk7TRu7xjXQ+9TK3Jru4ecqxYB7B88YXsw6cY1rUKcv7ujlI907YLbQi1knrnEFavej05ef1ClkpZUXOxfX2AH3p6Pdz1/E6FnDi2EL19iBVu3Gbd18pdgwU+jFsIVrdHjDQHGDJ39pkojm2ovlAq5xCXqWWtETmo7uG2t3L7vGJTTbF73+6UhNARtVvZjOcY0JZ42Y45+uGK2t7BC6xoQbBoqO3/SkGpt5Gy+2M1xjw3MGGZRubgxNS5qv6dxw4hob9OuPsf90pWnizlrANRpM+sSvvwypFqBGb8W6ZWjgHjOKtn/6Ug3OMv1WrFsG4ykjqv3yxGiudbdw4U2DbvjEuL8cqSZv7TJaeNOg1b2h8nTHWIj3whuDSQOUHmcSKkPagr5wNE0afLhioOj8lSc16QvTw2nwYfk8vlB5YjnfPOZp8FX9x8kd5Uqju3kzkCYAPUQU1X+5UjPACaatBEiPcAmVrfmKIQU/Jn/qEpNCs82lSgCOL0U/Na+hcvVD8/qKMU8AjiZDsdGjfCnGl415AnyCJVSVZptIlAD3sISqEgt9ZwnAHSIU07/1SMv7T5EA7CpFPzavofKljuA5EkCbPmICqB4p1m+SAPQGQ3XqMgnAQwtCdeo6CRBTwPXqJgnAKpFQnbpDAsQcQL26RwLEzt96dZ8ECFWsSIDKFQlQuSIBKlckQOUiAThLJlSnZqOAmAeoV7N5gJgJrFd3SQCePBGqU7dIgLgbWK9mdwO1ITRUn66QADoQIlYE1SPF+gIJEGsC69PCmkDOk0WxKrgeaQf4aRIA9AiYUD2a7wuA2BlUn1gKOE8A9ouj2BtYvh42r4z+5gnATlEUHcHy9X3z+poxT4A4H6Aecfxv63wAiOXh9ah1QgioHxAnhJYr1fKz9h/SBOA0aRSnhJUrJQCP/m0lAMQ5geWr85xA0I2haAbKk4b4K08KVTMQ08LlSU37vPqHNPgiVgiVK5r4hXgvvGm4aKC4PVyOFMuNnhfABEFMCpWnjZ8YAjxfBkUiTF/q/LH0rxXrlqFBJ4friVOh6Uod+oUHRYiWIYFnzaG4QzhdqefPo/+9GK9MAJ42SQ0QtcB0pV//wtAvxTUmqBaIiaHpSff9Z0fCduEaE+gLxBNEpyliRuzctl+4xiU0Ioh5gelIsfrQ8GI6xzUuwdjxgRGalojZacOL6RzX6KDNI0wmhPKWev6tWT8P19jBFwaKDmG+0pD9tnHS8OK4gGvsgDuFUQPkr7UdvxTXuAI9Wk7nzYfykX6clwwvdi6ucQ3MKqEYFeQjxYKFvRtV/cI1roG9hDpdNNYPHl6KAWc9re31L+MaN4DHzMUUcT4iFi8bXqxW4ho3RP2Bx81raHw9al557J8Xo7W4xi24ZqAYHYwv+XztbN8qXOMW0OFQpzBuG48n+XrrTt8yrnFLWELGViMUSTC85GN8Ptvftw+ucQcYGTD7hCIJhpN8y8rtrXv8Hq5xR7hpdNdAkQT9Sz7Fx70EH1zjHlAl6Z5BdAz7k3xJLdta2bsPrnFP0j5BzBXsL/mwlzZ/GdfYA/RMbxgo5gl2l3yHL/fq7XfhGnskfSpp3DvYXKmvZs/5HwrX2DOcP6QVRVqoGOqWfMSmnFcNz6e94RoH4IyhziGLFeMmUlv4RItv8RU+83zZK65xIGjDOH9AnZoYKj6RfIFvrhqDtPcernFg2KTwpSHVvMQsvXa2bnNus+ezwXCNI6DaQOPbGoeLumZ8gC9G+9WnuMYRYeOJdh+hGiaP0mvkiF584PlmFFzjAWAxgzqJqMRESK+Ja91pAUffuMYDwvGlaSJQTU65j0DZ0+aNaztveNd+EFxjBjB3QPWYOm9Kh1WkZeUa2KDJNXnXelBcY0bQPnKs2fIj7nOsFZbLRJkp+0Hb+HW4xgzhMGuqTubEl2sC9igcYpqZ71zeH0HZKCNlpczetWSFa8wcJQO7lrtONiUQ3xh9TDbxGXxWVxNEGSjLZIKe4honxlnjdYMFqnSyhhxB8Nl8B9/Fd/LdXpkmg2ssANpdfpEsXacdZq6BJ6Tya+VZyWnnUsLG3/Fv+Lf8H/4vn8FnZd2W78bRif8BxMOwtJg5Ph4AAAAASUVORK5CYII=",color:"rgb(255,131,0)",size:[8,8]},bh={text:"",face:"arial",size:10.5,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"left",offset:[5,15,-5]},Wr={face:"arial",text:"",size:10.5,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"right",offset:[-47,25,0]},wh={instanced:!0,tag:"ground-pointer",color:"rgb(0,305,0)",object3d:mh},Th={instanced:!0,tag:"head-pointer",color:"rgb(305,305,0)",object3d:vh};class Ch extends lt{constructor(t={}){super("ElevationProfileScene"),this._onLClick=i=>{let s=this._planet.getCartesianFromPixelTerrain(i.pos);s&&this.addGroundPoint3vAsync(s)},this._onMouseMove=i=>{if(this._planet.getCartesianFromMouseTerrain(),this._pickedGroundEntity){let s=new H(i.x,i.y).sub(this._startClickPos),r=this._startEntityPos.add(s),n=this._planet.getCartesianFromPixelTerrain(r);n&&this.setGroundPointCartesian3v(this._pickedGroundEntity.properties.index,n)}else if(this._pickedHeadEntity){let s=this._planet.camera,r=this._pickedHeadEntity.properties.groundEntity.getCartesian(),n=this._planet.ellipsoid.getSurfaceNormal3v(r),a=r.add(n),o=r.add(s.getRight()),h=new v;if(new V(s.eye,i.direction).hitPlaneRes(pe.fromPoints(r,a,o),h)===V.INSIDE){let c=v.proj_b_to_a(h,r),d=c.sub(r).dot(r),u=r.add(n.scale(Math.sign(d)*c.distance(r)));this.setHeadPointCartesian3v(this._pickedHeadEntity.properties.index,u)}}},this._onLUp=i=>{},this._onGroundPointerEnter=i=>{i.renderer.handler.canvas.style.cursor="pointer"},this._onGroundPointerLeave=i=>{i.renderer.handler.canvas.style.cursor="default"},this._onGroundPointerLDown=i=>{this._clampToGround=!1,this.renderer.controls.navigation.deactivate(),this._pickedGroundEntity=i.pickingObject;const s=this._pickedGroundEntity.getCartesian();this._startClickPos.set(i.x,i.y),this._startEntityPos=this._planet.getPixelFromCartesian(s)},this._onGroundPointerLUp=i=>{this._clampToGround=!0,this.renderer.controls.navigation.activate(),this._pickedGroundEntity=null},this._onHeadPointerEnter=i=>{i.renderer.handler.canvas.style.cursor="pointer"},this._onHeadPointerLeave=i=>{i.renderer.handler.canvas.style.cursor="default"},this._onHeadPointerLDown=i=>{this.renderer.controls.navigation.deactivate(),this._pickedHeadEntity=i.pickingObject},this._onHeadPointerLUp=i=>{this.renderer.controls.navigation.activate(),this._pickedHeadEntity=null},this.events=le(Ah),this._planet=t.planet||null,this._pickedGroundEntity=null,this._pickedHeadEntity=null,this._startClickPos=new H,this._startEntityPos=new H,this._clampToGround=!0,this._trackLayer=new ue("track",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-1,relativeToGround:!0,hideInLayerSwitcher:!0}),this._groundPointersLayer=new ue("ground-pointers",{entities:[],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[1,5e3,.02],pickingScale:1.5}),this._headPointersLayer=new ue("head-pointers",{entities:[],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[1,1e4,.02],pickingScale:1}),this._columnPointersLayer=new ue("column-pointers",{entities:[],pickingEnabled:!1,hideInLayerSwitcher:!0}),this._trackEntity=new U({polyline:{path3v:[],thickness:3.8,color:"rgba(0,305,0,0.8)",isClosed:!1}}),this._trackLayer=new ue("column-pointers",{entities:[this._trackEntity],pickingEnabled:!1,hideInLayerSwitcher:!0}),this._heightsLayer=new ue("heights-labels",{entities:[],pickingEnabled:!1,hideInLayerSwitcher:!0}),this._pointerHeadEntity=new U({cartesian:new v,billboard:xh}),this._pointerLabelEntity=new U({cartesian:new v,label:bh}),this._pointerRayEntity=new U({cartesian:new v,ray:yh}),this._pointerLayer=new ue("pointer",{entities:[this._pointerHeadEntity,this._pointerLabelEntity,this._pointerRayEntity],pickingEnabled:!1,hideInLayerSwitcher:!0})}flyExtent(){let t=this._headPointersLayer.getEntities(),i=180,s=180,r=-180,n=-180,a=-1e6;if(t.length>1){for(let o=0;o<t.length;o++){let h=t[o].getLonLat();h.lon<i&&(i=h.lon),h.lat<s&&(s=h.lat),h.lon>r&&(r=h.lon),h.lat>n&&(n=h.lat),h.height>a&&(a=h.height)}this._planet.camera.flyExtent(new j(new L(i,s),new L(r,n)),a,{amplitude:0})}}get planet(){return this._planet}_createGroundPointer(t,i=10){let s=this.ellipsoid.getSurfaceNormal3v(t),r=t.add(s.scale(i)),n=new U({ray:{startPosition:t,endPosition:r,startColor:"rgba(255,255,255,0.2)",endColor:"rgba(355,355,355,1.0)",thickness:3.2}}),a=new U({cartesian:t,geoObject:wh}),o=new U({cartesian:r,geoObject:Th,properties:{}}),h=new U({cartesian:r,label:Wr});h.appendChild(new U({cartesian:r,label:{...Wr,offset:[-47,45,0]}}));const c=this._groundPointersLayer.getEntities().length;return n.properties=a.properties=o.properties={index:c,altitude:i,lonLatEll:new L,headEntity:o,groundEntity:a,columnEntity:n,heightLabelEntity:h},{headEntity:o,groundEntity:a,columnEntity:n,heightLabelEntity:h}}setPointerCartesian3v(t,i){this._pointerLabelEntity.setCartesian3v(t),this._pointerLabelEntity.label.setText(`${Math.round(i).toString()} m`),this._pointerRayEntity.ray.setEndPosition3v(t);let s=this._planet.ellipsoid.getSurfaceNormal3v(t);this._pointerRayEntity.ray.setStartPosition3v(t.add(s.scale(-i))),this._pointerHeadEntity.setCartesian3v(t)}bindPlanet(t){this._planet=t}init(){this._activate()}onremove(){this._deactivate()}_activate(){this._planet.addLayer(this._trackLayer),this._planet.addLayer(this._groundPointersLayer),this._planet.addLayer(this._columnPointersLayer),this._planet.addLayer(this._headPointersLayer),this._planet.addLayer(this._heightsLayer),this._planet.addLayer(this._pointerLayer),this.renderer.events.on("ldblclick",this._onLClick),this.renderer.events.on("mousemove",this._onMouseMove),this.renderer.events.on("lup",this._onLUp),this._groundPointersLayer.events.on("mouseenter",this._onGroundPointerEnter),this._groundPointersLayer.events.on("mouseleave",this._onGroundPointerLeave),this._groundPointersLayer.events.on("ldown",this._onGroundPointerLDown),this._groundPointersLayer.events.on("lup",this._onGroundPointerLUp),this._headPointersLayer.events.on("mouseenter",this._onHeadPointerEnter),this._headPointersLayer.events.on("mouseleave",this._onHeadPointerLeave),this._headPointersLayer.events.on("ldown",this._onHeadPointerLDown),this._headPointersLayer.events.on("lup",this._onHeadPointerLUp),this.setPointerVisibility(!1)}getPointLonLat(t){let i=this._headPointersLayer.getEntities()[t];if(i)return i.getLonLat()}getPointsLonLat(){let t=this._headPointersLayer.getEntities(),i=new Array(t.length);for(let s=0,r=i.length;s<r;s++){let n=t[s];i[s]=n.getLonLat()}return i}getHeightMSL(t){return this._planet&&this._planet.terrain.geoid?this._planet.terrain.geoid.getHeightLonLat(t):0}getHeightELLAsync(t){return new Promise(((i,s)=>{this._planet.terrain.getHeightAsync(t,(r=>{if(this._planet){let n=this.getHeightMSL(t);i(r+n)}else s()}))}))}addPointLonLatArrayAsync(t,i=!1){if(!this._planet)throw new Error("Planet is not defined");let s=this._planet.ellipsoid;for(let n=0,a=t.length-1;n<a;n++){let o=s.lonLatToCartesian(t[n]),h=s.lonLatToCartesian(t[n+1]);if(o.distance(h)>1e5)throw new Error("Track is too long! 100 km is maximum.")}let r=new Array(t.length);for(let n=0,a=t.length;n<a;n++)r[n]=this.addPointLonLatAsync(t[n],!0);return Promise.all(r).then((()=>{i||this.events.dispatch(this.events.change,this)})),r}addPointLonLatAsync(t,i=!1){let s=this._planet.ellipsoid.lonLatToCartesian(t),r=this._planet.ellipsoid.getSurfaceNormal3v(s),n=new L(t.lon,t.lat),a=this._planet.ellipsoid.lonLatToCartesian(n),{headEntity:o,groundEntity:h,columnEntity:c,heightLabelEntity:d}=this._createGroundPointer(a);return this._groundPointersLayer.add(h),this._columnPointersLayer.add(c),this._headPointersLayer.add(o),this._heightsLayer.add(d),this._trackEntity.polyline.appendPoint3v(o.getCartesian()),h.properties.lonLatEll.lon=n.lon,h.properties.lonLatEll.lat=n.lat,h.properties.lonLatEll.height=n.height,new Promise((u=>{this.getHeightELLAsync(t).then((_=>{var p;h.properties.lonLatEll.height=_;let f,m=10;t.height===0?(f=s.add(r.scaleTo(_)),s=f.add(r.scaleTo(m))):(m=t.height-_,f=s.sub(r.scaleTo(m))),h.setCartesian3v(f),d.setCartesian3v(s),d.label.setText(`${_.toFixed(1)} m`),d.childEntities[0].label.setText(`${m.toFixed(1)} m`),o.properties.altitude=m,o.setCartesian3v(s),o.properties.columnEntity.ray.setStartPosition3v(f),o.properties.columnEntity.ray.setEndPosition3v(s),(p=this._trackEntity.polyline)==null||p.setPoint3v(s,o.properties.index),i||(this.events.dispatch(this.events.addpoint,o,this),this.events.dispatch(this.events.change,this)),u(o)}))}))}addGroundPointLonLatAsync(t,i=10,s=!1){let r=this._planet.ellipsoid.lonLatToCartesian(t);return this._addPoint(r,t,i,s)}addGroundPoint3vAsync(t,i=10,s=!1){let r=this._planet.ellipsoid.cartesianToLonLat(t);return this._addPoint(t,r,i,s)}_addPoint(t,i,s,r=!1){return new Promise(((n,a)=>{let{headEntity:o,groundEntity:h,columnEntity:c,heightLabelEntity:d}=this._createGroundPointer(t,s);this._groundPointersLayer.add(h),this._columnPointersLayer.add(c),this._headPointersLayer.add(o),this._heightsLayer.add(d),this._trackEntity.polyline.appendPoint3v(o.getCartesian()),h.properties.lonLatEll.lon=i.lon,h.properties.lonLatEll.lat=i.lat,h.properties.lonLatEll.height=i.height,this.getHeightELLAsync(i).then((u=>{var _;h.properties.lonLatEll.height=i.height=u;let p=this._planet.ellipsoid.lonLatToCartesian(i),f=this._planet.ellipsoid.getSurfaceNormal3v(p),m=p.add(f.scale(s));d.setCartesian3v(m),d.label.setText(`${u.toFixed(1)} m`),d.childEntities[0].label.setText(`${s.toFixed(1)} m`),o.setCartesian3v(m),o.properties.columnEntity.ray.setEndPosition3v(m),(_=this._trackEntity.polyline)==null||_.setPoint3v(m,o.properties.index),r||(this.events.dispatch(this.events.addpoint,o,this),this.events.dispatch(this.events.change,this)),n(o)}))}))}setHeadPointCartesian3v(t,i){const s=this._headPointersLayer.getEntities()[t];if(s){let r=this._planet.ellipsoid.lonLatToCartesian(s.properties.lonLatEll),n=i.length()-r.length();n<=0&&(i=r,n=0),s.properties.altitude=n,s.setCartesian3v(i),s.properties.columnEntity.ray.setEndPosition3v(i),s.properties.heightLabelEntity.setCartesian3v(i),s.properties.heightLabelEntity.childEntities[0].label.setText(`${n.toFixed(1)} m`),this._trackEntity.polyline.setPoint3v(i,t),this.events.dispatch(this.events.change,this._pickedHeadEntity)}}setGroundPointCartesian3v(t,i){var s;let r=this._groundPointersLayer.getEntities()[t];if(r){let n=this._planet.ellipsoid.cartesianToLonLat(i);r.properties.lonLatEll.lon=n.lon,r.properties.lonLatEll.lat=n.lat,r.properties.lonLatEll.height=n.height;let a=this._planet.ellipsoid.getSurfaceNormal3v(i),o=r.properties.headEntity,h=r.properties.heightLabelEntity,c=r.properties.altitude;r.setCartesian3v(i);let d=i.add(a.scale(c));o.setCartesian3v(d),o.properties.columnEntity.ray.setStartPosition3v(i),o.properties.columnEntity.ray.setEndPosition3v(d),(s=this._trackEntity.polyline)==null||s.setPoint3v(d,o.properties.index),h.setCartesian3v(d),h.label.setText(`${n.height.toFixed(1)} m`),h.childEntities[0].label.setText(`${c.toFixed(1)} m`),this.events.dispatch(this.events.change,r.properties.headEntity)}}_deactivate(){this.renderer.events.off("ldblclick",this._onLClick),this.renderer.events.off("mousemove",this._onMouseMove),this.renderer.events.off("lup",this._onLUp),this._groundPointersLayer.events.off("mouseenter",this._onGroundPointerEnter),this._groundPointersLayer.events.off("mouseleave",this._onGroundPointerLeave),this._groundPointersLayer.events.off("ldown",this._onGroundPointerLDown),this._groundPointersLayer.events.off("lup",this._onGroundPointerLUp),this._headPointersLayer.events.off("mouseenter",this._onHeadPointerEnter),this._headPointersLayer.events.off("mouseleave",this._onHeadPointerLeave),this._headPointersLayer.events.off("ldown",this._onHeadPointerLDown),this._headPointersLayer.events.off("lup",this._onHeadPointerLUp),this._trackLayer.remove(),this._groundPointersLayer.remove(),this._headPointersLayer.remove(),this._columnPointersLayer.remove(),this._trackLayer.remove(),this._heightsLayer.remove(),this._pointerLayer.remove(),this.clear()}setPointerVisibility(t){this._pointerLayer.setVisibility(t)}setVisibility(t){this._groundPointersLayer.setVisibility(t),this._trackLayer.setVisibility(t),this._columnPointersLayer.setVisibility(t),this._headPointersLayer.setVisibility(t),this._trackLayer.setVisibility(t),this._heightsLayer.setVisibility(t),this._pointerLayer.setVisibility(t)}clear(){this._headPointersLayer.setEntities([]),this._groundPointersLayer.setEntities([]),this._columnPointersLayer.setEntities([]),this._heightsLayer.setEntities([]),this._trackEntity.polyline.setPath3v([])}frame(){if(this._clampToGround){let t=new v;const i=this._planet.quadTreeStrategy._renderedNodes,s=this._groundPointersLayer.getEntities();for(let r=0;r<s.length;r++){let n=s[r];for(let a=0;a<i.length;a++){let o=i[a];if(o.segment.isEntityInside(n)){o.segment.getEntityTerrainPoint(n,t),n.setCartesian3v(t),n.properties.columnEntity.ray.setStartPosition3v(t);break}}}}}get ellipsoid(){return this._planet?this._planet.ellipsoid:null}}const Ah=["change","addpoint"],Eh=["reset","list","location"];class Lh extends xe{constructor(t={}){super({...t,template:'<div class="og-elevationprofile-buttons"></div>'}),this.events=this.events.registerNames(Eh),this.pointListBtn=new de({classList:["og-elevationprofile-button"],icon:'<?xml version="1.0" encoding="utf-8"?><svg width="800px" height="800px" viewBox="0 0 32 32" id="icon" xmlns="http://www.w3.org/2000/svg"><defs><style>.cls-1{fill:none;}</style></defs><title>list</title><rect x="10" y="6" width="18" height="2"/><rect x="10" y="24" width="18" height="2"/><rect x="10" y="15" width="18" height="2"/><rect x="4" y="15" width="2" height="2"/><rect x="4" y="6" width="2" height="2"/><rect x="4" y="24" width="2" height="2"/></svg>',title:"Point List"}),this.pointListBtn.events.on("change",(i=>{this.events.dispatch(this.events.list,i)}))}render(t){super.render(t);let i=new ot({classList:["og-elevationprofile-button"],icon:`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg width="30" height="30" viewBox="0 0 30 30" version="1.1">
  <g transform="translate(0,-289.0625)">
    <path d="M 15 6 C 10.041282 6 6 10.04128 6 15 C 6 19.95872 10.041282 24 15 24 C 16.586491 24 18.07668 23.58246 19.373047 22.857422 L 17.888672 21.375 C 17.00816 21.772814 16.032235 22 15 22 C 11.122162 22 8 18.87784 8 15 C 8 11.12216 11.122162 8 15 8 C 18.877838 8 22 11.12216 22 15 L 19 15 L 23 20 L 27 15 L 24 15 C 24 10.04128 19.958718 6 15 6 z " transform="translate(0,289.0625)" />
  </g>
</svg>`,title:"Reset"});i.appendTo(this.el),i.events.on("click",(()=>{this.model.clear(),this.events.dispatch(this.events.reset,this)})),this.pointListBtn.appendTo(this.el);let s=new ot({classList:["og-elevationprofile-button","og-elevationprofile-button__location"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Svg Vector Icons : http://www.onlinewebfonts.com/icon -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 256 256" enable-background="new 0 0 256 256" xml:space="preserve">
<metadata> Svg Vector Icons : http://www.onlinewebfonts.com/icon </metadata>
<g><g><path fill="#000000" d="M127,169.4c23.7,0,42.8-18.3,42.8-41s-19.2-41-42.8-41c-23.7,0-42.8,18.4-42.8,41S103.4,169.4,127,169.4z"/><path fill="#000000" d="M221.7,120.2c-3.8-44-40.9-78.9-87-82V15h-16.3v23.6c-44.8,4-80.3,38.5-84.1,81.7H10v15.6h24.3c3.8,43.1,39.3,77.4,84.1,81.7V241h16.3v-23.2c46-3.1,83.2-37.9,87-82H246v-15.6H221.7L221.7,120.2L221.7,120.2z M128,201.6c-42.5,0-76.7-33-76.7-73.4c0-40.4,34.5-73.4,76.7-73.4c42.5,0,76.7,33,76.7,73.4C204.7,168.5,170.5,201.6,128,201.6L128,201.6z"/></g></g>
</svg>`,title:"View bounds"});return s.appendTo(this.el),s.events.on("click",(()=>{this.events.dispatch(this.events.location,this)})),this}}class Ph extends it{constructor(t){super({title:"Points List",visible:!1,resizable:!0,useHide:!0,top:150,left:200,width:400,height:300,minHeight:100,minWidth:100,...t}),this._onApplyClick=()=>{try{this.model.clear();let i=JSON.parse(this.$textarea.value),s=new Array(i.length);for(let r=0;r<i.length;r++){let n=i[r];s[r]=new L(n[0],n[1],n[2])}this.model.addPointLonLatArrayAsync(s)}catch(i){console.error(i)}},this.$textarea=null}render(t){super.render(t);let i=new xe({template:`<div class="og-elevationprofile-list">
        <textarea placeholder="[[lon, lat, height], [lon, lat, height], ..., [lon, lat, height]]"></textarea>
        <div class="og-elevationprofile-list-buttons"></div>
    </div>`});i.appendTo(this.container);let s=new ot({classList:["og-elevationprofile-list-apply"],icon:"Apply"});return s.appendTo(i.select(".og-elevationprofile-list-buttons")),s.events.on("click",this._onApplyClick),this.$textarea=i.select("textarea"),this}}class Sh extends xe{constructor(t={}){super({...t,template:`<div class="og-elevationprofile-legend">
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__track">
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__ground">
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__warning">        
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__collision">
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
      </div>`}),this.$groundValue=null,this.$trackValue=null,this.$warningValue=null,this.$collisionValue=null,this.$trackUnits=null,this.$groundUnits=null,this.$warningUnits=null,this.$collisionUnits=null}render(t){return super.render(t),this.$trackValue=this.select(".og-elevationprofile-legend__track .og-elevationprofile-value"),this.$groundValue=this.select(".og-elevationprofile-legend__ground .og-elevationprofile-value"),this.$warningValue=this.select(".og-elevationprofile-legend__warning .og-elevationprofile-value"),this.$collisionValue=this.select(".og-elevationprofile-legend__collision .og-elevationprofile-value"),this.$trackUnits=this.select(".og-elevationprofile-legend__track .og-elevationprofile-units"),this.$groundUnits=this.select(".og-elevationprofile-legend__ground .og-elevationprofile-units"),this.$warningUnits=this.select(".og-elevationprofile-legend__warning .og-elevationprofile-units"),this.$collisionUnits=this.select(".og-elevationprofile-legend__collision .og-elevationprofile-units"),this}clear(){this.$trackValue&&(this.$trackValue.innerText="0"),this.$trackUnits&&(this.$trackUnits.innerText="m"),this.$groundValue&&(this.$groundValue.innerText="0"),this.$groundUnits&&(this.$groundUnits.innerText="m"),this.$warningValue&&(this.$warningValue.innerText="0"),this.$warningUnits&&(this.$warningUnits.innerText="m"),this.$collisionValue&&(this.$collisionValue.innerText="0"),this.$collisionUnits&&(this.$collisionUnits.innerText="m")}setTrackLength(t){let i=Ot(t);this.$trackValue.innerText=i[0],this.$trackUnits.innerText=i[1]}setGroundLength(t){let i=Ot(t);this.$groundValue.innerText=i[0],this.$groundUnits.innerText=i[1]}setWarningLength(t){let i=Ot(t);this.$warningValue.innerText=i[0],this.$warningUnits.innerText=i[1]}setCollisionLength(t){let i=Ot(t);this.$collisionValue.innerText=i[0],this.$collisionUnits.innerText=i[1]}}const Ut="rgb(253,77,77)",ar="rgb(248,115,115)",$i="rgb(73,73,239)",or="rgb(90,90,253)",Xi="rgb(26,122,26)",lr="rgb(55,191,55)",$r="rgba(255,255,255,0.8)",zi=.1,ho=new v(zi,zi,zi),co=.17,Xr=.0095,Rh=$.createCylinder(Xr,Xr,.83).scale(ho),Mh=$.createCylinder(0,.04,co,16,16,!1,!0,0,-.17).scale(ho);class us extends U{constructor(t={}){super({independentPicking:!0,yaw:t.yaw||0,pitch:t.pitch||0,roll:t.roll||0,forceGlobalPosition:!0,geoObject:{color:t.color||Ut,scale:1,tag:"line",object3d:Rh},properties:t.properties}),this._size=t.size!=null?t.size:1,this.appendChild(new U({yaw:t.yaw||0,pitch:t.pitch||0,roll:t.roll||0,forceGlobalPosition:!0,geoObject:{color:t.color||Ut,scale:1,tag:"tip",object3d:Mh},properties:t.properties}))}setSize(t){this._size=t;const i=new v(1,(this._size-co)/.83,1),s=new v(0,this._size*zi,0);let r=this.childEntities[0];this.setScale3v(i),r.geoObject.setTranslate3v(s)}setColorHTML(t){let i=this.childEntities[0];this.geoObject.setColorHTML(t),i.geoObject.setColorHTML(t)}}class Bh extends U{constructor(t={}){super(t),this._size=t.size!=null?t.size:1,this.childEntities=[],this._init()}_init(){let t=new us({color:Ut,yaw:0,pitch:0,roll:90*G,properties:{opName:"move_x",noEdit:!0,style:{color:Ut,selectColor:ar}}}),i=new us({color:$i,yaw:0,pitch:0,roll:0,properties:{opName:"move_y",noEdit:!0,style:{color:$i,selectColor:or}}}),s=new us({color:Xi,yaw:0,pitch:90*G,roll:0,properties:{opName:"move_z",noEdit:!0,style:{color:Xi,selectColor:lr}}});this.appendChild(t),this.appendChild(i),this.appendChild(s),this.setSize(this._size)}setSize(t){this.childEntities[0].setSize(t),this.childEntities[1].setSize(t),this.childEntities[2].setSize(t)}setPitch(t){let i=this.childEntities[0],s=i.childEntities[0];i.setPitch(t),s.setPitch(t),i=this.childEntities[1],s=i.childEntities[0],i.setPitch(t),s.setPitch(t),i=this.childEntities[2],s=i.childEntities[0],i.setPitch(t+90),s.setPitch(t+90)}setYaw(t){let i=this.childEntities[0],s=i.childEntities[0];i.setYaw(t),s.setYaw(t),i=this.childEntities[1],s=i.childEntities[0],i.setYaw(t),s.setYaw(t),i=this.childEntities[2],s=i.childEntities[0],i.setYaw(t),s.setYaw(t)}setRoll(t){let i=this.childEntities[0],s=i.childEntities[0];i.setRoll(t+90),s.setRoll(t+90),i=this.childEntities[1],s=i.childEntities[0],i.setRoll(t),s.setRoll(t)}getY(){return this.childEntities[1].getAbsoluteRotation().mulVec3(v.UP).normalize()}}const kh=$.createPlane(1,1,-.5,0,.5);class Ih extends U{constructor(t={}){super(t),this._init()}_init(){let t=new U({independentPicking:!0,scale:.025,forceGlobalPosition:!0,geoObject:{color:$r,tag:"plane",object3d:kh},properties:{opName:"move_xz",noEdit:!0,style:{color:$r,selectColor:"rgba(255,255,255,1.0)"}}});this.appendChild(t)}}const vi=360,_s=.95,Zr=new Array(vi),Qr=new Array(vi),Kr=new Array(vi);class zh extends U{constructor(t={}){super(t),this._init()}_init(){const t=vi;let i=new U({independentPicking:!0,polyline:{path3v:[Array.from({length:t},((n,a)=>new v))],thickness:3.1,color:Ut,isClosed:!0},properties:{opName:"rotate_pitch",noEdit:!0,style:{color:Ut,selectColor:ar}}}),s=new U({independentPicking:!0,polyline:{path3v:[Array.from({length:t},((n,a)=>new v))],thickness:2.5,color:$i,isClosed:!0},properties:{opName:"rotate_yaw",noEdit:!0,style:{color:$i,selectColor:or}}}),r=new U({independentPicking:!0,polyline:{path3v:[Array.from({length:t},((n,a)=>new v))],thickness:2.5,color:Xi,isClosed:!0},properties:{opName:"rotate_roll",noEdit:!0,style:{color:Xi,selectColor:lr}}});this.appendChild(i),this.appendChild(s),this.appendChild(r)}setCartesian3v(t,i=0){if(super.setCartesian3v(t),this._entityCollection&&this._entityCollection.renderNode){let s=this._entityCollection.renderNode,r=s.renderer.activeCamera,n=s.getFrameRotation(t).conjugate(),a=.15*r.eye.distance(t),o=F.xRotation(0),h=F.yRotation(i),c=F.zRotation(0).mul(o).mul(h).mul(s.getFrameRotation(t)).conjugate();for(let p=0,f=0,m=1;p<vi;p+=m,f++){let g=p*G,y=Math.cos(g),x=Math.sin(g),b=c.mulVec3(new v(0,x,y)).normalize().scale(a).add(t),T=n.mulVec3(new v(y,0,x)).normalize().scale(a).add(t),w=c.mulVec3(new v(y,x,0)).normalize().scale(a).add(t);Zr[f]=b,Qr[f]=T,Kr[f]=w}this.childEntities[0].polyline.setPath3v([Zr],void 0,!0),this.childEntities[1].polyline.setPath3v([Qr],void 0,!0),this.childEntities[2].polyline.setPath3v([Kr],void 0,!0);let d=c.mulVec3(new v(1,0,0)).normalize(),u=n.mulVec3(new v(0,1,0)).normalize(),_=c.mulVec3(new v(0,0,1)).normalize();this.childEntities[0].polyline.setVisibleSphere(t,Math.abs(d.dot(r.getForward()))>_s?0:a),this.childEntities[1].polyline.setVisibleSphere(t,Math.abs(u.dot(r.getForward()))>_s?0:a),this.childEntities[2].polyline.setVisibleSphere(t,Math.abs(_.dot(r.getForward()))>_s?0:a)}}}class Dh extends U{constructor(t={}){super({...t,forceGlobalPosition:!0}),this._init()}_init(){let t=[],i=[],s=[],r=ft(ar),n=ft(or),a=ft(lr);for(let d=0;d<20;d++){let u=1;if(d<5){let _=d/5;u=.5*(1-Math.cos(Math.PI*_))}else if(d>15){let _=(d-15)/5;u=1-.5*(1-Math.cos(Math.PI*_))}i.push([a[0],a[1],a[2],u]),t.push([r[0],r[1],r[2],u]),s.push([n[0],n[1],n[2],u])}let o=new U({polyline:{path3v:[Array.from({length:20},((d,u)=>new v))],thickness:2.5,pathColors:[t],isClosed:!1}}),h=new U({polyline:{path3v:[Array.from({length:20},((d,u)=>new v))],thickness:2.5,pathColors:[s],isClosed:!1}}),c=new U({polyline:{path3v:[Array.from({length:20},((d,u)=>new v))],thickness:2.5,pathColors:[i],isClosed:!1}});this.appendChild(o),this.appendChild(h),this.appendChild(c)}setCartesian3v(t){if(super.setCartesian3v(t),this._entityCollection&&this._entityCollection.renderNode){let i=this._entityCollection.renderNode,s=.05*i.renderer.activeCamera.eye.distance(t);if(i.planet){let r=[],n=[],a=[],o=i.planet.ellipsoid.getSurfaceNormal3v(t),h=this._lonLat,c=10;for(let d=-10;d<c;d++)a.push(new L(h.lon,h.lat+d,h.height)),n.push(new L(h.lon+d,h.lat,h.height)),r.push(t.add(o.scaleTo(d*s)));this.childEntities[0].polyline.setPathLonLatFast([n]),this.childEntities[1].polyline.setPath3vFast([r]),this.childEntities[2].polyline.setPathLonLatFast([a])}else{let r=[],n=[],a=[],o=v.UNIT_Y,h=v.UNIT_X,c=v.UNIT_Z,d=10;for(let u=-10;u<d;u++)n.push(t.add(h.scaleTo(u*s))),a.push(t.add(o.scaleTo(u*s))),r.push(t.add(c.scaleTo(u*s)));this.childEntities[0].polyline.setPath3vFast([n]),this.childEntities[1].polyline.setPath3vFast([a]),this.childEntities[2].polyline.setPath3vFast([r])}}}}function Jr(l,t,i,s,r,n){let a=r.add(v.UP),o=r.add(l),h=new v;if(new V(t,i).hitPlaneRes(pe.fromPoints(r,a,o),h)===V.INSIDE){let c=v.proj_b_to_a(h,l);if(new V(t,s).hitPlaneRes(pe.fromPoints(r,a,o),h)===V.INSIDE){let d=v.proj_b_to_a(h,l).sub(c);n.copy(r.add(d))}}}class Fh extends lt{constructor(t={}){super(t.name||"GeoObjectEditorScene"),this._onAxisLayerMouseEnter=i=>{this.renderer.handler.canvas.style.cursor="pointer",i.pickingObject.setColorHTML(i.pickingObject.properties.style.selectColor)},this._onAxisLayerMouseLeave=i=>{this.renderer.handler.canvas.style.cursor="default",i.pickingObject.setColorHTML(i.pickingObject.properties.style.color)},this._onAxisLayerLUp=i=>{this._selectedMove=null,this._navActivate(),this._setAxisTrackVisibility(!1)},this._onAxisLayerLDown=i=>{this._clickPos=i.pos.clone(),this._selectedEntity&&(this._selectedEntityCart=this._selectedEntity.getAbsoluteCartesian(),this._setAxisTrackVisibility(!0)),this._selectedMove=i.pickingObject.properties.opName,this._navDeactivate()},this._onPlaneLayerMouseEnter=i=>{this.renderer.handler.canvas.style.cursor="pointer",i.pickingObject.geoObject.setColorHTML(i.pickingObject.properties.style.selectColor)},this._onPlaneLayerMouseLeave=i=>{this.renderer.handler.canvas.style.cursor="default",i.pickingObject.geoObject.setColorHTML(i.pickingObject.properties.style.color)},this._onPlaneLayerLUp=i=>{this._selectedMove=null,this._navActivate(),this._setAxisTrackVisibility(!1)},this._onPlaneLayerLDown=i=>{this._clickPos=i.pos.clone(),this._selectedEntity&&(this._selectedEntityCart=this._selectedEntity.getAbsoluteCartesian(),this._setAxisTrackVisibility(!0)),this._selectedMove=i.pickingObject.properties.opName,this._navDeactivate()},this._onRotateLayerMouseEnter=i=>{this.renderer.handler.canvas.style.cursor="pointer",i.pickingObject.polyline.setColorHTML(i.pickingObject.properties.style.selectColor)},this._onRotateLayerMouseLeave=i=>{this.renderer.handler.canvas.style.cursor="default",i.pickingObject.polyline.setColorHTML(i.pickingObject.properties.style.color)},this._onRotateLayerLUp=i=>{this._selectedMove=null,this._navActivate()},this._onRotateLayerLDown=i=>{this._clickPos=i.pos.clone(),this._selectedEntity&&(this._selectedEntityCart=this._selectedEntity.getAbsoluteCartesian(),this._selectedEntity&&(this._selectedEntityPitch=this._selectedEntity.getAbsolutePitch(),this._selectedEntityYaw=this._selectedEntity.getAbsoluteYaw(),this._selectedEntityRoll=this._selectedEntity.getAbsoluteRoll())),this._selectedMove=i.pickingObject.properties.opName,this._navDeactivate()},this._onMouseMove=i=>{this._selectedEntity&&this._selectedMove&&this._ops[this._selectedMove]&&this._ops[this._selectedMove](i)},this._onLclick=i=>{i.pickingObject&&i.pickingObject instanceof U&&this.select(i.pickingObject)},this._moveX=i=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,r=this._selectedEntityCart,n=s.unproject(this._clickPos.x,this._clickPos.y),a=new v;if(this.planet){let o=new V(s.eye,n).hitSphere(new Be(r.length(),new v)),h=new V(s.eye,i.direction).hitSphere(new Be(r.length(),new v));if(!h)return;if(a=F.getRotationBetweenVectors(o.normal(),h.normal()).mulVec3(r),this.ellipsoid){let c=this.ellipsoid.cartesianToLonLat(r),d=this.ellipsoid.cartesianToLonLat(a);this.ellipsoid.lonLatToCartesianRes(new L(d.lon,c.lat,c.height),a)}}else Jr(v.UNIT_X,s.eye,n,i.direction,r,a);this._selectedEntity.setAbsoluteCartesian3v(a),this.events.dispatch(this.events.position,a,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._moveY=i=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,r=this._selectedEntityCart,n=v.UP;this.planet&&(n=this._axisEntity.getY());let a=r.add(n),o=r.add(s.getRight()),h=new v,c=s.unproject(this._clickPos.x,this._clickPos.y);if(new V(s.eye,c).hitPlaneRes(pe.fromPoints(r,a,o),h)===V.INSIDE){let d=v.proj_b_to_a(h,n);if(new V(s.eye,i.direction).hitPlaneRes(pe.fromPoints(r,a,o),h)===V.INSIDE){let u=v.proj_b_to_a(h,n).sub(d),_=this._selectedEntityCart.add(u);this._selectedEntity.setAbsoluteCartesian3v(_),this.events.dispatch(this.events.position,h,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}}},this._moveZ=i=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,r=this._selectedEntityCart,n=s.unproject(this._clickPos.x,this._clickPos.y),a=new v;if(this.planet){let o=new V(s.eye,n).hitSphere(new Be(r.length(),new v)),h=new V(s.eye,i.direction).hitSphere(new Be(r.length(),new v));if(!h)return;if(a=F.getRotationBetweenVectors(o.normal(),h.normal()).mulVec3(r),this.ellipsoid){let c=this.ellipsoid.cartesianToLonLat(r),d=this.ellipsoid.cartesianToLonLat(a);this.ellipsoid.lonLatToCartesianRes(new L(c.lon,d.lat,c.height),a)}}else Jr(v.UNIT_Z,s.eye,n,i.direction,r,a);this._selectedEntity.setAbsoluteCartesian3v(a),this.events.dispatch(this.events.position,a,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._moveXZ=i=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,r=this._selectedEntityCart,n=s.unproject(this._clickPos.x,this._clickPos.y),a=new v;if(this.planet){let o=new V(s.eye,n).hitSphere(new Be(r.length(),new v)),h=new V(s.eye,i.direction).hitSphere(new Be(r.length(),new v));if(!h)return;if(a=F.getRotationBetweenVectors(o.normal(),h.normal()).mulVec3(r),this.ellipsoid){let c=this.ellipsoid.cartesianToLonLat(a),d=this._selectedEntity.getLonLat().height;this.ellipsoid.lonLatToCartesianRes(new L(c.lon,c.lat,d),a)}}else{let o=r.add(v.UNIT_X),h=r.add(v.UNIT_Z),c=new v,d=new v;if(new V(s.eye,n).hitPlaneRes(pe.fromPoints(r,o,h),c)===V.INSIDE&&new V(s.eye,i.direction).hitPlaneRes(pe.fromPoints(r,o,h),d)===V.INSIDE){let u=d.sub(c);a=r.add(u)}}this._selectedEntity.setAbsoluteCartesian3v(a),this.events.dispatch(this.events.position,a,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._moveXY=i=>{console.log("moveXY")},this._moveZY=i=>{console.log("moveZY")},this._rotatePitch=i=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,r=this._selectedEntityCart,n=F.xRotation(0),a=F.yRotation(this._selectedEntity.getYaw()),o=F.zRotation(0).mul(n).mul(a).mul(this.getFrameRotation(r)).conjugate().mulVec3(new v(1,0,0)).normalize(),h=s.unproject(this._clickPos.x,this._clickPos.y),c=new pe(r,o),d=new v,u=new v;if(new V(s.eye,h).hitPlaneRes(c,d)===V.INSIDE&&new V(s.eye,i.direction).hitPlaneRes(c,u)===V.INSIDE){let _=d.sub(r).normalize(),p=u.sub(r).normalize(),f=Math.sign(_.cross(p).dot(o)),m=Math.acos(_.dot(p)),g=this._selectedEntityPitch+f*m;this._selectedEntity.setAbsolutePitch(g),this.events.dispatch(this.events.pitch,g,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}},this._rotateYaw=i=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,r=this._selectedEntityCart,n=this.getFrameRotation(r).conjugate().mulVec3(new v(0,1,0)).normalize(),a=s.unproject(this._clickPos.x,this._clickPos.y),o=new pe(r,n),h=new v,c=new v;if(new V(s.eye,a).hitPlaneRes(o,h)===V.INSIDE&&new V(s.eye,i.direction).hitPlaneRes(o,c)===V.INSIDE){let d=h.sub(r).normalize(),u=c.sub(r).normalize(),_=Math.sign(u.cross(d).dot(n)),p=Math.acos(d.dot(u)),f=this._selectedEntityYaw+_*p;this._selectedEntity.setAbsoluteYaw(f),this.events.dispatch(this.events.yaw,f,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}},this._rotateRoll=i=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,r=this._selectedEntityCart;this.getFrameRotation(r).conjugate();let n=F.xRotation(0),a=F.yRotation(this._selectedEntity.getYaw()),o=F.zRotation(0).mul(n).mul(a).mul(this.getFrameRotation(r)).conjugate().mulVec3(new v(0,0,1)).normalize(),h=s.unproject(this._clickPos.x,this._clickPos.y),c=new pe(r,o),d=new v,u=new v;if(new V(s.eye,h).hitPlaneRes(c,d)===V.INSIDE&&new V(s.eye,i.direction).hitPlaneRes(c,u)===V.INSIDE){let _=d.sub(r).normalize(),p=u.sub(r).normalize(),f=Math.sign(_.cross(p).dot(o)),m=Math.acos(_.dot(p)),g=this._selectedEntityRoll+f*m;this._selectedEntity.setAbsoluteRoll(g),this.events.dispatch(this.events.roll,g,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}},this._scale=i=>{this.events.dispatch(this.events.scale,1,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._scaleX=i=>{},this._scaleY=i=>{},this._scaleZ=i=>{},this.events=le(Oh),this._planet=t.planet||null,this._startPos=null,this._startClick=new H,this._axisEntity=new Bh,this._planeEntity=new Ih,this._rotateEntity=new zh,this._axisTrackEntity=new Dh,this._moveLayer=new ht({scaleByDistance:[.1,Tt,.1],useLighting:!1,pickingScale:[5,1.1,5],visibility:!1,depthOrder:1e3}),this._planeLayer=new ht({scaleByDistance:[.1,Tt,.1],useLighting:!1,visibility:!1,depthOrder:1e3}),this._rotateLayer=new ht({useLighting:!1,visibility:!1,depthOrder:1e3,pickingScale:5}),this._selectedEntity=null,this._clickPos=new H,this._selectedEntityCart=new v,this._selectedEntityPitch=0,this._selectedEntityYaw=0,this._selectedEntityRoll=0,this._selectedMove=null,this._axisTrackVisibility=!1,this._axisTrackLayer=new ht({useLighting:!1,visibility:!1,pickingScale:5,pickingEnabled:!1,opacity:.6}),this._ops={move_x:this._moveX,move_y:this._moveY,move_z:this._moveZ,move_xz:this._moveXZ,move_xy:this._moveXY,move_zy:this._moveZY,rotate_pitch:this._rotatePitch,rotate_yaw:this._rotateYaw,rotate_roll:this._rotateRoll,scale:this._scale,scale_x:this._scaleX,scale_y:this._scaleY,scale_z:this._scaleZ}}get ellipsoid(){if(this._planet)return this._planet.ellipsoid}get planet(){return this._planet}bindPlanet(t){this._planet=t}init(){this.activate()}onremove(){this.deactivate()}_addAxisLayers(){this._moveLayer.addTo(this),this._planeLayer.addTo(this),this._rotateLayer.addTo(this),this._axisTrackLayer.addTo(this),this._moveLayer.add(this._axisEntity),this._moveLayer.events.on("mouseenter",this._onAxisLayerMouseEnter),this._moveLayer.events.on("mouseleave",this._onAxisLayerMouseLeave),this._moveLayer.events.on("lup",this._onAxisLayerLUp),this._moveLayer.events.on("ldown",this._onAxisLayerLDown),this._planeLayer.add(this._planeEntity),this._planeLayer.events.on("mouseenter",this._onPlaneLayerMouseEnter),this._planeLayer.events.on("mouseleave",this._onPlaneLayerMouseLeave),this._planeLayer.events.on("lup",this._onPlaneLayerLUp),this._planeLayer.events.on("ldown",this._onPlaneLayerLDown),this._rotateLayer.add(this._rotateEntity),this._rotateLayer.events.on("mouseenter",this._onRotateLayerMouseEnter),this._rotateLayer.events.on("mouseleave",this._onRotateLayerMouseLeave),this._rotateLayer.events.on("lup",this._onRotateLayerLUp),this._rotateLayer.events.on("ldown",this._onRotateLayerLDown),this._axisTrackLayer.add(this._axisTrackEntity)}_navActivate(){this.renderer&&(this.renderer.controls.navigation&&this.renderer.controls.navigation.activate(),this.renderer.controls.SimpleNavigation&&this.renderer.controls.SimpleNavigation.activate())}_navDeactivate(){this.renderer&&(this.renderer.controls.navigation&&this.renderer.controls.navigation.deactivate(),this.renderer.controls.SimpleNavigation&&this.renderer.controls.SimpleNavigation.deactivate())}_removeAxisLayers(){this._moveLayer.remove(),this._planeLayer.remove(),this._rotateLayer.remove()}activate(){this.renderer.events.on("lclick",this._onLclick),this.renderer.events.on("mousemove",this._onMouseMove),this._addAxisLayers()}deactivate(){this.renderer.events.off("lclick",this._onLclick),this.renderer.events.off("mousemove",this._onMouseMove),this._removeAxisLayers(),this.clear()}_setAxisTrackVisibility(t){t!==this._axisTrackVisibility&&(this._axisTrackVisibility=t,this._axisTrackLayer.setVisibility(t))}setVisibility(t){this._moveLayer.setVisibility(t),this._planeLayer.setVisibility(t),this._rotateLayer.setVisibility(t),this.unlockView()}readyToEdit(t){return!t.properties||!t.properties.noEdit}select(t){(!this._selectedEntity||this._selectedEntity&&!t.isEqual(this._selectedEntity))&&this.readyToEdit(t)&&(this._selectedEntity&&this.unselect(),this._selectedEntity=t,this.renderer&&this.renderer.setRelativeCenter(),this.setVisibility(!0),this.events.dispatch(this.events.select,this._selectedEntity))}unselect(){this.setVisibility(!1);let t=this._selectedEntity;this._selectedEntity=null,this.events.dispatch(this.events.unselect,t)}clear(){this.removeEntityCollection(this._moveLayer),this.removeEntityCollection(this._planeLayer),this.removeEntityCollection(this._rotateLayer)}frame(){if(this._selectedEntity){let t=this._selectedEntity.getAbsoluteCartesian();this._axisEntity.setCartesian3v(t),this._planeEntity.setCartesian3v(t),this._rotateEntity.setCartesian3v(t,this._selectedEntity.getAbsoluteYaw()),this._axisTrackEntity.setCartesian3v(t)}}getFrameRotation(t){return this._planet?this._planet.getFrameRotation(t):super.getFrameRotation(t)}getSelectedEntity(){return this._selectedEntity}lockView(){this.renderer&&this._selectedEntity&&this.renderer.controls.CameraLock.lockView(this._selectedEntity)}unlockView(){if(this.renderer&&this._selectedEntity){let t=this.renderer.controls.CameraLock;t&&t.unlockView()}}}const Oh=["mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter","select","unselect","change","position","pitch","yaw","roll","scale"],Nh=["change"];class me extends xe{constructor(t={}){super({template:Ie(`<div class="og-input">
      <div class="og-input-label">{label}</div>
      <input type="{type}"/>
    </div>`,{label:t.label||"",type:t.type||"text"})}),this._onResize=()=>{},this._onMouseWheel=i=>{(i=i||window.event).preventDefault(),i.stopPropagation()},this._onMouseWheelFF=i=>{this._onMouseWheel(i)},this._onInput=i=>{(i=i||window.event).preventDefault(),i.stopPropagation(),this._setValue(i.target.value)},this.events=this.events.registerNames(Nh),this._value=t.value||"",this._maxFixed=t.maxFixed!=null?t.maxFixed:-1,this.$label=null,this.$input=null}render(t){return super.render(t),this.$label=this.select(".og-input-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$input=this.select("input"),this._initEvents(),this}set value(t){t!==this._value&&(this._value=typeof t=="number"?Ps(t,this._maxFixed):t,this.$input&&(this.$input.value=this._value),this.events.dispatch(this.events.change,this._value,this))}_setValue(t){t!==this._value&&(this._value=typeof t=="number"?Ps(t,this._maxFixed):t,this.events.dispatch(this.events.change,this._value,this))}get value(){return this._value}_initEvents(){this.el.addEventListener("mousewheel",this._onMouseWheel),this.el.addEventListener("wheel",this._onMouseWheelFF),this.$input.addEventListener("input",this._onInput)}_clearEvents(){this.el.removeEventListener("mousewheel",this._onMouseWheel),this.el.removeEventListener("wheel",this._onMouseWheelFF),this.$input.removeEventListener("input",this._onInput)}remove(){this._clearEvents(),super.remove()}set visibility(t){this.el&&(this.el.style.display=t?"":"none")}}const Hh=["change"];class Vh extends xe{constructor(t={}){super({template:Ie(`<div class="og-checkbox">
      <div class="og-input-label">{label}</div>
      <div class="og-checkbox-input">
        <input type="checkbox" {checked}/>
      </div>
    </div>`,{label:t.label||"",checked:t.checked?"checked":""})}),this._onResize=()=>{},this._onMouseWheel=i=>{(i=i||window.event).preventDefault(),i.stopPropagation()},this._onMouseWheelFF=i=>{this._onMouseWheel(i)},this._onClick=i=>{(i=i||window.event).stopPropagation(),this.checked=!this._checked},this._checked=t.checked||!1,this._disabled=t.disabled||!1,this.events=this.events.registerNames(Hh),this.$label=null,this.$input=null}set disabled(t){this._disabled=t,this._updateDisabled()}_updateDisabled(){this.el&&(this._disabled?this.el.classList.add("og-input-disabled"):this.el.classList.remove("og-input-disabled"))}get disabled(){return this._disabled}render(t){return super.render(t),this.$label=this.select(".og-input-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$input=this.select("input"),this.$input.checked=this._checked,this._updateDisabled(),this._initEvents(),this}set checked(t){t!==this._checked&&(this._checked=t,this.$input&&(this.$input.checked=this._checked),this.events.dispatch(this.events.change,this._checked,this))}get checked(){return this._checked}_initEvents(){this.el.addEventListener("mousewheel",this._onMouseWheel),this.el.addEventListener("wheel",this._onMouseWheelFF),this.$input.addEventListener("click",this._onClick)}_clearEvents(){this.el.removeEventListener("mousewheel",this._onMouseWheel),this.el.removeEventListener("wheel",this._onMouseWheelFF),this.$input.removeEventListener("click",this._onClick)}remove(){this._clearEvents(),super.remove()}set visibility(t){this.el&&(this.el.style.display=t?"":"none")}}class Uh extends it{constructor(t){super({title:"GeoObject Properties",visible:!1,resizable:!0,useHide:!0,top:25,right:85,width:252,height:480,minHeight:100,minWidth:100,model:t.model}),this._onVisibility=i=>{this.model.setVisibility(i)},this._onSelect=i=>{this.show(),this._refresh(i)},this._onUnselect=i=>{this.hide()},this._onChangeRelativePosition=i=>{let s=this.model.getSelectedEntity();s&&(s.relativePosition=i,this._refresh(s))},this._onPosition=(i,s)=>{this._refresh(s)},this._onPitch=(i,s)=>{this._pitchView.stopPropagation(),this._pitchView.value=s.getPitch()*J,this._absolutePitchView.stopPropagation(),this._absolutePitchView.value=s.getAbsolutePitch()*J},this._onYaw=(i,s)=>{this._yawView.stopPropagation(),this._yawView.value=s.getYaw()*J,this._absoluteYawView.stopPropagation(),this._absoluteYawView.value=s.getAbsoluteYaw()*J},this._onRoll=(i,s)=>{this._rollView.stopPropagation(),this._rollView.value=s.getRoll()*J,this._absoluteRollView.stopPropagation(),this._absoluteRollView.value=s.getAbsoluteRoll()*J},this._onChangeLon=i=>{let s=this.model.getSelectedEntity();if(s){let r=s.getLonLat();s.setLonLat2(parseFloat(i),r.lat,r.height),this._refresh(s)}},this._onChangeLat=i=>{let s=this.model.getSelectedEntity();if(s){let r=s.getLonLat();s.setLonLat2(r.lon,parseFloat(i),r.height),this._refresh(s)}},this._onChangeHeight=i=>{let s=this.model.getSelectedEntity();if(s){let r=s.getLonLat();s.setLonLat2(r.lon,r.lat,parseFloat(i)),this._refresh(s)}},this._onChangeX=i=>{let s=this.model.getSelectedEntity();if(s){let r=s.getCartesian();s.setCartesian(parseFloat(i),r.y,r.z),this._refresh(s)}},this._onChangeY=i=>{let s=this.model.getSelectedEntity();if(s){let r=s.getCartesian();s.setCartesian(r.x,parseFloat(i),r.z),this._refresh(s)}},this._onChangeZ=i=>{let s=this.model.getSelectedEntity();if(s){let r=s.getCartesian();s.setCartesian(r.x,r.y,parseFloat(i)),this._refresh(s)}},this._onChangeAbsoluteX=i=>{let s=this.model.getSelectedEntity();if(s){let r=s.getAbsoluteCartesian();s.setAbsoluteCartesian(parseFloat(i),r.y,r.z),this._refresh(s)}},this._onChangeAbsoluteY=i=>{let s=this.model.getSelectedEntity();if(s){let r=s.getAbsoluteCartesian();s.setAbsoluteCartesian(r.x,parseFloat(i),r.z),this._refresh(s)}},this._onChangeAbsoluteZ=i=>{let s=this.model.getSelectedEntity();if(s){let r=s.getAbsoluteCartesian();s.setAbsoluteCartesian(r.x,r.y,parseFloat(i)),this._refresh(s)}},this._onChangePitch=i=>{let s=this.model.getSelectedEntity();s&&(s.setPitch(parseFloat(i)*G),this._refresh(s))},this._onChangeYaw=i=>{let s=this.model.getSelectedEntity();s&&(s.setYaw(parseFloat(i)*G),this._refresh(s))},this._onChangeRoll=i=>{let s=this.model.getSelectedEntity();s&&(s.setRoll(parseFloat(i)*G),this._refresh(s))},this._onChangeAbsolutePitch=i=>{let s=this.model.getSelectedEntity();s&&(s.setAbsolutePitch(parseFloat(i)*G),this._refresh(s))},this._onChangeAbsoluteYaw=i=>{let s=this.model.getSelectedEntity();s&&(s.setAbsoluteYaw(parseFloat(i)*G),this._refresh(s))},this._onChangeAbsoluteRoll=i=>{let s=this.model.getSelectedEntity();s&&(s.setAbsoluteRoll(parseFloat(i)*G),this._refresh(s))},this._onChangeScale=i=>{let s=this.model.getSelectedEntity();if(s){let r=parseFloat(i);s.setScale(r),this._scaleXView.stopPropagation(),this._scaleYView.stopPropagation(),this._scaleZView.stopPropagation(),this._scaleXView.value=r,this._scaleYView.value=r,this._scaleZView.value=r}},this._onChangeScaleX=i=>{let s=this.model.getSelectedEntity();if(s){let r=s.getScale();s.setScale3v(new v(parseFloat(i),r.y,r.z))}},this._onChangeScaleY=i=>{let s=this.model.getSelectedEntity();if(s){let r=s.getScale();s.setScale3v(new v(r.x,parseFloat(i),r.z))}},this._onChangeScaleZ=i=>{let s=this.model.getSelectedEntity();if(s){let r=s.getScale();s.setScale3v(new v(r.x,r.y,parseFloat(i)))}},this._onGround=()=>{let i=this.model.getSelectedEntity();i&&this.model.planet&&(this.model.planet.terrain?this.model.planet.terrain.getHeightAsync(i.getLonLat(),(s=>{this._heightView.value=s})):this._heightView.value=0)},this._relativePositionView=new Vh({label:"Relative position"}),this._lonView=new me({label:"Lon",type:"number",min:-180,max:180,maxFixed:10}),this._latView=new me({label:"Lat",type:"number",min:-90,max:90,maxFixed:10}),this._heightView=new me({label:"Height",type:"number",maxFixed:4}),this._xView=new me({label:"X",type:"number",maxFixed:10}),this._yView=new me({label:"Y",type:"number"}),this._zView=new me({label:"Z",type:"number"}),this._absXView=new me({label:"Absolute X",type:"number",maxFixed:10}),this._absYView=new me({label:"Absolute Y",type:"number"}),this._absZView=new me({label:"Absolute Z",type:"number"}),this._pitchView=new me({label:"Pitch",type:"number",maxFixed:2}),this._yawView=new me({label:"Yaw",type:"number",maxFixed:2}),this._rollView=new me({label:"Roll",type:"number",maxFixed:2}),this._absolutePitchView=new me({label:"Absolute pitch",type:"number",maxFixed:2}),this._absoluteYawView=new me({label:"Absolute yaw",type:"number",maxFixed:2}),this._absoluteRollView=new me({label:"Absolute roll",type:"number",maxFixed:2}),this._scaleView=new me({label:"Scale",type:"number",maxFixed:2}),this._scaleXView=new me({label:"Scale X",type:"number",maxFixed:2}),this._scaleYView=new me({label:"Scale Y",type:"number",maxFixed:2}),this._scaleZView=new me({label:"Scale Z",type:"number",maxFixed:2}),this._groundBtn=new ot({text:"Ground",title:"Put on the ground",name:"ground",classList:["og-editor-ground_button"]})}render(t){var i;super.render(t),this._initSceneEvents();let s=document.createElement("div");s.classList.add("og-editor_toolbar"),(i=this.container)==null||i.appendChild(s);let r=new de({classList:["og-editor_toolbar-button"],icon:`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" id="filter-center-focus">
  <path d="M5 15H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zM12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
</svg>`,title:"Lock/Unlock camera view"});return r.appendTo(s),r.events.on("change",(n=>{n?this.model.lockView():this.model.unlockView()})),this.events.on("visibility",(n=>{n||(r.events.stopPropagation(),r.setActive(!1))})),this.events.on("visibility",this._onVisibility),this._relativePositionView.appendTo(this.container),this.model.planet&&(this._lonView.appendTo(this.container),this._latView.appendTo(this.container),this._heightView.appendTo(this.container)),this._xView.appendTo(this.container),this._yView.appendTo(this.container),this._zView.appendTo(this.container),this._absXView.appendTo(this.container),this._absYView.appendTo(this.container),this._absZView.appendTo(this.container),this._pitchView.appendTo(this.container),this._yawView.appendTo(this.container),this._rollView.appendTo(this.container),this._absolutePitchView.appendTo(this.container),this._absoluteYawView.appendTo(this.container),this._absoluteRollView.appendTo(this.container),this._scaleView.appendTo(this.container),this._scaleXView.appendTo(this.container),this._scaleYView.appendTo(this.container),this._scaleZView.appendTo(this.container),this.model.planet&&this._groundBtn.appendTo(this.container),this._relativePositionView.events.on("change",this._onChangeRelativePosition),this._lonView.events.on("change",this._onChangeLon),this._latView.events.on("change",this._onChangeLat),this._heightView.events.on("change",this._onChangeHeight),this._xView.events.on("change",this._onChangeX),this._yView.events.on("change",this._onChangeY),this._zView.events.on("change",this._onChangeZ),this._absXView.events.on("change",this._onChangeAbsoluteX),this._absYView.events.on("change",this._onChangeAbsoluteY),this._absZView.events.on("change",this._onChangeAbsoluteZ),this._pitchView.events.on("change",this._onChangePitch),this._yawView.events.on("change",this._onChangeYaw),this._rollView.events.on("change",this._onChangeRoll),this._absolutePitchView.events.on("change",this._onChangeAbsolutePitch),this._absoluteYawView.events.on("change",this._onChangeAbsoluteYaw),this._absoluteRollView.events.on("change",this._onChangeAbsoluteRoll),this._scaleView.events.on("change",this._onChangeScale),this._scaleXView.events.on("change",this._onChangeScaleX),this._scaleYView.events.on("change",this._onChangeScaleY),this._scaleZView.events.on("change",this._onChangeScaleZ),this._groundBtn.appendTo(this.container),this._groundBtn.events.on("click",this._onGround),this}remove(){super.remove(),this._clearSceneEvents()}_initSceneEvents(){this.model.events.on("select",this._onSelect),this.model.events.on("unselect",this._onUnselect),this.model.events.on("position",this._onPosition),this.model.events.on("pitch",this._onPitch),this.model.events.on("yaw",this._onYaw),this.model.events.on("roll",this._onRoll)}_clearSceneEvents(){this.model.events.off("select",this._onSelect),this.model.events.off("unselect",this._onUnselect),this.model.events.off("position",this._onPosition),this.model.events.off("pitch",this._onPitch),this.model.events.off("yaw",this._onYaw),this.model.events.off("roll",this._onRoll)}_refresh(t){t.parent?this._relativePositionView.disabled=!1:this._relativePositionView.disabled=!0,this._relativePositionView.checked=t.relativePosition;let i=t.getLonLat();this._lonView.stopPropagation(),this._latView.stopPropagation(),this._heightView.stopPropagation(),this._lonView.value=i.lon,this._latView.value=i.lat,this._heightView.value=i.height;let s=t.getCartesian();this._xView.stopPropagation(),this._yView.stopPropagation(),this._zView.stopPropagation(),this._xView.value=s.x,this._yView.value=s.y,this._zView.value=s.z,s=t.getAbsoluteCartesian(),this._absXView.stopPropagation(),this._absYView.stopPropagation(),this._absZView.stopPropagation(),this._absXView.value=s.x,this._absYView.value=s.y,this._absZView.value=s.z,this._pitchView.stopPropagation(),this._yawView.stopPropagation(),this._rollView.stopPropagation(),this._pitchView.value=t.getPitch()*J,this._yawView.value=t.getYaw()*J,this._rollView.value=t.getRoll()*J,this._absolutePitchView.stopPropagation(),this._absoluteYawView.stopPropagation(),this._absoluteRollView.stopPropagation(),this._absolutePitchView.value=t.getAbsolutePitch()*J,this._absoluteYawView.value=t.getAbsoluteYaw()*J,this._absoluteRollView.value=t.getAbsoluteRoll()*J,this._scaleView.stopPropagation();let r=t.getScale();r.x===r.y&&r.y===r.z?this._scaleView.value=r.x:this._scaleView.value=1,this._scaleXView.stopPropagation(),this._scaleYView.stopPropagation(),this._scaleZView.stopPropagation(),this._scaleXView.value=r.x,this._scaleYView.value=r.y,this._scaleZView.value=r.z}hide(){super.hide(),this.model.events.stopPropagation(),this.model.unselect()}}const Gh=["lockview","unlockview"];class en extends K{constructor(t={}){super(t),this._onLockViewDraw=()=>{this.renderer&&this._lockEntity&&(this._isFromTheBack||this.renderer.activeCamera.viewDistance(this._lockEntity.getAbsoluteCartesian(),this._lockDistance))},this._onMouseWheel=i=>{if(this.renderer&&this._lockEntity&&!this._isFromTheBack){let s=this.renderer.activeCamera.eye.distance(this._lockEntity.getAbsoluteCartesian());this._lockDistance-=.33*s*Math.sign(i.wheelDelta),this._lockDistance<.001&&(this._lockDistance=.001),this.renderer.activeCamera.viewDistance(this._lockEntity.getAbsoluteCartesian(),this._lockDistance)}},this._onMouseMove=i=>{if(this._lockEntity&&this.renderer&&(i.rightButtonDown||this.renderer.events.isKeyPressed(W.KEY_ALT))){let s=this._lockEntity.getAbsoluteCartesian(),r=this.renderer.activeCamera,n=.5/G;n>.007&&(n=.007),this.planet?r.rotateHorizontal(n*(i.x-i.prev_x),!1,s,s.isZero()?v.UP:s.normal()):r.rotateHorizontal(n*(i.x-i.prev_x),!1,s,v.UP),r.rotateVertical(n*(i.y-i.prev_y),s),this._viewDir=s.sub(r.eye).normalize()}},this.events=le(Gh),this._name="CameraLock",this.planet=t.planet||null,this._lockDistance=0,this._isFromTheBack=!1,this._lockEntity=null,this._viewDir=new v(0,0,0)}onactivate(){this.renderer}ondeactivate(){this.renderer&&this.unlockView()}oninit(){this.activate(),this.renderer}flyCartesian(t,i=120){if(!t.isZero()&&this.renderer)if(this.unlockView(),this.planet){let s=this.planet.camera;this.isVisibleDistance(t)&&s.flyDistance(t,i),s.eye.distance(t)<1e6?s.flyDistance(t,i):s.viewDistance(t,i)}else this.renderer.activeCamera.viewDistance(t,i)}lockView(t,i=!1){if(!this.renderer)return;this._lockDistance=this._getDistance(t,this._lockEntity),this._isFromTheBack=i,this._deactivateLockViewEvents(),this._lockEntity=t;let s=this.renderer.activeCamera;this.planet&&this.planet.camera.stopFlying(),s.viewDistance(t.getAbsoluteCartesian(),this._lockDistance),this._deactivateNav(),this._activateLockViewEvents(),this._viewDir=t.getAbsoluteCartesian().sub(s.eye).normalize(),this.events.dispatch(this.events.lockview,this._lockEntity,i)}_activateNav(){this.renderer&&this.renderer.controls.navigation&&this.renderer.controls.navigation.activate(),this.renderer&&this.renderer.controls.simpleNavigation&&this.renderer.controls.simpleNavigation.activate()}_deactivateNav(){this.renderer&&this.renderer.controls.navigation&&(this.renderer.controls.navigation.deactivate(),this.renderer.controls.navigation.stop()),this.renderer&&this.renderer.controls.simpleNavigation&&this.renderer.controls.simpleNavigation.deactivate()}unlockView(){this._lockEntity&&(this._deactivateLockViewEvents(),this._activateNav(),this.events.dispatch(this.events.unlockview,this._lockEntity),this._lockEntity=null)}_getCenterDist(){return this.renderer&&this.renderer.getDistanceFromPixel(this.renderer.handler.getCenter())||0}_getDistance(t,i){if(this.renderer){let s=t.getAbsoluteCartesian(),r=this.renderer.activeCamera,n=r.eye.distance(s);return i&&(n=r.eye.distance(i.getAbsoluteCartesian())),this.isVisibleDistance(s)?n:r.eye.distance(s)<1e6?this._getCenterDist():120}return 0}isVisibleDistance(t,i=0){if(this.planet){let s=this.planet.ellipsoid.equatorialSize,r=this.planet.camera.eye;return r.distance(t)<Math.sqrt(r.length2()-s*s)+i}return!0}get lockEntity(){return this._lockEntity}flyLonLat(t,i=120){if(this.planet){let s=this.planet.ellipsoid.lonLatToCartesian(t);this.flyCartesian(s,i)}}_activateLockViewEvents(){this.renderer&&(this.renderer.events.on("mousewheel",this._onMouseWheel),this.renderer.events.on("mousemove",this._onMouseMove),this.renderer.events.on("draw",this._onLockViewDraw))}_deactivateLockViewEvents(){this.renderer&&(this.renderer.events.off("mousewheel",this._onMouseWheel),this.renderer.events.off("mousemove",this._onMouseMove),this._lockEntity&&this.renderer.events.off("draw",this._onLockViewDraw))}}const jh=["click"];class qh extends xe{constructor(t){super({template:Ie(`<button class="og-object3d-collection__item">
        <div class="og-object3d-collection__item_name">{name}</div>
    </button>`,{name:t.model.name}),...t}),this.events=le(jh)}render(t){var i;return super.render(t),(i=this.el)==null||i.addEventListener("click",(s=>{this.events.dispatch(this.events.click,this.model,this,s)})),this}}const Yh=["select"];class Wh extends xe{constructor(t){super({template:'<div class="og-object3d-collection"></div>',model:t.model,...t}),this._onAdd=i=>{this._addItem(i)},this.events=le(Yh),this._activeView=null}_addItem(t){let i=new qh({model:t});i.appendTo(this.el),i.events.on("click",(s=>{var r,n;this._activeView&&((r=this._activeView.el)==null||r.classList.remove("active")),this._activeView=i,(n=this._activeView.el)==null||n.classList.add("active"),this.events.dispatch(this.events.select,s,i)}))}render(t){super.render(t);let i=this.model.getItems();for(let s of i)this._addItem(s);return this._initEvents(),this}_initEvents(){this.model.events.on("add",this._onAdd)}}const $h=["select"];class Xh extends it{constructor(t){super({classList:["og-object3d-manager"],title:"Object3D Collection",visible:!1,resizable:!0,useHide:!0,top:25,right:85,width:252,height:480,minHeight:100,minWidth:100}),this._onLoadClick=()=>{let i=new xe({initRender:!0,template:'<input type="file" accept=".obj,.mtl" multiple />'});i.el&&(i.el.addEventListener("change",(s=>{const r=s.target;if(r.files){const n=Array.from(r.files),a=n.find((h=>h.name.toLowerCase().endsWith(".obj"))),o=n.find((h=>h.name.toLowerCase().endsWith(".mtl")));a&&(async function(h,c){return await $.readFileObj(h,c).then((d=>({name:h.name,objects:c?d:[$.merge(d)]})))})(a,o).then(this._addObject)}})),i.el.click())},this._addObject=i=>{this._object3dCollectionView.model.addItem(i)},this.events=le($h),this._object3dCollectionView=new Wh({model:t.model})}render(t){var i;super.render(t);let s=document.createElement("div");s.classList.add("og-editor_toolbar"),(i=this.container)==null||i.appendChild(s);let r=new ot({classList:["og-editor_toolbar-button"],icon:'<svg class="svg-icon" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M426.666667 170.666667H170.666667c-47.146667 0-84.906667 38.186667-84.906667 85.333333L85.333333 768c0 47.146667 38.186667 85.333333 85.333334 85.333333h682.666666c47.146667 0 85.333333-38.186667 85.333334-85.333333V341.333333c0-47.146667-38.186667-85.333333-85.333334-85.333333H512l-85.333333-85.333333z"  /></svg>',title:"Load 3D object"});return r.appendTo(s),r.events.on("click",this._onLoadClick),this._object3dCollectionView.appendTo(this.container),this._object3dCollectionView.events.on("select",(n=>{this.events.dispatch(this.events.select,n)})),this}}const Zh=["add","remove"];class hr{constructor(t={}){this.events=le(Zh,this),this._items=hr.createItemsMap(t.collection||[])}static createItemsMap(t){let i=new Map;for(let s=0;s<t.length;s++)i.set(t[s].name,t[s]);return i}getItem(t){return this._items.get(t)}addItem(t,i=!1){this._items.has(t.name)&&!i||(this._items.set(t.name,t),this.events.dispatch(this.events.add,t))}getItems(){return Array.from(this._items,(([t,i])=>i))}}class Hs extends K{constructor(t={}){super({name:"CameraFrameComposer",autoActivate:!0,...t}),this._onPostdraw=()=>{for(let i=0,s=this._frameHandlers.length;i<s;i++)this._frameHandlers[i].frame()},this._cameraLayer=new ht({scaleByDistance:[100,1e6,1],pickingEnabled:!1}),this._cameraScene=new lt("CameraScene"),this._frameHandlers=t.frameHandlers||[]}get frameHandlers(){return[...this._frameHandlers]}add(t){t.addTo(this),this._cameraLayer.add(t.cameraEntity)}oninit(){super.oninit(),this._cameraLayer.addTo(this._cameraScene)}activate(){super.activate(),this.renderer&&(this.renderer.events.on("postdraw",this._onPostdraw),this.renderer.addNode(this._cameraScene))}deactivate(){super.deactivate(),this.renderer&&(this.renderer.events.off("postdraw",this._onPostdraw),this.renderer.removeNode(this._cameraScene))}}let Qh=$.createFrustum();class tn{constructor(t){this.camera=t.camera,this.frameBuffer=t.frameBuffer,this.frameHandler=t.frameHandler||null,this._composer=null,this._composerIndex=-1,this.showFrustum=t.showFrustum==null||t.showFrustum,this.cameraEntity=new U({visibility:!0,scale:this.frustumScale,geoObject:{tag:"frustum",color:"rgba(0,255,0,0.20)",object3d:Qh}}),this.frameBuffer.init()}get frustumScale(){return $.getFrustumScaleByCameraAspectRatio(1e3,this.camera.getViewAngle(),this.camera.getAspectRatio())}addTo(t){this._composer||(this._composer=t,this._composerIndex=t.frameHandlers.length,this._composer._frameHandlers.push(this))}remove(){this._composer&&(this._composer._frameHandlers.splice(this._composerIndex,1),this._composer=null,this._composerIndex=-1)}frame(){if(this.frameHandler&&this.frameBuffer.handler.gl&&(this.frameHandler(this),this.showFrustum)){let t=this.camera,i=$.getFrustumScaleByCameraAngles(100,t.horizontalViewAngle,t.verticalViewAngle);this.cameraEntity.setScale3v(i),this.cameraEntity.setCartesian3v(t.eye),this.cameraEntity.setAbsolutePitch(t.getAbsolutePitch()),this.cameraEntity.setAbsoluteYaw(t.getAbsoluteYaw()),this.cameraEntity.setAbsoluteRoll(t.getAbsoluteRoll())}}}function Bt(l){let t=1/Math.sqrt(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]);l[0]*=t,l[1]*=t,l[2]*=t,l[3]*=t}class sn{constructor(t={}){this._pickingColorU=new Float32Array([0,0,0]),this._f=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],this.projectionMatrix=new ee,this.inverseProjectionMatrix=new ee,this.projectionViewMatrix=new ee,this.projectionViewRTEMatrix=new ee,this.inverseProjectionViewMatrix=new ee,this.left=0,this.right=0,this.bottom=0,this.top=0,this.near=0,this.far=0,this.cameraFrustumIndex=t.cameraFrustumIndex!=null?t.cameraFrustumIndex:-1,this.setProjectionMatrix(t.fov||30,t.aspect||1,t.near||1,t.far||1e3)}getRightPlane(){return this._f[0]}getLeftPlane(){return this._f[1]}getBottomPlane(){return this._f[2]}getTopPlane(){return this._f[3]}getBackwardPlane(){return this._f[4]}getForwardPlane(){return this._f[5]}getProjectionViewMatrix(){return this.projectionViewMatrix._m}getProjectionViewRTEMatrix(){return this.projectionViewRTEMatrix._m}getProjectionMatrix(){return this.projectionMatrix._m}getInverseProjectionMatrix(){return this.inverseProjectionMatrix._m}setProjectionMatrix(t,i,s,r,n,a=10){if(n){let o=a*Math.tan(t*Ye),h=o*i;this._setFrustumParams(o,h,s,r),this.projectionMatrix.setOrthographic(this.left,this.right,this.bottom,this.top,this.near,this.far)}else{let o=s*Math.tan(t*Ye),h=o*i;this._setFrustumParams(o,h,s,r),this.projectionMatrix.setPerspective(this.left,this.right,this.bottom,this.top,this.near,this.far)}this.projectionMatrix.inverseTo(this.inverseProjectionMatrix)}_setFrustumParams(t,i,s,r){this.top=t,this.right=i,this.bottom=-this.top,this.left=-this.right,this.near=s,this.far=r}setProjectionViewRTEMatrix(t){this.projectionViewRTEMatrix=this.projectionMatrix.mul(t)}setViewMatrix(t){this.projectionViewMatrix=this.projectionMatrix.mul(t),this.projectionViewMatrix.inverseTo(this.inverseProjectionViewMatrix);let i=this.projectionViewMatrix._m;this._f[0][0]=i[3]-i[0],this._f[0][1]=i[7]-i[4],this._f[0][2]=i[11]-i[8],this._f[0][3]=i[15]-i[12],Bt(this._f[0]),this._f[1][0]=i[3]+i[0],this._f[1][1]=i[7]+i[4],this._f[1][2]=i[11]+i[8],this._f[1][3]=i[15]+i[12],Bt(this._f[1]),this._f[2][0]=i[3]+i[1],this._f[2][1]=i[7]+i[5],this._f[2][2]=i[11]+i[9],this._f[2][3]=i[15]+i[13],Bt(this._f[2]),this._f[3][0]=i[3]-i[1],this._f[3][1]=i[7]-i[5],this._f[3][2]=i[11]-i[9],this._f[3][3]=i[15]-i[13],Bt(this._f[3]),this._f[4][0]=i[3]-i[2],this._f[4][1]=i[7]-i[6],this._f[4][2]=i[11]-i[10],this._f[4][3]=i[15]-i[14],Bt(this._f[4]),this._f[5][0]=i[3]+i[2],this._f[5][1]=i[7]+i[6],this._f[5][2]=i[11]+i[10],this._f[5][3]=i[15]+i[14],Bt(this._f[5])}containsPoint(t){for(let i=0;i<6;i++)if(t.dotArr(this._f[i])+this._f[i][3]<=0)return!1;return!0}containsSphereBottomExc(t){let i=-t.radius,s=this._f;return!(t.center.dotArr(s[0])+s[0][3]<=i||t.center.dotArr(s[1])+s[1][3]<=i||t.center.dotArr(s[3])+s[3][3]<=i||t.center.dotArr(s[4])+s[4][3]<=i||t.center.dotArr(s[5])+s[5][3]<=i)}containsSphereButtom(t){let i=-t.radius,s=this._f;return!(t.center.dotArr(s[2])+s[2][3]<=i)}containsSphere(t){let i=-t.radius,s=this._f;return!(t.center.dotArr(s[0])+s[0][3]<=i||t.center.dotArr(s[1])+s[1][3]<=i||t.center.dotArr(s[2])+s[2][3]<=i||t.center.dotArr(s[3])+s[3][3]<=i||t.center.dotArr(s[4])+s[4][3]<=i||t.center.dotArr(s[5])+s[5][3]<=i)}containsSphere2(t,i){let s=-i;return!(t.dotArr(this._f[0])+this._f[0][3]<=s||t.dotArr(this._f[1])+this._f[1][3]<=s||t.dotArr(this._f[2])+this._f[2][3]<=s||t.dotArr(this._f[3])+this._f[3][3]<=s||t.dotArr(this._f[4])+this._f[4][3]<=s||t.dotArr(this._f[5])+this._f[5][3]<=s)}containsBox(t){let i,s,r=!0;for(let n=0;n<6;n++){i=0,s=0;for(let a=0;a<8&&(s===0||i===0);a++)t.vertices[a].dotArr(this._f[n])+this._f[n][3]<0?i++:s++;if(s===0)return!1;i>0&&(r=!0)}return r}}const Q=class{};Q.Linear=l=>l,Q.QuadIn=l=>l*l,Q.QuadOut=l=>1-(1-l)*(1-l),Q.QuadInOut=l=>l<.5?2*l*l:1-Math.pow(-2*l+2,2)/2,Q.CubicIn=l=>l*l*l,Q.CubicOut=l=>1-Math.pow(1-l,3),Q.CubicInOut=l=>l<.5?4*l*l*l:1-Math.pow(-2*l+2,3)/2,Q.QuartIn=l=>l*l*l*l,Q.QuartOut=l=>1-Math.pow(1-l,4),Q.QuartInOut=l=>l<.5?8*l*l*l*l:1-Math.pow(-2*l+2,4)/2,Q.QuintIn=l=>l*l*l*l*l,Q.QuintOut=l=>1-Math.pow(1-l,5),Q.QuintInOut=l=>l<.5?16*l*l*l*l*l:1-Math.pow(-2*l+2,5)/2,Q.SineIn=l=>1-Math.cos(l*Math.PI/2),Q.SineOut=l=>Math.sin(l*Math.PI/2),Q.SineInOut=l=>-(Math.cos(Math.PI*l)-1)/2,Q.ExpoIn=l=>l===0?0:Math.pow(2,10*l-10),Q.ExpoOut=l=>l===1?1:1-Math.pow(2,-10*l),Q.ExpoInOut=l=>l===0?0:l===1?1:l<.5?Math.pow(2,20*l-10)/2:(2-Math.pow(2,-20*l+10))/2,Q.CircIn=l=>1-Math.sqrt(1-Math.pow(l,2)),Q.CircOut=l=>Math.sqrt(1-Math.pow(l-1,2)),Q.CircInOut=l=>l<.5?(1-Math.sqrt(1-Math.pow(2*l,2)))/2:(Math.sqrt(1-Math.pow(-2*l+2,2))+1)/2,Q.BackIn=l=>2.70158*l*l*l-1.70158*l*l,Q.BackOut=l=>1+2.70158*Math.pow(l-1,3)+1.70158*Math.pow(l-1,2),Q.BackInOut=l=>{const t=2.5949095;return l<.5?Math.pow(2*l,2)*(7.189819*l-t)/2:(Math.pow(2*l-2,2)*((t+1)*(2*l-2)+t)+2)/2},Q.ElasticIn=l=>{const t=2*Math.PI/3;return l===0?0:l===1?1:-Math.pow(2,10*l-10)*Math.sin((10*l-10.75)*t)},Q.ElasticOut=l=>{const t=2*Math.PI/3;return l===0?0:l===1?1:Math.pow(2,-10*l)*Math.sin((10*l-.75)*t)+1},Q.ElasticInOut=l=>{const t=2*Math.PI/4.5;return l===0?0:l===1?1:l<.5?-Math.pow(2,20*l-10)*Math.sin((20*l-11.125)*t)/2:Math.pow(2,-20*l+10)*Math.sin((20*l-11.125)*t)/2+1},Q.BounceOut=l=>l<1/2.75?7.5625*l*l:l<2/2.75?7.5625*(l-=1.5/2.75)*l+.75:l<2.5/2.75?7.5625*(l-=2.25/2.75)*l+.9375:7.5625*(l-=2.625/2.75)*l+.984375,Q.BounceIn=l=>1-Q.BounceOut(1-l),Q.BounceInOut=l=>l<.5?.5*(1-Q.BounceOut(1-2*l)):.5*(Q.BounceOut(2*l-1)+1);let Kh=Q;const Jh=["viewchange","moveend","flystart","flyend","flystop"],uo=Kh.CubicInOut,_o=class fo{constructor(t={}){if(this.__id=fo.__counter__++,this.events=le(Jh,this),this._isOrthographic=t.isOrthographic??!1,this._focusDistance=t.focusDistance!=null?t.focusDistance:10,this._width=t.width||1,this._height=t.height||1,this.eye=t.eye||new v,this.eyeHigh=new Float32Array(3),this.eyeLow=new Float32Array(3),this._viewAngle=t.viewAngle||47,this._horizontalViewAngle=0,this._viewMatrix=new ee,this._viewMatrixRTE=new ee,this._normalMatrix=new At,this._r=new v(1,0,0),this._u=new v(0,1,0),this._b=new v(0,0,1),this._f=this._b.negateTo(),this._pr=this._r.clone(),this._pu=this._u.clone(),this._pb=this._b.clone(),this._peye=this.eye.clone(),this.isMoving=!1,this._flight=null,this._completeCallback=null,this._frameCallback=null,this._flying=!1,this._tanViewAngle_hrad=0,this._tanViewAngle_hradOneByHeight=0,this.frustums=[],this.frustumColors=[],t.frustums)for(let i=0,s=t.frustums.length;i<s;i++){let r=t.frustums[i],n=new sn({fov:this._viewAngle,aspect:this.getAspectRatio(),near:r[0],far:r[1]});n.cameraFrustumIndex=this.frustums.length,this.frustums.push(n),this.frustumColors.push(n._pickingColorU[0],n._pickingColorU[1],n._pickingColorU[2])}else{let i=1,s=500,r=new sn({fov:this._viewAngle,aspect:this.getAspectRatio(),near:i,far:s});r.cameraFrustumIndex=this.frustums.length,this.frustums.push(r),this.frustumColors.push(r._pickingColorU[0],r._pickingColorU[1],r._pickingColorU[2])}this.FARTHEST_FRUSTUM_INDEX=this.frustums.length-1,this.currentFrustumIndex=0,this.frustumColorIndex=0,this.isFirstPass=!1,this._projSizeConst=0,this.set(t.eye||new v(0,0,1),t.look||new v,t.up||new v(0,1,0))}get isOrthographic(){return this._isOrthographic}set isOrthographic(t){this._isOrthographic!==t&&(this._isOrthographic=t,this.refresh())}get focusDistance(){return this._focusDistance}set focusDistance(t){t!==this._focusDistance&&(this._focusDistance=t,this._isOrthographic&&this.refresh())}get id(){return this.__id}flyCartesian(t,i={}){this.stopFlying(),i.look=i.look||v.ZERO,i.up=i.up||v.UP,i.duration=i.duration||800;const s=i.ease||uo;this._completeCallback=i.completeCallback||(()=>{}),this._frameCallback=i.frameCallback||(()=>{}),i.startCallback&&i.startCallback.call(this);let r=this.eye.clone(),n=this._u,a=this._b,o=i.up,h=t.clone(),c=v.sub(t,i.look),d=o.cross(c);c.normalize(),d.normalize();let u=c.cross(d);this._flight={fly:_=>{let p=1-s(_),f=r.smerp(h,p),m=n.smerp(u,p),g=v.add(f,a.smerp(c,p).negateTo()),y=new v(f.x-g.x,f.y-g.y,f.z-g.z),x=m.cross(y);y.normalize(),x.normalize();let b=y.cross(x);return{eye:f,n:y,u:x,v:b}},duration:i.duration,startedAt:Date.now()},this._flying=!0,this.events.dispatch(this.events.flystart,this)}stopFlying(){this._flying&&(this._flying=!1,this._flight=null,this._frameCallback=null,this.events.dispatch(this.events.flystop,this))}checkFly(){if(this._flying&&this._flight!==null){let t=Math.min((Date.now()-this._flight.startedAt)/this._flight.duration,1);const i=this._flight.fly(t);this.eye=i.eye,this._r=i.u,this._u=i.v,this._b=i.n,this._f.set(-this._b.x,-this._b.y,-this._b.z),this._frameCallback&&this._frameCallback(),this.update(),t>=1&&(this.stopFlying(),this._completeCallback&&(this.events.dispatch(this.events.flyend,this),this._completeCallback(),this._completeCallback=null))}}isFlying(){return this._flying}checkMoveEnd(){let t=this._r,i=this._u,s=this._b,r=this.eye;this._peye.equal(r)&&this._pr.equal(t)&&this._pu.equal(i)&&this._pb.equal(s)?(this.isMoving&&this.events.dispatch(this.events.moveend,this),this.isMoving=!1):this.isMoving=!0,this._pr.copy(t),this._pu.copy(i),this._pb.copy(s),this._peye.copy(r)}bindFrustumsPickingColors(t){for(let i=0;i<this.frustums.length;i++)t.assignPickingColor(this.frustums[i])}_init(t){this._setProj(this._viewAngle,this.getAspectRatio()),this.set(t.eye||new v(0,0,1),t.look||new v,t.up||new v(0,1,0))}getUp(){return this._u.clone()}getDown(){return this._u.negateTo()}getRight(){return this._r.clone()}getLeft(){return this._r.negateTo()}getForward(){return this._f.clone()}getBackward(){return this._b.clone()}update(){let t=this._r,i=this._u,s=this._b,r=this.eye;v.doubleToTwoFloat32Array(r,this.eyeHigh,this.eyeLow),this._viewMatrix.set([t.x,i.x,s.x,0,t.y,i.y,s.y,0,t.z,i.z,s.z,0,-r.dot(t),-r.dot(i),-r.dot(s),1]),this._viewMatrixRTE.set([t.x,i.x,s.x,0,t.y,i.y,s.y,0,t.z,i.z,s.z,0,0,0,0,1]);for(let n=0,a=this.frustums.length;n<a;n++)this.frustums[n].setViewMatrix(this._viewMatrix),this.frustums[n].setProjectionViewRTEMatrix(this._viewMatrixRTE);this.events.dispatch(this.events.viewchange,this)}refresh(){this._setProj(this._viewAngle,this.getAspectRatio()),this.update()}get width(){return this._width}get height(){return this._height}setViewportSize(t,i){this._width=t,this._height=i,this.refresh()}getAspectRatio(){return this._width/this._height}_setProj(t,i){this._viewAngle=t;for(let n=0,a=this.frustums.length;n<a;n++){let o=this.frustums[n];o.setProjectionMatrix(t,i,o.near,o.far,this._isOrthographic,this._focusDistance)}var s,r;this._horizontalViewAngle=(s=t,r=i,js*Math.atan(Math.tan(Ye*s)*r)),this._updateViewportParameters()}_updateViewportParameters(){this._tanViewAngle_hrad=Math.tan(this._viewAngle*Ye),this._tanViewAngle_hradOneByHeight=this._tanViewAngle_hrad*(1/this._height),this._projSizeConst=Math.min(this._width<512?512:this._width,this._height<512?512:this._height)/(this._viewAngle*G)}setViewAngle(t){this._viewAngle=t,this.refresh()}getViewAngle(){return this._viewAngle}get viewAngle(){return this._viewAngle}get verticalViewAngle(){return this._viewAngle}get horizontalViewAngle(){return this._horizontalViewAngle}set(t,i,s){return this.eye.x=t.x,this.eye.y=t.y,this.eye.z=t.z,i=i||this._b,s=s||this._u,this._b.x=t.x-i.x,this._b.y=t.y-i.y,this._b.z=t.z-i.z,this._r.copy(s.cross(this._b)),this._b.normalize(),this._r.normalize(),this._u.copy(this._b.cross(this._r)),this._f.set(-this._b.x,-this._b.y,-this._b.z),this}look(t,i){this._b.set(this.eye.x-t.x,this.eye.y-t.y,this.eye.z-t.z),this._r.copy((i||this._u).cross(this._b)),this._b.normalize(),this._f.set(-this._b.x,-this._b.y,-this._b.z),this._r.normalize(),this._u.copy(this._b.cross(this._r))}slide(t,i,s){this.eye.x+=t*this._r.x+i*this._u.x+s*this._b.x,this.eye.y+=t*this._r.y+i*this._u.y+s*this._b.y,this.eye.z+=t*this._r.z+i*this._u.z+s*this._b.z}setRoll(t){let i=Math.cos(t),s=Math.sin(t),r=this._r.clone();this._r.set(i*r.x-s*this._u.x,i*r.y-s*this._u.y,i*r.z-s*this._u.z),this._u.set(s*r.x+i*this._u.x,s*r.y+i*this._u.y,s*r.z+i*this._u.z)}setPitch(t){let i=Math.cos(t),s=Math.sin(t),r=this._b;this._b.set(i*r.x-s*this._u.x,i*r.y-s*this._u.y,i*r.z-s*this._u.z),this._u.set(s*r.x+i*this._u.x,s*r.y+i*this._u.y,s*r.z+i*this._u.z)}setYaw(t){let i=Math.cos(t),s=Math.sin(t),r=this._r;this._r.set(i*r.x-s*this._b.x,i*r.y-s*this._b.y,i*r.z-s*this._b.z),this._b.set(s*r.x+i*this._b.x,s*r.y+i*this._b.y,s*r.z+i*this._b.z)}setPitchYawRoll(t,i,s){let r=new F;r.setPitchYawRoll(t,i,s),this.setRotation(r)}getPitch(){return this.getRotation().getPitch()}getYaw(){return this.getRotation().getYaw()}getRoll(){return this.getRotation().getRoll()}getAbsolutePitch(){return this.getRotation().getPitch()}getAbsoluteYaw(){return this.getRotation().getYaw()}getAbsoluteRoll(){return this.getRotation().getRoll()}getRotation(){return F.getLookRotation(this._f,this._u).conjugate()}setRotation(t,i,s,r){t.mulVec3Res(i||new v(0,1,0),this._u),t.mulVec3Res(s||new v(1,0,0),this._r),t.mulVec3Res(r||new v(0,0,1),this._b),this._f.set(-this._b.x,-this._b.y,-this._b.z)}rotate(t){t.mulVec3Res(this._u,this._u),t.mulVec3Res(this._r,this._r),t.mulVec3Res(this._b,this._b),this._f.set(-this._b.x,-this._b.y,-this._b.z)}unproject2v(t,i,s){return this.unproject(t.x,t.y,i,s)}unproject(t,i,s,r){let n=.5*this._width,a=.5*this._height,o=(t-n)/n,h=-(i-a)/a,c=this.frustums[0];if(this.isOrthographic){if(s){let d=.5*(c.right-c.left)*o,u=.5*(c.top-c.bottom)*h,_=this.getUp().scale(u),p=this.getRight().scale(d),f=_.addA(p),m=this.eye.add(f),g=this.getForward(),y=m.addA(g.scaleTo(s));return r&&r.copy(y),y.sub(this.eye).normalize()}return this.getForward()}{let d=c.inverseProjectionViewMatrix,u=d.mulVec4(new te(o,h,-1,1)).affinity();return d.mulVec4(new te(o,h,0,1)).affinity().subA(u).toVec3().normalize()}}project3v(t){return this.project(t.x,t.y,t.z)}project(t,i,s){let r=this.frustums[0].projectionViewMatrix.mulVec4(new te(t,i,s,1));return new H((1+r.x/r.w)*this._width*.5,(1-r.y/r.w)*this._height*.5)}rotateAround(t,i=!1,s=v.ZERO,r=v.UP){r=i?this._u:r;let n=ee.getRotation(t,r),a=ee.getRotationAroundPoint(t,s,r);this.eye=a.mulVec3(this.eye),this._u=n.mulVec3(this._u).normalize(),this._r=n.mulVec3(this._r).normalize(),this._b=n.mulVec3(this._b).normalize(),this._f.set(-this._b.x,-this._b.y,-this._b.z)}rotateHorizontal(t,i,s,r){this.rotateAround(t,i,s,r)}rotateVertical(t,i){this.rotateAround(t,!1,i,this._r)}projectedSize(t,i){if(this.isOrthographic){const s=this.frustums[0].projectionMatrix._m;return i*(this._height*s[5]*.5)}return Math.atan(i/this.eye.distance(t))*this._projSizeConst}getViewMatrix(){return this._viewMatrix._m}getNormalMatrix(){return this._normalMatrix._m}setCurrentFrustum(t){this.currentFrustumIndex=t,this.frustumColorIndex=10*(t+1)/255,this.isFirstPass=t===this.FARTHEST_FRUSTUM_INDEX}getCurrentFrustum(){return this.currentFrustumIndex}containsSphere(t){for(let i=0;i<this.frustums.length;i++)if(this.frustums[i].containsSphere(t))return!0;return!1}get frustum(){return this.frustums[this.currentFrustumIndex]}getProjectionMatrix(){return this.frustum.projectionMatrix._m}getProjectionViewMatrix(){return this.frustum.projectionViewMatrix._m}getProjectionViewRTEMatrix(){return this.frustum.projectionViewRTEMatrix._m}getInverseProjectionViewMatrix(){return this.frustum.inverseProjectionViewMatrix._m}getInverseProjectionMatrix(){return this.frustum.inverseProjectionMatrix._m}viewDistance(t,i=1e4){let s=t.add(this.getBackward().scaleTo(i));this.set(s,t),this.update()}copy(t){this.eye.copy(t.eye),this._r.copy(t._r),this._u.copy(t._u),this._b.copy(t._b),this._f.copy(t._f),this._width=t.width,this._height=t.height,this.setViewAngle(t.viewAngle),this.update()}getAltitude(){return this.eye.y}};_o.__counter__=0;let cr=_o;class go extends cr{constructor(t,i={}){super({...i,frustums:i.frustums||[[1,100.075],[100,1000.075],[1e3,101e4],[1e6,1e9]]}),this.planet=t,this.minAltitude=i.minAltitude||1,this.maxAltitude=i.maxAltitude||2e7,this._lonLat=this.planet.ellipsoid.cartesianToLonLat(this.eye),this._lonLatMerc=this._lonLat.forwardMercator(),this._terrainAltitude=this._lonLat.height,this._terrainPoint=new v,this._insideSegment=null,this.slope=0,this._keyLock=new bi,this._flight=null,this._completeCallback=null,this._frameCallback=null,this._flying=!1,this._checkTerrainCollision=!0,this.eyeNorm=this.eye.getNormal()}setTerrainCollisionActivity(t){this._checkTerrainCollision=t}update(){this.events.stopPropagation();let t=this.maxAltitude+this.planet.ellipsoid.getEquatorialSize();this.eye.length()>t&&this.eye.copy(this.eye.getNormal().scale(t)),super.update(),this.updateGeodeticPosition(),this.eyeNorm=this.eye.getNormal(),this.slope=this._b.dot(this.eyeNorm),this.events.dispatch(this.events.viewchange,this)}updateGeodeticPosition(){this.planet.ellipsoid.cartesianToLonLatRes(this.eye,this._lonLat),Math.abs(this._lonLat.lat)<=ce&&L.forwardMercatorRes(this._lonLat,this._lonLatMerc)}setAltitude(t){let i=this._terrainPoint,s=this.planet.ellipsoid.getSurfaceNormal3v(this.eye);this.eye.x=s.x*t+i.x,this.eye.y=s.y*t+i.y,this.eye.z=s.z*t+i.z,this._terrainAltitude=t}getAltitude(){return this._terrainAltitude}setLonLat(t,i,s){this.stopFlying(),this._lonLat.set(t.lon,t.lat,t.height||this._lonLat.height);let r=this.planet.ellipsoid,n=r.lonLatToCartesian(this._lonLat),a=i?r.lonLatToCartesian(i):v.ZERO;this.set(n,a,s||n.getNormal()),this.update()}getLonLat(){return this._lonLat}getHeight(){return this._lonLat.height}getExtentPosition(t,i){i=i||0;let s=t.getNorth(),r=t.getSouth(),n=t.getEast(),a=t.getWest();a>n&&(n+=360);let o=this.planet.ellipsoid,h=new L(n,s),c=o.lonLatToCartesian(h);h.lat=r;let d=o.lonLatToCartesian(h);h.lon=a;let u=o.lonLatToCartesian(h);h.lat=s;let _=o.lonLatToCartesian(h),p=v.sub(c,u).scale(.5).addA(u),f=p.length();f<1e-6&&(h.lon=.5*(n+a),h.lat=.5*(s+r),p=o.lonLatToCartesian(h)),_.subA(p),d.subA(p),c.subA(p),u.subA(p);let m=p.getNormal(),g=m.cross(v.NORTH).normalize(),y=g.cross(m).normalize(),x=Math.max(Math.abs(y.dot(_)),Math.abs(y.dot(d)),Math.abs(y.dot(c)),Math.abs(y.dot(u))),b=Math.max(Math.abs(g.dot(_)),Math.abs(g.dot(d)),Math.abs(g.dot(c)),Math.abs(g.dot(u))),T=Math.tan(this._viewAngle*G*.5),w=this.getAspectRatio()*T,A=Math.max(b/w,x/T);return p.normalize(),p.scale(f+A+i),p}viewExtent(t,i){this.stopFlying(),this.set(this.getExtentPosition(t,i),v.ZERO,v.NORTH),this.update()}flyExtent(t,i,s={}){s.look=v.ZERO,this.flyCartesian(this.getExtentPosition(t,i),s)}viewDistance(t,i=1e4){let s=this.eye.add(this.getForward().scaleTo(i)),r=F.getRotationBetweenVectors(s.getNormal(),t.getNormal());if(r.isZero()){let n=t.add(this.getBackward().scaleTo(i));this.set(n,t)}else{let n=t.add(r.mulVec3(this.getBackward()).scale(i)),a=r.mulVec3(this.getUp());this.set(n,t,a)}this.update()}flyLonLat(t,i={}){let s=new L(t.lon,t.lat,t.height||this._lonLat.height);this.flyCartesian(this.planet.ellipsoid.lonLatToCartesian(s),i)}flyDistance(t,i=1e4,s={}){let r=this.eye.add(this.getForward().scaleTo(i)),n=F.getRotationBetweenVectors(r.getNormal(),t.getNormal());if(n.isZero()){let a=t.add(this.getBackward().scaleTo(i));this.set(a,t)}else{let a=t.add(n.mulVec3(this.getBackward()).scale(i)),o=n.mulVec3(this.getUp());s.look=t,s.up=o,this.flyCartesian(a,s)}}flyCartesian(t,i={}){this.stopFlying(),i.preventLock||(this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet.normalMapCreator.lock(this._keyLock)),i.amplitude=i.amplitude!=null?i.amplitude:1,i.look=i.look||v.ZERO,i.up=i.up||v.NORTH,i.duration=i.duration||800;const s=i.ease||uo;this._completeCallback=i.completeCallback||(()=>{}),this._frameCallback=i.frameCallback||(()=>{}),i.startCallback&&i.startCallback.call(this),i.look instanceof L&&(i.look=this.planet.ellipsoid.lonLatToCartesian(i.look));let r=this.eye.clone(),n=this._u,a=this._b,o=this.planet.ellipsoid.cartesianToLonLat(t),h=i.up,c=this.planet.ellipsoid.lonLatToCartesian(new L(o.lon,o.lat,0)),d=v.sub(t,i.look),u=h.cross(d);d.normalize(),u.normalize();let _=d.cross(u),p=r.getNormal(),f=c.getNormal(),m=1-p.dot(f),g=i.amplitude*yn*Math.sqrt(m>0?m:0),y=6639613,x=Math.max(this._lonLat.height,o.height);x>y&&(y=x);let b=x+2.5*g*(y-x),T=v.ZERO;this._flight={fly:w=>{let A,E=s(w),C=1-E;if(E>=1)A=t.clone();else{let R=r.smerp(t,C).normalize(),z=this.planet.getRayIntersectionEllipsoid(new V(T,R)),D=this._lonLat.height*C*C*C+3*b*C*C*E+3*b*C*E*E+o.height*E*E*E;A=z.addA(R.scale(D))}let M=n.smerp(_,C),P=v.add(A,a.smerp(d,C).negateTo()),B=new v(A.x-P.x,A.y-P.y,A.z-P.z),k=M.cross(B);B.normalize(),k.normalize();let O=B.cross(k);return{eye:A,n:B,u:k,v:O}},duration:i.duration,startedAt:Date.now()},this._flying=!0,this.events.dispatch(this.events.flystart,this)}stopFlying(){this._flying&&(this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet.normalMapCreator.free(this._keyLock),super.stopFlying())}rotateLeft(t,i){this.rotateHorizontal(t,i!==!0,v.ZERO),this.update()}rotateRight(t,i){this.rotateHorizontal(-t,i!==!0,v.ZERO),this.update()}rotateUp(t){this.rotateVertical(t,v.ZERO),this.update()}rotateDown(t){this.rotateVertical(-t,v.ZERO),this.update()}rotateVertical(t,i,s=0){let r=new ee().setRotation(this._r,t),n=new ee().setIdentity().translate(i),a=new ee().setIdentity().translate(i.negateTo()),o=n.mul(r).mul(a).mulVec3(this.eye),h=r.mulVec3(this._u).normalize(),c=r.mulVec3(this._r).normalize(),d=r.mulVec3(this._b).normalize(),u=o.getNormal(),_=d.dot(u);if(!(h.dot(u)<=0))if(s){let p=_-this.slope;if(_<s&&p<0)return;(_>.1&&h.dot(u)>0||this.slope<=.1||this._u.dot(this.eye.getNormal())<=0)&&(this.eye=o,this._u=h,this._r=c,this._b=d,this._f.set(-d.x,-d.y,-d.z))}else this.eye=o,this._u=h,this._r=c,this._b=d,this._f.set(-d.x,-d.y,-d.z)}checkTerrainCollision(){if(this._terrainAltitude=this._lonLat.height,this._insideSegment&&this._insideSegment.planet)return this._terrainAltitude=this._insideSegment.getTerrainPoint(this.eye,this._insideSegment.getInsideLonLat(this),this._terrainPoint),this._terrainAltitude<this.minAltitude&&this._checkTerrainCollision&&this.setAltitude(this.minAltitude),this._terrainPoint}getSurfaceVisibleDistance(t){let i=this.planet.ellipsoid.equatorialSize;return i*Math.acos(i/(i+this._lonLat.height+t))}getHeading(){let t=this.eye.getNormal(),i=v.proj_b_to_plane(this.slope>=.97?this.getUp():this.getForward(),t).normalize(),s=v.proj_b_to_plane(v.NORTH,t).normalize(),r=Math.sign(t.dot(i.cross(s)))*Math.acos(i.dot(s))*J;return r<0?360+r:r}isVisible(t){let i=this.eye.length();return this.eye.distance(t)<Math.sqrt(i*i-this.planet.ellipsoid.equatorialSizeSqr)}getPitch(){return this.planet.getFrameRotation(this.eye).conjugate().inverse().mul(this.getRotation()).getPitch()}getYaw(){return this.planet.getFrameRotation(this.eye).conjugate().inverse().mul(this.getRotation()).getYaw()}getRoll(){return this.planet.getFrameRotation(this.eye).conjugate().inverse().mul(this.getRotation()).getRoll()}setPitch(t){let i=this.planet.getFrameRotation(this.eye),s=new F;s.setPitchYawRoll(t,this.getYaw(),this.getRoll(),i),this.setRotation(s)}setYaw(t){let i=this.planet.getFrameRotation(this.eye),s=new F;s.setPitchYawRoll(this.getPitch(),t,this.getRoll(),i),this.setRotation(s)}setRoll(t){let i=this.planet.getFrameRotation(this.eye),s=new F;s.setPitchYawRoll(this.getPitch(),this.getYaw(),t,i),this.setRotation(s)}setPitchYawRoll(t,i,s){let r=this.planet.getFrameRotation(this.eye),n=new F;n.setPitchYawRoll(t,i,s,r).conjugate(),this.setRotation(n)}}const po=class mo{constructor(t,i={}){this.handler=t,this.__id=mo.__counter__++,this._fbo=null,this._width=i.width||t.canvas.width,this._height=i.height||t.canvas.height,this._depthComponent=i.depthComponent!=null?i.depthComponent:"DEPTH_COMPONENT16",this._useDepth=i.useDepth==null||i.useDepth,this._active=!1,this._size=i.size||1,this._depthRenderbuffer=null,this._filter=i.filter||"NEAREST"}get width(){return this._width}get height(){return this._height}setSize(t,i,s=!1){this._width=t,this._height=i,this._active&&this.handler.gl.viewport(0,0,this._width,this._height),(this._useDepth||s)&&(this.destroy(),this.init())}init(){}destroy(){}isComplete(){let t=this.handler.gl;return t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE}checkStatus(){let t=this.handler.gl;return t.checkFramebufferStatus(t.FRAMEBUFFER)}activate(){let t=this.handler.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),t.viewport(0,0,this._width,this._height),this._active=!0;let i=this.handler.framebufferStack.current().data;return i&&(i._active=!1),this.handler.framebufferStack.push(this),this}deactivate(){let t=this.handler,i=t.gl;i.bindFramebuffer(i.FRAMEBUFFER,null),this._active=!1;let s=this.handler.framebufferStack.popPrev();s?(i.bindFramebuffer(i.FRAMEBUFFER,s._fbo),i.viewport(0,0,s._width,s._height)):i.viewport(0,0,t.canvas.width,t.canvas.height)}isEqual(t){return!!t&&this.__id===t.__id}};po.__counter__=0;let vo=po;class ci{constructor(t=256,i=256){this._canvas=document.createElement("canvas"),this._canvas.width=t,this._canvas.height=i,this._context=this._canvas.getContext("2d",{willReadFrequently:!0})}getCanvas(){return this._canvas}getContext(){return this._context}fillEmpty(){let t=this._context.getImageData(0,0,this._canvas.width,this._canvas.height),i=t.data;for(let s=0,r=i.length;s<r;s+=4)i[s]=i[s+1]=i[s+2]=i[s+3]=0;this._context.putImageData(t,0,0)}fill(t){this._context.fillStyle=t,this._context.fill()}getData(){return this._context.getImageData(0,0,this._canvas.width,this._canvas.height).data}fillColor(t){this._context.fillStyle=t,this._context.fillRect(0,0,this._canvas.width,this._canvas.height)}setData(t){let i=this._context.createImageData(this._canvas.width,this._canvas.height);i.data.set(t),this._context.putImageData(i,0,0)}resize(t,i){this._canvas.width=t,this._canvas.height=i,this._context=this._canvas.getContext("2d")}drawImage(t,i,s,r,n){this._context.drawImage(t,i||0,s||0,r||t.width,n||t.height)}getImage(){let t=new Image;return t.width=this.getWidth(),t.height=this.getHeight(),t.src=this._canvas.toDataURL("image/png"),t}getTextWidth(t){let i=this._context.measureText(t);return Math.round(i.width)}drawText(t,i=0,s=14,r="normal 14px Verdana",n="black"){this._context.fillStyle=n,this._context.font=r,this._context.fillText(t,i,s)}getWidth(){return this._canvas.width}getHeight(){return this._canvas.height}load(t,i){let s=new Image,r=this;s.onload=function(){r.resize(s.width,s.height),r._context.drawImage(s,0,0,s.width,s.height),i&&i(s)},s.src=t}openImage(){let t=this.getImage(),i="<!DOCTYPE html>";i+="<html>",i+="<head><title>Print</title></head>",i+="<body>",i+='<img src="'+t.src+'">',i+="</body>",i+="</html>";let s=window.open("","","width="+t.width+"px ,height="+t.height+"px");s&&(s.document.open(),s.document.write(i),s.document.close(),s.focus())}destroy(){this._canvas.width=1,this._canvas.height=1,this._canvas=null,this._context=null}}const rn={UNSIGNED_BYTE:Uint8Array,FLOAT:Float32Array};class Pe extends vo{constructor(t,i={}){super(t,i),this.readPixelBuffersAsync=s=>{const r=this.handler.gl;if(this._skipFrame)return;this._skipFrame=!0;let n=this.width,a=this.height,o=this.pixelBuffers;this.activate();for(let u=0;u<o.length;u++){let _=o[u];r.bindBuffer(r.PIXEL_PACK_BUFFER,_.buffer),r.bufferData(r.PIXEL_PACK_BUFFER,_.data.byteLength,r.STREAM_READ),r.readBuffer(_.glAttachment),r.readPixels(0,0,n,a,r.RGBA,_.glType,0),r.bindBuffer(r.PIXEL_PACK_BUFFER,null)}this.deactivate();const h=r.fenceSync(r.SYNC_GPU_COMMANDS_COMPLETE,0);var c,d;r.flush(),(c=r,d=h,new Promise(((u,_)=>{(function p(){const f=c.clientWaitSync(d,0,0);f==c.WAIT_FAILED?_():f==c.TIMEOUT_EXPIRED?requestAnimationFrame(p):u()})()}))).then((()=>{this._skipFrame=!1,r.deleteSync(h);for(let u=0;u<o.length;u++){let _=o[u];_.data&&(r.bindBuffer(r.PIXEL_PACK_BUFFER,_.buffer),r.getBufferSubData(r.PIXEL_PACK_BUFFER,0,_.data))}r.bindBuffer(r.PIXEL_PACK_BUFFER,null),s&&s(this)}))},this._targets=Pe.createTargets(i.targets),this._size=this._targets.length,this._renderbufferTarget=i.renderbufferTarget!=null?i.renderbufferTarget:"DEPTH_ATTACHMENT",this.textures=i.textures||new Array(this._size),this.pixelBuffers=[],this._skipFrame=!1}static createTargets(t){let i=0,s=0;return t?t.map((r=>{let n=r.attachment||"COLOR_ATTACHMENT";n==="COLOR_ATTACHMENT"&&(n="COLOR_ATTACHMENT"+i++);let a=r.type||"UNSIGNED_BYTE";return{internalFormat:r.internalFormat||"RGBA",format:r.format||"RGBA",type:a,attachment:n,filter:r.filter||"NEAREST",pixelBufferIndex:r.readAsync?s++:-1,TypeArrayConstructor:rn[a]}})):[{internalFormat:"RGBA",format:"RGBA",type:"UNSIGNED_BYTE",attachment:"COLOR_ATTACHMENT0",filter:"NEAREST",pixelBufferIndex:-1,TypeArrayConstructor:rn.UNSIGNED_BYTE}]}destroy(){let t=this.handler.gl;if(t){for(let i=0;i<this.textures.length;i++)t.deleteTexture(this.textures[i]);this.textures=new Array(this._size);for(let i=0;i<this.pixelBuffers.length;i++)this.pixelBuffers[i].data=null,t.deleteBuffer(this.pixelBuffers[i].buffer);this.pixelBuffers=[],t.deleteFramebuffer(this._fbo),t.deleteRenderbuffer(this._depthRenderbuffer),this._depthRenderbuffer=null,this._fbo=null,this._active=!1}}init(){let t=this.handler.gl;if(!t)return;this._fbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo);let i=[];for(let s=0;s<this._targets.length;s++){let r=this._targets[s],n=this.textures[s]||this.handler.createEmptyTexture2DExt(this._width,this._height,r.filter,r.internalFormat,r.format,r.type),a=t[r.attachment];n&&(this.bindOutputTexture(n,a),this.textures[s]=n),r.attachment!=="DEPTH_ATTACHMENT"&&i.push(a),r.pixelBufferIndex!==-1&&this._createPixelBuffer(r)}t.drawBuffers&&t.drawBuffers(i),this._useDepth&&(this._depthRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._depthRenderbuffer),t.renderbufferStorage(t.RENDERBUFFER,t[this._depthComponent],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t[this._renderbufferTarget],t.RENDERBUFFER,this._depthRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null)),t.bindFramebuffer(t.FRAMEBUFFER,null)}getPixelBufferData(t=0){let i=this._targets[t].pixelBufferIndex;return i!==-1?this.pixelBuffers[i].data:null}_createPixelBuffer(t){let i=this.handler.gl,s=t.pixelBufferIndex,r=this.pixelBuffers[s];r||(r=this.pixelBuffers[s]={buffer:null,data:null,glType:-1,glAttachment:-1});let n=this.width*this.height*4;r.data=null,r.data=new t.TypeArrayConstructor(n),r.buffer=i.createBuffer(),i.bindBuffer(i.PIXEL_PACK_BUFFER,r.buffer),i.bufferData(i.PIXEL_PACK_BUFFER,n,i.STREAM_READ),i.bindBuffer(i.PIXEL_PACK_BUFFER,null),r.glType=i[t.type],r.glAttachment=i[t.attachment]}bindOutputTexture(t,i){let s=this.handler.gl;s.bindTexture(s.TEXTURE_2D,t),s.framebufferTexture2D(s.FRAMEBUFFER,i||s.COLOR_ATTACHMENT0,s.TEXTURE_2D,t,0),s.bindTexture(s.TEXTURE_2D,null)}readPixels(t,i,s,r=0,n=1,a=1){let o=this.handler.gl;o.bindFramebuffer(o.FRAMEBUFFER,this._fbo),o.readBuffer&&o.readBuffer(o.COLOR_ATTACHMENT0+r||0),o.readPixels(i*this._width,s*this._height,n,a,o.RGBA,o[this._targets[r].type],t),o.bindFramebuffer(o.FRAMEBUFFER,null)}readAllPixels(t,i=0){let s=this.handler.gl;s.bindFramebuffer(s.FRAMEBUFFER,this._fbo),s.readBuffer&&s.readBuffer(s.COLOR_ATTACHMENT0+i),s.readPixels(0,0,this._width,this._height,s.RGBA,s[this._targets[i].type],t),s.bindFramebuffer(s.FRAMEBUFFER,null)}getImage(){let t=new Uint8Array(4*this._width*this._height);this.readAllPixels(t);let i=new ci(this._width,this._height);return i.setData(t),i.getImage()}readData(t,i,s,r=0){const n=this.width,a=this.height,o=Math.floor(t*(n-1)),h=4*(Math.floor(i*(a-1))*n+o),c=this.pixelBuffers[r].data;c&&(s[0]=c[h],s[1]=c[h+1],s[2]=c[h+2],s[3]=c[h+3])}}const ec=["tick","end","start","stop"],yo=class xo{constructor(t={}){this.__handler=null,this.active=!0,this.__id=xo.__counter__++,this.events=le(ec,this),this.name=t.name||"",this.startDate=t.startDate||0,this.endDate=t.endDate||0;let i=t.currentDate||Yi(new Date);t.startDate&&i<t.startDate&&(i=t.startDate),t.endDate&&i>t.endDate&&(i=t.endDate),this.currentDate=i,this._multiplier=t.multiplier!==void 0?t.multiplier:1,this._running=1,this.deltaTicks=0,this.active=!0,this._intervalDelay=0,this._intervalStart=0,this._intervalCallback=null}clearInterval(){this._intervalDelay=0,this._intervalStart=0,this._intervalCallback=null}setInterval(t,i){this._intervalStart=this.currentDate,this._intervalDelay=t*tr,this._intervalCallback=i}setDate(t){let i=Yi(t);this.startDate&&i<this.startDate&&(i=this.startDate),this.endDate&&i>this.endDate&&(i=this.endDate),this.currentDate=i}getDate(){return Bs(this.currentDate)}reset(){this.startDate&&(this.currentDate=this.startDate)}tick(t){let i=this._multiplier*this._running;if(this.deltaTicks=t*i,this.active){let s=Fn(this.currentDate,this.deltaTicks);i>0?this.endDate&&s>this.endDate?(this.currentDate=this.startDate,this.events.dispatch(this.events.end,this)):this.currentDate=s:this.startDate&&s<this.startDate?(this.currentDate=this.endDate,this.events.dispatch(this.events.end,this)):this.currentDate=s,this._intervalCallback&&this.currentDate-this._intervalStart>=this._intervalDelay&&(this._intervalStart=this.currentDate,this._intervalCallback(this)),this.events.dispatch(this.events.tick,this)}}isEqual(t){return this.__id===t.__id}start(){this._running===0&&(this._running=1,this.events.dispatch(this.events.start,this))}get multiplier(){return this._multiplier}set multiplier(t){this._multiplier=t}stop(){this._running===1&&(this._running=0,this.events.dispatch(this.events.stop,this))}};yo.__counter__=0;let tc=yo;class ic{constructor(t,i){i._programController=this,this._program=i,this._handler=t,this._activated=!1}initialize(){this._handler.gl&&this._program.createProgram(this._handler.gl)}getProgram(){return this._program}activate(){if(!this._activated){this._handler.activeProgram.deactivate(),this._handler.activeProgram=this;let t=this._program;this._activated=!0,t.enableAttribArrays(),t.use()}return this}remove(){let t=this._handler.programs;t[this._program.name]&&(this._activated&&this.deactivate(),this._program.delete(),delete t[this._program.name])}deactivate(){this._program.disableAttribArrays(),this._activated=!1}isActive(){return this._activated}set(t){return this.activate(),this._program.set(t),this}drawIndexBuffer(t,i){return this._program.drawIndexBuffer(t,i),this}drawArrays(t,i){return this._program.drawArrays(t,i),this}}let nn=class{constructor(){this.next=null,this.prev=null,this.data=null}};class fs{constructor(t=256){this._current=new nn,this._head=this._current;for(let i=0;i<t;i++){let s=new nn;s.prev=this._current,this._current.next=s,this._current=s}this._current=this._head}current(){return this._current}push(t){this._current=this._current.next,this._current.data=t}pop(){let t=this._current.data;return this._current=this._current.prev,t}popPrev(){return this._current=this._current.prev,this._current.data}}const an=["","WEBKIT_","MOZ_"],gs=["webgl2","webgl"];class Lt{constructor(t,i={}){this.framebufferStack=new fs,this._requestAnimationFrameId=0,this.drawFrame=()=>{let s=window.performance.now(),r=this.deltaTime;this.deltaTime=.5*(s-this._lastAnimationFrameTime+this.prevDeltaTime),this.deltaTime>3?this.deltaTime=3:this.deltaTime<1&&(this.deltaTime=1),this.prevDeltaTime=r,this._lastAnimationFrameTime=s,this.defaultClock.tick(this.deltaTime);for(let a=0;a<this._clocks.length;a++)this._clocks[a].tick(this.deltaTime);let n=this.canvas;Math.floor(n.clientWidth*this._params.pixelRatio)===n.width&&Math.floor(n.clientHeight*this._params.pixelRatio)===n.height||(n.clientWidth===0||n.clientHeight===0?this.stop():document.hidden||(this.start(),this.setSize(n.clientWidth,n.clientHeight))),this._frameCallback()},this.events=le(["visibilitychange","resize"]),this._throttledDrawFrame=this.drawFrame,this.defaultClock=new tc,this._clocks=[],this.prevDeltaTime=0,this.deltaTime=0,this.canvas=null,this.gl=null,this.programs={},this.activeProgram=null,this._canvasSize=[0,0],this._params={anisotropy:i.anisotropy||4,width:i.width||256,height:i.height||256,pixelRatio:zn("og_dpi")||i.pixelRatio||1,extensions:i.extensions||[],context:i.context||{}},this.extensions={},this._canvasTarget=t,this._lastAnimationFrameTime=0,this._initialized=!1,this._frameCallback=function(){},this.transparentTexture=null,this.defaultTexture=null,this.framebufferStack=new fs,this.createTexture_n=this.createTexture_n_webgl2.bind(this),this.createTexture_l=this.createTexture_l_webgl2.bind(this),this.createTexture_mm=this.createTexture_mm_webgl2.bind(this),this.createTexture_a=this.createTexture_a_webgl2.bind(this),this.createTexture={NEAREST:this.createTexture_n,LINEAR:this.createTexture_l,MIPMAP:this.createTexture_mm,ANISOTROPIC:this.createTexture_a},this.createTextureDefault=this.createTexture_n,this.ONCANVASRESIZE=null,this._createCanvas(),(i.autoActivate||Fe(i.autoActivate))&&this.initialize()}set frameDelay(t){this._throttledDrawFrame=t===0?this.drawFrame:di(this.drawFrame,t)}isInitialized(){return this._initialized}_createCanvas(){this._canvasTarget?this._canvasTarget instanceof HTMLElement?this.canvas=this._canvasTarget:this.canvas=document.getElementById(this._canvasTarget)||document.querySelector(this._canvasTarget):(this.canvas=document.createElement("canvas"),this.canvas.width=this._params.width,this.canvas.height=this._params.height)}static getExtension(t,i){if(!t)return;let s,r;for(s in an)if(r=t.getExtension(an[s]+i),r)return r}static getContext(t,i){let s=null;try{let r=new URLSearchParams(location.search).get("og_ver");if(r)s=t.getContext(r,i),s&&(s.type=r);else for(let n=0;n<gs.length;n++)if(s=t.getContext(gs[n],i),s){s.type=gs[n];break}}catch{Qe.logErr("exception during the GL context initialization")}return s||Qe.logErr("could not initialise WebGL"),s}setFrameCallback(t){t&&(this._frameCallback=t)}createEmptyTexture2DExt(t=1,i=1,s="NEAREST",r="RGBA",n="RGBA",a="UNSIGNED_BYTE",o="CLAMP_TO_EDGE",h=0){let c=this.gl,d=c.createTexture();return c.bindTexture(c.TEXTURE_2D,d),c.texImage2D(c.TEXTURE_2D,h,c[r.toUpperCase()],t,i,0,c[n.toUpperCase()],c[a.toUpperCase()],null),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c[s.toUpperCase()]),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c[s.toUpperCase()]),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c[o.toUpperCase()]),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c[o.toUpperCase()]),c.bindTexture(c.TEXTURE_2D,null),d}createEmptyTexture_n(t,i,s,r){let n=this.gl,a=n.createTexture();return n.bindTexture(n.TEXTURE_2D,a),n.texImage2D(n.TEXTURE_2D,0,s||n.RGBA,t,i,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,r||n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,r||n.CLAMP_TO_EDGE),n.bindTexture(n.TEXTURE_2D,null),a}createEmptyTexture_l(t,i,s,r){let n=this.gl,a=n.createTexture();return n.bindTexture(n.TEXTURE_2D,a),n.texImage2D(n.TEXTURE_2D,0,s||n.RGBA,t,i,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,r||n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,r||n.CLAMP_TO_EDGE),n.bindTexture(n.TEXTURE_2D,null),a}createTexture_n_webgl1(t,i,s,r=null){let n=this.gl;return r=r||n.createTexture(),n.bindTexture(n.TEXTURE_2D,r),n.texImage2D(n.TEXTURE_2D,0,i||n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,s||n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,s||n.CLAMP_TO_EDGE),n.bindTexture(n.TEXTURE_2D,null),r}createTexture_l_webgl1(t,i,s,r=null){let n=this.gl;return r=r||n.createTexture(),n.bindTexture(n.TEXTURE_2D,r),n.texImage2D(n.TEXTURE_2D,0,i||n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,s||n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,s||n.CLAMP_TO_EDGE),n.bindTexture(n.TEXTURE_2D,null),r}createTexture_mm_webgl1(t,i,s,r=null){let n=this.gl;return r=r||n.createTexture(),n.bindTexture(n.TEXTURE_2D,r),n.texImage2D(n.TEXTURE_2D,0,i||n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),n.generateMipmap(n.TEXTURE_2D),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,s||n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,s||n.CLAMP_TO_EDGE),n.bindTexture(n.TEXTURE_2D,null),r}createTexture_a_webgl1(t,i,s,r=null){let n=this.gl;return r=r||n.createTexture(),n.bindTexture(n.TEXTURE_2D,r),n.texImage2D(n.TEXTURE_2D,0,i||n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),n.generateMipmap(n.TEXTURE_2D),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_LINEAR),n.texParameterf(n.TEXTURE_2D,this.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._params.anisotropy),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,s||n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,s||n.CLAMP_TO_EDGE),n.bindTexture(n.TEXTURE_2D,null),r}createTexture_n_webgl2(t,i,s,r=null){let n=this.gl;return r=r||n.createTexture(),n.bindTexture(n.TEXTURE_2D,r),n.texStorage2D(n.TEXTURE_2D,1,i||n.RGBA8,t.width,t.height),n.texSubImage2D(n.TEXTURE_2D,0,0,0,t.width,t.height,n.RGBA,n.UNSIGNED_BYTE,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,s||n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,s||n.CLAMP_TO_EDGE),n.bindTexture(n.TEXTURE_2D,null),r}createTexture_l_webgl2(t,i,s,r=null){let n=this.gl;return r=r||n.createTexture(),n.bindTexture(n.TEXTURE_2D,r),n.texStorage2D(n.TEXTURE_2D,1,i||n.RGBA8,t.width,t.height),n.texSubImage2D(n.TEXTURE_2D,0,0,0,t.width,t.height,n.RGBA,n.UNSIGNED_BYTE,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,s||n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,s||n.CLAMP_TO_EDGE),n.bindTexture(n.TEXTURE_2D,null),r}createTexture_mm_webgl2(t,i,s,r=null){let n=this.gl;return r=r||n.createTexture(),n.bindTexture(n.TEXTURE_2D,r),n.texStorage2D(n.TEXTURE_2D,2,i||n.RGBA8,t.width,t.height),n.texSubImage2D(n.TEXTURE_2D,0,0,0,t.width,t.height,n.RGBA,n.UNSIGNED_BYTE,t),n.generateMipmap(n.TEXTURE_2D),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,s||n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,s||n.CLAMP_TO_EDGE),n.bindTexture(n.TEXTURE_2D,null),r}createTexture_a_webgl2(t,i,s,r=null){let n=this.gl;return r=r||n.createTexture(),n.bindTexture(n.TEXTURE_2D,r),n.texStorage2D(n.TEXTURE_2D,2,i||n.RGBA8,t.width,t.height),n.texSubImage2D(n.TEXTURE_2D,0,0,0,t.width,t.height,n.RGBA,n.UNSIGNED_BYTE,t),n.generateMipmap(n.TEXTURE_2D),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_LINEAR),n.texParameterf(n.TEXTURE_2D,this.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._params.anisotropy),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,s||n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,s||n.CLAMP_TO_EDGE),n.bindTexture(n.TEXTURE_2D,null),r}loadCubeMapTexture(t){let i=this.gl,s=i.createTexture();i.bindTexture(i.TEXTURE_CUBE_MAP,s),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR);let r=[[t.px,i.TEXTURE_CUBE_MAP_POSITIVE_X],[t.nx,i.TEXTURE_CUBE_MAP_NEGATIVE_X],[t.py,i.TEXTURE_CUBE_MAP_POSITIVE_Y],[t.ny,i.TEXTURE_CUBE_MAP_NEGATIVE_Y],[t.pz,i.TEXTURE_CUBE_MAP_POSITIVE_Z],[t.nz,i.TEXTURE_CUBE_MAP_NEGATIVE_Z]],n=new ci;n.fillEmpty();let a=n.getImage();for(let o=0;o<r.length;o++){let h=r[o][1];i.bindTexture(i.TEXTURE_CUBE_MAP,s),i.texImage2D(h,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,a)}for(let o=0;o<r.length;o++){let h=r[o][1],c=new Image;c.crossOrigin="",c.onload=(function(d,u,_){return function(){i&&d&&(i.bindTexture(i.TEXTURE_CUBE_MAP,d),i.texImage2D(u,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,_))}})(s,h,c),c.src=r[o][0]}return s}addProgram(t,i=!1){if(this.programs[t.name])console.warn(`Shader program: "${t.name}" already exists.`);else{let s=new ic(this,t);this.programs[t.name]=s,this._initProgramController(s),i||(s._activated=!1)}return t}removeProgram(t){this.programs[t]&&this.programs[t].remove()}addPrograms(t){for(let i=0;i<t.length;i++)this.addProgram(t[i])}_initProgramController(t){this._initialized&&(t.initialize(),this.activeProgram?(t.deactivate(),this.activeProgram._program.enableAttribArrays(),this.activeProgram._program.use()):(this.activeProgram=t,t.activate()))}_initPrograms(){for(let t in this.programs)this._initProgramController(this.programs[t])}initializeExtension(t,i=!1){if(!this.extensions||!this.extensions[t]){let s=Lt.getExtension(this.gl,t);s?this.extensions[t]=s:i&&console.warn("og.webgl.Handler: extension '"+t+"' doesn't initialize.")}return this.extensions&&this.extensions[t]}initialize(){if(this._initialized||!this.canvas||(this.gl=Lt.getContext(this.canvas,this._params.context),!this.gl))return;this._initialized=!0,this._params.extensions.push("EXT_texture_filter_anisotropic"),this.gl.type==="webgl"?(this._params.extensions.push("OES_standard_derivatives"),this._params.extensions.push("OES_element_index_uint"),this._params.extensions.push("WEBGL_depth_texture"),this._params.extensions.push("ANGLE_instanced_arrays")):(this._params.extensions.push("EXT_color_buffer_float"),this._params.extensions.push("OES_texture_float_linear"));let t=this._params.extensions.length;for(;t--;)this.initializeExtension(this._params.extensions[t],!0);this.gl.type==="webgl"?(this.createTexture_n=this.createTexture_n_webgl1.bind(this),this.createTexture_l=this.createTexture_l_webgl1.bind(this),this.createTexture_mm=this.createTexture_mm_webgl1.bind(this),this.createTexture_a=this.createTexture_a_webgl1.bind(this)):(this.createTexture_n=this.createTexture_n_webgl2.bind(this),this.createTexture_l=this.createTexture_l_webgl2.bind(this),this.createTexture_mm=this.createTexture_mm_webgl2.bind(this),this.createTexture_a=this.createTexture_a_webgl2.bind(this)),this.createTexture.NEAREST=this.createTexture_n,this.createTexture.LINEAR=this.createTexture_l,this.createTexture.MIPMAP=this.createTexture_mm,this.createTexture.ANISOTROPIC=this.createTexture_a,this.extensions.EXT_texture_filter_anisotropic?this.createTextureDefault=this.createTexture_a:this.createTextureDefault=this.createTexture_mm,this._initPrograms(),this._setDefaults(),this.intersectionObserver=new IntersectionObserver((i=>{this._toggleVisibilityChange(i[i.length-1].isIntersecting)}),{threshold:0}),this.intersectionObserver.observe(this.canvas),this.resizeObserver=new ResizeObserver((i=>{this._toggleVisibilityChange(i[0].contentRect.width!==0&&i[0].contentRect.height!==0)})),this.resizeObserver.observe(this.canvas),document.addEventListener("visibilitychange",(()=>{this._toggleVisibilityChange(document.visibilityState==="visible")}))}_toggleVisibilityChange(t){t?(this.start(),this.ONCANVASRESIZE&&this.ONCANVASRESIZE(),this.events.dispatch(this.events.visibilitychange,!0)):(this.events.dispatch(this.events.visibilitychange,!1),this.stop())}_setDefaults(){let t=this.gl;t&&this.canvas&&(t.depthFunc(t.LESS),t.enable(t.DEPTH_TEST),this.setSize(this.canvas.clientWidth||this._params.width,this.canvas.clientHeight||this._params.height),t.frontFace(t.CCW),t.cullFace(t.BACK),t.enable(t.CULL_FACE),t.disable(t.BLEND),this.createDefaultTexture({color:"rgba(0,0,0,0.0)"},(i=>{this.transparentTexture=i})),this.createDefaultTexture({color:"rgba(255, 255, 255, 1.0)"},(i=>{this.defaultTexture=i})))}getCanvasSize(){return this._canvasSize}createStreamArrayBuffer(t,i,s,r=4){let n=this.gl,a=n.createBuffer();return n.bindBuffer(n.ARRAY_BUFFER,a),n.bufferData(n.ARRAY_BUFFER,i*t*r,s||n.STREAM_DRAW),n.bindBuffer(n.ARRAY_BUFFER,null),a.itemSize=t,a.numItems=i,a}setStreamArrayBuffer(t,i,s=0){let r=this.gl;return r.bindBuffer(r.ARRAY_BUFFER,t),r.bufferSubData(r.ARRAY_BUFFER,s,i),r.bindBuffer(r.ARRAY_BUFFER,null),t}createArrayBuffer(t,i,s,r){let n=this.gl,a=n.createBuffer();return n.bindBuffer(n.ARRAY_BUFFER,a),n.bufferData(n.ARRAY_BUFFER,t,r||n.STATIC_DRAW),n.bindBuffer(n.ARRAY_BUFFER,null),a.itemSize=i,a.numItems=s||t.length/i,a}createArrayBufferLength(t,i){let s=this.gl,r=s.createBuffer();return s.bindBuffer(s.ARRAY_BUFFER,r),s.bufferData(s.ARRAY_BUFFER,t,i||s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,null),r.itemSize=1,r.numItems=t,r}createElementArrayBuffer(t,i,s,r){let n=this.gl,a=n.createBuffer();return n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,a),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t,r||n.STATIC_DRAW),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),a.itemSize=i,a.numItems=s||t.length,a}setSize(t,i){this._params.width=t,this._params.height=i,this.canvas&&(this.canvas.width=t*this._params.pixelRatio,this.canvas.height=i*this._params.pixelRatio,this._canvasSize[0]=this.canvas.width,this._canvasSize[1]=this.canvas.height,this.gl&&this.gl.viewport(0,0,t,i),this.ONCANVASRESIZE&&this.ONCANVASRESIZE(this.canvas),this.events.dispatch(this.events.resize,this))}get pixelRatio(){return this._params.pixelRatio}set pixelRatio(t){this._params.pixelRatio=t,this.setSize(this._params.width,this._params.height)}getWidth(){return this.canvas?this.canvas.width:0}getHeight(){return this.canvas?this.canvas.height:0}getClientAspect(){return this.canvas?this.canvas.clientWidth/this.canvas.clientHeight:0}getCenter(){let t=this.canvas;return t?new H(Math.round(.5*t.width),Math.round(.5*t.height)):new H}clearFrame(){let t=this.gl;t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}start(){!this._requestAnimationFrameId&&this._initialized&&this._animationFrameCallback()}stop(){this._requestAnimationFrameId&&(window.cancelAnimationFrame(this._requestAnimationFrameId),this._requestAnimationFrameId=0)}isStopped(){return!this._requestAnimationFrameId}isWebGl2(){return!!this.gl&&this.gl.type==="webgl2"}_animationFrameCallback(){this._requestAnimationFrameId=window.requestAnimationFrame((()=>{this._throttledDrawFrame(),this._requestAnimationFrameId&&this._animationFrameCallback()}))}createDefaultTexture(t,i){let s,r;if(t&&t.color)s=new ci(2,2),s.fillColor(t.color),r=this.createTexture_n(s.getCanvas()),r.default=!0,i(r);else if(t&&t.url){let n=new Image,a=this;n.onload=function(){r=a.createTextureDefault(n),r.default=!0,i(r)},n.src=t.url}else s=new ci(2,2),s.fillColor("#C5C5C5"),r=this.createTexture_n(s.getCanvas()),r.default=!0,i(r)}deleteTexture(t){t&&!t.default&&this.gl&&this.gl.deleteTexture(t)}destroy(){var t,i;(t=this.resizeObserver)==null||t.disconnect(),(i=this.intersectionObserver)==null||i.disconnect(),this.stop();for(let r in this.programs)this.removeProgram(r);let s=this.gl;if(s){s.deleteTexture(this.transparentTexture),this.transparentTexture=null,s.deleteTexture(this.defaultTexture),this.defaultTexture=null,this.framebufferStack=new fs;let r=s.getParameter(s.MAX_VERTEX_ATTRIBS),n=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,n);for(let o=0;o<r;++o)s.disableVertexAttribArray(o),s.vertexAttribPointer(o,4,s.FLOAT,!1,0,0),s.vertexAttrib1f(o,0);s.deleteBuffer(n);let a=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS);for(let o=0;o<a;++o)s.activeTexture(s.TEXTURE0+o),s.bindTexture(s.TEXTURE_CUBE_MAP,null),s.bindTexture(s.TEXTURE_2D,null);s.activeTexture(s.TEXTURE0),s.useProgram(null),s.bindBuffer(s.ARRAY_BUFFER,null),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),s.bindFramebuffer(s.FRAMEBUFFER,null),s.bindRenderbuffer(s.RENDERBUFFER,null),s.disable(s.BLEND),s.disable(s.CULL_FACE),s.disable(s.DEPTH_TEST),s.disable(s.DITHER),s.disable(s.SCISSOR_TEST),s.blendColor(0,0,0,0),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ONE,s.ZERO),s.clearColor(0,0,0,0),s.clearDepth(1),s.clearStencil(-1)}this.canvas&&(this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null),this.gl=null,this._initialized=!1}addClock(t){t.__handler||(t.__handler=this,this._clocks.push(t))}addClocks(t){for(let i=0;i<t.length;i++)this.addClock(t[i])}removeClock(t){if(t.__handler){let i=this._clocks,s=i.length;for(;s--;)if(i[s].isEqual(t)){t.__handler=null,i.splice(s,1);break}}}}class bo extends vo{constructor(t,i={}){super(t,i),this._internalFormat=i.internalFormat?i.internalFormat.toUpperCase():"RGBA8",this._msaa=i.msaa!=null?i.msaa:4,this._glFilter=0,this.renderbuffers=new Array(this._size)}destroy(){let t=this.handler.gl;if(t){for(let i=0;i<this.renderbuffers.length;i++)t.deleteRenderbuffer(this.renderbuffers[i]);this.renderbuffers=new Array(this._size),t.deleteFramebuffer(this._fbo),t.deleteRenderbuffer(this._depthRenderbuffer),this._depthRenderbuffer=null,this._fbo=null,this._active=!1}}init(){let t=this.handler.gl;if(!t)return;this._glFilter=t[this._filter],this._fbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo);let i=[];for(let s=0;s<this.renderbuffers.length;s++){let r=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,r),this._msaa>0?t.renderbufferStorageMultisample(t.RENDERBUFFER,this._msaa,t[this._internalFormat],this._width,this._height):t.renderbufferStorage(t.RENDERBUFFER,t[this._internalFormat],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+s,t.RENDERBUFFER,r),i.push(t.COLOR_ATTACHMENT0+s),this.renderbuffers[s]=r,t.bindRenderbuffer(t.RENDERBUFFER,null)}t.drawBuffers(i),this._useDepth&&(this._depthRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._depthRenderbuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._msaa,t[this._depthComponent],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this._depthRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null)),t.bindFramebuffer(t.FRAMEBUFFER,null)}blitTo(t,i=0){let s=this.handler.gl;s.bindFramebuffer(s.READ_FRAMEBUFFER,this._fbo),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,t._fbo),s.readBuffer(s.COLOR_ATTACHMENT0+i),s.clearBufferfv(s.COLOR,0,[0,0,0,1]),s.blitFramebuffer(0,0,this._width,this._height,0,0,t._width,t._height,s.COLOR_BUFFER_BIT,this._glFilter),s.bindFramebuffer(s.FRAMEBUFFER,null),s.bindFramebuffer(s.READ_FRAMEBUFFER,null),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,null)}}Object.freeze(Object.defineProperty({__proto__:null,Framebuffer:Pe,Handler:Lt,Multisample:bo,Program:X,types:he},Symbol.toStringTag,{value:"Module"}));class wo extends mi{constructor(t,i={}){super(t,i),this._image=i.image||null,this._src=i.src||null,this._onLoad_=null}get instanceName(){return"GeoImage"}abortLoading(){this._image instanceof HTMLImageElement&&(this._image.src="")}setSrc(t){this._planet&&this._planet._geoImageCreator.remove(this),this._src=t,this._sourceReady=!1,this._sourceCreated=!1,this._image=new Image,this._image.crossOrigin="Anonymous",this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_),this._image.src=t}setImage(t){this._planet&&this._planet._geoImageCreator.remove(this),this._sourceCreated=!1,this._sourceReady=!1,this._image=t,this._image.crossOrigin="Anonymous",this._src=t.src,Ls(this._image)?this._applyImage(this._image):(this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_))}_createSourceTexture(){!this._sourceCreated&&this._image&&(this._sourceTexture=this._planet.renderer.handler.createTexture_l(this._image),this._sourceCreated=!0)}_onLoad(t){this._applyImage(this._image),this._image instanceof HTMLImageElement&&this._image.removeEventListener("load",this._onLoad_),this._onLoad_=null}_applyImage(t){t&&(this._frameWidth=Vt(2*t.width,4096),this._frameHeight=Vt(3*t.height,4096),this._sourceReady=!0,this._planet&&this._planet._geoImageCreator.add(this))}loadMaterial(t){t.isLoading=!0,this._creationProceeding=!0,!this._sourceReady&&this._src?this._image?this._image instanceof HTMLImageElement&&(Ls(this._image)?this._applyImage(this._image):(this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_))):(this._image=new Image,this._image.crossOrigin="Anonymous",this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_),this._image.src=this._src):this._planet&&this._planet._geoImageCreator.add(this)}abortMaterialLoading(t){this._image&&this._image instanceof HTMLImageElement&&(this._image.src=""),this._creationProceeding=!1,t.isLoading=!1,t.isReady=!1}}const rd=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereConfig:class extends K{constructor(l={}){super(l),this.$maxOpacity=null,this.$minOpacity=null,this.$rayleight=null,this.$mie=null,this.$height=null,this.$bottomRadius=null,this.$mieScatteringCoefficient=null,this.$mieExtinctionCoefficient=null,this.$rayleighScatteringCoefficientA=null,this.$rayleighScatteringCoefficientB=null,this.$rayleighScatteringCoefficientC=null,this.$ozoneAbsorptionCoefficientA=null,this.$ozoneAbsorptionCoefficientB=null,this.$ozoneAbsorptionCoefficientC=null,this.$sunAngularRadius=null,this.$sunIntensity=null,this.$groundAlbedo=null,this.$ozoneDensityHeight=null,this.$ozoneDensityWide=null,this._toggleBtn=new de({classList:["og-map-button","og-atmosphere_button"],icon:`<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path fill="#000000" d="M135.688 18.5c-6.798 74.842-23.842 85.39-107.907 59.656 84.85 52.022 73.57 64.954-6.843 96.938 87.743-10.27 103.29 4.89 70.75 87.594 17.805-27.56 32.5-44.498 46.282-54.47-11.813 28.26-18.345 59.274-18.345 91.813 0 84.184 43.71 157.96 109.656 200.376-41.624-43.834-67.686-102.7-67.686-167.875 0-134.923 109.45-244.405 244.375-244.405 30.92 0 60.76 5.762 88 16.25-38.584-26.87-85.517-42.625-136.064-42.625-55.257 0-106.14 18.802-146.562 50.375 4.627-18.783 17.39-38.073 41.03-60.906C190.18 90.942 153.53 95.634 135.69 18.5zm10.03 77.188c5.67.002 11.428 1.247 16.876 3.874 14.506 6.998 22.72 21.81 22 36.938-10.26 10.87-19.507 22.696-27.594 35.344-9.035 2.753-19.075 2.27-28.25-2.156-19.37-9.343-27.5-32.6-18.156-51.97 6.715-13.92 20.638-22.036 35.125-22.03z"/></svg>`}),this._dialog=new it({title:"Atmosphere Parameters",visible:!1,useHide:!0,top:60,left:60,width:720}),this._dialog.events.on("visibility",(t=>{this._toggleBtn.setActive(t)})),this._panel=new xe({template:`<div class="og-atmosphere og-options-container">
         
         <div class="og-option og-atmosphere-maxOpacity"></div> 
         <div class="og-option og-atmosphere-minOpacity"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-rayleight"></div>
         <div class="og-option og-atmosphere-mie"></div>
         
       <div class="og-emptyline-2"></div>
                  
         <div class="og-option og-atmosphere-height"></div> 
         <div class="og-option og-atmosphere-bottomRadius"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-mieScatteringCoefficient"></div>  
         <div class="og-option og-atmosphere-mieExtinctionCoefficient"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-rayleighScatteringCoefficientA"></div>    
         <div class="og-option og-atmosphere-rayleighScatteringCoefficientB"></div>    
         <div class="og-option og-atmosphere-rayleighScatteringCoefficientC"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-ozoneAbsorptionCoefficientA"></div>    
         <div class="og-option og-atmosphere-ozoneAbsorptionCoefficientB"></div>    
         <div class="og-option og-atmosphere-ozoneAbsorptionCoefficientC"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-ozoneDensityHeight"></div>    
         <div class="og-option og-atmosphere-ozoneDensityWide"></div>    
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-sunAngularRadius"></div> 
         <div class="og-option og-atmosphere-sunIntensity"></div> 
         <div class="og-option og-atmosphere-groundAlbedo"></div>
       
    </div>`}),this._maxOpacity=new Z({label:"Max.opacity",max:5}),this._minOpacity=new Z({label:"Min.opacity",max:5}),this._rayleight=new Z({label:"Rayleight Scale",min:-10,max:10}),this._mie=new Z({label:"Mie Scale",min:-10,max:10}),this._height=new Z({label:"Height",max:1e6}),this._bottomRadius=new Z({label:"Polar Radius (BOTTOM_RADIUS)",max:31783761571225896e-9}),this._equatorialRadius=new Z({label:"Equatorial Radius (EQUATORIAL_RADIUS)",max:31890685}),this._mieScatteringCoefficient=new Z({label:"Mie Scattering Coefficient e-6",min:-39.96,max:39.96}),this._mieExtinctionCoefficient=new Z({label:"Mie Extinction Coef.e-6",min:4.44*-10,max:10*4.44}),this._rayleighScatteringCoefficientA=new Z({label:"Rayleight Scattering Coef A.e-6",min:5.802*-10,max:10*5.802}),this._rayleighScatteringCoefficientB=new Z({label:"Rayleight Scattering Coef B.e-6",min:13.558*-10,max:10*13.558}),this._rayleighScatteringCoefficientC=new Z({label:"Rayleight Scattering Coef C.e-6",min:-331,max:331}),this._ozoneAbsorptionCoefficientA=new Z({label:"Ozone absorbtion Coef A.e-6",min:-6.5,max:6.5}),this._ozoneAbsorptionCoefficientB=new Z({label:"Ozone absorbtion Coef B.e-6",min:-6.5,max:18.81}),this._ozoneAbsorptionCoefficientC=new Z({label:"Ozone absorbtion Coef C.e-6",min:.085*-10,max:10*.085}),this._ozoneDensityHeight=new Z({label:"Ozone Density Height",max:25e5}),this._ozoneDensityWide=new Z({label:"Ozone Density Wide",max:25e5}),this._sunAngularRadius=new Z({label:"Sun Angular Radius",max:4.685}),this._sunIntensity=new Z({label:"Sun Intensity",max:10}),this._groundAlbedo=new Z({label:"Ground Albedo (GROUND_ALBEDO)",max:.5}),this._parameters={ATMOS_HEIGHT:0,RAYLEIGH_SCALE:0,MIE_SCALE:0,GROUND_ALBEDO:0,BOTTOM_RADIUS:0,EQUATORIAL_RADIUS:0,rayleighScatteringCoefficient_0:0,rayleighScatteringCoefficient_1:0,rayleighScatteringCoefficient_2:0,mieScatteringCoefficient:0,mieExtinctionCoefficient:0,ozoneAbsorptionCoefficient_0:0,ozoneAbsorptionCoefficient_1:0,ozoneAbsorptionCoefficient_2:0,SUN_ANGULAR_RADIUS:0,SUN_INTENSITY:0,ozoneDensityHeight:0,ozoneDensityWide:0,disableSunDisk:!1}}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.renderer.div),this._panel.appendTo(this._dialog.container),this._panel.el&&(this.$height=this._panel.el.querySelector(".og-option.og-atmosphere-height"),this.$maxOpacity=this._panel.el.querySelector(".og-option.og-atmosphere-maxOpacity"),this.$minOpacity=this._panel.el.querySelector(".og-option.og-atmosphere-minOpacity"),this.$rayleight=this._panel.el.querySelector(".og-option.og-atmosphere-rayleight"),this.$mie=this._panel.el.querySelector(".og-option.og-atmosphere-mie"),this.$bottomRadius=this._panel.el.querySelector(".og-option.og-atmosphere-bottomRadius"),this.$mieScatteringCoefficient=this._panel.el.querySelector(".og-option.og-atmosphere-mieScatteringCoefficient"),this.$mieExtinctionCoefficient=this._panel.el.querySelector(".og-option.og-atmosphere-mieExtinctionCoefficient"),this.$rayleighScatteringCoefficientA=this._panel.el.querySelector(".og-option.og-atmosphere-rayleighScatteringCoefficientA"),this.$rayleighScatteringCoefficientB=this._panel.el.querySelector(".og-option.og-atmosphere-rayleighScatteringCoefficientB"),this.$rayleighScatteringCoefficientC=this._panel.el.querySelector(".og-option.og-atmosphere-rayleighScatteringCoefficientC"),this.$ozoneAbsorptionCoefficientA=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneAbsorptionCoefficientA"),this.$ozoneAbsorptionCoefficientB=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneAbsorptionCoefficientB"),this.$ozoneAbsorptionCoefficientC=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneAbsorptionCoefficientC"),this.$sunAngularRadius=this._panel.el.querySelector(".og-option.og-atmosphere-sunAngularRadius"),this.$sunIntensity=this._panel.el.querySelector(".og-option.og-atmosphere-sunIntensity"),this.$groundAlbedo=this._panel.el.querySelector(".og-option.og-atmosphere-groundAlbedo"),this.$ozoneDensityHeight=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneDensityHeight"),this.$ozoneDensityWide=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneDensityWide")),this._toggleBtn.events.on("change",(l=>{this._dialog.setVisibility(l)})),this._maxOpacity.appendTo(this.$maxOpacity),this._minOpacity.appendTo(this.$minOpacity),this._height.appendTo(this.$height),this._rayleight.appendTo(this.$rayleight),this._mie.appendTo(this.$mie),this._bottomRadius.appendTo(this.$bottomRadius),this._equatorialRadius.appendTo(this.$bottomRadius),this._mieScatteringCoefficient.appendTo(this.$mieScatteringCoefficient),this._mieExtinctionCoefficient.appendTo(this.$mieExtinctionCoefficient),this._rayleighScatteringCoefficientA.appendTo(this.$rayleighScatteringCoefficientA),this._rayleighScatteringCoefficientB.appendTo(this.$rayleighScatteringCoefficientB),this._rayleighScatteringCoefficientC.appendTo(this.$rayleighScatteringCoefficientC),this._ozoneAbsorptionCoefficientA.appendTo(this.$ozoneAbsorptionCoefficientA),this._ozoneAbsorptionCoefficientB.appendTo(this.$ozoneAbsorptionCoefficientB),this._ozoneAbsorptionCoefficientC.appendTo(this.$ozoneAbsorptionCoefficientC),this._sunAngularRadius.appendTo(this.$sunAngularRadius),this._sunIntensity.appendTo(this.$sunIntensity),this._groundAlbedo.appendTo(this.$groundAlbedo),this._ozoneDensityHeight.appendTo(this.$ozoneDensityHeight),this._ozoneDensityWide.appendTo(this.$ozoneDensityWide),this.planet&&(this._parameters=this.planet.atmosphereControl.parameters,this._bottomRadius.max=5*this.planet.ellipsoid.getPolarSize(),this._equatorialRadius.max=5*this.planet.ellipsoid.getEquatorialSize(),this._height.value=this._parameters.ATMOS_HEIGHT,this._rayleight.value=this._parameters.RAYLEIGH_SCALE,this._mie.value=this._parameters.MIE_SCALE,this._bottomRadius.value=this._parameters.BOTTOM_RADIUS,this._equatorialRadius.value=this._parameters.EQUATORIAL_RADIUS,this._mieScatteringCoefficient.value=this._parameters.mieScatteringCoefficient,this._mieExtinctionCoefficient.value=this._parameters.mieExtinctionCoefficient,this._rayleighScatteringCoefficientA.value=this._parameters.rayleighScatteringCoefficient_0,this._rayleighScatteringCoefficientB.value=this._parameters.rayleighScatteringCoefficient_1,this._rayleighScatteringCoefficientC.value=this._parameters.rayleighScatteringCoefficient_2,this._ozoneAbsorptionCoefficientA.value=this._parameters.ozoneAbsorptionCoefficient_0,this._ozoneAbsorptionCoefficientB.value=this._parameters.ozoneAbsorptionCoefficient_1,this._ozoneAbsorptionCoefficientC.value=this._parameters.ozoneAbsorptionCoefficient_2,this._sunAngularRadius.value=this._parameters.SUN_ANGULAR_RADIUS,this._sunIntensity.value=this._parameters.SUN_INTENSITY,this._groundAlbedo.value=this._parameters.GROUND_ALBEDO,this._ozoneDensityHeight.value=this._parameters.ozoneDensityHeight,this._ozoneDensityWide.value=this._parameters.ozoneDensityWide),this._minOpacity.value=this.planet.atmosphereMinOpacity,this._minOpacity.events.on("change",(l=>{this.planet.atmosphereMinOpacity=l})),this._maxOpacity.value=this.planet.atmosphereMaxOpacity,this._maxOpacity.events.on("change",(l=>{this.planet.atmosphereMaxOpacity=l})),this._rayleight.events.on("change",(l=>{this._parameters.RAYLEIGH_SCALE=l,this._update()})),this._mie.events.on("change",(l=>{this._parameters.MIE_SCALE=l,this._update()})),this._height.events.on("change",(l=>{this._parameters.ATMOS_HEIGHT=l,this._update()})),this._bottomRadius.events.on("change",(l=>{this._parameters.BOTTOM_RADIUS=l,this._update()})),this._equatorialRadius.events.on("change",(l=>{this._parameters.EQUATORIAL_RADIUS=l,this._update()})),this._mieScatteringCoefficient.events.on("change",(l=>{this._parameters.mieScatteringCoefficient=l,this._update()})),this._mieExtinctionCoefficient.events.on("change",(l=>{this._parameters.mieExtinctionCoefficient=l,this._update()})),this._rayleighScatteringCoefficientA.events.on("change",(l=>{this._parameters.rayleighScatteringCoefficient_0=l,this._update()})),this._rayleighScatteringCoefficientB.events.on("change",(l=>{this._parameters.rayleighScatteringCoefficient_1=l,this._update()})),this._rayleighScatteringCoefficientC.events.on("change",(l=>{this._parameters.rayleighScatteringCoefficient_2=l,this._update()})),this._ozoneAbsorptionCoefficientA.events.on("change",(l=>{this._parameters.ozoneAbsorptionCoefficient_0=l,this._update()})),this._ozoneAbsorptionCoefficientB.events.on("change",(l=>{this._parameters.ozoneAbsorptionCoefficient_1=l,this._update()})),this._ozoneAbsorptionCoefficientC.events.on("change",(l=>{this._parameters.ozoneAbsorptionCoefficient_2=l,this._update()})),this._sunAngularRadius.events.on("change",(l=>{this._parameters.SUN_ANGULAR_RADIUS=l,this._update()})),this._sunIntensity.events.on("change",(l=>{this._parameters.SUN_INTENSITY=l,this._update()})),this._groundAlbedo.events.on("change",(l=>{this._parameters.GROUND_ALBEDO=l,this._update()})),this._ozoneDensityHeight.events.on("change",(l=>{this._parameters.ozoneDensityHeight=l,this._update()})),this._ozoneDensityWide.events.on("change",(l=>{this._parameters.ozoneDensityWide=l,this._update()}))}_update(){this.planet&&this.planet.atmosphereControl.setParameters(this._parameters)}},CameraDepthHandler:class extends K{constructor(l){super(l),this._skipPreRender=!1,this._depthHandlerCallback=t=>{if(!this.planet)return;let i=t.frameBuffer;if(i.handler.gl,i.activate(),this._quadTreeStrategy){let o=t.camera;this._skipPreRender&&this._quadTreeStrategy.collectRenderNodes(o),this._skipPreRender=!0,console.log(this._quadTreeStrategy._renderedNodes)}i.deactivate(),i.readPixelBuffersAsync();let s=this.getLonLatFromPixelTerrain(1,1),r=this.getLonLatFromPixelTerrain(i.width-1,1),n=this.getLonLatFromPixelTerrain(i.width-1,i.height-1),a=this.getLonLatFromPixelTerrain(1,i.height-1);s&&r&&n&&a&&this.cameraGeoImage.setCorners([[s.lon,s.lat],[r.lon,r.lat],[n.lon,n.lat],[a.lon,a.lat]])},this._frameComposer=new Hs,this._frameHandler=null,this.cameraGeoImage=new wo(`cameraGeoImage:${this.__id}`,{src:"test4.jpg",corners:[[0,1],[1,1],[1,0],[0,0]],visibility:!0,isBaseLayer:!1,opacity:.7}),this._quadTreeStrategy=null}_createCamera(){return this.planet?new go(this.planet,{frustums:[[100,1e9]],width:640,height:480,viewAngle:45}):new cr({frustums:[[100,1e9]],width:640,height:480,viewAngle:45})}get camera(){if(this._frameHandler)return this._frameHandler.camera}oninit(){if(super.oninit(),!this.renderer)return;this.renderer.handler.addProgram(new X("camera_depth",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",height:"float",eyePositionHigh:"vec3",eyePositionLow:"vec3"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3"},vertexShader:`#version 300 es
            
            precision highp float;

            in vec3 aVertexPositionHigh;
            in vec3 aVertexPositionLow;

            uniform mat4 projectionMatrix;
            uniform mat4 viewMatrix;
            uniform vec3 eyePositionHigh;
            uniform vec3 eyePositionLow;
            uniform float height;

            void main(void) {

                mat4 viewMatrixRTE = viewMatrix;
                viewMatrixRTE[3] = vec4(0.0, 0.0, 0.0, 1.0);

                mat4 m = projectionMatrix * viewMatrixRTE;

                vec3 nh = height * normalize(aVertexPositionHigh + aVertexPositionLow);

                vec3 eyePosition = eyePositionHigh + eyePositionLow;
                vec3 vertexPosition = aVertexPositionHigh + aVertexPositionLow;

                vec3 highDiff = aVertexPositionHigh - eyePositionHigh;
                vec3 lowDiff = aVertexPositionLow - eyePositionLow + nh;
                
                gl_Position =  m * vec4(highDiff * step(1.0, length(highDiff)) + lowDiff, 1.0);    
            }`,fragmentShader:`#version 300 es
            
            precision highp float;        

            layout(location = 0) out vec4 depthColor;

            void main(void) {
                depthColor = vec4(gl_FragCoord.z, gl_FragCoord.z, gl_FragCoord.z, 1.0);
            }`})),this.planet&&this.planet.addLayer(this.cameraGeoImage);let l=new Pe(this.renderer.handler,{width:640,height:480,targets:[{internalFormat:"RGBA16F",type:"FLOAT",attachment:"COLOR_ATTACHMENT",readAsync:!0}],useDepth:!0});if(this._frameHandler=new tn({camera:this._createCamera(),frameBuffer:l,frameHandler:this._depthHandlerCallback}),this.renderer.controls.CameraFrameComposer?this._frameComposer=this.renderer.controls.CameraFrameComposer:this.renderer.addControl(this._frameComposer),this._frameComposer.add(this._frameHandler),this.planet){const t={planet:this.planet,maxEqualZoomAltitude:this.planet.quadTreeStrategy.maxEqualZoomAltitude,minEqualZoomAltitude:this.planet.quadTreeStrategy.minEqualZoomAltitude,minEqualZoomCameraSlope:this.planet.quadTreeStrategy.minEqualZoomCameraSlope,transitionOpacityEnabled:!1};this._quadTreeStrategy=new this.planet.quadTreeStrategyPrototype(t),this._quadTreeStrategy.init(this.camera),this._quadTreeStrategy.preRender(),this._quadTreeStrategy.clearRenderedNodes(),this._skipPreRender=!1,this._quadTreeStrategy.preLoad()}}get framebuffer(){if(this._frameHandler)return this._frameHandler.frameBuffer}getCartesianFromPixelTerrain(l,t){if(this._frameHandler){let i=this._frameHandler.frameBuffer,s=this._frameHandler.camera,r=(function(o,h,c,d){let u=new H(o,h),_=u.x/d.width,p=(d.height-u.y)/d.height,f=new Float32Array(4),m=0;if(d.readData(_,p,f,0),f[0]===0)return 0;let g=f[0],y=c.frustums[0].inverseProjectionMatrix,x=new te(2*_-1,2*p-1,2*g-1,1),b=y.mulVec4(x),T=c.unproject(_*c.width,(1-p)*c.height);return m=-b.z/b.w/T.dot(c.getForward()),m})(l,t,s,i);if(r===0)return;let n=l/i.width,a=(i.height-t)/i.height;return s.unproject(n*s.width,(1-a)*s.height).scaleTo(r).addA(s.eye)}}getLonLatFromPixelTerrain(l,t){if(this.planet){let i=this.getCartesianFromPixelTerrain(l,t);if(i)return this.planet.ellipsoid.cartesianToLonLat(i)}}activate(){super.activate()}deactivate(){super.deactivate()}},CameraFrameComposer:Hs,CameraFrameHandler:tn,CameraLock:en,CompassButton:qn,Control:K,DebugInfo:class extends K{constructor(l={}){l.name&&l.name!==""||(l.name="DebugInfo"),super(l),this.el=null,this._watch=l.watch||[],this._toggleBtn=new de({classList:["og-map-button","og-debuginfo_button"],icon:`<?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 width="800px" height="800px" viewBox="0 0 932.179 932.179"
	 xml:space="preserve">
<g>
	<path d="M61.2,341.538c4.9,16.8,11.7,33,20.3,48.2l-24.5,30.9c-8,10.1-7.1,24.5,1.9,33.6l42.2,42.2c9.1,9.1,23.5,9.899,33.6,1.899
		l30.7-24.3c15.8,9.101,32.6,16.2,50.1,21.2l4.6,39.5c1.5,12.8,12.3,22.4,25.1,22.4h59.7c12.8,0,23.6-9.601,25.1-22.4l4.4-38.1
		c18.8-4.9,36.8-12.2,53.7-21.7l29.7,23.5c10.1,8,24.5,7.1,33.6-1.9l42.2-42.2c9.1-9.1,9.9-23.5,1.9-33.6l-23.1-29.3
		c9.6-16.601,17.1-34.3,22.1-52.8l35.6-4.1c12.801-1.5,22.4-12.3,22.4-25.1v-59.7c0-12.8-9.6-23.6-22.4-25.1l-35.1-4.1
		c-4.801-18.3-12-35.8-21.199-52.2l21.6-27.3c8-10.1,7.1-24.5-1.9-33.6l-42.1-42.1c-9.1-9.1-23.5-9.9-33.6-1.9l-26.5,21
		c-17.2-10.1-35.601-17.8-54.9-23l-4-34.3c-1.5-12.8-12.3-22.4-25.1-22.4h-59.7c-12.8,0-23.6,9.6-25.1,22.4l-4,34.3
		c-19.8,5.3-38.7,13.3-56.3,23.8l-27.5-21.8c-10.1-8-24.5-7.1-33.6,1.9l-42.2,42.2c-9.1,9.1-9.9,23.5-1.9,33.6l23,29.1
		c-9.2,16.6-16.2,34.3-20.8,52.7l-36.8,4.2c-12.8,1.5-22.4,12.3-22.4,25.1v59.7c0,12.8,9.6,23.6,22.4,25.1L61.2,341.538z
		 M277.5,180.038c54.4,0,98.7,44.3,98.7,98.7s-44.3,98.7-98.7,98.7c-54.399,0-98.7-44.3-98.7-98.7S223.1,180.038,277.5,180.038z"/>
	<path d="M867.699,356.238l-31.5-26.6c-9.699-8.2-24-7.8-33.199,0.9l-17.4,16.3c-14.699-7.1-30.299-12.1-46.4-15l-4.898-24
		c-2.5-12.4-14-21-26.602-20l-41.1,3.5c-12.6,1.1-22.5,11.4-22.9,24.1l-0.799,24.4c-15.801,5.7-30.701,13.5-44.301,23.3
		l-20.799-13.8c-10.602-7-24.701-5-32.9,4.7l-26.6,31.7c-8.201,9.7-7.801,24,0.898,33.2l18.201,19.399
		c-6.301,14.2-10.801,29.101-13.4,44.4l-26,5.3c-12.4,2.5-21,14-20,26.601l3.5,41.1c1.1,12.6,11.4,22.5,24.1,22.9l28.1,0.899
		c5.102,13.4,11.801,26.101,19.9,38l-15.699,23.7c-7,10.6-5,24.7,4.699,32.9l31.5,26.6c9.701,8.2,24,7.8,33.201-0.9l20.6-19.3
		c13.5,6.3,27.699,11,42.299,13.8l5.701,28.2c2.5,12.4,14,21,26.6,20l41.1-3.5c12.6-1.1,22.5-11.399,22.9-24.1l0.9-27.601
		c15-5.3,29.199-12.5,42.299-21.399l22.701,15c10.6,7,24.699,5,32.9-4.7l26.6-31.5c8.199-9.7,7.799-24-0.9-33.2l-18.301-19.399
		c6.701-14.2,11.602-29.2,14.4-44.601l25-5.1c12.4-2.5,21-14,20-26.601l-3.5-41.1c-1.1-12.6-11.4-22.5-24.1-22.9l-25.1-0.8
		c-5.201-14.6-12.201-28.399-20.9-41.2l13.699-20.6C879.4,378.638,877.4,364.438,867.699,356.238z M712.801,593.837
		c-44.4,3.801-83.602-29.3-87.301-73.699c-3.801-44.4,29.301-83.601,73.699-87.301c44.4-3.8,83.602,29.301,87.301,73.7
		C790.301,550.938,757.199,590.138,712.801,593.837z"/>
	<path d="M205,704.438c-12.6,1.3-22.3,11.899-22.4,24.6l-0.3,25.3c-0.2,12.7,9.2,23.5,21.8,25.101l18.6,2.399
		c3.1,11.301,7.5,22.101,13.2,32.301l-12,14.8c-8,9.899-7.4,24.1,1.5,33.2l17.7,18.1c8.9,9.1,23.1,10.1,33.2,2.3l14.899-11.5
		c10.5,6.2,21.601,11.101,33.2,14.5l2,19.2c1.3,12.6,11.9,22.3,24.6,22.4l25.301,0.3c12.699,0.2,23.5-9.2,25.1-21.8l2.3-18.2
		c12.601-3.101,24.601-7.8,36-14l14,11.3c9.9,8,24.101,7.4,33.201-1.5l18.1-17.7c9.1-8.899,10.1-23.1,2.301-33.2L496.6,818.438
		c6.6-11,11.701-22.7,15.201-35l16.6-1.7c12.6-1.3,22.299-11.9,22.4-24.6l0.299-25.301c0.201-12.699-9.199-23.5-21.799-25.1
		l-16.201-2.1c-3.1-12.2-7.699-24-13.699-35l10.1-12.4c8-9.9,7.4-24.1-1.5-33.2l-17.699-18.1c-8.9-9.101-23.102-10.101-33.201-2.3
		l-12.101,9.3c-11.399-6.9-23.6-12.2-36.399-15.8l-1.601-15.7c-1.3-12.601-11.899-22.3-24.6-22.4l-25.3-0.3
		c-12.7-0.2-23.5,9.2-25.101,21.8l-2,15.601c-13.199,3.399-25.899,8.6-37.699,15.399l-12.5-10.2c-9.9-8-24.101-7.399-33.201,1.5
		l-18.2,17.801c-9.1,8.899-10.1,23.1-2.3,33.199l10.7,13.801c-6.2,11-11.1,22.699-14.3,35L205,704.438z M368.3,675.837
		c36.3,0.4,65.399,30.301,65,66.601c-0.4,36.3-30.301,65.399-66.601,65c-36.3-0.4-65.399-30.3-65-66.601
		C302.1,704.538,332,675.438,368.3,675.837z"/>
</g>
</svg>`}),this._dialog=new it({title:"Debug Info",visible:!1,useHide:!0,top:120,left:60,width:480}),this._dialog.events.on("visibility",(t=>{this._toggleBtn.setActive(t)})),this._canvasTiles=new Kn("Tile grid",{visibility:!0,isBaseLayer:!1,hideInLayerSwitcher:!0,drawTile:function(t,i){let s,r=document.createElement("canvas"),n=r.getContext("2d");r.width=256,r.height=256,n.clearRect(0,0,r.width,r.height),n.beginPath(),n.rect(0,0,r.width,r.height),n.lineWidth=2,n.strokeStyle="black",n.stroke(),s=t.segment.tileZoom>14?"26":"32",n.fillStyle="black",n.font="normal "+s+"px Verdana",n.textAlign="center",n.fillText(t.segment.tileX+","+t.segment.tileY+","+t.segment.tileZoom,r.width/2,r.height/2),i(r)}})}addWatches(l){for(let t=0;t<l.length;t++)this.addWatch(l[t])}addWatch(l){this._watch.push(l);let t=document.createElement("div");t.classList.add("og-watch-line"),t.innerHTML=`<div class="og-watch-label">${l.label}</div><div class="og-watch-value"></div>`,l.valEl=t.querySelector(".og-watch-value"),this.el.appendChild(t)}oninit(){var l;this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.renderer.div),this._toggleBtn.events.on("change",(a=>{this._dialog.setVisibility(a)})),this.el=document.createElement("div"),this.el.className="og-debug-info";let t=document.createElement("div");t.classList.add("og-debuginfo_controls"),this.el.appendChild(t);let i=this._watch;this._watch=[];for(let a=0;a<i.length;a++)this.addWatch(i[a]);(l=this._dialog.container)==null||l.appendChild(this.el),this.renderer.events.on("draw",this._frame,this);let s=this.planet;s&&this.addWatches([{label:"Nodes count",frame:()=>s.quadTreeStrategy._renderedNodes.length},{label:"Planet._fadingNodes",frame:()=>s.quadTreeStrategy._fadingNodes.size},{label:"createdNodes",frame:()=>s._createdNodesCount},{label:"indexesCache",frame:()=>s._indexesCacheToRemoveCounter},{label:"distBeforeMemClear",frame:()=>Math.round(s._distBeforeMemClear)},{label:"maxZoom/minZoom",frame:()=>s.quadTreeStrategy.maxCurrZoom+" / "+s?.quadTreeStrategy.minCurrZoom},{label:"viewExtent",frame:()=>s.getViewExtent().toString()},{label:"Mouse distance, m",frame:()=>{let a=s.getCartesianFromMouseTerrain();return a?s.camera.eye.distance(a).toFixed(3):""}},{label:"lodSize",frame:()=>Math.round(s.quadTreeStrategy.lodSize)},{label:"deltaTime/FPS",frame:()=>`<div style="width:70px"><div style="width:20px; float: left;">
                        ${Math.round(s.renderer.handler.deltaTime)}
                        </div> <div style="float: left">
                        ${Math.round(1e3/s.renderer.handler.deltaTime)}
                        </div></div>`},{label:"-------------------------"},{label:"Pitch, deg",frame:()=>(s.camera.getPitch()*J).toFixed(2)},{label:"Yaw, deg",frame:()=>(s.camera.getYaw()*J).toFixed(2)},{label:"Roll, deg",frame:()=>(s.camera.getRoll()*J).toFixed(2)},{label:"Lon, Lat",frame:()=>`<div style="width:190px">${s.camera._lonLat.lon.toFixed(7)}, ${s.camera._lonLat.lon.toFixed(7)}</div>`},{label:"height/alt, m",frame:()=>`<div style="width:190px">${s.camera._lonLat.height.toFixed(2)+" / "+s.camera.getAltitude().toFixed(2)}</div>`},{label:"cam.slope",frame:()=>s.camera.slope.toFixed(3)},{label:"-------------------------"},{label:"_renderCompleted / renderCompletedActivated",frame:()=>`${s.quadTreeStrategy._renderCompleted} / ${s.quadTreeStrategy._renderCompletedActivated}`},{label:"_terrainCompleted / terrainCompletedActivated",frame:()=>`${s.quadTreeStrategy._terrainCompleted} / ${s.quadTreeStrategy._terrainCompletedActivated}`},{label:"PlainWorker",frame:()=>s._plainSegmentWorker.pendingQueue.length},{label:"TileLoader",frame:()=>`${s._tileLoader.loading} ${s._tileLoader.queue.length}`},{label:"TerrainLoader",frame:()=>s.terrain&&!s.terrain.isEmpty?`${s.terrain.loader.loading}  ${s.terrain.loader.queue.length}`:""},{label:"TerrainWorker",frame:()=>s._terrainWorker.pendingQueue.length},{label:"NormalMapCreator",frame:()=>s._normalMapCreator.queueSize},{label:"VectorTileCreator",frame:()=>s._vectorTileCreator.queueSize}]);let r=new de({classList:["og-debuginfo_controls-button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" width="800px" height="800px" viewBox="-7.5 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">
<title>lock</title>
<path d="M14.625 15.156h2.094c0.281 0 0.5 0.25 0.5 0.531v11c0 0.281-0.219 0.5-0.5 0.5h-16.219c-0.281 0-0.5-0.219-0.5-0.5v-11c0-0.281 0.219-0.531 0.5-0.531h2.031v-5.125c0-2.875 1.844-5.25 4.688-5.25h2.688c2.875 0 4.719 2.375 4.719 5.25v5.125zM5.188 15.156h6.813v-4.875c0-1.594-1.313-2.938-2.938-2.938h-0.969c-1.594 0-2.906 1.344-2.906 2.938v4.875zM7.156 24h2.906l-0.719-3.156c0.5-0.25 0.844-0.781 0.844-1.375 0-0.906-0.719-1.594-1.594-1.594s-1.563 0.688-1.563 1.594c0 0.594 0.344 1.125 0.844 1.375z"></path>
</svg>`,title:"Lock/Unlock quad tree"});r.appendTo(t),r.events.on("change",(a=>{a?s.lockQuadTree():s.unlockQuadTree()}));let n=new de({classList:["og-debuginfo_controls-button"],icon:`<?xml version="1.0"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M 4 4 L 4 8 L 8 8 L 8 4 L 4 4 z M 10 4 L 10 8 L 14 8 L 14 4 L 10 4 z M 16 4 L 16 8 L 20 8 L 20 4 L 16 4 z M 4 10 L 4 14 L 8 14 L 8 10 L 4 10 z M 10 10 L 10 14 L 14 14 L 14 10 L 10 10 z M 16 10 L 16 14 L 20 14 L 20 10 L 16 10 z M 4 16 L 4 20 L 8 20 L 8 16 L 4 16 z M 10 16 L 10 20 L 14 20 L 14 16 L 10 16 z M 16 16 L 16 20 L 20 20 L 20 16 L 16 16 z"/>
</svg>`,title:"Show/Hide grid"});n.appendTo(t),n.events.on("change",(a=>{a?this.planet.addLayer(this._canvasTiles):this._canvasTiles.remove()}))}_frame(){this._watch.forEach((l=>{l.valEl&&(l.valEl.innerHTML=l.frame?String(l.frame()):"")}))}},DrawingControl:Ir,DrawingSwitcher:class extends K{constructor(l={}){super({name:"DrawingSwitcher",...l}),this.drawingControl=new Ir(l)}oninit(){this.planet.addControl(this.drawingControl),this._createMenu()}onactivate(){this.drawingControl.activate()}ondeactivate(){this.drawingControl.deactivate()}_createMenu(){let l=new de({classList:["og-map-button","og-drawing-default_button"],icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M4 0l16 12.279-6.951 1.17 4.325 8.817-3.596 1.734-4.35-8.879-5.428 4.702z"/></svg>',name:"default",isActive:!0}),t=new de({classList:["og-map-button","og-drawing-polygon_button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 24.1.3, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<svg version="1.1" id="Layer_2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 1024 1024" style="enable-background:new 0 0 1024 1024;" xml:space="preserve">
<g>
	<path d="M926.03,321.16c-16.02,0-31.11,3.94-44.48,10.79l-263.43-191.4c2.69-8.94,4.18-18.4,4.18-28.2
		c0-54.02-43.95-97.97-97.97-97.97c-54.03,0-97.98,43.95-97.98,97.97c0,9.81,1.49,19.27,4.18,28.21L155.75,340.18
		c-16.22-11.91-36.16-19.03-57.78-19.03C43.95,321.16,0,365.11,0,419.13c0,52.58,41.67,95.5,93.71,97.75l102.63,315.86
		c-24.28,17.85-40.13,46.52-40.13,78.9c0,54.02,43.95,97.98,97.98,97.98c37.54,0,70.18-21.25,86.62-52.34h367.26
		c16.44,31.08,49.08,52.34,86.63,52.34c54.03,0,97.98-43.95,97.98-97.98c0-32.46-15.94-61.21-40.33-79.05l104.11-320.4
		c39.15-12.84,67.54-49.68,67.54-93.07C1024,365.11,980.05,321.16,926.03,321.16z M828.05,911.65c0,8.5-3.3,16.19-8.55,22.09
		c-6.11,6.85-14.9,11.26-24.79,11.26c-13.65,0-25.37-8.26-30.52-20.02c-1.79-4.09-2.82-8.58-2.82-13.33
		c0-18.39,14.95-33.35,33.34-33.35c2.93,0,5.72,0.5,8.43,1.21c13.27,3.49,23.21,14.91,24.59,28.9
		C827.83,909.5,828.05,910.54,828.05,911.65z M790.48,813.89c-45.63,1.96-83.27,35.16-91.87,78.77H350.28
		c-8.62-43.69-46.38-76.93-92.11-78.79L155.59,498.19c24.41-17.84,40.36-46.59,40.36-79.06c0-8.9-1.3-17.49-3.53-25.7L468.57,192.8
		c15.84,11.01,35.05,17.52,55.76,17.52c20.71,0,39.92-6.5,55.76-17.52l256.56,186.4c-5.48,12.21-8.59,25.7-8.59,39.93
		c0,41.02,25.36,76.17,61.21,90.75L790.48,813.89z M254.19,945c-10.11,0-19.07-4.62-25.19-11.75c-5.01-5.84-8.15-13.32-8.15-21.6
		c0-0.91,0.2-1.76,0.27-2.66c1.14-14.18,11.08-25.8,24.43-29.41c2.78-0.75,5.64-1.28,8.65-1.28c18.38,0,33.33,14.96,33.33,33.35
		c0,4.74-1.03,9.24-2.82,13.33C279.55,936.74,267.83,945,254.19,945z M64.88,421.49c-0.06-0.79-0.24-1.55-0.24-2.35
		c0-16.41,11.93-30.01,27.55-32.76c1.89-0.33,3.8-0.58,5.78-0.58c11.94,0,22.35,6.36,28.24,15.81c3.18,5.11,5.11,11.09,5.11,17.53
		c0,15.47-10.63,28.39-24.94,32.14c-2.7,0.71-5.48,1.2-8.4,1.2C80.4,452.47,66.11,438.76,64.88,421.49z M549.41,90.62
		c5.07,5.85,8.25,13.39,8.25,21.72c0,7.32-2.44,14.03-6.45,19.54c-6.07,8.33-15.82,13.81-26.88,13.81
		c-11.07,0-20.83-5.48-26.89-13.81c-4.01-5.51-6.45-12.22-6.45-19.54c0-8.33,3.17-15.86,8.24-21.71
		c6.12-7.07,15.04-11.64,25.1-11.64C534.38,79,543.29,83.57,549.41,90.62z M959.36,419.13c0,11.94-6.36,22.35-15.82,28.24
		c-5.1,3.18-11.07,5.1-17.52,5.1c-6.08,0-11.71-1.76-16.62-4.61c-9.71-5.64-16.33-15.94-16.64-27.89c-0.01-0.29-0.09-0.56-0.09-0.85
		c0-11.75,6.14-22.05,15.36-28c5.2-3.35,11.35-5.35,17.99-5.35C944.41,385.78,959.36,400.75,959.36,419.13z"/>
</g>
</svg>`,name:"polygon"}),i=new de({classList:["og-map-button","og-drawing-linestring_button"],icon:`<?xml version="1.0" encoding="utf-8"?><!-- License: MIT. Made by Esri: https://github.com/Esri/calcite-ui-icons -->
    <svg width="800px" height="800px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 6h.046l-5.25 9h-.944L10 9.455V7H7v2.926L1.862 18H0v3h3v-2.926L8.138 10h1.01L14 15.545V18h3v-3h-.046l5.25-9H24V3h-3zM8 8h1v1H8zM2 20H1v-1h1zm14-3h-1v-1h1zm7-13v1h-1V4z"/></svg>`,name:"linestring"});new Jn({buttons:[l,t,i]}).events.on("change",(s=>{switch(this.drawingControl.deactivate(),s.name){case"polygon":this.drawingControl.activatePolygonDrawing();break;case"linestring":this.drawingControl.activateLineStringDrawing()}})),l.appendTo(this.renderer.div),t.appendTo(this.renderer.div),i.appendTo(this.renderer.div)}},EarthCoordinates:Ja,ElevationProfileControl:class extends K{constructor(l={}){super({name:"ElevationProfileControl",...l}),this._onSceneChange=()=>{this._collectProfileThrottled()},this._onElevationProfilePointer=(t,i,s,r,n,a,o,h)=>{let c=this._elevationProfileScene.getPointLonLat(a),d=this._elevationProfileScene.getPointLonLat(a+1),u=this.planet.ellipsoid.lonLatToCartesian(c),_=this.planet.ellipsoid.lonLatToCartesian(d),p=(t-i[0])/(s[0]-i[0]),f=_.sub(u);this._elevationProfileScene.setPointerCartesian3v(u.add(f.scale(p)),h)},this._onElevationProfileDblClick=(t,i,s,r,n,a,o,h)=>{let c=this._elevationProfileScene.getPointLonLat(a),d=this._elevationProfileScene.getPointLonLat(a+1),u=this.planet.ellipsoid.lonLatToCartesian(c),_=this.planet.ellipsoid.lonLatToCartesian(d),p=(t-i[0])/(s[0]-i[0]),f=_.sub(u),m=u.add(f.scale(p));this.planet.camera.flyDistance(m,this.planet.camera.eye.distance(m))},this._onElevationProfileMouseEnter=()=>{this._elevationProfileView.model.pointsReady&&this._elevationProfileScene.setPointerVisibility(!0)},this._onElevationProfileMouseLeave=()=>{},this._elevationProfileScene=new Ch,this._elevationProfileView=new ph,this._elevationProfileLegend=new Sh,this._elevationProfileButtonsView=new Lh({model:this._elevationProfileView.model}),this._elevationProfileView.events.on("pointer",this._onElevationProfilePointer),this._elevationProfileView.events.on("dblclick",this._onElevationProfileDblClick),this._elevationProfileView.events.on("mouseenter",this._onElevationProfileMouseEnter),this._elevationProfileView.events.on("mouseleave",this._onElevationProfileMouseLeave),this._dialog=new it({title:"Elevation Profile",visible:!1,resizable:!0,useHide:!0,top:175,left:65,width:400,height:200,minHeight:100,minWidth:100}),this._graphView=new xe({template:`<div class="og-elevationprofile__container">
      <div class="og-elevationprofile__menu"></div>
      <div class="og-elevationprofile__graph"></div>
    </div>`}),this._poiListDialog=new Ph({model:this._elevationProfileScene}),this._toggleBtn=new de({classList:["og-map-button","og-elevationprofile_button"],icon:'<svg style="width: 2em; height: 2em;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M128 896v-158.293333l331.946667-191.573334 160.853333 93.866667L896 480V896H128M896 381.44l-275.2 159.146667-160.853333-92.586667L128 640v-94.293333l331.946667-191.573334 160.853333 93.866667L896 288v93.44z" fill="" /></svg>'}),this._collectProfileThrottled=di((()=>{let t=this._elevationProfileScene.getPointsLonLat();this._elevationProfileView.model.collectProfile(t)}),250)}oninit(){this._dialog.appendTo(this.planet.renderer.div),this._graphView.appendTo(this._dialog.container),this._toggleBtn.appendTo(this.renderer.div),this._dialog.events.on("visibility",(l=>{this._toggleBtn.setActive(l),l?(this.activate(),this._elevationProfileView.resize()):this.deactivate()})),this._toggleBtn.events.on("change",(l=>{this._dialog.setVisibility(l)})),this._elevationProfileView.appendTo(this._graphView.select(".og-elevationprofile__graph")),this._elevationProfileView.model.bindPlanet(this.planet),this._elevationProfileView.model.events.on("clear",(()=>{this._elevationProfileScene.clear(),this._elevationProfileLegend.clear()})),this._elevationProfileView.model.events.on("startcollecting",(()=>{this._elevationProfileScene.setPointerVisibility(!1)})),this._elevationProfileView.events.on("tracklength",(l=>{this._elevationProfileLegend.setTrackLength(l)})),this._elevationProfileView.events.on("groundlength",(l=>{this._elevationProfileLegend.setGroundLength(l)})),this._elevationProfileView.events.on("warninglength",(l=>{this._elevationProfileLegend.setWarningLength(l)})),this._elevationProfileView.events.on("collisionlength",(l=>{this._elevationProfileLegend.setCollisionLength(l)})),this._poiListDialog.appendTo(this.planet.renderer.div),this._poiListDialog.events.on("visibility",(l=>{this._elevationProfileButtonsView.pointListBtn.setActive(l,!0)})),this._elevationProfileLegend.appendTo(this._graphView.select(".og-elevationprofile__menu")),this._elevationProfileButtonsView.appendTo(this._graphView.select(".og-elevationprofile__menu")),this._elevationProfileButtonsView.events.on("list",(l=>{this._poiListDialog.setVisibility(l)})),this._elevationProfileButtonsView.events.on("location",(l=>{this._elevationProfileScene.flyExtent()})),this._elevationProfileButtonsView.events.on("reset",(l=>{this._elevationProfileScene.setPointerVisibility(!1)})),this._elevationProfileScene.events.on("change",this._onSceneChange)}onactivate(){this.planet&&this._elevationProfileScene.bindPlanet(this.planet),this.renderer&&this.renderer.addNode(this._elevationProfileScene)}ondeactivate(){this._poiListDialog.setVisibility(!1),this._elevationProfileView.model.clear(),this.renderer&&this.renderer.removeNode(this._elevationProfileScene),this._dialog.hide()}},FramebufferPreview:class extends K{constructor(l){super({autoActivate:!0,...l}),this._onDraw=()=>{if(this._framebuffer&&this._screenFramebuffer){let t=this.renderer,i=t.handler.gl;i.disable(i.BLEND),this._screenFramebuffer.activate();let s=this._program._programController,r=s._program;i.bindBuffer(i.ARRAY_BUFFER,t.screenFramePositionBuffer),i.vertexAttribPointer(r.attributes.corners,2,i.FLOAT,!1,0,0),s.activate(),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this._framebuffer.textures[this.framebufferCurrentTexture]),i.uniform1i(r.uniforms.inputTexture,0),i.drawArrays(i.TRIANGLE_STRIP,0,4),this._screenFramebuffer.deactivate(),i.enable(i.BLEND),this._screenFramebuffer.readPixelBuffersAsync((n=>{let a=n.getPixelBufferData();if(a){let o=n.width,h=n.height,c=this.$canvas.getContext("2d"),d=new Uint8ClampedArray(a.buffer,a.byteOffset,a.byteLength),u=new ImageData(d,o,h);createImageBitmap(u).then((_=>{c.clearRect(0,0,this.$canvas.width,this.$canvas.height),c.drawImage(_,0,0,this.$canvas.width,this.$canvas.height)}))}}))}},this._dialog=new it({title:l.title||"",width:580,height:340,left:100,top:100}),this.$canvas=(function(t,i){let s=document.createElement("canvas");return s.width=t,s.height=i,s.style.position="absolute",s.style.width="100%",s.style.height="100%",s})(this._dialog.width,this._dialog.height),this._framebuffer=l.framebuffer||null,this._screenFramebuffer=null,this.framebufferCurrentTexture=0,this._program=(function(t=0,i,s,r){return new X(`framebuffer_dialog_screen:${t.toString()}`,{uniforms:{inputTexture:"sampler2D"},attributes:{corners:"vec2"},vertexShader:`#version 300 es
            
            in vec2 corners;
            
            out vec2 tc;

            void main(void) {
                gl_Position = vec4(corners, 0.0, 1.0);
                tc = corners * 0.5 + 0.5;
                ${r?"tc.y = 1.0 - tc.y;":""}               
            }`,fragmentShader:`#version 300 es

            precision highp float;

            uniform sampler2D inputTexture;
           
            in vec2 tc;

            layout(location = 0) out vec4 fragColor;

            ${i||""}
            
            ${s||`void mainImage(out vec4 fragColor, in vec2 fragCoord) { 
                fragColor = texture(inputTexture, fragCoord);
            }`}
            
            void main(void) {                              
               mainImage(fragColor, tc);
            }`})})(this.__id,l.common,l.image,l.flippedUV)}bindFramebuffer(l){l.isEqual(this._framebuffer)||(this._framebuffer=l)}oninit(){var l,t;super.oninit(),this.renderer&&(this.renderer.handler.addProgram(this._program),this._screenFramebuffer=new Pe(this.renderer.handler,{width:(l=this._framebuffer)==null?void 0:l.width,height:(t=this._framebuffer)==null?void 0:t.height,useDepth:!1,targets:[{internalFormat:"RGBA",type:"UNSIGNED_BYTE",attachment:"COLOR_ATTACHMENT",readAsync:!0}]}),this._screenFramebuffer.init())}activate(){var l,t;super.activate(),this._dialog.appendTo(document.body),(l=this._dialog.container)==null||l.appendChild(this.$canvas),(t=this.renderer)==null||t.events.on("draw",this._onDraw)}deactivate(){var l;super.deactivate(),this._dialog.remove(),(l=this.renderer)==null||l.events.off("draw",this._onDraw)}},GeoImageDragControl:class extends K{constructor(l={}){super(l),this._cornerIndex=-1,this._catchCorner=!1,this._toggleBtn=new de({classList:["og-map-button","og-geoimagegrag_button"],icon:'<?xml version="1.0" encoding="UTF-8" standalone="no"?> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M16 13l6.964 4.062-2.973.85 2.125 3.681-1.732 1-2.125-3.68-2.223 2.15L16 13zm-2-7h2v2h5a1 1 0 0 1 1 1v4h-2v-3H10v10h4v2H9a1 1 0 0 1-1-1v-5H6v-2h2V9a1 1 0 0 1 1-1h5V6zM4 14v2H2v-2h2zm0-4v2H2v-2h2zm0-4v2H2V6h2zm0-4v2H2V2h2zm4 0v2H6V2h2zm4 0v2h-2V2h2zm4 0v2h-2V2h2z" fill="#000"/></svg>'})}oninit(){this._toggleBtn.appendTo(this.renderer.div),this.planet.events.on("layeradd",(l=>{this.isActive()&&this._bindLayer(l)}),this),this._toggleBtn.events.on("change",(l=>{l?this.activate():this.deactivate()}))}onactivate(){super.onactivate();const l=this.planet;for(let t=0;t<l.layers.length;t++)this._bindLayer(l.layers[t])}ondeactivate(){super.ondeactivate();const l=this.planet;for(let t=0;t<l.layers.length;t++)this._unbindLayer(l.layers[t])}_bindLayer(l){l instanceof mi&&(l.events.on("mousemove",this._onMouseMove,this),l.events.on("mouseleave",this._onMouseLeave,this),l.events.on("ldown",this._onLDown,this),l.events.on("lup",this._onLUp,this))}_unbindLayer(l){l instanceof mi&&(l.events.off("mousemove",this._onMouseMove),l.events.off("mouseleave",this._onMouseLeave),l.events.off("ldown",this._onLDown),l.events.off("lup",this._onLUp))}_onLUp(l){this._catchCorner=!1,l.renderer.controls.navigation.activate()}_onLDown(l){this._cornerIndex!==-1&&(this._catchCorner=!0,l.renderer.controls.navigation.deactivate())}_onMouseLeave(){document.body.style.cursor="auto"}_onMouseMove(l){let t=l.pickingObject;const i=this.planet;if(this._catchCorner){let s=t.getCornersLonLat();s[this._cornerIndex]=i.getLonLatFromPixelTerrain(l),t.setCornersLonLat(s)}else{this._cornerIndex=-1;for(let s=0;s<t._cornersWgs84.length;s++){let r=i.getLonLatFromPixelTerrain(l);if(r&&i.ellipsoid.getGreatCircleDistance(t._cornersWgs84[s],r)/i.getDistanceFromPixel(l)<=.05){this._cornerIndex=s,document.body.style.cursor="move";break}document.body.style.cursor="auto"}}}},GeoObjectEditor:class extends K{constructor(l={}){super(l),this._geoObjectEditopScene=new Fh({name:`geoObjectEditorScene:${this.__id}`}),this._dialog=new Uh({model:this._geoObjectEditopScene})}oninit(){this.renderer&&(this.renderer.addControl(new en({planet:this.planet})),this._geoObjectEditopScene.bindPlanet(this.planet),this._dialog.appendTo(this.renderer.div||document.body),this.activate())}onactivate(){this.renderer&&this.renderer.addNode(this._geoObjectEditopScene)}ondeactivate(){this.renderer&&this.renderer.removeNode(this._geoObjectEditopScene),this._dialog.hide()}},HeightRuler:Vr,KeyboardNavigation:class extends K{constructor(l={}){l=l||{},super({name:"KeyboardNavigation",...l}),this.onCameraPitchUp=()=>{this._camera&&this._camera.setPitch(this._camera.getPitch()+.1*G)},this.onCameraPitchDown=()=>{this._camera&&this._camera.setPitch(this._camera.getPitch()-.1*G)},this.onCameraYawLeft=()=>{this._camera&&this._camera.setYaw(this._camera.getYaw()-.1*G)},this.onCameraYawRight=()=>{this._camera&&this._camera.setYaw(this._camera.getYaw()+.1*G)},this.onCameraMoveForward=()=>{this._camera&&this.force.addA(this._camera.getForward()).normalize()},this.onCameraMoveBackward=()=>{this._camera&&this.force.addA(this._camera.getBackward()).normalize()},this._camera=l.camera||null,this.speed=l.speed||10,this.force=new v,this.vel=new v,this.mass=1}bindCamera(l){this._camera=l}onactivate(){let l=this.renderer;l.events.on("keypress",W.KEY_S,this.onCameraMoveBackward,this),l.events.on("keypress",W.KEY_W,this.onCameraMoveForward,this),l.events.on("keypress",W.KEY_UP,this.onCameraPitchUp,this),l.events.on("keypress",W.KEY_DOWN,this.onCameraPitchDown,this),l.events.on("keypress",W.KEY_LEFT,this.onCameraYawLeft,this),l.events.on("keypress",W.KEY_RIGHT,this.onCameraYawRight,this),l.events.on("draw",this.onDraw,this,-1e3)}ondeactivate(){this.renderer}oninit(){this.activate()}get dt(){return .001*this.renderer.handler.deltaTime}onDraw(){if(this.renderer&&this._camera){let l=this.force.scale(1/this.mass);this.vel.addA(l),this.vel.scale(.96),this.force.set(0,0,0);let t=this._camera;t.eye=t.eye.add(this.vel.scaleTo(this.dt)),t.update()}}},LayerAnimation:class extends K{constructor(l={}){super(l),this._currVisibleIndex=0,this._onViewchange=()=>{this._timeoutStart=performance.now()},this._onVisibilityChange=t=>{t||this.pause()},this._onLayerLoadend=t=>{let i=this._layersArr[this._currentIndex];if(i&&i.isEqual(t)){let s=this._getFrameIndex(this._currentIndex)*this._frameSize,r=this._currentIndex;for(let a=s;a<r;a++){let o=this._layersArr[a];o.opacity=0,o.setVisibility(!1)}i.opacity=1;let n=this._layersArr[this._currVisibleIndex];if(n){n.opacity=0,n.setVisibility(!1);let a=this._getFrameIndex(this._currVisibleIndex);this._getFrameIndex(this._currentIndex)!==a&&this._removeFrameFromPlanet(a)}this.events.dispatch(this.events.idle,i)}},this.events=le(ql),this._name=l.name||`layerAnimation-${this.__id}`,this._layersArr=l.layers?[].concat(l.layers):[],this._currentIndex=-1,this._playInterval=l.playInterval||120,this._playIntervalHandler=-1,this._playIndex=0,this._frameSize=l.frameSize||50,this.repeat=l.repeat==null||l.repeat,this.skipTimeout=l.skipTimeout||5e3,this._timeoutStart=0}_getFramesNum(){return Math.ceil(this._layersArr.length/this._frameSize)}_setFrame(l){for(let t=0,i=this._getFramesNum();t<i;t++)t!==l?this._removeFrameFromPlanet(t):this._appendFrameToPlanet(t)}_getFrameIndex(l){return Math.floor(l/this._frameSize)}_appendFrameToPlanet(l){if(this.planet){let t=l*this._frameSize,i=t+this._frameSize;for(let s=t,r=i>this._layersArr.length?this._layersArr.length:i;s<r;s++)this.planet.addLayer(this._layersArr[s])}}_removeFrameFromPlanet(l){if(this.planet){let t=l*this._frameSize,i=t+this._frameSize;for(let s=t,r=i>this._layersArr.length?this._layersArr.length:i;s<r;s++)this._layersArr[s].abortLoading(),this._layersArr[s].remove(),this._layersArr[s].setVisibility(!1)}}oninit(){super.oninit(),this.onactivate(),this._initLayers(),this.planet.events.on("layerloadend",this._onLayerLoadend),this._setCurrentIndexAsync(0,!1,!0)}onactivate(){super.onactivate(),this.planet.camera.events.on("viewchange",this._onViewchange),this.planet.renderer.handler.events.on("visibilitychange",this._onVisibilityChange)}ondeactivate(){super.ondeactivate(),this.planet.camera.events.off("viewchange",this._onViewchange);for(let l=0;l<this._layersArr.length;l++)this._layersArr[l].setVisibility(!1);this.planet.events.off("layerloadend",this._onLayerLoadend),this.planet.renderer.handler.events.off("visibilitychange",this._onVisibilityChange)}clear(){this.stop(),this._currentIndex=-1,this._currVisibleIndex=-1;let l=this._layersArr;this._layersArr=[];for(let t=0;t<l.length;t++)l[t].remove()}_initLayers(){if(this.planet){for(let l=0,t=this._layersArr.length;l<t;l++){let i=this._layersArr[l];i.setVisibility(!1),i.setBaseLayer(!1),i.opacity=0}this._appendFrameToPlanet(0)}}setLayers(l){this.clear(),this._layersArr=[].concat(l),this._initLayers()}appendLayer(l){var t;this._layersArr.push(l),l.setVisibility(!1),l.setBaseLayer(!1),l.opacity=0,(t=this.planet)==null||t.addLayer(l)}get isIdle(){let l=this._layersArr[this._currentIndex];return l&&l.isIdle||!l}get playInterval(){return this._playInterval}set playInterval(l){l!==this._playInterval&&(this._playInterval=l,this.isPlaying&&(this.pause(),this.play()))}get isPlaying(){return this._playIntervalHandler!==-1}get layers(){return this._layersArr}_checkEnd(){this._playIndex>this._layersArr.length&&(this.repeat?this._playIndex=0:this.pause())}play(){this.isPlaying||(this._currentIndex>=this._layersArr.length-1&&this.stop(),this._timeoutStart=performance.now(),this._playIntervalHandler=setInterval((()=>{this._checkEnd(),this._setCurrentIndexAsync(this._playIndex,!1,!1),requestAnimationFrame((()=>{(this.isIdle||performance.now()-this._timeoutStart>this.skipTimeout)&&(this._playIndex++,this._timeoutStart=performance.now())}))}),this._playInterval),this.events.dispatch(this.events.play))}stop(){this._playIndex>0&&(this._clearInterval(),this._playIndex=0,this.setCurrentIndex(0),this.events.dispatch(this.events.stop))}pause(){this.isPlaying&&(this._clearInterval(),this.events.dispatch(this.events.pause))}_clearInterval(){clearInterval(this._playIntervalHandler),this._playIntervalHandler=-1}setCurrentIndex(l,t=!1){this._setCurrentIndexAsync(l,!0,t)}_setCurrentIndexAsync(l,t=!1,i=!1){if(l!=this._currentIndex&&l>=0&&l<this._layersArr.length){let s=this._currentIndex;this._currentIndex=l,this._playIndex=l;let r=this._getFrameIndex(s),n=this._getFrameIndex(this._currentIndex),a=this._layersArr[s],o=this._layersArr[l],h=n!=r;h&&this._appendFrameToPlanet(n),a&&(a.isIdle?this._currVisibleIndex=s:(a.opacity=0,a.setVisibility(!1))),o&&(o.opacity=0,o.setVisibility(!0),requestAnimationFrame((()=>{if(o.isIdle||t){o.opacity=1,h&&this._removeFrameFromPlanet(r),a&&(a.opacity=0,a.setVisibility(!1));let c=this._layersArr[this._currVisibleIndex];c&&(c.opacity=0,c.setVisibility(!1))}})),i||this.events.dispatch(this.events.change,this._currentIndex,s))}}},LayerSwitcher:class extends K{constructor(l={}){super({name:"LayerSwitcher",...l}),this.addLayer=t=>{if(!t.hideInLayerSwitcher){let i=this._createLayerButton(t);this._layerViews.push(i),t.isBaseLayer()?i.appendTo(this.$baseLayers):i.appendTo(this.$overlays)}},this.removeLayer=t=>{for(let i=0;i<this._layerViews.length;i++){let s=this._layerViews[i];if(s.model.isEqual(t)){s.remove(),this._layerViews.splice(i,1);break}}},this._dialog=new it({title:"Layer Switcher",top:15,useHide:!0,visible:!1,width:300,maxHeight:500}),this._panel=new xe({template:`<div class="og-layerSwitcher">
      <div class="og-layerSwitcher__title">Base Layers</div>
      <div class="og-layerSwitcher__list og-layerSwitcher__baseLayers"></div>        
        
      <div class="og-layerSwitcher__title">Overlays</div>
      <div class="og-layerSwitcher__list og-layerSwitcher__overlays"></div>
         
    </div>`}),this._toggleBtn=new de({classList:["og-map-button","og-layerSwitcher_button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Svg Vector Icons : http://www.onlinewebfonts.com/icon -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 1000 1000" enable-background="new 0 0 1000 1000" xml:space="preserve">
<metadata> Svg Vector Icons : http://www.onlinewebfonts.com/icon </metadata>
<g><path d="M500,573.5c-3.2,0-6.5-0.6-9.5-1.9L25,375.6c-9.1-3.8-15-12.7-15-22.6s5.9-18.8,15-22.6l465.5-196c6.1-2.5,12.9-2.5,19,0l465.5,196c9.1,3.8,15,12.7,15,22.6s-5.9,18.8-15,22.6l-465.5,196C506.5,572.9,503.2,573.5,500,573.5L500,573.5z M97.6,353L500,522.4L902.4,353L500,183.6L97.6,353L97.6,353z"/><path d="M500,720.5c-3.2,0-6.5-0.6-9.5-1.9L25,522.6c-12.4-5.2-18.3-19.6-13.1-32.1c5.2-12.5,19.6-18.3,32.1-13.1l456,192l456-192c12.4-5.2,26.9,0.6,32.1,13.1s-0.6,26.9-13.1,32.1l-465.5,196C506.5,719.9,503.2,720.5,500,720.5L500,720.5z"/><path d="M500,867.5c-3.2,0-6.5-0.6-9.5-1.9L25,669.6c-12.4-5.2-18.3-19.6-13.1-32.1c5.2-12.5,19.6-18.3,32.1-13.1l456,192l456-192c12.4-5.2,26.9,0.6,32.1,13.1c5.2,12.5-0.6,26.8-13.1,32.1l-465.5,196C506.5,866.9,503.2,867.5,500,867.5L500,867.5z"/></g>
</svg>`}),this.$baseLayers=null,this.$overlays=null,this._layerViews=[]}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.planet.renderer.div),this._panel.appendTo(this._dialog.container),this.$baseLayers=this._panel.el.querySelector(".og-layerSwitcher__baseLayers"),this.$overlays=this._panel.el.querySelector(".og-layerSwitcher__overlays"),this._dialog.setPosition(this.planet.renderer.div.clientWidth-this._dialog.width-67),this._dialog.events.on("visibility",(l=>{this._toggleBtn.setActive(l)})),this._toggleBtn.events.on("change",(l=>{this._dialog.setVisibility(l)})),this.planet.events.on("layeradd",this.addLayer,this),this.planet.events.on("layerremove",this.removeLayer,this),this._initLayers()}_initLayers(){let l=this.planet.layers;for(let t=0;t<l.length;t++)this.addLayer(l[t])}_createLayerButton(l){return new Yl({model:l})}onactivate(){}ondeactivate(){this._dialog.hide()}},Lighting:class extends K{constructor(l={}){super(l),this._selectedLayer=null,this._toggleBtn=new de({classList:["og-map-button","og-lighting_button"],icon:`<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="256" height="256" viewBox="0 0 256 256" xml:space="preserve">

<defs>
</defs>
<g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
	<path d="M 45 68 c -12.682 0 -23 -10.317 -23 -23 c 0 -12.682 10.318 -23 23 -23 c 12.683 0 23 10.318 23 23 C 68 57.683 57.683 68 45 68 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 45 17.556 c -1.657 0 -3 -1.343 -3 -3 V 3 c 0 -1.657 1.343 -3 3 -3 c 1.657 0 3 1.343 3 3 v 11.556 C 48 16.212 46.657 17.556 45 17.556 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 45 90 c -1.657 0 -3 -1.343 -3 -3 V 75.444 c 0 -1.657 1.343 -3 3 -3 c 1.657 0 3 1.343 3 3 V 87 C 48 88.657 46.657 90 45 90 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 14.556 48 H 3 c -1.657 0 -3 -1.343 -3 -3 c 0 -1.657 1.343 -3 3 -3 h 11.556 c 1.657 0 3 1.343 3 3 C 17.556 46.657 16.212 48 14.556 48 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 87 48 H 75.444 c -1.657 0 -3 -1.343 -3 -3 c 0 -1.657 1.343 -3 3 -3 H 87 c 1.657 0 3 1.343 3 3 C 90 46.657 88.657 48 87 48 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 66.527 26.473 c -0.768 0 -1.535 -0.293 -2.121 -0.878 c -1.172 -1.172 -1.172 -3.071 0 -4.243 l 8.171 -8.171 c 1.172 -1.172 3.07 -1.171 4.242 0 c 1.172 1.172 1.172 3.071 0 4.243 l -8.171 8.171 C 68.063 26.18 67.295 26.473 66.527 26.473 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 15.302 77.698 c -0.768 0 -1.536 -0.293 -2.121 -0.879 c -1.172 -1.171 -1.172 -3.071 0 -4.242 l 8.171 -8.171 c 1.171 -1.172 3.071 -1.172 4.242 0 c 1.172 1.171 1.172 3.071 0 4.242 l -8.171 8.171 C 16.837 77.405 16.069 77.698 15.302 77.698 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 23.473 26.473 c -0.768 0 -1.536 -0.293 -2.121 -0.878 l -8.171 -8.171 c -1.172 -1.172 -1.172 -3.071 0 -4.243 c 1.172 -1.172 3.072 -1.171 4.243 0 l 8.171 8.171 c 1.172 1.172 1.172 3.071 0 4.243 C 25.008 26.18 24.24 26.473 23.473 26.473 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 74.698 77.698 c -0.768 0 -1.535 -0.293 -2.121 -0.879 l -8.171 -8.171 c -1.172 -1.171 -1.172 -3.071 0 -4.242 c 1.172 -1.172 3.07 -1.172 4.242 0 l 8.171 8.171 c 1.172 1.171 1.172 3.071 0 4.242 C 76.233 77.405 75.466 77.698 74.698 77.698 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
</g>
</svg>`}),this._dialog=new it({title:"Lighting Parameters",visible:!1,useHide:!0,top:60,left:60,width:600}),this._dialog.events.on("visibility",(t=>{this._toggleBtn.setActive(t)})),this._panel=new xe({template:`<div class="og-lighing og-options-container">

         <div class="og-option">
           <div class="og-suncontrol"></div>
         </div>        
         
         <div class="og-option og-atmosphere-opacity">
         </div>
         
         <div class="og-option og-simpleskybackground">
         </div>
         
        <div class="og-lighting-emptyline"></div>

         <div class="og-option og-gamma"></div>         
         <div class="og-option og-exposure"></div>
       
        <div class="og-lighting-emptyline"></div>

         <div class="og-option">
         <div class="og-layers">
           <div class="og-caption">Select layer:</div>
           <select id="layers"></select>
         </div>
         </div>

         <div class="og-option og-opacity">
         </div>
         
         <div class="og-option og-night">
         </div>
         
         <div class="og-lighting-emptyline"></div>

         <div class="og-option og-diffuse">
         </div>
      
         <div class="og-option og-ambient">
         </div>

         <div class="og-option og-specular">
         </div>        

    </div>`}),this.$gamma=null,this.$exposure=null,this.$night=null,this.$opacity=null,this.$diffuse=null,this.$ambient=null,this.$specular=null,this.$atmosphereOpacity=null,this.$simpleSkyBackground=null,this._atmosphereMaxOpacity=new Z({label:"Max.opacity",max:5}),this._atmosphereMinOpacity=new Z({label:"Min.opacity",max:5}),this._simpleSkyBackgroundColorOne=new Dr({label:"Color One"}),this._simpleSkyBackgroundColorTwo=new Dr({label:"Color Two"}),this._gamma=new Z({label:"Gamma",max:5}),this._exposure=new Z({label:"Exposure",max:5}),this._night=new Z({label:"Nightlight",max:5}),this._opacity=new Z({label:"Opacity",max:1}),this._diffuse_r=new Z({label:"Diffuse R",max:5}),this._diffuse_g=new Z({label:"Diffuse G",max:5}),this._diffuse_b=new Z({label:"Diffuse B",max:5}),this._ambient_r=new Z({label:"Ambient R",max:5}),this._ambient_g=new Z({label:"Ambient G",max:5}),this._ambient_b=new Z({label:"Ambient B",max:5}),this._specular_r=new Z({label:"Specular R",max:.2}),this._specular_g=new Z({label:"Specular G",max:.2}),this._specular_b=new Z({label:"Specular B",max:.2}),this._shininess=new Z({label:"Shininess",max:100})}bindLayer(l){this._selectedLayer=l,this._opacity.value=l.opacity,this._update()}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.renderer.div),this._panel.appendTo(this._dialog.container),this._panel.el&&(this.$atmosphereOpacity=this._panel.el.querySelector(".og-atmosphere-opacity"),this.$simpleSkyBackground=this._panel.el.querySelector(".og-simpleskybackground"),this.$gamma=this._panel.el.querySelector(".og-option.og-gamma"),this.$exposure=this._panel.el.querySelector(".og-option.og-exposure"),this.$opacity=this._panel.el.querySelector(".og-option.og-opacity"),this.$diffuse=this._panel.el.querySelector(".og-option.og-diffuse"),this.$ambient=this._panel.el.querySelector(".og-option.og-ambient"),this.$specular=this._panel.el.querySelector(".og-option.og-specular"),this.$night=this._panel.el.querySelector(".og-option.og-night")),this._toggleBtn.events.on("change",(a=>{this._dialog.setVisibility(a)}));let l=this._dialog.select(".og-suncontrol"),t=new de({classList:["og-suncontrol-button"],isActive:!0,icon:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 122.88 70.41" style="enable-background:new 0 0 122.88 70.41" xml:space="preserve"><g><path d="M60.91,19.12c6.95,0,13.24,2.95,17.8,7.72c4.55,4.77,7.37,11.37,7.37,18.64c0,1.94-0.2,3.83-0.58,5.65h31.61 c2.1,0,2.62,1.16,2.62,2.59c0,1.43-0.52,2.59-2.62,2.59H7.09c-2.1,0-2.62-1.16-2.62-2.59c0-1.43,0.52-2.59,2.62-2.59h29.23 c-0.38-1.82-0.58-3.71-0.58-5.65c0-7.28,2.82-13.87,7.37-18.64C47.67,22.08,53.96,19.12,60.91,19.12L60.91,19.12L60.91,19.12z M63.4,70.41c-2.1,0-2.62-1.16-2.62-2.59s0.52-2.59,2.62-2.59h56.86c2.1,0,2.62,1.16,2.62,2.59s-0.52,2.59-2.62,2.59H63.4 L63.4,70.41z M2.62,70.41c-2.1,0-2.62-1.16-2.62-2.59s0.52-2.59,2.62-2.59h29.51c2.1,0,2.62,1.16,2.62,2.59s-0.52,2.59-2.62,2.59 H2.62L2.62,70.41z M38.39,9.46c-0.78-1.35-0.32-3.07,1.03-3.85c1.35-0.78,3.07-0.32,3.85,1.03l3.62,6.27 c0.78,1.35,0.32,3.07-1.03,3.85c-1.35,0.78-3.07,0.32-3.85-1.03L38.39,9.46L38.39,9.46L38.39,9.46z M58.67,2.83 c0-1.56,1.27-2.83,2.83-2.83c1.56,0,2.83,1.27,2.83,2.83v7.24c0,1.56-1.27,2.83-2.83,2.83c-1.56,0-2.83-1.26-2.83-2.83V2.83 L58.67,2.83L58.67,2.83z M79.56,7.23c0.77-1.35,2.49-1.81,3.84-1.04c1.35,0.77,1.81,2.49,1.04,3.84l-3.62,6.27 c-0.77,1.35-2.49,1.81-3.84,1.04c-1.35-0.77-1.81-2.49-1.04-3.84L79.56,7.23L79.56,7.23L79.56,7.23z M95.45,21.48 c1.35-0.78,3.07-0.32,3.85,1.03c0.78,1.35,0.32,3.07-1.03,3.85L92,29.98c-1.35,0.78-3.07,0.32-3.85-1.03 c-0.78-1.35-0.32-3.07,1.03-3.85L95.45,21.48L95.45,21.48L95.45,21.48z M102.08,41.76c1.56,0,2.83,1.27,2.83,2.83 c0,1.56-1.27,2.83-2.83,2.83h-7.24c-1.56,0-2.83-1.26-2.83-2.83s1.26-2.83,2.83-2.83H102.08L102.08,41.76L102.08,41.76z M19.74,46.25c-1.56,0-2.83-1.27-2.83-2.83c0-1.56,1.27-2.83,2.83-2.83h7.24c1.56,0,2.83,1.26,2.83,2.83s-1.27,2.83-2.83,2.83 H19.74L19.74,46.25L19.74,46.25z M24.14,25.35c-1.35-0.77-1.81-2.49-1.04-3.84c0.77-1.35,2.49-1.81,3.84-1.04l6.27,3.62 c1.35,0.77,1.81,2.49,1.04,3.84c-0.77,1.35-2.49,1.81-3.84,1.04L24.14,25.35L24.14,25.35L24.14,25.35z"/></g></svg>',title:"Star/stop the Sun from following the camera"});t.appendTo(l);let i=new de({classList:["og-suncontrol-button"],isActive:!0,icon:`<?xml version="1.0"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <path style="text-indent:0;text-align:start;line-height:normal;text-transform:none;block-progression:tb;-inkscape-font-specification:Sans" d="M 16 4 C 9.3844277 4 4 9.3844277 4 16 C 4 22.615572 9.3844277 28 16 28 C 22.615572 28 28 22.615572 28 16 C 28 9.3844277 22.615572 4 16 4 z M 16 6 C 16.389823 6 16.778223 6.0506339 17.15625 6.09375 C 18.631659 7.6568432 21 10.9245 21 16 C 21 21.0755 18.631659 24.343157 17.15625 25.90625 C 16.778223 25.949366 16.389823 26 16 26 C 10.465308 26 6 21.534692 6 16 C 6 10.465308 10.465308 6 16 6 z" overflow="visible" font-family="Sans"/>
</svg>
`,title:"Activate/deactivate the Sun current time positioning"});i.appendTo(l),t.events.on("change",(a=>{const o=this.planet.renderer.controls.sun;a?o.start():o.stop()})),i.events.on("change",(a=>{const o=this.planet.renderer.controls.sun;a?o.activate():o.deactivate()}));let s=new de({classList:["og-suncontrol-button"],isActive:this.planet.lightEnabled,icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Generated by IcoMoon.io -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="512" height="512" viewBox="0 0 512 512">
<g>
</g>
	<path d="M257.894 156.948c-53.258 0-96.42 43.561-96.42 97.26 0 53.719 43.161 97.249 96.42 97.249 53.197 0 96.379-43.53 96.379-97.25 0-53.698-43.182-97.26-96.379-97.26zM257.894 309.873c-30.464 0-55.163-24.945-55.163-55.665s24.699-55.624 55.163-55.624c30.423 0 55.101 24.904 55.101 55.624s-24.688 55.665-55.101 55.665z" fill="#000000" />
	<path d="M241.808 43.499h32.144v79.575h-32.144v-79.575z" fill="#000000" />
	<path d="M417.209 115.897l-22.723-22.917-55.757 56.279 22.723 22.907z" fill="#000000" />
	<path d="M389.468 238.407h78.899v32.389h-78.899v-32.389z" fill="#000000" />
	<path d="M396.012 416.86l22.723-22.917-55.767-56.259-22.712 22.897z" fill="#000000" />
	<path d="M242.473 388.915h32.144v79.575h-32.144v-79.575z" fill="#000000" />
	<path d="M96.266 396.073l22.722 22.938 55.778-56.289-22.692-22.928z" fill="#000000" />
	<path d="M43.633 240.537h78.879v32.43h-78.879v-32.43z" fill="#000000" />
	<path d="M115.394 93.051l-22.681 22.907 55.757 56.258 22.702-22.917z" fill="#000000" />
</svg>`,title:"Enable/disable planet lighting"});s.appendTo(l),s.events.on("change",(a=>{this.planet.lightEnabled=a}));let r=new de({classList:["og-suncontrol-button"],isActive:this.planet.atmosphereEnabled,icon:`<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path fill="#000000" d="M135.688 18.5c-6.798 74.842-23.842 85.39-107.907 59.656 84.85 52.022 73.57 64.954-6.843 96.938 87.743-10.27 103.29 4.89 70.75 87.594 17.805-27.56 32.5-44.498 46.282-54.47-11.813 28.26-18.345 59.274-18.345 91.813 0 84.184 43.71 157.96 109.656 200.376-41.624-43.834-67.686-102.7-67.686-167.875 0-134.923 109.45-244.405 244.375-244.405 30.92 0 60.76 5.762 88 16.25-38.584-26.87-85.517-42.625-136.064-42.625-55.257 0-106.14 18.802-146.562 50.375 4.627-18.783 17.39-38.073 41.03-60.906C190.18 90.942 153.53 95.634 135.69 18.5zm10.03 77.188c5.67.002 11.428 1.247 16.876 3.874 14.506 6.998 22.72 21.81 22 36.938-10.26 10.87-19.507 22.696-27.594 35.344-9.035 2.753-19.075 2.27-28.25-2.156-19.37-9.343-27.5-32.6-18.156-51.97 6.715-13.92 20.638-22.036 35.125-22.03z"/></svg>`,title:"Enable/disable atmosphere scattering"});r.appendTo(l),this.planet.atmosphereEnabled?(this.$atmosphereOpacity.style.display="block",this.$simpleSkyBackground.style.display="none"):(this.$atmosphereOpacity.style.display="none",this.$simpleSkyBackground.style.display="flex"),r.events.on("change",(a=>{this.planet.atmosphereEnabled=a,this.planet.atmosphereEnabled?(this.$atmosphereOpacity.style.display="block",this.$simpleSkyBackground.style.display="none"):(this.$atmosphereOpacity.style.display="none",this.$simpleSkyBackground.style.display="flex")})),this._atmosphereMaxOpacity.appendTo(this.$atmosphereOpacity),this._atmosphereMinOpacity.appendTo(this.$atmosphereOpacity),this._simpleSkyBackgroundColorOne.appendTo(this.$simpleSkyBackground),this._simpleSkyBackgroundColorTwo.appendTo(this.$simpleSkyBackground),this._gamma.appendTo(this.$gamma),this._exposure.appendTo(this.$exposure),this._night.appendTo(this.$night),this._opacity.appendTo(this.$opacity),this._diffuse_r.appendTo(this.$diffuse),this._diffuse_g.appendTo(this.$diffuse),this._diffuse_b.appendTo(this.$diffuse),this._ambient_r.appendTo(this.$ambient),this._ambient_g.appendTo(this.$ambient),this._ambient_b.appendTo(this.$ambient),this._specular_r.appendTo(this.$specular),this._specular_g.appendTo(this.$specular),this._specular_b.appendTo(this.$specular),this._shininess.appendTo(this.$specular),this._gamma.value=this.planet.renderer.gamma,this._gamma.events.on("change",(a=>{this.planet.renderer.gamma=a})),this._exposure.value=this.planet.renderer.exposure,this._exposure.events.on("change",(a=>{this.planet.renderer.exposure=a})),this._atmosphereMinOpacity.value=this.planet.atmosphereMinOpacity,this._atmosphereMinOpacity.events.on("change",(a=>{this.planet.atmosphereMinOpacity=a})),this._atmosphereMaxOpacity.value=this.planet.atmosphereMaxOpacity,this._atmosphereMaxOpacity.events.on("change",(a=>{this.planet.atmosphereMaxOpacity=a,this.planet.renderer.controls.Atmosphere.opacity=a}));let n=this.planet.renderer.controls.SimpleSkyBackground;n&&(this._simpleSkyBackgroundColorOne.value=n.colorOne,this._simpleSkyBackgroundColorTwo.value=n.colorTwo),this._simpleSkyBackgroundColorOne.events.on("input",(a=>{let o=this.planet.renderer.controls.SimpleSkyBackground;o&&(o.colorOne=a)})),this._simpleSkyBackgroundColorTwo.events.on("input",(a=>{let o=this.planet.renderer.controls.SimpleSkyBackground;o&&(o.colorTwo=a)})),this._panel.el.querySelector("#layers").addEventListener("change",(a=>{const o=this.planet.getLayerByName(a.target.value);o&&this.bindLayer(o)})),this._night.events.on("change",(a=>{this._selectedLayer&&(this._selectedLayer.nightTextureCoefficient=a)})),this._opacity.events.on("change",(a=>{this._selectedLayer&&(this._selectedLayer.opacity=a)})),this._ambient_r.events.on("change",(a=>{this._selectedLayer&&this._selectedLayer._ambient&&(this._selectedLayer._ambient[0]=a)})),this._ambient_g.events.on("change",(a=>{this._selectedLayer&&this._selectedLayer._ambient&&(this._selectedLayer._ambient[1]=a)})),this._ambient_b.events.on("change",(a=>{this._selectedLayer&&this._selectedLayer._ambient&&(this._selectedLayer._ambient[2]=a)})),this._diffuse_r.events.on("change",(a=>{this._selectedLayer&&this._selectedLayer._diffuse&&(this._selectedLayer._diffuse[0]=a)})),this._diffuse_g.events.on("change",(a=>{this._selectedLayer&&this._selectedLayer._diffuse&&(this._selectedLayer._diffuse[1]=a)})),this._diffuse_b.events.on("change",(a=>{this._selectedLayer&&this._selectedLayer._diffuse&&(this._selectedLayer._diffuse[2]=a)})),this._specular_r.events.on("change",(a=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[0]=a)})),this._specular_g.events.on("change",(a=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[1]=a)})),this._specular_b.events.on("change",(a=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[2]=a)})),this._shininess.events.on("change",(a=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[3]=a)})),this.planet&&(this.planet.events.on("layeradd",this._onLayerAdd,this),this.planet.events.on("layerremove",this._onLayerRemove,this)),this._fetchLayers()}_update(){let l=this._selectedLayer;this._opacity.value=l&&l.opacity?l.opacity:0,this._night.value=l&&l.nightTextureCoefficient?l.nightTextureCoefficient:this.planet.nightTextureCoefficient;let t=l&&l._ambient?l._ambient:this.planet._ambient;this._ambient_r.value=t[0],this._ambient_g.value=t[1],this._ambient_b.value=t[2];let i=l&&l._diffuse?l._diffuse:this.planet._diffuse;this._diffuse_r.value=i[0],this._diffuse_g.value=i[1],this._diffuse_b.value=i[2];let s=l&&l._specular?l._specular:this.planet._specular;this._specular_r.value=s[0],this._specular_g.value=s[1],this._specular_b.value=s[2],this._shininess.value=s[3]}_fetchLayers(){if(this.planet)for(let l=0;l<this.planet.layers.length;l++)this._onLayerAdd(this.planet.layers[l])}_onLayerAdd(l){this.bindLayer(l);let t=document.createElement("option");t.value=l.name,t.innerText=l.name,this._panel.el.querySelector("#layers").appendChild(t),this._panel.el.querySelector("#layers").value=l.name}_onLayerRemove(l){}},Navigation:Ii,Object3dManager:class extends K{constructor(l={}){super(l),this._onSelect=t=>{this._currentItem=t},this._onClick=t=>{if(!this.planet||!this._layer||!this._currentItem)return;let i=this.planet.getLonLatFromPixelTerrain(t.pos);if(i&&(this.renderer.setRelativeCenter(this.planet.camera.eye),this.renderer.events.isKeyPressed(W.KEY_CTRL))){let s=this._createEntity(this._currentItem,i);this._layer.add(s)}},this._layer=l.layer||null,this._currentItem=null,this._collection=new hr({collection:l.collection}),this._dialog=new Xh({model:this._collection})}oninit(){this.renderer&&(this._dialog.appendTo(this.renderer.div||document.body),this._dialog.events.on("select",this._onSelect),this.activate())}onactivate(){this._dialog.show(),this._initEvents()}ondeactivate(){this._dialog.hide(),this._clearEvents()}bindLayer(l){this._layer=l}_initEvents(){this.planet&&this.planet.renderer&&this.planet.renderer.events.on("lclick",this._onClick)}_clearEvents(){this.planet&&this.planet.renderer&&this.planet.renderer.events.off("lclick",this._onClick)}_createEntity(l,t){let i=l.name,s=l.scale,r=new U({lonlat:t,pitch:0,yaw:0,roll:0,scale:s});for(let n=0;n<l.objects.length;n++){let a=l.objects[n],o=new U({forceGlobalPosition:!0,forceGlobalRotation:!0,forceGlobalScale:!0,geoObject:{tag:`${i}:${n.toString()}`,object3d:a}});r.appendChild(o)}return r}},OldMouseNavigation:nr,Ruler:so,RulerSwitcher:class extends K{constructor(l={}){super({name:"RulerSwitcher",...l}),this.ruler=new Vr({ignoreTerrain:l.ignoreTerrain})}oninit(){this.planet.addControl(this.ruler),this._createMenuBtn()}onactivate(){this.ruler.activate()}ondeactivate(){this.ruler.deactivate()}_createMenuBtn(){let l=new de({classList:["og-map-button","og-ruler_button"],icon:`<?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" height="800px" width="800px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 512 512" xml:space="preserve">
<g>
	<g>
		<path d="M369.151,0L0.001,369.15L142.85,512l369.149-369.15L369.151,0z M47.286,369.15l10.908-10.908l47.782,47.782l23.642-23.642
			L81.837,334.6l10.909-10.909l23.711,23.711L140.1,323.76l-23.711-23.711l10.909-10.909l23.711,23.711l23.642-23.642
			l-23.711-23.711l10.909-10.909l47.782,47.782l23.642-23.642l-47.782-47.782l10.908-10.908l23.71,23.71l23.642-23.642l-23.71-23.71
			l10.908-10.908l23.711,23.711l23.642-23.642l-23.711-23.711l10.909-10.909l47.782,47.782l23.642-23.642l-47.782-47.782
			l10.908-10.908l23.71,23.711l23.642-23.642l-23.711-23.71L334.6,81.837l23.711,23.71l23.642-23.642l-23.711-23.712l10.908-10.908
			l95.564,95.564L142.85,464.714L47.286,369.15z"/>
	</g>
</g>
</svg>`});l.appendTo(this.renderer.div),l.events.on("change",(t=>{t?this.onactivate():this.ondeactivate()}))}},ScaleControl:ro,Selection:class extends K{constructor(l={}){super(l),this._selectorScene=new rh({name:`selectionScene:${this.__id}`,ignoreTerrain:l.ignoreTerrain,onSelect:l.onSelect,autoSelectionHide:l.autoSelectionHide}),this._toggleBtn=new de({classList:["og-map-button","og-selection_button"],icon:`<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--gis" preserveAspectRatio="xMidYMid meet"><path d="M2.1 0v1.914H0v6h3V3h5.1V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h1.8v1.2h3V0h-4.8zm1.8 7.2v6h3v-6h-3zM0 10.913v6h3v-6H0zM66.9 16.2v6h3v-6h-3zM0 19.914v6h3v-6H0zM66.9 25.2v6h3v-6h-3zM0 28.914v6h3v-6H0zM66.9 34.2v6h3v-6h-3zM0 37.914v6h3v-6H0zM66.9 43.2v6h3v-6h-3zM0 46.914v6h3v-6H0zM66.9 52.2v6h3v-6h-3zM0 55.914v5.191h3.809v-3H3v-2.19H0zm6.809 2.191v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9.648 1.899a2.076 2.076 0 0 0-2.19 2.324l3.137 33.676c.2 1.635 2.135 2.399 3.397 1.34l6.623-5.371l2.969 5.142c1.707 2.958 4.417 3.684 7.375 1.977c2.957-1.708 3.684-4.417 1.976-7.375l-2.959-5.125l7.848-3.008c1.548-.564 1.855-2.62.539-3.611L71.576 60.416a2.073 2.073 0 0 0-1.119-.412z" fill="#000000"></path></svg>`})}set ignoreTerrain(l){this._selectorScene.ignoreTerrain=l}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._toggleBtn.events.on("change",(l=>{l?this.activate():this.deactivate()})),this._selectorScene.bindPlanet(this.planet)}onactivate(){this.renderer.addNode(this._selectorScene)}ondeactivate(){this.renderer.removeNode(this._selectorScene)}},ShowFps:class extends K{constructor(l){super(l)}oninit(){let l=document.createElement("div");l.className="defaultText ",l.id="ogShowFpsControl",document.body.appendChild(l),this.renderer.events.on("draw",this._draw,this)}_draw(){Rn("ogShowFpsControl",(1e3/this.renderer.handler.deltaTime).toFixed(1),this.renderer.handler.canvas.clientWidth-60,0)}},SimpleNavigation:class extends K{constructor(l={}){super({name:"SimpleNavigation",autoActivate:!0,...l}),this.focusVel=0,this.focusForce=0,this._nx=0,this._ny=0,this._onMouseLeftButtonDown=t=>{if(this._active&&this.renderer){if(this.stop(),this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"),this._grabbedPoint=this.renderer.getCartesianFromPixel(t),this._grabbedScreenPoint.set(t.nx,t.ny),!this._grabbedPoint){let i=this.renderer.activeCamera,s=new v,r=new v(1,0,0),n=new v(0,0,1),a=new v;new V(i.eye,t.direction).hitPlaneRes(pe.fromPoints(s,r,n),a)===V.INSIDE&&(this._grabbedPoint=a)}this._grabbedPoint&&this._eye0.copy(this.renderer.activeCamera.eye)}},this._onMouseLeftButtonUp=t=>{this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner"),t.x===t.prev_x&&(t.y,t.prev_y)},this._onMouseLeftButtonHold=t=>{if(this.renderer&&this._grabbedPoint&&t.moving){let i=this.renderer.activeCamera;if(i.isOrthographic){let s=t.nx-this._grabbedScreenPoint.x,r=t.ny-this._grabbedScreenPoint.y,n=i.frustum,a=-(n.right-n.left)*s,o=(n.top-n.bottom)*r,h=i.getUp().scale(o),c=i.getRight().scale(a);i.eye=this._eye0.add(c.add(h))}else{let s,r,n=Math.abs(i.getForward().dot(v.UP)),a=this._grabbedPoint;n>.7?(s=v.add(a,v.LEFT),r=v.add(a,i.getRight())):(s=v.add(a,i.getRight()),r=v.add(a,v.UP));let o=new v;new V(i.eye,t.direction).hitPlaneRes(pe.fromPoints(a,s,r),o)===V.INSIDE&&(i.eye=i.eye.add(a.sub(o)))}i.update()}},this._onRHold=t=>{if(this._lookPos&&t.moving&&this.renderer){const i=this.renderer.activeCamera;this.renderer.controlsBag.scaleRot=1;let s=.5/i.eye.distance(this._lookPos)*G;s>.007?s=.007:s<.003&&(s=.003),i.rotateHorizontal(s*(t.x-t.prev_x),!1,this._lookPos,this._up),i.rotateVertical(s*(t.y-t.prev_y),this._lookPos),i.update()}},this._onRDown=t=>{if(this.renderer)if(this.stop(),this._lookPos=this.renderer.getCartesianFromPixel(t.pos),this._lookPos)this._up=v.UP;else{const i=this.renderer.activeCamera;let s=new pe(v.ZERO,v.UP),r=new V(i.eye,t.direction);this._lookPos=new v,r.hitPlaneRes(s,this._lookPos),this._up=v.UP}},this._onMouseWheel=t=>{if(this.renderer){let i=this.renderer.activeCamera;if(i.isOrthographic){let s=i.frustums[0],r=-(s.right-s.left)*(.5-t.nx),n=(s.top-s.bottom)*(.5-t.ny),a=i.getUp().scale(n),o=i.getRight().scale(r),h=i.eye.add(o.add(a));this._wheelPos=h.add(i.getForward()),this._wheelDist=1,this._nx=t.nx,this._ny=t.ny,this.focusForce=.05*t.wheelDelta}else{let s=this.renderer.getCartesianFromPixel(t);if(!s){s=new v;let a=new pe(v.ZERO,v.UP);new V(i.eye,t.direction).hitPlaneRes(a,s)}let r=s.sub(i.eye).normalize(),n=8*i.eye.distance(s);this.force.addA(r.scale(t.wheelDelta)).normalize().scale(n)}}},this.onCameraMoveForward=()=>{this.force.addA(this.renderer.activeCamera.getForward()).normalize()},this.onCameraMoveBackward=()=>{this.force.addA(this.renderer.activeCamera.getBackward()).normalize()},this.onCameraStrifeLeft=()=>{this.force.addA(this.renderer.activeCamera.getLeft()).normalize()},this.onCameraStrifeRight=()=>{this.force.addA(this.renderer.activeCamera.getRight()).normalize()},this.onCameraLookUp=()=>{this.renderer.activeCamera.update()},this.onCameraLookDown=()=>{this.renderer.activeCamera.update()},this.onCameraTurnLeft=()=>{this.renderer.activeCamera.update()},this.onCameraTurnRight=()=>{this.renderer.activeCamera.update()},this.onCameraRollLeft=()=>{this.renderer.activeCamera.update()},this.onCameraRollRight=()=>{this.renderer.activeCamera.update()},this.speed=l.speed||1,this.force=new v,this.vel=new v,this.mass=1,this._lookPos=void 0,this._grabbedPoint=void 0,this._grabbedScreenPoint=new H,this._up=null,this._eye0=new v,this._wheelDist=0,this._wheelPos=new v}oninit(){}onactivate(){super.onactivate();let l=this.renderer;l.activeCamera.isOrthographic&&l.getDepthMinDistanceAsync().then((t=>{l.activeCamera.focusDistance=t})),l.events.on("mousewheel",this._onMouseWheel),l.events.on("keypress",W.KEY_W,this.onCameraMoveForward,this),l.events.on("keypress",W.KEY_S,this.onCameraMoveBackward,this),l.events.on("keypress",W.KEY_A,this.onCameraStrifeLeft,this),l.events.on("keypress",W.KEY_D,this.onCameraStrifeRight,this),l.events.on("keypress",W.KEY_UP,this.onCameraLookUp,this),l.events.on("keypress",W.KEY_DOWN,this.onCameraLookDown,this),l.events.on("keypress",W.KEY_LEFT,this.onCameraTurnLeft,this),l.events.on("keypress",W.KEY_RIGHT,this.onCameraTurnRight,this),l.events.on("keypress",W.KEY_Q,this.onCameraRollLeft,this),l.events.on("keypress",W.KEY_E,this.onCameraRollRight,this),l.events.on("rhold",this._onRHold,this),l.events.on("rdown",this._onRDown,this),l.events.on("lhold",this._onMouseLeftButtonHold),l.events.on("ldown",this._onMouseLeftButtonDown),l.events.on("lup",this._onMouseLeftButtonUp),l.events.on("draw",this.onDraw,this,-1e3)}ondeactivate(){super.ondeactivate();let l=this.renderer;l.events.off("mousewheel",this._onMouseWheel),l.events.off("keypress",W.KEY_W,this.onCameraMoveForward),l.events.off("keypress",W.KEY_S,this.onCameraMoveBackward),l.events.off("keypress",W.KEY_A,this.onCameraStrifeLeft),l.events.off("keypress",W.KEY_D,this.onCameraStrifeRight),l.events.off("keypress",W.KEY_UP,this.onCameraLookUp),l.events.off("keypress",W.KEY_DOWN,this.onCameraLookDown),l.events.off("keypress",W.KEY_LEFT,this.onCameraTurnLeft),l.events.off("keypress",W.KEY_RIGHT,this.onCameraTurnRight),l.events.off("keypress",W.KEY_Q,this.onCameraRollLeft),l.events.off("keypress",W.KEY_E,this.onCameraRollRight),l.events.off("rhold",this._onRHold),l.events.off("rdown",this._onRDown),l.events.off("lhold",this._onMouseLeftButtonHold),l.events.off("ldown",this._onMouseLeftButtonDown),l.events.off("lup",this._onMouseLeftButtonUp),l.events.off("draw",this.onDraw)}_handleMouseWheel(){let l=this.renderer.activeCamera;if(l.isOrthographic&&Math.abs(this.focusVel)>.01){l.eye=this._wheelPos.add(l.getBackward().scale(this._wheelDist)),l.focusDistance-=l.focusDistance*this.focusVel*this.dt;let t=l.frustums[0],i=(t.right-t.left)*(.5-this._nx),s=-(t.top-t.bottom)*(.5-this._ny),r=l.getUp().scale(s),n=l.getRight().scale(i);l.eye.addA(n.add(r)),l.update()}else this.vel.length()>.01&&(l.eye=l.eye.add(this.vel.scaleTo(this.dt)),l.update())}onDraw(){this._updateVel(),this._handleMouseWheel()}get dt(){return .001*this.renderer.handler.deltaTime}_updateVel(){let l=this.force.scale(1/this.mass);this.vel.addA(l),this.vel.scale(.77),this.force.set(0,0,0),this.focusVel+=this.focusForce,this.focusVel*=.77,this.focusForce=0}stop(){this.focusVel=0,this.vel.clear()}},SimpleSkyBackground:no,Sun:Ns,TimelineControl:class extends K{constructor(l={}){super({name:"timeline",...l});let t=l.current||new Date,i=l.rangeStart||qr(t,-12),s=l.rangeEnd||qr(t,12);this._timelineView=new uh({rangeStart:i,rangeEnd:s,currentDate:t}),this._toggleBtn=new de({classList:["og-map-button","og-timeline_button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Svg Vector Icons : http://www.onlinewebfonts.com/icon -->
    <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 1000 1000" enable-background="new 0 0 1000 1000" xml:space="preserve">
    <metadata> Svg Vector Icons : http://www.onlinewebfonts.com/icon </metadata>
    <g><path d="M500,10C229.4,10,10,229.4,10,500s219.4,490,490,490s490-219.4,490-490S770.6,10,500,10z M800.3,800.3c-39,39-84.5,69.7-135,91C613,913.5,557.4,924.7,500,924.7s-112.9-11.2-165.3-33.3c-50.5-21.3-95.9-52-135-91c-39-39-69.7-84.5-91-135C86.5,612.9,75.3,557.4,75.3,500s11.2-112.9,33.3-165.3c21.3-50.5,52-95.9,91-135c39-39,84.5-69.7,135-91C387.1,86.5,442.6,75.3,500,75.3s112.9,11.2,165.3,33.3c50.5,21.3,95.9,52,135,91c39,39,69.7,84.5,91,135c22.1,52.3,33.3,107.9,33.3,165.3s-11.2,112.9-33.3,165.3C869.9,715.8,839.3,761.2,800.3,800.3z"/><path d="M761.3,532.7H532.7V304c0-18.1-14.6-32.7-32.7-32.7s-32.7,14.6-32.7,32.7v261.3l0,0c0,18.1,14.6,32.7,32.7,32.7h261.3c18.1,0,32.7-14.6,32.7-32.7l0,0C794,547.3,779.4,532.7,761.3,532.7z"/></g>
</svg>`}),this._dialog=new it({title:"Timeline",visible:!1,resizable:!0,useHide:!0,top:10,left:60,width:600,height:115,minHeight:115,maxHeight:110}),this._dialog.events.on("visibility",(r=>{this._toggleBtn.setActive(r)}))}oninit(){let l=this.renderer.div;this._toggleBtn.appendTo(l),this._dialog.appendTo(l),this._toggleBtn.events.on("change",(t=>{this._dialog.setVisibility(t),t&&this._timelineView.resize()})),this._timelineView.appendTo(this._dialog.container),this._timelineView.events.on("setcurrent",(t=>{this.renderer&&this.renderer.handler.defaultClock.setDate(t)})),this._timelineView.events.on("startdrag",(()=>{var t;(t=this.planet)==null||t.sun.stop(),this.renderer&&this.renderer.controls.navigation.deactivate()})),this._timelineView.events.on("stopdrag",(()=>{this.renderer&&this.renderer.controls.navigation.activate()})),this._timelineView.events.on("startdragcurrent",(()=>{var t;(t=this.planet)==null||t.sun.stop(),this.renderer&&this.renderer.controls.navigation.deactivate()})),this._timelineView.events.on("stopdragcurrent",(()=>{this.renderer&&this.renderer.controls.navigation.activate()}))}},ToggleWireframe:class extends K{constructor(l={}){super(l),this._isActive=!1,this.toogleWireframe=()=>{this.renderer&&this.renderer.handler.gl&&(this.planet.drawMode===this.renderer.handler.gl.LINE_STRIP?this.planet.setDrawMode(this.renderer.handler.gl.TRIANGLE_STRIP):this.planet.setDrawMode(this.renderer.handler.gl.LINE_STRIP))},this._isActive=l.isActive||!1}oninit(){this.renderer.events.on("charkeypress",W.KEY_X,this.toogleWireframe,this),this._isActive&&this.planet.setDrawMode(this.renderer.handler.gl.LINE_STRIP)}},TouchNavigation:ao,ZoomControl:oo},Symbol.toStringTag,{value:"Module"}));function jt(l){return new Uint32Array(l)}function sc(l){let t=[],i=0,s=0,r=0;for(let n=1;n<l-1-1;n++){for(let a=1;a<l-1;a++)i=n*l+a,r=(n+1)*l,s=r+a,t.push(i,s);t.push(s,r+1)}return t.push(t[t.length-1],l*l-l),jt(t)}function rc(l,t){let i=[];const s=(l-1)/t,r=l*l-l;let n=0;for(let a=0;a<l-2;a++){a%s==0&&(n=a);let o=r-l*a-l+1,h=r-l*n;i.push(h,o)}return t===l-1&&(i.push(l),i.push(0)),jt(i)}function nc(l,t){let i=[];const s=(l-1)/t;let r=0;for(let n=0;n<l-2;n++){n%s==0&&(r=n);let a=l+n+1,o=r;i.push(o,a)}return t===l-1&&(i.push(l-2),i.push(l-1)),jt(i)}function ac(l,t){let i=[];const s=(l-1)/t;let r=0;for(let n=0;n<l-2;n++){n%s==0&&(r=n);let a=l*(n+1)+l-2,o=l+l*r-1;i.push(o,a)}return t===l-1&&(i.push(l*(l-1)-1),i.push(l*l-1)),jt(i)}function oc(l,t){let i=[];const s=(l-1)/t;let r=0;const n=l*(l-1)-2,a=l*l-1;for(let o=0;o<l-2;o++){o%s==0&&(r=o);let h=n-o,c=a-r;i.push(c,h)}return t===l-1&&i.push(l*l-l+1),i.push(l*l-l),jt(i)}function on(l){let t=[[],[],[],[]];for(let i=0;i<=l;i++){let s=Math.pow(2,i)+1;t[0][i]=[],t[3][i]=[],t[2][i]=[],t[1][i]=[];for(let r=0;r<=l;r++){let n=Math.pow(2,r);t[3][i][r]=rc(s,n),t[0][i][r]=nc(s,n),t[1][i][r]=ac(s,n),t[2][i][r]=oc(s,n)}}return t}function ln(l){let t=[];for(let i=0;i<=l;i++){const s=Math.pow(2,i);t[i]=sc(s+1)}return t}function lc(l){let t=new Uint16Array((l+1)*(l+1)*2),i=0;for(let s=0;s<=l;s++)for(let r=0;r<=l;r++)t[i++]=r/l*65535,t[i++]=s/l*65535;return t}let hc=new class{constructor(l=0){this._maxGridSize=l,this.centerIndexesTable=ln(this._maxGridSize),this.skirtsIndexesTable=on(this._maxGridSize)}get maxGridSize(){return this._maxGridSize}init(){this.centerIndexesTable=ln(this._maxGridSize),this.skirtsIndexesTable=on(this._maxGridSize)}setMaxGridSize(l){this._maxGridSize=l,this.init()}createSegmentIndexes(l,t){if(l){let s=this.centerIndexesTable[l],r=this.skirtsIndexesTable[3][l][t[3]],n=this.skirtsIndexesTable[0][l][t[0]],a=this.skirtsIndexesTable[1][l][t[1]],o=this.skirtsIndexesTable[2][l][t[2]],h=(i=s.length+r.length+n.length+a.length+o.length,new Uint32Array(i));return h.set(s,0),h.set(r,s.length),h.set(n,s.length+r.length),h.set(a,s.length+r.length+n.length),h.set(o,s.length+r.length+n.length+a.length),h}var i;return jt([0,2,1,3])}initTextureCoordsTable(l){let t=[];for(let i=0;i<=l;i++){const s=Math.pow(2,i);t[i]=lc(s)}return t}};function Di(){return hc}function hn(){return new X("drawnode_screen_wl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",height:"float",uGlobalTextureCoord:"vec4",uNormalMapBias:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",uNormalMap:"sampler2d",nightTexture:"sampler2d",specularTexture:"sampler2d",lightPosition:"vec3",diffuse:"vec3",ambient:"vec3",specular:"vec4",camHeight:"float",nightTextureCoefficient:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:"attribute vec3 aVertexPositionHigh;attribute vec3 aVertexPositionLow;attribute vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec4 uGlobalTextureCoord;uniform vec3 uNormalMapBias;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;varying vec4 vTextureCoord;varying vec3 v_vertex;varying vec3 cameraPosition;varying vec2 vGlobalTextureCoord;varying float v_height;void main(void){vec3 aVertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 nh=height*normalize(aVertexPosition);vTextureCoord.xy=aTextureCoord;vGlobalTextureCoord=uGlobalTextureCoord.xy+(uGlobalTextureCoord.zw-uGlobalTextureCoord.xy)*aTextureCoord;vTextureCoord.zw=uNormalMapBias.z*(aTextureCoord+uNormalMapBias.xy);cameraPosition=eyePositionHigh+eyePositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);v_height=height;v_vertex=aVertexPosition+nh;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}",fragmentShader:`precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 specular;uniform vec3 diffuse;uniform vec3 ambient;uniform sampler2D uNormalMap;uniform sampler2D nightTexture;uniform sampler2D specularTexture;uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform vec4 tileOffsetArr[SLICE_SIZE];uniform vec3 lightPosition;uniform float layerOpacityArr[SLICE_SIZE];uniform int samplerCount;uniform float nightTextureCoefficient;uniform float camHeight;varying vec4 vTextureCoord;varying vec3 v_vertex;varying vec3 cameraPosition;varying vec2 vGlobalTextureCoord;varying float v_height;vec3 sunPos;void main(void){sunPos=lightPosition;vec3 texNormal=texture2D(uNormalMap,vTextureCoord.zw).rgb;vec3 normal=normalize((texNormal-0.5)*2.0);float minH=1200000.0;float maxH=minH*3.0;float nightCoef=getLerpValue(minH,maxH,camHeight)*nightTextureCoefficient;vec3 lightDir=normalize(sunPos);vec3 viewDir=normalize(cameraPosition-v_vertex);float overGround=1.0-step(0.1,v_height);float shininess=texture2D(specularTexture,vGlobalTextureCoord.st).r*255.0*overGround;vec3 reflectionDirection=reflect(-lightDir,normal);float reflection=max(dot(reflectionDirection,viewDir),0.0);vec3 spec=specular.rgb*pow(reflection,specular.w)*shininess;float diffuseLightWeighting=max(dot(normal,lightDir),0.0);vec4 nightImageColor=texture2D(nightTexture,vGlobalTextureCoord.st);vec3 night=nightStep*(.18-diffuseLightWeighting*3.0)*nightImageColor.rgb*nightCoef;night*=overGround*step(0.0,night);vec4 lightWeighting=vec4(ambient+diffuse*diffuseLightWeighting+night,1.0);gl_FragColor=texture2D(defaultTexture,vTextureCoord.xy);if(samplerCount==0){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}vec4 src;blend(gl_FragColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);}`})}function cn(l){return new X("drawnode_screen_wl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",height:"float",uGlobalTextureCoord:"vec4",uNormalMapBias:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",uNormalMap:"sampler2d",nightTexture:"sampler2d",specularTexture:"sampler2d",lightPosition:"vec3",diffuse:"vec3",ambient:"vec3",specular:"vec4",transmittanceTexture:"sampler2D",scatteringTexture:"sampler2D",camHeight:"float",nightTextureCoefficient:"float",maxMinOpacity:"vec2",transitionOpacity:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:`#version 300 es
precision highp float;in vec3 aVertexPositionHigh;in vec3 aVertexPositionLow;in vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec4 uGlobalTextureCoord;uniform vec3 uNormalMapBias;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;out vec4 vTextureCoord;out vec3 v_vertex;out vec3 cameraPosition;out vec2 vGlobalTextureCoord;out float v_height;void main(void){vec3 aVertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 nh=height*normalize(aVertexPosition);vTextureCoord.xy=aTextureCoord;vGlobalTextureCoord=uGlobalTextureCoord.xy+(uGlobalTextureCoord.zw-uGlobalTextureCoord.xy)*aTextureCoord;vTextureCoord.zw=uNormalMapBias.z*(aTextureCoord+uNormalMapBias.xy);cameraPosition=eyePositionHigh+eyePositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);v_height=height;v_vertex=aVertexPosition+nh;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}`,fragmentShader:ri("#version 300 es\nprecision highp float;\n#ifdef WEBGL2\n#define TEXTURE_FUNC texture\n#else\n#define TEXTURE_FUNC texture2D\n#endif\n#define SLICE_SIZE 5\n#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;\n#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);\nconst vec3 nightStep=10.0*vec3(0.58,0.48,0.25);float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=float(${EQUATORIAL_RADIUS});const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}vec3 sunWithBloomScaled(vec3 rayDir,vec3 sunDir,float angularScale){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS*angularScale);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}uniform vec4 specular;uniform vec3 diffuse;uniform vec3 ambient;uniform vec3 lightPosition;uniform sampler2D uNormalMap;uniform sampler2D nightTexture;uniform sampler2D specularTexture;uniform sampler2D transmittanceTexture;uniform sampler2D scatteringTexture;uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform vec4 tileOffsetArr[SLICE_SIZE];uniform float layerOpacityArr[SLICE_SIZE];uniform int samplerCount;uniform float nightTextureCoefficient;uniform vec2 maxMinOpacity;uniform float camHeight;uniform float transitionOpacity;in vec4 vTextureCoord;in vec3 v_vertex;in vec3 cameraPosition;in vec2 vGlobalTextureCoord;in float v_height;vec3 sunPos;layout(location=0)out vec4 diffuseColor;vec3 transmittanceFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture(transmittanceTexture,vec2(u,v)).xyz;}vec3 multipleScatteringContributionFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture(scatteringTexture,vec2(u,v)).xyz;}void getSunIlluminance(in vec3 point,in vec3 lightDir,out vec3 sunIlluminance){float mu_s=dot(normalize(point),lightDir);float height=length(point)-BOTTOM_RADIUS;sunIlluminance=SUN_INTENSITY*transmittanceFromTexture(height,mu_s);}void atmosGroundColor(out vec4 fragColor,in vec3 normal){vec3 cameraPosition=cameraPosition;if(length(cameraPosition*SPHERE_TO_ELLIPSOID_SCALE)<BOTTOM_RADIUS+1.0){cameraPosition=normalize(cameraPosition*SPHERE_TO_ELLIPSOID_SCALE)*(BOTTOM_RADIUS+1.0)/SPHERE_TO_ELLIPSOID_SCALE;}vec3 rayDirection=normalize(v_vertex-cameraPosition);vec3 lightDir=normalize(sunPos);rayDirection=normalize(rayDirection*SPHERE_TO_ELLIPSOID_SCALE);vec3 camPos=cameraPosition*SPHERE_TO_ELLIPSOID_SCALE;lightDir=normalize(lightDir*SPHERE_TO_ELLIPSOID_SCALE);vec3 light=vec3(0.0);vec3 transmittanceFromCameraToSpace=vec3(1.0);float offset=0.0;float distanceToSpace=0.0;intersectSphere(camPos,rayDirection,TOP_RADIUS,offset,distanceToSpace);vec3 rayOrigin=camPos;if(offset>0.0){rayOrigin+=rayDirection*offset;}float height=length(rayOrigin)-BOTTOM_RADIUS;float rayAngle=dot(rayOrigin,rayDirection)/length(rayOrigin);bool cameraBelow=rayAngle<0.0;transmittanceFromCameraToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);float phaseAngle=dot(lightDir,rayDirection);float rayleighPhase=rayleighPhase(phaseAngle);float miePhase=miePhase(phaseAngle);float distanceToGround=0.0;bool hitGround=intersectSphere(camPos,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;if(length(v_vertex*SPHERE_TO_ELLIPSOID_SCALE)>BOTTOM_RADIUS){distanceToGround=distance(camPos,v_vertex*SPHERE_TO_ELLIPSOID_SCALE);}float segmentLength=(distanceToGround-max(offset,0.0))/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 transmittanceCamera;vec3 transmittanceLight;for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;vec3 up=position/length(position);float rayAngle=dot(up,rayDirection);float lightAngle=dot(up,lightDir);vec3 transmittanceToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);transmittanceCamera=cameraBelow ?(transmittanceToSpace/transmittanceFromCameraToSpace):(transmittanceFromCameraToSpace/transmittanceToSpace);transmittanceLight=transmittanceFromTexture(height,lightAngle);vec2 opticalDensity=exp(-height/rayleighMieHeights);vec3 scatteredLight=transmittanceLight*(rayleighScatteringCoefficient*opticalDensity.x*rayleighPhase+mieScatteringCoefficient*opticalDensity.y*miePhase);scatteredLight+=multipleScatteringContributionFromTexture(height,lightAngle)*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y);light+=transmittanceCamera*scatteredLight*segmentLength;t+=segmentLength;}light*=SUN_INTENSITY;vec3 hitPoint=camPos+rayDirection*distanceToGround;vec3 up=normalize(hitPoint);float diffuseAngle=max(dot(up,lightDir),0.0);float lightAngle=dot(normal,lightDir);vec3 tA=transmittanceCamera*GROUND_ALBEDO*SUN_INTENSITY;vec3 scatteringLight=multipleScatteringContributionFromTexture(height,lightAngle);vec3 diffuseTransmittanceLight=transmittanceLight*diffuseAngle;light+=tA*(scatteringLight+diffuseTransmittanceLight);fragColor=vec4(pow(light*8.0,vec3(1.0/2.2)),1.0);}void getAtmosFadingOpacity(out float opacity){float c=length(cameraPosition);float maxDist=sqrt(c*c-BOTTOM_RADIUS*BOTTOM_RADIUS);float minDist=c-BOTTOM_RADIUS;float vertDist=distance(cameraPosition,v_vertex);opacity=clamp(maxMinOpacity.y+(maxMinOpacity.x-maxMinOpacity.y)*getLerpValue(minDist,maxDist,vertDist),0.0,1.0);}void main(void){sunPos=lightPosition;vec3 texNormal=texture(uNormalMap,vTextureCoord.zw).rgb;vec3 normal=normalize((texNormal-0.5)*2.0);float minH=1200000.0;float maxH=minH*3.0;float nightCoef=getLerpValue(minH,maxH,camHeight)*nightTextureCoefficient;vec3 lightDir=normalize(sunPos);vec3 viewDir=normalize(cameraPosition-v_vertex);vec4 atmosColor;atmosGroundColor(atmosColor,normal);vec3 sunIlluminance;getSunIlluminance(v_vertex*SPHERE_TO_ELLIPSOID_SCALE,lightDir*SPHERE_TO_ELLIPSOID_SCALE,sunIlluminance);float overGround=1.0-step(0.1,v_height);float shininess=texture(specularTexture,vGlobalTextureCoord.st).r*255.0*overGround;vec3 reflectionDirection=reflect(-lightDir,normal);float reflection=max(dot(reflectionDirection,viewDir),0.0);vec3 spec=sunIlluminance*specular.rgb*pow(reflection,specular.w)*shininess;float diffuseLightWeighting=max(dot(normal,lightDir),0.0);vec4 nightImageColor=texture(nightTexture,vGlobalTextureCoord.st);vec3 night=nightStep*(.18-diffuseLightWeighting*3.0)*nightImageColor.rgb*nightCoef;night*=overGround*step(0.0,night);vec4 lightWeighting=vec4(ambient+sunIlluminance*diffuse*diffuseLightWeighting+night,1.0);float fadingOpacity;getAtmosFadingOpacity(fadingOpacity);getSunIlluminance(cameraPosition,viewDir*SPHERE_TO_ELLIPSOID_SCALE,sunIlluminance);spec*=sunIlluminance;diffuseColor=texture(defaultTexture,vTextureCoord.xy);if(samplerCount==0){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}vec4 src;blend(diffuseColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;}",l)})}const ps={ATMOS_HEIGHT:1e5,RAYLEIGH_SCALE:.08,MIE_SCALE:.012,GROUND_ALBEDO:.05,BOTTOM_RADIUS:6356752314245179e-9,EQUATORIAL_RADIUS:6378137,rayleighScatteringCoefficient_0:5.802,rayleighScatteringCoefficient_1:13.558,rayleighScatteringCoefficient_2:33.1,mieScatteringCoefficient:3.996,mieExtinctionCoefficient:4.44,ozoneAbsorptionCoefficient_0:.65,ozoneAbsorptionCoefficient_1:1.881,ozoneAbsorptionCoefficient_2:.085,SUN_ANGULAR_RADIUS:.004685,SUN_INTENSITY:1,ozoneDensityHeight:25e3,ozoneDensityWide:15e3,disableSunDisk:!1};var cc="attribute vec2 corners;void main(void){gl_Position=vec4(corners,0.0,1.0);}",dc="precision lowp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=float(${EQUATORIAL_RADIUS});const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}vec3 sunWithBloomScaled(vec3 rayDir,vec3 sunDir,float angularScale){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS*angularScale);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}\n#define DISABLE_SUN_DISK ${ disableSunDisk }\nuniform mat4 viewMatrix;uniform vec3 sunPos;uniform vec3 camPos;uniform vec2 iResolution;uniform float fov;uniform float opacity;uniform float isOrthographic;uniform vec4 frustumParams;uniform sampler2D transmittanceTexture;uniform sampler2D scatteringTexture;float valueHSV(vec3 rgb){return max(max(rgb.r,rgb.g),rgb.b);}vec3 transmittanceFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture2D(transmittanceTexture,vec2(u,v)).xyz;}vec3 multipleScatteringContributionFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture2D(scatteringTexture,vec2(u,v)).xyz;}bool intersectEllipsoidToSphere(in vec3 ro,in vec3 rd,in vec3 ellRadii,in float sphereRadius,out float t1,out float t2){float offset=0.0,distanceToSpace=0.0;if(intersectEllipsoid(ro,rd,ellRadii,offset,distanceToSpace)){vec3 hitEll=ro+rd*offset;vec3 nEll=normalEllipsoid(hitEll,ellRadii);float t=0.0;bool intersectsSphere=intersectSphere(hitEll,nEll,sphereRadius,t);vec3 hitSphere=hitEll+nEll*t;t1=length(hitSphere-ro);hitEll=ro+rd*distanceToSpace;nEll=normalEllipsoid(hitEll,ellRadii);t=0.0;intersectsSphere=intersectSphere(hitEll,nEll,sphereRadius,t);hitSphere=hitEll+nEll*t;t2=length(hitSphere-ro);return true;}return false;}mat4 transpose(in mat4 m){vec4 i0=m[0];vec4 i1=m[1];vec4 i2=m[2];vec4 i3=m[3];mat4 outMatrix=mat4(vec4(i0.x,i1.x,i2.x,i3.x),vec4(i0.y,i1.y,i2.y,i3.y),vec4(i0.z,i1.z,i2.z,i3.z),vec4(i0.w,i1.w,i2.w,i3.w));return outMatrix;}void mainImage(out vec4 fragColor){vec3 cameraPosition=camPos;vec3 lightDirection=normalize(sunPos);vec2 uv=(2.0*gl_FragCoord.xy-iResolution.xy)/iResolution.y;vec3 rayDirection;if(isOrthographic!=0.0){float px=uv.x*iResolution.y/iResolution.x;float py=uv.y;float dx=0.5*frustumParams.x*px;float dy=0.5*frustumParams.y*py;mat4 viewMatrixT=transpose(viewMatrix);vec3 right=normalize(viewMatrixT[0].xyz);vec3 up=normalize(viewMatrixT[1].xyz);vec3 backward=normalize(viewMatrixT[2].xyz);vec3 forward=-backward;rayDirection=forward;cameraPosition=cameraPosition+right*dx+up*dy;}else{float fieldOfView=fov;float z=1.0/tan(fieldOfView*0.5*PI/180.0);rayDirection=normalize(vec3(uv,-z));vec4 rd=transpose(viewMatrix)*vec4(rayDirection,1.0);rayDirection=rd.xyz;}vec3 light=vec3(0.0);vec3 transmittanceFromCameraToSpace=vec3(1.0);float offset=0.0;float distanceToSpace=0.0;rayDirection=normalize(rayDirection*SPHERE_TO_ELLIPSOID_SCALE);cameraPosition*=SPHERE_TO_ELLIPSOID_SCALE;lightDirection=normalize(lightDirection*SPHERE_TO_ELLIPSOID_SCALE);if(length(cameraPosition)<BOTTOM_RADIUS+100.0){cameraPosition=normalize(cameraPosition)*(BOTTOM_RADIUS+100.0);}if(intersectSphere(cameraPosition,rayDirection,TOP_RADIUS,offset,distanceToSpace)){vec3 rayOrigin=cameraPosition;if(offset>0.0){rayOrigin=cameraPosition+rayDirection*offset;}float height=length(rayOrigin)-BOTTOM_RADIUS;float rayAngle=dot(rayOrigin,rayDirection)/length(rayOrigin);bool cameraBelow=rayAngle<0.0;transmittanceFromCameraToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);float phaseAngle=dot(lightDirection,rayDirection);float rayleighPhase=rayleighPhase(phaseAngle);float miePhase=miePhase(phaseAngle);float distanceToGround=0.0;bool hitGround=intersectSphere(cameraPosition,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;if(intersectSphere(cameraPosition,rayDirection,BOTTOM_RADIUS-100000.0,distanceToGround)&&hitGround){fragColor=vec4(0.47,0.47,0.5,1.0);return;}float segmentLength=abs(((hitGround ? distanceToGround : distanceToSpace)-max(offset,0.0))/float(SAMPLE_COUNT));float t=segmentLength*0.5;vec3 transmittanceCamera;vec3 transmittanceLight;for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;vec3 up=position/length(position);float rayAngle=dot(up,rayDirection);float lightAngle=dot(up,lightDirection);vec3 transmittanceToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);transmittanceCamera=cameraBelow ?(transmittanceToSpace/transmittanceFromCameraToSpace):(transmittanceFromCameraToSpace/transmittanceToSpace);transmittanceLight=transmittanceFromTexture(height,lightAngle);vec2 opticalDensity=exp(-height/rayleighMieHeights);vec3 scatteredLight=transmittanceLight*(rayleighScatteringCoefficient*opticalDensity.x*rayleighPhase+mieScatteringCoefficient*opticalDensity.y*miePhase);scatteredLight+=multipleScatteringContributionFromTexture(height,lightAngle)*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y);light+=transmittanceCamera*scatteredLight*segmentLength;t+=segmentLength;}light*=SUN_INTENSITY;if(hitGround){vec3 hitPoint=cameraPosition+rayDirection*distanceToGround;vec3 up=hitPoint/length(hitPoint);float diffuseAngle=max(dot(up,lightDirection),0.0);float lightAngle=dot(up,lightDirection);light+=transmittanceCamera*GROUND_ALBEDO*multipleScatteringContributionFromTexture(height,lightAngle)*SUN_INTENSITY;light+=transmittanceCamera*transmittanceLight*GROUND_ALBEDO*diffuseAngle*SUN_INTENSITY;}}\n#if !DISABLE_SUN_DISK\n{float distanceToGround=0.0;bool hitGround=intersectSphere(cameraPosition,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;if(!hitGround){vec3 sunLum;if(isOrthographic!=0.0){float z=1.0/tan(fov*0.5*PI/180.0);vec3 viewRay=normalize(vec3(uv,-z));vec4 rd=transpose(viewMatrix)*vec4(viewRay,1.0);vec3 pseudoRayDirection=normalize(rd.xyz);const float sunOrthoAngularScale=2.0;sunLum=sunWithBloomScaled(pseudoRayDirection,lightDirection,sunOrthoAngularScale)*vec3(1.0,1.0,0.8);}else{sunLum=sunWithBloom(rayDirection,lightDirection)*vec3(1.0,1.0,0.8);}sunLum=smoothstep(0.002,1.0,sunLum);light+=sunLum*SUN_INTENSITY*transmittanceFromCameraToSpace;}}\n#endif\nvec4 color=vec4(pow(opacity*light*8.0,vec3(1.0/2.2)),valueHSV(light)*clamp(opacity,0.0,1.0));fragColor=color;}void main(void){mainImage(gl_FragColor);}";class uc extends K{constructor(t={}){super({name:"Atmosphere",...t}),this._transmittanceBuffer=null,this._scatteringBuffer=null,this.opacity=1;const i=t;this._parameters=JSON.parse(JSON.stringify({...ps,...i}))}setParameters(t){this._parameters=JSON.parse(JSON.stringify(t)),this.initLookupTexturesShaders(),this.drawLookupTextures(),this.removeLookupTexturesShaders(),this.initPlanetAtmosphereShader()}get parameters(){return JSON.parse(JSON.stringify(this._parameters))}initPlanetAtmosphereShader(){var t;(t=this.planet)==null||t.initAtmosphereShader(this._parameters)}oninit(){this.renderer&&(this._initLookupTextures(),this.initLookupTexturesShaders(),this.drawLookupTextures(),this.removeLookupTexturesShaders(),this.initBackgroundShader(),this.activate())}initLookupTexturesShaders(){var t,i;this.renderer&&(this.renderer.handler.addProgram((t=this._parameters,new X("transmittance",{uniforms:{iResolution:"vec2"},attributes:{a_position:"vec2"},vertexShader:"attribute vec2 a_position;void main(void){gl_Position=vec4(a_position,0.0,1.0);}",fragmentShader:ri("precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=float(${EQUATORIAL_RADIUS});const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}vec3 sunWithBloomScaled(vec3 rayDir,vec3 sunDir,float angularScale){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS*angularScale);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}uniform vec2 iResolution;void main(void){vec2 uv=gl_FragCoord.xy/iResolution.xy;float height=uv.y*ATMOS_HEIGHT;float angle=uv.x*2.0-1.0;gl_FragColor=vec4(transmittance(height,angle),1.0);}",t||ps)}))),this.renderer.handler.addProgram((i=this._parameters,new X("scattering",{uniforms:{iResolution:"vec2",transmittanceTexture:"sampler2d"},attributes:{a_position:"vec2"},vertexShader:"attribute vec2 a_position;void main(void){gl_Position=vec4(a_position,0.0,1.0);}",fragmentShader:ri("precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=float(${EQUATORIAL_RADIUS});const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}vec3 sunWithBloomScaled(vec3 rayDir,vec3 sunDir,float angularScale){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS*angularScale);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}uniform sampler2D transmittanceTexture;uniform vec2 iResolution;vec3 transmittanceFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture2D(transmittanceTexture,vec2(u,v)).xyz;}void main(void){vec2 uv=gl_FragCoord.xy/iResolution.xy;float height=uv.y*ATMOS_HEIGHT;float angle=uv.x*2.0-1.0;vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 up=rayOrigin/length(rayOrigin);vec3 lightDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);const float isotropicPhase=1.0/(4.0*PI);vec3 light=vec3(0.0);vec3 lightTransferFactor=vec3(0.0);for(int i=0;i<SQRT_SAMPLE_COUNT;i++){for(int j=0;j<SQRT_SAMPLE_COUNT;j++){float u=((0.5+float(i))/float(SQRT_SAMPLE_COUNT))*2.0-1.0;float v=(0.5+float(j))/float(SQRT_SAMPLE_COUNT);float r=sqrt(1.0-u*u);float theta=2.0*PI*v;vec3 rayDirection=vec3(cos(theta)*r,sin(theta)*r,u);float rayAngle=dot(up,rayDirection);bool cameraBelow=rayAngle<0.0;vec3 transmittanceFromCameraToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);float offset=0.0;float distanceToSpace=0.0;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,offset,distanceToSpace);float distanceToGround=0.0;bool hitGround=intersectSphere(rayOrigin,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;float segmentLength=(hitGround ? distanceToGround : distanceToSpace)/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 transmittanceCamera;vec3 transmittanceLight;for(int k=0;k<SAMPLE_COUNT;k++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;vec3 up=position/length(position);float rayAngle=dot(up,rayDirection);float lightAngle=dot(up,lightDirection);float distanceToGround;float shadow=intersectSphere(position,lightDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>=0.0 ? 0.0 : 1.0;vec3 transmittanceToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);transmittanceCamera=cameraBelow ?(transmittanceToSpace/transmittanceFromCameraToSpace):(transmittanceFromCameraToSpace/transmittanceToSpace);transmittanceLight=transmittanceFromTexture(height,lightAngle);vec2 opticalDensity=exp(-height/rayleighMieHeights);vec3 scatteredLight=transmittanceLight*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y)*isotropicPhase;light+=shadow*transmittanceCamera*scatteredLight*segmentLength;lightTransferFactor+=transmittanceCamera*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y)*segmentLength;t+=segmentLength;}if(hitGround){vec3 hitPoint=rayOrigin+rayDirection*distanceToGround;vec3 normal=normalize(hitPoint);float diffuseAngle=max(dot(normal,lightDirection),0.0);light+=transmittanceCamera*transmittanceLight*GROUND_ALBEDO*diffuseAngle;}}}light/=float(SAMPLE_COUNT);lightTransferFactor/=float(SAMPLE_COUNT);vec3 color=light/(1.0-lightTransferFactor);gl_FragColor=vec4(color,1.0);}",i||ps)}))))}initBackgroundShader(){var t;this.renderer&&this.renderer.handler.addProgram((t=this._parameters,new X("atmosphereBackground",{uniforms:{iResolution:"vec2",fov:"float",camPos:"vec3",viewMatrix:"mat4",transmittanceTexture:"sampler2D",scatteringTexture:"sampler2D",sunPos:"vec3",opacity:"float",isOrthographic:"float",frustumParams:"vec4"},attributes:{corners:"vec3"},vertexShader:cc,fragmentShader:ri(dc,{...t,disableSunDisk:t!=null&&t.disableSunDisk?1:0})})))}removeBackgroundShader(){this.renderer&&this.renderer.handler.removeProgram("atmosphereBackground")}removeLookupTexturesShaders(){var t,i;if(this.renderer){let s=this.renderer.handler;(t=this._scatteringBuffer)!=null&&t.isComplete()&&s.removeProgram("scattering"),(i=this._transmittanceBuffer)!=null&&i.isComplete()&&s.removeProgram("transmittance")}}onactivate(){super.onactivate(),this.planet&&this.planet.events.on("draw",this._drawBackground,this)}ondeactivate(){super.ondeactivate(),this.planet&&this.planet.events.off("draw",this._drawBackground)}_initLookupTextures(){this._transmittanceBuffer=new Pe(this.renderer.handler,{width:1024,height:1024,useDepth:!1,targets:[{filter:"LINEAR",type:"FLOAT",internalFormat:"RGBA16F"}]}),this._transmittanceBuffer.init(),this._scatteringBuffer=new Pe(this.renderer.handler,{width:1024,height:1024,useDepth:!1,targets:[{filter:"LINEAR",type:"FLOAT",internalFormat:"RGBA16F"}]}),this._scatteringBuffer.init()}_renderLookupTextures(){if(!this.renderer)return;let t=this.renderer.screenFramePositionBuffer,i=this.renderer.handler,s=i.gl;if(this._transmittanceBuffer){this._transmittanceBuffer.activate();let r=i.programs.transmittance,n=r._program.attributes,a=r._program.uniforms;r.activate(),s.clearColor(0,0,0,1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.uniform2fv(a.iResolution,[this._transmittanceBuffer.width,this._transmittanceBuffer.height]),s.bindBuffer(s.ARRAY_BUFFER,t),s.vertexAttribPointer(n.a_position,t.itemSize,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLE_STRIP,0,t.numItems),this._transmittanceBuffer.deactivate()}if(this._scatteringBuffer&&this._transmittanceBuffer){this._scatteringBuffer.activate();let r=i.programs.scattering,n=r._program.attributes,a=r._program.uniforms;r.activate(),s.clearColor(0,0,0,1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.uniform2fv(a.iResolution,[this._scatteringBuffer.width,this._scatteringBuffer.height]),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._transmittanceBuffer.textures[0]),s.uniform1i(a.transmittanceTexture,0),s.bindBuffer(s.ARRAY_BUFFER,t),s.vertexAttribPointer(n.a_position,t.itemSize,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLE_STRIP,0,t.numItems),this._scatteringBuffer.deactivate()}}drawLookupTextures(){this._renderLookupTextures()}_drawBackground(){let t=this.renderer.handler,i=t.programs.atmosphereBackground,s=i._program,r=s.uniforms,n=t.gl,a=this.renderer,o=this.planet.camera;n.disable(n.DEPTH_TEST),a.enableBlendOneSrcAlpha(),i.activate(),n.bindBuffer(n.ARRAY_BUFFER,a.screenFramePositionBuffer),n.vertexAttribPointer(s.attributes.corners,2,n.FLOAT,!1,0,0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._transmittanceBuffer.textures[0]),n.uniform1i(r.transmittanceTexture,0),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,this._scatteringBuffer.textures[0]),n.uniform1i(r.scatteringTexture,1),n.uniformMatrix4fv(r.viewMatrix,!1,o.getViewMatrix());let h=this.planet.sunPos;n.uniform3fv(r.sunPos,[h.x,h.y,h.z]),n.uniform3fv(r.camPos,[o.eye.x,o.eye.y,o.eye.z]),n.uniform2fv(r.iResolution,[a.sceneFramebuffer.width,a.sceneFramebuffer.height]),n.uniform1f(r.fov,o.getViewAngle()),n.uniform1f(r.opacity,this.opacity);let c=o.frustum;n.uniform1f(r.isOrthographic,o.isOrthographic?1:0),n.uniform4fv(r.frustumParams,[c.right-c.left,c.top-c.bottom,c.right,c.top]),n.drawArrays(n.TRIANGLE_STRIP,0,4),n.enable(n.DEPTH_TEST),a.enableBlendDefault()}}const To="degrees",_c="m";let fc=0;class dr{constructor(t){this.id=fc++,this.code=t.code,this.units=t.units}equal(t){return t.id===this.id}}const ur=new dr({code:"epsg:3857",units:_c});class gc{constructor(t){this.segment=t,this.layers=[],this.tileOffsetArr=new Float32Array(t.planet.SLICE_SIZE_4),this.layerOpacityArr=new Float32Array(t.planet.SLICE_SIZE)}clear(){this.layers=null,this.tileOffsetArr=null,this.layerOpacityArr=null}append(t,i){let s=this.layers.length;this.layers.push(t),this.layerOpacityArr[s]=t.screenOpacity;let r=4*s,n=t.applyMaterial(i);this.tileOffsetArr[r]=n[0],this.tileOffsetArr[r+1]=n[1],this.tileOffsetArr[r+2]=n[2],this.tileOffsetArr[r+3]=n[3]}}function Ne(l,t,i){return Math.floor(Math.abs(i-l)/t)}function Vs(l,t,i,s){let r=1/(1<<i),n=s.getWidth()*r,a=s.getHeight()*r,o=s.southWest.lon+l*n,h=s.northEast.lat-t*a;return new j(new L(o,h-a),new L(o+n,h))}const pc=20,Ct=300;let gt=new v,pt=new v,ms=new v,qt=new v,Yt=new v,vs=new v,Wt=new V,Ci=new V;const ii=new Array(4);ii[0]=0,ii[1]=1,ii[2]=1,ii[3]=0;const si=new Array(4);si[0]=!1,si[1]=!0,si[2]=!1,si[3]=!0;class Co{constructor(t,i,s,r){this.isPole=!1,this._tileGroup=0,this._projection=ur,this.node=t,this.quadTreeStrategy=i,this.planet=i.planet,this.handler=i.planet.renderer.handler,this.bsphere=new Be,this._plainRadius=0,this.bbox=new Nn,this._sw=new v,this._nw=new v,this._se=new v,this._ne=new v,this.centerNormal=new v,this._extent=this._extentMerc=r,this._extentLonLat=new j,this.gridSize=this.planet.terrain.gridSizeByZoom[s],this.fileGridSize=0,this.tileZoom=s,this.powTileZoom=1<<s,this.tileX=0,this.tileXE=0,this.tileXW=0,this.tileYN=0,this.tileYS=0,this.tileY=0,this.tileIndex="",this.elevationData=null,this._assignTileIndexes(),this.materials=[],this.plainReady=!1,this.initialized=!1,this.normalMapReady=!1,this.terrainReady=!1,this.terrainIsLoading=!1,this.terrainExists=!1,this.passReady=!1,this.plainVertices=null,this.plainVerticesHigh=null,this.plainVerticesLow=null,this.plainNormals=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.normalMapTexture=null,this.normalMapTextureBias=new Float32Array(3),this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.normalMapNormals=null,this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexPositionBufferHigh=null,this.vertexPositionBufferLow=null,this.vertexTextureCoordBuffer=null,this._globalTextureCoordinates=new Float32Array(4),this._inTheQueue=!1,this._appliedNeighborsZoom=[0,0,0,0],this._slices=[],this._indexBuffer=null,this.readyToEngage=!1,this.plainProcessing=!1,this.normalMapTexturePtr=null,this._transitionOpacity=1,this._transitionTimestamp=0}checkZoom(){return this.tileZoom<this.planet.terrain._maxNodeZoom}getEntityTerrainPoint(t,i){return this.getTerrainPoint(t._cartesian,this.getInsideLonLat(t),i)}getInsideLonLat(t){return t._lonLatMerc}isEntityInside(t){return this._extentLonLat.isInside(t._lonLat)}getTerrainPoint(t,i,s){let r=this.tempVertices;if(r&&r.length){let n=this.planet.ellipsoid.getSurfaceNormal3v(t);Wt.set(t,n.negateTo());let a=this._extent.northEast,o=this._extent.southWest,h=Math.sqrt(r.length/3)-1,c=a.lon,d=a.lat,u=o.lon,_=o.lat,p=(c-u)/h,f=(d-_)/h,m=i.lon-u,g=i.lat-_,y=Math.floor(m/p),x=Math.floor(h-g/f),b=3*((h+1)*x+y),T=3*((h+1)*(x+1)+y);ms.set(r[b],r[b+1],r[b+2]),qt.set(r[b+3],r[b+4],r[b+5]),Yt.set(r[T],r[T+1],r[T+2]);let w=Wt.hitTriangleRes(ms,qt,Yt,s);return w===V.INSIDE?t.distance(s):w===V.AWAY&&(Ci.set(t,n),Ci.hitTriangleRes(ms,qt,Yt,s)===V.INSIDE)?-t.distance(s):(vs.set(r[T+3],r[T+4],r[T+5]),w=Wt.hitTriangleRes(qt,vs,Yt,s),w===V.INSIDE?t.distance(s):w===V.AWAY&&(Ci.set(t,n),Ci.hitTriangleRes(qt,vs,Yt,s)===V.INSIDE)||w===V.AWAY?-t.distance(s):t.distance(s))}return t.distance(this.planet.ellipsoid.hitRay(Wt.origin,Wt.direction))}projectNative(t){return t.forwardMercator()}loadTerrain(t=!1){this.tileZoom<this.planet.terrain.minZoom||this.planet.terrain.isEmpty?(this.terrainIsLoading=!0,this.elevationsNotExists(),this._inTheQueue||this.planet._normalMapCreator.queue(this)):this.tileZoom>this.planet.terrain.maxZoom?this.elevationsNotExists():this.terrainIsLoading||this.terrainReady||this.planet.terrain.loadTerrain(this,t)}elevationsExists(t){if(this.plainReady&&this.terrainIsLoading){let i=new Float32Array(t.length);i.set(t),this.elevationData=new Float32Array(t.length),this.elevationData.set(t),this.planet._terrainWorker.make({segment:this,elevations:i}),this.plainVerticesHigh=null,this.plainVerticesLow=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.planet.terrain.equalizeVertices||(this.tempVerticesHigh=null,this.tempVerticesLow=null)}}elevationsNotExists(){if(this.planet&&this.tileZoom<=this.planet.terrain.maxNativeZoom){if(this.plainReady&&this.terrainIsLoading){this.terrainIsLoading=!1;let t=this.node;t.appliedTerrainNodeId=this.node.nodeId,t.equalizedSideWithNodeId[0]=t.equalizedSideWithNodeId[1]=t.equalizedSideWithNodeId[2]=t.equalizedSideWithNodeId[3]=t.appliedTerrainNodeId,this.planet.lightEnabled&&!this._inTheQueue&&this.planet._normalMapCreator.queue(this),this.readyToEngage=!0}this.terrainVertices=this.plainVertices,this.terrainVerticesHigh=this.plainVerticesHigh,this.terrainVerticesLow=this.plainVerticesLow,this.tempVertices=this.terrainVertices,this.tempVerticesHigh=this.terrainVerticesHigh,this.tempVerticesLow=this.terrainVerticesLow,this.noDataVertices=null,this.fileGridSize=Math.sqrt(this.terrainVertices.length/3)-1,this.gridSize=this.fileGridSize,this.terrainReady=!0,this.terrainExists=!1}else if(this.plainReady&&this.terrainIsLoading){this.terrainIsLoading=!1;let t=this.node;t.appliedTerrainNodeId=this.node.nodeId,t.equalizedSideWithNodeId[0]=t.equalizedSideWithNodeId[1]=t.equalizedSideWithNodeId[2]=t.equalizedSideWithNodeId[3]=t.appliedTerrainNodeId,this.readyToEngage=!0,this.terrainReady=!0,this.passReady=!0,this.terrainExists=!1}}_checkEqualization(t,i){return i&&i.segment&&this.tileZoom>=i.segment.tileZoom&&this.node.equalizedSideWithNodeId[t]!==i.equalizedSideWithNodeId[ni[t]]}equalize(){if(this.tileZoom<2||this.gridSize<2)return;this.readyToEngage=!0;let t=this.node.neighbors,i=this.tempVertices,s=this.tempVerticesHigh,r=this.tempVerticesLow,n=this.gridSize,a=n+1,o=t[0][0];if(this._checkEqualization(0,o)){this.node.equalizedSideWithNodeId[0]=o.equalizedSideWithNodeId[2],this.readyToEngage=!0;let h=this.node.getOffsetOppositeNeighbourSide(o,0),c=o.segment.tempVertices,d=o.segment.tempVerticesHigh,u=o.segment.tempVerticesLow,_=o.segment.gridSize,p=_+1,f=1/(1<<this.tileZoom-o.segment.tileZoom),m=Math.max(n/(_*f),1),g=Math.max(_*f/n,1);for(let y=0,x=h*_;y<a;y+=m,x+=g){const b=3*y,T=3*(p*_+x);i[b]=c[T],i[b+1]=c[T+1],i[b+2]=c[T+2],s[b]=d[T],s[b+1]=d[T+1],s[b+2]=d[T+2],r[b]=u[T],r[b+1]=u[T+1],r[b+2]=u[T+2]}}if(o=t[1][0],this._checkEqualization(1,o)){this.node.equalizedSideWithNodeId[1]=o.equalizedSideWithNodeId[3],this.readyToEngage=!0;let h=this.node.getOffsetOppositeNeighbourSide(o,1),c=o.segment.tempVertices,d=o.segment.tempVerticesHigh,u=o.segment.tempVerticesLow,_=o.segment.gridSize,p=_+1,f=1/(1<<this.tileZoom-o.segment.tileZoom),m=Math.max(n/(_*f),1),g=Math.max(_*f/n,1);for(let y=0,x=h*_;y<a;y+=m,x+=g){const b=3*(a*y+n),T=p*x*3;i[b]=c[T],i[b+1]=c[T+1],i[b+2]=c[T+2],s[b]=d[T],s[b+1]=d[T+1],s[b+2]=d[T+2],r[b]=u[T],r[b+1]=u[T+1],r[b+2]=u[T+2]}}if(o=t[2][0],this._checkEqualization(2,o)){this.node.equalizedSideWithNodeId[2]=o.equalizedSideWithNodeId[0],this.readyToEngage=!0;let h=this.node.getOffsetOppositeNeighbourSide(o,2),c=o.segment.tempVertices,d=o.segment.tempVerticesHigh,u=o.segment.tempVerticesLow,_=o.segment.gridSize,p=1/(1<<this.tileZoom-o.segment.tileZoom),f=Math.max(n/(_*p),1),m=Math.max(_*p/n,1);for(let g=0,y=h*_;g<a;g+=f,y+=m){const x=3*(a*n+g),b=3*y;i[x]=c[b],i[x+1]=c[b+1],i[x+2]=c[b+2],s[x]=d[b],s[x+1]=d[b+1],s[x+2]=d[b+2],r[x]=u[b],r[x+1]=u[b+1],r[x+2]=u[b+2]}}if(o=t[3][0],this._checkEqualization(3,o)){this.node.equalizedSideWithNodeId[3]=o.equalizedSideWithNodeId[1],this.readyToEngage=!0;let h=this.node.getOffsetOppositeNeighbourSide(o,3),c=o.segment.tempVertices,d=o.segment.tempVerticesHigh,u=o.segment.tempVerticesLow,_=o.segment.gridSize,p=_+1,f=1/(1<<this.tileZoom-o.segment.tileZoom),m=Math.max(n/(_*f),1),g=Math.max(_*f/n,1);for(let y=0,x=h*_;y<a;y+=m,x+=g){const b=a*y*3,T=3*(p*x+_);i[b]=c[T],i[b+1]=c[T+1],i[b+2]=c[T+2],s[b]=d[T],s[b+1]=d[T+1],s[b+2]=d[T+2],r[b]=u[T],r[b+1]=u[T+1],r[b+2]=u[T+2]}}}engage(){this.readyToEngage=!1,this.createCoordsBuffers(this.tempVerticesHigh,this.tempVerticesLow,this.gridSize)}_terrainWorkerCallback(t){if(this.plainReady){this.readyToEngage=!0,this.normalMapNormals=null,this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.normalMapNormals=t.normalMapNormals,this.normalMapVertices=t.normalMapVertices,this.normalMapVerticesHigh=t.normalMapVerticesHigh,this.normalMapVerticesLow=t.normalMapVerticesLow,this.terrainVertices=t.terrainVertices,this.terrainVerticesHigh=t.terrainVerticesHigh,this.terrainVerticesLow=t.terrainVerticesLow,this.noDataVertices=t.noDataVertices,this.tempVertices=this.terrainVertices,this.tempVerticesHigh=this.terrainVerticesHigh,this.tempVerticesLow=this.terrainVerticesLow,this.setBoundingVolumeArr(t.bounds),this.gridSize=Math.sqrt(this.terrainVertices.length/3)-1;let i=this.node;if(i.appliedTerrainNodeId=i.nodeId,i.equalizedSideWithNodeId[0]=i.equalizedSideWithNodeId[1]=i.equalizedSideWithNodeId[2]=i.equalizedSideWithNodeId[3]=i.appliedTerrainNodeId,this.terrainReady=!0,this.terrainIsLoading=!1,this.terrainExists=!0,!this.normalMapTexturePtr){const s=this.planet._normalMapCreator;this.normalMapTexturePtr=this.planet.renderer.handler.createEmptyTexture_l(s.width,s.height)}this.planet.lightEnabled&&this.planet._normalMapCreator.queue(this)}}_normalMapEdgeEqualize(t){let i=this.node.neighbors,s=i[t],r=s&&s[0],n=this.planet.terrain.maxZoom;this.tileZoom===n&&s&&!(i[0].length||i[1].length||i[2].length||i[3].length)&&(r=this.node.getEqualNeighbor(t));let a=r&&r.segment,o=this;if(r&&a&&a.terrainReady&&a.terrainExists&&a.tileZoom<=n&&o._appliedNeighborsZoom[t]!==a.tileZoom){o._appliedNeighborsZoom[t]=a.tileZoom;let h=o.normalMapNormals,c=a.normalMapNormals;if(!h||!c)return;let d=o.normalMapNormals,u=a.normalMapNormals,_=Math.sqrt(h.length/3),p=_-1;const f=p*ii[t];let m,g,y,x;if(o.tileZoom===a.tileZoom){const b=p-f;if(si[t])for(let T=0;T<_;T++){let w=3*(T*_+f),A=3*(T*_+b);m=d[w]+u[A],g=d[w+1]+u[A+1],y=d[w+2]+u[A+2],x=1/Math.sqrt(m*m+g*g+y*y),c[A]=h[w]=m*x,c[A+1]=h[w+1]=g*x,c[A+2]=h[w+2]=y*x}else for(let T=0;T<_;T++){let w=3*(f*_+T),A=3*(b*_+T);m=d[w]+u[A],g=d[w+1]+u[A+1],y=d[w+2]+u[A+2],x=1/Math.sqrt(m*m+g*g+y*y),c[A]=h[w]=m*x,c[A+1]=h[w+1]=g*x,c[A+2]=h[w+2]=y*x}a._inTheQueue||a._appliedNeighborsZoom[ni[t]]===o.tileZoom||(a._appliedNeighborsZoom[ni[t]]=o.tileZoom,o.planet._normalMapCreator.queue(a))}}}applyTerrain(t){t?this.elevationsExists(t):this.elevationsNotExists()}deleteBuffers(){const t=this.handler.gl;t.deleteBuffer(this.vertexNormalBuffer),t.deleteBuffer(this.vertexPositionBuffer),t.deleteBuffer(this.vertexPositionBufferHigh),t.deleteBuffer(this.vertexPositionBufferLow),this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexPositionBufferHigh=null,this.vertexPositionBufferLow=null,this.vertexTextureCoordBuffer=null}deleteMaterials(){let t=this.materials;for(let i=0;i<t.length;i++){let s=t[i];s&&s.clear()}this.materials.length=0}deleteElevations(){this.terrainExists=!1,this.terrainReady=!1,this.terrainIsLoading=!1,this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.normalMapNormals=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.plainVertices=null,this.plainVerticesHigh=null,this.plainVerticesLow=null,this.plainNormals=null,this.normalMapReady&&(this.handler.gl.deleteTexture(this.normalMapTexture),this.normalMapReady=!1),this._appliedNeighborsZoom=[0,0,0,0],this.normalMapTextureBias[0]=0,this.normalMapTextureBias[1]=0,this.normalMapTextureBias[2]=1,this._inTheQueue=!1}clearSegment(){this.plainReady=!1,this.initialized=!1,this.deleteBuffers(),this.deleteMaterials(),this.deleteElevations()}childrenInitialized(){let t=this.node.nodes;return t.length===4&&t[0].segment.initialized&&t[1].segment.initialized&&t[2].segment.initialized&&t[3].segment.initialized}destroySegment(){this.clearSegment();let t=this._slices.length;for(;t--;)this._slices[t].clear();this._slices=null,this.node=null,this.planet=null,this.handler=null,this.bbox=null,this.bsphere=null,this._extent=null,this.materials=null,this.plainVertices=null,this.plainVerticesHigh=null,this.plainVerticesLow=null,this.plainNormals=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.normalMapTextureBias=null,this.normalMapTexture=null,this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.normalMapNormals=null,this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexPositionBufferHigh=null,this.vertexPositionBufferLow=null,this.vertexTextureCoordBuffer=null,this._projection=null,this._appliedNeighborsZoom=null,this._globalTextureCoordinates=null}_setExtentLonLat(){this._extentLonLat=this._extent.inverseMercator()}_createExtentNormals(){const t=this.planet.ellipsoid,i=this._extentLonLat,s=t.geodeticToCartesian(i.southWest.lon,i.southWest.lat),r=t.geodeticToCartesian(i.northEast.lon,i.northEast.lat),n=t.geodeticToCartesian(i.southWest.lon,i.northEast.lat),a=t.geodeticToCartesian(i.northEast.lon,i.southWest.lat);this._sw.copy(s),this._nw.copy(n),this._ne.copy(r),this._se.copy(a)}createBoundsByExtent(){this._createExtentNormals(),this.setBoundingVolume3v(this._sw,this._ne)}createBoundsByParent(){let t=this.node;for(;t.parentNode&&!t.segment.terrainReady;)t=t.parentNode;let i=1<<this.tileZoom-t.segment.tileZoom,s=this.tileX-t.segment.tileX*i,r=this.tileY-t.segment.tileY*i;if(t.segment.terrainReady&&t.segment.tileZoom>=this.planet.terrain.minZoom){let n=t.segment.gridSize/i;if(n>=1){this.bsphere.center.x=t.segment.bsphere.center.x,this.bsphere.center.y=t.segment.bsphere.center.y,this.bsphere.center.z=t.segment.bsphere.center.z,this.bsphere.radius=t.segment.bsphere.radius;let a=n*r,o=n*s,h=t.segment.gridSize+1,c=3*((a+n)*h+o),d=3*(a*h+o),u=3*(a*h+o+n),_=3*((a+n)*h+o+n),p=t.segment.tempVertices,f=new v(p[c],p[c+1],p[c+2]),m=new v(p[u],p[u+1],p[u+2]),g=new v(p[d],p[d+1],p[d+2]),y=new v(p[_],p[_+1],p[_+2]);this._sw.copy(f),this._nw.copy(g),this._ne.copy(m),this._se.copy(y)}else{let a,o=t.segment,h=Math.floor(n*r),c=Math.floor(n*s),d=1/n,u=r-d*h,_=s-d*c;a=o.gridSize===1?o.tempVertices:Ks(o.tempVertices,o.gridSize,h,c,1);let p,f,m=new v(a[0],a[1],a[2]),g=new v(a[9],a[10],a[11]),y=new v(a[3]-a[0],a[4]-a[1],a[5]-a[2]),x=new v(a[6]-a[0],a[7]-a[1],a[8]-a[2]),b=new v(a[3]-a[9],a[4]-a[10],a[5]-a[11]),T=new v(a[6]-a[9],a[7]-a[10],a[8]-a[11]),w=u,A=_;p=w+A<d?v.add(y.scaleTo(A/d),x.scaleTo(w/d)).addA(m):v.add(T.scaleTo(1-A/d),b.scaleTo(1-w/d)).addA(g),w=u+1,A=_+1,f=w+A<d?v.add(y.scaleTo(A/d),x.scaleTo(w/d)).addA(m):v.add(T.scaleTo(1-A/d),b.scaleTo(1-w/d)).addA(g),this._createExtentNormals(),this.setBoundingVolume3v(p,f)}}else this.createBoundsByExtent()}setBoundingSphere(t,i,s,r){this.bsphere.center.x=t,this.bsphere.center.y=i,this.bsphere.center.z=s,this.bsphere.radius=this.bsphere.center.distance(r)}setBoundingVolume(t,i,s,r,n,a){this.bbox.setFromBoundsArr([t,i,s,r,n,a]);let o=t+.5*(r-t),h=i+.5*(n-i),c=s+.5*(a-s);this.bsphere.center.set(o,h,c),this.bsphere.radius=this.bsphere.center.distance(new v(t,i,s))}setBoundingVolume3v(t,i){this.bbox.setFromBoundsArr([t.x,t.y,t.z,i.x,i.y,i.z]);let s=t.x+.5*(i.x-t.x),r=t.y+.5*(i.y-t.y),n=t.z+.5*(i.z-t.z);this.bsphere.center.set(s,r,n),this.bsphere.radius=this.bsphere.center.distance(new v(t.x,t.y,t.z))}setBoundingVolumeArr(t){this.bbox.setFromBoundsArr(t);let i=t[0]+.5*(t[3]-t[0]),s=t[1]+.5*(t[4]-t[1]),r=t[2]+.5*(t[5]-t[2]);this.bsphere.center.set(i,s,r),this.bsphere.radius=this.bsphere.center.distance(new v(t[0],t[1],t[2]))}createCoordsBuffers(t,i,s){const r=(s+1)*(s+1),n=this.handler;this.vertexPositionBufferHigh&&this.vertexPositionBufferHigh.numItems===r?(n.setStreamArrayBuffer(this.vertexPositionBufferHigh,t),n.setStreamArrayBuffer(this.vertexPositionBufferLow,i)):(n.gl.deleteBuffer(this.vertexPositionBufferHigh),n.gl.deleteBuffer(this.vertexPositionBufferLow),this.vertexTextureCoordBuffer=this.planet._textureCoordsBufferCache[Math.log2(s)],this.vertexPositionBufferHigh=n.createArrayBuffer(t,3,r),this.vertexPositionBufferLow=n.createArrayBuffer(i,3,r))}_addViewExtent(){const t=this._extentLonLat;let i=this.quadTreeStrategy._viewExtent;t.southWest.lon<i.southWest.lon&&(i.southWest.lon=t.southWest.lon),t.northEast.lon>i.northEast.lon&&(i.northEast.lon=t.northEast.lon),t.southWest.lat<i.southWest.lat&&(i.southWest.lat=t.southWest.lat),t.northEast.lat>i.northEast.lat&&(i.northEast.lat=t.northEast.lat)}_assignTileIndexes(){this._tileGroup=0;const t=this.tileZoom,i=this._extent,s=Ae;this.tileX=Ne(i.getCenter().lon,i.getWidth(),-2003750834e-2),this.tileY=Ne(i.getCenter().lat,i.getHeight(),s);const r=this.powTileZoom;this.tileXE=(this.tileX+1)%r,this.tileXW=(r+this.tileX-1)%r,this.tileYN=this.tileY-1,this.tileYS=this.tileY+1,this.tileIndex=Ve.getTileIndex(this.tileX,this.tileY,t,this._tileGroup)}initialize(){const t=this.planet,i=this.node;if(this.gridSize=t.terrain.gridSizeByZoom[this.tileZoom]||t.terrain.plainGridSize,i.sideSizeLog2[0]=i.sideSizeLog2[1]=i.sideSizeLog2[2]=i.sideSizeLog2[3]=Math.log2(this.gridSize),this.tileZoom<=t.terrain.maxZoom){const s=this.planet._normalMapCreator;this.normalMapTexturePtr=t.renderer.handler.createEmptyTexture_l(s.width,s.height)}this.normalMapTexture=this.planet.transparentTexture,this._assignGlobalTextureCoordinates(),this.initialized=!0}_assignGlobalTextureCoordinates(){const t=this._extent;this._globalTextureCoordinates[0]=(t.southWest.lon+Ae)*Qt,this._globalTextureCoordinates[1]=(Ae-t.northEast.lat)*Qt,this._globalTextureCoordinates[2]=(t.northEast.lon+Ae)*Qt,this._globalTextureCoordinates[3]=(Ae-t.southWest.lat)*Qt}createPlainSegmentAsync(){let t=this.planet,i=t.terrain;i.isReady()&&!this.plainReady&&this.tileZoom<=i.maxZoom&&(this.plainProcessing=!0,t._plainSegmentWorker.make(this))}_plainSegmentWorkerCallback(t){this.plainProcessing=!1,this.initialized&&!this.terrainReady&&(this.plainReady=!0,this.plainVertices=t.plainVertices,this.plainVerticesHigh=t.plainVerticesHigh,this.plainVerticesLow=t.plainVerticesLow,this.plainNormals=t.plainNormals,this._plainRadius=t.plainRadius,this.normalMapNormals=t.normalMapNormals,this.normalMapVertices=t.normalMapVertices,this.normalMapVerticesHigh=t.normalMapVerticesHigh,this.normalMapVerticesLow=t.normalMapVerticesLow,this.fileGridSize=Math.sqrt(t.normalMapVertices.length/3)-1)}createPlainSegment(){this.initialize(),this._createPlainVertices(),this.readyToEngage=!0}_projToDeg(t,i){return L.inverseMercator(t,i)}_createPlainVertices(){const t=this.planet.terrain.gridSizeByZoom[this.tileZoom],i=this.planet.terrain.plainGridSize,s=Math.max(i,t),r=this._extent,n=r.getWidth()/s,a=r.getHeight()/s,o=r.southWest.lon,h=r.northEast.lat,c=Math.max(i/t,1),d=s+1,u=this.planet.ellipsoid._invRadii2,_=d*d,p=(t+1)*(t+1)*3;let f=0,m=0;this.plainNormals=new Float32Array(p),this.plainVertices=new Float64Array(p),this.plainVerticesHigh=new Float32Array(p),this.plainVerticesLow=new Float32Array(p),this.normalMapNormals=new Float32Array(3*_),this.normalMapVertices=new Float64Array(3*_),this.normalMapVerticesHigh=new Float32Array(3*_),this.normalMapVerticesLow=new Float32Array(3*_);let g=this.plainVertices,y=this.plainVerticesHigh,x=this.plainVerticesLow,b=this.plainNormals,T=this.normalMapVertices,w=this.normalMapVerticesHigh,A=this.normalMapVerticesLow,E=this.normalMapNormals;for(let C=0;C<_;C++){let M=C%d,P=~~(C/d),B=this.planet.ellipsoid.lonLatToCartesian(this._projToDeg(o+M*n,h-P*a)),k=B.x*u.x,O=B.y*u.y,R=B.z*u.z,z=1/Math.sqrt(k*k+O*O+R*R),D=k*z,S=O*z,I=R*z;v.doubleToTwoFloats(B,gt,pt),T[m]=B.x,w[m]=gt.x,A[m]=pt.x,E[m++]=D,T[m]=B.y,w[m]=gt.y,A[m]=pt.y,E[m++]=S,T[m]=B.z,w[m]=gt.z,A[m]=pt.z,E[m++]=I,P%c==0&&M%c==0&&(g[f]=B.x,y[f]=gt.x,x[f]=pt.x,b[f++]=D,g[f]=B.y,y[f]=gt.y,x[f]=pt.y,b[f++]=S,g[f]=B.z,y[f]=gt.z,x[f]=pt.z,b[f++]=I)}this.terrainVertices=g,this.terrainVerticesHigh=y,this.terrainVerticesLow=x,this.plainReady=!0}getMaterialByLayer(t){return this.materials[t.__id]}_getLayerExtentOffset(t){const i=t._extentMerc,s=this._extent,r=i.northEast.lon-i.southWest.lon,n=i.northEast.lat-i.southWest.lat;return[(s.southWest.lon-i.southWest.lon)/r,(i.northEast.lat-s.northEast.lat)/n,(s.northEast.lon-s.southWest.lon)/r,(s.northEast.lat-s.southWest.lat)/n]}initSlice(t){let i=this._slices[t];return i?i.layers=[]:i=this._slices[t]=new gc(this),i}screenRendering(t,i,s,r,n=!1,a){const o=this.handler.gl,h=t.attributes,c=t.uniforms,d=this.materials,u=this.planet,_=this.quadTreeStrategy;let p,f;i&&i.length?(f=i[0],p=f._height):p=0,o.activeTexture(o.TEXTURE0+u.SLICE_SIZE+2),o.bindTexture(o.TEXTURE_2D,r||this.getDefaultTexture()),o.uniform1i(c.defaultTexture,u.SLICE_SIZE+2);let m=0,g=0,y=!1,x=this.initSlice(s);for(this._indexBuffer=this._getIndexBuffer();f;){if(this.layerOverlap(f)&&(f._fading&&f._fadingOpacity>0||(f.minZoom>=_.minCurrZoom||f.maxZoom>=_.minCurrZoom)&&(f.minZoom<=_.maxCurrZoom||f.maxZoom<=_.maxCurrZoom))){y=!0;let b=d[f.__id];b||(b=d[f.__id]=f.createMaterial(this)),b.isReady||(_._renderCompleted=!1),x.append(f,b),u._samplerArr[m]=m,o.activeTexture(o.TEXTURE0+m),o.bindTexture(o.TEXTURE_2D,b.texture||u.transparentTexture),m++}g++,f=i[g]}!y&&n||(o.uniform1f(c.transitionOpacity,a||this._transitionOpacity>1?1:this._transitionOpacity),o.uniform1i(c.samplerCount,m),o.uniform1f(c.height,p),o.uniform1iv(c.samplerArr,u._samplerArr),o.uniform4fv(c.tileOffsetArr,x.tileOffsetArr),o.uniform1fv(c.layerOpacityArr,x.layerOpacityArr),u.lightEnabled&&(o.activeTexture(o.TEXTURE0+u.SLICE_SIZE+3),o.bindTexture(o.TEXTURE_2D,this.normalMapTexture||u.transparentTexture),o.uniform1i(c.uNormalMap,u.SLICE_SIZE+3),o.uniform3fv(c.uNormalMapBias,this.normalMapTextureBias),o.uniform4fv(c.uGlobalTextureCoord,this._globalTextureCoordinates)),o.bindBuffer(o.ARRAY_BUFFER,this.vertexPositionBufferHigh),o.vertexAttribPointer(h.aVertexPositionHigh,this.vertexPositionBufferHigh.itemSize,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this.vertexPositionBufferLow),o.vertexAttribPointer(h.aVertexPositionLow,this.vertexPositionBufferLow.itemSize,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this.vertexTextureCoordBuffer),o.vertexAttribPointer(h.aTextureCoord,2,o.UNSIGNED_SHORT,!0,0,0),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,this._indexBuffer),o.drawElements(u.drawMode,this._indexBuffer.numItems,o.UNSIGNED_INT,0))}increaseTransitionOpacity(){this._transitionOpacity+=(window.performance.now()-this._transitionTimestamp)/this.planet.transitionTime,this._transitionTimestamp=window.performance.now(),this._transitionOpacity>2&&(this._transitionOpacity=2);let t=this.node._fadingNodes.length;for(;t--;){let i=this.node._fadingNodes[t];if(!i.segment){this._transitionOpacity=1;break}i.segment._transitionOpacity>0&&!this.quadTreeStrategy._fadingNodes.has(i.__id)&&(this.quadTreeStrategy._fadingNodes.set(i.__id,i),i.segment._transitionOpacity=2-this._transitionOpacity,i.segment._transitionOpacity===0&&this.node._fadingNodes.splice(t,1))}}fadingTransitionOpacity(){this._transitionOpacity-=.01,this._transitionTimestamp=window.performance.now(),this._transitionOpacity<0&&(this._transitionOpacity=0)}colorPickingRendering(t,i,s,r,n=!1){const a=this.handler.gl,o=t.attributes,h=t.uniforms;let c,d=this.materials,u=this.planet;c=i&&i.length?i[0]._height:0;let _=!1,p=this._slices[s],f=p.layers.length;for(let m=0;m<f;m++){_=!0;let g=p.layers[m],y=4*m;u._pickingColorArr[y]=g._pickingColor.x/255,u._pickingColorArr[y+1]=g._pickingColor.y/255,u._pickingColorArr[y+2]=g._pickingColor.z/255,u._pickingColorArr[y+3]=Number(g._pickingEnabled),u._samplerArr[m]=m,a.activeTexture(a.TEXTURE0+m),a.bindTexture(a.TEXTURE_2D,d[g.__id].texture||this.planet.transparentTexture),u._pickingMaskArr[m]=m+u.SLICE_SIZE,a.activeTexture(a.TEXTURE0+m+u.SLICE_SIZE),a.bindTexture(a.TEXTURE_2D,d[g.__id].pickingMask||this.planet.transparentTexture)}!_&&n||(a.uniform1i(h.samplerCount,f),a.uniform1f(h.height,c),a.uniform1iv(h.samplerArr,u._samplerArr),a.uniform1iv(h.pickingMaskArr,u._pickingMaskArr),a.uniform4fv(h.pickingColorArr,u._pickingColorArr),a.uniform4fv(h.tileOffsetArr,p.tileOffsetArr),a.uniform1fv(h.layerOpacityArr,p.layerOpacityArr),a.bindBuffer(a.ARRAY_BUFFER,this.vertexPositionBufferHigh),a.vertexAttribPointer(o.aVertexPositionHigh,this.vertexPositionBufferHigh.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.vertexPositionBufferLow),a.vertexAttribPointer(o.aVertexPositionLow,this.vertexPositionBufferLow.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.vertexTextureCoordBuffer),a.vertexAttribPointer(o.aTextureCoord,2,a.UNSIGNED_SHORT,!0,0,0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this._indexBuffer),a.drawElements(a.TRIANGLE_STRIP,this._indexBuffer.numItems,a.UNSIGNED_INT,0))}depthRendering(t,i){const s=this.handler.gl,r=t.attributes,n=t.uniforms;var a;a=i&&i.length?i[0]._height:0,s.uniform1f(n.height,a),s.bindBuffer(s.ARRAY_BUFFER,this.vertexPositionBufferHigh),s.vertexAttribPointer(r.aVertexPositionHigh,this.vertexPositionBufferHigh.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this.vertexPositionBufferLow),s.vertexAttribPointer(r.aVertexPositionLow,this.vertexPositionBufferLow.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this._indexBuffer),s.drawElements(s.TRIANGLE_STRIP,this._indexBuffer.numItems,s.UNSIGNED_INT,0)}_getIndexBuffer(){const t=this.node.sideSizeLog2;let i=this.planet._indexesCache[Math.log2(this.gridSize)][t[0]][t[1]][t[2]][t[3]];if(!i.buffer){let s=Di().createSegmentIndexes(Math.log2(this.gridSize),[t[0],t[1],t[2],t[3]]);i.buffer=this.planet.renderer.handler.createElementArrayBuffer(s,1),this.planet._indexesCacheToRemoveCounter++}return i.buffer}layerOverlap(t){return this._extent.overlaps(t._extentMerc)}getDefaultTexture(){return this.planet.solidTextureOne}getExtentLonLat(){return this._extentLonLat}getExtentMerc(){return this._extentMerc}getExtent(){return this._extent}getNeighborSide(t){if(this.tileY===t.tileY){if(this.tileX===t.tileXE)return 3;if(this.tileX===t.tileXW)return 1}else if(this.tileX===t.tileX){if(this.tileY===t.tileYS)return 0;if(this.tileY===t.tileYN)return 2}return-1}}let Ai=new v,Ei=new v;const vt=[new H(0,0),new H(1,0),new H(0,1),new H(1,1)],mc=Math.sqrt(vt.length)-1;let oe={xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0},vc=0;class ut{constructor(t,i,s,r,n,a){i.planet._createdNodesCount++,this.__id=vc++,this.SegmentPrototype=t,this.quadTreeStrategy=i,this.parentNode=r,this.partId=s,this.nodeId=s+(r?4*r.nodeId+1:0),this.state=null,this.prevState=null,this.appliedTerrainNodeId=-1,this.sideSizeLog2=[0,0,0,0],this.ready=!1,this.neighbors=[[],[],[],[]],this.equalizedSideWithNodeId=[this.nodeId,this.nodeId,this.nodeId,this.nodeId],this.nodes=[],this.segment=new t(this,i,n,a),this._cameraInside=!1,this.inFrustum=0,this._fadingNodes=[],this.createBounds()}createChildNodes(){this.ready=!0;const t=this.quadTreeStrategy,i=this.segment,s=i._extent,r=i.tileZoom+1,n=.5*s.getWidth(),a=.5*s.getHeight(),o=s.northEast,h=s.southWest,c=new L(h.lon+n,h.lat+a),d=this.nodes;d[0]=new ut(this.SegmentPrototype,t,0,this,r,new j(new L(h.lon,h.lat+a),new L(h.lon+n,o.lat))),d[1]=new ut(this.SegmentPrototype,t,1,this,r,new j(c,new L(o.lon,o.lat))),d[2]=new ut(this.SegmentPrototype,t,2,this,r,new j(new L(h.lon,h.lat),c)),d[3]=new ut(this.SegmentPrototype,t,3,this,r,new j(new L(h.lon+n,h.lat),new L(o.lon,h.lat+a)))}createBounds(){let t=this.segment;t._setExtentLonLat(),t.tileZoom===0?t.setBoundingSphere(0,0,0,new v(0,0,t.planet.ellipsoid.equatorialSize)):t.tileZoom<t.planet.terrain.minZoom?t.createBoundsByExtent():t.createBoundsByParent();let i=t.bsphere.center.x,s=t.bsphere.center.y,r=t.bsphere.center.z,n=1/Math.sqrt(i*i+s*s+r*r);t.centerNormal.x=i*n,t.centerNormal.y=s*n,t.centerNormal.z=r*n}getState(){if(this.state===-1)return this.state;let t=this.parentNode;for(;t;){if(t.state!==2)return 0;t=t.parentNode}return this.state}getEqualNeighbor(t){let i=this,s=Tr[t][i.partId];if(s!==-1)return i.parentNode.nodes[s];{let r=[];for(;i.parentNode;)if(r.push(i.partId),s=Tr[t][i.partId],i=i.parentNode,s!==-1){let n=r.length;for(t=ni[t];i&&n--;)s=tl[t][r[n]],i=i.nodes[s];return i}}}traverseNodes(t,i,s,r,n){this.ready||this.createChildNodes();let a=this.nodes;a[0].renderTree(t,i,s,r,n),a[1].renderTree(t,i,s,r,n),a[2].renderTree(t,i,s,r,n),a[3].renderTree(t,i,s,r,n)}renderTree(t,i,s,r,n){if(this.quadTreeStrategy._renderedNodes.length>=1e3)return;(!i||n&&this.segment.tileZoom>n.segment.tileZoom)&&(this.prevState=this.state),this.state=2,this.clearNeighbors();let a=this.segment,o=this.quadTreeStrategy.planet;if(this._cameraInside=!1,!this.parentNode||this.parentNode._cameraInside){let d;d=a._projection.id===ur.id?a._extent.isInside(t._lonLatMerc):a._extent.isInside(t._lonLat),d&&(t._insideSegment=a,this._cameraInside=!0)}this.inFrustum=0;let h=t.frustums,c=h.length;if(a.tileZoom<6)for(let d=0;d<c;d++)h[d].containsSphere(a.bsphere)&&(this.inFrustum|=1<<d);else for(let d=0;d<c;d++)a.terrainReady?h[d].containsBox(a.bbox)&&(this.inFrustum|=1<<d):h[d].containsSphere(a.bsphere)&&(this.inFrustum|=1<<d);if(this.inFrustum||this._cameraInside||a.tileZoom<3){let d=Math.abs(t._lonLat.height),u=t.eye.length2()-o.ellipsoid.polarSizeSqr,_=10687647287563281e-5*o._heightFactor;u=u<_?_:u;let p=a.tileZoom<2||a.tileZoom>19||a.tileZoom<6&&!a.terrainReady;if(t.isOrthographic){let f=t.getForward();p=p||f.dot(a._sw.getNormal())<-0||f.dot(a._nw.getNormal())<-0||f.dot(a._ne.getNormal())<-0||f.dot(a._se.getNormal())<-0}else p=p||t.eye.distance2(a._sw)<u||t.eye.distance2(a._nw)<u||t.eye.distance2(a._ne)<u||t.eye.distance2(a._se)<u;(this.inFrustum&&(p||d>1e4)||this._cameraInside)&&this.quadTreeStrategy.collectVisibleNode(this),a.tileZoom<2?this.traverseNodes(t,i,s,r,n):a.terrainReady&&(!i&&t.projectedSize(a.bsphere.center,a._plainRadius)<this.quadTreeStrategy.lodSize||i&&(a.tileZoom===i||!p))?p?(a.passReady=!0,this.renderNode(this.inFrustum,!this.inFrustum,s,r)):this.state=0:a.terrainReady&&a.checkZoom()&&(!i||t.projectedSize(a.bsphere.center,a.bsphere.radius)>this.quadTreeStrategy._maxLodSize)?this.traverseNodes(t,i,a,r,n):p?(a.passReady=!!i&&a.terrainReady,this.renderNode(this.inFrustum,!this.inFrustum,s,r)):this.state=0}else this.state=0}renderNode(t,i,s,r){let n=this.segment;n.terrainReady||(n.initialized||n.initialize(),this.whileTerrainLoading(s),n.plainProcessing||n.createPlainSegmentAsync(),n.plainReady&&!r&&n.loadTerrain()),n.planet.lightEnabled&&!n.normalMapReady&&this.whileNormalMapCreating(),i?this.state=-1:(!this._cameraInside&&n.tileZoom>this.quadTreeStrategy.maxCurrZoom&&(this.quadTreeStrategy.maxCurrZoom=n.tileZoom),n.tileZoom<this.quadTreeStrategy.minCurrZoom&&(this.quadTreeStrategy.minCurrZoom=n.tileZoom),n._addViewExtent(),this.addToRender(t))}childrenPrevStateEquals(t){let i=this.nodes;return i.length===4&&i[0].prevState===t&&i[1].prevState===t&&i[2].prevState===t&&i[3].prevState===t}isFading(){let t=this.nodes;return this.state===2&&this.segment._transitionOpacity>0&&t.length===4&&t[0].state===1&&t[1].state===1&&t[2].state===1&&t[3].state===1}_collectFadingNodes(){if(this.segment.tileZoom<3)this.segment._transitionOpacity=1;else if(this.prevState!==1){this.segment._transitionOpacity=0,this._fadingNodes=[];let t=window.performance.now();if(this.segment._transitionTimestamp=t,this.parentNode){if(this.parentNode.prevState===1){let i=this.parentNode.parentNode;for(;i;){if(i.isFading()){for(let s=0;s<i.nodes.length;s++)i.nodes[s].segment._transitionOpacity=1,i.nodes[s]._fadingNodes=[];i.segment._transitionOpacity=0;break}i=i.parentNode}this.parentNode.whileTerrainLoading(),this._fadingNodes.push(this.parentNode),this.parentNode.segment._transitionOpacity=2,this.parentNode.segment._transitionTimestamp=t}else if(this.segment.childrenInitialized()&&this.childrenPrevStateEquals(1))for(let i=0;i<this.nodes.length;i++){let s=this.nodes[i];s.whileTerrainLoading(),this._fadingNodes.push(s),s.segment._transitionOpacity=2,s.segment._transitionTimestamp=t,s.prevState=s.state,s.state=0}}}}clearNeighbors(){this.neighbors&&(this.neighbors[0]=this.neighbors[1]=this.neighbors[2]=this.neighbors[3]=null,this.neighbors[0]=[],this.neighbors[1]=[],this.neighbors[2]=[],this.neighbors[3]=[])}_refreshTransitionOpacity(){if(this._fadingNodes.length===0)this.segment._transitionOpacity=1;else if(this._fadingNodes.length!==4||this.childrenPrevStateEquals(1)){for(let t=0;t<this._fadingNodes.length;t++)this.segment._transitionOpacity<1&&this._fadingNodes[t].segment._transitionOpacity===0&&(this._fadingNodes[t].segment._transitionOpacity=0,this.segment._transitionOpacity=1);this.segment.increaseTransitionOpacity()}else this.segment._transitionOpacity=1,this._fadingNodes=[]}addToRender(t){this.state=1;let i=this.quadTreeStrategy._renderedNodes;this.quadTreeStrategy._transitionOpacityEnabled?Qs(i,this,((n,a)=>n.segment.tileZoom-a.segment.tileZoom)):(this.getRenderedNodesNeighbors(i),i.push(this)),this.segment.terrainReady||(this.quadTreeStrategy._renderCompleted=!1,this.quadTreeStrategy._terrainCompleted=!1);let s=0,r=this.quadTreeStrategy._renderedNodesInFrustum;for(;t;)1&t&&r[s].push(this),s++,t>>=1}applyNeighbor(t,i){const s=ni[i];if(this.neighbors[i].length===0||t.neighbors[s].length===0){const r=this.segment,n=t.segment,a=r.gridSize/(n.gridSize*Math.pow(2,n.tileZoom-r.tileZoom));let o=r.gridSize,h=n.gridSize;a>1?(o=Math.ceil(r.gridSize/a),h=n.gridSize):a<1&&(o=r.gridSize,h=Math.ceil(n.gridSize*a)),this.sideSizeLog2[i]=Math.log2(o),t.sideSizeLog2[s]=Math.log2(h)}this.neighbors[i].push(t),t.neighbors[s].push(this)}getRenderedNodesNeighbors(t){for(let i=t.length-1;i>=0;--i){let s=t[i],r=this.getCommonSide(s);r!==-1&&this.applyNeighbor(s,r)}}getCommonSide(t){const i=this.segment,s=t.segment;if(i.tileZoom===s.tileZoom&&i._tileGroup===s._tileGroup)return i.getNeighborSide(s);{const r=i._extentLonLat,n=s._extentLonLat;let a=r.northEast,o=r.southWest,h=n.northEast,c=n.southWest,d=a.lon,u=a.lat,_=o.lon,p=o.lat,f=h.lon,m=h.lat,g=c.lon,y=c.lat;if(i._tileGroup===s._tileGroup){if(d===g&&(u<=m&&p>=y||u>=m&&p<=y))return 1;if(_===f&&(u<=m&&p>=y||u>=m&&p<=y))return 3;if(u===y&&(_>=g&&d<=f||_<=g&&d>=f))return 0;if(p===m&&(_>=g&&d<=f||_<=g&&d>=f))return 2;if(s.tileX===0&&g===-d&&(u<=m&&p>=y||u>=m&&p<=y))return 1;if(i.tileX===0&&_===-f&&(u<=m&&p>=y||u>=m&&p<=y))return 3}if(i._tileGroup===0&&s._tileGroup===20&&i.tileY===0&&s.tileY===s.powTileZoom-1&&(_>=g&&d<=f||_<=g&&d>=f))return 0;if(i._tileGroup===0&&s._tileGroup===Ct&&i.tileY===i.powTileZoom-1&&s.tileY===0&&(_>=g&&d<=f||_<=g&&d>=f))return 2;if(i._tileGroup===Ct&&s._tileGroup===0&&i.tileY===0&&s.tileY===s.powTileZoom-1&&(_>=g&&d<=f||_<=g&&d>=f))return 0;if(i._tileGroup===20&&s._tileGroup===0&&i.tileY===i.powTileZoom-1&&s.tileY===0&&(_>=g&&d<=f||_<=g&&d>=f))return 2}return-1}whileNormalMapCreating(){const t=this.segment;t.terrainIsLoading||!t.terrainExists||t._inTheQueue||t.planet._normalMapCreator.queue(t);let i=this;for(;i.parentNode&&!i.segment.normalMapReady;)i=i.parentNode;const s=2<<t.tileZoom-i.segment.tileZoom-1;t.normalMapTexture=i.segment.normalMapTexture,t.normalMapTextureBias[0]=t.tileX-i.segment.tileX*s,t.normalMapTextureBias[1]=t.tileY-i.segment.tileY*s,t.normalMapTextureBias[2]=1/s}whileTerrainLoading(t){const i=this.segment;let s=this;if(t&&t.terrainReady)s=t.node;else for(;s.parentNode&&!s.segment.terrainReady;)s=s.parentNode;if(s.segment.terrainReady&&this.appliedTerrainNodeId!==s.nodeId){let r=2<<i.tileZoom-s.segment.tileZoom-1,n=i.tileX-s.segment.tileX*r,a=i.tileY-s.segment.tileY*r;const o=s.segment;let h,c,d,u;this.appliedTerrainNodeId=s.nodeId,this.equalizedSideWithNodeId[0]=this.equalizedSideWithNodeId[1]=this.equalizedSideWithNodeId[2]=this.equalizedSideWithNodeId[3]=this.appliedTerrainNodeId;let _=s.segment.gridSize/r,p=s.segment.fileGridSize/r;if(oe.xmin=ve,oe.xmax=Te,oe.ymin=ve,oe.ymax=Te,oe.zmin=ve,oe.zmax=Te,_>=1){i.gridSize=_;let f=(_+1)*(_+1)*3;h=new Float64Array(f),c=new Float32Array(f),d=new Float32Array(f),o.noDataVertices&&(u=new Uint8Array(f/3)),Es(o.terrainVertices,o.terrainVerticesHigh,o.terrainVerticesLow,o.noDataVertices,o.gridSize,_*a,_*n,_,h,c,d,oe,u)}else if(p>=1&&s.segment.terrainExists){i.gridSize=p;let f=(p+1)*(p+1)*3;h=new Float64Array(f),c=new Float32Array(f),d=new Float32Array(f),o.noDataVertices&&(u=new Uint8Array(f/3)),Es(o.normalMapVertices,o.normalMapVerticesHigh,o.normalMapVerticesLow,o.noDataVertices,s.segment.fileGridSize,p*a,p*n,p,h,c,d,oe,u)}else{i.gridSize=mc;let f,m=Math.floor(_*a),g=Math.floor(_*n);f=o.gridSize===1?o.terrainVertices:Ks(o.terrainVertices,o.gridSize,m,g,1);let y=1/_,x=a-y*m,b=n-y*g,T=new v(f[0],f[1],f[2]),w=new v(f[9],f[10],f[11]),A=new v(f[3]-f[0],f[4]-f[1],f[5]-f[2]),E=new v(f[6]-f[0],f[7]-f[1],f[8]-f[2]),C=new v(f[3]-f[9],f[4]-f[10],f[5]-f[11]),M=new v(f[6]-f[9],f[7]-f[10],f[8]-f[11]),P=new v;h=new Float64Array(3*vt.length),c=new Float32Array(3*vt.length),d=new Float32Array(3*vt.length);for(let B=0;B<vt.length;B++){let k=vt[B].y+x,O=vt[B].x+b,R=O*_,z=k*_;P=k+O<y?A.scaleTo(R).addA(E.scaleTo(z)).addA(T):M.scaleTo(1-R).addA(C.scaleTo(1-z)).addA(w),v.doubleToTwoFloats(P,Ai,Ei);let D=3*B;h[D]=P.x,h[D+1]=P.y,h[D+2]=P.z,c[D]=Ai.x,c[D+1]=Ai.y,c[D+2]=Ai.z,d[D]=Ei.x,d[D+1]=Ei.y,d[D+2]=Ei.z,P.x<oe.xmin&&(oe.xmin=P.x),P.x>oe.xmax&&(oe.xmax=P.x),P.y<oe.ymin&&(oe.ymin=P.y),P.y>oe.ymax&&(oe.ymax=P.y),P.z<oe.zmin&&(oe.zmin=P.z),P.z>oe.zmax&&(oe.zmax=P.z)}}if(i.readyToEngage=!0,i.terrainVertices=h,i.terrainVerticesHigh=c,i.terrainVerticesLow=d,i.tempVertices=h,i.tempVerticesHigh=c,i.tempVerticesLow=d,i.noDataVertices=u,i.setBoundingVolume(oe.xmin,oe.ymin,oe.zmin,oe.xmax,oe.ymax,oe.zmax),i.tileZoom>i.planet.terrain.maxZoom&&s.segment.tileZoom>=i.planet.terrain.maxZoom&&(i._plainRadius=s.segment._plainRadius/r,i.terrainReady=!0,i.terrainIsLoading=!1,i.terrainVertices=h,i.terrainVerticesHigh=c,i.terrainVerticesLow=d,i.passReady=!0,this.appliedTerrainNodeId=this.nodeId,this.equalizedSideWithNodeId[0]=this.equalizedSideWithNodeId[1]=this.equalizedSideWithNodeId[2]=this.equalizedSideWithNodeId[3]=this.appliedTerrainNodeId,s.segment.terrainExists)){i.normalMapVertices=h,i.fileGridSize=Math.sqrt(h.length/3)-1;let f=Math.sqrt(o.normalMapNormals.length/3)-1,m=f/r;i.normalMapNormals=f>1?In(o.normalMapNormals,f,m*a,m*n,m):o.normalMapNormals}}}destroy(){this.prevState=this.state=0,this.segment.destroySegment();let t=this.neighbors;for(let i=0,s=t.length;i<s;i++){let r=t[i];if(r)for(let n=0;n<r.length;n++){let a=r[n];a&&a.neighbors&&a.clearNeighbors()}}this.neighbors=null,this.parentNode=null,this.sideSizeLog2=null,this.segment=null}clearTree(){const t=this.getState();if(t===0||t===1)this.destroyBranches();else for(let i=0;i<this.nodes.length;i++)this.nodes[i]&&this.nodes[i].clearTree()}clearBranches(){for(let t=0;t<this.nodes.length;t++)this.nodes[t].clearBranches(),this.nodes[t].segment.deleteMaterials()}destroyBranches(){if(this.ready){let t,i=[];for(t=0;t<this.nodes.length;t++)i[t]=this.nodes[t];for(this.ready=!1,this.nodes=[],t=0;t<i.length;t++)i[t].destroyBranches(),i[t].destroy(),i[t]=null;i.length=0,i=null}}traverseTree(t){if(t(this),this.ready)for(let i=0;i<this.nodes.length;i++)this.nodes[i].traverseTree(t)}getOffsetOppositeNeighbourSide(t,i){let s=this,r=t.segment.tileZoom,n=0;for(;s.segment.tileZoom>r;)n+=il[s.partId][i]/(1<<s.segment.tileZoom-r),s=s.parentNode;return n}}class _r{constructor(t=2048){this._size=t,this._array=new Array(this._size),this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}reset(){this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}clear(){this._array.length=0,this._array=new Array(this._size),this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}push(t){this.length++,this._array[this._popIndex++]=t}pop(){if(this.length){this.length--;let t=this._array[--this._popIndex];return this._array[this._popIndex]=null,this._array[this._popIndex-1]||(this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex),t}}unshift(t){this.length++,this._array[--this._shiftIndex]=t}shift(){if(this.length){this.length--;let t=this._array[this._shiftIndex];return this._array[this._shiftIndex++]=null,this._array[this._shiftIndex]||(this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex),t}}forEach(t){for(let i=this._shiftIndex;i<this._popIndex;i++)t(this._array[i])}}class Ao{constructor(t,i,s){this.quadTreeStrategy=t,this._layer=i,this._nodeCapacity=s,this._secondPASS=[],this._counter=0,this._deferredEntitiesPendingQueue=new _r,this._renderingNodes={}}insertEntity(t,i=!1){}setPickingEnabled(t){}dispose(){}insertEntities(t){}collectVisibleEntityCollections(t){}_queueDeferredNode(t){this._layer.getVisibility()&&(t._inTheQueue=!0,this._counter>=1?this._deferredEntitiesPendingQueue.push(t):this._execDeferredNode(t))}_execDeferredNode(t){this._counter++,requestAnimationFrame((()=>{if(t.applyCollection(),this._counter--,this._deferredEntitiesPendingQueue.length&&this._counter<1)for(;this._deferredEntitiesPendingQueue.length;){let i=this._deferredEntitiesPendingQueue.pop();if(i._inTheQueue=!1,i.isVisible())return void this._execDeferredNode(i)}}))}}class yc{constructor(t){this._skipPreRender=!1,this.events=le(xc),this.name=t.name||"",this.projection=t.proj||ur,this.planet=t.planet,this._quadTreeList=[],this._visibleNodes={},this._renderedNodes=[],this._renderedNodesInFrustum=[],this._fadingNodes=new Map,this._fadingNodesInFrustum=[],this._fadingOpaqueSegments=[],this.minCurrZoom=ve,this.maxCurrZoom=Te,this._viewExtent=new j(new L(180,180),new L(-180,-180)),this._lodSize=256,this._curLodSize=256,this._minLodSize=512,this._maxLodSize=256,this.maxEqualZoomAltitude=t.maxEqualZoomAltitude||15e6,this.minEqualZoomAltitude=t.minEqualZoomAltitude||1e4,this.minEqualZoomCameraSlope=t.minEqualZoomCameraSlope||.8,this._renderCompleted=!1,this._renderCompletedActivated=!1,this._terrainCompleted=!1,this._terrainCompletedActivated=!1,this._transitionOpacityEnabled=t.transitionOpacityEnabled==null||t.transitionOpacityEnabled}get lodSize(){return this._lodSize}setLodSize(t,i,s){this._maxLodSize=s||this._maxLodSize,this._minLodSize=i||this._minLodSize,this._curLodSize=t,this._renderCompletedActivated=!1,this._terrainCompletedActivated=!1}createEntityCollectionsTreeStrategy(t,i){return new Ao(this,t,i)}destroyBranches(){this._renderCompletedActivated=!1,this._terrainCompletedActivated=!1;for(let t=0,i=this._quadTreeList.length;t<i;t++)this._quadTreeList[t].destroyBranches()}clearLayerMaterial(t,i=!1){let s=t.__id;for(let r=0,n=this._quadTreeList.length;r<n;r++)this._quadTreeList[r].traverseTree((a=>{if(i&&this._renderedNodes.includes(a))return;let o=a.segment.materials;o[s]&&(o[s].clear(),o[s]=null)}))}get terrainReady(){return this._terrainCompleted&&this._terrainCompletedActivated}_checkRendercompleted(){this._renderCompleted?this._renderCompletedActivated||(this._renderCompletedActivated=!0,this.events.dispatch(this.events.rendercompleted,!0)):this._renderCompletedActivated=!1,this._renderCompleted=!0,this._terrainCompleted?this._terrainCompletedActivated||(this._terrainCompletedActivated=!0,this.events.dispatch(this.events.terraincompleted,!0)):this._terrainCompletedActivated=!1,this._terrainCompleted=!0}_initEvents(){this.planet.renderer.events.on("resize",(()=>{this._renderCompletedActivated=!1,this._terrainCompletedActivated=!1})),this.planet.renderer.events.on("postdraw",(()=>{this._checkRendercompleted()}))}init(t){this._initEvents(),this._renderedNodesInFrustum=new Array(t.frustums.length);for(let i=0,s=this._renderedNodesInFrustum.length;i<s;i++)this._renderedNodesInFrustum[i]=[];this.preRender(),this.clearRenderedNodes(),this.preLoad()}clearRenderedNodes(){this._clearRenderedNodeList(),this._clearRenderNodesInFrustum()}_clearRenderedNodeList(){this._renderedNodes.length=0,this._renderedNodes=[]}_clearRenderNodesInFrustum(){for(let t=0,i=this._renderedNodesInFrustum.length;t<i;t++)this._renderedNodesInFrustum[t].length=0,this._renderedNodesInFrustum[t]=[]}_collectRenderedNodesMaxZoom(t){if(t.isOrthographic||t.slope>this.minEqualZoomCameraSlope&&t._lonLat.height<this.maxEqualZoomAltitude&&t._lonLat.height>this.minEqualZoomAltitude){this.minCurrZoom=this.maxCurrZoom;let i=this._renderedNodes,s=this._renderedNodesInFrustum,r=[];this._clearRenderNodesInFrustum(),this._renderedNodes=[];for(let n=0,a=i.length;n<a;n++){let o=i[n],h=o.segment.centerNormal.dot(t.getBackward());if(o.segment.tileZoom===this.maxCurrZoom||h<.81){this._renderedNodes.push(o);let c=0,d=o.inFrustum;for(;d;)1&d&&s[c].push(o),c++,d>>=1}else r.push(o)}for(let n=0,a=r.length;n<a;n++)r[n].renderTree(t,this.maxCurrZoom,null,!1,r[n])}}set transitionOpacityEnabled(t){this._transitionOpacityEnabled=t}get transitionOpacityEnabled(){return this._transitionOpacityEnabled}collectRenderNodes(t){if(this._skipPreRender&&(this._lodSize=wn(t.slope<0?0:t.slope,this._curLodSize,this._minLodSize),t._insideSegment=null,this._clearRenderedNodeList(),this._clearRenderNodesInFrustum(),this._viewExtent.southWest.set(180,180),this._viewExtent.northEast.set(-180,-180),this.minCurrZoom=ve,this.maxCurrZoom=Te,this._collectRenderNodes(t),this._collectRenderedNodesMaxZoom(t),this._fadingNodes.clear(),this._transitionOpacityEnabled)){let i=[];for(let s=0;s<this._renderedNodes.length;s++){let r=this._renderedNodes[s];if(r._collectFadingNodes(),r._refreshTransitionOpacity(),r.segment._transitionOpacity>=1)r.clearNeighbors(),r.getRenderedNodesNeighbors(i),i.push(r);else for(let n=0;n<r._fadingNodes.length;n++){let a=r._fadingNodes[n];a.segment&&a.segment._transitionOpacity>=1&&(a.clearNeighbors(),a.getRenderedNodesNeighbors(i),i.push(a))}}}this._skipPreRender=!0}preRender(){this._skipPreRender=!1;for(let t=0;t<this._quadTreeList.length;t++){let i=this._quadTreeList[t];i.createChildNodes(),i.segment.createPlainSegment();for(let s=0;s<i.nodes.length;s++)i.nodes[s].segment.createPlainSegment()}}preLoad(){for(let t=0;t<this._quadTreeList.length;t++){let i=this._quadTreeList[t];i.segment.passReady=!0,i.renderNode(1),this.planet.normalMapCreator.drawSingle(i.segment);for(let s=0;s<i.nodes.length;s++)i.nodes[s].segment.passReady=!0,i.nodes[s].renderNode(1),this.planet._normalMapCreator.drawSingle(i.nodes[s].segment)}}_clearVisibleNodes(){this._visibleNodes={}}_collectRenderNodes(t){this._clearVisibleNodes();for(let i=0;i<this._quadTreeList.length;i++)this._quadTreeList[i].renderTree(t,0,null)}clear(){for(let t=0;t<this._quadTreeList.length;t++)this._quadTreeList[t].clearTree()}get quadTreeList(){return this._quadTreeList}getTileXY(t,i){let s,r,n=i,a=1<<n;return s=Ne(t.lon,360/a,-180),r=Ne(t.lat,180/a,90),[s,r,n,0]}getLonLatTileOffset(t,i,s,r,n){let a;a=Vs(i,s,r,j.createFromArray([-180,-90,180,90]));let o=a.getWidth()/(n-1),h=a.getHeight()/(n-1);return[n-Math.ceil((t.lat-a.southWest.lat)/h)-1,Math.floor((t.lon-a.southWest.lon)/o)]}collectVisibleNode(t){this._visibleNodes[t.nodeId]=t}}const xc=["rendercompleted","terraincompleted"],Eo=new dr({code:"epsg:4326",units:To}),dn=(90-ce)/Math.pow(2,7);class un extends Co{constructor(t,i,s,r){super(t,i,s,r),this._projection=Eo,this._extentLonLat=this._extent,this._extentMerc=new j(r.southWest.forwardMercatorEPS01(),r.northEast.forwardMercatorEPS01()),this._isNorth=this._extent.northEast.lat>0,this.isPole=!0}_setExtentLonLat(){this._extentLonLat=this._extent}projectNative(t){return t}getInsideLonLat(t){return t._lonLat}_getMaxZoom(){let t;if(this._isNorth){let i=Math.floor((90-this._extent.northEast.lat)/dn);t=Math.floor(i/16)+7}else{let i=Math.floor((ke-this._extent.northEast.lat)/dn);t=12-Math.floor(i/16)}return t}checkZoom(){return super.checkZoom()&&this.tileZoom<=this._getMaxZoom()}_assignTileIndexes(){this._assignTileXIndexes(this._extent),this._assignTileYIndexes(this._extent),this.tileIndex=Ve.getTileIndex(this.tileX,this.tileY,this.tileZoom,this._tileGroup)}_assignTileXIndexes(t){this.tileX=Ne(t.getCenter().lon,t.getWidth(),-180);let i=1<<this.tileZoom;this.tileXE=(this.tileX+1)%i,this.tileXW=(i+this.tileX-1)%i}_assignTileYIndexes(t){const i=t.getCenter().lat;i>0?(this._tileGroup=20,this.tileY=Ne(i,t.getHeight(),90)):(this._tileGroup=Ct,this.tileY=Ne(i,t.getHeight(),ke)),this.tileYN=this.tileY-1,this.tileYS=this.tileY+1}_projToDeg(t,i){return new L(t,i)}_assignGlobalTextureCoordinates(){const t=this._extent;this._globalTextureCoordinates[0]=(t.southWest.lon+180)/360,this._globalTextureCoordinates[1]=(90-t.northEast.lat)/180,this._globalTextureCoordinates[2]=(t.northEast.lon+180)/360,this._globalTextureCoordinates[3]=(90-t.southWest.lat)/180}_getLayerExtentOffset(t){const i=t._extent,s=this._extent,r=i.northEast.lon-i.southWest.lon,n=i.northEast.lat-i.southWest.lat;return[(s.southWest.lon-i.southWest.lon)/r,(i.northEast.lat-s.northEast.lat)/n,(s.northEast.lon-s.southWest.lon)/r,(s.northEast.lat-s.southWest.lat)/n]}layerOverlap(t){return this._extent.overlaps(t._extent)}getDefaultTexture(){return this._isNorth?this.planet.solidTextureOne:this.planet.solidTextureTwo}getExtentLonLat(){return this._extent}}class bt{constructor(t,i,s,r,n,a){this.strategy=t,this.layer=t._layer,this.parentNode=s,this.childNodes=[],this.partId=i,this.nodeId=i+(s?4*s.nodeId+1:0),this.state=null,this.extent=r,this.count=0,this.deferredEntities=[],this.entityCollection=null,this.zoom=a,this._inTheQueue=!1,this.bsphere=new Be,n&&this._setExtentBounds()}insertEntity(t,i=!1){this.buildTree([t],i)}_addEntitiesToCollection(t,i=!1){if(t.length){const s=this.layer,r=s._planet;let n=this.entityCollection;n||(n=new ht({pickingEnabled:s._pickingEnabled,labelMaxLetters:s.labelMaxLetters}),n._layer=this.layer,n.addTo(r,!0),n._quadNode=this,s._bindEventsDefault(n),this.entityCollection=n),i||!s.async?this.entityCollection.addEntities(t):this.deferredEntities.push.apply(this.deferredEntities,t)}}_setExtentBounds(){this.nodeId?this.bsphere.setFromExtent(this.layer._planet.ellipsoid,this.extent.inverseMercator()):(this.bsphere.radius=this.layer._planet.ellipsoid.equatorialSize,this.bsphere.center=new v)}__setLonLat__(t){return t._lonLat.isZero()&&!t._cartesian.isZero()&&(t._lonLat=this.layer._planet.ellipsoid.cartesianToLonLat(t._cartesian)),Math.abs(t._lonLat.lat)<ce?t._lonLatMerc=t._lonLat.forwardMercator():t._lonLatMerc=new L,t._lonLatMerc}buildTree(t,i=!1){if(this.count+=t.length,t.length>this.layer._nodeCapacity){const s=this.childNodes;s.length||this.createChildNodes();let r=[],n=[],a=[],o=[],h=t.length;for(;h--;){const c=t[h];s[0].isInside(c)?(c._nodePtr=s[0],r.push(c)):s[1].isInside(c)?(c._nodePtr=s[1],n.push(c)):s[2].isInside(c)?(c._nodePtr=s[2],a.push(c)):s[3].isInside(c)&&(c._nodePtr=s[3],o.push(c))}r.length&&s[0].buildTree(r,i),n.length&&s[1].buildTree(n,i),a.length&&s[2].buildTree(a,i),o.length&&s[3].buildTree(o,i)}else this._addEntitiesToCollection(t,i)}isInside(t){return!!t._lonLatMerc&&this.extent.isInside(t._lonLatMerc)}createChildNodes(){const t=this.strategy,i=this.extent,s=.5*i.getWidth(),r=.5*i.getHeight(),n=i.northEast,a=i.southWest,o=new L(a.lon+s,a.lat+r),h=this.childNodes,c=this.layer._planet,d=this.zoom+1;h[0]=new bt(t,0,this,new j(new L(a.lon,a.lat+r),new L(a.lon+s,n.lat)),c,d),h[1]=new bt(t,1,this,new j(o,new L(n.lon,n.lat)),c,d),h[2]=new bt(t,2,this,new j(new L(a.lon,a.lat),o),c,d),h[3]=new bt(t,3,this,new j(new L(a.lon+s,a.lat),new L(n.lon,a.lat+r)),c,d)}collectRenderCollectionsPASS1(t,i){const s=t[this.nodeId];if(s){const r=this.childNodes;this.entityCollection?this.renderCollection(i,t):r.length&&(s.state===1?this.strategy._secondPASS.push(this):(r[0].collectRenderCollectionsPASS1(t,i),r[1].collectRenderCollectionsPASS1(t,i),r[2].collectRenderCollectionsPASS1(t,i),r[3].collectRenderCollectionsPASS1(t,i)))}}collectRenderCollectionsPASS2(t,i,s){const r=this.layer._planet.camera,n=r.eye.distance(this.bsphere.center)-this.bsphere.radius<3570*Math.sqrt(r._lonLat.height)||r._lonLat.height>1e4;if(this.count>0&&n&&r.containsSphere(this.bsphere)){const a=this.childNodes;this.entityCollection?this.renderCollection(i,t,s):a.length&&(a[0].collectRenderCollectionsPASS2(t,i,s),a[1].collectRenderCollectionsPASS2(t,i,s),a[2].collectRenderCollectionsPASS2(t,i,s),a[3].collectRenderCollectionsPASS2(t,i,s))}}applyCollection(){this.entityCollection.addEntities(this.deferredEntities),this.deferredEntities.length=0,this.deferredEntities=[],this._inTheQueue=!1}traverseTree(t){const i=this.childNodes;this.entityCollection?t(this):i.length&&(i[0].traverseTree(t),i[1].traverseTree(t),i[2].traverseTree(t),i[3].traverseTree(t))}renderCollection(t,i,s){const r=this.strategy;r._renderingNodes[this.nodeId]=!0,this.deferredEntities.length&&!this._inTheQueue&&(this.layer.async?r._queueDeferredNode(this):this.applyCollection());let n=this.entityCollection,a=this.layer;if(n._fadingOpacity=a._fadingOpacity,n.scaleByDistance=a.scaleByDistance,n.pickingScale=a.pickingScale,n.polygonOffsetUnits=a.polygonOffsetUnits,t.push(n),a.clampToGround||a.relativeToGround){const o=n._entities;let h=o.length;if(i[this.nodeId]&&i[this.nodeId].state===1)for(;h--;){let c=o[h];this.alignEntityToTheGround(c,i[this.nodeId].segment)}else if(s)for(;h--;){let c=o[h];this.alignEntityToTheGround(c,i[s].segment)}else{const c=this.strategy.quadTreeStrategy._renderedNodes;for(;h--;){let d=o[h],u=c.length;for(;u--;)if(c[u].segment.isEntityInside(d)){this.alignEntityToTheGround(d,c[u].segment);break}}}}}alignEntityToTheGround(t,i){let s=new v;i.getEntityTerrainPoint(t,s);let r=Number(this.layer.relativeToGround)&&t._altitude||0;if(r){let n=this.layer._planet.ellipsoid.getSurfaceNormal3v(s);t._setCartesian3vSilent(s.addA(n.scale(r)))}else t._setCartesian3vSilent(s)}isVisible(){return!!this.strategy._renderingNodes[this.nodeId]}}class wt extends bt{constructor(t,i,s,r,n,a){super(t,i,s,r,n,a),this.strategy=t,this.isNorth=!1}createChildNodes(){const t=this.strategy,i=this.extent,s=.5*i.getWidth(),r=.5*i.getHeight(),n=i.northEast,a=i.southWest,o=new L(a.lon+s,a.lat+r),h=this.childNodes,c=this.layer._planet,d=this.zoom+1;h[0]=new wt(t,0,this,new j(new L(a.lon,a.lat+r),new L(a.lon+s,n.lat)),c,d),h[1]=new wt(t,1,this,new j(o,new L(n.lon,n.lat)),c,d),h[2]=new wt(t,2,this,new j(new L(a.lon,a.lat),o),c,d),h[3]=new wt(t,3,this,new j(new L(a.lon+s,a.lat),new L(n.lon,a.lat+r)),c,d)}_setExtentBounds(){this.extent.northEast.lat>0&&(this.isNorth=!0),this.bsphere.setFromExtent(this.layer._planet.ellipsoid,this.extent)}__setLonLat__(t){return t._lonLat.isZero()&&(t._lonLat=this.layer._planet.ellipsoid.cartesianToLonLat(t._cartesian)),t._lonLat}isVisible(){return!(!this.isNorth||!this.strategy._renderingNodesNorth[this.nodeId])||!!this.strategy._renderingNodesSouth[this.nodeId]}isInside(t){return this.extent.isInside(t._lonLat)}renderCollection(t,i,s){this.isNorth?this.strategy._renderingNodesNorth[this.nodeId]=!0:this.strategy._renderingNodesSouth[this.nodeId]=!0,this.deferredEntities.length&&!this._inTheQueue&&(this.layer.async?this.strategy._queueDeferredNode(this):this.applyCollection());const r=this.entityCollection;r._fadingOpacity=this.layer._fadingOpacity,r.scaleByDistance=this.layer.scaleByDistance,r.pickingScale=this.layer.pickingScale,r.isEmpty()||t.push(r)}}class bc extends Ao{constructor(t,i,s){super(t,i,s);let r=i._planet;this._entityCollectionsTree=new bt(this,0,null,j.createFromArray([-2003750834e-2,-2003750834e-2,2003750834e-2,2003750834e-2]),r,0),this._entityCollectionsTreeNorth=new wt(this,0,null,j.createFromArray([-180,ce,180,90]),r,0),this._entityCollectionsTreeSouth=new wt(this,0,null,j.createFromArray([-180,-90,180,ke]),r,0),this._renderingNodes={},this._renderingNodesNorth={},this._renderingNodesSouth={}}insertEntity(t,i=!1){t._lonLat.lat>ce?(this._entityCollectionsTreeNorth.__setLonLat__(t),this._entityCollectionsTreeNorth.insertEntity(t,i)):t._lonLat.lat<ke?(this._entityCollectionsTreeSouth.__setLonLat__(t),this._entityCollectionsTreeSouth.insertEntity(t,i)):(this._entityCollectionsTree.__setLonLat__(t),this._entityCollectionsTree.insertEntity(t,i))}setPickingEnabled(t){this._entityCollectionsTree&&this._entityCollectionsTree.traverseTree((i=>{i.entityCollection.setPickingEnabled(t)})),this._entityCollectionsTreeNorth&&this._entityCollectionsTreeNorth.traverseTree((i=>{i.entityCollection.setPickingEnabled(t)})),this._entityCollectionsTreeSouth&&this._entityCollectionsTreeSouth.traverseTree((i=>{i.entityCollection.setPickingEnabled(t)}))}dispose(){this._entityCollectionsTree=null,this._entityCollectionsTreeNorth=null,this._entityCollectionsTreeSouth=null,this._renderingNodes={},this._renderingNodesNorth={},this._renderingNodesSouth={}}insertEntities(t){let i=[],s=[],r=[];for(let n=0,a=t.length;n<a;n++){let o=t[n];o._lonLat.lat>ce?(i.push(o),this._entityCollectionsTreeNorth.__setLonLat__(o)):o._lonLat.lat<ke?(s.push(o),this._entityCollectionsTreeSouth.__setLonLat__(o)):(r.push(o),this._entityCollectionsTree.__setLonLat__(o))}this._entityCollectionsTree.buildTree(r),this._entityCollectionsTreeNorth.buildTree(i),this._entityCollectionsTreeSouth.buildTree(s)}collectVisibleEntityCollections(t){this._renderingNodes={},this._renderingNodesNorth={},this._renderingNodesSouth={};let i=this._layer._planet.quadTreeStrategy;this._secondPASS=[],this._entityCollectionsTree.collectRenderCollectionsPASS1(i._visibleNodes,t);let s=this._secondPASS.length;for(;s--;)this._secondPASS[s].collectRenderCollectionsPASS2(i._visibleNodes,t,this._secondPASS[s].nodeId);for(this._secondPASS=[],this._entityCollectionsTreeNorth.collectRenderCollectionsPASS1(i._visibleNodesNorth,t),s=this._secondPASS.length;s--;)this._secondPASS[s].collectRenderCollectionsPASS2(i._visibleNodesNorth,t,this._secondPASS[s].nodeId);for(this._secondPASS=[],this._entityCollectionsTreeSouth.collectRenderCollectionsPASS1(i._visibleNodesSouth,t),s=this._secondPASS.length;s--;)this._secondPASS[s].collectRenderCollectionsPASS2(i._visibleNodesSouth,t,this._secondPASS[s].nodeId)}}class wc extends yc{constructor(t){super({name:"Earth",...t}),this._visibleNodesNorth={},this._visibleNodesSouth={}}collectVisibleNode(t){let i=t.segment._tileGroup;i===20?this._visibleNodesNorth[t.nodeId]=t:i===Ct?this._visibleNodesSouth[t.nodeId]=t:this._visibleNodes[t.nodeId]=t}_clearVisibleNodes(){super._clearVisibleNodes(),this._visibleNodesNorth={},this._visibleNodesSouth={}}createEntityCollectionsTreeStrategy(t,i){return new bc(this,t,i)}init(t){this._quadTreeList=[new ut(Co,this,0,null,0,j.createFromArray([-2003750834e-2,-2003750834e-2,2003750834e-2,2003750834e-2])),new ut(un,this,0,null,0,j.createFromArray([-180,ce,180,90])),new ut(un,this,0,null,0,j.createFromArray([-180,-90,180,ke]))],super.init(t)}getTileXY(t,i){let s,r,n=(function(h,c=ce){return h>c?20:h<-c?Ct:0})(t.lat,ce),a=i,o=1<<a;if(n===20)s=Ne(t.lon,360/o,-180),r=Ne(t.lat,(90-ce)/o,90);else if(n===Ct)s=Ne(t.lon,360/o,-180),r=Ne(t.lat,(90-ce)/o,ke);else{let h=Ui(t);s=Ne(h.lon,Vi/o,-2003750834e-2),r=Ne(h.lat,Vi/o,Ae)}return[s,r,a,n]}getLonLatTileOffset(t,i,s,r,n){let a,o=t;t.lat>ce?a=Vs(i,s,r,j.createFromArray([-180,ce,180,90])):t.lat<ke?a=Vs(i,s,r,j.createFromArray([-180,-90,180,ke])):(o=Ui(t),a=Gt(i,s,r));let h=a.getWidth()/(n-1),c=a.getHeight()/(n-1);return[n-Math.ceil((o.lat-a.southWest.lat)/c)-1,Math.floor((o.lon-a.southWest.lon)/h)]}}class Lo{constructor(t={}){this.model=t.model||null,this.src=t.src||null,this._cached_ix=0,this._cached_iy=0,this._v00=0,this._v01=0,this._v10=0,this._v11=0,this._t=0}static loadModel(t){return t?fetch(t,{}).then((i=>{if(!i.ok)throw Error("Geoid model file: HTTP error "+i.status);return i.arrayBuffer()})).then((i=>{if(i)return new Uint8Array(i);throw Error("Geoid model file: no data from "+t)})).then((function(i){if(i[0]!==80||i[1]!==53||(i[2]!==13||i[3]!==10)&&i[2]!==10)throw new Error("Geoid model file: no PGM header");var s,r,n=i[2]===13?4:3,a=null,o=null;function h(){let u=n;for(var _=n;;_++){if(_>=i.length)throw new Error("Geoid model file: missing newline in header");if(i[_]===10){n=_+1;break}}return _>u&&i[_-1]===13&&_--,String.fromCharCode.apply(null,i.slice(u,_))}for(;(r=h())[0]==="#";)if(s=r.match(/^# Offset (.*)$/)){if(a=parseInt(s[1],10),!isFinite(a))throw new Error("Geoid model file: bad offset "+s[1])}else if((s=r.match(/^# Scale (.*)$/))&&(o=parseFloat(s[1]),!isFinite(o)))throw new Error("Geoid model file: bad scale "+s[1]);let c=0,d=0;if((s=r.match(/^\s*(\d+)\s+(\d+)\s*$/))&&(c=parseInt(s[1],10),d=parseInt(s[2],10)),!(s&&c>=0&&d>=0))throw new Error("Geoid model file: bad PGM width&height line");if(parseInt(h())!=65535)throw new Error("Geoid model file: PGM file must have 65535 gray levels");if(a===null)throw new Error("Geoid model file: PGM file does not contain offset");if(o===null)throw new Error("Geoid model file: PGM file does not contain scale");if(c<2||d<2)throw new Error("Geoid model file: Raster size too small");if(i.length-n!=c*d*2)throw new Error("Geoid model file: File has the wrong length");return{scale:o,offset:a,width:c,height:d,rlonres:c/360,rlatres:(d-1)/180,i:n,rawfile:i}})):new Promise((i=>{i(null)}))}setModel(t){this.model=t}_rawval(t,i){let s=this.model;i<0?(i=-i,t+=s.width/2):i>=s.height&&(i=2*(s.height-1)-i,t+=s.width/2),t<0?t+=s.width:t>=s.width&&(t-=s.width);let r=2*(i*s.width+t)+s.i;return s.rawfile[r]<<8|s.rawfile[r+1]}getHeightLonLat(t){return this.getHeight(t.lon,t.lat)}getHeight(t,i){if(!this.model)return 0;let s=this.model;t<0&&(t+=360);let r=(90-i)*s.rlatres,n=t*s.rlonres,a=Math.floor(r),o=Math.floor(n);n-=o,r-=a,a===s.height-1&&a--,this._cached_ix===o&&this._cached_iy===a||(this._cached_ix=o,this._cached_iy=a,this._v00=this._rawval(o,a),this._v01=this._rawval(o+1,a),this._v10=this._rawval(o,a+1),this._v11=this._rawval(o+1,a+1));let h=(1-r)*((1-n)*this._v00+n*this._v01)+r*((1-n)*this._v10+n*this._v11);return s.offset+s.scale*h}}class Tc{constructor(t,i=5){this.MAX_FRAMES=i,this._gridSize=64,this._planet=t,this._framebuffer=null,this._framebufferMercProj=null,this._texCoordsBuffer=null,this._indexBuffer=null,this._currentFrame=0,this._queue=[],this._animate=[],this._quadTexCoordsBuffer=null,this._quadVertexBuffer=null}init(){this._initShaders(),this._initBuffers()}createGridBuffer(t,i=!1){let s=this._gridSize,r=new L((t[3].lon-t[0].lon)/s,(t[3].lat-t[0].lat)/s),n=new L((t[2].lon-t[1].lon)/s,(t[2].lat-t[1].lat)/s),a=new L((t[1].lon-t[0].lon)/s,(t[1].lat-t[0].lat)/s),o=new L((t[2].lon-t[3].lon)/s,(t[2].lat-t[3].lat)/s);const h=(s+1)*(s+1)*2,c=h/2;let d=new Float32Array(h),u=new Float32Array(h),_=new Array(c),p=0,f=0,m=0,g=new Float32Array(2);for(let y=0;y<=s;y++){let x=new L(t[0].lon+y*r.lon,t[0].lat+y*r.lat),b=new L(t[1].lon+y*n.lon,t[1].lat+y*n.lat);for(let T=0;T<=s;T++){let w=kn(x,b,new L(t[0].lon+T*a.lon,t[0].lat+T*a.lat),new L(t[3].lon+T*o.lon,t[3].lat+T*o.lat));rt(w.lon,g),d[p++]=g[0],u[f++]=g[1],rt(w.lat,g),d[p++]=g[0],u[f++]=g[1],_[m++]=w}}if(i)for(let y=0;y<c;y++){let x=_[y].forwardMercator();rt(x.lon,g),d[2*y]=g[0],u[2*y]=g[1],rt(x.lat,g),d[2*y+1]=g[0],u[2*y+1]=g[1]}return[this._planet.renderer.handler.createArrayBuffer(d,2,c),this._planet.renderer.handler.createArrayBuffer(u,2,c)]}frame(){let t=this.MAX_FRAMES;for(;t--&&this._queue.length;){const i=this._queue.shift();i._isRendering=!1,i.rendering(),i.events.dispatch(i.events.loadend)}for(t=this._animate.length;t--;)this._animate[t].rendering()}add(t){t._isRendering||(t._isRendering=!0,t._animate?this._animate.push(t):this._queue.push(t))}remove(t){if(t._isRendering){let i;t._creationProceeding=!1,t._isRendering=!1,i=t._animate?this._animate:this._queue;for(let s=0;s<i.length;s++)if(i[s].isEqual(t))return void i.splice(s,1)}}_initBuffers(){let t=this._planet.renderer.handler;this._framebuffer=new Pe(t,{width:2,height:2,useDepth:!1}),this._framebuffer.init(),this._framebufferMercProj=new Pe(t,{width:2,height:2,useDepth:!1}),this._framebufferMercProj.init();let i=Math.log2(this._gridSize);this._texCoordsBuffer=this._planet._textureCoordsBufferCache[i],this._indexBuffer=this._planet._indexesCache[i][i][i][i][i].buffer,this._quadTexCoordsBuffer=t.createArrayBuffer(new Float32Array([0,1,1,1,0,0,1,0]),2,4),this._quadVertexBuffer=t.createArrayBuffer(new Float32Array([-1,1,1,1,-1,-1,1,-1]),2,4)}_initShaders(){this._planet.renderer.handler.addProgram(new X("geoImageTransform",{uniforms:{sourceTexture:"sampler2d",extentParamsHigh:"vec4",extentParamsLow:"vec4",isFullExtent:"bool"},attributes:{cornersHigh:"vec2",cornersLow:"vec2",texCoords:"vec2"},vertexShader:`attribute vec2 cornersHigh; 
                     attribute vec2 cornersLow;
                      attribute vec2 texCoords; 
                      uniform vec4 extentParamsHigh; 
                      uniform vec4 extentParamsLow; 
                      varying vec2 v_texCoords;
                      void main() {                                                             
                          v_texCoords = texCoords; 
                          vec2 highDiff = cornersHigh - extentParamsHigh.xy;
                          vec2 lowDiff = cornersLow - extentParamsLow.xy;                                        
                          gl_Position = vec4((-1.0 + (highDiff * step(1.0, length(highDiff)) + lowDiff) * extentParamsHigh.zw) * vec2(1.0, -1.0), 0.0, 1.0); 
                      }`,fragmentShader:`precision highp float;
                        uniform sampler2D sourceTexture;
                        uniform bool isFullExtent;
                        varying vec2 v_texCoords;
                        void main () {
                            if(!isFullExtent && (v_texCoords.x <= 0.001 || v_texCoords.x >= 0.999 ||
                                v_texCoords.y <= 0.001 || v_texCoords.y >= 0.999)) {
                                discard;
                            }
                            gl_FragColor = texture2D(sourceTexture, v_texCoords);
                        }`}))}}const Cc=["loadend","layerloadend"];class Po{constructor(t=24){this.MAX_REQUESTS=t,this.events=le(Cc),this._loading=0,this._queue=[],this._senderRequestCounter=[],this._promises={json:i=>i.json(),blob:i=>i.blob(),arrayBuffer:i=>i.arrayBuffer(),imageBitmap:i=>i.blob().then((s=>createImageBitmap(s,{premultiplyAlpha:"premultiply"}))),text:i=>i.text()}}load(t,i){t.sender&&(this._senderRequestCounter[t.sender.__id]||(this._senderRequestCounter[t.sender.__id]={sender:t.sender,counter:0,__requestCounterFrame__:0}),this._senderRequestCounter[t.sender.__id].counter++),this._queue.push({params:t,callback:i}),this._exec()}fetch(t){return fetch(t.src,t.options||{}).then((i=>{if(!i.ok)throw Error(`Unable to load '${t.src}'`);return this._promises[t.type||"blob"](i)})).then((i=>({status:"ready",data:i}))).catch((i=>({status:"error",msg:i.toString()})))}getRequestCounter(t){if(t){let i=this._senderRequestCounter[t.__id];if(i)return i.counter}return 0}isIdle(t){return t.isIdle}_checkLoadend(t,i){t.counter===0&&(!i._planet||i.quadTreeStrategy&&i.quadTreeStrategy._terrainCompletedActivated)?(i.events.dispatch(i.events.loadend,i),this.events.dispatch(this.events.layerloadend,i),t.__requestCounterFrame__=0):t.__requestCounterFrame__=requestAnimationFrame((()=>{this._checkLoadend(t,i)}))}_handleResponse(t,i){t.callback(i);let s=t.params.sender;if(s&&(s.events.loadend.handlers.length||this.events.layerloadend.handlers.length)){let r=this._senderRequestCounter[s.__id];r&&r.counter>0&&(r.counter--,cancelAnimationFrame(r.__requestCounterFrame__),r.__requestCounterFrame__=requestAnimationFrame((()=>{this._checkLoadend(r,s)})))}this._exec()}_exec(){if(this._queue.length>0&&this._loading<this.MAX_REQUESTS){let t=this._queue.pop();if(!t)return;let i=t.params;if(!i.filter||i.filter(i))return this._loading++,fetch(i.src,i.options||{}).then((s=>{if(!s.ok)throw Error(`Unable to load '${i.src}'`);return this._promises[i.type||"blob"](s)})).then((s=>{this._loading--,this._handleResponse(t,{status:"ready",data:s})})).catch((s=>{this._loading--,this._handleResponse(t,{status:"error",msg:s.toString()})}));this._handleResponse(t,{status:"abort"})}else this._loading===0&&this.events.dispatch(this.events.loadend)}abort(t){this._senderRequestCounter[t.__id]&&(this._senderRequestCounter[t.__id].counter=0,cancelAnimationFrame(this._senderRequestCounter[t.__id].__requestCounterFrame__),this._senderRequestCounter[t.__id].__requestCounterFrame__=0);for(let i=0,s=this._queue.length;i<s;i++){let r=this._queue[i];r&&r.params.sender&&t.isEqual(r.params.sender)&&(r.callback({status:"abort"}),this._queue[i]=null)}}abortAll(){for(let t=0,i=this._queue.length;t<i;t++){let s=this._queue[t];if(s){let r=s.params.sender;r&&this._senderRequestCounter[r.__id]&&(this._senderRequestCounter[r.__id].counter=0,cancelAnimationFrame(this._senderRequestCounter[r.__id].__requestCounterFrame__),this._senderRequestCounter[r.__id].__requestCounterFrame__=0),s.callback({status:"abort"}),this._queue[t]=null}}this._queue=[]}get loading(){return this._loading}get queue(){return this._queue}}class Ac{constructor(t,i={}){this._minTabelSize=i.minTableSize||1,this._maxTableSize=i.maxTableSize||8,this._planet=t,this._handler=null,this._verticesBufferArray=[],this._indexBufferArray=[],this._positionBuffer=null,this._framebuffer=null,this._normalMapVerticesTexture=null,this._width=i.width||128,this._height=i.height||128,this._queue=new _r(1024),this._lock=new Os}get width(){return this._width}get height(){return this._height}init(){this._maxTableSize=this._planet.maxGridSize||8,this._handler=this._planet.renderer.handler;const t=new X("normalMapBlur",{attributes:{a_position:"vec2"},uniforms:{s_texture:"sampler2d"},vertexShader:`attribute vec2 a_position;
                       attribute vec2 a_texCoord;

                      varying vec2 blurCoordinates[5];

                      void main() {
                          vec2 vt = a_position * 0.5 + 0.5; 
                           
                          gl_Position = vec4(a_position, 0.0, 1.0);
                          blurCoordinates[0] = vt;
                          blurCoordinates[1] = vt + ${1/this._width*1.407333};
                          blurCoordinates[2] = vt - ${1/this._height*1.407333};
                          blurCoordinates[3] = vt + ${1/this._width*3.294215};
                          blurCoordinates[4] = vt - ${1/this._height*3.294215};
                }`,fragmentShader:`precision lowp float;
                        uniform sampler2D s_texture;                        
                        varying vec2 blurCoordinates[5];                        

                        void main() {
                            lowp vec4 sum = vec4(0.0);
                            //if(blurCoordinates[0].x <= 0.01 || blurCoordinates[0].x >= 0.99 ||
                            //    blurCoordinates[0].y <= 0.01 || blurCoordinates[0].y >= 0.99){
                            //    sum = texture2D(s_texture, blurCoordinates[0]);
                            //} else {
                                sum += texture2D(s_texture, blurCoordinates[0]) * 0.204164;
                                sum += texture2D(s_texture, blurCoordinates[1]) * 0.304005;
                                sum += texture2D(s_texture, blurCoordinates[2]) * 0.304005;
                                sum += texture2D(s_texture, blurCoordinates[3]) * 0.093913;
                                sum += texture2D(s_texture, blurCoordinates[4]) * 0.093913;
                            //}
                            gl_FragColor = sum;
                        }`}),i=new X("normalMap",{attributes:{a_position:"vec2",a_normal:"vec3"},uniforms:{},vertexShader:`attribute vec2 a_position;
                      attribute vec3 a_normal;
                      
                      varying vec3 v_color;
                      
                      void main() {
                          gl_Position = vec4(a_position, 0, 1);
                          v_color = normalize(a_normal) * 0.5 + 0.5;
                      }`,fragmentShader:`precision highp float;
                        
                        varying vec3 v_color;
                        
                        void main () {
                            gl_FragColor = vec4(v_color, 1.0);
                        }`});this._handler.addProgram(t),this._handler.addProgram(i),this._framebuffer=new Pe(this._handler,{width:this._width,height:this._height,useDepth:!1}),this._framebuffer.init(),this._normalMapVerticesTexture=this._handler.createEmptyTexture_l(this._width,this._height);for(let r=this._minTabelSize;r<=this._maxTableSize;r++){const n=1<<r,a=n/2;let o=new Float32Array((n+1)*(n+1)*2);for(let h=0;h<=n;h++)for(let c=0;c<=n;c++){let d=2*(h*(n+1)+c);o[d]=c/a-1,o[d+1]=h/a-1}this._verticesBufferArray[n]=this._handler.createArrayBuffer(o,2,o.length/2),this._indexBufferArray[n]=this._planet._indexesCache[Math.log2(n)][Math.log2(n)][Math.log2(n)][Math.log2(n)][Math.log2(n)].buffer}const s=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this._positionBuffer=this._handler.createArrayBuffer(s,2,s.length/2)}_drawNormalMapBlur(t){let i=t.normalMapNormals;if(t.node&&t.node.getState()!==0&&i&&i.length){const s=i.length/3,r=Math.sqrt(s)-1;let n=this._verticesBufferArray[r];if(n){t.planet.terrain.equalizeNormals&&(t._normalMapEdgeEqualize(0),t._normalMapEdgeEqualize(2),t._normalMapEdgeEqualize(3),t._normalMapEdgeEqualize(1));let a=t.normalMapTexturePtr;const o=this._handler,h=o.gl;let c=o.createArrayBuffer(i,3,s,h.DYNAMIC_DRAW);const d=this._framebuffer;let u=o.programs.normalMap,_=u._program.attributes;return d.bindOutputTexture(this._normalMapVerticesTexture),u.activate(),h.bindBuffer(h.ARRAY_BUFFER,n),h.vertexAttribPointer(_.a_position,n.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,c),h.vertexAttribPointer(_.a_normal,c.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,this._indexBufferArray[r]),h.drawElements(h.TRIANGLE_STRIP,this._indexBufferArray[r].numItems,h.UNSIGNED_INT,0),h.deleteBuffer(c),d.bindOutputTexture(a),u=o.programs.normalMapBlur,u.activate(),h.bindBuffer(h.ARRAY_BUFFER,this._positionBuffer),h.vertexAttribPointer(u._program.attributes.a_position,this._positionBuffer.itemSize,h.FLOAT,!1,0,0),h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,this._normalMapVerticesTexture),h.uniform1i(u._program.uniforms.s_texture,0),h.drawArrays(h.TRIANGLE_STRIP,0,this._positionBuffer.numItems),!0}return!0}return!1}_drawNormalMapNoBlur(t){let i=t.normalMapNormals;if(t.node&&t.node.getState()!==0&&i&&i.length){const s=i.length/3,r=Math.sqrt(s)-1;let n=this._verticesBufferArray[r];if(n){t.planet.terrain.equalizeNormals&&(t._normalMapEdgeEqualize(0),t._normalMapEdgeEqualize(2),t._normalMapEdgeEqualize(3),t._normalMapEdgeEqualize(1));let a=t.normalMapTexturePtr;const o=this._handler,h=o.gl;let c=o.createArrayBuffer(i,3,s,h.DYNAMIC_DRAW);const d=this._framebuffer,u=o.programs.normalMap,_=u._program.attributes;return d.bindOutputTexture(a),u.activate(),h.bindBuffer(h.ARRAY_BUFFER,n),h.vertexAttribPointer(_.a_position,n.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,c),h.vertexAttribPointer(_.a_normal,c.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,this._indexBufferArray[r]),h.drawElements(h.TRIANGLE_STRIP,this._indexBufferArray[r].numItems,h.UNSIGNED_INT,0),h.deleteBuffer(c),!0}return!0}return!1}_drawNormalMap(t){return t.planet.terrain.isBlur(t)?this._drawNormalMapBlur(t):this._drawNormalMapNoBlur(t)}drawSingle(t){const i=this._handler.gl;this._framebuffer.activate(),i.disable(i.CULL_FACE),i.disable(i.DEPTH_TEST),i.disable(i.BLEND),t.terrainReady&&this._drawNormalMap(t)&&(t.normalMapReady=!0,t.normalMapTexture=t.normalMapTexturePtr,t.normalMapTextureBias[0]=0,t.normalMapTextureBias[1]=0,t.normalMapTextureBias[2]=1),t._inTheQueue=!1,i.enable(i.DEPTH_TEST),i.enable(i.CULL_FACE),i.enable(i.BLEND),this._framebuffer.deactivate()}frame(){if(this._queue.length){const t=this._handler.gl;this._framebuffer.activate(),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.BLEND);let i=0,s=window.performance.now();for(;this._lock.isFree()&&this._queue.length&&i<.25;){const r=this._queue.shift();r.terrainReady&&this._drawNormalMap(r)&&(r.normalMapReady=!0,r.normalMapTexture=r.normalMapTexturePtr,r.normalMapTextureBias[0]=0,r.normalMapTextureBias[1]=0,r.normalMapTextureBias[2]=1),r._inTheQueue=!1,i=window.performance.now()-s}t.enable(t.BLEND),t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),this._framebuffer.deactivate()}}get queueSize(){return this._queue.length}queue(t){t._inTheQueue=!0,this._queue.push(t)}unshift(t){t._inTheQueue=!0,this._queue.unshift(t)}remove(t){}clear(){for(;this._queue.length;)this._queue.pop()._inTheQueue=!1}lock(t){this._lock.lock(t)}free(t){this._lock.free(t)}}const Ec=new dr({code:"equi",units:To}),So=`(function(){"use strict";let l=null,K=null,O=null,Q=null,S=null,T=null,U=null;function P(a,t){t<0?(t=-t,a+=l.width/2):t>=l.height&&(t=2*(l.height-1)-t,a+=l.width/2),a<0?a+=l.width:a>=l.width&&(a-=l.width);var n=2*(t*l.width+a)+l.i;return l.rawfile[n]<<8|l.rawfile[n+1]}const sa=.5*Math.PI,W=2003750834e-2,ia=Math.PI/W,ua=180/W,X=180/Math.PI,Ma=X*sa,Y=Math.PI/180,da=2*X;let k=0,Z=0,_=null;const B=function(a,t,n){this.x=a,this.y=t,this.z=n};var $=function(a,t,n,o){let f=function(c,C){if(!l)return 0;c<0&&(c+=360);var w=(90-C)*l.rlatres,M=c*l.rlonres,u=Math.floor(w),d=Math.floor(M);M-=d,w-=u,u===l.height-1&&u--,K===d&&O===u||(K=d,O=u,Q=P(d,u),S=P(d+1,u),T=P(d,u+1),U=P(d+1,u+1));let L=null;return L=(1-w)*((1-M)*Q+M*S)+w*((1-M)*T+M*U),l.offset+l.scale*L}(a,t)*n,h=Y*t,r=Y*a,m=Math.sin(h),x=Z/Math.sqrt(1-k*m*m),H=(x+f)*Math.cos(h);o.x=H*Math.cos(r),o.y=H*Math.sin(r),o.z=(x*(1-k)+f)*m},ma=function(a,t,n,o){$(a*ua,da*Math.atan(Math.exp(t*ia))-Ma,n,o)},e=new B(0,0,0),p=new B(0,0,0),y=new B(0,0,0),pa=function(a,t,n){let o=a.x,f=a.y,h=a.z;var r;o>=0?(r=65536*Math.floor(o/65536),t.x=Math.fround(r),n.x=Math.fround(o-r)):(r=65536*Math.floor(-o/65536),t.x=Math.fround(-r),n.x=Math.fround(o+r)),f>=0?(r=65536*Math.floor(f/65536),t.y=Math.fround(r),n.y=Math.fround(f-r)):(r=65536*Math.floor(-f/65536),t.y=Math.fround(-r),n.y=Math.fround(f+r)),h>=0?(r=65536*Math.floor(h/65536),t.z=Math.fround(r),n.z=Math.fround(h-r)):(r=65536*Math.floor(-h/65536),t.z=Math.fround(-r),n.z=Math.fround(h+r))};self.onmessage=function(a){if(a.data.model)l=a.data.model,l.rawfile=a.data.rawfile;else if(a.data.params){let t=549755748352,n=-549755748352,o=549755748352,f=-549755748352,h=549755748352,r=-549755748352;k=a.data.params[8],Z=a.data.params[9];let m=a.data.params[2],x=a.data.params[3],H=a.data.params[10],c=a.data.params[11],C=a.data.params[12],w=a.data.params[13];_=a.data.params[1]===0?ma:$;let M=Math.max(x,m),u=(a.data.params[6]-a.data.params[4])/M,d=(a.data.params[7]-a.data.params[5])/M,L=a.data.params[4],ya=a.data.params[7],aa=Math.max(x/m,1),N=M+1;const z=N*N,R=(m+1)*(m+1)*3;let b=new Float32Array(R),A=new Float64Array(R),F=new Float32Array(R),g=new Float32Array(R),V=new Float32Array(3*z),q=new Float64Array(3*z),v=new Float32Array(3*z),I=new Float32Array(3*z),s=0,i=0;for(let j=0;j<z;j++){let la=j%N,na=~~(j/N);_(L+la*u,ya-na*d,w,e);let D=e.x*H,E=e.y*c,G=e.z*C,J=1/Math.sqrt(D*D+E*E+G*G),oa=D*J,fa=E*J,ha=G*J;pa(e,p,y),q[i]=e.x,v[i]=p.x,I[i]=y.x,V[i++]=oa,q[i]=e.y,v[i]=p.y,I[i]=y.y,V[i++]=fa,q[i]=e.z,v[i]=p.z,I[i]=y.z,V[i++]=ha,na%aa==0&&la%aa==0&&(A[s]=e.x,F[s]=p.x,g[s]=y.x,b[s++]=oa,A[s]=e.y,F[s]=p.y,g[s]=y.y,b[s++]=fa,A[s]=e.z,F[s]=p.z,g[s]=y.z,b[s++]=ha,e.x<t&&(t=e.x),e.x>n&&(n=e.x),e.y<o&&(o=e.y),e.y>f&&(f=e.y),e.z<h&&(h=e.z),e.z>r&&(r=e.z))}let ta=.5*(n-t),ra=.5*(f-o),ea=.5*(r-h),wa=Math.sqrt(ta*ta+ra*ra+ea*ea);self.postMessage({id:a.data.params[0],plainVertices:A,plainVerticesHigh:F,plainVerticesLow:g,plainNormals:b,normalMapNormals:V,normalMapVertices:q,normalMapVerticesHigh:v,normalMapVerticesLow:I,plainRadius:wa},[A.buffer,F.buffer,g.buffer,b.buffer,V.buffer,q.buffer,v.buffer,I.buffer])}}})();
//# sourceMappingURL=PlainSegmentWorker.worker-CT1cj8jj.js.map
`,_n=typeof self<"u"&&self.Blob&&new Blob([So],{type:"text/javascript;charset=utf-8"});function Lc(l){let t;try{if(t=_n&&(self.URL||self.webkitURL).createObjectURL(_n),!t)throw"";const i=new Worker(t,{name:l?.name});return i.addEventListener("error",(()=>{(self.URL||self.webkitURL).revokeObjectURL(t)})),i}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(So),{name:l?.name})}finally{t&&(self.URL||self.webkitURL).revokeObjectURL(t)}}class Pc extends sr{constructor(t=2){super(t,Lc)}_onMessage(t){this._source.get(t.data.id)._plainSegmentWorkerCallback(t.data),t.data.plainVertices=null,t.data.plainVerticesHigh=null,t.data.plainVerticesLow=null,t.data.plainNormals=null,t.data.normalMapNormals=null,t.data.normalMapVertices=null,t.data.normalMapVerticesHigh=null,t.data.normalMapVerticesLow=null,this._source.delete(t.data.id)}setGeoid(t){if(t.model){let i=t.model,s={scale:i.scale,offset:i.offset,width:i.width,height:i.height,rlonres:i.rlonres,rlatres:i.rlatres,i:i.i};this._workerQueue.forEach((r=>{let n=new Uint8Array(i.rawfile.length);n.set(i.rawfile),r.postMessage({model:s,rawfile:n},[n.buffer])}))}else this._workerQueue.forEach((i=>{i.postMessage({model:null})}))}make(t){if(t.initialized)if(this._workerQueue.length){let i=this._workerQueue.pop();this._source.set(this._sourceId,t);let s=t._projection.id===Eo.id||t._projection.id===Ec.id?1:0,r=new Float64Array([this._sourceId,s,t.planet.terrain.gridSizeByZoom[t.tileZoom],t.planet.terrain.plainGridSize,t._extent.southWest.lon,t._extent.southWest.lat,t._extent.northEast.lon,t._extent.northEast.lat,t.planet.ellipsoid._e2,t.planet.ellipsoid.equatorialSize,t.planet.ellipsoid._invRadii2.x,t.planet.ellipsoid._invRadii2.y,t.planet.ellipsoid._invRadii2.z,t.planet._heightFactor]);this._sourceId++,i.postMessage({params:r},[r.buffer])}else this._pendingQueue.push(t);else this.check()}}const Ro=`(function(){"use strict";function H(r,e){return function(z,b){let v=0,N=z.length-1;for(;v<=N;){let n=Math.floor(.5*(v+N));if(Math.abs(z[n]-b)<.001)return n;z[n]<b?v=n+1:N=n-1}return-1}(r,e)!==-1}var y=function(r,e,z){this.x=r,this.y=e,this.z=z},Y=function(r,e,z){let b=r.x,v=r.y,N=r.z;var n;b>=0?(n=65536*Math.floor(b/65536),e.x=Math.fround(n),z.x=Math.fround(b-n)):(n=65536*Math.floor(-b/65536),e.x=Math.fround(-n),z.x=Math.fround(b+n)),v>=0?(n=65536*Math.floor(v/65536),e.y=Math.fround(n),z.y=Math.fround(v-n)):(n=65536*Math.floor(-v/65536),e.y=Math.fround(-n),z.y=Math.fround(v+n)),N>=0?(n=65536*Math.floor(N/65536),e.z=Math.fround(n),z.z=Math.fround(N-n)):(n=65536*Math.floor(-N/65536),e.z=Math.fround(-n),z.z=Math.fround(N+n))};y.prototype.sub=function(r){return new y(this.x-r.x,this.y-r.y,this.z-r.z)},y.prototype.add=function(r){return new y(this.x+r.x,this.y+r.y,this.z+r.z)},y.prototype.cross=function(r){return new y(this.y*r.z-this.z*r.y,this.z*r.x-this.x*r.z,this.x*r.y-this.y*r.x)},y.prototype.normalize=function(r){var e=this.x,z=this.y,b=this.z,v=1/Math.sqrt(e*e+z*z+b*b);return this.x=e*v,this.y=z*v,this.z=b*v,this},y.prototype.distance=function(r){return this.sub(r).length()},y.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};var x=new y(0,0,0),i=new y(0,0,0),t=new y(0,0,0);self.onmessage=function(r){var e=r.data.elevations,z=r.data.this_plainVertices,b=r.data.this_plainNormals,v=r.data.this_normalMapVertices,N=r.data.this_normalMapNormals,n=r.data.heightFactor,Dr=r.data.gridSize,D=r.data.noDataValues,Hr=r.data.id,Q=549755748352,W=-549755748352,T=549755748352,$=-549755748352,Z=549755748352,X=-549755748352;const J=Math.sqrt(e.length)-1,K=J+1,R=K*K,C=Dr,vr=J/C,L=C+1,tr=n;var a,d,p,m,yr,sr,S=0,xr=0,U=L*L*3,h=new Float64Array(U),j=new Float32Array(U),k=new Float32Array(U),lr=new Uint8Array(L*L),u=v,g=N;if(J>=C){a=new Float32Array(3*R),d=new Float64Array(3*R),p=new Float32Array(3*R),m=new Float32Array(3*R);for(let f=0;f<R;f++){var Ar=f%K,Fr=~~(f/K),ur=f,o=3*ur,rr=e[ur];H(D,rr)&&(rr=0);var Mr=tr*rr,s=new y(u[o]+Mr*g[o],u[o+1]+Mr*g[o+1],u[o+2]+Mr*g[o+2]);if(Y(s,i,t),d[o]=s.x,d[o+1]=s.y,d[o+2]=s.z,p[o]=i.x,p[o+1]=i.y,p[o+2]=i.z,m[o]=t.x,m[o+1]=t.y,m[o+2]=t.z,Fr%vr==0&&Ar%vr==0){let A=new y(u[o],u[o+1],u[o+2]),V=new y(u[o+3],u[o+4],u[o+5]),F=e[ur+1];H(D,F)&&(F=0);let q=!1;if(D.length===0){let _=A.distance(V);q=Math.abs(rr-F)/_>10||rr<-5e3}q?lr[xr]=1:(lr[xr]=0,s.x<Q&&(Q=s.x),s.x>W&&(W=s.x),s.y<T&&(T=s.y),s.y>$&&($=s.y),s.z<Z&&(Z=s.z),s.z>X&&(X=s.z)),j[S]=i.x,k[S]=t.x,h[S++]=s.x,j[S]=i.y,k[S]=t.y,h[S++]=s.y,j[S]=i.z,k[S]=t.z,h[S++]=s.z,xr++}if(Fr!==J&&Ar!==J){var gr=f+1,M=3*gr,B=e[gr];H(D,B)&&(B=0);var cr=tr*B,ar=new y(u[M]+cr*g[M],u[M+1]+cr*g[M+1],u[M+2]+cr*g[M+2]);Y(ar,i,t),d[M]=ar.x,d[M+1]=ar.y,d[M+2]=ar.z,p[M]=i.x,p[M+1]=i.y,p[M+2]=i.z,m[M]=t.x,m[M+1]=t.y,m[M+2]=t.z;var Vr=f+K,c=3*Vr;H(D,B=e[Vr])&&(B=0);var wr=tr*B,nr=new y(u[c]+wr*g[c],u[c+1]+wr*g[c+1],u[c+2]+wr*g[c+2]);Y(nr,i,t),d[c]=nr.x,d[c+1]=nr.y,d[c+2]=nr.z,p[c]=i.x,p[c+1]=i.y,p[c+2]=i.z,m[c]=t.x,m[c+1]=t.y,m[c+2]=t.z;var qr=f+K+1,w=3*qr;H(D,B=e[qr])&&(B=0);var dr=tr*B,er=new y(u[w]+dr*g[w],u[w+1]+dr*g[w+1],u[w+2]+dr*g[w+2]);Y(er,i,t),d[w]=er.x,d[w+1]=er.y,d[w+2]=er.z,p[w]=i.x,p[w+1]=i.y,p[w+2]=i.z,m[w]=t.x,m[w+1]=t.y,m[w+2]=t.z;var Lr=ar.sub(s),Sr=nr.sub(s),Nr=er.sub(s),hr=Sr.cross(Nr).normalize(),zr=Nr.cross(Lr).normalize(),O=zr.add(hr).normalize();a[o]+=O.x,a[o+1]+=O.y,a[o+2]+=O.z,a[M]+=zr.x,a[M+1]+=zr.y,a[M+2]+=zr.z,a[c]+=hr.x,a[c+1]+=hr.y,a[c+2]+=hr.z,a[w]+=O.x,a[w+1]+=O.y,a[w+2]+=O.z}}}else{a=new Float32Array(U),d=new Float64Array(U),p=new Float32Array(U),m=new Float32Array(U),a=new Float32Array(U);var E=C/J,_r=U/3,pr=J+1;for(let f=0;f<_r;f++){let A=Math.floor(f/L),V=f%L,F=A%E,q=V%E,_=Math.floor(A/E)*pr+Math.floor(V/E);V===C&&(_-=1,q=E),A===C&&(_-=pr,F=E);let mr=_+1,fr=_+pr,br=fr+1,or=e[_],ir=e[mr],P=e[fr],G=e[br];H(D,or)&&(or=0),H(D,ir)&&(ir=0),H(D,P)&&(P=0),H(D,G)&&(G=0);let I=or*(1-(yr=q/E))*(1-(sr=F/E))+ir*yr*(1-sr)+P*(1-yr)*sr+G*yr*sr,l=3*f;x.x=z[l]+I*b[l],x.y=z[l+1]+I*b[l+1],x.z=z[l+2]+I*b[l+2],Y(x,i,t),h[l]=x.x,h[l+1]=x.y,h[l+2]=x.z,j[l]=i.x,j[l+1]=i.y,j[l+2]=i.z,k[l]=t.x,k[l+1]=t.y,k[l+2]=t.z,x.x<Q&&(Q=x.x),x.x>W&&(W=x.x),x.y<T&&(T=x.y),x.y>$&&($=x.y),x.z<Z&&(Z=x.z),x.z>X&&(X=x.z)}d.set(h),p.set(j),m.set(k);for(let f=0;f<_r;f++)if(~~(f/L)!==C&&f%L!==C){let A=3*f,V=A+3,F=A+3*L,q=F+3,_=new y(h[A],h[A+1],h[A+2]),mr=new y(h[V],h[V+1],h[V+2]),fr=new y(h[F],h[F+1],h[F+2]),br=new y(h[q],h[q+1],h[q+2]),or=mr.sub(_).normalize(),ir=fr.sub(_).normalize(),P=br.sub(_).normalize(),G=ir.cross(P).normalize(),I=P.cross(or).normalize(),l=I.add(G).normalize();a[A]+=l.x,a[A+1]+=l.y,a[A+2]+=l.z,a[V]+=I.x,a[V+1]+=I.y,a[V+2]+=I.z,a[F]+=G.x,a[F+1]+=G.y,a[F+2]+=G.z,a[q]+=l.x,a[q+1]+=l.y,a[q+2]+=l.z}}self.postMessage({id:Hr,normalMapNormals:a,normalMapVertices:d,normalMapVerticesHigh:p,normalMapVerticesLow:m,terrainVertices:h,terrainVerticesHigh:j,terrainVerticesLow:k,noDataVertices:lr,bounds:[Q,T,Z,W,$,X]},[a.buffer,d.buffer,p.buffer,m.buffer,h.buffer,j.buffer,k.buffer,lr.buffer])}})();
//# sourceMappingURL=TerrainWorker.worker-DmikdfB2.js.map
`,fn=typeof self<"u"&&self.Blob&&new Blob([Ro],{type:"text/javascript;charset=utf-8"});function Sc(l){let t;try{if(t=fn&&(self.URL||self.webkitURL).createObjectURL(fn),!t)throw"";const i=new Worker(t,{name:l?.name});return i.addEventListener("error",(()=>{(self.URL||self.webkitURL).revokeObjectURL(t)})),i}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(Ro),{name:l?.name})}finally{t&&(self.URL||self.webkitURL).revokeObjectURL(t)}}class Rc extends sr{constructor(t=2){super(t,Sc)}_onMessage(t){this._source.get(t.data.id).segment._terrainWorkerCallback(t.data),this._source.delete(t.data.id),t.data.normalMapNormals=null,t.data.normalMapVertices=null,t.data.normalMapVerticesHigh=null,t.data.normalMapVerticesLow=null,t.data.terrainVertices=null,t.data.terrainVerticesHigh=null,t.data.terrainVerticesLow=null}make(t){if(t.segment.plainReady&&t.segment.terrainIsLoading)if(this._workerQueue.length){const i=this._workerQueue.pop();this._source.set(this._sourceId,t);let s=t.segment;i.postMessage({elevations:t.elevations,this_plainVertices:s.plainVertices,this_plainNormals:s.plainNormals,this_normalMapVertices:s.normalMapVertices,this_normalMapNormals:s.normalMapNormals,heightFactor:s.planet._heightFactor,gridSize:s.planet.terrain.gridSizeByZoom[s.tileZoom],noDataValues:s.planet.terrain.noDataValues,id:this._sourceId},[t.elevations.buffer,s.plainVertices.buffer,s.plainNormals.buffer,s.normalMapVertices.buffer,s.normalMapNormals.buffer]),this._sourceId++}else this._pendingQueue.push(t);else this.check()}}let kt=new Float32Array(2);class Mc{constructor(t,i=256,s=256){this._width=i,this._height=s,this._planet=t,this._framebuffer=null,this._queue=[],this._handler=null}init(){this._handler=this._planet.renderer.handler,this._handler.programs.vectorTileLineRasterization||this._handler.addProgram(new X("vectorTileLineRasterization",{uniforms:{viewport:"vec2",thicknessOutline:"float",alpha:"float",extentParamsHigh:"vec4",extentParamsLow:"vec4"},attributes:{prevHigh:"vec2",currentHigh:"vec2",nextHigh:"vec2",prevLow:"vec2",currentLow:"vec2",nextLow:"vec2",order:"float",color:"vec4",thickness:"float"},vertexShader:`attribute vec2 prevHigh;
                attribute vec2 currentHigh;
                attribute vec2 nextHigh;

                attribute vec2 prevLow;
                attribute vec2 currentLow;
                attribute vec2 nextLow;

                attribute float order;
                attribute float thickness;
                attribute vec4 color;
                uniform float thicknessOutline;
                uniform vec2 viewport;
                uniform vec4 extentParamsHigh;
                uniform vec4 extentParamsLow;
                varying vec4 vColor;
                
                vec2 proj(vec2 coordHigh, vec2 coordLow) {
                    vec2 highDiff = coordHigh - extentParamsHigh.xy;
                    vec2 lowDiff = coordLow - extentParamsLow.xy;                    
                    return vec2(-1.0 + (highDiff * step(1.0, length(highDiff)) + lowDiff) * extentParamsHigh.zw) * vec2(1.0, -1.0);
                }
                
                void main(){
                    vColor = color;

                    vec2 vNext = proj(nextHigh, nextLow),
                         vCurrent = proj(currentHigh, currentLow),
                         vPrev = proj(prevHigh, prevLow);

                    vec2 _next = vNext;
                    vec2 _prev = vPrev;
                    vec2 _current = vCurrent;

                    if(_prev == _current){
                        if(_next == _current){
                            _next = _current + vec2(1.0, 0.0);
                            _prev = _current - _next;
                        }else{
                            _prev = _current + normalize(_current - _next);
                        }
                    }

                    if(_next == _current){
                        _next = _current + normalize(_current - _prev);
                    }

                    vec2 sNext = _next;
                    vec2 sCurrent = _current;
                    vec2 sPrev = _prev;
                    
                    vec2 dirNext = normalize(sNext - sCurrent);
                    vec2 dirPrev = normalize(sPrev - sCurrent);
                    float dotNP = dot(dirNext, dirPrev);
                    
                    vec2 normalNext = normalize(vec2(-dirNext.y, dirNext.x));
                    vec2 normalPrev = normalize(vec2(dirPrev.y, -dirPrev.x));
                    vec2 d = (thickness + thicknessOutline) * 0.5 * sign(order) / viewport;
                    
                    vec2 m;
                    if(dotNP >= 0.99991){
                        m = sCurrent - normalPrev * d;
                    }else{
                        vec2 dir = normalPrev + normalNext;
                        m = sCurrent + dir * d / (dirNext.x * dir.y - dirNext.y * dir.x);
                        
                        if( dotNP > 0.5 && dot(dirNext + dirPrev, m - sCurrent) < 0.0 ){
                            float occw = order * sign(dirNext.x * dirPrev.y - dirNext.y * dirPrev.x);
                            if(occw == -1.0){
                                m = sCurrent + normalPrev * d;
                            }else if(occw == 1.0){
                                m = sCurrent + normalNext * d;
                            }else if(occw == -2.0){
                                m = sCurrent + normalNext * d;
                            }else if(occw == 2.0){
                                m = sCurrent + normalPrev * d;
                            }
                        }else if(distance(sCurrent, m) > min(distance(sCurrent, sNext), distance(sCurrent, sPrev))){
                            m = sCurrent + normalNext * d;
                        }
                    }
                    gl_Position = vec4(m.x, m.y, 0.0, 1.0);
                }`,fragmentShader:`precision highp float;
                uniform float alpha;
                varying vec4 vColor;
                void main() {
                    gl_FragColor = vec4(vColor.rgb, alpha * vColor.a);
                }`})),this._handler.programs.vectorTilePolygonRasterization||this._handler.addProgram(new X("vectorTilePolygonRasterization",{uniforms:{extentParamsHigh:"vec4",extentParamsLow:"vec4"},attributes:{coordinatesHigh:"vec2",coordinatesLow:"vec2",colors:"vec4"},vertexShader:`attribute vec2 coordinatesHigh;
                attribute vec2 coordinatesLow; 
                attribute vec4 colors; 
                uniform vec4 extentParamsHigh; 
                uniform vec4 extentParamsLow; 
                varying vec4 color;

                vec2 proj(vec2 coordHigh, vec2 coordLow) {
                    vec2 highDiff = coordHigh - extentParamsHigh.xy;
                    vec2 lowDiff = coordLow - extentParamsLow.xy;
                    return vec2(-1.0 + (highDiff * step(1.0, length(highDiff)) + lowDiff) * extentParamsHigh.zw) * vec2(1.0, -1.0);
                }

                void main() { 
                    color = colors;
                    gl_Position = vec4(proj(coordinatesHigh, coordinatesLow), 0.0, 1.0); 
                }`,fragmentShader:`precision highp float;
                varying vec4 color;
                void main () {  
                    gl_FragColor = color; 
                }`})),this._framebuffer=new Pe(this._handler,{width:this._width,height:this._height,useDepth:!1}),this._framebuffer.init()}frame(){if(this._planet.layerLock.isFree()&&this._queue.length){let t=this._handler,i=t.gl;i.disable(i.CULL_FACE),i.disable(i.DEPTH_TEST);let s=t.programs.vectorTileLineRasterization,r=t.programs.vectorTilePolygonRasterization,n=this._width,a=this._height,o=n,h=a,c=o<<1,d=h<<1,u=new Float32Array(4),_=new Float32Array(4),p=this._framebuffer.activate(),f=0,m=window.performance.now();for(;this._queue.length&&f<25;){let g=this._queue.shift();if(g.isLoading&&g.segment.node.getState()===1){let y=g.layer._pickingEnabled;g.segment.tileZoom<4?(o=c,h=d):(o=n,h=a);let x=g._updateTexture||t.createEmptyTexture_l(o,h),b=y?g._updatePickingMask||t.createEmptyTexture_n(o,h):null;g.applyTexture(x,b),p.setSize(o,h),p.bindOutputTexture(x),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT);let T=g.segment.getExtentMerc();rt(T.southWest.lon,kt),u[0]=kt[0],_[0]=kt[1],rt(T.southWest.lat,kt),u[1]=kt[0],_[1]=kt[1],u[2]=2/T.getWidth(),u[3]=2/T.getHeight(),r.activate();let w=r._program,A=w.attributes,E=w.uniforms,C=g.layer._geometryHandler;i.uniform4fv(E.extentParamsHigh,u),i.uniform4fv(E.extentParamsLow,_),i.bindBuffer(i.ARRAY_BUFFER,C._polyVerticesHighBufferMerc),i.vertexAttribPointer(A.coordinatesHigh,C._polyVerticesHighBufferMerc.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,C._polyVerticesLowBufferMerc),i.vertexAttribPointer(A.coordinatesLow,C._polyVerticesLowBufferMerc.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,C._polyColorsBuffer),i.vertexAttribPointer(A.colors,C._polyColorsBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,C._polyIndexesBuffer),i.drawElements(i.TRIANGLES,C._polyIndexesBuffer.numItems,i.UNSIGNED_INT,0),y&&(p.bindOutputTexture(b),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),i.bindBuffer(i.ARRAY_BUFFER,C._polyPickingColorsBuffer),i.vertexAttribPointer(A.colors,C._polyPickingColorsBuffer.itemSize,i.FLOAT,!1,0,0),i.drawElements(i.TRIANGLES,C._polyIndexesBuffer.numItems,i.UNSIGNED_INT,0)),p.bindOutputTexture(x),s.activate(),w=s._program,A=w.attributes,E=w.uniforms,i.uniform2fv(E.viewport,[o,h]),i.uniform4fv(E.extentParamsHigh,u),i.uniform4fv(E.extentParamsLow,_);let M=C._lineVerticesHighBufferMerc;i.bindBuffer(i.ARRAY_BUFFER,M),i.vertexAttribPointer(A.prevHigh,M.itemSize,i.FLOAT,!1,8,0),i.vertexAttribPointer(A.currentHigh,M.itemSize,i.FLOAT,!1,8,32),i.vertexAttribPointer(A.nextHigh,M.itemSize,i.FLOAT,!1,8,64),M=C._lineVerticesLowBufferMerc,i.bindBuffer(i.ARRAY_BUFFER,M),i.vertexAttribPointer(A.prevLow,M.itemSize,i.FLOAT,!1,8,0),i.vertexAttribPointer(A.currentLow,M.itemSize,i.FLOAT,!1,8,32),i.vertexAttribPointer(A.nextLow,M.itemSize,i.FLOAT,!1,8,64),i.bindBuffer(i.ARRAY_BUFFER,C._lineOrdersBuffer),i.vertexAttribPointer(A.order,C._lineOrdersBuffer.itemSize,i.FLOAT,!1,4,0),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,C._lineIndexesBuffer),i.bindBuffer(i.ARRAY_BUFFER,C._lineStrokesBuffer),i.vertexAttribPointer(A.thickness,C._lineStrokesBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,C._lineStrokeColorsBuffer),i.vertexAttribPointer(A.color,C._lineStrokeColorsBuffer.itemSize,i.FLOAT,!1,0,0),i.uniform1f(E.thicknessOutline,2),i.uniform1f(E.alpha,.54),i.drawElements(i.TRIANGLE_STRIP,C._lineIndexesBuffer.numItems,i.UNSIGNED_INT,0),i.uniform1f(E.thicknessOutline,1),i.uniform1f(E.alpha,1),i.drawElements(i.TRIANGLE_STRIP,C._lineIndexesBuffer.numItems,i.UNSIGNED_INT,0),i.bindBuffer(i.ARRAY_BUFFER,C._lineThicknessBuffer),i.vertexAttribPointer(A.thickness,C._lineThicknessBuffer.itemSize,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,C._lineColorsBuffer),i.vertexAttribPointer(A.color,C._lineColorsBuffer.itemSize,i.FLOAT,!1,0,0),i.uniform1f(E.thicknessOutline,2),i.uniform1f(E.alpha,.54),i.drawElements(i.TRIANGLE_STRIP,C._lineIndexesBuffer.numItems,i.UNSIGNED_INT,0),i.uniform1f(E.thicknessOutline,1),i.uniform1f(E.alpha,1),i.drawElements(i.TRIANGLE_STRIP,C._lineIndexesBuffer.numItems,i.UNSIGNED_INT,0),y&&(p.bindOutputTexture(b),i.uniform1f(E.thicknessOutline,8),i.bindBuffer(i.ARRAY_BUFFER,C._linePickingColorsBuffer),i.vertexAttribPointer(A.color,C._linePickingColorsBuffer.itemSize,i.FLOAT,!1,0,0),i.drawElements(i.TRIANGLE_STRIP,C._lineIndexesBuffer.numItems,i.UNSIGNED_INT,0))}else g.isLoading=!1;f=window.performance.now()-m}i.enable(i.DEPTH_TEST),i.enable(i.CULL_FACE),p.deactivate()}}add(t){this._queue.push(t)}remove(t){}get queueSize(){return this._queue.length}}class yi extends lt{constructor(t={}){super(t.name),this._minDistanceBeforeMemClear=0,this._renderingFadingNodes=(o,h,c,d,u,_,p,f)=>{let m=_===0,g=this.terrain.equalizeVertices;for(let y=0,x=d._fadingNodes.length;y<x;y++){let b=d._fadingNodes[y].segment;o._fadingNodes.has(d._fadingNodes[0].__id)&&!h.has(b.node.__id)&&(h.set(b.node.__id,!0),b._transitionOpacity<1?p.push(b):m?(g&&b.equalize(),b.readyToEngage&&b.engage(),b.screenRendering(c,u,_),f.push(b)):b.screenRendering(c,u,_,this.transparentTexture,!0))}},this._renderingFadingNodesNoDepth=(o,h,c,d,u,_,p)=>{let f=_===0,m=this.terrain.equalizeVertices,g=c.gl;g.disable(g.DEPTH_TEST);for(let y=0,x=d._fadingNodes.length;y<x;y++){let b=d._fadingNodes[y].segment;o._fadingNodes.has(d._fadingNodes[0].__id)&&!h.has(b.node.__id)&&(h.set(b.node.__id,!0),f?(m&&b.equalize(),b.readyToEngage&&b.engage(),b.screenRendering(c,u,_),p.push(b)):b.screenRendering(c,u,_,this.transparentTexture,!0))}g.enable(g.DEPTH_TEST)},this._createdNodesCount=0,this.transitionTime=580,this.ellipsoid=t.ellipsoid||Sn,this._atmosphere=new uc(t.atmosphereParameters),this.lightEnabled=!0,this._planetRadius2=(this.ellipsoid.getPolarSize()-1e4)*(this.ellipsoid.getPolarSize()-1e4),this._layers=[],this._updateLayers=!1,this.visibleTileLayers=[],this.visibleVectorLayers=[],this._visibleVectorLayersByDepthOrder=[],this._visibleTileLayerSlices=[],this._visibleEntityCollections=[[]],this.baseLayer=null,this.terrain=null,this.camera=new go(this,{frustums:t.frustums,eye:new v(25e6,0,0),look:v.ZERO,up:v.NORTH,minAltitude:t.minAltitude,maxAltitude:t.maxAltitude}),this.mousePositionOnEarth=new v,this.emptyTexture=null,this.transparentTexture=null,this.defaultTexture=null,this._initialViewExtent=null,this.layerLock=new Os,this.terrainLock=new Os,this._heightFactor=1,this._indexesCache=[],this._indexesCacheToRemove=[],this._indexesCacheToRemoveCounter=0,this._textureCoordsBufferCache=[];const i={planet:this,maxEqualZoomAltitude:t.maxEqualZoomAltitude,minEqualZoomAltitude:t.minEqualZoomAltitude,minEqualZoomCameraSlope:t.minEqualZoomCameraSlope,transitionOpacityEnabled:t.transitionOpacityEnabled};this.quadTreeStrategyPrototype=t.quadTreeStrategyPrototype||wc,this.quadTreeStrategy=new this.quadTreeStrategyPrototype(i),this._nightTexture=null,this._specularTexture=null;let s=Oe(t.ambient,new v(.2,.2,.3)),r=Oe(t.diffuse,new v(1,1,1)),n=Oe(t.specular,new v(63e-5,55e-5,32e-5)),a=t.shininess||18;this._ambient=new Float32Array([s.x,s.y,s.z]),this._diffuse=new Float32Array([r.x,r.y,r.z]),this._specular=new Float32Array([n.x,n.y,n.z,a]),this._maxGridSize=Math.log2(t.maxGridSize||256),this.SLICE_SIZE=4,this.SLICE_SIZE_4=4*this.SLICE_SIZE,this.SLICE_SIZE_3=3*this.SLICE_SIZE,this._maxNodes=t.maxNodesCount||200,this._pickingColorArr=new Float32Array(this.SLICE_SIZE_4),this._samplerArr=new Int32Array(this.SLICE_SIZE),this._pickingMaskArr=new Int32Array(this.SLICE_SIZE),this._geoImageCreator=new Tc(this),this._vectorTileCreator=new Mc(this,t.vectorTileSize,t.vectorTileSize),this._normalMapCreator=new Ac(this),this._terrainWorker=new Rc(3),this._plainSegmentWorker=new Pc(3),this._tileLoader=new Po(t.maxLoadingRequests||12),this._memKey=new bi,this.events=le(Bc),this._distBeforeMemClear=0,this._prevCamEye=new v,this._initialized=!1,this._collectRenderNodesIsActive=!0,this.nightTextureCoefficient=2,this._renderScreenNodesPASS=this._renderScreenNodesPASSNoAtmos,this._renderScreenNodesWithHeightPASS=this._renderScreenNodesWithHeightPASSNoAtmos,this._atmosphereEnabled=t.atmosphereEnabled||!1,this._atmosphereMaxMinOpacity=new Float32Array([.95,.28]),this.solidTextureOne=null,this.solidTextureTwo=null,this._nightTextureSrc=t.nightTextureSrc||null,this._specularTextureSrc=t.specularTextureSrc||null,this._transparentBackground=t.transparentBackground||!1}get terrainReady(){return this.quadTreeStrategy.terrainReady}get maxGridSize(){return this._maxGridSize}getNorthFrameRotation(t){return this.getFrameRotation(t)}getFrameRotation(t){return this.ellipsoid.getNorthFrameRotation(t)}set atmosphereMaxOpacity(t){this._atmosphereMaxMinOpacity[0]=t}get atmosphereMaxOpacity(){return this._atmosphereMaxMinOpacity[0]}set atmosphereMinOpacity(t){this._atmosphereMaxMinOpacity[1]=t}get atmosphereMinOpacity(){return this._atmosphereMaxMinOpacity[1]}set atmosphereEnabled(t){t!=this._atmosphereEnabled&&(this._atmosphereEnabled=t,this._initializeAtmosphere())}get atmosphereEnabled(){return this._atmosphereEnabled}set diffuse(t){let i=Oe(t);this._diffuse=new Float32Array(i.toArray())}set ambient(t){let i=Oe(t);this._ambient=new Float32Array(i.toArray())}set specular(t){let i=Oe(t);this._specular=new Float32Array([i.x,i.y,i.y,this._specular[3]])}set shininess(t){this._specular[3]=t}get normalMapCreator(){return this._normalMapCreator}get layers(){return[...this._layers]}get sun(){if(this.renderer&&this.renderer.controls.sun)return this.renderer.controls.sun}get sunPos(){return this.sun.sunlight.getPosition()}addControl(t){t.planet=this,t.addTo(this.renderer)}addControls(t){for(let i=0;i<t.length;i++)this.addControl(t[i])}getLayerByName(t){for(let i=0,s=this._layers.length;i<s;i++)if(t===this._layers[i].name)return this._layers[i]}addLayer(t){t.addTo(this)}_onLayerVisibilityChanged(t){this.events.dispatch(this.events.layervisibilitychange,t)}addLayers(t){for(let i=0,s=t.length;i<s;i++)this.addLayer(t[i])}removeLayer(t){t.remove()}_clearLayerMaterial(t){this.quadTreeStrategy.clearLayerMaterial(t)}setBaseLayer(t){this.baseLayer?this.baseLayer.isEqual(t)||(this.baseLayer.setVisibility(!1),this.baseLayer=t,t.setVisibility(!0),this.events.dispatch(this.events.baselayerchange,t)):(this.baseLayer=t,this.baseLayer.setVisibility(!0),this.events.dispatch(this.events.baselayerchange,t))}setHeightFactor(t){this._heightFactor!==t&&(this._heightFactor=t,this.quadTreeStrategy.destroyBranches(),this.quadTreeStrategy.clearRenderedNodes())}getHeightFactor(){return this._heightFactor}setTerrain(t){this._initialized&&this.memClear(),this.terrain&&(this.terrain.abortLoading(),this.terrain.clearCache(),this.terrain._planet=null),this.terrain=t,this.terrain._planet=this,this.quadTreeStrategy.destroyBranches(),t._geoid.model?(this._plainSegmentWorker.setGeoid(t.getGeoid()),t._isReady=!0):Lo.loadModel(t.geoid.src).then((i=>{t.geoid.setModel(i),this._plainSegmentWorker.setGeoid(t.getGeoid()),t._isReady=!0})).catch((i=>{console.warn(i)}))}initAtmosphereShader(t){if(this.renderer&&this.renderer.handler&&this._atmosphereEnabled){let i=this.renderer.handler;i.isWebGl2()?(i.removeProgram("drawnode_screen_wl"),i.addProgram(cn(t))):console.warn("Atmosphere WebGL2 only")}}get atmosphereControl(){return this._atmosphere}_initializeAtmosphere(){if(!this.renderer)return;let t=this.renderer.handler;t.removeProgram("drawnode_screen_wl"),this._atmosphereEnabled?(this._renderScreenNodesPASS=this._renderScreenNodesPASSAtmos,this._renderScreenNodesWithHeightPASS=this._renderScreenNodesWithHeightPASSAtmos,this.renderer.controls.Atmosphere||this.addControl(this._atmosphere),this._atmosphere.activate(),t.isWebGl2()?t.addProgram(cn(this._atmosphere.parameters)):t.addProgram(hn()),this._transparentBackground||this.renderer.controls.SimpleSkyBackground&&this.renderer.controls.SimpleSkyBackground.deactivate()):(this._renderScreenNodesPASS=this._renderScreenNodesPASSNoAtmos,this._renderScreenNodesWithHeightPASS=this._renderScreenNodesWithHeightPASSNoAtmos,this._atmosphere.deactivate(),this._transparentBackground||(this.renderer.controls.SimpleSkyBackground?this.renderer.controls.SimpleSkyBackground.activate():this.addControl(new no)),t.isWebGl2()?t.addProgram(new X("drawnode_screen_wl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",height:"float",uGlobalTextureCoord:"vec4",uNormalMapBias:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",uNormalMap:"sampler2d",nightTexture:"sampler2d",specularTexture:"sampler2d",lightPosition:"vec3",diffuse:"vec3",ambient:"vec3",specular:"vec4",camHeight:"float",nightTextureCoefficient:"float",transitionOpacity:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:`#version 300 es
precision highp float;in vec3 aVertexPositionHigh;in vec3 aVertexPositionLow;in vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec4 uGlobalTextureCoord;uniform vec3 uNormalMapBias;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;out vec4 vTextureCoord;out vec3 v_vertex;out vec3 cameraPosition;out vec2 vGlobalTextureCoord;out float v_height;void main(void){vec3 aVertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 nh=height*normalize(aVertexPosition);vTextureCoord.xy=aTextureCoord;vGlobalTextureCoord=uGlobalTextureCoord.xy+(uGlobalTextureCoord.zw-uGlobalTextureCoord.xy)*aTextureCoord;vTextureCoord.zw=uNormalMapBias.z*(aTextureCoord+uNormalMapBias.xy);cameraPosition=eyePositionHigh+eyePositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);v_height=height;v_vertex=aVertexPosition+nh;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}`,fragmentShader:`#version 300 es
precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 specular;uniform vec3 diffuse;uniform vec3 ambient;uniform sampler2D uNormalMap;uniform sampler2D nightTexture;uniform sampler2D specularTexture;uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform vec4 tileOffsetArr[SLICE_SIZE];uniform vec3 lightPosition;uniform float layerOpacityArr[SLICE_SIZE];uniform int samplerCount;uniform float nightTextureCoefficient;uniform float transitionOpacity;uniform float camHeight;in vec4 vTextureCoord;in vec3 v_vertex;in vec3 cameraPosition;in vec2 vGlobalTextureCoord;in float v_height;vec3 sunPos;layout(location=0)out vec4 diffuseColor;void main(void){sunPos=lightPosition;vec3 texNormal=texture(uNormalMap,vTextureCoord.zw).rgb;vec3 normal=normalize((texNormal-0.5)*2.0);float minH=1200000.0;float maxH=minH*3.0;float nightCoef=getLerpValue(minH,maxH,camHeight)*nightTextureCoefficient;vec3 lightDir=normalize(sunPos);vec3 viewDir=normalize(cameraPosition-v_vertex);float overGround=1.0-step(0.1,v_height);float shininess=texture(specularTexture,vGlobalTextureCoord.st).r*255.0*overGround;vec3 reflectionDirection=reflect(-lightDir,normal);float reflection=max(dot(reflectionDirection,viewDir),0.0);vec3 spec=specular.rgb*pow(reflection,specular.w)*shininess;float diffuseLightWeighting=max(dot(normal,lightDir),0.0);vec4 nightImageColor=texture(nightTexture,vGlobalTextureCoord.st);vec3 night=nightStep*(.18-diffuseLightWeighting*3.0)*nightImageColor.rgb*nightCoef;night*=overGround*step(0.0,night);vec4 lightWeighting=vec4(ambient+diffuse*diffuseLightWeighting+night,1.0);diffuseColor=texture(defaultTexture,vTextureCoord.xy);if(samplerCount==0){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}vec4 src;blend(diffuseColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;}`})):t.addProgram(hn()))}_initializeShaders(){if(!this.renderer)throw new Error("Renderer is not initialized");let t=this.renderer,i=t.handler;i.addProgram(new X("drawnode_screen_nl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",height:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:"precision highp float;attribute vec3 aVertexPositionHigh;attribute vec3 aVertexPositionLow;attribute vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;varying vec2 vTextureCoord;void main(void){vTextureCoord=aTextureCoord;vec3 nh=height*normalize(aVertexPositionHigh+aVertexPositionLow);mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);mat4 m=projectionMatrix*viewMatrixRTE;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;gl_Position=m*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}",fragmentShader:`precision highp float;
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 tileOffsetArr[SLICE_SIZE];uniform float layerOpacityArr[SLICE_SIZE];uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform int samplerCount;varying vec2 vTextureCoord;void main(void){gl_FragColor=texture2D(defaultTexture,vTextureCoord);if(samplerCount==0)return;vec4 src;blend(gl_FragColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1)return;blend(gl_FragColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2)return;blend(gl_FragColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3)return;blend(gl_FragColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4)return;blend(gl_FragColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);}`})),i.addProgram(new X("drawnode_colorPicking",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",samplerCount:"int",tileOffsetArr:"vec4",samplerArr:"sampler2darray",pickingMaskArr:"sampler2darray",pickingColorArr:"vec4",height:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:"precision highp float;attribute vec3 aVertexPositionHigh;attribute vec3 aVertexPositionLow;attribute vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;varying vec2 vTextureCoord;void main(void){vTextureCoord=aTextureCoord;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);mat4 m=projectionMatrix*viewMatrixRTE;vec3 nh=height*normalize(aVertexPositionHigh+aVertexPositionLow);vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;gl_Position=m*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}",fragmentShader:`precision highp float;
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 tileOffsetArr[SLICE_SIZE];uniform vec4 pickingColorArr[SLICE_SIZE];uniform sampler2D samplerArr[SLICE_SIZE];uniform sampler2D pickingMaskArr[SLICE_SIZE];uniform int samplerCount;varying vec2 vTextureCoord;void main(void){gl_FragColor=vec4(0.0);if(samplerCount==0)return;vec2 tc;vec4 t;vec4 p;blendPicking(gl_FragColor,tileOffsetArr[0],samplerArr[0],pickingMaskArr[0],pickingColorArr[0],1.0);if(samplerCount==1)return;blendPicking(gl_FragColor,tileOffsetArr[1],samplerArr[1],pickingMaskArr[1],pickingColorArr[1],1.0);if(samplerCount==2)return;blendPicking(gl_FragColor,tileOffsetArr[2],samplerArr[2],pickingMaskArr[2],pickingColorArr[2],1.0);if(samplerCount==3)return;blendPicking(gl_FragColor,tileOffsetArr[3],samplerArr[3],pickingMaskArr[3],pickingColorArr[3],1.0);if(samplerCount==4)return;blendPicking(gl_FragColor,tileOffsetArr[4],samplerArr[4],pickingMaskArr[4],pickingColorArr[4],1.0);}`})),i.addProgram(new X("drawnode_depth",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",height:"float",eyePositionHigh:"vec3",eyePositionLow:"vec3",frustumPickingColor:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3"},vertexShader:`#version 300 es
precision highp float;in vec3 aVertexPositionHigh;in vec3 aVertexPositionLow;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;void main(void){mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);mat4 m=projectionMatrix*viewMatrixRTE;vec3 nh=height*normalize(aVertexPositionHigh+aVertexPositionLow);vec3 eyePosition=eyePositionHigh+eyePositionLow;vec3 vertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;gl_Position=m*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}`,fragmentShader:`#version 300 es
precision highp float;uniform float frustumPickingColor;layout(location=0)out vec4 frustumColor;layout(location=1)out vec4 depthColor;void main(void){frustumColor=vec4(frustumPickingColor,frustumPickingColor,frustumPickingColor,1.0);depthColor=vec4(gl_FragCoord.z,gl_FragCoord.z,gl_FragCoord.z,1.0);}`})),t.addPickingCallback(this,this._renderColorPickingFramebufferPASS),t.addDepthCallback(this,(()=>{this.renderDepthFramebuffer(this.camera,this.quadTreeStrategy)}))}_onLayerLoadend(t){this.events.dispatch(this.events.layerloadend,t)}init(){this._tileLoader.events.on("layerloadend",this._onLayerLoadend,this),Di().setMaxGridSize(this._maxGridSize);const t=this._maxGridSize;let i=0;for(let r=0;r<=t;r++){!this._indexesCache[r]&&(this._indexesCache[r]=new Array(t));for(let n=0;n<=t;n++){!this._indexesCache[r][n]&&(this._indexesCache[r][n]=new Array(t));for(let a=0;a<=t;a++){!this._indexesCache[r][n][a]&&(this._indexesCache[r][n][a]=new Array(t));for(let o=0;o<=t;o++){!this._indexesCache[r][n][a][o]&&(this._indexesCache[r][n][a][o]=new Array(t));for(let h=0;h<=t;h++){let c={buffer:null};if(r>=1&&r===n&&r===a&&r===o&&r===h){let d=Di().createSegmentIndexes(r,[n,a,o,h]);c.buffer=this.renderer.handler.createElementArrayBuffer(d,1)}else this._indexesCacheToRemove[i++]=c;this._indexesCache[r][n][a][o][h]=c}}}}}this.renderer.events.on("drawtransparent",(()=>{this._renderScreenNodesWithHeightPASS()})),this._textureCoordsBufferCache=[];let s=Di().initTextureCoordsTable(t+1);for(let r=0;r<=t;r++)this._textureCoordsBufferCache[r]=this.renderer.handler.createArrayBuffer(s[r],2,(1+(1<<r))*(1+(1<<r)));if(this.renderer.handler.createDefaultTexture(null,(r=>{this.solidTextureOne=r,this.solidTextureTwo=r})),this.transparentTexture=this.renderer.handler.transparentTexture,this.drawMode=this.renderer.handler.gl.TRIANGLE_STRIP,this._initializeShaders(),this._initializeAtmosphere(),this._updateVisibleLayers(),this._nightTextureSrc){let r=new Image;r.crossOrigin="Anonymous",r.onload=()=>{this._nightTexture=this.renderer.handler.createTextureDefault(r),this._nightTexture.default=!0},r.src=this._nightTextureSrc}if(this._specularTextureSrc){let r=new Image;r.crossOrigin="Anonymous",r.onload=()=>{this._specularTexture=this.renderer.handler.createTextureDefault(r),this._specularTexture.default=!0},r.src=this._specularTextureSrc}this._geoImageCreator.init(),this._vectorTileCreator.init(),this._normalMapCreator.init(),this.renderer.events.on("draw",this._globalPreDraw,this,-100),this.quadTreeStrategy.init(this.camera),this.initLayers(),this._initialized=!0,this._initialViewExtent&&this.viewExtent(this._initialViewExtent),this.renderer.activeCamera=this.camera,this.camera.bindFrustumsPickingColors(this.renderer),this.camera.update()}initLayers(){let t=[...this._layers];for(let i=0;i<t.length;i++)this.removeLayer(t[i]),this.addLayer(t[i])}_clearIndexesCache(){this._indexesCacheToRemoveCounter=0;let t=this._indexesCacheToRemove,i=this.renderer.handler.gl;for(let s=0,r=t.length;s<r;s++){let n=t[s];i.deleteBuffer(n.buffer),n.buffer=null}}createDefaultTextures(t,i){this.renderer.handler.gl.deleteTexture(this.solidTextureOne),this.renderer.handler.gl.deleteTexture(this.solidTextureTwo),this.renderer.handler.createDefaultTexture(t,(s=>{this.solidTextureOne=s})),this.renderer.handler.createDefaultTexture(i,(s=>{this.solidTextureTwo=s}))}_getLayerAttributionHTML(t){return`<div class="og-attribution__layer">${t.getAttribution()}</div>`}updateAttributionsList(){let t="";for(let i=0,s=this._layers.length;i<s;i++){let r=this._layers[i];r.getVisibility()&&r.getAttribution().length&&(t+=this._getLayerAttributionHTML(r))}this._applyAttribution(t)}updateVisibleLayers(){this._updateLayers=!0}_updateVisibleLayers(){this.visibleTileLayers=[],this.visibleTileLayers.length=0,this.visibleVectorLayers=[],this.visibleVectorLayers.length=0;let t="";for(let i=0,s=this._layers.length;i<s;i++){let r=this._layers[i];r.getVisibility()?(r.isBaseLayer()&&(this.createDefaultTextures(r._defaultTextures[0],r._defaultTextures[1]),this.baseLayer=r),r.hasImageryTiles()&&this.visibleTileLayers.push(r),r.isVector&&this.visibleVectorLayers.push(r),r.getAttribution().length&&(t+=this._getLayerAttributionHTML(r))):r._fading&&r._fadingOpacity>0&&(r.hasImageryTiles()&&this.visibleTileLayers.push(r),r.isVector&&this.visibleVectorLayers.push(r))}this._applyAttribution(t),this._sortLayers()}_applyAttribution(t){this.renderer&&this.renderer.div&&(t.length?this.renderer.div.attributions.innerHTML!==t&&(this.renderer.div.attributions.innerHTML=t):this.renderer.div.attributions.innerHTML="")}_sortLayers(){this.visibleVectorLayers.sort(((i,s)=>i.getZIndex()-s.getZIndex()||i.getHeight()-s.getHeight()));let t={0:[]};for(const i of this.visibleVectorLayers)t[i.depthOrder]||(t[i.depthOrder]=[]),t[i.depthOrder].push(i);if(this._visibleVectorLayersByDepthOrder.length=0,this._visibleVectorLayersByDepthOrder=[],this._visibleVectorLayersByDepthOrder=Object.keys(t).sort(((i,s)=>Number(i)-Number(s))).map((i=>t[Number(i)])),this._visibleTileLayerSlices=[],this._visibleTileLayerSlices.length=0,this.visibleTileLayers.length){this.visibleTileLayers.sort(((r,n)=>r.getHeight()-n.getHeight()||r.getZIndex()-n.getZIndex()));let i=-1,s=this.visibleTileLayers[0].getHeight();for(let r=0,n=this.visibleTileLayers.length;r<n;r++)r%this.SLICE_SIZE!=0&&this.visibleTileLayers[r].getHeight()===s||(i++,this._visibleTileLayerSlices[i]=[],s=this.visibleTileLayers[r].getHeight()),this._visibleTileLayerSlices[i].push(this.visibleTileLayers[r])}}_renderScreenNodesPASSNoAtmos(){let t=this.camera,i=this._setUniformsNoAtmos(t);this._renderingScreenNodes(this.quadTreeStrategy,i,t,this.quadTreeStrategy._renderedNodesInFrustum[t.currentFrustumIndex])}_renderScreenNodesPASSAtmos(){let t=this.camera,i=this._setUniformsAtmos(t);this._renderingScreenNodes(this.quadTreeStrategy,i,t,this.quadTreeStrategy._renderedNodesInFrustum[t.currentFrustumIndex])}_renderScreenNodesWithHeightPASSNoAtmos(){let t=this.camera,i=this._setUniformsNoAtmos(t);this._renderingScreenNodesWithHeight(this.quadTreeStrategy,i,t,this.quadTreeStrategy._renderedNodesInFrustum[t.currentFrustumIndex])}_renderScreenNodesWithHeightPASSAtmos(){let t=this.camera,i=this._setUniformsAtmos(t);this._renderingScreenNodesWithHeight(this.quadTreeStrategy,i,t,this.quadTreeStrategy._renderedNodesInFrustum[t.currentFrustumIndex])}_globalPreDraw(){let t=this.camera;this._distBeforeMemClear+=this._prevCamEye.distance(t.eye),this._prevCamEye.copy(t.eye),this._createdNodesCount>this._maxNodes&&this._distBeforeMemClear>this._minDistanceBeforeMemClear&&(this.terrain.clearCache(),this.memClear()),this._indexesCacheToRemoveCounter>600&&this._clearIndexesCache()}preFrame(){this._updateLayers&&(this._updateLayers=!1,this._updateVisibleLayers()),this.camera.isFirstPass&&(this.camera.update(),this._collectRenderNodesIsActive&&this.quadTreeStrategy.collectRenderNodes(this.camera),this._normalMapCreator.frame(),this._geoImageCreator.frame(),this._vectorTileCreator.frame(),this.camera.checkTerrainCollision(),this.camera.update(),this.events.dispatch(this.events.draw,this),this._collectVectorLayerCollections());for(let t=0;t<this._visibleEntityCollections.length;t++)this.drawEntityCollections(this._visibleEntityCollections[t],t)}frame(){this._renderScreenNodesPASS()}lockQuadTree(){this._collectRenderNodesIsActive=!1,this.camera.setTerrainCollisionActivity(!1)}unlockQuadTree(){this._collectRenderNodesIsActive=!0,this.camera.setTerrainCollisionActivity(!0)}_setUniformsNoAtmos(t){let i,s,r=this.renderer,n=r.handler,a=n.gl;return a.enable(a.CULL_FACE),r.enableBlendOneSrcAlpha(),this.lightEnabled?(n.programs.drawnode_screen_wl.activate(),i=n.programs.drawnode_screen_wl._program,s=i.uniforms,a.uniform3fv(s.lightPosition,this._lightPosition),a.uniformMatrix4fv(s.viewMatrix,!1,t.getViewMatrix()),a.uniformMatrix4fv(s.projectionMatrix,!1,t.getProjectionMatrix()),this.baseLayer?(a.uniform3fv(s.diffuse,this.baseLayer._diffuse||this._diffuse),a.uniform3fv(s.ambient,this.baseLayer._ambient||this._ambient),a.uniform4fv(s.specular,this.baseLayer._specular||this._specular),a.uniform1f(s.nightTextureCoefficient,this.baseLayer.nightTextureCoefficient||this.nightTextureCoefficient)):(a.uniform3fv(s.diffuse,this._diffuse),a.uniform3fv(s.ambient,this._ambient),a.uniform4fv(s.specular,this._specular),a.uniform1f(s.nightTextureCoefficient,this.nightTextureCoefficient)),a.activeTexture(a.TEXTURE0+this.SLICE_SIZE),a.bindTexture(a.TEXTURE_2D,this._nightTexture||this.transparentTexture),a.uniform1i(s.nightTexture,this.SLICE_SIZE),a.activeTexture(a.TEXTURE0+this.SLICE_SIZE+1),a.bindTexture(a.TEXTURE_2D,this._specularTexture||this.transparentTexture),a.uniform1i(s.specularTexture,this.SLICE_SIZE+1),a.uniform1f(s.camHeight,t.getHeight())):(n.programs.drawnode_screen_nl.activate(),i=n.programs.drawnode_screen_nl._program,s=i.uniforms,a.uniformMatrix4fv(s.viewMatrix,!1,t.getViewMatrix()),a.uniformMatrix4fv(s.projectionMatrix,!1,t.getProjectionMatrix())),a.uniform3fv(s.eyePositionHigh,t.eyeHigh),a.uniform3fv(s.eyePositionLow,t.eyeLow),i}_setUniformsAtmos(t){let i,s,r=this.renderer,n=r.handler,a=n.gl;return a.enable(a.CULL_FACE),r.enableBlendOneSrcAlpha(),this.lightEnabled?(n.programs.drawnode_screen_wl.activate(),i=n.programs.drawnode_screen_wl._program,s=i.uniforms,a.uniform3fv(s.lightPosition,this._lightPosition),a.uniformMatrix4fv(s.viewMatrix,!1,t.getViewMatrix()),a.uniformMatrix4fv(s.projectionMatrix,!1,t.getProjectionMatrix()),this.baseLayer?(a.uniform3fv(s.diffuse,this.baseLayer._diffuse||this._diffuse),a.uniform3fv(s.ambient,this.baseLayer._ambient||this._ambient),a.uniform4fv(s.specular,this.baseLayer._specular||this._specular),a.uniform1f(s.nightTextureCoefficient,this.baseLayer.nightTextureCoefficient||this.nightTextureCoefficient)):(a.uniform3fv(s.diffuse,this._diffuse),a.uniform3fv(s.ambient,this._ambient),a.uniform4fv(s.specular,this._specular),a.uniform1f(s.nightTextureCoefficient,this.nightTextureCoefficient)),a.uniform2fv(s.maxMinOpacity,this._atmosphereMaxMinOpacity),a.activeTexture(a.TEXTURE0+this.SLICE_SIZE),a.bindTexture(a.TEXTURE_2D,this._nightTexture||this.transparentTexture),a.uniform1i(s.nightTexture,this.SLICE_SIZE),a.activeTexture(a.TEXTURE0+this.SLICE_SIZE+1),a.bindTexture(a.TEXTURE_2D,this._specularTexture||this.transparentTexture),a.uniform1i(s.specularTexture,this.SLICE_SIZE+1),a.activeTexture(a.TEXTURE0+this.SLICE_SIZE+4),a.bindTexture(a.TEXTURE_2D,r.controls.Atmosphere._transmittanceBuffer.textures[0]),a.uniform1i(s.transmittanceTexture,this.SLICE_SIZE+4),a.activeTexture(a.TEXTURE0+this.SLICE_SIZE+5),a.bindTexture(a.TEXTURE_2D,r.controls.Atmosphere._scatteringBuffer.textures[0]),a.uniform1i(s.scatteringTexture,this.SLICE_SIZE+5),a.uniform1f(s.camHeight,t.getHeight())):(n.programs.drawnode_screen_nl.activate(),i=n.programs.drawnode_screen_nl._program,s=i.uniforms,a.uniformMatrix4fv(s.viewMatrix,!1,t.getViewMatrix()),a.uniformMatrix4fv(s.projectionMatrix,!1,t.getProjectionMatrix())),a.uniform3fv(s.eyePositionHigh,t.eyeHigh),a.uniform3fv(s.eyePositionLow,t.eyeLow),i}static __refreshLayersFadingOpacity__(t,i,s){for(let r=t.length-1;r>=0;--r){let n=t[r];n._fading&&n._refreshFadingOpacity(i,s)&&t.splice(r,1)}}_renderingScreenNodes(t,i,s,r){let n=this._visibleTileLayerSlices;n.length&&s.isFirstPass&&yi.__refreshLayersFadingOpacity__(n[0],t.minCurrZoom,t.maxCurrZoom);let a=new Map,o=[],h=this.terrain.equalizeVertices,c=r.length;if(t._fadingOpaqueSegments=[],s.slope>.8||!this.terrain||this.terrain.isEmpty)for(;c--;){let d=r[c],u=d.segment;this._renderingFadingNodesNoDepth(t,a,i,d,n[0],0,t._fadingOpaqueSegments),h&&u.equalize(),u.readyToEngage&&u.engage(),u.screenRendering(i,n[0],0)}else{for(;c--;){let d=r[c],u=d.segment;this._renderingFadingNodes(t,a,i,d,n[0],0,o,t._fadingOpaqueSegments),u._transitionOpacity<1?o.push(u):(h&&u.equalize(),u.readyToEngage&&u.engage(),u.screenRendering(i,n[0],0))}for(let d=0;d<o.length;d++){let u=o[d];h&&u.equalize(),u.readyToEngage&&u.engage(),u.screenRendering(i,n[0],0)}}}_renderingScreenNodesWithHeight(t,i,s,r){let n=this.renderer.handler.gl;n.enable(n.POLYGON_OFFSET_FILL),n.disable(n.CULL_FACE);let a=new Map,o=[],h=this._visibleTileLayerSlices;for(let c=1,d=h.length;c<d;c++){s.isFirstPass&&yi.__refreshLayersFadingOpacity__(h[c],t.minCurrZoom,t.maxCurrZoom),n.polygonOffset(0,-c);let u=r.length;for(;u--;){let _=r[u];this._renderingFadingNodes(t,a,i,_,h[c],c,o),_.segment._transitionOpacity<1?_.segment.initSlice(c):_.segment.screenRendering(i,h[c],c,this.transparentTexture,!0)}}n.disable(n.POLYGON_OFFSET_FILL),n.enable(n.CULL_FACE)}_renderColorPickingFramebufferPASS(){let t,i=this.renderer,s=i.handler,r=s.gl;s.programs.drawnode_colorPicking.activate(),t=s.programs.drawnode_colorPicking._program;let n=t.uniforms,a=i.activeCamera;r.enable(r.CULL_FACE),r.uniformMatrix4fv(n.viewMatrix,!1,a.getViewMatrix()),r.uniformMatrix4fv(n.projectionMatrix,!1,a.getProjectionMatrix()),r.uniform3fv(n.eyePositionHigh,a.eyeHigh),r.uniform3fv(n.eyePositionLow,a.eyeLow);let o=this.quadTreeStrategy._renderedNodesInFrustum[a.getCurrentFrustum()],h=this._visibleTileLayerSlices,c=o.length;for(;c--;)o[c].segment._transitionOpacity>=1&&o[c].segment.colorPickingRendering(t,h[0],0);for(let d=0;d<this.quadTreeStrategy._fadingOpaqueSegments.length;++d)this.quadTreeStrategy._fadingOpaqueSegments[d].colorPickingRendering(t,h[0],0);r.enable(r.POLYGON_OFFSET_FILL);for(let d=1,u=h.length;d<u;d++)for(c=o.length,r.polygonOffset(0,-d);c--;)o[c].segment.colorPickingRendering(t,h[d],d,this.transparentTexture,!0);r.disable(r.POLYGON_OFFSET_FILL)}renderDepthFramebuffer(t,i){let s,r=this.renderer.handler,n=r.gl;r.programs.drawnode_depth.activate(),s=r.programs.drawnode_depth._program;let a=s.uniforms;n.disable(n.BLEND),n.disable(n.POLYGON_OFFSET_FILL),n.uniformMatrix4fv(a.viewMatrix,!1,t.getViewMatrix()),n.uniformMatrix4fv(a.projectionMatrix,!1,t.getProjectionMatrix()),n.uniform3fv(a.eyePositionHigh,t.eyeHigh),n.uniform3fv(a.eyePositionLow,t.eyeLow),n.uniform1f(a.frustumPickingColor,t.frustumColorIndex);let o=i._renderedNodesInFrustum[t.getCurrentFrustum()],h=this._visibleTileLayerSlices,c=o.length;for(;c--;)o[c].segment._transitionOpacity>=1&&o[c].segment.depthRendering(s,h[0]);for(let d=0;d<i._fadingOpaqueSegments.length;++d)i._fadingOpaqueSegments[d].depthRendering(s,h[0]);n.enable(n.BLEND)}_collectVectorLayerCollections(){let t=this._visibleVectorLayersByDepthOrder.length;this._visibleEntityCollections.length=0,this._visibleEntityCollections=new Array(t);for(let i=0;i<this._visibleEntityCollections.length;i++)this._visibleEntityCollections[i]=[];for(;t--;){let i=this._visibleVectorLayersByDepthOrder[t],s=i.length;for(;s--;){let r=i[s];r._fading&&r._refreshFadingOpacity(this.quadTreeStrategy.minCurrZoom,this.quadTreeStrategy.maxCurrZoom)&&(i.splice(s,1),i.length===0&&this._visibleVectorLayersByDepthOrder.splice(t,1)),r.collectVisibleCollections(this._visibleEntityCollections[t]),r.update()}}}memClear(){this._distBeforeMemClear=0,this.camera._insideSegment=null,this.layerLock.lock(this._memKey),this.terrainLock.lock(this._memKey),this._normalMapCreator.lock(this._memKey),this._normalMapCreator.clear(),this.terrain.abortLoading(),this._tileLoader.abortAll(),this.quadTreeStrategy.clear(),this.layerLock.free(this._memKey),this.terrainLock.free(this._memKey),this._normalMapCreator.free(this._memKey),this._createdNodesCount=0}getRayIntersectionEllipsoid(t){return this.ellipsoid.hitRay(t.origin,t.direction)}getCartesianFromPixelEllipsoid(t){let i=this.renderer.activeCamera;return this.ellipsoid.hitRay(i.eye,i.unproject(t.x,t.y))}getLonLatFromPixelEllipsoid(t){let i=this.getCartesianFromPixelEllipsoid(t);if(i)return this.ellipsoid.cartesianToLonLat(i)}getCartesianFromMouseTerrain(){let t=this.renderer.events.mouseState,i=this.getDistanceFromPixel(t);if(i)return t.direction.scaleTo(i).addA(this.renderer.activeCamera.eye)}getCartesianFromPixelTerrain(t){let i=this.getDistanceFromPixel(t);if(i)return(t.direction||this.renderer.activeCamera.unproject(t.x,t.y)).scaleTo(i).addA(this.renderer.activeCamera.eye)}getLonLatFromPixelTerrain(t){let i=this.getCartesianFromPixelTerrain(t);if(i)return this.ellipsoid.cartesianToLonLat(i)}getPixelFromCartesian(t){return this.renderer.activeCamera.project3v(t)}getPixelFromLonLat(t){let i=this.ellipsoid.lonLatToCartesian(t);if(i)return this.renderer.activeCamera.project3v(i)}getDistanceFromPixelEllipsoid(t){let i=this.getCartesianFromPixelEllipsoid(t);if(i)return i.distance(this.renderer.activeCamera.eye)}getDistanceFromPixel(t){return this.renderer.getDistanceFromPixel(t)||this.getDistanceFromPixelEllipsoid(t)||0}viewExtent(t){this.camera?this.camera.viewExtent(t):this._initialViewExtent=t}viewExtentArr(t){this.viewExtent(new j(new L(t[0],t[1]),new L(t[2],t[3])))}getExtent(){if(this.renderer){let t=this.renderer.handler.getWidth(),i=this.renderer.handler.getHeight(),s=[this.getLonLatFromPixelTerrain(new H(0,0)),this.getLonLatFromPixelTerrain(new H(t,0)),this.getLonLatFromPixelTerrain(new H(t,i)),this.getLonLatFromPixelTerrain(new H(0,i))];if(s[0]&&s[1]&&s[2]&&s[3]){let r=s[0].lon,n=s[2].lat,a=s[1].lon,o=s[0].lat;for(let h=0;h<s.length;h++)s[h].lon>a&&(a=s[h].lon),s[h].lat>o&&(o=s[h].lat),s[h].lon<r&&(r=s[h].lon),s[h].lat<n&&(n=s[h].lat);return new j(new L(r,n),new L(a,o))}}return this.quadTreeStrategy._viewExtent}getViewExtent(){return this.quadTreeStrategy._viewExtent}viewLonLat(t,i,s){this.camera.setLonLat(t,i,s)}flyExtent(t,i,s={}){this.camera.flyExtent(t,i,s)}flyCartesian(t,i){this.camera.flyCartesian(t,i)}flyLonLat(t,i={}){this.camera.flyLonLat(t,i)}stopFlying(){this.camera.stopFlying()}updateBillboardsTexCoords(){for(let i=0;i<this.entityCollections.length;i++)this.entityCollections[i].billboardHandler.refreshTexCoordsArr();let t={};for(let i=0;i<this._layers.length;i++){let s=this._layers[i];s instanceof ue&&s.each((function(r){r._entityCollection&&!t[r._entityCollection.id]&&(r._entityCollection.billboardHandler.refreshTexCoordsArr(),t[r._entityCollection.id]=!0)}))}}getEntityTerrainPoint(t,i){let s=this.quadTreeStrategy._renderedNodes,r=s.length;for(;r--;)if(s[r].segment.isEntityInside(t))return s[r].segment.getEntityTerrainPoint(t,i)}async getHeightDefault(t){return new Promise((i=>{this.terrain?this.terrain.getHeightAsync(t.clone(),(s=>{i(s)})):i(0)}))}async getHeightAboveELL(t){return new Promise((i=>{this.terrain?this.terrain.getHeightAsync(t.clone(),(s=>{i(s+this.terrain.geoid.getHeightLonLat(t))})):i(0)}))}onremove(){this.memClear(),this.quadTreeStrategy.destroyBranches(),this.quadTreeStrategy.clearRenderedNodes()}destroy(){var t;this._terrainWorker.destroy(),this._plainSegmentWorker.destroy(),(t=this.renderer)==null||t.destroy(),this.onremove(),super.destroy()}}const Bc=["draw","layeradd","baselayerchange","layerremove","layervisibilitychange","rendercompleted","terraincompleted","layerloadend"];class fr extends lt{constructor(t){super("skybox"),this.params=t,this.vertexPositionBuffer=null,this.texture=null}static createDefault(t){return new fr({nx:t+"skybox/gal/_nx.jpg",px:t+"skybox/gal/_px.jpg",py:t+"skybox/gal/_py.jpg",ny:t+"skybox/gal/_ny.jpg",pz:t+"skybox/gal/_pz.jpg",nz:t+"skybox/gal/_nz.jpg"})}init(){this.renderer.handler.addProgram(new X("skybox",{uniforms:{projectionViewMatrix:{type:he.MAT4},uSampler:{type:he.SAMPLERCUBE},pos:{type:he.VEC3}},attributes:{aVertexPosition:{type:he.VEC3,enableArray:!0}},vertexShader:`attribute vec3 aVertexPosition;
            uniform mat4 projectionViewMatrix;
            uniform vec3 pos;
            varying vec3 vTextureCoord;
            void main(void) {
                vTextureCoord = aVertexPosition;
                gl_Position = projectionViewMatrix * vec4(aVertexPosition + pos, 1.0);
            }`,fragmentShader:`precision lowp float;
            varying vec3 vTextureCoord;
            uniform samplerCube uSampler;
            void main(void) {
                gl_FragColor = textureCube(uSampler, vTextureCoord);
            }`})),this.texture=this.renderer.handler.loadCubeMapTexture(this.params),this._createBuffers(),this.drawMode=this.renderer.handler.gl.TRIANGLES}preFrame(){let t=this.renderer.handler,i=t.gl,s=this.renderer.activeCamera;i.disable(i.DEPTH_TEST),t.programs.skybox.activate();let r=t.programs.skybox._program,n=r.uniforms;if(s.isOrthographic){const o=s.frustum.near,h=s.frustum.far,c=s.getAspectRatio(),d=o*Math.tan(s.viewAngle*Ye),u=d*c,_=new ee().setPerspective(-u,u,-d,d,o,h),p=new ee().set(s.getViewMatrix());i.uniformMatrix4fv(n.projectionViewMatrix,!1,_.mul(p)._m)}else i.uniformMatrix4fv(n.projectionViewMatrix,!1,s.getProjectionViewMatrix());i.uniform3fv(n.pos,s.eye.toArray()),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_CUBE_MAP,this.texture),i.uniform1i(n.uSampler,0);let a=this.vertexPositionBuffer;i.bindBuffer(i.ARRAY_BUFFER,a),i.vertexAttribPointer(r.attributes.aVertexPosition,a.itemSize,i.FLOAT,!1,0,0),i.drawArrays(this.drawMode,0,a.numItems),i.enable(i.DEPTH_TEST)}_createBuffers(){const t=new Float32Array([-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,-1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,-1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,-1e8,1e8,-1e8,-1e8,1e8,-1e8,1e8,-1e8,1e8,1e8,-1e8,1e8,1e8,1e8,1e8,1e8,1e8,-1e8,1e8,1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,1e8,-1e8,1e8]);this.vertexPositionBuffer=this.renderer.handler.createArrayBuffer(t,3,t.length/3)}}const nd=Object.freeze(Object.defineProperty({__proto__:null,Axes:class extends lt{constructor(l=100){super("Axes"),this.size=l,this.axesBuffer=null,this.axesColorBuffer=null}init(){this.createAxesBuffer(this.size),this.drawMode=this.renderer.handler.gl.LINES,this.renderer.handler.addProgram(new X("axesShader",{uniforms:{projectionViewMatrix:"mat4"},attributes:{aVertexPosition:"vec3",aVertexColor:"vec4"},vertexShader:`attribute vec3 aVertexPosition;
            attribute vec4 aVertexColor;
            uniform mat4 projectionViewMatrix;
            varying vec4 vColor;
            void main(void) {
                gl_Position = projectionViewMatrix * vec4(aVertexPosition, 1.0);
                vColor = aVertexColor;
            }`,fragmentShader:`precision highp float;
            varying vec4 vColor;
            void main(void) {
                gl_FragColor = vColor;
            }`}))}frame(){this.renderer.handler.programs.axesShader.activate().set({projectionViewMatrix:this.renderer.activeCamera.getProjectionViewMatrix(),aVertexPosition:this.axesBuffer,aVertexColor:this.axesColorBuffer}),this.renderer.handler.programs.axesShader.drawArrays(this.drawMode,this.axesBuffer.numItems)}createAxesBuffer(l){const t=[0,0,0,l-1,0,0,0,0,0,0,l-1,0,0,0,0,0,0,l-1];this.axesBuffer=this.renderer.handler.createArrayBuffer(new Float32Array(t),3,6),this.axesColorBuffer=this.renderer.handler.createArrayBuffer(new Float32Array([1,0,0,1,1,0,0,1,0,0,1,1,0,0,1,1,0,1,0,1,0,1,0,1]),4,6)}},Planet:yi,RenderNode:lt,SkyBox:fr},Symbol.toStringTag,{value:"Module"})),Mo=class Bo{constructor(t={}){this.__id=Bo.__counter__++,this.equalizeVertices=t.equalizeVertices||!1,this.equalizeNormals=!1,this.isEmpty=!0,this.name=t.name||"empty",this.minZoom=t.minZoom||2,this.maxZoom=t.maxZoom||19,this.maxNativeZoom=t.maxNativeZoom||this.maxZoom,this.gridSizeByZoom=t.gridSizeByZoom||[64,32,16,8,4,4,4,4,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],this._maxNodeZoom=this.gridSizeByZoom.length-1,this.plainGridSize=2,this.noDataValues=[],this._planet=null,this._geoid=t.geoid||new Lo({src:t.geoidSrc||null}),this._isReady=!1}setUrlRewriteCallback(t){}get isIdle(){return!0}isEqual(t){return t.__id===this.__id}static checkNoDataValue(t,i){return Zs(t,i)!==-1}isBlur(t){return!1}set maxNodeZoom(t){t>this.gridSizeByZoom.length-1&&(t=this.gridSizeByZoom.length-1),this._maxNodeZoom=t}get maxNodeZoom(){return this._maxNodeZoom}set geoid(t){this._geoid=t}get geoid(){return this._geoid}getGeoid(){return this._geoid}handleSegmentTerrain(t){t.terrainIsLoading=!1,t.terrainReady=!0,t.terrainExists=!0}isReady(){return this._isReady}abortLoading(){}clearCache(){}getHeightAsync(t,i){return i(0),!0}loadTerrain(t,i=!1){}};Mo.__counter__=0;let gr=Mo;class pr extends gr{constructor(t="",i={}){super({geoidSrc:"https://openglobus.org/geoid/egm84-30.pgm",maxNativeZoom:i.maxNativeZoom||14,...i}),this._s=i.subdomains||["a","b","c"],this.events=le(kc,this),this._requestCount=0,this._requestsPeerSubdomain=4,this.isEmpty=!1,this.equalizeNormals=!0,this.name=t||"openglobus",this.url=i.url||"https://{s}.srtm3.openglobus.org/{z}/{y}/{x}.ddm",this.gridSizeByZoom=i.gridSizeByZoom||[64,32,32,16,16,8,8,8,16,16,16,32,32,32,32,16,8,4,2,2,2,2,2,2],this._heightFactor=i.heightFactor!=null?i.heightFactor:1,this.noDataValues=i.noDataValues||[];for(let s=0;s<this.noDataValues.length;s++)this.noDataValues[s]*=this._heightFactor;this.plainGridSize=i.plainGridSize||32,this._extent=Xs(i.extent,new j(new L(-180,-90),new L(180,90))),this._dataType="arrayBuffer",this._maxNodeZoom=this.gridSizeByZoom.length-1,this._elevationCache={},this._fetchCache={},this._cache=i.cache||"default",this._loader=new Po,this._urlRewriteCallback=i.urlRewrite||null}get loader(){return this._loader}clearCache(){for(let t in this._elevationCache)this._elevationCache[t].heights=null,this._elevationCache[t].extent=null,delete this._elevationCache[t];this._elevationCache=null,this._elevationCache={};for(let t in this._fetchCache)this._fetchCache[t]=null,delete this._fetchCache[t];this._fetchCache=null,this._fetchCache={}}isBlur(t){return t.tileZoom>=6}setElevationCache(t,i){this._elevationCache[t]=i}getElevationCache(t){return this._elevationCache[t]}getHeightAsync(t,i,s,r){if(!t||t.lat>ce||t.lat<ke)return i(0),!0;r=r==null||r;const[n,a,o,h]=this._planet.quadTreeStrategy.getTileXY(t,s||this.maxZoom);let c=Ve.getTileIndex(n,a,o,h),d=this.getElevationCache(c),u=Ui(t);if(d)return d.heights?i(this._getGroundHeightMerc(u,d)):i(0),!0;{let _=this._fetchCache[c];_||(_=this._loader.fetch({src:this._urlRewriteCallback&&this._urlRewriteCallback(n,a,o,h)||this.buildURL(n,a,o,h),type:this._dataType,options:{cache:this._cache}}),this._fetchCache[c]=_),_.then((p=>{let f=Gt(n,a,o);if(p.status==="ready"){let m={heights:this._createHeights(p.data,null,h,n,a,o,f),extent:f};this.setElevationCache(c,m),i(this._getGroundHeightMerc(u,m))}else if(p.status==="error"){if(r&&o>this.maxNativeZoom)return r=!1,void this.getHeightAsync(t,i,this.maxNativeZoom,!1);this.setElevationCache(c,{heights:null,extent:f}),i(0)}else this._fetchCache[c]=null,delete this._fetchCache[c]}))}return!1}_getGroundHeightMerc(t,i){if(!i.extent||!i.heights)return 0;let s=i.extent.getWidth(),r=Math.sqrt(i.heights.length),n=s/(r-1),a=r-Math.ceil((t.lat-i.extent.southWest.lat)/n)-1,o=Math.floor((t.lon-i.extent.southWest.lon)/n),h=(a+1)*r+o,c=h+1,d=a*r+o,u=d+1,_=i.heights[h],p=i.heights[c],f=i.heights[d],m=i.heights[u],g=new v(i.extent.southWest.lon+n*o,_,i.extent.northEast.lat-n*a-n),y=new v(g.x+n,p,g.z),x=new v(g.x,f,g.z+n),b=new v(g.x+n,m,g.z+n),T=new v(t.lon,1e5,t.lat),w=new V(T,new v(0,-1,0)),A=new v,E=w.hitTriangleRes(g,y,x,A);return E===V.INSIDE?A.y:(E=w.hitTriangleRes(y,b,x,A),E===V.INSIDE?A.y:0)}abortLoading(){this._loader.abortAll()}setUrl(t){this.url=t}setName(t){this.name=t}isReadyToLoad(t){return t._tileGroup===0&&this._extent.overlaps(t.getExtentLonLat())}loadTerrain(t,i=!1){if(this._planet.terrainLock.isFree())if(t.terrainReady=!1,t.terrainIsLoading=!0,this.isReadyToLoad(t)){let s=this.getElevationCache(t.tileIndex);s?this._applyElevationsData(t,s.heights):this._loader.load({sender:this,src:this._getHTTPRequestString(t),segment:t,type:this._dataType,options:{cache:this._cache},filter:()=>t.plainReady&&t.node.getState()!==0||i},(r=>{if(r.status==="ready"){let n=this._createHeights(r.data,t,t._tileGroup,t.tileX,t.tileY,t.tileZoom,t.getExtent(),t.tileZoom===this.maxZoom);this.setElevationCache(t.tileIndex,{heights:n,extent:t.getExtent()}),this._applyElevationsData(t,n)}else r.status==="abort"?t.terrainIsLoading=!1:r.status==="error"?this._applyElevationsData(t,null):t.terrainIsLoading=!1}))}else t.elevationsNotExists();else t.terrainIsLoading=!1}_getSubdomain(){return this._requestCount++,this._s[Math.floor(this._requestCount%(this._requestsPeerSubdomain*this._s.length)/this._requestsPeerSubdomain)]}buildURL(t,i,s,r){return Ie(this.url,{s:this._getSubdomain(),x:t.toString(),y:i.toString(),z:s.toString()})}_createUrl(t){return this.buildURL(t.tileX,t.tileY,t.tileZoom,t._tileGroup)}_getHTTPRequestString(t){return this._urlRewriteCallback&&this._urlRewriteCallback(t.tileX,t.tileY,t.tileZoom,t._tileGroup)||this._createUrl(t)}setUrlRewriteCallback(t){this._urlRewriteCallback=t}_createHeights(t,i,s,r,n,a,o,h){if(this._heightFactor!==1){let c=new Float32Array(t);for(let d=0,u=c.length;d<u;d++)c[d]=c[d]*this._heightFactor;return c}return new Float32Array(t)}_applyElevationsData(t,i){if(t){let s=this.events.load;s.handlers.length&&this.events.dispatch(s,{elevations:i,segment:t}),t.applyTerrain(i)}}}const kc=["load","loadend"];class Qi extends Ve{constructor(t,i={}){super(t,i),this.events=this.events.registerNames(Ic),this.url=i.url||"",this._s=i.subdomains||["a","b","c"],this.minNativeZoom=i.minNativeZoom||0,this.maxNativeZoom=i.maxNativeZoom||19,this._urlRewriteCallback=i.urlRewrite||null,this._requestsPeerSubdomains=4,this._requestCount=0,this._cache=i.cache||"default"}get isIdle(){return super.isIdle&&this._planet._tileLoader.getRequestCounter(this)===0}get instanceName(){return"XYZ"}abortLoading(){this._planet&&this._planet._tileLoader.abort(this)}setVisibility(t){t!==this._visibility&&(super.setVisibility(t),t||this.abortLoading())}remove(){return this.abortLoading(),super.remove(),this}setUrl(t){this.url=t}_checkSegment(t){return t._projection.id===this._planet.quadTreeStrategy.projection.id}loadMaterial(t,i=!1){let s=t.segment;this._isBaseLayer?t.texture=s.getDefaultTexture():t.texture=s.planet.transparentTexture,(this._planet.layerLock.isFree()||t.segment.tileZoom<2)&&(t.isReady=!1,t.isLoading=!0,this._checkSegment(s)?(t.loadingAttempts++,this._planet._tileLoader.load({sender:this,src:this._getHTTPRequestString(t.segment),type:"imageBitmap",filter:()=>s.initialized&&s.node.getState()===1||i,options:{cache:this._cache}},(r=>{if(r.status==="ready"){if(t.isLoading){let n=this.events.load;n.handlers.length&&this.events.dispatch(n,t),t.applyImage(r.data),r.data=null}}else r.status==="abort"?t.isLoading=!1:r.status==="error"&&t.isLoading&&t.textureNotExists()}))):t.textureNotExists())}_createUrl(t){return Ie(this.url,{s:this._getSubdomain(),x:t.tileX.toString(),y:t.tileY.toString(),z:t.tileZoom.toString()})}_getSubdomain(){return this._requestCount++,this._s[Math.floor(this._requestCount%(this._requestsPeerSubdomains*this._s.length)/this._requestsPeerSubdomains)]}_getHTTPRequestString(t){return this._urlRewriteCallback?this._urlRewriteCallback(t,this.url):this._createUrl(t)}setUrlRewriteCallback(t){this._urlRewriteCallback=t}applyMaterial(t,i=!1){if(t.isReady)return t.texOffset;if(t.segment.tileZoom<this.minNativeZoom)t.textureNotExists();else{let s=t.segment,r=s.node,n=!1,a=this.__id,o=t;for(;r.parentNode;)if(r=r.parentNode,o=r.segment.materials[a],o&&o.textureExists){n=!0;break}if(s.passReady){let h=t.layer.maxNativeZoom;if(r.segment.tileZoom===h)t.textureNotExists();else if(t.segment.tileZoom<=h)!t.isLoading&&!t.isReady&&this.loadMaterial(t,i);else{let c=s.node;for(;c.segment.tileZoom>t.layer.maxNativeZoom;)c=c.parentNode;let d=c.segment.materials[t.layer.__id];d?!d.isLoading&&!d.isReady&&this.loadMaterial(d,!0):(d=c.segment.materials[t.layer.__id]=t.layer.createMaterial(c.segment),this.loadMaterial(d,!0))}}if(n){t.appliedNode=r,t.appliedNodeId=r.nodeId,t.texture=o.texture;let h=1/(2<<s.tileZoom-r.segment.tileZoom-1);t.texOffset[0]=s.tileX*h-r.segment.tileX,t.texOffset[1]=s.tileY*h-r.segment.tileY,t.texOffset[2]=h,t.texOffset[3]=h}else t.texture=s.planet.transparentTexture,t.texOffset[0]=0,t.texOffset[1]=0,t.texOffset[2]=1,t.texOffset[3]=1}return t.texOffset}clearMaterial(t){t.isReady&&t.textureExists&&(!t.texture.default&&t.segment.handler.gl.deleteTexture(t.texture),t.texture=null),t.isReady=!1,t.textureExists=!1,t.isLoading=!1}_correctFullExtent(){let t=this._extent,i=this._extentMerc;t.northEast.lat===90&&(i.northEast.lat=2008750834e-2),t.northEast.lon===180&&(i.northEast.lon=2008750834e-2),t.southWest.lat===-90&&(i.southWest.lat=-2008750834e-2),t.southWest.lon===-180&&(i.southWest.lon=-2008750834e-2)}}const Ic=["load","loadend"];class _t extends Qi{constructor(t,i){super(t,i),this._extra=new URLSearchParams(i.extra).toString(),i.extent||this.setExtent(new j(new L(-180,-90),new L(180,90))),this.layers=i.layers,this.imageWidth=i.imageWidth||256,this.imageHeight=i.imageHeight||256,this._getBbox=_t.get_bbox_v1_1_1,this._version="",this.setVersion(i.version)}static createRequestUrl(t,i,s="image/png",r="1.1.1",n="GetMap",a,o,h=256,c=256,d){return`${t}?LAYERS=${i}&FORMAT=${s}&SERVICE=WMS&VERSION=${r}&REQUEST=${n}&SRS=${a}&BBOX=${o}&WIDTH=${h}&HEIGHT=${c}`+(d?`&${d}`:"")}static get_bbox_v1_1_1(t){return`${t.getWest()},${t.getSouth()},${t.getEast()},${t.getNorth()}`}static get_bbox_v1_3_0(t,i){return i==="epsg:4326"?`${t.getSouth()},${t.getWest()},${t.getNorth()},${t.getEast()}`:`${t.getWest()},${t.getSouth()},${t.getEast()},${t.getNorth()}`}_checkSegment(t){return!0}get instanceName(){return"WMS"}_createUrl(t){return _t.createRequestUrl(this.url,this.layers,"image/png",this._version,"GetMap",t._projection.code,this._getBbox(t.getExtent(),t._projection.code),this.imageWidth,this.imageHeight,this._extra)}setVersion(t){this._version=t||"1.1.1",this._version==="1.1.1"?this._getBbox=_t.get_bbox_v1_1_1:t==="1.3.0"&&(this._getBbox=_t.get_bbox_v1_3_0)}_correctFullExtent(){const t=this._extent,i=this._extentMerc;t.northEast.lat===90&&(i.northEast.lat=2008750834e-2),t.northEast.lon===180&&(i.northEast.lon=2008750834e-2),t.southWest.lat===-90&&(i.southWest.lat=-2008750834e-2),t.southWest.lon===-180&&(i.southWest.lon=-2008750834e-2)}}class Nt extends pr{constructor(t={}){super("BilTerrain",t),this.equalizeVertices=!0,this.equalizeNormals=!0,this.minZoom=t.minZoom||2,this.maxZoom=t.maxZoom||14,this.noDataValues=t.noDataValues||[-9999,32767],this.url=t.url||"",this._format="application/bil16",this._layers=t.layers||"",this._imageSize=t.imageSize||256,this.plainGridSize=t.plainGridSize!=null?t.plainGridSize:Hi(this._imageSize)?this._imageSize/2:Vt(this._imageSize)/2,this._dataType="arrayBuffer"}isBlur(t){return t.tileZoom>=18}_createUrl(t){return _t.createRequestUrl(this.url,this._layers,this._format,"1.1.1","GetMap",t._projection.code,_t.get_bbox_v1_1_1(t.getExtent()),this._imageSize,this._imageSize)}_createHeights(t,i,s,r,n,a,o,h){let c=new Int16Array(t);if(!Hi(this._imageSize)){let m=new Float32Array(c.length);return(function(g,y){for(let x=0,b=y.length;x<b;x++)y[x]=g[x]})(c,m),m}let d=(this.plainGridSize+1)*(this.plainGridSize+1),u=new Array(4);for(let m=0;m<4;m++){u[m]=[];for(let g=0;g<4;g++)u[m][g]=new Float32Array(d)}let _=new Float32Array(d);(function(m,g,y,x){let b=Math.sqrt(y.length)-1,T=b+1,w=Math.sqrt(m.length),A=w/b,E=0,C=0;for(let M=0,P=0,B=m.length;M<B;M++){let k=m[M],O=Nt.checkNoDataValue(g,k),R=!1,z=!1,D=Math.floor(M/w),S=M%w,I=Math.floor(S/b),N=Math.floor(D/b),Ue=x[N][I],be=D%b,ze=S%b,Se=(be+N)*T+ze+I;if(Ue[Se]=k,(D+N)%A==0&&(S+I)%A==0&&(y[P++]=k),(S+1)%b==0&&S!==w-1){E=m[M],R=Nt.checkNoDataValue(g,E);let re=k;O||R||(re=.5*(k+E)),Se=(be+N)*T+ze+1,Ue[Se]=re,(D+N)%A==0&&(y[P++]=re);let Ge=(be+N)*T+(ze+1)%b;x[N][I+1][Ge]=re}if((D+1)%b==0&&D!==w-1){C=m[M+w],z=Nt.checkNoDataValue(g,C);let re=k;O||z||(re=.5*(k+C)),Se=(be+1)*T+ze+I,Ue[Se]=re,(S+I)%A==0&&(y[P++]=re);let Ge=(be+1)%b*T+ze+I;x[N+1][I][Ge]=re}if((S+1)%b==0&&S!==w-1&&(D+1)%b==0&&D!==w-1){let re=m[M+w+1],Ge=Nt.checkNoDataValue(g,re),De=k;O||R||z||Ge||(De=.25*(k+E+C+re)),Se=(be+1)*T+(ze+1),Ue[Se]=De,y[P++]=De;let Ki=(be+1)*T;x[N][I+1][Ki]=De;let Ji=b;x[N+1][I][Ji]=De;let es=0;x[N+1][I+1][es]=De}}})(c,this.noDataValues,_,u);let p=Ve.getTileIndex(r,n,a,s);this.setElevationCache(p,{heights:_,extent:o});let f=this._imageSize/this.plainGridSize;for(let m=0;m<f;m++)for(let g=0;g<f;g++){let y=2*r+g,x=2*n+m,b=a+1,T=Ve.getTileIndex(y,x,b,s);this.setElevationCache(T,{heights:u[m][g],extent:Gt(y,x,b)})}return _}}class Le extends pr{constructor(t,i={}){super(t||"RgbTerrain",{equalizeVertices:i.equalizeVertices==null||i.equalizeVertices,maxZoom:i.maxZoom||17,noDataValues:i.noDataValues||[i.minHeight!=null?i.minHeight:-1e4],plainGridSize:i.plainGridSize||128,url:i.url!=null?i.url:`//api.mapbox.com/v4/mapbox.terrain-rgb/{z}/{x}/{y}.pngraw?access_token=${i.key||"<key>"}`,gridSizeByZoom:i.gridSizeByZoom||[64,32,16,8,8,8,16,16,16,32,32,32,32,32,32,64,64,64,32,32,16,8],...i}),this.equalizeNormals=i.equalizeNormals||!1,this._dataType="imageBitmap",this._imageSize=i.imageSize||256,this._ctx=this._createTemporalCanvas(this._imageSize),this._imageDataCache={},this._minHeight=i.minHeight||-1e4,this._resolution=i.resolution||.1}static checkNoDataValue(t,i){return i>5e4||Zs(t,i)!==-1}rgb2Height(t,i,s){return t===255?this._minHeight:this._minHeight+this._resolution*(256*t*256+256*i+s)}isBlur(t){return t.tileZoom>=16}_createTemporalCanvas(t){let i=document.createElement("canvas");return i.width=t,i.height=t,i.getContext("2d",{willReadFrequently:!0})}_createHeights(t,i,s,r,n,a,o,h){this._ctx.clearRect(0,0,this._imageSize,this._imageSize),this._ctx.drawImage(t,0,0);let c=this._ctx.getImageData(0,0,this._imageSize,this._imageSize).data;const d=t.width;let u=0,_=0,p=0,f=null,m=!1;if(i&&i.tileZoom>this.maxNativeZoom){let w=i.node;for(;w&&!w.segment.terrainExists;)w=w.parentNode;w&&(u=w.segment.tileX,_=w.segment.tileY,p=w.segment.tileZoom,f=w.segment.elevationData,m=p<=8)}if(!Hi(this._imageSize)&&d===this._imageSize){let w=new Float32Array(d*d);return this.extractElevationTilesRgbNonPowerOfTwo(c,w,this._heightFactor),w}if(this._imageSize===this.plainGridSize){let w=(this.plainGridSize+1)*(this.plainGridSize+1),A=new Float32Array(w),[E,C,M]=i?ys(i.tileX,i.tileY,i.tileZoom,u,_,p):[0,0,0];return this.extractElevationSimple(c,this.noDataValues,f,E,C,M,m,A,this._heightFactor,this._imageSize),A}let g=(this.plainGridSize+1)*(this.plainGridSize+1),y=d/this.plainGridSize,x=new Float32Array(g),b=new Array(y);for(let w=0;w<y;w++){b[w]=[];for(let A=0;A<y;A++)b[w][A]=new Float32Array(g)}if(h)this.extractElevationTilesRgbNoChildren(c,this._heightFactor,this.noDataValues,f,u,_,p,i?i.tileX:0,i?i.tileY:0,i?i.tileZoom:0,m,x);else{this.extractElevationTilesRgb(c,this._heightFactor,this.noDataValues,f,u,_,p,i?i.tileX:0,i?i.tileY:0,i?i.tileZoom:0,m,x,b);for(let w=0;w<y;w++)for(let A=0;A<y;A++){let[E,C,M]=[2*r+A,2*n+w,a+1],P=Ve.getTileIndex(E,C,M,s);this.setElevationCache(P,{heights:b[w][A],extent:Gt(E,C,M)})}}let T=Ve.getTileIndex(r,n,a,s);return this.setElevationCache(T,{heights:x,extent:o}),x}getHeightAsync(t,i,s){if((s=s??this.maxZoom)===0)return i(0),!0;const r=this._planet.quadTreeStrategy,[n,a,o,h]=r.getTileXY(t,s),[c,d]=r.getLonLatTileOffset(t,n,a,o,this._imageSize),u=4*(c*this._imageSize+d),_=Ve.getTileIndex(n,a,o,h);if(this._imageDataCache[_]){let f=this._imageDataCache[_],m=this._heightFactor*this.rgb2Height(f[u],f[u+1],f[u+2]);return Le.checkNoDataValue(this.noDataValues,m)?this.getHeightAsync(t,i,s-1):(i(this._heightFactor*this.rgb2Height(f[u],f[u+1],f[u+2])),!0)}let p=this._fetchCache[_];return p||(p=this._loader.fetch({src:this._urlRewriteCallback&&this._urlRewriteCallback(n,a,o,h)||this.buildURL(n,a,o,h),type:this._dataType,options:{cache:this._cache}}),this._fetchCache[_]=p),p.then((f=>{if(f.status==="ready"){this._ctx.clearRect(0,0,this._imageSize,this._imageSize),this._ctx.drawImage(f.data,0,0);let m=this._ctx.getImageData(0,0,256,256).data;this._imageDataCache[_]=m;let g=this._heightFactor*this.rgb2Height(m[u],m[u+1],m[u+2]);if(Le.checkNoDataValue(this.noDataValues,g))return this.getHeightAsync(t,i,s-1);i(this._heightFactor*this.rgb2Height(m[u],m[u+1],m[u+2]))}else{if(f.status==="error")return this.getHeightAsync(t,i,s-1);this._fetchCache[_]=null,delete this._fetchCache[_]}})),!1}extractElevationSimple(t,i,s=null,r,n,a,o,h,c=1,d){for(let _=0,p=d*d;_<p;_++){let f=_%d,m=Math.floor(_/d),g=4*_,y=c*this.rgb2Height(t[g],t[g+1],t[g+2]);(Le.checkNoDataValue(i,y)||y===0)&&s&&(y=je(a,r,n,s,m,f,o)),h[m*(d+1)+f]=y}for(let _=0,p=d;_<p;_++){let f=d-1,m=4*(_*d+f),g=c*this.rgb2Height(t[m],t[m+1],t[m+2]);(Le.checkNoDataValue(i,g)||g===0)&&s&&(g=je(a,r,n,s,_,f,o)),h[_*(d+1)+d]=g}for(let _=0,p=d;_<p;_++){let f=d-1,m=4*(f*d+_),g=c*this.rgb2Height(t[m],t[m+1],t[m+2]);(Le.checkNoDataValue(i,g)||g===0)&&s&&(g=je(a,r,n,s,f,_,o)),h[d*(d+1)+_]=g}let u=c*this.rgb2Height(t[t.length-4],t[t.length-3],t[t.length-2]);(Le.checkNoDataValue(i,u)||u===0)&&s&&(u=je(a,r,n,s,d-1,d-1,o)),h[h.length-1]=u}extractElevationTilesRgbNonPowerOfTwo(t,i,s=1){for(let r=0,n=i.length;r<n;r++){let a=4*r;i[r]=s*this.rgb2Height(t[a],t[a+1],t[a+2])}}extractElevationTilesRgb(t,i,s,r=null,n,a,o,h,c,d,u,_,p){let f=Math.sqrt(_.length)-1,m=f+1,g=Math.sqrt(t.length/4),y=g/f,x=0,b=0,T=0,[w,A,E]=ys(h,c,d,n,a,o);for(let C=0,M=0,P=t.length/4;C<P;C++){let B=4*C,k=i*this.rgb2Height(t[B],t[B+1],t[B+2]),O=Le.checkNoDataValue(s,k),R=!1,z=!1,D=Math.floor(C/g),S=C%g;(O||k===0)&&r&&(k=je(E,w,A,r,Math.floor(D/y),Math.floor(S/y),u));let I=Math.floor(S/f),N=Math.floor(D/f),Ue=p[N][I],be=D%f,ze=S%f,Se=(be+N)*m+ze+I;if(Ue[Se]=k,(D+N)%y==0&&(S+I)%y==0&&(_[M++]=k),(S+1)%f==0&&S!==g-1){x=i*this.rgb2Height(t[B+4],t[B+5],t[B+6]),R=Le.checkNoDataValue(s,x),(R||x===0)&&r&&(x=je(E,w,A,r,Math.floor(D/y),Math.floor((S+1)/y),u));let re=k;O||R||(re=.5*(k+x)),Se=(be+N)*m+ze+1,Ue[Se]=re,(D+N)%y==0&&(_[M++]=re);let Ge=(be+N)*m+(ze+1)%f;p[N][I+1][Ge]=re}if((D+1)%f==0&&D!==g-1){T=4*g,b=i*this.rgb2Height(t[B+T],t[B+T+1],t[B+T+2]),z=Le.checkNoDataValue(s,b),(z||b===0)&&r&&(b=je(E,w,A,r,Math.floor((D+1)/y),Math.floor(S/y),u));let re=.5*(k+b);O||z||(re=.5*(k+b)),Se=(be+1)*m+ze+I,Ue[Se]=re,(S+I)%y==0&&(_[M++]=re);let Ge=(be+1)%f*m+ze+I;p[N+1][I][Ge]=re}if((S+1)%f==0&&S!==g-1&&(D+1)%f==0&&D!==g-1){let re=i*this.rgb2Height(t[B+T+4],t[B+T+5],t[B+T+6]),Ge=Le.checkNoDataValue(s,re);(Ge||re===0)&&r&&(re=je(E,w,A,r,Math.floor((D+1)/y),Math.floor((S+1)/y),u));let De=k;O||R||z||Ge||(De=.25*(k+x+b+re)),Se=(be+1)*m+(ze+1),Ue[Se]=De,_[M++]=De;let Ki=(be+1)*m;p[N][I+1][Ki]=De;let Ji=f;p[N+1][I][Ji]=De;let es=0;p[N+1][I+1][es]=De}}}extractElevationTilesRgbNoChildren(t,i,s,r=null,n,a,o,h,c,d,u,_){let p=Math.sqrt(_.length)-1,f=p+1,m=Math.sqrt(t.length/4),g=m/p,y=0,x=0,b=0,[T,w,A]=ys(h,c,d,n,a,o);for(let E=0,C=0,M=t.length/4;E<M;E++){let P=4*E,B=i*this.rgb2Height(t[P],t[P+1],t[P+2]),k=Le.checkNoDataValue(s,B),O=!1,R=!1,z=Math.floor(E/m),D=E%m;(k||B===0)&&r&&(B=je(A,T,w,r,Math.floor(C/f),C%f,u));let S=Math.floor(D/p),I=Math.floor(z/p);if((z+I)%g==0&&(D+S)%g==0&&(_[C++]=B),(D+1)%p==0&&D!==m-1){y=i*this.rgb2Height(t[P+4],t[P+5],t[P+6]),O=Le.checkNoDataValue(s,y),(O||y===0)&&r&&(y=je(A,T,w,r,Math.floor(C/f),C%f,u));let N=B;k||O||(N=.5*(B+y)),(z+I)%g==0&&(_[C++]=N)}if((z+1)%p==0&&z!==m-1){b=4*m,x=i*this.rgb2Height(t[P+b],t[P+b+1],t[P+b+2]),R=Le.checkNoDataValue(s,x),(R||x===0)&&r&&(x=je(A,T,w,r,Math.floor(C/f),C%f,u));let N=.5*(B+x);k||R||(N=.5*(B+x)),(D+S)%g==0&&(_[C++]=N)}if((D+1)%p==0&&D!==m-1&&(z+1)%p==0&&z!==m-1){let N=i*this.rgb2Height(t[P+b+4],t[P+b+5],t[P+b+6]),Ue=Le.checkNoDataValue(s,N);(Ue||N===0)&&r&&(N=je(A,T,w,r,Math.floor(C/f),C%f,u));let be=B;k||O||R||Ue||(be=.25*(B+y+x+N)),_[C++]=be}}}}function ys(l,t,i,s,r,n){let a=2<<i-n-1;return[l-a*s,t-a*r,1/a]}function je(l,t,i,s,r,n,a){let o=Math.sqrt(s.length),h=s[Math.floor(i*l*o+r*l)*o+Math.floor(t*l*o+n*l)];return a&&h>0?0:h}const zc={[pc]:"north",[Ct]:"south"},Dc=(l,t,i,s)=>{let r=zc[s];if(r)return`https://terrain.openglobus.org/poles/${r}/${i}/${l}/${t}.png`};class ko extends Le{constructor(t,i){super(t||"GlobusEarthRgb",{maxNativeZoom:6,maxZoom:17,url:"https://{s}.terrain.openglobus.org/all/{z}/{x}/{y}.png",urlRewrite:Dc,...i})}isReadyToLoad(t){return this._extent.overlaps(t.getExtentLonLat())}}Object.freeze(Object.defineProperty({__proto__:null,BilTerrain:Nt,EmptyTerrain:gr,GlobusRgbTerrain:ko,GlobusTerrain:pr,RgbTerrain:Le},Symbol.toStringTag,{value:"Module"}));class Fc extends mi{constructor(t,i={}){super(t,i),this._sourceTexture=i.texture||null,i.texture&&(this._sourceReady=!0,this._sourceCreated=!0),this._frameWidth=i.frameWidth!=null?Vt(i.frameWidth):256,this._frameHeight=i.frameHeight!=null?Vt(i.frameHeight):256,this._animate=!0}get instanceName(){return"GeoTexture2d"}loadMaterial(t){this._planet._geoImageCreator.add(this)}bindTexture(t){this._sourceReady=!0,this._sourceCreated=!0,this._sourceTexture=t}setSize(t,i){this._frameWidth=t,this._frameHeight=i,this._frameCreated=!1}abortMaterialLoading(t){this._creationProceeding=!1,t.isLoading=!1,t.isReady=!1}}class Oc extends mi{constructor(t,i={}){super(t,i),this._animate=!0,this._video=i.videoElement||null,this._src=i.src||null}get instanceName(){return"GeoVideo"}setSrc(t){this._planet&&this._planet._geoImageCreator.remove(this),this._src=t,this._sourceReady=!1}setVideoElement(t){this._planet&&this._planet._geoImageCreator.remove(this),this._video=t,this._src=t.src,this._sourceReady=!1}setVisibility(t){t!=this._visibility&&(super.setVisibility(t),this._planet&&(t?(this._sourceReady&&this._planet._geoImageCreator.add(this),this._video&&this._video.play()):(this._sourceReady&&this._planet._geoImageCreator.remove(this),this._video&&this._video.pause())))}_createSourceTexture(){let t=this._planet.renderer.handler.gl;this._sourceCreated?(t.bindTexture(t.TEXTURE_2D,this._sourceTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._video)):(this._sourceTexture=this._planet.renderer.handler.createTexture_n_webgl1(this._video),this._sourceCreated=!0)}_onCanPlay(t){this._frameWidth=t.videoWidth,this._frameHeight=t.videoHeight,t.width=t.videoWidth,t.height=t.videoHeight,t.play(),this._sourceReady=!0,this._planet._geoImageCreator.add(this)}_onError(t){let i="unknown error";switch(t.error.code){case 1:i="video loading aborted";break;case 2:i="network loading error";break;case 3:i="video decoding failed / corrupted data or unsupported codec";break;case 4:i="video not supported"}console.warn(`Error: ${i} error-code=${t.error.code})`)}loadMaterial(t){if(t.isLoading=!0,this._creationProceeding=!0,!this._sourceReady&&this._src){if(this._video){if(this._video.readyState===this._video.HAVE_ENOUGH_DATA)this._onCanPlay(this._video);else if(this._video.src){let i=this;this._video.addEventListener("canplay",(function(s){i._onCanPlay(this)}))}}else{this._video=document.createElement("video"),this._video.crossOrigin="Anonymous";let i=this;this._video.addEventListener("canplay",(function(){i._onCanPlay(this)})),this._video.addEventListener("error",(function(){i._onError(this)}))}this._video.autoplay=!0,this._video.loop=!0,this._video.src=this._src,this._video.muted=!0,this._video.setAttribute("playsinline","true"),this._video.setAttribute("webkit-playsinline","true")}else this._planet._geoImageCreator.add(this)}abortMaterialLoading(t){this._video&&(this._video.src=""),this._creationProceeding=!1,t.isLoading=!1,t.isReady=!1}}class Nc extends ue{constructor(t,i={}){super(t,i),this._billboard=i.billboard||{src:"https://openglobus.org/examples/billboards/carrot.png"},this._color=i.color||"#6689db"}get instanceName(){return"KML"}_extractCoordonatesFromKml(t){return Array.from(t.getElementsByTagName("coordinates")).map((i=>i.textContent.trim())).map((i=>i.replace(/\n/g," ").replace(/\t/g," ").replace(/ +/g," ").split(" ").map((s=>s.split(",").map(parseFloat)))))}_AGBRtoRGBA(t){if(!t||t.length!=8)return;const i=parseInt(t.slice(0,2),16)/255,s=parseInt(t.slice(2,4),16),r=parseInt(t.slice(4,6),16);return`rgba(${parseInt(t.slice(6,8),16)},${r},${s},${i})`}_parseKMLcoordinates(t){return t.innerHTML.trim().replace(/\n/g," ").replace(/\t/g," ").replace(/ +/g," ").split(" ").map((i=>i.split(",").map(parseFloat)))}_kmlPlacemarkToEntity(t,i){if(!t)return;const s=Array.from(t.getElementsByTagName("name")),r=s&&s.length>0?s[0].innerHTML.trim():"",{iconHeading:n,iconURL:a,iconColor:o,lineWidth:h,lineColor:c}=this._extractStyle(t),d=[];for(const u of t.getElementsByTagName("coordinates")){const _=this._parseKMLcoordinates(u)||[[0,0,0]];for(const p of _){const[f,m,g]=p;d.push(new L(f,m,g)),f<i.southWest.lon&&(i.southWest.lon=f),m<i.southWest.lat&&(i.southWest.lat=m),f>i.northEast.lon&&(i.northEast.lon=f),m>i.northEast.lat&&(i.northEast.lat=m)}}if(d.length===1){const u=.01745329*n;return new U({name:r,lonlat:d[0],billboard:{src:a,size:[24,24],color:o,rotation:u},properties:{color:o,heading:n}})}return new U({name:r,polyline:{pathLonLat:[d],thickness:h,color:c,isClosed:!1},properties:{name:r}})}_extractStyle(t){let i,s,r,n,a;const o=t.getElementsByTagName("Style")[0];if(o){let h=o.getElementsByTagName("IconStyle")[0];if(h){let d=h.getElementsByTagName("color")[0];d&&(i=this._AGBRtoRGBA(d.innerHTML.trim()));let u=h.getElementsByTagName("heading")[0];if(u){const p=parseFloat(u.innerHTML.trim());p>=0&&p<=360&&(s=p%360)}let _=h.getElementsByTagName("Icon")[0];if(_){let p=_.getElementsByTagName("href")[0];p&&(r=p.innerHTML.trim())}}let c=o.getElementsByTagName("LineStyle")[0];if(c){let d=c.getElementsByTagName("color")[0];d&&(n=this._AGBRtoRGBA(d.innerHTML.trim()));let u=c.getElementsByTagName("width")[0];u!==void 0&&(a=parseFloat(u.innerHTML.trim()))}}return i||(i="#FFFFFF"),s||(s=0),r||(r="https://openglobus.org/examples/billboards/carrot.png"),n||(n="#FFFFFF"),a||(a=1),{iconHeading:s,iconURL:r,iconColor:i,lineWidth:a,lineColor:n}}_parseKML(t,i,s){if(s||(s=[]),t.documentElement.nodeName!=="kml")return s;for(const r of t.getElementsByTagName("Placemark")){const n=this._kmlPlacemarkToEntity(r,i);n&&s.push(n)}return s}_convertKMLintoEntities(t){const i=new j(new L(180,90),new L(-180,-90));return{entities:this._parseKML(t,i),extent:i}}_convertCoordonatesIntoEntities(t,i,s){const r=new j(new L(180,90),new L(-180,-90)),n=o=>{const h=o[0],c=o[1];h<r.southWest.lon&&(r.southWest.lon=h),c<r.southWest.lat&&(r.southWest.lat=c),h>r.northEast.lon&&(r.northEast.lon=h),c>r.northEast.lat&&(r.northEast.lat=c)},a=[];return t.forEach((o=>o.forEach((h=>a.push(h))))),{entities:a.map((o=>{if(o.length===1){const h=o[0],c=new U({lonlat:h,billboard:s});return n(h),c}if(o.length>1){const h=o.map((c=>(n(c),new L(c[0],c[1],c[2]))));return new U({polyline:{pathLonLat:[h],thickness:3,color:i,isClosed:!1}})}})),extent:r}}_getXmlContent(t){return new Promise((i=>{const s=new FileReader;s.onload=async r=>i(new DOMParser().parseFromString(r.target.result,"text/xml")),s.readAsText(t)}))}_expandExtents(t,i){return t?(i.southWest.lon<t.southWest.lon&&(t.southWest.lon=i.southWest.lon),i.southWest.lat<t.southWest.lat&&(t.southWest.lat=i.southWest.lat),i.northEast.lon>t.northEast.lon&&(t.northEast.lon=i.northEast.lon),i.northEast.lat>t.northEast.lat&&(t.northEast.lat=i.northEast.lat),t):i}async addKmlFromFiles(t,i,s){if(!Array.isArray(t))return null;const r=(await Promise.all(t.map(this._getXmlContent))).map(this._extractCoordonatesFromKml),{entities:n,extent:a}=this._convertCoordonatesIntoEntities(r,i||this._color,s||this._billboard);return this._extent=this._expandExtents(this._extent,a),n.forEach(this.add.bind(this)),{entities:n,extent:a}}setColor(t){this._color=t,this._billboard.color=t}_getKmlFromUrl(t){return new Promise(((i,s)=>{const r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="document",r.overrideMimeType("text/xml"),r.onload=()=>{r.readyState===r.DONE&&r.status===200?i(r.responseXML):s(new Error("no valid kml file"))},r.send()}))}async addKmlFromUrl(t,i,s){const r=await this._getKmlFromUrl(t),{entities:n,extent:a}=this._convertKMLintoEntities(r);return this._extent=this._expandExtents(this._extent,a),n.forEach(this.add.bind(this)),{entities:n,extent:a}}}class Io extends Qi{constructor(t,i={}){super(t||"OpenStreetMap",{iconSrc:"https://tile.openstreetmap.org/8/138/95.png",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"Data @ OpenStreetMap contributors, ODbL",isBaseLayer:!0,maxNativeZoom:19,defaultTextures:[{color:"#AAD3DF"},{color:"#F2EFE9"}],isSRGB:!1,shininess:18,specular:[63e-5,55e-5,32e-5],ambient:[.2,.2,.3],diffuse:[.9,.9,.7],...i})}}function Hc(l,t,i){var s="";for(let a=i;a>0;a--){var r=0,n=1<<a-1;l&n&&r++,t&n&&(r+=2),s+=r.toString()}return s}class zo extends Qi{constructor(t,i={}){super(t||"Bing",{iconSrc:"https://ecn.t0.tiles.virtualearth.net/tiles/a120.jpeg?n=z&g=7146",subdomains:["t0","t1","t2","t3"],url:"https://ecn.{s}.tiles.virtualearth.net/tiles/a{quad}.jpeg?n=z&g=7146",isBaseLayer:!0,textureFilter:"LINEAR",maxNativeZoom:17,defaultTextures:[{color:"#001522"},{color:"#E4E6F3"}],attribution:'<div style="transform: scale(0.8); margin-top:-2px;"><a href="https://www.bing.com" target="_blank"><img style="position: relative; top: 2px;" title="Bing Imagery" src="https://sandcastle.cesium.com/CesiumUnminified/Assets/Images/bing_maps_credit.png"></a>  2021 Microsoft Corporation</div>',urlRewrite:(s,r)=>Ie(r,{s:this._getSubdomain(),quad:Hc(s.tileX,s.tileY,s.tileZoom)}),specular:[63e-5,55e-5,32e-5],ambient:[.35,.35,.35],diffuse:[1.5,1.5,1.5],shininess:20,nightTextureCoefficient:2.7,...i})}}Object.freeze(Object.defineProperty({__proto__:null,Bing:zo,CanvasTiles:Kn,GeoImage:wo,GeoTexture2d:Fc,GeoVideo:Oc,KML:Nc,LAYER_EVENTS:Qn,Layer:Ve,Material:$n,OpenStreetMap:Io,Vector:ue,WMS:_t,XYZ:Qi},Symbol.toStringTag,{value:"Module"}));const xs=function(l,t){return+(l.priority<t.priority)};class Vc{constructor(){this._currentlyPressedKeys={},this._pressedKeysCallbacks={},this._unpressedKeysCallbacks={},this._charkeysCallbacks={},this._anykeyCallback=null,this._event=null,this._active=!0,this._stampCache={},document.onkeydown=t=>{this._event=t,this._active&&this.handleKeyDown()},document.onkeyup=t=>{this._event=t,this._active&&this.handleKeyUp()}}getcurrentlyPressedKeys(){return this._currentlyPressedKeys}getPressedKeysCallbacks(){return this._pressedKeysCallbacks}getUnpressedKeysCallbacks(){return this._unpressedKeysCallbacks}getCharkeysCallbacks(){return this._charkeysCallbacks}removeEvent(t,i,s){let r=this._getStamp(t,i,s._openglobus_id);s._openglobus_id&&this._stampCache[r]&&(delete this._stampCache[r],t==="keypress"?this._removeCallback(this._pressedKeysCallbacks[i],s):t==="keyfree"?this._removeCallback(this._unpressedKeysCallbacks[i],s):t==="charkeypress"&&this._removeCallback(this._charkeysCallbacks[i],s))}_removeCallback(t,i){for(let s=0;s<t.length;s++)t[s].callback._openglobus_id===i._openglobus_id&&t.splice(s,1)}_getStamp(t,i,s){return`${t}_${i}_${s}`}_stamp(t,i,s){const r=Ws(s),n=this._getStamp(t,i,r);return!this._stampCache[n]&&(this._stampCache[n]=r,!0)}setActivity(t){this._active=t}releaseKeys(){this._currentlyPressedKeys={}}addEvent(t,i,s,r,n){if(this._stamp(t,i,s))switch(n===void 0&&(n=1600),t){case"keyfree":this._unpressedKeysCallbacks[i]||(this._unpressedKeysCallbacks[i]=[]),this._unpressedKeysCallbacks[i].push({callback:s,sender:r,priority:n}),this._unpressedKeysCallbacks[i].sort(xs);break;case"keypress":i==null?this._anykeyCallback={callback:s,sender:r||this}:(this._pressedKeysCallbacks[i]||(this._pressedKeysCallbacks[i]=[]),this._pressedKeysCallbacks[i].push({callback:s,sender:r,priority:n}),this._pressedKeysCallbacks[i].sort(xs));break;case"charkeypress":this._charkeysCallbacks[i]||(this._charkeysCallbacks[i]=[]),this._charkeysCallbacks[i].push({callback:s,sender:r,priority:n}),this._charkeysCallbacks[i].sort(xs)}}isKeyPressed(t){return this._currentlyPressedKeys[t]}handleKeyDown(){this._anykeyCallback&&this._anykeyCallback.callback.call(this._anykeyCallback.sender,this._event),this._currentlyPressedKeys[this._event.keyCode]=!0;for(let t in this._charkeysCallbacks)if(String.fromCharCode(this._event.keyCode)===String.fromCharCode(Number(t))){let i=this._charkeysCallbacks[t];for(let s=0;s<i.length;s++)i[s].callback.call(i[s].sender,this._event)}this._event.keyCode!=W.KEY_ALT&&this._event.keyCode!=W.KEY_SHIFT||this._event.preventDefault()}handleKeyUp(){if(this._currentlyPressedKeys[this._event.keyCode]||this._event.keyCode===W.KEY_PRINTSCREEN){for(let t in this._unpressedKeysCallbacks)if(this._currentlyPressedKeys[t]||this._event.keyCode===W.KEY_PRINTSCREEN&&Number(t)===W.KEY_PRINTSCREEN){let i=this._unpressedKeysCallbacks[t];for(let s=0;s<i.length;s++)i[s].callback.call(i[s].sender,this._event)}}this._currentlyPressedKeys[this._event.keyCode]=!1}handleEvents(){for(let t in this._pressedKeysCallbacks)if(this._currentlyPressedKeys[t]){let i=this._pressedKeysCallbacks[t];for(let s=0;s<i.length;s++)i[s].callback.call(i[s].sender,this._event)}}}class Uc{constructor(t){this._htmlObject=t}setEvent(t,i,s){switch(t){case"mousewheel":this._htmlObject.addEventListener("wheel",(r=>{let n=r.deltaY||r.detail||r.wheelDelta||0;var a;r.wheelDelta==null&&(r.wheelDelta=-120*n),r.isTouchPad=(a=r).deltaMode===0&&Math.abs(a.deltaY)<50,s.call(i,r),r.preventDefault()}),!1);break;case"mousedown":this._htmlObject.addEventListener("mousedown",(function(r){let n=this.getBoundingClientRect();s.call(i,r,{button:r.button,clientX:r.clientX-n.left,clientY:r.clientY-n.top})})),this._htmlObject.addEventListener("contextmenu",(function(r){return r.preventDefault(),!1}));break;case"mouseup":this._htmlObject.addEventListener("mouseup",(function(r){let n=this.getBoundingClientRect();s.call(i,r,{button:r.button,clientX:r.clientX-n.left,clientY:r.clientY-n.top})}));break;case"mousemove":this._htmlObject.addEventListener("mousemove",(function(r){let n=this.getBoundingClientRect();s.call(i,r,{clientX:r.clientX-n.left,clientY:r.clientY-n.top})}));break;case"mouseleave":this._htmlObject.addEventListener("mouseleave",(function(r){s.call(i,r)}));break;case"mouseout":this._htmlObject.addEventListener("mouseout",(function(r){s.call(i,r)}));break;case"mouseover":this._htmlObject.addEventListener("mouseover",(function(r){s.call(i,r)}));break;case"mouseenter":this._htmlObject.addEventListener("mouseenter",(function(r){s.call(i,r)}))}}}class Gc{constructor(t){this.$el=t,this.$el.style.touchAction="none",this.$el.style.userSelect="none",this._activePointers=new Map}setEvent(t,i,s){let r=this;switch(t){case"pointercancel":this.$el.addEventListener("pointercancel",(function(n){if(r._activePointers.delete(n.pointerId)){const a=this.getBoundingClientRect(),o=Object.assign(n,{offsetLeft:a.left,offsetTop:a.top,pointers:[...r._activePointers.values()],activePointers:r._activePointers});s.call(i,o)}}));break;case"pointerdown":this.$el.addEventListener("pointerdown",(function(n){if(n.pointerType==="touch"){r._activePointers.set(n.pointerId,n);const a=this.getBoundingClientRect(),o=Object.assign(n,{offsetLeft:a.left,offsetTop:a.top,pointers:[...r._activePointers.values()],activePointers:r._activePointers});s.call(i,o)}}));break;case"pointerup":this.$el.addEventListener("pointerup",(function(n){if(r._activePointers.delete(n.pointerId)){const a=this.getBoundingClientRect(),o=Object.assign(n,{offsetLeft:a.left,offsetTop:a.top,pointers:[...r._activePointers.values()],activePointers:r._activePointers});s.call(i,o)}}));break;case"pointermove":this.$el.addEventListener("pointermove",(function(n){if(n.pointerType==="touch"&&r._activePointers.has(n.pointerId)){r._activePointers.set(n.pointerId,n);const a=this.getBoundingClientRect(),o=Object.assign(n,{offsetLeft:a.left,offsetTop:a.top,pointers:[...r._activePointers.values()],activePointers:r._activePointers});s.call(i,o)}}))}}}let ct=new Uint8Array(4),$t=new Uint8Array(4),Xt=new Uint8Array(4);class jc extends ir{constructor(t){super(qc),this.renderer=t,this._mouseHandler=new Uc(t.handler.canvas),this._pointerHandler=new Gc(t.handler.canvas),this._keyboardHandler=new Vc,this._active=!0,this.clickRadius=15,this.mouseState={clientX:0,clientY:0,pos:new H,x:0,y:0,nx:0,ny:0,prev_x:0,prev_y:0,direction:new v,leftButtonUp:!1,rightButtonUp:!1,middleButtonUp:!1,leftButtonDown:!1,rightButtonDown:!1,middleButtonDown:!1,leftButtonHold:!1,rightButtonHold:!1,middleButtonHold:!1,leftButtonDoubleClick:!1,rightButtonDoubleClick:!1,middleButtonDoubleClick:!1,leftButtonClick:!1,rightButtonClick:!1,middleButtonClick:!1,moving:!1,justStopped:!1,doubleClickDelay:500,clickDelay:200,wheelDelta:0,sys:null,pickingObject:null,renderer:t,isTouchPad:!1},this.touchState={touching:!1,moving:!1,touchEnd:!1,touchStart:!1,touchCancel:!1,doubleTouch:!1,doubleTouchDelay:550,doubleTouchRadius:10,clientX:0,clientY:0,pos:new H,x:0,y:0,nx:0,ny:0,prev_x:0,prev_y:0,direction:new v,sys:null,pickingObject:null,renderer:t},this._isMouseInside=!0,this._entityPickingEventsActive=!0,this._dblTchCoords=new H,this._oneTouchStart=!1,this._dblTchBegins=0,this._mousestopThread=null,this._ldblClkBegins=0,this._rdblClkBegins=0,this._mdblClkBegins=0,this._lClkBegins=0,this._rClkBegins=0,this._mClkBegins=0,this._lclickX=0,this._lclickY=0,this._rclickX=0,this._rclickY=0,this._mclickX=0,this._mclickY=0}pointerEvent(){let t=this.mouseState;return t.moving||t.justStopped||t.wheelDelta!==0}get active(){return this._active}set active(t){this._active=t,this._keyboardHandler.setActivity(t)}handleEvents(){this._active&&(this.mouseState.direction=this.renderer.activeCamera.unproject(this.mouseState.x,this.mouseState.y),this.touchState.direction=this.renderer.activeCamera.unproject(this.touchState.x,this.touchState.y),this._keyboardHandler.handleEvents(),this.handleMouseEvents(),this.handleTouchEvents(),this.entityPickingEvents())}on(t,i,s,r,n){t==="keypress"||t==="charkeypress"||t==="keyfree"?this._keyboardHandler.addEvent(t,i,s,r,n):super.on(t,i,s,r)}off(t,i,s){t==="keypress"||t==="charkeypress"||t==="keyfree"?this._keyboardHandler.removeEvent(t,i,s):super.off(t,i)}isKeyPressed(t){return this._keyboardHandler.isKeyPressed(t)}releaseKeys(){this._keyboardHandler.releaseKeys()}initialize(){this._mouseHandler.setEvent("mouseup",this,this.onMouseUp),this._mouseHandler.setEvent("mousemove",this,this.onMouseMove),this._mouseHandler.setEvent("mousedown",this,this.onMouseDown),this._mouseHandler.setEvent("mousewheel",this,this.onMouseWheel),this._mouseHandler.setEvent("mouseleave",this,this.onMouseLeave),this._mouseHandler.setEvent("mouseenter",this,this.onMouseEnter),this._pointerHandler.setEvent("pointerdown",this,this.onPointerDown),this._pointerHandler.setEvent("pointerup",this,this.onPointerUp),this._pointerHandler.setEvent("pointercancel",this,this.onPointerCancel),this._pointerHandler.setEvent("pointermove",this,this.onPointerMove)}onMouseWheel(t){this.mouseState.isTouchPad=t.isTouchPad||!1,this.mouseState.sys=t,this.mouseState.wheelDelta=t.wheelDelta||0}updateButtonsStates(t){let i=this.mouseState;1&t&&i.leftButtonDown?i.leftButtonDown=!0:(i.leftButtonHold=!1,i.leftButtonDown=!1),2&t&&i.rightButtonDown?i.rightButtonDown=!0:(i.rightButtonHold=!1,i.rightButtonDown=!1),4&t&&i.middleButtonDown?i.middleButtonDown=!0:(i.middleButtonHold=!1,i.middleButtonDown=!1)}onMouseMove(t,i){let s=this.mouseState;this.updateButtonsStates(t.buttons),s.sys=t;let r=i.clientX,n=i.clientY,a=this.clickRadius;if(Math.abs(this._lclickX-r)>=a&&Math.abs(this._lclickY-n)>=a&&(this._ldblClkBegins=0,this._lClkBegins=0),Math.abs(this._rclickX-r)>=a&&Math.abs(this._rclickY-n)>=a&&(this._rdblClkBegins=0,this._rClkBegins=0),Math.abs(this._mclickX-r)>=a&&Math.abs(this._mclickY-n)>=a&&(this._mdblClkBegins=0,this._mClkBegins=0),s.clientX===i.clientX&&s.clientY===i.clientY)return;s.clientX=i.clientX,s.clientY=i.clientY;let o=this.renderer.handler;s.pos.x=s.x=i.clientX*o.pixelRatio,s.pos.y=s.y=i.clientY*o.pixelRatio,s.nx=s.x/o.canvas.width,s.ny=s.y/o.canvas.height,s.moving=!0,clearTimeout(this._mousestopThread),this._mousestopThread=setTimeout((function(){s.justStopped=!0}),100)}onMouseLeave(t){this._isMouseInside=!1,this.mouseState.sys=t,this.dispatch(this.mouseleave,this.mouseState)}onMouseEnter(t){this._isMouseInside=!0,this.mouseState.sys=t,this.dispatch(this.mouseenter,this.mouseState)}onMouseDown(t,i){i.button===W.MB_LEFT?(this._lClkBegins=window.performance.now(),this._lclickX=i.clientX,this._lclickY=i.clientY,this.mouseState.sys=t,this.mouseState.leftButtonDown=!0):i.button===W.MB_RIGHT?(this._rClkBegins=window.performance.now(),this._rclickX=i.clientX,this._rclickY=i.clientY,this.mouseState.sys=t,this.mouseState.rightButtonDown=!0):i.button===W.MB_MIDDLE&&(this._mClkBegins=window.performance.now(),this._mclickX=i.clientX,this._mclickY=i.clientY,this.mouseState.sys=t,this.mouseState.middleButtonDown=!0)}onMouseUp(t,i){let s=this.mouseState;s.sys=t;let r=window.performance.now();i.button===W.MB_LEFT?(s.leftButtonDown=!1,s.leftButtonUp=!0,Math.abs(this._lclickX-i.clientX)<this.clickRadius&&Math.abs(this._lclickY-i.clientY)<this.clickRadius&&r-this._lClkBegins<=s.clickDelay&&(this._ldblClkBegins?(window.performance.now()-this._ldblClkBegins<=s.doubleClickDelay&&(s.leftButtonDoubleClick=!0),this._ldblClkBegins=0):this._ldblClkBegins=window.performance.now(),s.leftButtonClick=!0,this._lClkBegins=0)):i.button===W.MB_RIGHT?(s.rightButtonDown=!1,s.rightButtonUp=!0,Math.abs(this._rclickX-i.clientX)<this.clickRadius&&Math.abs(this._rclickY-i.clientY)<this.clickRadius&&r-this._rClkBegins<=s.clickDelay&&(this._rdblClkBegins?(window.performance.now()-this._rdblClkBegins<=s.doubleClickDelay&&(s.rightButtonDoubleClick=!0),this._rdblClkBegins=0):this._rdblClkBegins=window.performance.now(),s.rightButtonClick=!0,this._rClkBegins=0)):i.button===W.MB_MIDDLE&&(s.middleButtonDown=!1,s.middleButtonUp=!0,Math.abs(this._mclickX-i.clientX)<this.clickRadius&&Math.abs(this._mclickY-i.clientY)<this.clickRadius&&r-this._mClkBegins<=s.clickDelay)&&(this._mdblClkBegins?(window.performance.now()-this._mdblClkBegins<=s.doubleClickDelay&&(s.middleButtonDoubleClick=!0),this._mdblClkBegins=0):this._mdblClkBegins=window.performance.now(),s.middleButtonClick=!0,this._mClkBegins=0)}onPointerDown(t){let i=this.touchState;i.sys=t,i.clientX=t.pointers[0].clientX-t.offsetLeft,i.clientY=t.pointers[0].clientY-t.offsetTop;let s=this.renderer.handler;i.pos.x=i.x=i.clientX*s.pixelRatio,i.pos.y=i.y=i.clientY*s.pixelRatio,i.nx=i.x/s.canvas.width,i.ny=i.y/s.canvas.height,i.prev_x=i.x,i.prev_y=i.y,i.touchStart=!0,i.touching=!0,t.pointers.length===1?(this._dblTchCoords.x=i.x,this._dblTchCoords.y=i.y,this._oneTouchStart=!0):this._oneTouchStart=!1}onPointerUp(t){let i=this.touchState;i.sys=t,i.touchEnd=!0,t.pointers.length===0&&(i.prev_x=i.x,i.prev_y=i.y,this._oneTouchStart)&&(this._dblTchBegins&&(window.performance.now()-this._dblTchBegins<=i.doubleTouchDelay&&(i.doubleTouch=!0),this._dblTchBegins=0),this._dblTchBegins=window.performance.now(),this._oneTouchStart=!1)}onPointerCancel(t){let i=this.touchState;i.sys=t,i.touchCancel=!0}onPointerMove(t){let i=this.touchState;i.clientX=t.pointers[0].clientX-t.offsetLeft,i.clientY=t.pointers[0].clientY-t.offsetTop;let s=this.renderer.handler;i.x=i.clientX*s.pixelRatio,i.y=i.clientY*s.pixelRatio,i.nx=i.x/s.canvas.width,i.ny=i.y/s.canvas.height,i.sys=t,i.moving=!0;let r=i.x-i.prev_x,n=i.y-i.prev_y;(Math.abs(r)>9||Math.abs(n)>9)&&(this._dblTchBegins=0,this._oneTouchStart=!1)}entityPickingEvents(){let t=this.touchState,i=this.mouseState;if(this._isMouseInside!==this._entityPickingEventsActive&&(this._entityPickingEventsActive=this._isMouseInside,!this._entityPickingEventsActive)){let r=this.renderer,n=ct,a=r.getPickingObjectArr(n);if(a){let o=a.rendererEvents;i.pickingObject=a,o&&o.dispatch(o.mouseleave,i),t.pickingObject=a,o&&o.dispatch(o.touchleave,t)}ct[0]=ct[1]=ct[2]=ct[3]=Xt[0]=Xt[1]=Xt[2]=Xt[3]=$t[0]=$t[1]=$t[2]=$t[3]=0}if(this._isMouseInside&&!(i.leftButtonHold||i.rightButtonHold||i.middleButtonHold)){let r=this.renderer,n=ct,a=Xt,o=$t;t.x||t.y?r.readPickingColor(t.nx,1-t.ny,o):r.readPickingColor(i.nx,1-i.ny,o),a[0]=n[0],a[1]=n[1],a[2]=n[2],n[0]=o[0],n[1]=o[1],n[2]=o[2],i.pickingObject=null,t.pickingObject=null;let h=r.getPickingObjectArr(n);if(i.pickingObject=h,t.pickingObject=h,n[0]!==a[0]||n[1]!==a[1]||n[2]!==a[2])if((s=n)[0]||s[1]||s[2]){if((c=>!!(c[0]||c[1]||c[2]))(a)){let c=r.getPickingObjectArr(a);if(c){let d=c.rendererEvents;i.pickingObject=c,d&&d.dispatch(d.mouseleave,i),t.pickingObject=c,d&&d.dispatch(d.touchleave,t)}}if(h){let c=h.rendererEvents;i.pickingObject=h,c&&c.dispatch(c.mouseenter,i),t.pickingObject=h,c&&c.dispatch(c.touchenter,t)}}else{let c=r.getPickingObjectArr(a);if(c){let d=c.rendererEvents;i.pickingObject=c,d&&d.dispatch(d.mouseleave,i),t.pickingObject=c,d&&d.dispatch(d.touchleave,t)}}}var s}handleMouseEvents(){let t=this,i=this.mouseState,s=i.pickingObject,r=null;i.leftButtonClick&&(s&&(r=s.rendererEvents,r&&r.dispatch(r.lclick,i)),this.dispatch(t.lclick,i),i.leftButtonClick=!1),i.rightButtonClick&&(s&&(r=s.rendererEvents,r&&r.dispatch(r.rclick,i)),this.dispatch(t.rclick,i),i.rightButtonClick=!1),i.middleButtonClick&&(s&&(r=s.rendererEvents,r&&r.dispatch(r.mclick,i)),this.dispatch(t.mclick,i),i.middleButtonClick=!1),i.leftButtonDown&&(i.leftButtonHold?(s&&(r=s.rendererEvents,r&&r.dispatch(r.lhold,i)),this.dispatch(t.lhold,i)):(i.leftButtonHold=!0,s&&(r=s.rendererEvents,r&&r.dispatch(r.ldown,i)),this.dispatch(t.ldown,i))),i.rightButtonDown&&(i.rightButtonHold?(s&&(r=s.rendererEvents,r&&r.dispatch(r.rhold,i)),this.dispatch(t.rhold,i)):(i.rightButtonHold=!0,s&&(r=s.rendererEvents,r&&r.dispatch(r.rdown,i)),this.dispatch(t.rdown,i))),i.middleButtonDown&&(i.middleButtonHold?(s&&(r=s.rendererEvents,r&&r.dispatch(r.mhold,i)),this.dispatch(t.mhold,i)):(i.middleButtonHold=!0,s&&(r=s.rendererEvents,r&&r.dispatch(r.mdown,i)),this.dispatch(t.mdown,i))),i.leftButtonUp&&(s&&(r=s.rendererEvents,r&&r.dispatch(r.lup,i)),this.dispatch(t.lup,i),i.leftButtonUp=!1,i.leftButtonHold=!1),i.rightButtonUp&&(s&&(r=s.rendererEvents,r&&r.dispatch(r.rup,i)),this.dispatch(t.rup,i),i.rightButtonUp=!1,i.rightButtonHold=!1),i.middleButtonUp&&(s&&(r=s.rendererEvents,r&&r.dispatch(r.mup,i)),this.dispatch(t.mup,i),i.middleButtonUp=!1,i.middleButtonHold=!1),i.leftButtonDoubleClick&&(s&&(r=s.rendererEvents,r&&r.dispatch(r.ldblclick,i)),this.dispatch(t.ldblclick,i),i.leftButtonDoubleClick=!1),i.rightButtonDoubleClick&&(s&&(r=s.rendererEvents,r&&r.dispatch(r.rdblclick,i)),this.dispatch(t.rdblclick,i),i.rightButtonDoubleClick=!1),i.middleButtonDoubleClick&&(s&&(r=s.rendererEvents,r&&r.dispatch(r.mdblclick,i)),this.dispatch(t.mdblclick,i),i.middleButtonDoubleClick=!1),i.wheelDelta&&(s&&(r=s.rendererEvents,r&&r.dispatch(r.mousewheel,i)),this.dispatch(t.mousewheel,i)),i.moving&&(s&&(r=s.rendererEvents,r&&r.dispatch(r.mousemove,i)),this.dispatch(t.mousemove,i),i.prev_x=i.x,i.prev_y=i.y),i.justStopped&&this.dispatch(t.mousestop,i)}handleTouchEvents(){let t=this,i=this.touchState,s=i.pickingObject,r=null;if(i.touchCancel&&(this.dispatch(t.touchcancel,i),i.touchCancel=!1),i.touchStart){let n=this.renderer;n.readPickingColor(i.nx,1-i.ny,ct);let a=n.getPickingObjectArr(ct);s=i.pickingObject=a,s&&(r=s.rendererEvents,r&&r.dispatch(r.touchstart,i)),this.dispatch(t.touchstart,i),i.touchStart=!1}i.doubleTouch&&(s&&(r=s.rendererEvents,r&&r.dispatch(r.doubletouch,i)),this.dispatch(t.doubletouch,i),i.doubleTouch=!1),i.touchEnd&&(s&&(r=s.rendererEvents,r&&r.dispatch(r.touchend,i)),this.dispatch(t.touchend,i),i.x=0,i.y=0,i.touchEnd=!1,i.touching=!1),i.moving&&(s&&(r=s.rendererEvents,r&&r.dispatch(r.touchmove,i)),this.dispatch(t.touchmove,i),i.prev_x=i.x,i.prev_y=i.y)}}const qc=["projchanged","changerelativecenter","draw","drawtransparent","postdraw","resize","resizeend","mouseenter","mouseleave","mousemove","mousestop","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchstart","touchend","touchcancel","touchmove","doubletouch","touchleave","touchenter"];class wi{constructor(t=0,i=0,s=0,r=0){this.left=t,this.right=s,this.top=i,this.bottom=r}set(t=0,i=0,s=0,r=0){this.left=t,this.right=s,this.top=i,this.bottom=r}clone(){return new wi(this.left,this.top,this.right,this.bottom)}getWidth(){return Math.abs(this.right-this.left)}getHeight(){return Math.abs(this.bottom-this.top)}getSquare(){return this.getHeight()*this.getWidth()}getDiagonal(){let t=this.getWidth(),i=this.getHeight();return Math.sqrt(i*i+t*t)}fit(t,i){return this.getWidth()===t&&this.getHeight()===i}isInside(t,i){return t>=this.left&&t<=this.right&&i>=this.top&&i<=this.bottom}}class Yc{constructor(){this.imagesCache={},this._counter=0,this._pendingsQueue=new _r,this._imageIndexCounter=0}load(t,i){if(this.imagesCache[t])i(this.imagesCache[t]);else{let s={src:t,success:i};this._counter>=1?this._pendingsQueue.unshift(s):this._exec(s)}}_exec(t){this._counter++;const i=this;let s=new Image;s.crossOrigin="",s.onload=function(){i.imagesCache[t.src]=s,s.__nodeIndex=i._imageIndexCounter++,t.success(s),i._dequeueRequest()},s.onerror=function(){i._dequeueRequest()},s.src=t.src}_dequeueRequest(){if(this._counter--,this._pendingsQueue.length&&this._counter<1)for(;this._pendingsQueue.length;){let t=this._pendingsQueue.pop();if(t){if(!this.imagesCache[t.src]){this._exec(t);break}this._counter<=0?this._counter=0:this._counter--,t.success(this.imagesCache[t.src])}}}}class Us{constructor(t=1024,i=1024){this.nodes=new Map,this.texture=null,this.canvas=new ci(t,i),this.clearCanvas(),this._handler=null,this._images=[],this._btree=null,this._imagesCacheManager=new Yc,this.borderSize=4}getImage(){return this.canvas.getImage()}getCanvas(){return this.canvas.getCanvas()}clearCanvas(){this.canvas.fillEmpty()}assignHandler(t){this._handler=t,this.createTexture()}getDiagonal(t){let i=t.atlasWidth||t.width,s=t.atlasHeight||t.height;return Math.sqrt(i*i+s*s)}addImage(t,i=!1){if(t.width&&t.height)return this._images.push(t),this._makeAtlas(i),t.__nodeIndex!=null?this.get(t.__nodeIndex):void 0}_completeNode(t,i){if(i){let s=this.canvas.getWidth(),r=this.canvas.getHeight(),n=i.image,a=i.rect,o=Math.round(.5*this.borderSize);this.canvas.drawImage(n,a.left+o,a.top+o,n.atlasWidth||0,n.atlasHeight||0);let h=i.texCoords;h[0]=(a.left+o)/s,h[1]=(a.top+o)/r,h[2]=(a.left+o)/s,h[3]=(a.bottom-o)/r,h[4]=(a.right-o)/s,h[5]=(a.bottom-o)/r,h[6]=(a.right-o)/s,h[7]=(a.bottom-o)/r,h[8]=(a.right-o)/s,h[9]=(a.top+o)/r,h[10]=(a.left+o)/s,h[11]=(a.top+o)/r,t.set(n.__nodeIndex,i)}}_makeAtlas(t=!1){if(t&&this._btree){let i=this._images[this._images.length-1];this._completeNode(this.nodes,this._btree.insert(i))}else{let i=this._images.slice(0);i.sort((function(r,n){return(n.atlasWidth||n.width)-(r.atlasWidth||r.width)||(n.atlasHeight||n.height)-(r.atlasHeight||r.height)})),this._btree=new xi(new wi(0,0,this.canvas.getWidth(),this.canvas.getHeight())),this._btree.atlas=this,this.clearCanvas();let s=new Map;for(let r=0;r<i.length;r++)this._completeNode(s,this._btree.insert(i[r]));this.nodes=null,this.nodes=s}}get(t){return this.nodes.get(t)}set(t,i){this.nodes.set(t,i)}createTexture(t,i){this._handler&&(this._handler.gl.deleteTexture(this.texture),t&&(this.canvas.resize(t.width,t.height),this.canvas.drawImage(t,0,0,t.width,t.height)),this.texture=this._handler.createTexture_l(this.canvas.getCanvas(),i))}loadImage(t,i){this._imagesCacheManager.load(t,i)}getImageTexCoordinates(t){if(t.__nodeIndex!=null){let i=this.get(t.__nodeIndex);if(i)return i.texCoords}}}class xi{constructor(t,i){this.childNodes=null,this.image=null,this.rect=t||new wi,this.texCoords=i||[],this.atlas=null}insert(t){if(this.childNodes)return this.childNodes[0].insert(t)||this.childNodes[1].insert(t);{if(this.image!=null)return;let i=this.rect;const s=(t.atlasWidth||t.width)+this.atlas.borderSize,r=(t.atlasHeight||t.height)+this.atlas.borderSize;return s>i.getWidth()||r>i.getHeight()?void 0:i.fit(s,r)?(this.image=t,this):(this.childNodes=new Array(2),this.childNodes[0]=new xi,this.childNodes[0].atlas=this.atlas,this.childNodes[1]=new xi,this.childNodes[1].atlas=this.atlas,i.getWidth()-s>i.getHeight()-r?(this.childNodes[0].rect.set(i.left,i.top,i.left+s,i.bottom),this.childNodes[1].rect.set(i.left+s,i.top,i.right,i.bottom)):(this.childNodes[0].rect.set(i.left,i.top,i.right,i.top+r),this.childNodes[1].rect.set(i.left,i.top+r,i.right,i.bottom)),this.childNodes[0].insert(t))}}}class gn extends Us{constructor(t,i){super(t,i),this.width=0,this.height=0,this.gliphSize=0,this.distanceRange=0,this.nodes=new Map,this.kernings={}}get(t){return this.nodes.get(t)}}class Wc extends xi{constructor(t,i){super(t,i),this.emptySize=1,this.metrics={id:0,char:"",width:0,height:0,x:0,y:0,chnl:0,index:0,page:0,xadvance:0,xoffset:0,yoffset:0,nChar:"",nCode:0,nWidth:0,nHeight:0,nAdvance:0,nXOffset:0,nYOffset:0}}}class $c{constructor(t){this.atlasesArr=[],this.atlasIndexes={},this.atlasIndexesDeferred={},this.tokenImageSize=64,this.samplerArr=new Uint32Array(11),this.sdfParamsArr=new Float32Array(44),this._handler=null,this.catalogSrc=t||"./"}assignHandler(t){this._handler=t}getFontIndex(t){let i=this.getFullIndex(t);return this.atlasIndexes[i]||this.loadFont(t,this.catalogSrc,`${t}.json`),this.atlasIndexesDeferred[i]||(this.atlasIndexesDeferred[i]=new hi),this.atlasIndexesDeferred[i].promise}getFullIndex(t){return t.trim().toLowerCase()}_applyFontDataToAtlas(t,i,s=0){let r=i.chars;t.height=i.common.scaleH,t.width=i.common.scaleW,t.gliphSize=i.info.size,t.distanceRange=i.distanceField.distanceRange;let n=t.width,a=t.height,o=t.gliphSize;this.sdfParamsArr[4*s]=n,this.sdfParamsArr[4*s+1]=a,this.sdfParamsArr[4*s+2]=o,this.sdfParamsArr[4*s+3]=t.distanceRange;let h={};for(let c=0;c<r.length;c++){let d=r[c],u=d.char;h[d.id]=u;let _=new wi(d.x,d.y,d.x+d.width,d.y+d.height),p=new Array(12);p[0]=_.left/n,p[1]=_.top/a,p[2]=_.left/n,p[3]=_.bottom/a,p[4]=_.right/n,p[5]=_.bottom/a,p[6]=_.right/n,p[7]=_.bottom/a,p[8]=_.right/n,p[9]=_.top/a,p[10]=_.left/n,p[11]=_.top/a;let f=new Wc(_,p),m=d.char.normalize("NFKC"),g=m.charCodeAt(0),y=f.metrics;y.id=d.id,y.char=d.char,y.width=d.width,y.height=d.height,y.x=d.x,y.y=d.y,y.chnl=d.chnl,y.index=d.index,y.page=d.page,y.xadvance=d.xadvance,y.xoffset=d.xoffset,y.yoffset=d.yoffset,y.nChar=m,y.nCode=g,y.nWidth=f.metrics.width/o,y.nHeight=f.metrics.height/o,y.nAdvance=f.metrics.xadvance/o,y.nXOffset=f.metrics.xoffset/o,y.nYOffset=1-f.metrics.yoffset/o,f.emptySize=1,t.nodes.set(m.charCodeAt(0),f)}t.kernings={};for(let c=0;c<i.kernings.length;c++){let d=i.kernings[c],u=d.first,_=d.second;t.kernings[u]||(t.kernings[u]={}),t.kernings[u][_]=d.amount/o}}initFont(t,i,s){let r=this.atlasesArr.length,n=this.getFullIndex(t);this.atlasIndexes[n]=r;let a=this.atlasIndexesDeferred[n];a||(a=this.atlasIndexesDeferred[n]=new hi),this.samplerArr[this.atlasesArr.length]=r;let o=new gn;o.height=0,o.width=0,o.gliphSize=0,o.distanceRange=0,o.kernings={},o.assignHandler(this._handler),this.atlasesArr[r]=o,this._applyFontDataToAtlas(o,i,r);let h=new Image;h.onload=()=>{this._createTexture(o,h),a.resolve(r)},h.src=s}_createTexture(t,i){t.createTexture(i)}loadFont(t,i,s){let r=this.atlasesArr.length,n=this.getFullIndex(t);this.atlasIndexes[n]=r;let a=this.atlasIndexesDeferred[n];a||(a=this.atlasIndexesDeferred[n]=new hi),this.samplerArr[this.atlasesArr.length]=r;let o=new gn;o.height=0,o.width=0,o.gliphSize=0,o.distanceRange=0,o.kernings={},o.assignHandler(this._handler),this.atlasesArr[r]=o,fetch(`${i}/${s}`).then((h=>{if(!h.ok)throw Error(`Unable to load "${i}/${s}"`);return h.json()})).then((h=>{this._applyFontDataToAtlas(o,h,r);let c=new Image;c.onload=()=>{this._createTexture(o,c),a.resolve(r)},c.src=`${i}/${h.pages[0]}`,c.crossOrigin="Anonymous"})).catch((h=>(a.reject(),{status:"error",msg:h.toString()})))}}let Xc=0,Zc=0,It=new Float32Array(2);class Qc{constructor(t,i={}){var s,r;if(this.div=null,this.handler=t instanceof Lt?t:new Lt(t,{pixelRatio:i.dpi||window.devicePixelRatio+.15,autoActivate:!0}),this.clearColor=new Float32Array(i.clearColor||[0,0,0,1]),this.exposure=i.exposure||3.01,this.gamma=i.gamma||.47,this.whitepoint=1,this.brightThreshold=.9,this._renderNodesArr=[],this.renderNodes={},this.activeCamera=new cr({width:(s=this.handler.canvas)==null?void 0:s.width,height:(r=this.handler.canvas)==null?void 0:r.height,eye:new v(0,0,0),look:new v(0,0,-1),up:new v(0,1,0)}),this.events=new jc(this),this.controls={},i.controls)for(let o in i.controls)this.controls[i.controls[o].name]=i.controls[o];this.controlsBag={},this.colorObjects=new Map,this._pickingCallbacks=[],this.pickingFramebuffer=null,this._depthCallbacks=[],this.depthFramebuffer=null,this._depthRefreshRequired=!1;let n=new URLSearchParams(location.search),a=n.get("og_msaa");this._msaa=a?Number(n.get("og_msaa")):i.msaa!=null?i.msaa:0,this._internalFormat="RGBA16F",this._format="RGBA",this._type="FLOAT",this.sceneFramebuffer=null,this.blitFramebuffer=null,this.toneMappingFramebuffer=null,this._initialized=!1,this.billboardsTextureAtlas=new Us,this.fontAtlas=new $c(i.fontsSrc),this.strokeTextureAtlas=new Us,this._entityCollections=[[]],this._currentOutput="screen",this._fnScreenFrame=null,this.labelWorker=new al(4),this.screenDepthFramebuffer=null,this.screenFramePositionBuffer=null,this.screenTexture={},this.outputTexture=null,this._readPickingBuffer=this._readPickingBuffer_webgl2,(i.autoActivate||Fe(i.autoActivate))&&this.start()}enableBlendOneSrcAlpha(){let t=this.handler.gl;t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA)}enableBlendDefault(){let t=this.handler.gl;t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE)}setRelativeCenter(t){this.events.dispatch(this.events.changerelativecenter,t||this.activeCamera.eye)}setEventsActivity(t){this.events.active=t}addDepthCallback(t,i){let s=Zc++;return this._depthCallbacks.push({id:s,callback:i,sender:t}),s}removeDepthCallback(t){for(let i=0;i<this._depthCallbacks.length;i++)if(t===this._depthCallbacks[i].id){this._depthCallbacks.splice(i,1);break}}addPickingCallback(t,i){let s=Xc++;return this._pickingCallbacks.push({id:s,callback:i,sender:t}),s}removePickingCallback(t){for(let i=0;i<this._pickingCallbacks.length;i++)if(t===this._pickingCallbacks[i].id){this._pickingCallbacks.splice(i,1);break}}getPickingObject(t,i,s){return this.colorObjects.get(`${t}_${i}_${s}`)}getPickingObjectArr(t){return this.colorObjects.get(`${t[0]}_${t[1]}_${t[2]}`)}getPickingObject3v(t){return this.colorObjects.get(`${t.x}_${t.y}_${t.z}`)}assignPickingColor(t){if(!t._pickingColor||t._pickingColor.isZero()){let i=0,s=0,r=0,n="0_0_0";for(;!(i||s||r)||this.colorObjects.has(n);)i=Li(1,255),s=Li(1,255),r=Li(1,255),n=`${i}_${s}_${r}`;t._pickingColor?t._pickingColor.set(i,s,r):t._pickingColor=new v(i,s,r),t._pickingColorU=new Float32Array([i/255,s/255,r/255]),this.colorObjects.set(n,t)}}clearPickingColor(t){if(t._pickingColor&&!t._pickingColor.isZero()){let i=t._pickingColor;i.isZero()||(this.colorObjects.delete(`${i.x}_${i.y}_${i.z}`),i.x=i.y=i.z=0)}}getWidth(){return this.handler.canvas.clientWidth}getHeight(){return this.handler.canvas.clientHeight}getCenter(){let t=this.handler.canvas;return new H(Math.round(.5*t.width),Math.round(.5*t.height))}getClientCenter(){let t=this.handler.canvas;return new H(Math.round(.5*t.clientWidth),Math.round(.5*t.clientHeight))}addControl(t){t.addTo(this)}addControls(t){for(let i=0;i<t.length;i++)t[i].addTo(this)}removeControl(t){t.remove()}isInitialized(){return this._initialized}initialize(){if(!this._initialized){if(this._initialized=!0,this.handler.initialize(),this.billboardsTextureAtlas.assignHandler(this.handler),this.fontAtlas.assignHandler(this.handler),this.strokeTextureAtlas.assignHandler(this.handler),this.handler.setFrameCallback((()=>{this.draw()})),this.events.initialize(),this.events.on("charkeypress",W.KEY_APOSTROPHE,(function(){Qe.setVisibility(!Qe.getVisibility())})),this.handler.addProgram(new X("screenFrame",{uniforms:{texture:"sampler2d"},attributes:{corners:"vec3"},vertexShader:`attribute vec2 corners;
            
            varying vec2 tc;
            void main(void) {
                gl_Position = vec4(corners, 0.0, 1.0);
                tc = corners * 0.5 + 0.5;
            }`,fragmentShader:`precision highp float;
            uniform sampler2D texture;
            
            varying vec2 tc;
            
            void main(void) {
                gl_FragColor = texture2D( texture, tc );
            }`})),this.pickingFramebuffer=new Pe(this.handler,{width:640,height:480,targets:[{readAsync:!0}]}),this.pickingFramebuffer.init(),this.depthFramebuffer=new Pe(this.handler,{width:640,height:480,targets:[{internalFormat:"RGBA",type:"UNSIGNED_BYTE",attachment:"COLOR_ATTACHMENT",readAsync:!0},{internalFormat:"RGBA16F",type:"FLOAT",attachment:"COLOR_ATTACHMENT",readAsync:!0}],useDepth:!0}),this.depthFramebuffer.init(),this.screenDepthFramebuffer=new Pe(this.handler,{useDepth:!1}),this.screenDepthFramebuffer.init(),this.handler.gl.type==="webgl")this._readPickingBuffer=this._readPickingBuffer_webgl1,this.sceneFramebuffer=new Pe(this.handler),this.sceneFramebuffer.init(),this._fnScreenFrame=this._screenFrameNoMSAA,this.screenTexture={screen:this.sceneFramebuffer.textures[0],picking:this.pickingFramebuffer.textures[0],depth:this.screenDepthFramebuffer.textures[0]};else{let t=this.getMaxMSAA(this._internalFormat);this._msaa>t&&(this._msaa=t),this.handler.addPrograms([new X("toneMapping",{uniforms:{hdrBuffer:"sampler2d",exposure:"float",gamma:"float",whitepoint:"float"},attributes:{corners:"vec3"},vertexShader:`#version 300 es
in vec2 corners;out vec2 tc;void main(void){gl_Position=vec4(corners,0.0,1.0);tc=corners*0.5+0.5;}`,fragmentShader:`#version 300 es
precision highp float;
#ifndef saturate
#define saturate(a) clamp(a, 0.0, 1.0)
#endif
uniform sampler2D hdrBuffer;uniform float whitepoint;uniform float exposure;uniform float gamma;vec3 LinearToneMapping(vec3 color){return exposure*color;}vec3 ReinhardToneMapping2(vec3 color){return vec3(1.0)-exp(-color*exposure);}vec3 ReinhardToneMapping(vec3 color){color*=exposure;return saturate(color/(vec3(1.0)+color));}
#define Uncharted2Helper(x) max(((x * (0.15 * x + 0.10 * 0.50) + 0.20 * 0.02) / (x * (0.15 * x + 0.50) + 0.20 * 0.30)) - 0.02 / 0.30, vec3(0.0))
vec3 Uncharted2ToneMapping(vec3 color){color*=exposure;return saturate(Uncharted2Helper(color)/Uncharted2Helper(vec3(whitepoint)));}vec3 OptimizedCineonToneMapping(vec3 color){color*=exposure;color=max(vec3(0.0),color-0.004);return pow((color*(6.2*color+0.5))/(color*(6.2*color+1.7)+0.06),vec3(2.2));}vec3 ACESFilmicToneMapping(vec3 color){color*=exposure;return saturate((color*(2.51*color+0.03))/(color*(2.43*color+0.59)+0.14));}in vec2 tc;layout(location=0)out vec4 fragColor;void main(void){vec4 hdrColor=texture(hdrBuffer,tc);float oneByGamma=gamma/gamma;float oneByWhitePoint=whitepoint/whitepoint;vec3 mapped=ReinhardToneMapping2(hdrColor.rgb)*oneByGamma*oneByWhitePoint;mapped=pow(mapped,vec3(1.0/gamma));fragColor=vec4(mapped,hdrColor.a);}`})]),this.handler.addPrograms([new X("depth",{uniforms:{depthTexture:"sampler2D"},attributes:{corners:"vec2"},vertexShader:`#version 300 es
            
            in vec2 corners;
            
            out vec2 tc;

            void main(void) {
                gl_Position = vec4(corners, 0.0, 1.0);
                tc = corners * 0.5 + 0.5;
            }`,fragmentShader:`#version 300 es

            precision highp float;

            uniform sampler2D depthTexture;
           
            in vec2 tc;

            layout(location = 0) out vec4 fragColor;

            float LinearizeDepth(in vec2 uv)
            {
                return texture(depthTexture, tc).r;
            }
            
            void main(void) {
                float c = LinearizeDepth(tc);
                fragColor = vec4(c, c, c, 1.0);
            }`})]),this.sceneFramebuffer=new bo(this.handler,{size:1,msaa:this._msaa,internalFormat:this._internalFormat,filter:"LINEAR"}),this.sceneFramebuffer.init(),this.blitFramebuffer=new Pe(this.handler,{size:1,useDepth:!1,targets:[{internalFormat:this._internalFormat,format:this._format,type:this._type,filter:"NEAREST"}]}),this.blitFramebuffer.init(),this.toneMappingFramebuffer=new Pe(this.handler,{useDepth:!1}),this.toneMappingFramebuffer.init(),this._fnScreenFrame=this._screenFrameMSAA,this.screenTexture={screen:this.toneMappingFramebuffer.textures[0],picking:this.pickingFramebuffer.textures[0],depth:this.screenDepthFramebuffer.textures[0],frustum:this.depthFramebuffer.textures[0]}}this.handler.ONCANVASRESIZE=()=>{this._resizeStart(),this.events.dispatch(this.events.resize,this.handler.canvas),this._resizeEnd(),this.events.dispatch(this.events.resizeend,this.handler.canvas)},this.screenFramePositionBuffer=this.handler.createArrayBuffer(new Float32Array([1,1,-1,1,1,-1,-1,-1]),2,4),this.outputTexture=this.screenTexture.screen,this._initializeRenderNodes(),this._initializeControls()}}_initializeControls(){let t=this.controls;this.controls={};for(let i in t)this.addControl(t[i])}resize(){this._resizeEnd()}setCurrentScreen(t){this._currentOutput=t,this.screenTexture[t]&&(this.outputTexture=this.screenTexture[t])}_resizeStart(){let t=this.handler.canvas;this.activeCamera.setViewportSize(t.width,t.height),this.sceneFramebuffer.setSize(.5*t.width,.5*t.height),this.blitFramebuffer&&this.blitFramebuffer.setSize(.5*t.width,.5*t.height,!0)}_resizeEnd(){let t=this.handler.canvas;this.activeCamera.setViewportSize(t.width,t.height),this.sceneFramebuffer.setSize(t.width,t.height),this.blitFramebuffer&&this.blitFramebuffer.setSize(t.width,t.height,!0),this.toneMappingFramebuffer&&this.toneMappingFramebuffer.setSize(t.width,t.height,!0),this.screenDepthFramebuffer&&this.screenDepthFramebuffer.setSize(t.clientWidth,t.clientHeight,!0),this.handler.gl.type==="webgl"?(this.screenTexture.screen=this.sceneFramebuffer.textures[0],this.screenTexture.picking=this.pickingFramebuffer.textures[0],this.screenTexture.depth=this.screenDepthFramebuffer.textures[0],this.screenTexture.frustum=this.depthFramebuffer.textures[0]):(this.screenTexture.screen=this.toneMappingFramebuffer.textures[0],this.screenTexture.picking=this.pickingFramebuffer.textures[0],this.screenTexture.depth=this.screenDepthFramebuffer.textures[0],this.screenTexture.frustum=this.depthFramebuffer.textures[0]),this.setCurrentScreen(this._currentOutput)}removeNode(t){t.remove()}addNode(t){this.renderNodes[t.name]?Qe.logWrn(`Node name ${t.name} already exists.`):(t.assign(this),this._renderNodesArr.unshift(t),this.renderNodes[t.name]=t)}_initializeRenderNodes(){for(let t=0;t<this._renderNodesArr.length;t++)this._renderNodesArr[t].initialize()}addNodeBefore(t,i){if(this.renderNodes[t.name])Qe.logWrn(`Node name ${t.name} already exists.`);else{t.assign(this),this.renderNodes[t.name]=t;for(let s=0;s<this._renderNodesArr.length;s++)if(this._renderNodesArr[s].isEqual(i)){this._renderNodesArr.splice(s,0,t);break}this._renderNodesArr.unshift(t)}}addNodes(t){for(let i=0;i<t.length;i++)this.addNode(t[i])}getMaxMSAA(t){let i=this.handler.gl;return i.getInternalformatParameter(i.RENDERBUFFER,i[t],i.SAMPLES)[0]}getMSAA(){return this._msaa}enqueueEntityCollectionsToDraw(t,i=0){this._entityCollections[i]||(this._entityCollections[i]=[]),this._entityCollections[i].push(...t)}markForDepthRefresh(){this._depthRefreshRequired=!0}_drawEntityCollections(t){let i=this._entityCollections[t];if(i.length){let s=this.handler.gl;this.enableBlendDefault();let r=i.length;for(;r--;)i[r]._fadingOpacity&&i[r].pointCloudHandler.draw();for(r=i.length;r--;){let a=i[r];i[r]._fadingOpacity&&(a.events.dispatch(a.events.draw,a),i[r].geoObjectHandler.draw())}for(s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.billboardsTextureAtlas.texture),r=i.length;r--;){let a=i[r];a._fadingOpacity&&a.billboardHandler.draw()}let n=this.fontAtlas.atlasesArr;for(r=0;r<n.length;r++)s.activeTexture(s.TEXTURE0+r),s.bindTexture(s.TEXTURE_2D,n[r].texture);for(r=i.length;r--;)i[r]._fadingOpacity&&i[r].labelHandler.draw();for(s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.strokeTextureAtlas.texture),r=i.length;r--;)i[r]._fadingOpacity&&i[r].rayHandler.draw();for(r=i.length;r--;)i[r]._fadingOpacity&&i[r].polylineHandler.draw();for(r=i.length;r--;)i[r]._fadingOpacity&&i[r].stripHandler.draw()}}_drawPickingEntityCollections(t){let i=this._entityCollections[t];if(i.length){let s=i.length;for(;s--;)i[s]._fadingOpacity&&i[s].billboardHandler.drawPicking();for(s=i.length;s--;)i[s]._fadingOpacity&&i[s].geoObjectHandler.drawPicking();for(s=i.length;s--;)i[s]._fadingOpacity&&i[s].labelHandler.drawPicking();for(s=i.length;s--;)i[s]._fadingOpacity&&i[s].rayHandler.drawPicking();for(s=i.length;s--;)i[s]._visibility&&i[s].polylineHandler.drawPicking();for(s=i.length;s--;)i[s]._visibility&&i[s].stripHandler.drawPicking()}}_drawDepthEntityCollections(t){let i=this._entityCollections[t];if(i.length){let s=i.length;for(;s--;)i[s]._fadingOpacity&&i[s].geoObjectHandler.drawDepth()}}_clearEntityCollectionQueue(t){this._entityCollections[t].length=0,this._entityCollections[t]=[]}draw(){this.activeCamera.checkMoveEnd();let t=this.events,i=t.pointerEvent(),s=!t.mouseState.leftButtonDown&&!t.mouseState.rightButtonDown,r=t.touchState.touchStart||t.touchState.touchEnd;const n=i&&s||r||this._depthRefreshRequired;this._depthRefreshRequired=!1,t.handleEvents();let a=this.sceneFramebuffer;a.activate();let o=this.handler.gl;o.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),this.enableBlendDefault(),t.dispatch(t.draw,this),this.activeCamera.checkFly();let h=this.activeCamera.frustums,c=this._renderNodesArr,d=h.length;for(;d--;){this.activeCamera.setCurrentFrustum(d),o.clear(o.DEPTH_BUFFER_BIT);let u=c.length;for(;u--;)c[u].preDrawNode();for(u=c.length;u--;)this.enableBlendDefault(),c[u].drawNode();this._drawEntityCollections(0),t.dispatch(t.drawtransparent,this),n&&this._drawPickingBuffer(0),this._drawDepthBuffer(0),this._clearEntityCollectionQueue(0)}for(let u=1;u<this._entityCollections.length;u++){o.clear(o.DEPTH_BUFFER_BIT);let _=h.length;for(;_--;)this.activeCamera.setCurrentFrustum(_),this._drawEntityCollections(u),n&&this._drawPickingBuffer(u),this._drawDepthBuffer(u);this._clearEntityCollectionQueue(u)}a.deactivate(),this.blitFramebuffer&&a.blitTo(this.blitFramebuffer,0),n&&(this._readPickingBuffer(),this._readDepthBuffer()),this._fnScreenFrame(),t.dispatch(t.postdraw,this),t.mouseState.wheelDelta=0,t.mouseState.justStopped=!1,t.mouseState.moving=!1,t.touchState.moving=!1}getImageDataURL(t="image/png",i=1){return this.draw(),this.handler.canvas?this.handler.canvas.toDataURL(t,i):""}_screenFrameMSAA(){let t=this.handler,i=t.programs.toneMapping,s=i._program,r=t.gl;r.disable(r.DEPTH_TEST),r.bindBuffer(r.ARRAY_BUFFER,this.screenFramePositionBuffer),r.vertexAttribPointer(s.attributes.corners,2,r.FLOAT,!1,0,0),this.toneMappingFramebuffer.activate(),r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),i.activate(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.blitFramebuffer.textures[0]),r.uniform1i(s.uniforms.hdrBuffer,0),r.uniform1f(s.uniforms.gamma,this.gamma),r.uniform1f(s.uniforms.exposure,this.exposure),r.uniform1f(s.uniforms.whitepoint,this.whitepoint),r.drawArrays(r.TRIANGLE_STRIP,0,4),this.toneMappingFramebuffer.deactivate(),i=t.programs.screenFrame,s=i._program,i.activate(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.outputTexture),r.uniform1i(s.uniforms.texture,0),r.drawArrays(r.TRIANGLE_STRIP,0,4),r.enable(r.DEPTH_TEST)}_screenFrameNoMSAA(){let t=this.handler,i=t.programs.screenFrame,s=i._program,r=t.gl;r.disable(r.DEPTH_TEST),i.activate(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.outputTexture),r.uniform1i(s.uniforms.texture,0),r.bindBuffer(r.ARRAY_BUFFER,this.screenFramePositionBuffer),r.vertexAttribPointer(s.attributes.corners,2,r.FLOAT,!1,0,0),r.drawArrays(r.TRIANGLE_STRIP,0,4),r.enable(r.DEPTH_TEST)}_drawPickingBuffer(t){this.pickingFramebuffer.activate();let i=this.handler.gl;if(this.activeCamera.isFirstPass&&t===0?(i.clearColor(0,0,0,1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT)):i.clear(i.DEPTH_BUFFER_BIT),i.disable(i.BLEND),t===0){let s=this._pickingCallbacks;for(let r=0,n=s.length;r<n;r++)s[r].callback.call(s[r].sender)}this._drawPickingEntityCollections(t),i.enable(i.BLEND),this.pickingFramebuffer.deactivate()}_drawDepthBuffer(t){this.depthFramebuffer.activate();let i=this.handler,s=i.gl;if(s.disable(s.BLEND),this.activeCamera.isFirstPass&&t===0?(s.clearColor(0,0,0,1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)):s.clear(s.DEPTH_BUFFER_BIT),t===0){let r=this._depthCallbacks,n=r.length;for(;n--;)r[n].callback.call(r[n].sender)}if(this._drawDepthEntityCollections(t),this.depthFramebuffer.deactivate(),this._currentOutput==="depth"||this._currentOutput==="frustum"){this.screenDepthFramebuffer.activate();let r=i.programs.depth,n=r._program;s.bindBuffer(s.ARRAY_BUFFER,this.screenFramePositionBuffer),s.vertexAttribPointer(n.attributes.corners,2,s.FLOAT,!1,0,0),r.activate(),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.depthFramebuffer.textures[1]),s.uniform1i(n.uniforms.depthTexture,0),s.drawArrays(s.TRIANGLE_STRIP,0,4),this.screenDepthFramebuffer.deactivate()}s.enable(s.BLEND)}_readDepthBuffer(t){this.depthFramebuffer.readPixelBuffersAsync(t)}_readPickingBuffer_webgl1(){this.pickingFramebuffer.readPixelBuffersAsync()}_readPickingBuffer_webgl2(){this.pickingFramebuffer.readPixelBuffersAsync()}readPickingColor(t,i,s){var r;let n=this.pickingFramebuffer.width,a=this.pickingFramebuffer.height;t=Math.round(t*n);let o=4*((i=Math.round(i*a))*n+t),h=(r=this.pickingFramebuffer)==null?void 0:r.pixelBuffers[0].data;h&&(s[0]=h[o],s[1]=h[o+1],s[2]=h[o+2])}readDepth(t,i,s){let r=new Float32Array(4),n=new Uint8Array(4);this.depthFramebuffer.readData(t,i,n,0),this.depthFramebuffer.readData(t,i,r,1),s[0]=r[0],s[1]=Math.round(n[0]/10)-1}getDistanceFromPixel(t){let i=this.activeCamera,s=this.handler.canvas,r=t.x/s.width,n=(s.height-t.y)/s.height;if(It[0]=It[1]=0,this.readDepth(r,n,It),It[1]===-1)return;let a=It[0],o=i.frustums[It[1]];if(!o)return;let h=new te(2*r-1,2*n-1,2*a-1,1),c=o.inverseProjectionMatrix.mulVec4(h),d=-c.z/c.w;if(i.isOrthographic)return d;let u=t.direction||i.unproject(t.x,t.y);return d/Math.max(1e-6,u.dot(i.getForward()))}getCartesianFromPixel(t){let i=this.getDistanceFromPixel(t);if(i){if(this.activeCamera.isOrthographic){let s=new v;return this.activeCamera.unproject(t.x,t.y,i,s),s}return(t.direction||this.activeCamera.unproject(t.x,t.y)).scaleTo(i).addA(this.activeCamera.eye)}}getCartesianFromPixelAsync(t){return new Promise(((i,s)=>{this._readDepthBuffer((()=>{i(this.getCartesianFromPixel(t))}))}))}getDepthMinDistance(){let t=this.handler.canvas,i=t.width,s=t.height,r=bs,n=s*i,a=new H;for(let o=0;o<n;o++){a.x=o%i,a.y=Math.floor(o/i);let h=this.getDistanceFromPixel(a);h&&h<r&&(r=h)}return r<bs?r:0}getDepthMinDistanceAsync(){return new Promise(((t,i)=>{this._readDepthBuffer((()=>{t(this.getDepthMinDistance())}))}))}async setOrthographicProjection(t){if(t!==this.activeCamera.isOrthographic){let i=await this.getDepthMinDistanceAsync();i&&t&&(this.activeCamera.focusDistance=i),this.activeCamera.isOrthographic=t,this.events.dispatch(this.events.projchanged,this.activeCamera)}}start(){this._initialized||this.initialize(),this.handler.start()}destroy(){this.labelWorker.destroy();for(let t in this.controls)this.controls[t].remove();for(let t=0;t<this._renderNodesArr.length;t++)this._renderNodesArr[t].remove();this.div=null,this._renderNodesArr=[],this.renderNodes={},this.controls={},this.controlsBag={},this.colorObjects.clear(),this._pickingCallbacks=[],this.pickingFramebuffer=null,this._tempPickingPix_=null,this._depthCallbacks=[],this.depthFramebuffer=null,this.sceneFramebuffer=null,this.blitFramebuffer=null,this.toneMappingFramebuffer=null,this._entityCollections=[[]],this.handler.ONCANVASRESIZE=null,this.handler.destroy(),this._initialized=!1}}const pn="/res",Do=class Fi{constructor(t){this.$target=null,this._instanceID=`__globus${Fi.__counter__++?Fi.__counter__:""}__`,window[this._instanceID]=this,this._canvas=document.createElement("canvas"),this._canvas.id=`canvas${this._instanceID}`,this._canvas.style.width="100%",this._canvas.style.height="100%",this._canvas.style.display="block",this._canvas.style.opacity="0.0",this._canvas.style.transition="opacity 150ms",this.$inner=document.createElement("div"),this.$inner.classList.add("og-inner"),this.$inner.appendChild(this._canvas),this.$inner.attributions=document.createElement("div"),t.attributionContainer?t.attributionContainer.appendChild(this.$inner.attributions):(this.$inner.attributions.classList.add("og-attribution"),this.$inner.appendChild(this.$inner.attributions)),t.target&&this.attachTo(t.target);const i=o=>{o.preventDefault()};this._canvas.onmouseenter=function(){document.addEventListener("mousewheel",i,{capture:!1,passive:!1})},this._canvas.onmouseleave=function(){document.removeEventListener("mousewheel",i)},this.renderer=new Qc(new Lt(this._canvas,{autoActivate:!1,pixelRatio:t.dpi||window.devicePixelRatio+.15,context:{alpha:t.transparentBackground,antialias:!1,premultipliedAlpha:!0,preserveDrawingBuffer:!1}}),{autoActivate:!1,msaa:t.msaa,fontsSrc:t.fontsSrc,gamma:t.gamma,exposure:t.exposure,...t.transparentBackground&&{clearColor:[0,0,0,0]}}),this.renderer.div=this.$inner,t.skybox&&this.renderer.addNode(t.skybox),this._planetName=t.name?t.name:"globus_planet_"+Fi.__counter__,this.planet=new yi({name:this._planetName,frustums:t.frustums,ellipsoid:t.ellipsoid,maxGridSize:t.maxGridSize,nightTextureSrc:t.nightTextureSrc===null?null:t.nightTextureSrc||`${t.resourcesSrc||pn}/night.png`,specularTextureSrc:t.specularTextureSrc===null?null:t.specularTextureSrc||`${t.resourcesSrc||pn}/spec.png`,minAltitude:t.minAltitude,maxAltitude:t.maxAltitude||15e6,maxEqualZoomAltitude:t.maxEqualZoomAltitude,minEqualZoomAltitude:t.minEqualZoomAltitude,minEqualZoomCameraSlope:t.minEqualZoomCameraSlope,quadTreeStrategyPrototype:t.quadTreeStrategyPrototype,maxLoadingRequests:t.maxLoadingRequests,atmosphereEnabled:t.atmosphereEnabled,transitionOpacityEnabled:t.transitionOpacityEnabled,atmosphereParameters:t.atmosphereParameters,minDistanceBeforeMemClear:t.minDistanceBeforeMemClear,vectorTileSize:t.vectorTileSize,maxNodesCount:t.maxNodesCount,transparentBackground:t.transparentBackground}),t.terrain?Array.isArray(t.terrain)?this.planet.setTerrain(t.terrain[0]):this.planet.setTerrain(t.terrain):this.planet.setTerrain(new gr),this.renderer.addNode(this.planet),t.controls?this.planet.addControls(t.controls):this.planet.addControls([new oo,new Ii,new ao,new Ja,new ro,new qn,new Hs]);const s=this.renderer.controls;let r,n;for(let o in s)s[o]instanceof Ns&&(r=s[o]),s[o]instanceof Ii&&(n=s[o]);r?this.sun=r:(this.sun=new Ns,this.planet.addControl(this.sun)),t.sun&&(t.sun.active===void 0||t.sun.active||this.sun.deactivate(),t.sun.stopped===!0&&this.sun.stop()),n?this.navigation=n:(this.navigation=new Ii,this.planet.addControl(this.navigation)),t.navigation&&(t.navigation.active===void 0||t.navigation.active||this.navigation.deactivate(),t.navigation.inertia!==void 0&&(this.navigation.inertia=t.navigation.inertia),t.navigation.dragInertia!==void 0&&(this.navigation.dragInertia=t.navigation.dragInertia),t.navigation.minSlope!==void 0&&(this.navigation.minSlope=t.navigation.minSlope),t.navigation.mass!==void 0&&(this.navigation.mass=t.navigation.mass),t.navigation.zoomSpeed!==void 0&&(this.navigation.zoomSpeed=t.navigation.zoomSpeed),t.navigation.mode!==void 0&&this.navigation.setMode(t.navigation.mode),t.navigation.poleThreshold!==void 0&&(this.navigation.poleThreshold=t.navigation.poleThreshold),t.navigation.disableRotation!==void 0&&(this.navigation.disableRotation=t.navigation.disableRotation),t.navigation.disableTilt!==void 0&&(this.navigation.disableTilt=t.navigation.disableTilt)),t.layers&&this.planet.addLayers(t.layers);let a=t.viewExtent;a&&(a instanceof Array?this.planet.viewExtentArr(a):this.planet.viewExtent(a)),(t.autoActivate||Fe(t.autoActivate))&&this.start()}start(){this.renderer.start(),this.fadeIn()}fadeIn(){this._canvas.style.opacity="1.0"}fadeOut(){this._canvas.style.opacity="0"}attachTo(t,i){let s;this.detach(),s=t instanceof HTMLElement?t:document.getElementById(t)||document.querySelector(t),s?(this.$target=s,i&&this.$target.firstChild?this.$target.insertBefore(this.$inner,this.$target.firstChild):s.appendChild(this.$inner)):console.warn(`Target container not found. Provided target: ${t}`)}detach(){this.$target&&(this.$target.removeChild(this.$inner),this.$target=null)}destroy(){this.detach(),this.planet.layers.forEach((t=>t.remove())),this.planet.destroy(),this.renderer.destroy(),window[this._instanceID]=null}};Do.__counter__=0;let Kc=Do;new Ys(3396200,3389508);new Ys(1737400,1737400);class Jc{static async load(t){const i=await fetch(t);if(!i.ok)throw new Error(`Unable to load '${t}'`);const s=await i.arrayBuffer(),r=new DataView(s);if(r.getUint32(0,!0)!==1179937895)throw new Error("Not a valid GLB");r.getUint32(4,!0);const n=this.getChunks(r);return this.parseChunks(n)}static getChunks(t){const i=[];let s=12;do{const r=this.getChunk(t,s);s+=8+r.length,i.push(r)}while(s<t.byteLength);return i}static getChunk(t,i){const s=t.getUint32(i,!0);return{length:s,type:this.getChunkType(t.getUint32(i+4,!0)),chunkData:t.buffer.slice(i+8,i+8+s)}}static getChunkType(t){switch(t){case 1313821514:return 0;case 5130562:return 1;default:return 2}}static parseChunks(t){let i,s=[];for(const r of t)switch(r.type){case 0:i=this.parseJsonChunk(r);break;case 1:s.push(r.chunkData)}if(i===void 0)throw new Error("GLB json data extraction failed");return{gltf:i,bin:s}}static parseJsonChunk(t){return JSON.parse(new TextDecoder().decode(t.chunkData))}}var yt=(l=>(l[l.byte=5120]="byte",l[l.ubyte=5121]="ubyte",l[l.short=5122]="short",l[l.ushort=5123]="ushort",l[l.uint=5125]="uint",l[l.float=5126]="float",l))(yt||{}),dt=(l=>(l.scalar="SCALAR",l.vec2="VEC2",l.vec3="VEC3",l.vec4="VEC4",l.mat2="MAT2",l.mat3="MAT3",l.mat4="MAT4",l))(dt||{}),Gs=(l=>(l[l.points=0]="points",l[l.lines=1]="lines",l[l.lineLoop=2]="lineLoop",l[l.lineStrip=3]="lineStrip",l[l.triangles=4]="triangles",l[l.triangleStrip=5]="triangleStrip",l[l.triangleFan=6]="triangleFan",l))(Gs||{});const Fo=class et{constructor(t){var i;if(this.gltf=t,this._materials=[],this._images=[],this.meshes=[],((i=t.gltf.extensionsRequired)==null?void 0:i.includes("KHR_draco_mesh_compression"))&&et._dracoDecoderModule===null)throw new Error("Unable to import GLTF. Draco decoder module is not connected");this._initImages(),this._initMaterials(),this._initMeshes()}static connectDracoDecoderModule(t){et._dracoDecoderModule=t}static async loadGlb(t){const i=await Jc.load(t);return new et(i)}getObjects3d(){const t=[];for(let i=0;i<this.meshes.length;i++)for(let s=0;s<this.meshes[i].primitives.length;s++)this.meshes[i].primitives[s].object3d!==void 0&&t.push(this.meshes[i].primitives[s].object3d);return t}toEntities(){const t=[];for(const i of this.gltf.gltf.scenes){if(i===void 0||i.nodes===void 0)return[];for(const s of i.nodes){const r=this.gltf.gltf.nodes[s];r.mesh===void 0&&r.children===void 0||t.push(this._nodeToEntity(r))}}return t}_nodeToEntity(t,i){const s=new U({name:t.name,cartesian:new v(0,0,0),relativePosition:i!==void 0});let r=null;if(t.mesh!==void 0&&(r=this.meshToEntity(this.meshes[t.mesh],i),s.appendChild(r)),t.matrix!==void 0){const n=new ee;n.set(t.matrix),s.setCartesian3v(n.getPosition()),s.setDirectQuaternionRotation(n.getQuat()),s.setScale3v(n.getScaling())}if(t.translation!==void 0&&t.matrix===void 0&&(s.relativePosition=!0,s.setCartesian(t.translation[0],t.translation[1],t.translation[2])),t.rotation!==void 0&&t.matrix===void 0&&s.setDirectQuaternionRotation(new F(t.rotation[0],t.rotation[1],t.rotation[2],t.rotation[3])),t.scale!==void 0&&t.matrix===void 0&&s.setScale3v(new v(t.scale[0],t.scale[1],t.scale[2])),t.children!==void 0)for(const n of t.children){const a=this._nodeToEntity(this.gltf.gltf.nodes[n],s);r?r.appendChild(a):s.appendChild(a)}return s}meshToEntity(t,i){const s=new U({name:t.name,cartesian:new v(0,0,0),relativePosition:!0,independentPicking:!0});return t.primitives.map((r=>{s.appendChild(new U({name:r.name,relativePosition:!0,geoObject:{object3d:r.object3d,tag:r.name}}))})),s}_initImages(){if(this.gltf.gltf.images)for(const t of this.gltf.gltf.images)this._images.push({src:t.uri,element:this._getImage(t.mimeType,t.bufferView),mimeType:t.mimeType,name:t.name})}_getImage(t,i){if(i&&t){const s=this.gltf.gltf.bufferViews[i],r=URL.createObjectURL(new Blob([this.gltf.bin[s.buffer].slice(s.byteOffset,s.byteOffset+s.byteLength)],{type:t})),n=new Image;return n.src=r,n}}_initMaterials(){if(this.gltf.gltf.materials)for(const t of this.gltf.gltf.materials){const i={name:t.name,emissiveFactor:t.emissiveFactor,alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided};if(t.pbrMetallicRoughness){if(t.pbrMetallicRoughness.baseColorFactor&&(i.baseColorFactor=t.pbrMetallicRoughness.baseColorFactor),t.pbrMetallicRoughness.baseColorTexture){const s=this.gltf.gltf.textures[t.pbrMetallicRoughness.baseColorTexture.index].source;s!==void 0&&(i.baseColorTexture={image:this._images[s],texCoord:t.pbrMetallicRoughness.baseColorTexture.texCoord})}if(t.pbrMetallicRoughness.metallicRoughnessTexture){const s=this.gltf.gltf.textures[t.pbrMetallicRoughness.metallicRoughnessTexture.index].source;s!==void 0&&(i.metallicRoughnessTexture={image:this._images[s],texCoord:t.pbrMetallicRoughness.metallicRoughnessTexture.texCoord})}}if(t.normalTexture){const s=this.gltf.gltf.textures[t.normalTexture.index].source;s!==void 0&&(i.normalTexture={image:this._images[s],texCoord:t.normalTexture.texCoord,scale:t.normalTexture.scale})}if(t.occlusionTexture){const s=this.gltf.gltf.textures[t.occlusionTexture.index].source;s!==void 0&&(i.occlusionTexture={image:this._images[s],texCoord:t.occlusionTexture.texCoord,strength:t.occlusionTexture.strength})}if(t.emissiveTexture){const s=this.gltf.gltf.textures[t.emissiveTexture.index].source;s!==void 0&&(i.emissiveTexture={image:this._images[s],texCoord:t.emissiveTexture.texCoord})}this._materials.push(i)}}_initMeshes(){this.meshes=[];for(let t=0;t<this.gltf.gltf.meshes.length;t++){const i=this.gltf.gltf.meshes[t],s={name:i.name,primitives:[]};for(let r=0;r<i.primitives.length;r++)s.primitives.push(this._buildPrimitive(i,i.primitives[r],`${t}-${r}`));this.meshes.push(s)}}_buildPrimitive(t,i,s){var r,n;let a=null;const o=this._materials[i.material||0],h=(r=o.baseColorTexture)!=null&&r.texCoord?`TEXCOORD_${o.baseColorTexture.texCoord}`:"TEXCOORD_0";if((n=i.extensions)!=null&&n.KHR_draco_mesh_compression){const c=i.extensions.KHR_draco_mesh_compression,d=this.gltf.gltf.bufferViews[c.bufferView],u=d.byteOffset||0,_=et._dracoDecoderModule,p=new _.Decoder,f=new _.DecoderBuffer;if(f.Init(new Int8Array(this.gltf.bin[d.buffer].slice(u,u+d.byteLength)),d.byteLength),p.GetEncodedGeometryType(f)!==_.TRIANGULAR_MESH)throw new Error("Draco compressed data is not a mesh");const m=new _.Mesh;if(!p.DecodeBufferToMesh(f,m).ok()||m.ptr===0)throw new Error("Failed to decode Draco mesh");const g=m.num_faces(),y=new Uint32Array(3*g),x=new _.DracoInt32Array;for(let T=0;T<g;T++)p.GetFaceFromMesh(m,T,x),y[3*T]=x.GetValue(0),y[3*T+1]=x.GetValue(1),y[3*T+2]=x.GetValue(2);_.destroy(x);const b={};for(const T in c.attributes){const w=c.attributes[T],A=p.GetAttributeByUniqueId(m,w),E=m.num_points(),C=A.num_components(),M=new _.DracoFloat32Array;p.GetAttributeFloatForAllPoints(m,A,M);const P=new Float32Array(E*C);for(let B=0;B<P.length;B++)P[B]=M.GetValue(B);_.destroy(M),b[T]=P}_.destroy(m),_.destroy(f),_.destroy(p),a={name:`${t.name}/${o.name}/${s}`,vertices:b.POSITION,indices:y,mode:i.mode?i.mode:Gs.triangles,material:this._materials[i.material||0]||void 0,normals:b.NORMAL,texCoords:void 0}}else{const c=h?i.attributes[h]:void 0,d=c?this.gltf.gltf.accessors[c]:void 0;a={name:`${t.name}/${o.name}/${s}`,indices:i.indices?et._access(this.gltf.gltf.accessors[i.indices],this.gltf):void 0,mode:i.mode?i.mode:Gs.triangles,material:this._materials[i.material||0]||void 0,vertices:et._access(this.gltf.gltf.accessors[i.attributes.POSITION],this.gltf),normals:et._access(this.gltf.gltf.accessors[i.attributes.NORMAL],this.gltf),texCoords:d?et._access(d,this.gltf):void 0}}if(a===null)throw new Error("Unable to build primitive");return a.object3d=et._toObject3d(a),a}static _toObject3d(t){var i,s,r,n,a,o,h,c,d,u,_,p,f;return new $({name:t.name,vertices:Array.from(t.vertices),normals:Array.from(t.normals),texCoords:t.texCoords?Array.from(t.texCoords):void 0,indices:Array.from(t.indices),normalTextureImage:(s=(i=t.material)==null?void 0:i.normalTexture)==null?void 0:s.image.element,normalTextureSrc:(n=(r=t.material)==null?void 0:r.normalTexture)==null?void 0:n.image.src,colorTextureImage:(o=(a=t.material)==null?void 0:a.baseColorTexture)==null?void 0:o.image.element,colorTextureSrc:(c=(h=t.material)==null?void 0:h.baseColorTexture)==null?void 0:c.image.src,metallicRoughnessTextureImage:(u=(d=t.material)==null?void 0:d.occlusionTexture)==null?void 0:u.image.element,metallicRoughnessTextureSrc:(p=(_=t.material)==null?void 0:_.occlusionTexture)==null?void 0:p.image.src,color:(f=t.material)==null?void 0:f.baseColorFactor})}static _access(t,i){const s=i.gltf.bufferViews[t.bufferView],r=i.bin[s.buffer];let n=s.byteOffset||0;t.byteOffset!==void 0&&(n+=t.byteOffset);const a=r.slice(n,n+s.byteLength);switch(t.type){case dt.scalar:return this._getTensor(a,t,1,s.byteStride);case dt.vec2:return this._getTensor(a,t,2,s.byteStride);case dt.vec3:return this._getTensor(a,t,3,s.byteStride);case dt.vec4:case dt.mat2:return this._getTensor(a,t,4,s.byteStride);case dt.mat3:return this._getTensor(a,t,9,s.byteStride);case dt.mat4:return this._getTensor(a,t,16,s.byteStride);default:throw new Error("Unknown accessor type")}}static _getTensor(t,i,s,r){if(i.componentType===yt.ushort)return new Uint16Array(t,0,i.count*s);if(i.componentType===yt.short)return new Int16Array(t,0,i.count*s);if(i.componentType===yt.uint)return new Uint32Array(t,0,i.count*s);if(i.componentType===yt.float)return new Float32Array(t,0,i.count*s);if(i.componentType===yt.ubyte)return new Uint8Array(t,0,i.count*s);if(i.componentType===yt.byte)return new Int8Array(t,0,i.count*s);throw new Error("Unknown component type")}};Fo._dracoDecoderModule=null;let ad=Fo;(globalThis.og??(globalThis.og={})).version="0.28.6";const ed=({children:l,onDraw:t,...i})=>{const s=qe.useRef(null),{setGlobe:r}=No(),[n,a]=qe.useState(i),o=qe.useRef(null);return qe.useEffect(()=>{if(o&&o.current&&i.viewExtent!==void 0){const h=i.viewExtent instanceof j?i.viewExtent:new j(new L(i.viewExtent[0],i.viewExtent[1]),new L(i.viewExtent[2],i.viewExtent[3]));o.current.planet.viewExtent(h)}},[i.viewExtent]),qe.useEffect(()=>{o&&o.current&&i.atmosphereEnabled!==void 0&&(o.current.planet.atmosphereEnabled=i.atmosphereEnabled)},[i.atmosphereEnabled]),qe.useEffect(()=>{o&&o.current&&i.sunActive!==void 0&&(i.sunActive?o.current?.sun.activate():o.current?.sun.deactivate())},[i.sunActive]),qe.useEffect(()=>{if(o.current)s.current=o.current.$target;else{const h=new Io("OSM"),c=new zo("Microsoft Bing");o.current=new Kc({target:s.current,name:"Earth",terrain:new ko,layers:[h,c],autoActivate:!0,atmosphereEnabled:!0,...n}),t&&o.current.planet.events.on("draw",t)}return r(o.current),()=>{o.current&&(t&&o.current.planet.events.off("draw",t),o.current.destroy(),o.current=null)}},[n]),qe.createElement("div",{style:{width:"100%",height:"100%"},ref:s},l)};ed.__docgenInfo={description:"",methods:[],displayName:"Globe",props:{children:{required:!1,tsType:{name:"union",raw:"LayerChildren | LayerChildren[]",elements:[{name:"ReactReactElement",raw:"React.ReactElement<{ type: typeof Layer | typeof Vector }>",elements:[{name:"signature",type:"object",raw:"{ type: typeof Layer | typeof Vector }",signature:{properties:[{key:"type",value:{name:"union",raw:"typeof Layer | typeof Vector",elements:[{name:"Layer"},{name:"Vector"}],required:!0}}]}}]},{name:"Array",elements:[{name:"ReactReactElement",raw:"React.ReactElement<{ type: typeof Layer | typeof Vector }>",elements:[{name:"signature",type:"object",raw:"{ type: typeof Layer | typeof Vector }",signature:{properties:[{key:"type",value:{name:"union",raw:"typeof Layer | typeof Vector",elements:[{name:"Layer"},{name:"Vector"}],required:!0}}]}}]}],raw:"LayerChildren[]"}]},description:""},atmosphereEnabled:{required:!1,tsType:{name:"boolean"},description:""},sunActive:{required:!1,tsType:{name:"boolean"},description:""},onDraw:{required:!1,tsType:{name:"EventCallback"},description:""},viewExtent:{required:!1,tsType:{name:"union",raw:"Extent | NumberArray4",elements:[{name:"Extent"},{name:"NumberArray4"}]},description:""}},composes:["IGlobeParams"]};export{Qc as A,wo as C,Qi as D,ed as G,H,L,rd as N,ol as Q,pl as T,Oo as a,v as b,ul as c,fl as d,te as e,Oc as f,nd as g,ue as h,lt as i,U as j,id as k,ad as m,Ys as q,ht as s,No as u,hl as v,dl as y,sd as z};
