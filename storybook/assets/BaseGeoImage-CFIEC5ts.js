import{L as u,E as l,b as o,M as d,c,d as _}from"./Globe-LHHj7Ux8.js";const m=["loadend"];class E extends u{constructor(t,r={}){super(t,r),this.events=this.events.registerNames(m),this._projType=0,this._frameWidth=256,this._frameHeight=256,this._sourceReady=!1,this._sourceTexture=null,this._materialTexture=null,this._gridBufferLow=null,this._gridBufferHigh=null,this._extentWgs84ParamsHigh=new Float32Array(4),this._extentWgs84ParamsLow=new Float32Array(4),this._extentMercParamsHigh=new Float32Array(4),this._extentMercParamsLow=new Float32Array(4),this._refreshFrame=!0,this._frameCreated=!1,this._sourceCreated=!1,this._animate=!1,this._ready=!1,this._creationProceeding=!1,this._isRendering=!1,this._extentWgs84=new l,this._cornersWgs84=[],this._cornersMerc=[],this._isFullExtent=r.fullExtent?1:0,this.rendering=this._renderingProjType0.bind(this),this._onLoadend_=null,r.corners&&this.setCorners(r.corners)}get isIdle(){return super.isIdle&&this._ready}addTo(t){return this._onLoadend_=this._onLoadend.bind(this),this.events.on("loadend",this._onLoadend_,this),super.addTo(t)}_onLoadend(){this._planet&&this._planet.events.dispatch(this._planet.events.layerloadend,this)}remove(){return this.events.off("loadend",this._onLoadend_),this._onLoadend_=null,super.remove()}get instanceName(){return"BaseGeoImage"}getCornersLonLat(){let t=this._cornersWgs84;return[new o(t[0].lon,t[0].lat),new o(t[1].lon,t[1].lat),new o(t[2].lon,t[2].lat),new o(t[3].lon,t[3].lat)]}getCorners(){let t=this._cornersWgs84;return[[t[0].lon,t[0].lat],[t[1].lon,t[1].lat],[t[2].lon,t[2].lat],[t[3].lon,t[3].lat]]}setCorners(t){this.setCornersLonLat(o.join(t))}setCornersLonLat(t){this._refreshFrame=!0,this._cornersWgs84=[t[0].clone(),t[1].clone(),t[2].clone(),t[3].clone()];for(let e=0;e<this._cornersWgs84.length;e++)this._cornersWgs84[e].lat>=89.9&&(this._cornersWgs84[e].lat=89.9),this._cornersWgs84[e].lat<=-89.9&&(this._cornersWgs84[e].lat=-89.9);this._extent.setByCoordinates(this._cornersWgs84);let r=this._extent;r.southWest.lat>d||r.northEast.lat<c?(this._projType=0,this.rendering=this._renderingProjType0):(this._projType=1,this.rendering=this._renderingProjType1),this._ready&&!this._creationProceeding&&this._planet._geoImageCreator.add(this)}_createFrame(){this._extentWgs84=this._extent.clone(),this._cornersMerc=[this._cornersWgs84[0].forwardMercatorEPS01(),this._cornersWgs84[1].forwardMercatorEPS01(),this._cornersWgs84[2].forwardMercatorEPS01(),this._cornersWgs84[3].forwardMercatorEPS01()],this._extentMerc=new l(this._extentWgs84.southWest.forwardMercatorEPS01(),this._extentWgs84.northEast.forwardMercatorEPS01());let t=new Float32Array(2);if(this._projType===0?(_(this._extentWgs84.southWest.lon,t),this._extentWgs84ParamsHigh[0]=t[0],this._extentWgs84ParamsLow[0]=t[1],_(this._extentWgs84.southWest.lat,t),this._extentWgs84ParamsHigh[1]=t[0],this._extentWgs84ParamsLow[1]=t[1],this._extentWgs84ParamsHigh[2]=2/this._extentWgs84.getWidth(),this._extentWgs84ParamsHigh[3]=2/this._extentWgs84.getHeight()):(_(this._extentMerc.southWest.lon,t),this._extentMercParamsHigh[0]=t[0],this._extentMercParamsLow[0]=t[1],_(this._extentMerc.southWest.lat,t),this._extentMercParamsHigh[1]=t[0],this._extentMercParamsLow[1]=t[1],this._extentMercParamsHigh[2]=2/this._extentMerc.getWidth(),this._extentMercParamsHigh[3]=2/this._extentMerc.getHeight()),this._planet){let r=this._planet,e=r.renderer.handler;e.gl.deleteTexture(this._materialTexture),this._materialTexture=e.createEmptyTexture_l(this._frameWidth,this._frameHeight);let i=this._planet._geoImageCreator.createGridBuffer(this._cornersWgs84,this._projType===1);this._gridBufferHigh=i[0],this._gridBufferLow=i[1],this._refreshFrame=!1}}abortMaterialLoading(t){this._creationProceeding=!1,t.isLoading=!1,t.isReady=!1}clear(){let t=this._planet;if(t){let r=t.renderer.handler.gl;this._creationProceeding&&t._geoImageCreator.remove(this),t._clearLayerMaterial(this),r&&(r.deleteBuffer(this._gridBufferHigh),r.deleteBuffer(this._gridBufferLow),r.deleteTexture(this._sourceTexture),this._materialTexture&&!this._materialTexture.default&&r.deleteTexture(this._materialTexture))}this._sourceTexture=null,this._materialTexture=null,this._gridBufferHigh=null,this._gridBufferLow=null,this._refreshFrame=!0,this._sourceCreated=!1,this._ready=!1,this._creationProceeding=!1}setVisibility(t){t!==this._visibility&&(super.setVisibility(t),this._planet&&this._sourceReady&&(t?this._planet._geoImageCreator.add(this):this._planet._geoImageCreator.remove(this)))}clearMaterial(t){t.texture=null,t.isLoading=!1,t.isReady=!1}applyMaterial(t){let r=t.segment;this._ready?t.applyTexture(this._materialTexture):(t.texture=this._planet.transparentTexture,!this._creationProceeding&&this.loadMaterial(t));let e,s;this._projType===0?(e=this._extentWgs84,s=r._extent):(e=this._extentMerc,s=r.getExtentMerc());let i=e.northEast.lon-e.southWest.lon,h=e.northEast.lat-e.southWest.lat,n=(s.southWest.lon-e.southWest.lon)/i,a=(e.northEast.lat-s.northEast.lat)/h,g=(s.northEast.lon-s.southWest.lon)/i,f=(s.northEast.lat-s.southWest.lat)/h;return[n,a,g,f]}get getFrameWidth(){return this._frameWidth}get getFrameHeight(){return this._frameHeight}_createSourceTexture(){}_renderingProjType1(){let t=this._planet,r=t.renderer.handler,e=r.gl,s=t._geoImageCreator;this._refreshFrame&&this._createFrame(),this._createSourceTexture();let i=s._framebuffer;i.setSize(this._frameWidth,this._frameHeight),i.activate(),r.programs.geoImageTransform.activate();let h=r.programs.geoImageTransform._program,n=h.attributes,a=h.uniforms;e.disable(e.CULL_FACE),i.bindOutputTexture(this._materialTexture),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT),e.uniform1i(a.isFullExtent,this._isFullExtent),e.bindBuffer(e.ARRAY_BUFFER,s._texCoordsBuffer),e.vertexAttribPointer(n.texCoords,2,e.UNSIGNED_SHORT,!0,0,0),e.bindBuffer(e.ARRAY_BUFFER,this._gridBufferHigh),e.vertexAttribPointer(n.cornersHigh,this._gridBufferHigh.itemSize,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this._gridBufferLow),e.vertexAttribPointer(n.cornersLow,this._gridBufferLow.itemSize,e.FLOAT,!1,0,0),e.uniform4fv(a.extentParamsHigh,this._extentMercParamsHigh),e.uniform4fv(a.extentParamsLow,this._extentMercParamsLow),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._sourceTexture),e.uniform1i(a.sourceTexture,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s._indexBuffer),e.drawElements(e.TRIANGLE_STRIP,s._indexBuffer.numItems,e.UNSIGNED_INT,0),i.deactivate(),e.enable(e.CULL_FACE),this._ready=!0,this._creationProceeding=!1}_renderingProjType0(){let t=this._planet,r=t.renderer.handler,e=r.gl,s=t._geoImageCreator;this._refreshFrame&&this._createFrame(),this._createSourceTexture();let i=s._framebuffer;i.setSize(this._frameWidth,this._frameHeight),i.activate(),r.programs.geoImageTransform.activate();let h=r.programs.geoImageTransform._program,n=h.attributes,a=h.uniforms;e.disable(e.CULL_FACE),i.bindOutputTexture(this._materialTexture),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT),e.bindBuffer(e.ARRAY_BUFFER,s._texCoordsBuffer),e.vertexAttribPointer(n.texCoords,2,e.UNSIGNED_SHORT,!0,0,0),e.bindBuffer(e.ARRAY_BUFFER,this._gridBufferHigh),e.vertexAttribPointer(n.cornersHigh,this._gridBufferHigh.itemSize,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this._gridBufferLow),e.vertexAttribPointer(n.cornersLow,this._gridBufferLow.itemSize,e.FLOAT,!1,0,0),e.uniform4fv(a.extentParamsHigh,this._extentWgs84ParamsHigh),e.uniform4fv(a.extentParamsLow,this._extentWgs84ParamsLow),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._sourceTexture),e.uniform1i(a.sourceTexture,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s._indexBuffer),e.drawElements(e.TRIANGLE_STRIP,s._indexBuffer.numItems,e.UNSIGNED_INT,0),i.deactivate(),e.enable(e.CULL_FACE),this._ready=!0,this._creationProceeding=!1}}export{E as B};
